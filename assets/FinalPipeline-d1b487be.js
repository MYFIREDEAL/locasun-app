import{c as Et,r as n,R as gt,u as ks,j as e,m as Ye,C as nt,l as N,s as he,a as ot,b as Ve,d as As,e as et,f as Es,g as _t,h as ct,B as be,P as Pt,D as ht,i as ft,X as Je,k as bt,n as jt,U as Ue,o as tt,M as yt,p as Dt,q as vt,S as Tt,t as Rt,v as Ft,w as $t,x as $e,y as Mt,A as as,z as rs,T as Ot,E as ns,F as is,G as ls,H as os,I as cs,J as ds,K as us,L as X,N as Oe,O as Ps,Q as ms,V as Ds,W as gs,Y as Vt,Z as Ts,_ as Rs,$ as Qe,a0 as Fs,a1 as $s,a2 as Ms,a3 as it,a4 as Os,a5 as xs,a6 as ps,a7 as zs,a8 as Ls,a9 as Me,aa as Be,ab as dt,ac as hs,ad as qs,ae as Vs,af as Bs,ag as Hs,ah as Gs,ai as Ws,aj as Js,ak as Xs,al as Ys,am as Ks,an as Qs,ao as Zs,ap as Us,aq as ea,ar as ta,as as sa,at as aa,au as ra}from"./index-62fa5fb5.js";import{u as st,A as fs,C as na}from"./Agenda-379ec4b5.js";import{S as ia}from"./SearchableSelect-83a5bcde.js";import{u as la}from"./useSupabaseProjectStepsStatus-a6e471fb.js";import{u as bs,a as js}from"./useSupabaseProjectFiles-dfc199b1.js";import{F as oa,a as ca,P as da,b as ua,e as ma,u as ys,S as zt,c as ga}from"./useSupabaseWorkflowModuleTemplates-5f214312.js";import{f as Ke,a as Le,V as xa}from"./index-e0cee78b.js";import{D as xt}from"./download-731022a6.js";import{i as pa}from"./workflowV2Config-f801420c.js";import{P as pt}from"./pen-square-278d47a5.js";import{f as ha,P as Bt}from"./index-85147e80.js";import"./external-link-07e38a48.js";const fa=Et("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),ba=Et("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),ja=Et("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function ya(){for(var t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return n.useMemo(()=>r=>{s.forEach(d=>d(r))},s)}const va=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function Na(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function wa(t){return"nodeType"in t}function vs(t){var s,a;return t?Na(t)?t:wa(t)&&(s=(a=t.ownerDocument)==null?void 0:a.defaultView)!=null?s:window:window}const Nt=va?n.useLayoutEffect:n.useEffect;function Ns(t){const s=n.useRef(t);return Nt(()=>{s.current=t}),n.useCallback(function(){for(var a=arguments.length,r=new Array(a),d=0;d<a;d++)r[d]=arguments[d];return s.current==null?void 0:s.current(...r)},[])}function It(t,s){s===void 0&&(s=[t]);const a=n.useRef(t);return Nt(()=>{a.current!==t&&(a.current=t)},s),a}function Ct(t){const s=Ns(t),a=n.useRef(null),r=n.useCallback(d=>{d!==a.current&&(s==null||s(d,a.current)),a.current=d},[]);return[a,r]}let St={};function ws(t,s){return n.useMemo(()=>{if(s)return s;const a=St[t]==null?0:St[t]+1;return St[t]=a,t+"-"+a},[t,s])}function Sa(t){if(!t)return!1;const{KeyboardEvent:s}=vs(t.target);return s&&t instanceof s}const lt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:a}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:a}=t;return"scaleX("+s+") scaleY("+a+")"}},Transform:{toString(t){if(t)return[lt.Translate.toString(t),lt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:a,easing:r}=t;return s+" "+a+"ms "+r}}});var rt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(rt||(rt={}));function Ht(){}const _a=Object.freeze({x:0,y:0});function Ia(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Ca(t,s,a){const r=Ia(s);if(!r)return t;const{scaleX:d,scaleY:u,x:m,y:g}=r,w=t.left-m-(1-d)*parseFloat(a),I=t.top-g-(1-u)*parseFloat(a.slice(a.indexOf(" ")+1)),j=d?t.width/d:t.width,h=u?t.height/u:t.height;return{width:j,height:h,top:I,right:w+j,bottom:I+h,left:w}}const ka={ignoreTransform:!1};function Lt(t,s){s===void 0&&(s=ka);let a=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:I,transformOrigin:j}=vs(t).getComputedStyle(t);I&&(a=Ca(a,I,j))}const{top:r,left:d,width:u,height:m,bottom:g,right:w}=a;return{top:r,left:d,width:u,height:m,bottom:g,right:w}}function Gt(t){return Lt(t,{ignoreTransform:!0})}var Ze;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(Ze||(Ze={}));var Wt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Wt||(Wt={}));var Fe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Fe||(Fe={}));Fe.Space,Fe.Enter,Fe.Esc,Fe.Space,Fe.Enter,Fe.Tab;var Jt;(function(t){t[t.RightClick=2]="RightClick"})(Jt||(Jt={}));var Xt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Xt||(Xt={}));var Yt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Yt||(Yt={}));Ze.Backward+"",Ze.Forward+"",Ze.Backward+"",Ze.Forward+"";var kt;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(kt||(kt={}));var At;(function(t){t.Optimized="optimized"})(At||(At={}));function Aa(t){let{callback:s,disabled:a}=t;const r=Ns(s),d=n.useMemo(()=>{if(a||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:u}=window;return new u(r)},[a]);return n.useEffect(()=>()=>d==null?void 0:d.disconnect(),[d]),d}function Ea(t,s){return n.useMemo(()=>t.reduce((a,r)=>{let{eventName:d,handler:u}=r;return a[d]=m=>{u(m,s)},a},{}),[t,s])}kt.WhileDragging,At.Optimized;const Pa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Ht,draggableNodes:new Map,over:null,measureDroppableContainers:Ht},Ss=n.createContext(Pa),Da=n.createContext({..._a,scaleX:1,scaleY:1});var Kt;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Kt||(Kt={}));const Ta=n.createContext(null),Qt="button",Ra="Draggable";function Fa(t){let{id:s,data:a,disabled:r=!1,attributes:d}=t;const u=ws(Ra),{activators:m,activatorEvent:g,active:w,activeNodeRect:I,ariaDescribedById:j,draggableNodes:h,over:O}=n.useContext(Ss),{role:x=Qt,roleDescription:$="draggable",tabIndex:D=0}=d??{},b=(w==null?void 0:w.id)===s,k=n.useContext(b?Da:Ta),[E,y]=Ct(),[i,o]=Ct(),T=Ea(m,s),W=It(a);Nt(()=>(h.set(s,{id:s,key:u,node:E,activatorNode:i,data:W}),()=>{const M=h.get(s);M&&M.key===u&&h.delete(s)}),[h,s]);const S=n.useMemo(()=>({role:x,tabIndex:D,"aria-disabled":r,"aria-pressed":b&&x===Qt?!0:void 0,"aria-roledescription":$,"aria-describedby":j.draggable}),[r,x,D,b,$,j.draggable]);return{active:w,activatorEvent:g,activeNodeRect:I,attributes:S,isDragging:b,listeners:r?void 0:T,node:E,over:O,setNodeRef:y,setActivatorNodeRef:o,transform:k}}const $a="Droppable",Ma={timeout:25};function Oa(t){let{data:s,disabled:a=!1,id:r,resizeObserverConfig:d}=t;const u=ws($a),{active:m,dispatch:g,over:w,measureDroppableContainers:I}=n.useContext(Ss),j=n.useRef({disabled:a}),h=n.useRef(!1),O=n.useRef(null),x=n.useRef(null),{disabled:$,updateMeasurementsFor:D,timeout:b}={...Ma,...d},k=It(D??r),E=n.useCallback(()=>{if(!h.current){h.current=!0;return}x.current!=null&&clearTimeout(x.current),x.current=setTimeout(()=>{I(Array.isArray(k.current)?k.current:[k.current]),x.current=null},b)},[b]),y=Aa({callback:E,disabled:$||!m}),i=n.useCallback((S,M)=>{y&&(M&&(y.unobserve(M),h.current=!1),S&&y.observe(S))},[y]),[o,T]=Ct(i),W=It(s);return n.useEffect(()=>{!y||!o.current||(y.disconnect(),h.current=!1,y.observe(o.current))},[o,y]),n.useEffect(()=>(g({type:rt.RegisterDroppable,element:{id:r,key:u,disabled:a,node:o,rect:O,data:W}}),()=>g({type:rt.UnregisterDroppable,key:u,id:r})),[r]),n.useEffect(()=>{a!==j.current.disabled&&(g({type:rt.SetDroppableDisabled,id:r,key:u,disabled:a}),j.current.disabled=a)},[r,u,a,g]),{active:m,rect:O,isOver:(w==null?void 0:w.id)===r,node:o,over:w,setNodeRef:T}}function _s(t,s,a){const r=t.slice();return r.splice(a<0?r.length+a:a,0,r.splice(s,1)[0]),r}function mt(t){return t!==null&&t>=0}const za=t=>{let{rects:s,activeIndex:a,overIndex:r,index:d}=t;const u=_s(s,r,a),m=s[d],g=u[d];return!g||!m?null:{x:g.left-m.left,y:g.top-m.top,scaleX:g.width/m.width,scaleY:g.height/m.height}},La="Sortable",qa=gt.createContext({activeIndex:-1,containerId:La,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:za,disabled:{draggable:!1,droppable:!1}}),Va=t=>{let{id:s,items:a,activeIndex:r,overIndex:d}=t;return _s(a,r,d).indexOf(s)},Ba=t=>{let{containerId:s,isSorting:a,wasDragging:r,index:d,items:u,newIndex:m,previousItems:g,previousContainerId:w,transition:I}=t;return!I||!r||g!==u&&d===m?!1:a?!0:m!==d&&s===w},Ha={duration:200,easing:"ease"},Is="transform",Ga=lt.Transition.toString({property:Is,duration:0,easing:"linear"}),Wa={roleDescription:"sortable"};function Ja(t){let{disabled:s,index:a,node:r,rect:d}=t;const[u,m]=n.useState(null),g=n.useRef(a);return Nt(()=>{if(!s&&a!==g.current&&r.current){const w=d.current;if(w){const I=Lt(r.current,{ignoreTransform:!0}),j={x:w.left-I.left,y:w.top-I.top,scaleX:w.width/I.width,scaleY:w.height/I.height};(j.x||j.y)&&m(j)}}a!==g.current&&(g.current=a)},[s,a,r,d]),n.useEffect(()=>{u&&m(null)},[u]),u}function Xa(t){let{animateLayoutChanges:s=Ba,attributes:a,disabled:r,data:d,getNewIndex:u=Va,id:m,strategy:g,resizeObserverConfig:w,transition:I=Ha}=t;const{items:j,containerId:h,activeIndex:O,disabled:x,disableTransforms:$,sortedRects:D,overIndex:b,useDragOverlay:k,strategy:E}=n.useContext(qa),y=Ya(r,x),i=j.indexOf(m),o=n.useMemo(()=>({sortable:{containerId:h,index:i,items:j},...d}),[h,d,i,j]),T=n.useMemo(()=>j.slice(j.indexOf(m)),[j,m]),{rect:W,node:S,isOver:M,setNodeRef:ie}=Oa({id:m,data:o,disabled:y.droppable,resizeObserverConfig:{updateMeasurementsFor:T,...w}}),{active:oe,activatorEvent:xe,activeNodeRect:G,attributes:je,setNodeRef:Z,listeners:A,isDragging:J,over:ue,setActivatorNodeRef:q,transform:c}=Fa({id:m,data:o,attributes:{...Wa,...a},disabled:y.draggable}),z=ya(ie,Z),V=!!oe,ce=V&&!$&&mt(O)&&mt(b),f=!k&&J,P=f&&ce?c:null,B=ce?P??(g??E)({rects:D,activeNodeRect:G,activeIndex:O,overIndex:b,index:i}):null,te=mt(O)&&mt(b)?u({id:m,items:j,activeIndex:O,overIndex:b}):i,L=oe==null?void 0:oe.id,K=n.useRef({activeId:L,items:j,newIndex:te,containerId:h}),de=j!==K.current.items,le=s({active:oe,containerId:h,isDragging:J,isSorting:V,id:m,index:i,items:j,newIndex:K.current.newIndex,previousItems:K.current.items,previousContainerId:K.current.containerId,transition:I,wasDragging:K.current.activeId!=null}),fe=Ja({disabled:!le,index:i,node:S,rect:W});return n.useEffect(()=>{V&&K.current.newIndex!==te&&(K.current.newIndex=te),h!==K.current.containerId&&(K.current.containerId=h),j!==K.current.items&&(K.current.items=j)},[V,te,h,j]),n.useEffect(()=>{if(L===K.current.activeId)return;if(L&&!K.current.activeId){K.current.activeId=L;return}const ne=setTimeout(()=>{K.current.activeId=L},50);return()=>clearTimeout(ne)},[L]),{active:oe,activeIndex:O,attributes:je,data:o,rect:W,index:i,newIndex:te,items:j,isOver:M,isSorting:V,isDragging:J,listeners:A,node:S,overIndex:b,over:ue,setNodeRef:z,setActivatorNodeRef:q,setDroppableNodeRef:ie,setDraggableNodeRef:Z,transform:fe??B,transition:_()};function _(){if(fe||de&&K.current.newIndex===i)return Ga;if(!(f&&!Sa(xe)||!I)&&(V||le))return lt.Transition.toString({...I,property:Is})}}function Ya(t,s){var a,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(a=t==null?void 0:t.draggable)!=null?a:s.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:s.droppable}}Fe.Down,Fe.Right,Fe.Up,Fe.Left;const Ka=t=>(t||"").toString().trim().toUpperCase(),Qa=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const a=t.prospect,r=s.prospect;if(a.id!==r.id||a.name!==r.name||a.hasAppointment!==r.hasAppointment||a.updatedAt!==r.updatedAt)return!1;const d=a._projectContext||{},u=r._projectContext||{};if(d.projectType!==u.projectType||d.projectTitle!==u.projectTitle||d.stepLabel!==u.stepLabel)return!1;const m=a.tags||[],g=r.tags||[];return!(m.length!==g.length||m.some((w,I)=>w!==g[I])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},Za=({prospect:t,onClick:s,sortableId:a,projectsData:r={}})=>{var b,k,E,y,i,o,T;ks();const d=Array.isArray(t.tags)?t.tags:[],u=((b=t._projectContext)==null?void 0:b.projectTitle)||((k=t._projectContext)==null?void 0:k.projectType)||null,m=((E=t._projectContext)==null?void 0:E.projectType)||null;(y=t._projectContext)!=null&&y.stepLabel;const g=u?Ka(u):null,w=a||(g?`${t.id}-${g}`:`${t.id}-${((i=t._projectContext)==null?void 0:i.projectType)||"default"}`),{attributes:I,listeners:j,setNodeRef:h,transform:O,transition:x,isDragging:$}=Xa({id:w,data:{prospect:t}}),D={transform:lt.Transform.toString(O),transition:x,zIndex:$?10:"auto",opacity:$?.8:1};return e.jsx("div",{ref:h,style:D,...I,...j,children:e.jsxs(Ye.div,{layoutId:`prospect-card-${w}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(nt,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[u&&d.includes(((o=t._projectContext)==null?void 0:o.projectType)||u)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((T=r[m])==null?void 0:T.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:u})}),d.filter(W=>W!==m).map(W=>{var ie,oe;const S=((ie=r[W])==null?void 0:ie.title)||W,M=((oe=r[W])==null?void 0:oe.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:S},W)})]})]})})},Ua=n.memo(Za,Qa);function er({prospectId:t,projectType:s,currentStepIndex:a,prompt:r,sendNextAction:d}){const u=n.useRef(new Set);n.useRef(!1),n.useEffect(()=>{if(!t||!s||a===void 0||!r)return;N.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:a,promptName:r==null?void 0:r.name});const m=he.channel(`workflow-forms-${t}-${s}-${a}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async g=>{const w=g.new;N.info("üîç Form panel UPDATE re√ßu",{panelId:w.id,prospectId:w.prospect_id,projectType:w.project_type,status:w.status,actionId:w.action_id,expectedProjectType:s});const I=w.project_type===s,j=w.status==="approved",h=!!w.action_id;if(I&&j&&h){const O=`${t}-${s}-${a}-${w.action_id}`;if(u.current.has(O)){N.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:O});return}u.current.add(O),N.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:w.form_id,actionId:w.action_id}),setTimeout(()=>{N.info("üöÄ Envoi action suivante",{completedActionId:w.action_id}),d(w.action_id)},2e3)}}).subscribe();return()=>{he.removeChannel(m)}},[t,s,a,r,d])}function tr({projectType:t,prospectId:s,enabled:a=!0}){const[r,d]=n.useState([]),[u,m]=n.useState(!1),[g,w]=n.useState(!1),[I,j]=n.useState(null),{organizationId:h}=ot(),O=n.useCallback(async()=>{if(!(!t||!a))try{m(!0),j(null);let b=he.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(b=b.eq("prospect_id",s));const{data:k,error:E}=await b;if(E)throw E;d(k||[])}catch(b){N.error("Erreur r√©cup√©ration project notes:",{error:b.message}),j(b.message)}finally{m(!1)}},[t,s,a]);n.useEffect(()=>{if(!t||!a)return;O();const b=he.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},k=>{d(E=>{const{eventType:y,new:i,old:o}=k;return y==="INSERT"?[i,...E]:y==="UPDATE"?E.map(T=>T.id===i.id?i:T):y==="DELETE"?E.filter(T=>T.id!==o.id):E})}).subscribe();return()=>{he.removeChannel(b)}},[t,a,O]);const x=n.useCallback(async({content:b,createdBy:k,createdByName:E})=>{if(!(!t||!(b!=null&&b.trim())))try{if(w(!0),j(null),!h)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:y,error:i}=await he.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:b.trim(),created_by:k||null,created_by_name:E||null,organization_id:h}]).select().single();if(i)throw i;return d(o=>[y,...o]),y}catch(y){throw N.error("Erreur ajout project note:",{error:y.message}),j(y.message),y}finally{w(!1)}},[t,s,h]),$=n.useCallback(async(b,{content:k})=>{if(!(!b||!(k!=null&&k.trim())))try{w(!0),j(null);const{data:E,error:y}=await he.from("project_notes").update({content:k.trim(),updated_at:new Date().toISOString()}).eq("id",b).select().single();if(y)throw y;return d(i=>i.map(o=>o.id===b?E:o)),E}catch(E){throw N.error("Erreur update project note:",{error:E.message}),j(E.message),E}finally{w(!1)}},[]),D=n.useCallback(async b=>{if(b)try{w(!0),j(null);const{error:k}=await he.from("project_notes").delete().eq("id",b);if(k)throw k;d(E=>E.filter(y=>y.id!==b))}catch(k){throw N.error("Erreur suppression project note:",{error:k.message}),j(k.message),k}finally{w(!1)}},[]);return{notes:r,loading:u,saving:g,error:I,addNote:x,updateNote:$,deleteNote:D,refetch:O}}function sr({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r}){var i;const{activeAdminUser:d}=Ve(),u=r||d,[m,g]=n.useState(""),[w,I]=n.useState(!1),{getTemplateByType:j}=As(),h=j(t),O=(h==null?void 0:h.title)||t,{notes:x,loading:$,saving:D,error:b,addNote:k}=tr({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:E}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:u}),y=async()=>{if(m.trim())try{const o=await k({content:m,createdBy:(u==null?void 0:u.id)||(a==null?void 0:a.id),createdByName:(u==null?void 0:u.name)||(u==null?void 0:u.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)});o&&E&&await E({event_type:"note",title:"Note ajout√©e",description:o.content||m.trim(),metadata:{source:"notes_tab"},createdBy:(u==null?void 0:u.id)||(a==null?void 0:a.id),createdByName:(u==null?void 0:u.name)||(u==null?void 0:u.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),g("")}catch(o){N.error(o)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${O}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:m,onChange:o=>g(o.target.value),disabled:!t||D}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:y,disabled:!m.trim()||!t||D,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:D?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),b&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",b]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),x&&x.length>3&&e.jsx("button",{onClick:()=>I(!w),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:w?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx(Es,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",x.length,")"]}),e.jsx(_t,{className:"w-4 h-4"})]})})]}),$&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!$&&(x==null?void 0:x.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(i=w?x:x==null?void 0:x.slice(0,3))==null?void 0:i.map(o=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:o.created_by_name||o.created_by?`Par ${o.created_by_name||o.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:o.created_at&&new Date(o.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:o.content})]},o.id))})]})]})}const ar=({prospectId:t,projectType:s,activeAdminUser:a})=>{const{projectsData:r,appointments:d,updateAppointment:u,deleteAppointment:m,addAppointment:g,addCall:w,addTask:I,updateCall:j,updateTask:h,prospects:O}=Ve(),[x,$]=n.useState(!1),[D,b]=n.useState(null),[k,E]=n.useState(null),{users:y}=ct(),{supabaseUserId:i}=st(),{history:o,loading:T}=et({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),W=n.useMemo(()=>!o||o.length===0?[]:o.filter(A=>A.event_type==="activity").sort((A,J)=>new Date(J.created_at)-new Date(A.created_at)),[o]),S=n.useMemo(()=>{const A={};return W.forEach(ue=>{var c;const q=(c=ue.metadata)==null?void 0:c.appointment_id;q&&(A[q]||(A[q]=[]),A[q].push(ue))}),Object.entries(A).map(([ue,q])=>{var V;const z=q.sort((ce,f)=>new Date(f.created_at)-new Date(ce.created_at))[0];return{...z,currentStatus:((V=z.metadata)==null?void 0:V.status)||(z.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[W]),M=n.useMemo(()=>S?S.filter(A=>A.currentStatus==="pending"):[],[S]),ie=n.useMemo(()=>S?S.filter(A=>A.currentStatus!=="pending"):[],[S]),oe=A=>{switch((A==null?void 0:A.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(nt,{className:"h-4 w-4"});case"virtual":return e.jsx(xa,{className:"h-4 w-4"});case"call":return e.jsx(tt,{className:"h-4 w-4"});case"task":return e.jsx(na,{className:"h-4 w-4"});default:return e.jsx(nt,{className:"h-4 w-4"})}},xe=A=>{const J=(A==null?void 0:A.activity_type)||"appointment",ue=A==null?void 0:A.status;if(ue==="effectue"||ue==="completed")return"text-green-600 bg-green-50";if(ue==="annule")return"text-red-600 bg-red-50";if(ue==="reporte")return"text-yellow-600 bg-yellow-50";switch(J){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},G=A=>{var J;return!d||!((J=A.metadata)!=null&&J.appointment_id)?null:d.find(ue=>ue.id===A.metadata.appointment_id)},je=A=>{const J=G(A);J&&b(J)},Z=A=>{b(null),E({...A,type:A.type}),$(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(be,{onClick:()=>{$(!x)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),x&&e.jsx(fs,{open:x,onOpenChange:A=>{A||E(null),$(A)},initialData:k||{contactId:t,projectId:s},defaultAssignedUserId:i,addAppointment:g,addCall:w,addTask:I,updateAppointment:u,updateCall:j,updateTask:h,prospects:O||[],users:y||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),T?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(A=>{const J=G(A),ue=(J==null?void 0:J.title)||A.title||"Activit√©",q=J!=null&&J.start?new Date(J.start):new Date(A.created_at);return e.jsxs("div",{onClick:()=>je(A),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${xe(A.metadata)}`,children:oe(A.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:ue}),(J==null?void 0:J.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:J.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Ke(q,"d MMM '√†' HH:mm",{locale:Le})})]})]},A.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",ie.length,")"]}),T?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ie.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:ie.map(A=>{const J=G(A),ue=(J==null?void 0:J.title)||A.title||"Activit√©",q=J!=null&&J.start?new Date(J.start):new Date(A.created_at),c={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[A.currentStatus]||A.currentStatus;return e.jsxs("div",{onClick:()=>je(A),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${xe(A.metadata)}`,children:oe(A.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:ue}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[c," ‚Ä¢ ",Ke(q,"d MMM yyyy '√†' HH:mm",{locale:Le})]})]})]},A.id)})})]}),D&&e.jsx(rr,{event:D,onClose:()=>b(null),onReport:()=>{},onEdit:Z,prospects:O,supabaseUsers:y,updateAppointment:u,deleteAppointment:m,projectsData:r})]})},rr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:d,supabaseUsers:u,updateAppointment:m,deleteAppointment:g,projectsData:w})=>{var y;const[I,j]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&j(t.status||"pending")},[t]),!t||!d||!u||!m||!g||!w)return null;const h=d.find(i=>i.id===t.contactId),O=u.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(h?u.find(i=>i.user_id===h.ownerId):null),x=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",$=(i,o,T={})=>{try{const W=new Date(i);return isNaN(W.getTime())?"Date invalide":Ke(W,o,T)}catch{return"Date invalide"}},D=i=>{j(i),m(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},b=()=>{g(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},k=i=>{if(!h){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":h.phone&&(window.location.href=`tel:${h.phone}`);break;case"Mail":h.email&&(window.location.href=`mailto:${h.email}`);break;case"WhatsApp":if(h.phone){let o=h.phone.replace(/\D/g,"");o.startsWith("0")&&(o=`33${o.substring(1)}`);const T=encodeURIComponent("Bonjour");window.open(`https://wa.me/${o}?text=${T}`,"_blank")}break;case"GPS":if(h.address){const o=encodeURIComponent(h.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${o}`:window.open(`https://www.google.com/maps/search/?api=1&query=${o}`,"_blank")}break;default:X({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(ht,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(ft,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:x($(t.start,"eeee d MMMM",{locale:Le}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Le})," - ",$(t.end,"HH:mm",{locale:Le})]})]}),e.jsx(bt,{className:"p-0 text-left space-y-1",children:e.jsx(jt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(Ue,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),h&&e.jsxs("p",{className:"text-sm",children:[h.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"}].map(({icon:i,label:o})=>e.jsxs("button",{onClick:()=>k(o),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:o})]},o))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[I].color}`,children:e.jsxs(Tt,{onValueChange:D,value:I,children:[e.jsx(Rt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ft,{placeholder:"Qualifier votre activit√©"})}),e.jsxs($t,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx($e,{value:"effectue",children:"Effectu√©"}),e.jsx($e,{value:"annule",children:"Annul√©"}),e.jsx($e,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((y=w[t.projectId])==null?void 0:y.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(h==null?void 0:h.name)||"N/A"})]})]})]}),e.jsxs(Mt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(as,{children:[e.jsx(rs,{asChild:!0,children:e.jsxs(be,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Ot,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(os,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(cs,{children:[e.jsx(ds,{children:"Annuler"}),e.jsx(us,{onClick:b,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(be,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})},nr=({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r})=>{const{activeAdminUser:d}=Ve(),{organizationId:u}=ot(),m=r||d,[g,w]=n.useState(null),{files:I,loading:j,uploading:h,deleting:O,error:x,uploadFile:$,deleteFile:D}=bs({projectType:t,prospectId:s,organizationId:u,enabled:!!t}),{addHistoryEvent:b}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:m}),k=async S=>{const M=Array.from(S.target.files||[]);if(M.length!==0)try{const ie=M.map(async oe=>{w(oe);const xe=await $({file:oe,uploadedBy:a==null?void 0:a.id});return xe&&b&&await b({event_type:"file",title:"Fichier ajout√©",description:xe.file_name,metadata:{size:xe.file_size,type:xe.file_type,storage_path:xe.storage_path},createdBy:(m==null?void 0:m.id)||(a==null?void 0:a.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),xe});await Promise.all(ie),w(null),S.target.value=""}catch(ie){N.error("Error uploading files:",ie),w(null)}},E=async S=>{try{const{data:M,error:ie}=await he.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(ie){N.error("Error creating signed URL:",ie);return}const xe=await(await fetch(M.signedUrl)).blob(),G=window.URL.createObjectURL(xe),je=document.createElement("a");je.href=G,je.download=S.file_name,document.body.appendChild(je),je.click(),document.body.removeChild(je),window.URL.revokeObjectURL(G)}catch(M){N.error("Error downloading file:",M)}},y=async S=>{try{N.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:S.storage_path});const{data:M,error:ie}=await he.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(ie){N.error("Error creating signed URL:",ie);return}N.debug("‚úÖ Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){N.error("Error viewing file:",M)}},i=async S=>{if(confirm(`Supprimer le fichier "${S.file_name}" ?`))try{await D(S.id,S.storage_path)}catch(M){N.error("Error deleting file:",M)}},o=S=>S!=null&&S.startsWith("image/")?e.jsx(Ds,{className:"h-5 w-5 text-blue-500"}):S==="application/pdf"?e.jsx(Oe,{className:"h-5 w-5 text-red-500"}):e.jsx(oa,{className:"h-5 w-5 text-gray-500"}),T=S=>S?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(S)):"",W=S=>S?S<1024?`${S} o`:S<1024*1024?`${(S/1024).toFixed(1)} Ko`:`${(S/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Ps,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:h?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:k,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:h,multiple:!0})]})}),x&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:x}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",I.length,")"]}),j?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):I.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:I.map(S=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:o(S.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[S.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:S.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:S.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:S.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[W(S.file_size)," ‚Ä¢ ",T(S.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[S.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>y(S),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:O,children:e.jsx(ms,{className:"h-4 w-4"})}),S.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>E(S),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:O,children:e.jsx(xt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>i(S),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:O,children:e.jsx(Ot,{className:"h-4 w-4"})})]})]},S.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},ir=({prospectId:t,projectType:s,activeAdminUser:a})=>{const[r,d]=n.useState("notes"),{supabaseUserId:u}=st(),m=[{id:"notes",label:"Notes",icon:Oe},{id:"activity",label:"Activit√©",icon:fa},{id:"files",label:"Fichiers",icon:ca}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:m.map(({id:g,label:w,icon:I})=>e.jsxs("button",{onClick:()=>d(g),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===g?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx("span",{children:w})]},g))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(sr,{prospectId:t,projectType:s,currentUser:{id:u},activeAdminUser:a}),r==="activity"&&e.jsx(ar,{prospectId:t,projectType:s,activeAdminUser:a}),r==="files"&&e.jsx(nr,{prospectId:t,projectType:s,currentUser:{id:u},activeAdminUser:a})]})]})},lr=({projectType:t,prospectId:s,activeAdminUser:a})=>{const{history:r,loading:d,error:u}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:a});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),d&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),u&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",u]}),!d&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(m=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:m.title||m.event_type}),m.description&&e.jsx("p",{className:"text-xs text-gray-600",children:m.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(m.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(m.created_by_name||m.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",m.created_by_name||m.created_by]})]})]})]})]},m.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},or=({children:t,prospectId:s,projectType:a,currentStep:r,statusConfig:d,activeAdminUser:u})=>{var m,g,w;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((m=d[r.status])==null?void 0:m.iconOnly)||d.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((g=d[r.status])==null?void 0:g.badge)||d.pending.badge}`,children:((w=d[r.status])==null?void 0:w.label)||d.pending.label})]}),t]},r.name),!r&&!a&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Oe,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),a&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ir,{prospectId:s,projectType:a,activeAdminUser:u}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(lr,{prospectId:s,projectType:a,activeAdminUser:u})]})]})},cr={CLIENT:it,COMMERCIAL:Os,PARTENAIRE:Ue},dr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},ur={FORM:Oe,SIGNATURE:da},mr={FORM:"Formulaire",SIGNATURE:"Signature"},gr=({isOpen:t,onClose:s,prospectId:a,projectType:r,moduleId:d,moduleName:u,moduleConfig:m,context:g={},availableForms:w=[],availableTemplates:I=[]})=>{var V,ce;const[j,h]=n.useState(null),[O,x]=n.useState(!1),[$,D]=n.useState(null),[b,k]=n.useState(!1),E=pa(),y=n.useMemo(()=>m?m.actions&&m.actions.length>0?m.actions:m.actionConfig?[{order:1,status:"pending",actionConfig:m.actionConfig}]:[]:[],[m]),[i,o]=n.useState({}),[T,W]=n.useState(!1);n.useEffect(()=>{if(!t||!a||!d||y.length<=1){o({});return}(async()=>{W(!0);try{const P=y.map((L,K)=>`v2-${d}-action-${K}`),{data:Y,error:B}=await he.from("client_form_panels").select("id, action_id, status").eq("prospect_id",a).eq("project_type",r).in("action_id",P),te={};if(!B&&Y&&Y.length>0){for(const L of Y)L.action_id&&(L.status==="approved"||L.status==="submitted")&&(te[L.action_id]=L.status);console.log("[V2 Robot] Action statuses by action_id:",te)}else{const{data:L}=await he.from("client_form_panels").select("id, step_name, status").eq("prospect_id",a).eq("project_type",r).in("status",["approved","submitted"]);if(L){const K=L.filter(de=>!de.step_name||de.step_name===u||de.step_name===d);K.forEach((de,le)=>{le<y.length&&(te[`v2-${d}-action-${le}`]=de.status)}),console.log("[V2 Robot] Fallback legacy statuses:",te,"from",K.length,"panels")}}o(te)}catch(P){console.error("[V2 Robot] Error fetching action statuses:",P)}finally{W(!1)}})()},[t,a,r,u,d,y.length]);const S=n.useMemo(()=>y.map((f,P)=>{const Y=`v2-${d}-action-${P}`,B=i[Y];return{...f,actionId:Y,realStatus:B==="approved"?"validated":B==="submitted"?"submitted":"pending"}}),[y,i,d]),[M,ie]=n.useState(0);n.useEffect(()=>{if(t&&S.length>0&&!T){const f=S.findIndex(P=>P.realStatus!=="validated");ie(f>=0?f:S.length-1)}},[t,S,T]);const oe=S[M]||null,xe=S.length,G=xe>1,je=n.useMemo(()=>{if(!oe)return!1;const f=oe.actionConfig;return!(!f||!f.actionType||!(Array.isArray(f.targetAudience)?f.targetAudience.length>0:!!f.targetAudience))},[oe]),Z=(oe==null?void 0:oe.actionConfig)||null,A=()=>{if(!je||!Z){X({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:Z.allowedFormIds,currentActionFull:oe,allActions:S.map((f,P)=>{var Y;return{index:P,formIds:(Y=f.actionConfig)==null?void 0:Y.allowedFormIds}})});try{const f=Array.isArray(Z.targetAudience)?Z.targetAudience[0]:Z.targetAudience,P=ua({moduleId:d,moduleName:u,projectType:r,prospectId:a,actionIndex:M,actionConfig:{...Z,targetAudience:f||"CLIENT"},message:""});h(P),D(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",P)}catch(f){console.error("[V2 Robot] Erreur g√©n√©ration:",f),X({title:"Erreur",description:f.message,variant:"destructive"})}},J=async()=>{if(!j){X({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!E){X({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}x(!0),D(null);try{const f={...j,_meta:{...j._meta,isSimulation:!1}},P=await ma(f,g);D(P),P.success?(X({title:"‚úÖ Action ex√©cut√©e",description:P.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):X({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:P.message,variant:"destructive"})}catch(f){console.error("[V2 Robot] Erreur ex√©cution:",f),D({success:!1,status:"error",message:f.message}),X({title:"Erreur",description:f.message,variant:"destructive"})}finally{x(!1)}},ue=()=>{j&&(navigator.clipboard.writeText(JSON.stringify(j,null,2)),X({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},q=gt.useRef(M);n.useEffect(()=>{const f=q.current!==M;if(q.current=M,f&&(h(null),D(null)),t&&je&&!T&&(!j||f)){const P=setTimeout(()=>{A()},f?50:0);return()=>clearTimeout(P)}},[t,je,T,M]),n.useEffect(()=>{t||(h(null),D(null),k(!1),ie(0))},[t]);const c=f=>{const P=w.find(Y=>Y.id===f);return(P==null?void 0:P.name)||f},z=f=>{const P=I.find(Y=>Y.id===f);return(P==null?void 0:P.name)||f};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(gs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[u||d,G&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",M+1,"/",xe]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Je,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[G&&je&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",M+1," sur ",xe]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," termin√©e",M>1?"s":"",")"]})]}),!je&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Vt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>{X({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Ts,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),je&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:G?`Action ${M+1}/${xe}`:"Action configur√©e"}),E&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(Z==null?void 0:Z.actionType)&&e.jsxs(e.Fragment,{children:[gt.createElement(ur[Z.actionType]||Oe,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:mr[Z.actionType]||Z.actionType})]})}),(Z==null?void 0:Z.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(Z.targetAudience)?Z.targetAudience:[Z.targetAudience]).map(f=>{const P=cr[f]||it;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(P,{className:"h-3.5 w-3.5"}),dr[f]||f]},f)})]}),((V=Z==null?void 0:Z.allowedFormIds)==null?void 0:V.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",Z.allowedFormIds.map(f=>c(f)).join(", ")]}),((ce=Z==null?void 0:Z.allowedTemplateIds)==null?void 0:ce.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",Z.allowedTemplateIds.map(f=>z(f)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(Z==null?void 0:Z.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(Z==null?void 0:Z.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),j&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>k(!b),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Rs,{className:Qe("h-4 w-4 transition-transform",b&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:f=>{f.stopPropagation(),ue()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(Fs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),b&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(j,null,2)})]}),$&&e.jsxs("div",{className:Qe("rounded-lg p-4 flex items-start gap-3",$.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[$.success?e.jsx($s,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Vt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Qe("font-medium text-sm",$.success?"text-green-800":"text-red-800"),children:[$.status==="executed"&&"Ex√©cut√© avec succ√®s",$.status==="simulated"&&"Simulation uniquement",$.status==="blocked"&&"Ex√©cution bloqu√©e",$.status==="error"&&"Erreur"]}),e.jsx("p",{className:Qe("text-sm mt-1",$.success?"text-green-700":"text-red-700"),children:$.message})]})]})]})]}),je&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(be,{variant:"outline",onClick:A,disabled:O,children:[e.jsx(ms,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(be,{onClick:J,disabled:!j||O||!E,className:Qe(!E&&"opacity-50 cursor-not-allowed"),children:[O?e.jsx(Ms,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ja,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},qe="completed",Ee="in_progress",ze="pending",at={[qe]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Ee]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[ze]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Zt=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||ze}))};if(t.status!==Ee)return s;if(!s.subSteps.some(r=>r.status===Ee)){const r=s.subSteps.findIndex(d=>d.status===ze);r!==-1&&(s.subSteps=s.subSteps.map((d,u)=>({...d,status:u===r?Ee:d.status})))}return s},Ut=(t,s,a)=>{var I;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,d=r?`${s}:${r}`:null,u=d&&a?a[d]:null,m=(I=u==null?void 0:u.configJson)==null?void 0:I.actions;if(!m||m.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const j=t.subSteps.map((h,O)=>{var b,k;const x=m[O],D=((k=(b=x==null?void 0:x.config)==null?void 0:b.objective)==null?void 0:k.trim())||(x==null?void 0:x.title)||(x==null?void 0:x.label);return{...h,name:D||h.name||`Action ${O+1}`}});return{...t,subSteps:j}}const g=t.status||ze,w=m.map((j,h)=>{var O;return{id:j.id||`v2-${r}-action-${h}`,name:((O=j.config)==null?void 0:O.objective)&&j.config.objective.trim()||j.title||j.label||`Action ${h+1}`,status:g===qe?qe:g===Ee&&h===0?Ee:ze}});return{...t,subSteps:w,status:g}},xr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===qe),pr=({form:t,prospectId:s,onFormSubmit:a})=>{const[r,d]=n.useState({}),u=(g,w)=>{d(I=>({...I,[g]:w}))},m=()=>{a(s,t.id,r),X({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(g=>{if(g.show_if_conditions&&g.show_if_conditions.length>0){const I=g.condition_operator||"AND",j=g.show_if_conditions.map(O=>{const x=r[O.field];return O.equals==="has_value"?!!x&&x!=="":x===O.equals});if(!(I==="AND"?j.every(O=>O===!0):j.some(O=>O===!0)))return null}if(g.show_if){const I=g.show_if.field,j=g.show_if.equals,h=r[I];if(!h||h!==j)return null}return(t.fields||[]).some(I=>I.is_repeater&&(I.repeats_fields||[]).includes(g.id))?null:e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${g.id}`,children:g.label}),e.jsx(Be,{id:`${t.id}-${g.id}`,type:g.type,value:typeof r[g.id]=="object"?"":r[g.id]||"",onChange:I=>u(g.id,I.target.value),placeholder:g.placeholder||""}),g.is_repeater&&g.repeats_fields&&g.repeats_fields.length>0&&r[g.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[g.id])||0},(I,j)=>{const h=(t.fields||[]).filter(O=>g.repeats_fields.includes(O.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[g.label," #",j+1]}),h.map(O=>{const x=`${g.id}_repeat_${j}_${O.id}`,$=r[x];return e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${x}`,children:O.label}),e.jsx(Be,{id:`${t.id}-${x}`,type:O.type,value:typeof $=="object"?"":$||"",onChange:D=>u(x,D.target.value),placeholder:O.placeholder||""})]},x)})]},j)})})]},g.id)}),e.jsx(be,{onClick:m,className:"w-full",children:"Soumettre"})]})},hr=({prospectId:t,projectType:s,currentStepIndex:a,activeAdminUser:r})=>{var le,fe;const{addChatMessage:d,prompts:u,projectsData:m,forms:g,updateProspect:w,prospects:I,completeStepAndProceed:j,registerClientForm:h}=Ve();ct();const{messages:O,loading:x}=js(t,s),{uploadFile:$,uploading:D}=bs({projectType:s,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:b}=et({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),{user:k}=st(),[E,y]=n.useState(""),[i,o]=n.useState(null),T=n.useRef(null),W=n.useRef(null),[S,M]=n.useState(!1),[ie,oe]=n.useState(!1),{organizationId:xe}=ot(),{templates:G,loading:je}=ys(xe||(r==null?void 0:r.organization_id),s),{forms:Z,loading:A}=qs(xe||(r==null?void 0:r.organization_id)),{templates:J,loading:ue}=Vs(xe||(r==null?void 0:r.organization_id)),q=(fe=(le=m[s])==null?void 0:le.steps)==null?void 0:fe[a],c=n.useMemo(()=>q!=null&&q.name?q.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`,[q,a]),z=n.useMemo(()=>{if(!G||!c)return null;const _=G[`${s}:${c}`];return(_==null?void 0:_.configJson)||null},[G,c,s]),V=n.useMemo(()=>Z?Object.values(Z).map(_=>({id:_.id,name:_.name||_.title||"Formulaire sans nom"})):[],[Z]),ce=n.useMemo(()=>J?Array.isArray(J)?J.map(_=>({id:_.id,name:_.name||"Template sans nom"})):Object.values(J).map(_=>({id:_.id,name:_.name||"Template sans nom"})):[],[J]),f=I.find(_=>_.id===t),P=n.useMemo(()=>Object.values(u).filter(_=>{var me;if(_.projectId!==s)return!1;const ne=(me=_.stepsConfig)==null?void 0:me[a];return ne&&ne.actions&&ne.actions.length>0}),[u,s,a]),Y=n.useCallback(async(_=null)=>{var _e;const ne=P[0];if(!ne){N.warn("Aucun prompt disponible");return}const me=(_e=ne.stepsConfig)==null?void 0:_e[a];if(!me||!me.actions){N.warn("Aucune action dans la config de l'√©tape");return}const ge=[...me.actions].sort((we,Ce)=>(we.order||0)-(Ce.order||0));if(_){const we=ge.findIndex(Ce=>Ce.id===_);if(we!==-1&&we+1<ge.length){const Ce=ge[we+1];N.info("üéØ Action suivante trouv√©e",{completedActionId:_,nextActionId:Ce.id,nextActionType:Ce.type}),await de(ne,Ce.id);return}else{N.warn("Pas d'action suivante",{completedActionId:_,totalActions:ge.length});return}}await de(ne)},[P,a]);er({prospectId:t,projectType:s,currentStepIndex:a,prompt:P[0],sendNextAction:Y}),n.useEffect(()=>{requestAnimationFrame(()=>{var _;(_=T.current)==null||_.scrollIntoView({behavior:"smooth",block:"end"})})},[O]);const B=async()=>{if(!(!E.trim()&&!i))try{let _=null;if(i){if(i.size>10485760){X({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}N.debug("üì§ Uploading file from admin chat",{name:i.name,size:i.size,type:i.type});const{data:{user:ge}}=await he.auth.getUser(),_e=await $({file:i,uploadedBy:ge==null?void 0:ge.id});_e&&(_={id:_e.id,name:_e.file_name,size:_e.file_size,type:_e.file_type,storagePath:_e.storage_path},N.debug("‚úÖ File uploaded successfully",_))}d(t,s,{sender:"pro",text:E,file:_}),y(""),o(null),requestAnimationFrame(()=>{var me;(me=T.current)==null||me.scrollIntoView({behavior:"smooth",block:"end"})}),_&&X({title:"‚úÖ Fichier envoy√©",description:`${_.name} a √©t√© envoy√© avec succ√®s.`})}catch(_){N.error("‚ùå Error sending message with file",_),X({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${_.message}`,variant:"destructive"})}},te=_=>{_.target.files&&_.target.files[0]&&o(_.target.files[0])},L=async _=>{if(!_||!_.storagePath){X({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{N.debug("üì• Downloading file",{storagePath:_.storagePath});const{data:ne,error:me}=await he.storage.from("project-files").createSignedUrl(_.storagePath,3600);if(me)throw me;window.open(ne.signedUrl,"_blank"),X({title:"‚úÖ T√©l√©chargement",description:`${_.name} s'ouvre dans un nouvel onglet.`})}catch(ne){N.error("‚ùå Error downloading file",ne),X({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${ne.message}`,variant:"destructive"})}},K=(_,ne,me)=>{var Pe;const ge=I.find(ke=>ke.id===_);if(!ge)return;const _e={...ge.formData||{},...me};w({...ge,formData:_e});const we={sender:"client",text:`A compl√©t√© le formulaire : ${((Pe=g[ne])==null?void 0:Pe.name)||"Formulaire"}.`};if(d(_,s,we),Object.values(u).find(ke=>{var Se,ye;if(ke.projectId!==s)return!1;const De=(Se=ke.stepsConfig)==null?void 0:Se[a];return De!=null&&De.autoCompleteStep?(ye=De.actions)==null?void 0:ye.some(pe=>pe.type==="show_form"&&pe.formId===ne):!1})){const ke=z==null?void 0:z.actions;if(ke&&ke.length>1){X({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}j(t,s,a),X({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},de=async(_,ne=null)=>{var ge,_e,we,Ce,Pe,ke,De,Se;const me=(ge=_.stepsConfig)==null?void 0:ge[a];if(me&&me.actions&&me.actions.length>0){const ye=O,pe=[...me.actions].sort((v,H)=>(v.order||0)-(H.order||0));let se=pe,p=!1;if(ne){const v=pe.find(H=>H.id===ne);if(!v){N.warn("Action sp√©cifique introuvable",{specificActionId:ne});return}N.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:ne,actionType:v.type}),se=[v],p=!0}for(const v of se)if(!(!p&&ye.some(ae=>ae.promptId===_.id&&ae.stepIndex===a&&(ae.text===v.message||ae.formId===v.formId&&v.type==="show_form")))){if(v.message){const H={sender:"pro",text:v.message,promptId:_.id,stepIndex:a,actionId:v.id};d(t,s,H)}if(v.type==="show_form"&&v.formId){const H={sender:"pro",formId:v.formId,promptId:_.id,stepIndex:a,actionId:v.id};d(t,s,H);const ae=((Ce=(we=(_e=m[s])==null?void 0:_e.steps)==null?void 0:we[a])==null?void 0:Ce.name)||"√âtape inconnue";try{const ve=await h({prospectId:t,projectType:s,formId:v.formId,currentStepIndex:a,promptId:_.id,messageTimestamp:Date.now(),status:"pending",stepName:ae,actionId:v.id});if(!ve.success)N.error("‚ùå √âchec enregistrement formulaire:",ve.error),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const l=((Pe=g[v.formId])==null?void 0:Pe.name)||v.formId;await b({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${l} a √©t√© envoy√© √† ${(f==null?void 0:f.name)||"le client"}.`,createdBy:(k==null?void 0:k.user_id)||null,createdByName:(k==null?void 0:k.name)||"Admin"})}catch(l){N.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",l)}}catch(ve){N.error("‚ùå Exception enregistrement formulaire:",ve),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(v.type==="start_signature"&&v.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");N.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:v.templateId,prospectId:t,projectType:s,organizationId:r.organization_id,formId:v.formId});const{data:H,error:ae}=await he.from("prospects").select("form_data").eq("id",t).single(),ve=((De=(ke=H==null?void 0:H.form_data)==null?void 0:ke[s])==null?void 0:De[v.formId])||{};N.info("üìã Donn√©es formulaire extraites",{formId:v.formId,dataKeys:Object.keys(ve)}),X({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const l=await ga({templateId:v.templateId,projectType:s,prospectId:t,formData:ve,organizationId:r==null?void 0:r.organization_id});if(l.success){const C=l.fileData.id;N.debug("Cr√©ation proc√©dure de signature...",{fileId:C,prospectId:t,projectType:s});const{data:R}=await he.from("signature_procedures").select("*").eq("file_id",C).eq("prospect_id",t).eq("status","pending").maybeSingle();let F=R;if(!F){const ee=crypto.randomUUID(),re=new Date;re.setDate(re.getDate()+7);const Ne=[{role:"principal",name:(f==null?void 0:f.name)||"Client",email:f==null?void 0:f.email,phone:(f==null?void 0:f.phone)||null,access_token:ee,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const Re=typeof(f==null?void 0:f.name)=="string"&&f.name.trim()!==""?f.name:((Se=f==null?void 0:f.email)==null?void 0:Se.split("@")[0])||"Client",Ie=f==null?void 0:f.email,{data:ut,error:He}=await he.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:C,access_token:ee,access_token_expires_at:re.toISOString(),status:"pending",signers:Ne,organization_id:r.organization_id,signer_name:Re,signer_email:Ie}).select().single();if(He)throw N.error("Erreur cr√©ation signature_procedures",He),He;F=ut,N.debug("Proc√©dure de signature cr√©√©e",{procedureId:F.id,signersCount:Ne.length})}const Q=`https://evatime.fr/signature/${F.id}?token=${F.access_token}`,{data:U}=await he.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${F.id}%`).maybeSingle();U||(await he.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${Q}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id}),N.debug("Lien de signature envoy√© dans le chat")),X({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await b({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(f==null?void 0:f.name)||"le client"}.`,createdBy:(k==null?void 0:k.user_id)||null,createdByName:(k==null?void 0:k.name)||"Admin"})}catch(ee){N.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",ee)}}else throw new Error(l.error||"Erreur inconnue")}catch(H){N.error("‚ùå Exception g√©n√©ration contrat:",H),X({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${H.message}`,variant:"destructive"})}break}}M(!1)};return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[O.map((_,ne)=>e.jsxs("div",{className:`flex items-end gap-2 ${_.sender==="pro"?"justify-end":"justify-start"}`,children:[_.sender==="client"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(f==null?void 0:f.name.charAt(0))||"?"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${_.sender==="pro"?"bg-blue-500 text-white rounded-br-none p-2.5":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[_.text&&(_.sender==="pro"&&_.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:_.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:_.text})),_.file&&e.jsxs("button",{onClick:()=>L(_.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Oe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:_.file.name}),e.jsx(xt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),_.formId&&g[_.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(pr,{form:g[_.formId],prospectId:t,onFormSubmit:K})}),e.jsx("p",{className:`text-xs mt-1 ${_.sender==="pro"?"text-blue-200":"text-gray-500"}`,children:ha(new Date(_.timestamp),{addSuffix:!0,locale:Le})})]}),_.sender==="pro"&&!_.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},ne)),e.jsx("div",{ref:T})]}),i&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Bt,{className:"w-4 h-4"}),e.jsx("span",{children:i.name}),e.jsx("button",{onClick:()=>o(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Be,{placeholder:"√âcrire au client...",className:"pr-28 h-12",value:E,onChange:_=>y(_.target.value),onKeyPress:_=>_.key==="Enter"&&B()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(be,{variant:"ghost",size:"icon",onClick:()=>oe(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(gs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(be,{variant:"ghost",size:"icon",onClick:()=>W.current.click(),disabled:D,children:e.jsx(Bt,{className:`h-5 w-5 ${D?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:W,onChange:te,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:D}),e.jsx(be,{onClick:B,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:D,children:D?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Bs,{className:"h-4 w-4"})})]})]}),e.jsx(gr,{isOpen:ie,onClose:()=>oe(!1),prospectId:t,projectType:s,moduleId:c,moduleName:(q==null?void 0:q.name)||`√âtape ${a+1}`,moduleConfig:z,context:{organizationId:xe||(r==null?void 0:r.organization_id),adminUser:r},availableForms:V,availableTemplates:ce})]})},fr=({steps:t,onUpdateStatus:s,prompts:a,projectType:r,currentStepIndex:d,prospectId:u,completeStepAndProceed:m})=>{var b;if(!t)return null;const[g,w]=n.useState({}),{activeAdminUser:I,appointments:j,updateAppointment:h}=Ve(),O=a?Object.values(a).find(k=>k.projectId===r):null,x=(b=O==null?void 0:O.stepsConfig)==null?void 0:b[d],$=n.useMemo(()=>{if(!t[d])return[];const k=t[d].name,E=j.filter(y=>y.type==="task"&&y.contactId===u&&y.projectId===r&&y.step===k);return E.length>0&&N.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:u,projectType:r,stepName:k,totalAppointments:j.length,filteredTasks:E.length,tasks:E.map(y=>({id:y.id,title:y.title,contactId:y.contactId,projectId:y.projectId,step:y.step}))}),E},[j,u,r,d,t]),D=(k,E)=>{w(y=>{var S;const i=y[k]||{},o={...i,[E]:!i[E]},T={...y,[k]:o},W=(S=x==null?void 0:x.actions)==null?void 0:S.find(M=>M.id===k);return W&&W.checklist&&W.checklist.every(ie=>o[ie.id])&&x!=null&&x.autoCompleteStep&&(X({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),m(u,r,d,t)),T})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((k,E)=>{const y=at[k.status]||at[ze];return e.jsxs(Ye.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:E*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${y.iconOnly}`,children:k.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${y.text}`,children:k.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[k.subSteps&&k.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[k.subSteps.filter(i=>i.status===qe).length,"/",k.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(be,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${y.badge} hover:opacity-90`,onClick:i=>{var S;i.stopPropagation();const o=i.currentTarget,T=o.nextElementSibling,W=o.closest("[data-step-status-container]");!T||!W||((S=W.parentElement)==null||S.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==T&&M.classList.add("hidden")}),T.classList.toggle("hidden"))},children:y.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:i=>{var o;i.stopPropagation(),i.preventDefault(),s(E,Ee),(o=i.currentTarget.parentElement)==null||o.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:i=>{var o;i.stopPropagation(),i.preventDefault(),s(E,qe),(o=i.currentTarget.parentElement)==null||o.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:i=>{var o;i.stopPropagation(),i.preventDefault(),s(E,ze),(o=i.currentTarget.parentElement)==null||o.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),k.subSteps&&k.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:k.subSteps.map((i,o)=>{const T=at[i.status]||at[ze];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${i.status===qe?"bg-green-500":i.status===Ee?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:i.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${T.badge}`,children:T.label})]},i.id||o)})}),k.status===Ee&&E===d&&(x==null?void 0:x.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:x.actions.filter(i=>i.hasClientAction===!1&&i.checklist&&i.checklist.length>0).map(i=>{const o=g[i.id]||{},T=i.checklist.length,W=i.checklist.filter(M=>o[M.id]).length,S=W===T;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${S?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[W,"/",T]})]}),e.jsx("div",{className:"space-y-2",children:i.checklist.map(M=>{const ie=o[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ie,onChange:()=>D(i.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ie?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(x==null?void 0:x.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},i.id)})}),k.status===Ee&&E===d&&$.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:$.map(i=>{const o=i.status==="effectue",T=i.startTime?new Date(i.startTime):null,W=T&&!isNaN(T.getTime()),S=async()=>{const M=o?"pending":"effectue";await h(i.id,{status:M}),X({title:o?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:o?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:o?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:S,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${o?"line-through text-gray-500":""} truncate flex-1`,children:i.title||"T√¢che"}),o&&e.jsx(dt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),W&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Ke(T,"dd/MM/yyyy √† HH:mm",{locale:Le})]})]})]},i.id)})})]})]},E)})})]})},br=({prospect:t,projectType:s,supabaseSteps:a,v2Templates:r,onUpdate:d})=>{var q;const{forms:u,prompts:m,completeStepAndProceed:g,activeAdminUser:w,appointments:I,updateAppointment:j}=Ve(),{formPanels:h=[],loading:O,updateFormPanel:x}=Hs(null),{sendMessage:$}=js(t.id,s),[D,b]=n.useState(null),[k,E]=n.useState({}),[y,i]=n.useState(!1),[o,T]=n.useState(null),[W,S]=n.useState(""),[M,ie]=n.useState(new Set),oe=n.useMemo(()=>h?h.filter(c=>c.prospectId===t.id&&c.projectType===s).sort((c,z)=>(z.createdAt||0)-(c.createdAt||0)):[],[h,t.id,s]);if(n.useEffect(()=>{!oe||oe.length===0||oe.forEach(c=>{var V,ce,f,P;if(M.has(c.panelId)||c.status!=="submitted")return;if(c.lastSubmittedAt){const Y=new Date(c.lastSubmittedAt).getTime(),te=Date.now()-Y;if(te>1e4){N.debug("Form too old, skipping auto-complete",{panelId:c.panelId,ageSeconds:Math.floor(te/1e3)}),ie(L=>new Set([...L,c.panelId]));return}}N.debug("New submitted form detected",{panelId:c.panelId,formId:c.formId,projectType:c.projectType}),N.debug("Available prompts",{count:Object.keys(m).length});let z=null;if(c.promptId&&(N.debug("Searching by promptId",{promptId:c.promptId}),z=m[c.promptId]),z||(z=Object.values(m).find(Y=>{var L,K;if(N.debug("Testing prompt",{name:Y.name,projectId:Y.projectId,target:c.projectType}),Y.projectId!==c.projectType)return!1;const B=(L=Y.stepsConfig)==null?void 0:L[c.currentStepIndex];return(K=B==null?void 0:B.actions)==null?void 0:K.some(de=>de.type==="show_form"&&de.formId===c.formId)})),N.debug("Prompt found",{name:z==null?void 0:z.name,autoComplete:(ce=(V=z==null?void 0:z.stepsConfig)==null?void 0:V[c.currentStepIndex])==null?void 0:ce.autoCompleteStep}),z){const Y=(f=z.stepsConfig)==null?void 0:f[c.currentStepIndex],B=(P=Y==null?void 0:Y.actions)==null?void 0:P.find(L=>L.type==="show_form"&&L.formId===c.formId),te=(B==null?void 0:B.verificationMode)||"human";N.debug("Checking auto-complete conditions",{autoCompleteStep:Y==null?void 0:Y.autoCompleteStep,verificationMode:te}),Y!=null&&Y.autoCompleteStep&&te==="none"&&(N.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),g(t.id,c.projectType,c.currentStepIndex),X({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}ie(Y=>new Set([...Y,c.panelId]))})},[oe,m,g,t.id,t.name,M]),oe.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const xe=c=>{b(c.panelId);const ce=((t.form_data||t.formData||{})[c.projectType]||{})[c.formId]||{};E({...ce,_meta:{projectType:c.projectType,formId:c.formId}})},G=()=>{b(null),E({})},je=async()=>{const{_meta:c,...z}=k,{projectType:V,formId:ce}=c||{};if(!V||!ce){N.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const f=t.form_data||t.formData||{},P={...f,[V]:{...f[V]||{},[ce]:z}},{error:Y}=await he.from("prospects").update({form_data:P}).eq("id",t.id);if(Y){N.error("‚ùå Erreur sauvegarde formulaire:",Y),X({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}X({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),d&&d({...t,form_data:P,formData:P}),b(null),E({})},Z=(c,z)=>{E(V=>({...V,[c]:z}))},A=c=>{var ce,f;const z=Object.values(m).find(P=>P.id===c.promptId||P.projectId===c.projectType),V=(ce=z==null?void 0:z.stepsConfig)==null?void 0:ce[c.currentStepIndex];return(f=V==null?void 0:V.actions)==null?void 0:f.find(P=>P.formId===c.formId)},J=async c=>{var z,V,ce,f,P,Y;try{await x(c.panelId,{status:"approved"});const B=A(c),te=(B==null?void 0:B.verificationMode)||"human";if(N.debug("üîç Checking verification mode",{verificationMode:te,shouldSearchTask:te==="human"}),te==="human"){N.debug("üîç Searching for related task",{totalAppointments:(I==null?void 0:I.length)||0,prospectId:t.id,projectType:c.projectType,stepName:c.stepName,panel:c});const Se=(I==null?void 0:I.filter(se=>se.type==="task"))||[],ye=Se.filter(se=>se.contactId===t.id);N.debug("üîç Task filtering debug",{allTasks:Se.length,prospectTasks:ye.length,prospectTasksData:ye.map(se=>({id:se.id,title:se.title,contactId:se.contactId,projectId:se.projectId,step:se.step,status:se.status}))}),N.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:c.projectType,step:c.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let pe=I==null?void 0:I.find(se=>{var H;const p={isTask:se.type==="task",contactMatch:se.contactId===t.id,projectMatch:se.projectId===c.projectType,stepMatch:se.step===c.stepName,isPending:se.status==="pending",titleMatch:(H=se.title)==null?void 0:H.includes("V√©rifier le formulaire")},v=Object.values(p).every(ae=>ae);return!v&&se.type==="task"&&se.contactId===t.id&&N.warn("üîç Task failed matching:",{taskId:se.id,title:se.title,checks:p,COMPARISON:{taskStep:`"${se.step}"`,panelStep:`"${c.stepName}"`,areEqual:se.step===c.stepName,taskStepType:typeof se.step,panelStepType:typeof c.stepName},taskData:{contactId:se.contactId,projectId:se.projectId,step:se.step,status:se.status},panelData:{projectType:c.projectType,stepName:c.stepName}}),v});pe||(N.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:c.stepName}),pe=I==null?void 0:I.find(se=>{var p;return se.type==="task"&&se.contactId===t.id&&se.projectId===c.projectType&&se.status==="pending"&&((p=se.title)==null?void 0:p.includes("V√©rifier le formulaire"))}),pe&&N.info("‚úÖ Found task via fallback (without step match)",{taskId:pe.id,taskStep:pe.step})),pe?(N.info("‚úÖ Found verification task, marking as completed",{taskId:pe.id,prospectId:t.id,title:pe.title}),await j(pe.id,{status:"effectue"}),X({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):N.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:c.projectType,step:c.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else N.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:te});const L=a==null?void 0:a[c.projectType],K=(L==null?void 0:L.findIndex(Se=>Se.status==="in_progress"))??c.currentStepIndex,de=(z=L==null?void 0:L[K])==null?void 0:z.name,le=de?de.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,fe=le&&r?r[`${s}:${le}`]:null,_=(V=fe==null?void 0:fe.configJson)==null?void 0:V.actionConfig,ne=de?ps(de):null,me=(_==null?void 0:_.completionTrigger)||(ne==null?void 0:ne.completionTrigger),ge=(ce=fe==null?void 0:fe.configJson)==null?void 0:ce.actions,_e=ge&&ge.length>1;let we=!0;if(_e){const Se=ge.map((p,v)=>`v2-${le}-action-${v}`),{data:ye}=await he.from("client_form_panels").select("id, action_id").eq("prospect_id",t.id).eq("project_type",c.projectType).eq("status","approved").in("action_id",Se);let pe=new Set((ye||[]).map(p=>p.action_id));if(pe.size===0){const{data:p}=await he.from("client_form_panels").select("id, step_name").eq("prospect_id",t.id).eq("project_type",c.projectType).eq("status","approved");(p||[]).filter(H=>!H.step_name||H.step_name===de||H.step_name===le).forEach((H,ae)=>{ae<ge.length&&pe.add(`v2-${le}-action-${ae}`)})}const se=pe.size;we=se>=ge.length,N.debug("[V2] Multi-actions check (by action_id)",{totalActions:ge.length,approvedActionIds:[...pe],allCompleted:we}),we||(N.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:ge.length-se}),X({title:"‚úÖ Action valid√©e",description:`Action ${se}/${ge.length} ‚Äî il reste ${ge.length-se} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}N.debug("[V2] Checking completionTrigger for form approval",{stepName:de,moduleId:le,v2TemplateFound:!!fe,completionTrigger:me,currentStepIdx:K,hasMultiActions:_e,allActionsCompleted:we});const Ce=(me==="form_approved"||!me)&&we;let Pe=L;if(L&&((P=(f=L[K])==null?void 0:f.subSteps)==null?void 0:P.length)>0&&c.action_id){const Se=L[K],ye=Se.subSteps.findIndex(pe=>pe.id===c.action_id);if(ye!==-1){N.debug("[V2] Updating substep for approved action",{actionId:c.action_id,subStepIndex:ye,subStepName:Se.subSteps[ye].name,allActionsCompleted:we});const pe=JSON.parse(JSON.stringify(L));if(pe[K].subSteps[ye].status=qe,!we){const se=pe[K].subSteps.findIndex((p,v)=>v>ye&&p.status===ze);se!==-1&&(pe[K].subSteps[se].status=Ee)}await updateSupabaseSteps(c.projectType,pe),Pe=pe,N.info("[V2] Substep updated successfully",{completedSubStep:ye,nextActivated:!we})}}if(Ce&&Pe)N.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:c.projectType,currentStepIdx:K,stepName:de,trigger:me||"default_behavior"}),await g(t.id,c.projectType,K,Pe),X({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const Se=Object.values(m).find(ye=>ye.id===c.promptId||ye.projectId===c.projectType);if(Se){const ye=(Y=Se.stepsConfig)==null?void 0:Y[c.currentStepIndex];ye!=null&&ye.autoCompleteStep&&(N.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:c.projectType,stepIndex:c.currentStepIndex}),L?await g(t.id,c.projectType,c.currentStepIndex,L):N.error("No steps found in supabaseSteps for projectType",{projectType:c.projectType}))}}const ke=(B==null?void 0:B.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:De}=await he.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",c.projectType).eq("sender","admin").eq("text",ke).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!De||De.length===0?await $({sender:"admin",text:ke,relatedMessageTimestamp:new Date().toISOString()}):N.debug("Message de validation d√©j√† envoy√© r√©cemment, skip"),X({title:"‚úÖ Formulaire valid√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(B){N.error("‚ùå Erreur validation formulaire:",B),X({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},ue=async(c="")=>{if(o)try{const z=o;await x(z.panelId,{status:"rejected"});const V=A(z),ce=(V==null?void 0:V.verificationMode)||"human";if(N.debug("üîç Checking verification mode (reject)",{verificationMode:ce,shouldSearchTask:ce==="human"}),ce==="human"){N.debug("üîç Searching for related task (reject)",{totalAppointments:(I==null?void 0:I.length)||0,prospectId:t.id,projectType:z.projectType,stepName:z.stepName}),N.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:z.projectType,step:z.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let Y=I==null?void 0:I.find(B=>{var K;const te={isTask:B.type==="task",contactMatch:B.contactId===t.id,projectMatch:B.projectId===z.projectType,stepMatch:B.step===z.stepName,isPending:B.status==="pending",titleMatch:(K=B.title)==null?void 0:K.includes("V√©rifier le formulaire")},L=Object.values(te).every(de=>de);return!L&&B.type==="task"&&B.contactId===t.id&&N.warn("üîç Task failed matching (REJECT):",{taskId:B.id,title:B.title,checks:te,COMPARISON:{taskStep:`"${B.step}"`,panelStep:`"${z.stepName}"`,areEqual:B.step===z.stepName,taskStepType:typeof B.step,panelStepType:typeof z.stepName},taskData:{contactId:B.contactId,projectId:B.projectId,step:B.step,status:B.status},panelData:{projectType:z.projectType,stepName:z.stepName}}),L});Y||(N.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:z.stepName}),Y=I==null?void 0:I.find(B=>{var te;return B.type==="task"&&B.contactId===t.id&&B.projectId===z.projectType&&B.status==="pending"&&((te=B.title)==null?void 0:te.includes("V√©rifier le formulaire"))}),Y&&N.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:Y.id,taskStep:Y.step})),Y&&(N.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:Y.id,prospectId:t.id,title:Y.title}),await j(Y.id,{status:"effectue"}))}else N.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:ce});const P=`${(V==null?void 0:V.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${c}`;await $({sender:"admin",text:P,relatedMessageTimestamp:new Date().toISOString()}),X({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"}),i(!1),T(null),S("")}catch(z){N.error("‚ùå Erreur rejet formulaire:",z),X({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[oe.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:oe.map(c=>{const z=u[c.formId],f=((t.form_data||t.formData||{})[c.projectType]||{})[c.formId]||{};return z?e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:z.name}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",c.stepName||"Non sp√©cifi√©e"]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${c.status==="submitted"?"bg-green-100 text-green-700":c.status==="approved"?"bg-blue-100 text-blue-700":c.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:c.status==="submitted"?"Envoy√©":c.status==="approved"?"Approuv√©":c.status==="rejected"?"Rejet√©":"En attente"})]}),c.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsx("p",{className:"text-sm text-green-700",children:"‚úÖ Client a soumis ce formulaire"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(be,{size:"sm",onClick:()=>J(c),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(dt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(be,{size:"sm",variant:"outline",onClick:()=>{T(c),i(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(z.fields||[]).map(P=>{if(P.show_if_conditions&&P.show_if_conditions.length>0){const L=P.condition_operator||"AND",K=P.show_if_conditions.map(le=>{const fe=f[le.field];return le.equals==="has_value"?!!fe&&fe!=="":fe===le.equals});if(!(L==="AND"?K.every(le=>le===!0):K.some(le=>le===!0)))return null}if(P.show_if){const L=P.show_if.field,K=P.show_if.equals,de=f[L];if(!de||de!==K)return null}if((z.fields||[]).some(L=>L.is_repeater&&(L.repeats_fields||[]).includes(P.id)))return null;const B=f[P.id],te=P.type==="file"&&typeof B=="object"&&(B==null?void 0:B.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-sm font-medium text-gray-600",children:P.label}),D===c.panelId?te?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Oe,{className:"inline h-4 w-4 mr-2"}),B.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):P.type==="select"?e.jsxs("select",{value:k[P.id]||"",onChange:L=>Z(P.id,L.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(P.options||[]).map((L,K)=>e.jsx("option",{value:L,children:L},K))]}):e.jsx(Be,{type:P.type||"text",value:k[P.id]||"",onChange:L=>Z(P.id,L.target.value),placeholder:P.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:te?e.jsxs("button",{onClick:async()=>{try{const{data:L,error:K}=await he.storage.from("project-files").createSignedUrl(B.storagePath,3600);if(K)throw K;window.open(L.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx("span",{children:B.name}),e.jsx(xt,{className:"h-3 w-3"})]}):B||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),P.is_repeater&&P.repeats_fields&&P.repeats_fields.length>0&&B&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(B)||0},(L,K)=>{const de=(z.fields||[]).filter(le=>P.repeats_fields.includes(le.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[P.label," #",K+1]}),de.map(le=>{const fe=`${P.id}_repeat_${K}_${le.id}`,_=f[fe],ne=le.type==="file"&&typeof _=="object"&&(_==null?void 0:_.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:le.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:ne?e.jsxs("button",{onClick:async()=>{try{const{data:me,error:ge}=await he.storage.from("project-files").createSignedUrl(_.storagePath,3600);if(ge)throw ge;window.open(me.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Oe,{className:"h-3 w-3"}),e.jsx("span",{children:_.name}),e.jsx(xt,{className:"h-3 w-3"})]}):_||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},fe)})]},K)})})]},P.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D===c.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(be,{variant:"outline",size:"sm",onClick:G,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(be,{size:"sm",onClick:je,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(zt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>xe(c),children:[e.jsx(pt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},c.panelId):null})}),e.jsx(ht,{open:y,onOpenChange:i,children:e.jsxs(ft,{className:"max-w-lg",children:[e.jsxs(bt,{children:[e.jsx(jt,{children:"Rejeter le formulaire"}),e.jsx(hs,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((q=A(o))==null?void 0:q.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Me,{children:"Raison du refus"}),e.jsx("textarea",{value:W,onChange:c=>S(c.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Mt,{children:[e.jsx(be,{variant:"outline",onClick:()=>{i(!1),T(null),S("")},children:"Annuler"}),e.jsx(be,{onClick:()=>ue(W),disabled:!W.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},jr=({prospect:t,projectType:s,onUpdate:a})=>{const{forms:r}=Ve(),[d,u]=n.useState(null),[m,g]=n.useState({}),w=n.useMemo(()=>Object.values(r).filter(x=>x.audience==="internal"&&(x.projectIds||[]).includes(s)),[r,s]);n.useEffect(()=>{if(t&&t.form_data){const x=t.form_data[s]||{};g(x)}},[t,s]);const I=x=>{u(x)},j=()=>{if(u(null),t&&t.form_data){const x=t.form_data[s]||{};g(x)}},h=(x,$,D)=>{g(b=>({...b,[x]:{...b[x]||{},[$]:D}}))},O=async()=>{try{const x={...t.form_data||{},[s]:m},$={...t,form_data:x,formData:x};await a($),X({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),u(null)}catch(x){N.error("Erreur sauvegarde formulaire interne:",x),X({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[w.length," formulaire(s)"]})]}),w.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:w.map(x=>{const $=m[x.id]||{},D=d===x.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:x.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(x.fields||[]).map(b=>{if(b.show_if_conditions&&b.show_if_conditions.length>0){const y=b.condition_operator||"AND",i=b.show_if_conditions.map(T=>{const W=$[T.field];return T.equals==="has_value"?!!W&&W!=="":W===T.equals});if(!(y==="AND"?i.every(T=>T===!0):i.some(T=>T===!0)))return null}if(b.show_if){const y=b.show_if.field,i=b.show_if.equals,o=$[y];if(!o||o!==i)return null}if((x.fields||[]).some(y=>y.is_repeater&&(y.repeats_fields||[]).includes(b.id)))return null;const E=$[b.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Me,{className:"text-sm font-medium text-gray-600",children:[b.label,b.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),D?b.type==="textarea"?e.jsx("textarea",{value:E,onChange:y=>h(x.id,b.id,y.target.value),placeholder:b.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):b.type==="select"?e.jsxs("select",{value:E,onChange:y=>h(x.id,b.id,y.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(b.options||[]).map((y,i)=>e.jsx("option",{value:y,children:y},i))]}):e.jsx(Be,{type:b.type||"text",value:E,onChange:y=>h(x.id,b.id,y.target.value),placeholder:b.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:E||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),b.is_repeater&&b.repeats_fields&&b.repeats_fields.length>0&&E&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(E)||0},(y,i)=>{const o=(x.fields||[]).filter(T=>b.repeats_fields.includes(T.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[b.label," #",i+1]}),o.map(T=>{const W=`${b.id}_repeat_${i}_${T.id}`,S=$[W]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:T.label}),D?T.type==="textarea"?e.jsx("textarea",{value:S,onChange:M=>h(x.id,W,M.target.value),placeholder:T.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):T.type==="select"?e.jsxs("select",{value:S,onChange:M=>h(x.id,W,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(T.options||[]).map((M,ie)=>e.jsx("option",{value:M,children:M},ie))]}):e.jsx(Be,{type:T.type||"text",value:S,onChange:M=>h(x.id,W,M.target.value),placeholder:T.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:S||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},W)})]},i)})})]},b.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D?e.jsxs(e.Fragment,{children:[e.jsxs(be,{variant:"outline",size:"sm",onClick:j,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(be,{size:"sm",onClick:O,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(zt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>I(x.id),children:[e.jsx(pt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},x.id)})})]})},yr=t=>{switch(t.type){case"email":return e.jsx(yt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(tt,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Gs,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(vt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(it,{className:"h-4 w-4 text-gray-400"}):e.jsx(Ws,{className:"h-4 w-4 text-gray-400"})}},vr=({prospect:t,onBack:s,onUpdate:a,onEditingChange:r})=>{var ve;const{getProjectSteps:d,completeStepAndProceed:u,updateProjectSteps:m,markNotificationAsRead:g,projectsData:w,formContactConfig:I,currentUser:j,userProjects:h,setUserProjects:O,getProjectInfo:x,updateProjectInfo:$,activeAdminUser:D,prompts:b,notifications:k}=Ve(),{supabaseUserId:E}=st(),{users:y,loading:i}=ct(),{projectStepsStatus:o,updateProjectSteps:T}=la(t.id),{organizationId:W}=ot(),{templates:S}=ys(W||(D==null?void 0:D.organization_id),null),[M,ie]=xs(),oe=M.get("project")||t._selectedProjectType,xe=M.get("notificationId"),[G,je]=n.useState(oe||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:Z,addProjectEvent:A}=et({projectType:G||"",prospectId:t.id,enabled:!!G&&!!t.id,activeAdminUser:D}),[J,ue]=n.useState(!1),[q,c]=n.useState(t);n.useEffect(()=>{c(t)},[t]);const[z,V]=n.useState(!1),ce=n.useMemo(()=>G?x(t.id,G)||{}:{},[G,x,t.id]),[f,P]=n.useState((ce==null?void 0:ce.status)||"actif"),[Y,B]=n.useState({}),te=ce==null?void 0:ce.amount,L=n.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[K,de]=n.useState(""),[le,fe]=n.useState(!1),_=n.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...y.map(l=>({value:l.user_id,label:l.name}))],[y]),ne=n.useMemo(()=>{var C;if(!G)return[];if(o[G])return o[G].map(R=>Ut(R,G,S)).map(Zt);const l=(C=w[G])==null?void 0:C.steps;if(l&&l.length>0){const R=JSON.parse(JSON.stringify(l));return R[0].status="in_progress",R.map(F=>Ut(F,G,S)).map(Zt)}return[]},[G,o,w,S]),me=ne.findIndex(l=>l.status===Ee),ge=ne[me]||ne.find(l=>l.status===ze)||ne[0];n.useEffect(()=>{if(xe){g(parseInt(xe));const l=new URLSearchParams(M);l.delete("notificationId"),ie(l,{replace:!0})}},[xe,g,ie,M]),n.useEffect(()=>{var C;const l=M.get("project");l&&l!==G&&((C=t.tags)!=null&&C.includes(l))&&je(l)},[M,t.tags]),n.useEffect(()=>{if(!(t!=null&&t.id)||!G||!k||!g)return;const l=k.filter(C=>!C.read&&C.prospectId===t.id&&C.projectType===G);l.length>0&&l.forEach(C=>{g(C.id)})},[t==null?void 0:t.id,G,k,g]),n.useEffect(()=>{N.debug("Prospect prop changed",{name:t.name}),c(t)},[t]),n.useEffect(()=>{le||(te==null||te===""?de(""):de(te.toString()))},[te,le]),n.useEffect(()=>{(async()=>{var F;if(!G||!t.id)return;const{data:C,error:R}=await he.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",G).maybeSingle();R?(N.error("Erreur chargement project status:",R),P("actif")):(F=C==null?void 0:C.data)!=null&&F.status?P(C.data.status):P("actif")})()},[G,t.id]),n.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:C,error:R}=await he.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(C){const F={};C.forEach(Q=>{F[Q.project_type]=Q.status||"actif"}),B(F)}})()},[t.id,t.tags]),n.useEffect(()=>{r&&r(J)},[J,r]),n.useEffect(()=>{if(!t.id)return;const l=he.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async C=>{var Re;const{new:R,old:F}=C;if(R.status!=="signed"||(F==null?void 0:F.status)==="signed")return;const Q=R.project_type;N.info("[V2 Signature Listener] Signature completed",{procedureId:R.id,projectType:Q,prospectId:R.prospect_id});const U=o==null?void 0:o[Q];if(!U||U.length===0){N.warn("[V2 Signature Listener] No steps found for project type",{projectType:Q});return}const ee=U.findIndex(Ie=>Ie.status==="in_progress");if(ee===-1){N.warn("[V2 Signature Listener] No current step in_progress",{projectType:Q});return}const re=(Re=U[ee])==null?void 0:Re.name;if(!re){N.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:ee});return}const Ne=ps(re);if((Ne==null?void 0:Ne.completionTrigger)!=="signature"){N.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:re,completionTrigger:(Ne==null?void 0:Ne.completionTrigger)||"null"});return}N.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:Q,currentStepIdx:ee,stepName:re});try{await u(t.id,Q,ee,U),X({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${re}"`,className:"bg-green-500 text-white"})}catch(Ie){N.error("[V2 Signature Listener] Error completing step",Ie)}}).subscribe();return()=>{he.removeChannel(l)}},[t.id,o,u]);const _e=l=>{je(l),ie(C=>(C.set("project",l),C),{replace:!0})},we=async l=>{if(!G||!t.id)return;const C=f;P(l);try{const{error:R}=await he.from("project_infos").upsert({prospect_id:t.id,project_type:G,status:l,data:(ce==null?void 0:ce.data)||{}},{onConflict:"prospect_id,project_type"});if(R)throw R;const F={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:Q}=await he.from("project_history").insert({prospect_id:t.id,project_type:G,event_type:"status",description:`Projet ${F[l]||l}`,organization_id:D==null?void 0:D.organization_id,metadata:{old_status:C,new_status:l}});Q&&N.error("Erreur historique:",Q),$(t.id,G,(U={})=>({...U,status:l})),B(U=>({...U,[G]:l})),X({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${F[l]}".`,className:"bg-green-500 text-white"})}catch(R){N.error("Erreur lors du changement de statut:",R),P(C),X({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},Ce=l=>{de(l)},Pe=l=>{if(!G)return;const C=l.replace(",",".").trim();if(C===""){$(t.id,G,(Q={})=>{if(!Q.amount)return Q;const U={...Q};return delete U.amount,U}),de("");return}const R=parseFloat(C);if(Number.isNaN(R)||R<0){de(te==null?"":te.toString());return}const F=Math.round(R*100)/100;$(t.id,G,(Q={})=>({...Q,amount:F})),de(F.toFixed(2))},ke=()=>{Pe(K),fe(!1)},De=l=>{l.key==="Enter"&&(l.preventDefault(),Pe(l.currentTarget.value),l.currentTarget.blur(),fe(!1))},Se=async(l,C)=>{var F,Q;const R=ne[l];if(C===qe&&((F=R==null?void 0:R.subSteps)==null?void 0:F.length)>0&&!xr(R)){X({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(C===Ee&&((Q=R==null?void 0:R.subSteps)==null?void 0:Q.length)>0){const U=JSON.parse(JSON.stringify(ne)),ee=U[l];ee.status=Ee,ee.subSteps=ee.subSteps.map((re,Ne)=>({...re,status:Ne===0?Ee:ze})),await T(G,U),Z&&await Z({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${ee.name} ¬ª`,metadata:{step_id:(ee==null?void 0:ee.id)||null,step_name:(ee==null?void 0:ee.name)||null,previous_status:(R==null?void 0:R.status)||null,new_status:Ee,project_type:G},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)});return}if(C===qe){const U=JSON.parse(JSON.stringify(ne));U[l].status="completed";let ee=l+1;if(ee<U.length&&(U[ee].status="in_progress"),await T(G,U),Z){const re=ee<U.length?U[ee]:null;await Z({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:R&&re?`√âtape ¬´ ${R.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${re.name} ¬ª`:`√âtape ¬´ ${R.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(R==null?void 0:R.id)||null,previous_step_name:(R==null?void 0:R.name)||null,previous_step_status:(R==null?void 0:R.status)||null,new_step_id:(re==null?void 0:re.id)||null,new_step_name:(re==null?void 0:re.name)||null,new_step_status:"in_progress",project_type:G},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}if(ee<U.length&&U[ee].globalStepId){const re=U[ee].globalStepId,Ne={...t,status:re};a(Ne),X({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const U=ne.map((re,Ne)=>{let Re=re.status;return Ne===l&&(Re=C),{...re,status:Re}});if(await T(G,U),Z){const re=U[l];await Z({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${re.name} ¬ª pass√©e de ¬´ ${R.status==="pending"?"√Ä venir":R.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${C==="pending"?"√Ä venir":C==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(re==null?void 0:re.id)||null,step_name:(re==null?void 0:re.name)||null,previous_status:(R==null?void 0:R.status)||null,new_status:C,project_type:G},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}const ee=U[l];if(ee.globalStepId&&C==="in_progress"){const re={...t,status:ee.globalStepId};a(re)}}},ye=async l=>{var R,F;const C=q.tags||[];if(!C.includes(l)){const Q={...q,tags:[...C,l]};if(c(Q),a(Q),je(l),j&&t.id===j.id&&!h.includes(l)){const ee=[...h,l];O(ee)}const U=(R=w[l])==null?void 0:R.steps;if(U&&U.length>0)try{const ee=JSON.parse(JSON.stringify(U));ee[0].status="in_progress",await T(l,ee),N.debug("Steps initialized in Supabase",{projectType:l})}catch(ee){N.error("Steps initialization error:",ee)}X({title:"‚úÖ Projet ajout√© !",description:`Le projet ${(F=w[l])==null?void 0:F.title} a √©t√© associ√© au prospect.`})}V(!1)},pe=()=>{const l=q.tags||[];return Object.values(w).filter(C=>C.isPublic&&!l.includes(C.type))},se=async l=>{switch(l){case"Appel":q.phone&&(window.location.href=`tel:${q.phone}`);break;case"Mail":q.email&&(window.location.href=`mailto:${q.email}`);break;case"WhatsApp":if(q.phone){const C=q.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${C}`,"_blank")}else X({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const C=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${C}`:window.open(`https://www.google.com/maps/search/?api=1&query=${C}`,"_blank")}break;case"Invitation":if(!q.email){X({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const C=`${window.location.origin}/dashboard`,R=W||(D==null?void 0:D.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",q.email,"org:",R);const{error:F}=await he.auth.signInWithOtp({email:q.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:C,data:{organization_id:R}}});F?(console.error("[handleActionClick] ‚ùå Magic link error:",F),X({title:"‚ùå Erreur envoi invitation",description:F.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",q.email),X({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${q.email}`,className:"bg-green-500 text-white"}))}catch(C){console.error("[handleActionClick] üí• Exception:",C),X({title:"‚ùå Erreur",description:C.message,variant:"destructive"})}break;default:X({title:`Action: ${l}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},p=()=>{const l=window.scrollY;ue(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:l,behavior:"instant"})})})},v=()=>{try{a(q),ue(!1),X({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(l){N.error("‚ùå Erreur sauvegarde:",l),X({title:"‚ùå Erreur",description:l.message,variant:"destructive"})}},H=(l,C)=>{c(R=>({...R,[l]:C}))},ae=l=>{let C=l;l==="unassigned"?C=null:l==="user-1"&&E&&(C=E),c(R=>({...R,ownerId:C}))};return w[G],n.useEffect(()=>{const l=document.createElement("style");return l.id="disable-auto-scroll",l.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(l),()=>{const C=document.getElementById("disable-auto-scroll");C&&C.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(be,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(zs,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:q.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(be,{size:"icon",className:"rounded-full",onClick:()=>V(!0),children:e.jsx(Pt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(q.tags||[]).map(l=>{var R;const C=Y[l]||"actif";return e.jsxs("button",{onClick:()=>_e(l),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${G===l?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((R=w[l])==null?void 0:R.title)||l}),C==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${G===l?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),C==="archive"&&e.jsx("span",{className:`text-xs font-medium ${G===l?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},l)}),(!q.tags||q.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"},{icon:Ls,label:"Invitation",highlight:!q.userId}].map(({icon:l,label:C,highlight:R})=>e.jsxs("button",{onClick:()=>se(C),className:`flex flex-col items-center space-x-1 transition-colors group ${R?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${R?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(l,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:C})]},C))})]}),e.jsx(Nr,{prospectId:t.id,projectType:G}),e.jsx(br,{prospect:q,projectType:G,supabaseSteps:o,v2Templates:S,onUpdate:l=>{c(l),a&&a(l)}}),e.jsx(jr,{prospect:q,projectType:G,onUpdate:l=>{c(l),a&&a(l)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),J?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:v,children:e.jsx(zt,{className:"h-4 w-4"})}),e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>ue(!1),children:e.jsx(Je,{className:"h-4 w-4"})})]}):e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:p,children:e.jsx(pt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[I.map(l=>e.jsxs("div",{className:"flex items-start space-x-3",children:[yr(l),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{htmlFor:l.id,className:"text-xs text-gray-500",children:l.name.replace("*","")}),J?e.jsx(Be,{id:l.id,name:l.id,type:l.type,value:q[l.id]||"",onChange:C=>H(l.id,C.target.value),className:"h-8 text-sm",placeholder:l.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:q[l.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},l.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(it,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"Suivi par"}),J?e.jsx(ia,{options:_,value:q.ownerId||"unassigned",onSelect:ae,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((ve=y.find(l=>l.user_id===q.ownerId))==null?void 0:ve.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(it,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(or,{prospectId:t.id,projectType:G,currentStep:ge,statusConfig:at,activeAdminUser:D,children:G&&e.jsx(hr,{prospectId:t.id,projectType:G,currentStepIndex:me!==-1?me:0,activeAdminUser:D})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[G&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>fe(!le),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:le?"Annuler":"Modifier le montant",children:le?e.jsx(Je,{className:"h-4 w-4 text-gray-600"}):e.jsx(pt,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),le?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(Be,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:K,onChange:l=>Ce(l.target.value),onKeyDown:De,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(be,{size:"sm",onClick:ke,className:"h-8",children:e.jsx(dt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof te=="number"?L.format(te):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Tt,{value:f,onValueChange:we,children:[e.jsx(Rt,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${f==="actif"?"bg-green-100 text-green-700":f==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Ft,{})}),e.jsxs($t,{className:"w-44",children:[e.jsx($e,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx($e,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx($e,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(fr,{steps:ne,onUpdateStatus:Se,prompts:b,projectType:G,currentStepIndex:me,prospectId:t.id,completeStepAndProceed:u})]})]})]})]}),e.jsx(ht,{open:z,onOpenChange:V,children:e.jsxs(ft,{className:"sm:max-w-md",children:[e.jsxs(bt,{children:[e.jsx(jt,{children:"Ajouter un projet"}),e.jsx(hs,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:pe().length>0?pe().map(l=>e.jsxs(be,{variant:"outline",onClick:()=>ye(l.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:l.icon}),e.jsx("span",{className:"font-medium",children:l.title})]},l.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},Nr=({prospectId:t,projectType:s})=>{var Z;const{activeAdminUser:a,prospects:r,projectsData:d,appointments:u,agendaLoading:m,updateAppointment:g,deleteAppointment:w,addAppointment:I,addCall:j,addTask:h,updateCall:O,updateTask:x}=Ve(),{users:$,loading:D}=ct(),{supabaseUserId:b}=st(),[k,E]=n.useState(null),[y,i]=n.useState(null),[o,T]=n.useState(null),[W,S]=n.useState(!1),[M,ie]=n.useState(null),oe=n.useMemo(()=>!u||u.length===0?[]:u.filter(J=>{var q;if(J.contactId!==t||s&&J.projectId!==s)return!1;const ue=(q=J.status)==null?void 0:q.toLowerCase();return!(ue!=="pending"&&ue!=="prevu")}).sort((J,ue)=>{const q=new Date(J.start),c=new Date(ue.start);return q-c}),[u,t,s]),xe=(A,J)=>{T(A)},G=()=>{E(null),i(null),T(null)},je=A=>{T(null),ie({...A,type:A.type}),S(!0)};return m?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(Z=d[s])==null?void 0:Z.title})`]})}),oe.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:oe.map(A=>{const J=new Date(A.start),ue={physical:{icon:nt,color:"blue",label:"üìç RDV"},virtual:{icon:nt,color:"purple",label:"üé• Visio"},call:{icon:tt,color:"green",label:"üìû Appel"},task:{icon:dt,color:"yellow",label:"‚úÖ T√¢che"}},q=ue[A.type]||ue.physical,c=q.icon,z={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},V={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>xe(A,A.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${q.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(c,{className:`h-5 w-5 text-${q.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:A.title||q.label}),A.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:A.notes}),A.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",A.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${q.color}-700 bg-${q.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Ke(J,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Ke(J,"HH:mm")})]})]}),V[A.status]&&A.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${z[A.status]}`,children:V[A.status]})]},A.id)})})]}),e.jsx(wr,{event:o,onClose:G,onReport:()=>{},onEdit:je,prospects:r,supabaseUsers:$,updateAppointment:g,deleteAppointment:w,projectsData:d}),W&&e.jsx(fs,{open:W,onOpenChange:A=>{A||ie(null),S(A)},initialData:M||{contactId:t,projectId:s},defaultAssignedUserId:b,addAppointment:I,addCall:j,addTask:h,updateAppointment:g,updateCall:O,updateTask:x,prospects:r||[],users:$||[],projectsData:d||{}})]})},wr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:d,supabaseUsers:u,updateAppointment:m,deleteAppointment:g,projectsData:w})=>{var y;const[I,j]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&j(t.status||"pending")},[t]),!t||!d||!u||!m||!g||!w)return null;const h=d.find(i=>i.id===t.contactId),O=u.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(h?u.find(i=>i.user_id===h.ownerId):null),x=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",$=(i,o,T={})=>{try{const W=new Date(i);return isNaN(W.getTime())?"Date invalide":Ke(W,o,T)}catch{return"Date invalide"}},D=i=>{j(i),m(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},b=()=>{g(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},k=i=>{if(!h){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":h.phone&&(window.location.href=`tel:${h.phone}`);break;case"Mail":h.email&&(window.location.href=`mailto:${h.email}`);break;case"WhatsApp":if(h.phone){let o=h.phone.replace(/\D/g,"");o.startsWith("0")&&(o=`33${o.substring(1)}`);const T=encodeURIComponent("Bonjour");window.open(`https://wa.me/${o}?text=${T}`,"_blank")}break;case"GPS":if(h.address){const o=encodeURIComponent(h.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${o}`:window.open(`https://www.google.com/maps/search/?api=1&query=${o}`,"_blank")}break;default:X({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(ht,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(ft,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:x($(t.start,"eeee d MMMM",{locale:Le}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Le})," - ",$(t.end,"HH:mm",{locale:Le})]})]}),e.jsx(bt,{className:"p-0 text-left space-y-1",children:e.jsx(jt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(Ue,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),h&&e.jsxs("p",{className:"text-sm",children:[h.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"}].map(({icon:i,label:o})=>e.jsxs("button",{onClick:()=>k(o),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:o})]},o))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[I].color}`,children:e.jsxs(Tt,{onValueChange:D,value:I,children:[e.jsx(Rt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ft,{placeholder:"Qualifier votre activit√©"})}),e.jsxs($t,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx($e,{value:"effectue",children:"Effectu√©"}),e.jsx($e,{value:"annule",children:"Annul√©"}),e.jsx($e,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((y=w[t.projectId])==null?void 0:y.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(h==null?void 0:h.name)||"N/A"})]})]})]}),e.jsxs(Mt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(as,{children:[e.jsx(rs,{asChild:!0,children:e.jsxs(be,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Ot,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(os,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(cs,{children:[e.jsx(ds,{children:"Annuler"}),e.jsx(us,{onClick:b,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(be,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})};function Sr(t,s){const a=t.prospect,r=s.prospect;return!a||!r?!1:a.id===r.id&&(a.updatedAt||a.updated_at)===(r.updatedAt||r.updated_at)}const _r=gt.memo(vr,Sr),es=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Ir=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",We=t=>(t||"").toString().trim().toUpperCase(),Cr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},kr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],ts=50,ss=50,qr=()=>{var pe,se;const t=Ve(),[s,a]=xs(),{organizationId:r}=ot(),[d,u]=n.useState(null),[m,g]=n.useState(!1),[w,I]=n.useState("all"),[j,h]=n.useState(null),[O,x]=n.useState(!1),[$,D]=n.useState([]),[b,k]=n.useState(!1),E=n.useRef(null),[y,i]=n.useState(""),o=n.useRef(null),[T,W]=n.useState(!1),[S,M]=n.useState(!1),[ie,oe]=n.useState({}),{users:xe,loading:G}=ct(),{authUserId:je}=st(),Z=t==null?void 0:t.addProspect,{prospects:A=[],prospectsLoading:J=!0,allProjectSteps:ue={},allStepsLoading:q=!0,updateProspect:c=async()=>{},projectsData:z={},activeAdminUser:V=null,users:ce={},globalPipelineSteps:f=[],pipelineLoading:P=!0,getProjectSteps:Y=()=>[],adminReady:B=!1}=t||{},te=n.useMemo(()=>xe.reduce((p,v)=>(p[v.user_id]={id:v.id,user_id:v.user_id,name:v.name,email:v.email,role:v.role,phone:v.phone,avatarUrl:v.avatar_url,managerId:v.manager_id,accessRights:v.access_rights},p),{}),[xe]);n.useEffect(()=>{B&&!J&&!q&&!S&&M(!0)},[B,J,q,S]);const L=A,K=c,de=(A==null?void 0:A.find(p=>p.id===d))||null,le=n.useMemo(()=>!f||f.length===0?kr:f.map((p,v)=>{const H=We(p.label),ae=p.color||Cr[H]||es[v%es.length];return{id:p.id,label:p.label,name:Ir(p.label),color:ae}}),[f]),fe=n.useMemo(()=>{if(!V)return[];if(V.role==="Global Admin"||V.role==="Admin")return Object.values(te);const p=V.access_rights||V.accessRights,v=[V.user_id,...(p==null?void 0:p.users)||[]];return Object.values(te).filter(H=>v.includes(H.user_id))},[V,te]),_=n.useMemo(()=>{const p=fe.map(v=>({value:v.user_id,label:v.name}));return fe.length>1?[{value:"all",label:"Tous les utilisateurs"},...p]:p},[fe]);n.useEffect(()=>{V&&j===null&&(fe.length>1?h("all"):fe.length===1&&h(fe[0].user_id))},[V,j,fe]),n.useEffect(()=>{if(!b)return;const p=v=>{E.current&&!E.current.contains(v.target)&&k(!1)};return document.addEventListener("mousedown",p),()=>document.removeEventListener("mousedown",p)},[b]);const ne=n.useMemo(()=>{const p=new Set;return L.forEach(v=>{(v.tags||[]).forEach(H=>p.add(H))}),Array.from(p)},[L]),me=$.length===0?"Tags":$.length===1?((pe=z[$[0]])==null?void 0:pe.title)||$[0]:`${$.length} tags`,ge=n.useMemo(()=>{const p=L.filter(H=>{if(!V)return!1;if(V.role==="Global Admin"||V.role==="Admin")return!0;const ae=V.access_rights||V.accessRights;return[V.user_id,...(ae==null?void 0:ae.users)||[]].includes(H.ownerId)});N.debug("[FinalPipeline] Prospects count",{total:L.length,visible:p.length});let v=p;if($.length>0&&(v=v.filter(H=>{const ae=H.tags||[];return $.some(ve=>ae.includes(ve))})),j&&j!=="all"&&(v=v.filter(H=>H.ownerId===j)),y.trim()){const H=y.toLowerCase();v=v.filter(ae=>(ae.name||"").toLowerCase().includes(H)||(ae.email||"").toLowerCase().includes(H)||(ae.city||"").toLowerCase().includes(H)||(ae.phone||"").toLowerCase().includes(H))}return w==="mine"&&je?v.filter(H=>H.ownerId===je):v},[L,w,je,j,$,y]),{stagesWithCounts:_e,prospectsByStage:we}=n.useMemo(()=>{var R;const p=le.reduce((F,Q)=>(F[Q.id]=[],F),{}),v=((R=le[0])==null?void 0:R.id)||"fallback-stage",H=new Set(le.map(F=>F.id)),ae=new Map(le.map(F=>[We(F.label),F.id])),ve=F=>{const Q=[];return F.projectType&&z[F.projectType]&&Q.push(F.projectType),Array.isArray(F.tags)&&F.tags.forEach(U=>{z[U]&&!Q.includes(U)&&Q.push(U)}),Q},l=F=>{const Q=[];if(!f.length){const ee=F.stage||v,re=H.has(ee)?ee:v;return Q.push({stageId:re,prospect:F}),Q}if(typeof Y!="function")return Q.push({stageId:v,prospect:F}),Q;const U=ve(F);return U.length?(U.forEach(ee=>{var qt;const re=`${F.id}-${ee}`,Ne=ue[re]||(typeof Y=="function"?Y(F.id,ee):[])||[],Re=((qt=z[ee])==null?void 0:qt.steps)||[];if(!Ne.length){Q.push({stageId:v,prospect:F,projectType:ee});return}const Ie=Ne.find(Ge=>Ge.status==="in_progress"||Ge.status==="current")||Ne.find(Ge=>Ge.status==="pending")||Ne[Ne.length-1];if(!Ie){Q.push({stageId:v,prospect:F,projectType:ee});return}const He=(()=>{if(Ie.globalStepId&&H.has(Ie.globalStepId))return Ie.globalStepId;if(Ie.globalStepId){const Xe=We(Ie.globalStepId),Te=ae.get(Xe);if(Te&&H.has(Te))return Te}const Ge=Ne.indexOf(Ie);let Ae=null;if(Ge>=0&&Re[Ge]&&(Ae=Re[Ge]),!Ae){const Xe=We(Ie.name||Ie.label);Ae=Re.find(Te=>We(Te.name||Te.label)===Xe)}if(Ae!=null&&Ae.globalStepId&&H.has(Ae.globalStepId))return Ae.globalStepId;if(Ae!=null&&Ae.globalStepId){const Xe=We(Ae.globalStepId),Te=ae.get(Xe);if(Te&&H.has(Te))return Te}if(Ae&&(Ae.label||Ae.name)){const Xe=We(Ae.label||Ae.name),Te=ae.get(Xe);if(Te&&H.has(Te))return Te}const Cs=We(Ie.label||Ie.name),wt=ae.get(Cs);return wt&&H.has(wt)?wt:v})();Q.push({stageId:He,prospect:F,projectType:ee,activeStep:Ie})}),Q):(Q.push({stageId:v,prospect:F}),Q)};return ge.forEach(F=>{l(F).forEach(({stageId:U,projectType:ee,activeStep:re})=>{p[U]||(p[U]=[]),p[U].push({prospect:F,projectType:ee,activeStep:re})})}),{stagesWithCounts:le.map(F=>{var Q;return{...F,count:((Q=p[F.id])==null?void 0:Q.length)||0}}),prospectsByStage:p}},[le,ge,f,Y,z]);n.useEffect(()=>{const p=s.get("prospect"),v=s.get("project"),H=`${p}-${v}`;if(o.current===H)return;if(!p){d!==null&&(u(null),o.current=null);return}(L.find(ve=>ve.id===p)||null)&&(u(p),o.current=H)},[s,L]);const Ce=p=>{D(v=>v.includes(p)?v.filter(H=>H!==p):[...v,p])},Pe=n.useCallback((p,v)=>{u(p.id),a(H=>{const ae=new URLSearchParams(H);return ae.set("prospect",p.id),v?ae.set("project",v):ae.delete("project"),ae})},[a]),ke=n.useCallback(p=>{oe(v=>({...v,[p]:(v[p]||ts)+ss}))},[]),De=()=>{u(null);const p=new URLSearchParams(s);p.delete("prospect"),p.delete("project"),a(p)},Se=async p=>{var v,H,ae;try{if(!Z)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const ve=((v=f[0])==null?void 0:v.step_id)||((H=f[0])==null?void 0:H.id);console.log("[handleAddProspect] calling addProspect",{name:p.name,email:p.email,status:ve,ownerId:V==null?void 0:V.user_id,sendInvitation:p.sendInvitation,allData:p});const l=await Z({...p,status:ve,ownerId:V==null?void 0:V.user_id});if(console.log("[handleAddProspect] result",l),!(l!=null&&l.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(l&&p.tags&&p.tags.length>0)for(const C of p.tags){const R=(ae=z[C])==null?void 0:ae.steps;if(R&&R.length>0)try{const F=JSON.parse(JSON.stringify(R));if(F[0].status="in_progress",!r)throw new Error("Organization ID manquant - Impossible de cr√©er les steps projet");const{error:Q}=await he.from("project_steps_status").upsert({prospect_id:l.id,project_type:C,steps:F,organization_id:r,updated_at:new Date().toISOString()},{onConflict:"prospect_id,project_type"});Q?N.error("Erreur initialisation steps",{projectType:C,error:Q}):N.debug("Steps initialized for project",{projectType:C,prospectId:l.id})}catch(F){N.error("Erreur initialisation steps",{projectType:C,error:F})}}if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:p.sendInvitation,email:l.email,willSend:p.sendInvitation&&l.email}),p.sendInvitation&&l.email)try{const C=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",l.email.trim(),"redirect:",C,"org:",r);const{error:R}=await he.auth.signInWithOtp({email:l.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:C,data:{organization_id:r}}});R?(console.error("[handleAddProspect] ‚ùå invitation error",R),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${R.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",l.email),X({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${l.email}`,className:"bg-green-500 text-white"}))}catch(C){console.error("[handleAddProspect] üí• invitation exception",C),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${C.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:p.sendInvitation?"no email":"sendInvitation=false"});g(!1)}catch(ve){console.error("‚ùå handleAddProspect error",ve),X({title:"Erreur",description:ve.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},ye=p=>{try{K&&(K(p),X({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{X({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return de&&de.id?e.jsx(Ye.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Js,{name:"Fiche Prospect",children:e.jsx(_r,{prospect:de,onBack:De,onUpdate:ye,onEditingChange:W})})}):S?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ue,{className:"w-4 h-4"}),e.jsxs("span",{children:[ge.length," prospect",ge.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:E,className:"relative inline-block text-left",children:[e.jsxs(be,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>k(p=>!p),children:[e.jsx("span",{children:me}),e.jsx(_t,{className:"h-4 w-4"})]}),b&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[ne.map(p=>{var v;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:$.includes(p),onChange:()=>Ce(p),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((v=z[p])==null?void 0:v.title)||p})]},p)}),$.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>D([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(Xs,{open:O,onOpenChange:x,children:[e.jsx(Ys,{asChild:!0,children:e.jsxs(be,{variant:"outline",role:"combobox","aria-expanded":O,className:"w-[230px] justify-between",children:[e.jsx(Ue,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:j==="all"?"Tous les utilisateurs":((se=te[j])==null?void 0:se.name)||"Utilisateur"}),e.jsx(_t,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(Ks,{className:"w-[200px] p-0",children:e.jsxs(Qs,{children:[e.jsx(Zs,{placeholder:"Rechercher..."}),e.jsxs(Us,{children:[e.jsx(ea,{children:"Aucun utilisateur"}),e.jsx(ta,{children:_.map(p=>e.jsxs(sa,{value:p.label,onSelect:()=>{h(p.value),x(!1)},children:[e.jsx(dt,{className:Qe("mr-2 h-4 w-4",j===p.value?"opacity-100":"opacity-0")}),p.label]},p.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(aa,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Be,{type:"text",placeholder:"Rechercher un prospect...",value:y,onChange:p=>i(p.target.value),className:"pl-9 pr-4"}),y&&e.jsx("button",{onClick:()=>i(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(be,{onClick:()=>g(!0),children:[e.jsx(Pt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:_e.map(p=>e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${p.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:p.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(we[p.id]||[]).filter(v=>{if($.length===0)return!0;const{projectType:H}=v;return $.some(ae=>ae.toUpperCase()===(H||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const v=(we[p.id]||[]).filter(C=>{if($.length===0)return!0;const{projectType:R}=C;return $.some(F=>F.toUpperCase()===(R||"").toUpperCase())}),H=ie[p.id]||ts,ae=v.slice(0,H),ve=v.length>H,l=v.length-H;return e.jsxs(e.Fragment,{children:[ae.map((C,R)=>{var He;const{prospect:F,projectType:Q,activeStep:U}=C,ee=`${F.id}-${Q||"default"}-${p.id}-${R}`,re=F.projectType||F.tags&&F.tags[0]||"Projet",Ne=Q&&((He=z[Q])!=null&&He.title)?z[Q].title:re,Re=(U==null?void 0:U.label)||(U==null?void 0:U.name)||p.name,Ie=p.color||"bg-blue-100 text-blue-700",ut=`${F.id}-${Q||Ne}-${p.id}-${R}`;return e.jsx(Ye.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(Ua,{prospect:{...F,_projectContext:{projectType:Q||re,projectTitle:Ne,stepLabel:Re,projectColor:Ie}},onClick:()=>Pe(F,Q||F.projectType||(Array.isArray(F.tags)?F.tags[0]:re)),compact:!0,sortableId:ut,projectsData:z})},ee)}),ve&&e.jsxs("button",{onClick:()=>ke(p.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(l,ss)," de plus (",l," restants)"]}),v.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(Ue,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},p.id))})})}),e.jsx(ra,{open:m,onOpenChange:g,onAddProspect:Se}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(p=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},p))})})})]})};export{qr as default};
