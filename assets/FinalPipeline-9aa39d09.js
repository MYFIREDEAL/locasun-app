import{c as Ot,r as i,R as jt,u as qs,j as e,m as et,C as ut,l as v,s as pe,a as xt,b as Je,d as Vs,e as it,f as Bs,g as Tt,h as pt,B as be,P as Lt,i as Ge,D as vt,k as wt,X as Ze,n as _t,o as St,U as nt,p as lt,M as Ct,q as zt,t as It,S as qt,v as Vt,w as Bt,x as Ht,y as qe,z as Wt,A as us,E as ms,T as Gt,F as gs,G as xs,H as ps,I as hs,J as fs,K as bs,L as js,N as K,O as ys,Q as Le,V as Hs,W as Ns,Y as yt,Z as Ws,_ as vs,$ as Kt,a0 as Gs,a1 as Js,a2 as at,a3 as Xs,a4 as Ys,a5 as Ks,a6 as mt,a7 as Qs,a8 as ws,a9 as _s,aa as Zs,ab as Us,ac as Ve,ad as Xe,ae as ht,af as Ss,ag as Cs,ah as ea,ai as ta,aj as sa,ak as aa,al as ra,am as na,an as ia,ao as la,ap as oa,aq as ca,ar as da,as as ua,at as ma,au as ga,av as xa,aw as pa,ax as ha,ay as fa,az as ba,aA as ja}from"./index-ea7e742b.js";import{u as ot,A as Is,C as ya}from"./Agenda-7ddabfc5.js";import{S as Na}from"./SearchableSelect-152f355f.js";import{u as va}from"./useSupabaseProjectStepsStatus-36c75076.js";import{F as wa,a as _a,P as Sa,b as Ca,e as Ia,u as ks,S as Jt,c as ka}from"./useSupabaseWorkflowModuleTemplates-679552ed.js";import{f as tt,V as Ea}from"./index-9c295575.js";import{i as Aa}from"./workflowV2Config-f801420c.js";import{P as Nt}from"./pen-square-ed7a41dc.js";import{P as Qt}from"./paperclip-772b993c.js";import"./external-link-7faec7a3.js";const Pa=Ot("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),Da=Ot("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),Ta=Ot("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function Ra(){for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];return i.useMemo(()=>r=>{a.forEach(g=>g(r))},a)}const Ma=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function $a(t){const a=Object.prototype.toString.call(t);return a==="[object Window]"||a==="[object global]"}function Fa(t){return"nodeType"in t}function Es(t){var a,n;return t?$a(t)?t:Fa(t)&&(a=(n=t.ownerDocument)==null?void 0:n.defaultView)!=null?a:window:window}const kt=Ma?i.useLayoutEffect:i.useEffect;function As(t){const a=i.useRef(t);return kt(()=>{a.current=t}),i.useCallback(function(){for(var n=arguments.length,r=new Array(n),g=0;g<n;g++)r[g]=arguments[g];return a.current==null?void 0:a.current(...r)},[])}function Rt(t,a){a===void 0&&(a=[t]);const n=i.useRef(t);return kt(()=>{n.current!==t&&(n.current=t)},a),n}function Mt(t){const a=As(t),n=i.useRef(null),r=i.useCallback(g=>{g!==n.current&&(a==null||a(g,n.current)),n.current=g},[]);return[n,r]}let Dt={};function Ps(t,a){return i.useMemo(()=>{if(a)return a;const n=Dt[t]==null?0:Dt[t]+1;return Dt[t]=n,t+"-"+n},[t,a])}function Oa(t){if(!t)return!1;const{KeyboardEvent:a}=Es(t.target);return a&&t instanceof a}const gt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:a,y:n}=t;return"translate3d("+(a?Math.round(a):0)+"px, "+(n?Math.round(n):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:a,scaleY:n}=t;return"scaleX("+a+") scaleY("+n+")"}},Transform:{toString(t){if(t)return[gt.Translate.toString(t),gt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:a,duration:n,easing:r}=t;return a+" "+n+"ms "+r}}});var dt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(dt||(dt={}));function Zt(){}const La=Object.freeze({x:0,y:0});function za(t){if(t.startsWith("matrix3d(")){const a=t.slice(9,-1).split(/, /);return{x:+a[12],y:+a[13],scaleX:+a[0],scaleY:+a[5]}}else if(t.startsWith("matrix(")){const a=t.slice(7,-1).split(/, /);return{x:+a[4],y:+a[5],scaleX:+a[0],scaleY:+a[3]}}return null}function qa(t,a,n){const r=za(a);if(!r)return t;const{scaleX:g,scaleY:m,x:h,y:f}=r,_=t.left-h-(1-g)*parseFloat(n),k=t.top-f-(1-m)*parseFloat(n.slice(n.indexOf(" ")+1)),y=g?t.width/g:t.width,b=m?t.height/m:t.height;return{width:y,height:b,top:k,right:_+y,bottom:k+b,left:_}}const Va={ignoreTransform:!1};function Xt(t,a){a===void 0&&(a=Va);let n=t.getBoundingClientRect();if(a.ignoreTransform){const{transform:k,transformOrigin:y}=Es(t).getComputedStyle(t);k&&(n=qa(n,k,y))}const{top:r,left:g,width:m,height:h,bottom:f,right:_}=n;return{top:r,left:g,width:m,height:h,bottom:f,right:_}}function Ut(t){return Xt(t,{ignoreTransform:!0})}var rt;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(rt||(rt={}));var es;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(es||(es={}));var Oe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Oe||(Oe={}));Oe.Space,Oe.Enter,Oe.Esc,Oe.Space,Oe.Enter,Oe.Tab;var ts;(function(t){t[t.RightClick=2]="RightClick"})(ts||(ts={}));var ss;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(ss||(ss={}));var as;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(as||(as={}));rt.Backward+"",rt.Forward+"",rt.Backward+"",rt.Forward+"";var $t;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})($t||($t={}));var Ft;(function(t){t.Optimized="optimized"})(Ft||(Ft={}));function Ba(t){let{callback:a,disabled:n}=t;const r=As(a),g=i.useMemo(()=>{if(n||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:m}=window;return new m(r)},[n]);return i.useEffect(()=>()=>g==null?void 0:g.disconnect(),[g]),g}function Ha(t,a){return i.useMemo(()=>t.reduce((n,r)=>{let{eventName:g,handler:m}=r;return n[g]=h=>{m(h,a)},n},{}),[t,a])}$t.WhileDragging,Ft.Optimized;const Wa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Zt,draggableNodes:new Map,over:null,measureDroppableContainers:Zt},Ds=i.createContext(Wa),Ga=i.createContext({...La,scaleX:1,scaleY:1});var rs;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(rs||(rs={}));const Ja=i.createContext(null),ns="button",Xa="Draggable";function Ya(t){let{id:a,data:n,disabled:r=!1,attributes:g}=t;const m=Ps(Xa),{activators:h,activatorEvent:f,active:_,activeNodeRect:k,ariaDescribedById:y,draggableNodes:b,over:O}=i.useContext(Ds),{role:p=ns,roleDescription:$="draggable",tabIndex:D=0}=g??{},N=(_==null?void 0:_.id)===a,F=i.useContext(N?Ga:Ja),[E,w]=Mt(),[o,u]=Mt(),R=Ha(h,a),q=Rt(n);kt(()=>(b.set(a,{id:a,key:m,node:E,activatorNode:o,data:q}),()=>{const M=b.get(a);M&&M.key===m&&b.delete(a)}),[b,a]);const S=i.useMemo(()=>({role:p,tabIndex:D,"aria-disabled":r,"aria-pressed":N&&p===ns?!0:void 0,"aria-roledescription":$,"aria-describedby":y.draggable}),[r,p,D,N,$,y.draggable]);return{active:_,activatorEvent:f,activeNodeRect:k,attributes:S,isDragging:N,listeners:r?void 0:R,node:E,over:O,setNodeRef:w,setActivatorNodeRef:u,transform:F}}const Ka="Droppable",Qa={timeout:25};function Za(t){let{data:a,disabled:n=!1,id:r,resizeObserverConfig:g}=t;const m=Ps(Ka),{active:h,dispatch:f,over:_,measureDroppableContainers:k}=i.useContext(Ds),y=i.useRef({disabled:n}),b=i.useRef(!1),O=i.useRef(null),p=i.useRef(null),{disabled:$,updateMeasurementsFor:D,timeout:N}={...Qa,...g},F=Rt(D??r),E=i.useCallback(()=>{if(!b.current){b.current=!0;return}p.current!=null&&clearTimeout(p.current),p.current=setTimeout(()=>{k(Array.isArray(F.current)?F.current:[F.current]),p.current=null},N)},[N]),w=Ba({callback:E,disabled:$||!h}),o=i.useCallback((S,M)=>{w&&(M&&(w.unobserve(M),b.current=!1),S&&w.observe(S))},[w]),[u,R]=Mt(o),q=Rt(a);return i.useEffect(()=>{!w||!u.current||(w.disconnect(),b.current=!1,w.observe(u.current))},[u,w]),i.useEffect(()=>(f({type:dt.RegisterDroppable,element:{id:r,key:m,disabled:n,node:u,rect:O,data:q}}),()=>f({type:dt.UnregisterDroppable,key:m,id:r})),[r]),i.useEffect(()=>{n!==y.current.disabled&&(f({type:dt.SetDroppableDisabled,id:r,key:m,disabled:n}),y.current.disabled=n)},[r,m,n,f]),{active:h,rect:O,isOver:(_==null?void 0:_.id)===r,node:u,over:_,setNodeRef:R}}function Ts(t,a,n){const r=t.slice();return r.splice(n<0?r.length+n:n,0,r.splice(a,1)[0]),r}function bt(t){return t!==null&&t>=0}const Ua=t=>{let{rects:a,activeIndex:n,overIndex:r,index:g}=t;const m=Ts(a,r,n),h=a[g],f=m[g];return!f||!h?null:{x:f.left-h.left,y:f.top-h.top,scaleX:f.width/h.width,scaleY:f.height/h.height}},er="Sortable",tr=jt.createContext({activeIndex:-1,containerId:er,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Ua,disabled:{draggable:!1,droppable:!1}}),sr=t=>{let{id:a,items:n,activeIndex:r,overIndex:g}=t;return Ts(n,r,g).indexOf(a)},ar=t=>{let{containerId:a,isSorting:n,wasDragging:r,index:g,items:m,newIndex:h,previousItems:f,previousContainerId:_,transition:k}=t;return!k||!r||f!==m&&g===h?!1:n?!0:h!==g&&a===_},rr={duration:200,easing:"ease"},Rs="transform",nr=gt.Transition.toString({property:Rs,duration:0,easing:"linear"}),ir={roleDescription:"sortable"};function lr(t){let{disabled:a,index:n,node:r,rect:g}=t;const[m,h]=i.useState(null),f=i.useRef(n);return kt(()=>{if(!a&&n!==f.current&&r.current){const _=g.current;if(_){const k=Xt(r.current,{ignoreTransform:!0}),y={x:_.left-k.left,y:_.top-k.top,scaleX:_.width/k.width,scaleY:_.height/k.height};(y.x||y.y)&&h(y)}}n!==f.current&&(f.current=n)},[a,n,r,g]),i.useEffect(()=>{m&&h(null)},[m]),m}function or(t){let{animateLayoutChanges:a=ar,attributes:n,disabled:r,data:g,getNewIndex:m=sr,id:h,strategy:f,resizeObserverConfig:_,transition:k=rr}=t;const{items:y,containerId:b,activeIndex:O,disabled:p,disableTransforms:$,sortedRects:D,overIndex:N,useDragOverlay:F,strategy:E}=i.useContext(tr),w=cr(r,p),o=y.indexOf(h),u=i.useMemo(()=>({sortable:{containerId:b,index:o,items:y},...g}),[b,g,o,y]),R=i.useMemo(()=>y.slice(y.indexOf(h)),[y,h]),{rect:q,node:S,isOver:M,setNodeRef:ne}=Za({id:h,data:u,disabled:w.droppable,resizeObserverConfig:{updateMeasurementsFor:R,..._}}),{active:ue,activatorEvent:je,activeNodeRect:Se,attributes:L,setNodeRef:W,listeners:C,isDragging:Z,over:me,setActivatorNodeRef:le,transform:l}=Ya({id:h,data:u,attributes:{...ir,...n},disabled:w.draggable}),P=Ra(ne,W),z=!!ue,xe=z&&!$&&bt(O)&&bt(N),I=!F&&Z,V=I&&xe?l:null,de=xe?V??(f??E)({rects:D,activeNodeRect:Se,activeIndex:O,overIndex:N,index:o}):null,ee=bt(O)&&bt(N)?m({id:h,items:y,activeIndex:O,overIndex:N}):o,Q=ue==null?void 0:ue.id,U=i.useRef({activeId:Q,items:y,newIndex:ee,containerId:b}),ae=y!==U.current.items,ge=a({active:ue,containerId:b,isDragging:Z,isSorting:z,id:h,index:o,items:y,newIndex:U.current.newIndex,previousItems:U.current.items,previousContainerId:U.current.containerId,transition:k,wasDragging:U.current.activeId!=null}),oe=lr({disabled:!ge,index:o,node:S,rect:q});return i.useEffect(()=>{z&&U.current.newIndex!==ee&&(U.current.newIndex=ee),b!==U.current.containerId&&(U.current.containerId=b),y!==U.current.items&&(U.current.items=y)},[z,ee,b,y]),i.useEffect(()=>{if(Q===U.current.activeId)return;if(Q&&!U.current.activeId){U.current.activeId=Q;return}const G=setTimeout(()=>{U.current.activeId=Q},50);return()=>clearTimeout(G)},[Q]),{active:ue,activeIndex:O,attributes:L,data:u,rect:q,index:o,newIndex:ee,items:y,isOver:M,isSorting:z,isDragging:Z,listeners:C,node:S,overIndex:N,over:me,setNodeRef:P,setActivatorNodeRef:le,setDroppableNodeRef:ne,setDraggableNodeRef:W,transform:oe??de,transition:Ee()};function Ee(){if(oe||ae&&U.current.newIndex===o)return nr;if(!(I&&!Oa(je)||!k)&&(z||ge))return gt.Transition.toString({...k,property:Rs})}}function cr(t,a){var n,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(n=t==null?void 0:t.draggable)!=null?n:a.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:a.droppable}}Oe.Down,Oe.Right,Oe.Up,Oe.Left;const dr=t=>(t||"").toString().trim().toUpperCase(),ur=(t,a)=>{if(t.sortableId!==a.sortableId)return!1;const n=t.prospect,r=a.prospect;if(n.id!==r.id||n.name!==r.name||n.hasAppointment!==r.hasAppointment||n.updatedAt!==r.updatedAt)return!1;const g=n._projectContext||{},m=r._projectContext||{};if(g.projectType!==m.projectType||g.projectTitle!==m.projectTitle||g.stepLabel!==m.stepLabel)return!1;const h=n.tags||[],f=r.tags||[];return!(h.length!==f.length||h.some((_,k)=>_!==f[k])||t.projectsData!==a.projectsData||t.onClick!==a.onClick)},mr=({prospect:t,onClick:a,sortableId:n,projectsData:r={}})=>{var N,F,E,w,o,u,R;qs();const g=Array.isArray(t.tags)?t.tags:[],m=((N=t._projectContext)==null?void 0:N.projectTitle)||((F=t._projectContext)==null?void 0:F.projectType)||null,h=((E=t._projectContext)==null?void 0:E.projectType)||null;(w=t._projectContext)!=null&&w.stepLabel;const f=m?dr(m):null,_=n||(f?`${t.id}-${f}`:`${t.id}-${((o=t._projectContext)==null?void 0:o.projectType)||"default"}`),{attributes:k,listeners:y,setNodeRef:b,transform:O,transition:p,isDragging:$}=or({id:_,data:{prospect:t}}),D={transform:gt.Transform.toString(O),transition:p,zIndex:$?10:"auto",opacity:$?.8:1};return e.jsx("div",{ref:b,style:D,...k,...y,children:e.jsxs(et.div,{layoutId:`prospect-card-${_}`,whileHover:{y:-4,scale:1.02},onClick:a,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(ut,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[m&&g.includes(((u=t._projectContext)==null?void 0:u.projectType)||m)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((R=r[h])==null?void 0:R.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:m})}),g.filter(q=>q!==h).map(q=>{var ne,ue;const S=((ne=r[q])==null?void 0:ne.title)||q,M=((ue=r[q])==null?void 0:ue.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:S},q)})]})]})})},gr=i.memo(mr,ur);function xr({prospectId:t,projectType:a,currentStepIndex:n,prompt:r,sendNextAction:g}){const m=i.useRef(new Set);i.useRef(!1),i.useEffect(()=>{if(!t||!a||n===void 0||!r)return;v.info("ðŸ”„ Workflow action trigger activÃ©",{prospectId:t,projectType:a,currentStepIndex:n,promptName:r==null?void 0:r.name});const h=pe.channel(`workflow-forms-${t}-${a}-${n}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async f=>{const _=f.new;v.info("ðŸ” Form panel UPDATE reÃ§u",{panelId:_.id,prospectId:_.prospect_id,projectType:_.project_type,status:_.status,actionId:_.action_id,expectedProjectType:a});const k=_.project_type===a,y=_.status==="approved",b=!!_.action_id;if(k&&y&&b){const O=`${t}-${a}-${n}-${_.action_id}`;if(m.current.has(O)){v.warn("âš ï¸ Action dÃ©jÃ  exÃ©cutÃ©e, skip",{actionKey:O});return}m.current.add(O),v.info("âœ… Formulaire approuvÃ© â†’ Action suivante dans 2s",{formId:_.form_id,actionId:_.action_id}),setTimeout(()=>{v.info("ðŸš€ Envoi action suivante",{completedActionId:_.action_id}),g(_.action_id)},2e3)}}).subscribe();return()=>{pe.removeChannel(h)}},[t,a,n,r,g])}function pr({projectType:t,prospectId:a,enabled:n=!0}){const[r,g]=i.useState([]),[m,h]=i.useState(!1),[f,_]=i.useState(!1),[k,y]=i.useState(null),{organizationId:b}=xt(),O=i.useCallback(async()=>{if(!(!t||!n))try{h(!0),y(null);let N=pe.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});a&&(N=N.eq("prospect_id",a));const{data:F,error:E}=await N;if(E)throw E;g(F||[])}catch(N){v.error("Erreur rÃ©cupÃ©ration project notes:",{error:N.message}),y(N.message)}finally{h(!1)}},[t,a,n]);i.useEffect(()=>{if(!t||!n)return;O();const N=pe.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},F=>{g(E=>{const{eventType:w,new:o,old:u}=F;return w==="INSERT"?[o,...E]:w==="UPDATE"?E.map(R=>R.id===o.id?o:R):w==="DELETE"?E.filter(R=>R.id!==u.id):E})}).subscribe();return()=>{pe.removeChannel(N)}},[t,n,O]);const p=i.useCallback(async({content:N,createdBy:F,createdByName:E})=>{if(!(!t||!(N!=null&&N.trim())))try{if(_(!0),y(null),!b)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:w,error:o}=await pe.from("project_notes").insert([{project_type:t,prospect_id:a||null,content:N.trim(),created_by:F||null,created_by_name:E||null,organization_id:b}]).select().single();if(o)throw o;return g(u=>[w,...u]),w}catch(w){throw v.error("Erreur ajout project note:",{error:w.message}),y(w.message),w}finally{_(!1)}},[t,a,b]),$=i.useCallback(async(N,{content:F})=>{if(!(!N||!(F!=null&&F.trim())))try{_(!0),y(null);const{data:E,error:w}=await pe.from("project_notes").update({content:F.trim(),updated_at:new Date().toISOString()}).eq("id",N).select().single();if(w)throw w;return g(o=>o.map(u=>u.id===N?E:u)),E}catch(E){throw v.error("Erreur update project note:",{error:E.message}),y(E.message),E}finally{_(!1)}},[]),D=i.useCallback(async N=>{if(N)try{_(!0),y(null);const{error:F}=await pe.from("project_notes").delete().eq("id",N);if(F)throw F;g(E=>E.filter(w=>w.id!==N))}catch(F){throw v.error("Erreur suppression project note:",{error:F.message}),y(F.message),F}finally{_(!1)}},[]);return{notes:r,loading:m,saving:f,error:k,addNote:p,updateNote:$,deleteNote:D,refetch:O}}function hr({projectType:t,prospectId:a,currentUser:n,activeAdminUser:r}){var o;const{activeAdminUser:g}=Je(),m=r||g,[h,f]=i.useState(""),[_,k]=i.useState(!1),{getTemplateByType:y}=Vs(),b=y(t),O=(b==null?void 0:b.title)||t,{notes:p,loading:$,saving:D,error:N,addNote:F}=pr({projectType:t,prospectId:a,enabled:!!t}),{addHistoryEvent:E}=it({projectType:t,prospectId:a,enabled:!!t,activeAdminUser:m}),w=async()=>{if(h.trim())try{const u=await F({content:h,createdBy:(m==null?void 0:m.id)||(n==null?void 0:n.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(n==null?void 0:n.full_name)||(n==null?void 0:n.email)});u&&E&&await E({event_type:"note",title:"Note ajoutÃ©e",description:u.content||h.trim(),metadata:{source:"notes_tab"},createdBy:(m==null?void 0:m.id)||(n==null?void 0:n.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(n==null?void 0:n.full_name)||(n==null?void 0:n.email)}),f("")}catch(u){v.error(u)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${O}`:"Aucun projet sÃ©lectionnÃ©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne liÃ©e Ã  ce projetâ€¦",value:h,onChange:u=>f(u.target.value),disabled:!t||D}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"ðŸ–¼ï¸"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:w,disabled:!h.trim()||!t||D,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:D?"Enregistrementâ€¦":"Enregistrer la note"})]}),N&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",N]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes prÃ©cÃ©dentes"}),p&&p.length>3&&e.jsx("button",{onClick:()=>k(!_),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:_?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"RÃ©duire"}),e.jsx(Bs,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",p.length,")"]}),e.jsx(Tt,{className:"w-4 h-4"})]})})]}),$&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notesâ€¦"}),!$&&(p==null?void 0:p.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(o=_?p:p==null?void 0:p.slice(0,3))==null?void 0:o.map(u=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:u.created_by_name||u.created_by?`Par ${u.created_by_name||u.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:u.created_at&&new Date(u.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:u.content})]},u.id))})]})]})}const fr=({prospectId:t,projectType:a,activeAdminUser:n})=>{const{projectsData:r,appointments:g,updateAppointment:m,deleteAppointment:h,addAppointment:f,addCall:_,addTask:k,updateCall:y,updateTask:b,prospects:O}=Je(),[p,$]=i.useState(!1),[D,N]=i.useState(null),[F,E]=i.useState(null),{users:w}=pt(),{supabaseUserId:o}=ot(),{history:u,loading:R}=it({projectType:a,prospectId:t,enabled:!!a&&!!t,activeAdminUser:n}),q=i.useMemo(()=>!u||u.length===0?[]:u.filter(C=>C.event_type==="activity").sort((C,Z)=>new Date(Z.created_at)-new Date(C.created_at)),[u]),S=i.useMemo(()=>{const C={};return q.forEach(me=>{var l;const le=(l=me.metadata)==null?void 0:l.appointment_id;le&&(C[le]||(C[le]=[]),C[le].push(me))}),Object.entries(C).map(([me,le])=>{var z;const P=le.sort((xe,I)=>new Date(I.created_at)-new Date(xe.created_at))[0];return{...P,currentStatus:((z=P.metadata)==null?void 0:z.status)||(P.title==="ActivitÃ© supprimÃ©e"?"deleted":"pending")}})},[q]),M=i.useMemo(()=>S?S.filter(C=>C.currentStatus==="pending"):[],[S]),ne=i.useMemo(()=>S?S.filter(C=>C.currentStatus!=="pending"):[],[S]),ue=C=>{switch((C==null?void 0:C.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(ut,{className:"h-4 w-4"});case"virtual":return e.jsx(Ea,{className:"h-4 w-4"});case"call":return e.jsx(lt,{className:"h-4 w-4"});case"task":return e.jsx(ya,{className:"h-4 w-4"});default:return e.jsx(ut,{className:"h-4 w-4"})}},je=C=>{const Z=(C==null?void 0:C.activity_type)||"appointment",me=C==null?void 0:C.status;if(me==="effectue"||me==="completed")return"text-green-600 bg-green-50";if(me==="annule")return"text-red-600 bg-red-50";if(me==="reporte")return"text-yellow-600 bg-yellow-50";switch(Z){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},Se=C=>{var Z;return!g||!((Z=C.metadata)!=null&&Z.appointment_id)?null:g.find(me=>me.id===C.metadata.appointment_id)},L=C=>{const Z=Se(C);Z&&N(Z)},W=C=>{N(null),E({...C,type:C.type}),$(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"ActivitÃ©s du projet"}),e.jsxs(be,{onClick:()=>{$(!p)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Lt,{className:"h-4 w-4 mr-2"}),"Ajouter une activitÃ©"]})]}),p&&e.jsx(Is,{open:p,onOpenChange:C=>{C||E(null),$(C)},initialData:F||{contactId:t,projectId:a},defaultAssignedUserId:o,addAppointment:f,addCall:_,addTask:k,updateAppointment:m,updateCall:y,updateTask:b,prospects:O||[],users:w||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activitÃ©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activitÃ© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(C=>{const Z=Se(C),me=(Z==null?void 0:Z.title)||C.title||"ActivitÃ©",le=Z!=null&&Z.start?new Date(Z.start):new Date(C.created_at);return e.jsxs("div",{onClick:()=>L(C),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${je(C.metadata)}`,children:ue(C.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:me}),(Z==null?void 0:Z.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:Z.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:tt(le,"d MMM 'Ã ' HH:mm",{locale:Ge})})]})]},C.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["PassÃ©es (",ne.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ne.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activitÃ© passÃ©e"}):e.jsx("div",{className:"space-y-2",children:ne.map(C=>{const Z=Se(C),me=(Z==null?void 0:Z.title)||C.title||"ActivitÃ©",le=Z!=null&&Z.start?new Date(Z.start):new Date(C.created_at),l={effectue:"âœ… EffectuÃ©",annule:"âŒ AnnulÃ©",reporte:"ðŸ“… ReportÃ©",deleted:"ðŸ—‘ï¸ SupprimÃ©",completed:"âœ… TerminÃ©"}[C.currentStatus]||C.currentStatus;return e.jsxs("div",{onClick:()=>L(C),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${je(C.metadata)}`,children:ue(C.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:me}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[l," â€¢ ",tt(le,"d MMM yyyy 'Ã ' HH:mm",{locale:Ge})]})]})]},C.id)})})]}),D&&e.jsx(br,{event:D,onClose:()=>N(null),onReport:()=>{},onEdit:W,prospects:O,supabaseUsers:w,updateAppointment:m,deleteAppointment:h,projectsData:r})]})},br=({event:t,onClose:a,onReport:n,onEdit:r,prospects:g,supabaseUsers:m,updateAppointment:h,deleteAppointment:f,projectsData:_})=>{var w;const[k,y]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!g||!m||!h||!f||!_)return null;const b=g.find(o=>o.id===t.contactId),O=m.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(b?m.find(o=>o.user_id===b.ownerId):null),p=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",$=(o,u,R={})=>{try{const q=new Date(o);return isNaN(q.getTime())?"Date invalide":tt(q,u,R)}catch{return"Date invalide"}},D=o=>{y(o),h(t.id,{status:o}),setTimeout(()=>{a(),o==="reporte"&&n(t)},300)},N=()=>{f(t.id),K({title:"âœ… RDV supprimÃ©",description:"Le rendez-vous a Ã©tÃ© retirÃ© de votre agenda."}),a()},F=o=>{if(!b){K({title:"Contact non trouvÃ©",variant:"destructive"});return}switch(o){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:K({title:`Action: ${o}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activitÃ©"},effectue:{color:"bg-green-500",label:"EffectuÃ©"},annule:{color:"bg-red-500",label:"AnnulÃ©"},reporte:{color:"bg-yellow-500",label:"ReportÃ©"}};return e.jsx(vt,{open:!!t,onOpenChange:o=>!o&&a(),children:e.jsxs(wt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:a,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ze,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p($(t.start,"eeee d MMMM",{locale:Ge}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Ge})," - ",$(t.end,"HH:mm",{locale:Ge})]})]}),e.jsx(_t,{className:"p-0 text-left space-y-1",children:e.jsx(St,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(nt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (AssignÃ©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:lt,label:"Appel"},{icon:Ct,label:"Mail"},{icon:zt,label:"WhatsApp"},{icon:It,label:"GPS"}].map(({icon:o,label:u})=>e.jsxs("button",{onClick:()=>F(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[k].color}`,children:e.jsxs(qt,{onValueChange:D,value:k,children:[e.jsx(Vt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Bt,{placeholder:"Qualifier votre activitÃ©"})}),e.jsxs(Ht,{children:[e.jsx(qe,{value:"pending",disabled:!0,children:"Qualifier votre activitÃ©"}),e.jsx(qe,{value:"effectue",children:"EffectuÃ©"}),e.jsx(qe,{value:"annule",children:"AnnulÃ©"}),e.jsx(qe,{value:"reporte",children:"ReportÃ©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activitÃ©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((w=_[t.projectId])==null?void 0:w.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ã‰tape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(Wt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(us,{children:[e.jsx(ms,{asChild:!0,children:e.jsxs(be,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Gt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(gs,{children:[e.jsxs(xs,{children:[e.jsx(ps,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(hs,{children:"Cette action est irrÃ©versible. Le rendez-vous sera dÃ©finitivement supprimÃ©."})]}),e.jsxs(fs,{children:[e.jsx(bs,{children:"Annuler"}),e.jsx(js,{onClick:N,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(be,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activitÃ©"})]})]})})},jr=({projectType:t,prospectId:a,currentUser:n,activeAdminUser:r})=>{const{activeAdminUser:g}=Je(),{organizationId:m}=xt(),h=r||g,[f,_]=i.useState(null),{files:k,loading:y,uploading:b,deleting:O,error:p,uploadFile:$,deleteFile:D}=ys({projectType:t,prospectId:a,organizationId:m,enabled:!!t}),{addHistoryEvent:N}=it({projectType:t,prospectId:a,enabled:!!t,activeAdminUser:h}),F=async S=>{const M=Array.from(S.target.files||[]);if(M.length!==0)try{const ne=M.map(async ue=>{_(ue);const je=await $({file:ue,uploadedBy:n==null?void 0:n.id});return je&&N&&await N({event_type:"file",title:"Fichier ajoutÃ©",description:je.file_name,metadata:{size:je.file_size,type:je.file_type,storage_path:je.storage_path},createdBy:(h==null?void 0:h.id)||(n==null?void 0:n.id),createdByName:(h==null?void 0:h.name)||(h==null?void 0:h.email)||(n==null?void 0:n.full_name)||(n==null?void 0:n.email)}),je});await Promise.all(ne),_(null),S.target.value=""}catch(ne){v.error("Error uploading files:",ne),_(null)}},E=async S=>{try{const{data:M,error:ne}=await pe.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(ne){v.error("Error creating signed URL:",ne);return}const je=await(await fetch(M.signedUrl)).blob(),Se=window.URL.createObjectURL(je),L=document.createElement("a");L.href=Se,L.download=S.file_name,document.body.appendChild(L),L.click(),document.body.removeChild(L),window.URL.revokeObjectURL(Se)}catch(M){v.error("Error downloading file:",M)}},w=async S=>{try{v.debug("ðŸ‘ï¸ Generating signed URL for view",{storagePath:S.storage_path});const{data:M,error:ne}=await pe.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(ne){v.error("Error creating signed URL:",ne);return}v.debug("âœ… Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){v.error("Error viewing file:",M)}},o=async S=>{if(confirm(`Supprimer le fichier "${S.file_name}" ?`))try{await D(S.id,S.storage_path)}catch(M){v.error("Error deleting file:",M)}},u=S=>S!=null&&S.startsWith("image/")?e.jsx(Ws,{className:"h-5 w-5 text-blue-500"}):S==="application/pdf"?e.jsx(Le,{className:"h-5 w-5 text-red-500"}):e.jsx(wa,{className:"h-5 w-5 text-gray-500"}),R=S=>S?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(S)):"",q=S=>S?S<1024?`${S} o`:S<1024*1024?`${(S/1024).toFixed(1)} Ko`:`${(S/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Hs,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:b?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents â€¢ SÃ©lection multiple possible â€¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:F,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:b,multiple:!0})]})}),p&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:p}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",k.length,")"]}),y?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):k.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:k.map(S=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:u(S.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[S.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:S.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:S.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:S.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[q(S.file_size)," â€¢ ",R(S.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[S.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>w(S),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:O,children:e.jsx(Ns,{className:"h-4 w-4"})}),S.field_label==="Document signÃ©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"âœ“ SignÃ©"}),e.jsx("button",{onClick:()=>E(S),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"TÃ©lÃ©charger",disabled:O,children:e.jsx(yt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"â³ En attente"}),e.jsx("button",{onClick:()=>o(S),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:O,children:e.jsx(Gt,{className:"h-4 w-4"})})]})]},S.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stockÃ©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"SÃ©lectionnez un projet pour voir les fichiers"})]})},yr=({prospectId:t,projectType:a,activeAdminUser:n})=>{const[r,g]=i.useState("notes"),{supabaseUserId:m}=ot(),h=[{id:"notes",label:"Notes",icon:Le},{id:"activity",label:"ActivitÃ©",icon:Pa},{id:"files",label:"Fichiers",icon:_a}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:h.map(({id:f,label:_,icon:k})=>e.jsxs("button",{onClick:()=>g(f),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===f?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{children:_})]},f))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(hr,{prospectId:t,projectType:a,currentUser:{id:m},activeAdminUser:n}),r==="activity"&&e.jsx(fr,{prospectId:t,projectType:a,activeAdminUser:n}),r==="files"&&e.jsx(jr,{prospectId:t,projectType:a,currentUser:{id:m},activeAdminUser:n})]})]})},Nr=({projectType:t,prospectId:a,activeAdminUser:n})=>{const{history:r,loading:g,error:m}=it({projectType:t,prospectId:a,enabled:!!t,activeAdminUser:n});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),g&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historiqueâ€¦"}),m&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",m]}),!g&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun Ã©vÃ©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(h=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.title||h.event_type}),h.description&&e.jsx("p",{className:"text-xs text-gray-600",children:h.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(h.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(h.created_by_name||h.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Par ",h.created_by_name||h.created_by]})]})]})]})]},h.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"SÃ©lectionnez un projet"})})},vr=({children:t,prospectId:a,projectType:n,currentStep:r,statusConfig:g,activeAdminUser:m})=>{var h,f,_;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(et.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((h=g[r.status])==null?void 0:h.iconOnly)||g.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((f=g[r.status])==null?void 0:f.badge)||g.pending.badge}`,children:((_=g[r.status])==null?void 0:_.label)||g.pending.label})]}),t]},r.name),!r&&!n&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Le,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet sÃ©lectionnÃ©"}),e.jsx("p",{className:"text-gray-500",children:"SÃ©lectionnez un projet dans la liste ci-dessus pour voir le suivi dÃ©taillÃ©."})]})]}),n&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(yr,{prospectId:a,projectType:n,activeAdminUser:m}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(Nr,{prospectId:a,projectType:n,activeAdminUser:m})]})]})},wr={CLIENT:mt,COMMERCIAL:Qs,PARTENAIRE:nt},_r={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},Sr={FORM:Le,SIGNATURE:Sa},Cr={FORM:"Formulaire",SIGNATURE:"Signature"},Ir=({isOpen:t,onClose:a,prospectId:n,projectType:r,moduleId:g,moduleName:m,moduleConfig:h,context:f={},availableForms:_=[],availableTemplates:k=[]})=>{var z,xe;const[y,b]=i.useState(null),[O,p]=i.useState(!1),[$,D]=i.useState(null),[N,F]=i.useState(!1),E=Aa(),w=i.useMemo(()=>h?h.actions&&h.actions.length>0?h.actions:h.actionConfig?[{order:1,status:"pending",actionConfig:h.actionConfig}]:[]:[],[h]),[o,u]=i.useState({}),[R,q]=i.useState(!1);i.useEffect(()=>{if(!t||!n||!g||w.length<=1){u({});return}(async()=>{q(!0);try{const V=w.map((Q,U)=>`v2-${g}-action-${U}`),{data:j,error:de}=await pe.from("client_form_panels").select("id, action_id, status").eq("prospect_id",n).eq("project_type",r).in("action_id",V),ee={};if(!de&&j&&j.length>0){for(const Q of j)Q.action_id&&(Q.status==="approved"||Q.status==="submitted")&&(ee[Q.action_id]=Q.status);console.log("[V2 Robot] Action statuses by action_id:",ee)}else{const{data:Q}=await pe.from("client_form_panels").select("id, step_name, status").eq("prospect_id",n).eq("project_type",r).in("status",["approved","submitted"]);if(Q){const U=Q.filter(ae=>!ae.step_name||ae.step_name===m||ae.step_name===g);U.forEach((ae,ge)=>{ge<w.length&&(ee[`v2-${g}-action-${ge}`]=ae.status)}),console.log("[V2 Robot] Fallback legacy statuses:",ee,"from",U.length,"panels")}}u(ee)}catch(V){console.error("[V2 Robot] Error fetching action statuses:",V)}finally{q(!1)}})()},[t,n,r,m,g,w.length]);const S=i.useMemo(()=>w.map((I,V)=>{const j=`v2-${g}-action-${V}`,de=o[j];return{...I,actionId:j,realStatus:de==="approved"?"validated":de==="submitted"?"submitted":"pending"}}),[w,o,g]),[M,ne]=i.useState(0);i.useEffect(()=>{if(t&&S.length>0&&!R){const I=S.findIndex(V=>V.realStatus!=="validated");ne(I>=0?I:S.length-1)}},[t,S,R]);const ue=S[M]||null,je=S.length,Se=je>1,L=i.useMemo(()=>{if(!ue)return!1;const I=ue.actionConfig;return!(!I||!I.actionType||!(Array.isArray(I.targetAudience)?I.targetAudience.length>0:!!I.targetAudience))},[ue]),W=(ue==null?void 0:ue.actionConfig)||null,C=()=>{if(!L||!W){K({title:"Configuration incomplÃ¨te",description:"Aucune action configurÃ©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:W.allowedFormIds,currentActionFull:ue,allActions:S.map((I,V)=>{var j;return{index:V,formIds:(j=I.actionConfig)==null?void 0:j.allowedFormIds}})});try{const I=Array.isArray(W.targetAudience)?W.targetAudience[0]:W.targetAudience,V=Ca({moduleId:g,moduleName:m,projectType:r,prospectId:n,actionIndex:M,actionConfig:{...W,targetAudience:I||"CLIENT"},message:""});b(V),D(null),console.log("[V2 Robot] ActionOrder gÃ©nÃ©rÃ©:",V)}catch(I){console.error("[V2 Robot] Erreur gÃ©nÃ©ration:",I),K({title:"Erreur",description:I.message,variant:"destructive"})}},Z=async()=>{if(!y){K({title:"Aucun ordre",description:"Simulez d'abord pour gÃ©nÃ©rer un ActionOrder.",variant:"destructive"});return}if(!E){K({title:"ExÃ©cution dÃ©sactivÃ©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}p(!0),D(null);try{const I={...y,_meta:{...y._meta,isSimulation:!1}},V=await Ia(I,f);D(V),V.success?(K({title:"âœ… Action exÃ©cutÃ©e",description:V.message,className:"bg-green-500 text-white"}),setTimeout(()=>{a()},1e3)):K({title:"âš ï¸ ExÃ©cution bloquÃ©e",description:V.message,variant:"destructive"})}catch(I){console.error("[V2 Robot] Erreur exÃ©cution:",I),D({success:!1,status:"error",message:I.message}),K({title:"Erreur",description:I.message,variant:"destructive"})}finally{p(!1)}},me=()=>{y&&(navigator.clipboard.writeText(JSON.stringify(y,null,2)),K({title:"CopiÃ© !",description:"ActionOrder JSON copiÃ© dans le presse-papiers."}))},le=jt.useRef(M);i.useEffect(()=>{const I=le.current!==M;if(le.current=M,I&&(b(null),D(null)),t&&L&&!R&&(!y||I)){const V=setTimeout(()=>{C()},I?50:0);return()=>clearTimeout(V)}},[t,L,R,M]),i.useEffect(()=>{t||(b(null),D(null),F(!1),ne(0))},[t]);const l=I=>{const V=_.find(j=>j.id===I);return(V==null?void 0:V.name)||I},P=I=>{const V=k.find(j=>j.id===I);return(V==null?void 0:V.name)||I};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(vs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m||g,Se&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["â€” Action ",M+1,"/",je]})]})]})]}),e.jsx("button",{onClick:a,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ze,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[Se&&L&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["ðŸ“‹ Ã‰tape ",M+1," sur ",je]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," terminÃ©e",M>1?"s":"",")"]})]}),!L&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Kt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est dÃ©finie pour cette Ã©tape."}),e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>{K({title:"Configurer cette Ã©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Gs,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:Se?`Action ${M+1}/${je}`:"Action configurÃ©e"}),E&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(W==null?void 0:W.actionType)&&e.jsxs(e.Fragment,{children:[jt.createElement(Sr[W.actionType]||Le,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:Cr[W.actionType]||W.actionType})]})}),(W==null?void 0:W.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(W.targetAudience)?W.targetAudience:[W.targetAudience]).map(I=>{const V=wr[I]||mt;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(V,{className:"h-3.5 w-3.5"}),_r[I]||I]},I)})]}),((z=W==null?void 0:W.allowedFormIds)==null?void 0:z.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",W.allowedFormIds.map(I=>l(I)).join(", ")]}),((xe=W==null?void 0:W.allowedTemplateIds)==null?void 0:xe.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",W.allowedTemplateIds.map(I=>P(I)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(W==null?void 0:W.managementMode)==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"]}),e.jsxs("span",{children:["VÃ©rif: ",(W==null?void 0:W.verificationMode)==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"]})]})]}),y&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>F(!N),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Js,{className:at("h-4 w-4 transition-transform",N&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:I=>{I.stopPropagation(),me()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(Xs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),N&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(y,null,2)})]}),$&&e.jsxs("div",{className:at("rounded-lg p-4 flex items-start gap-3",$.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[$.success?e.jsx(Ys,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Kt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:at("font-medium text-sm",$.success?"text-green-800":"text-red-800"),children:[$.status==="executed"&&"ExÃ©cutÃ© avec succÃ¨s",$.status==="simulated"&&"Simulation uniquement",$.status==="blocked"&&"ExÃ©cution bloquÃ©e",$.status==="error"&&"Erreur"]}),e.jsx("p",{className:at("text-sm mt-1",$.success?"text-green-700":"text-red-700"),children:$.message})]})]})]})]}),L&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(be,{variant:"outline",onClick:C,disabled:O,children:[e.jsx(Ns,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(be,{onClick:Z,disabled:!y||O||!E,className:at(!E&&"opacity-50 cursor-not-allowed"),children:[O?e.jsx(Ks,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Ta,{className:"h-4 w-4 mr-2"}),"ExÃ©cuter"]})]})]})}):null},Be="completed",Pe="in_progress",He="pending",ct={[Be]:{label:"TerminÃ©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Pe]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[He]:{label:"Ã€ venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},is=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const a={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||He}))};if(t.status!==Pe)return a;if(!a.subSteps.some(r=>r.status===Pe)){const r=a.subSteps.findIndex(g=>g.status===He);r!==-1&&(a.subSteps=a.subSteps.map((g,m)=>({...g,status:m===r?Pe:g.status})))}return a},ls=(t,a,n)=>{var k;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,g=r?`${a}:${r}`:null,m=g&&n?n[g]:null,h=(k=m==null?void 0:m.configJson)==null?void 0:k.actions;if(!h||h.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const y=t.subSteps.map((b,O)=>{var N,F;const p=h[O],D=((F=(N=p==null?void 0:p.config)==null?void 0:N.objective)==null?void 0:F.trim())||(p==null?void 0:p.title)||(p==null?void 0:p.label);return{...b,name:D||b.name||`Action ${O+1}`}});return{...t,subSteps:y}}const f=t.status||He,_=h.map((y,b)=>{var O;return{id:y.id||`v2-${r}-action-${b}`,name:((O=y.config)==null?void 0:O.objective)&&y.config.objective.trim()||y.title||y.label||`Action ${b+1}`,status:f===Be?Be:f===Pe&&b===0?Pe:He}});return{...t,subSteps:_,status:f}},kr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(a=>a.status===Be),Er=({form:t,prospectId:a,onFormSubmit:n})=>{const[r,g]=i.useState({}),m=(f,_)=>{g(k=>({...k,[f]:_}))},h=()=>{n(a,t.id,r),K({title:"RÃ©ponses enregistrÃ©es",description:`Les rÃ©ponses au formulaire "${t.name}" ont Ã©tÃ© sauvegardÃ©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(f=>{if(f.show_if_conditions&&f.show_if_conditions.length>0){const k=f.condition_operator||"AND",y=f.show_if_conditions.map(O=>{const p=r[O.field];return O.equals==="has_value"?!!p&&p!=="":p===O.equals});if(!(k==="AND"?y.every(O=>O===!0):y.some(O=>O===!0)))return null}if(f.show_if){const k=f.show_if.field,y=f.show_if.equals,b=r[k];if(!b||b!==y)return null}return(t.fields||[]).some(k=>k.is_repeater&&(k.repeats_fields||[]).includes(f.id))?null:e.jsxs("div",{children:[e.jsx(Ve,{htmlFor:`${t.id}-${f.id}`,children:f.label}),e.jsx(Xe,{id:`${t.id}-${f.id}`,type:f.type,value:typeof r[f.id]=="object"?"":r[f.id]||"",onChange:k=>m(f.id,k.target.value),placeholder:f.placeholder||""}),f.is_repeater&&f.repeats_fields&&f.repeats_fields.length>0&&r[f.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[f.id])||0},(k,y)=>{const b=(t.fields||[]).filter(O=>f.repeats_fields.includes(O.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[f.label," #",y+1]}),b.map(O=>{const p=`${f.id}_repeat_${y}_${O.id}`,$=r[p];return e.jsxs("div",{children:[e.jsx(Ve,{htmlFor:`${t.id}-${p}`,children:O.label}),e.jsx(Xe,{id:`${t.id}-${p}`,type:O.type,value:typeof $=="object"?"":$||"",onChange:D=>m(p,D.target.value),placeholder:O.placeholder||""})]},p)})]},y)})})]},f.id)}),e.jsx(be,{onClick:h,className:"w-full",children:"Soumettre"})]})},Ar=({prospectId:t,projectType:a,currentStepIndex:n,activeAdminUser:r,initialChannel:g})=>{var Ne,Re;const{addChatMessage:m,prompts:h,projectsData:f,forms:_,updateProspect:k,prospects:y,completeStepAndProceed:b,registerClientForm:O}=Je(),{users:p,loading:$}=pt(),{messages:D,loading:N}=Cs(t,a),{uploadFile:F,uploading:E}=ys({projectType:a,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:w}=it({projectType:a||"",prospectId:t,enabled:!!a&&!!t,activeAdminUser:r}),{user:o}=ot(),[u,R]=i.useState(""),[q,S]=i.useState(null),M=i.useRef(null),ne=i.useRef(null),[ue,je]=i.useState(!1),[Se,L]=i.useState(!1),[W,C]=i.useState(g==="partner"?"partner":g==="internal"?"internal":"client"),[Z,me]=i.useState(null),[le,l]=i.useState([]),{organizationId:P}=xt(),{partners:z,loading:xe}=ea(P||(r==null?void 0:r.organization_id));i.useEffect(()=>{if(!t||!a)return;(async()=>{try{const{data:x,error:c}=await pe.from("missions").select("id, partner_id, title, step_name, status, created_at").eq("prospect_id",t).eq("project_type",a).order("created_at",{ascending:!1});!c&&x&&l(x)}catch(x){v.error("âŒ Error loading partner missions for chat",x)}})()},[t,a]);const{templates:I,loading:V}=ks(P||(r==null?void 0:r.organization_id),a),{forms:j,loading:de}=ta(P||(r==null?void 0:r.organization_id)),{templates:ee,loading:Q}=sa(P||(r==null?void 0:r.organization_id)),U=(Re=(Ne=f[a])==null?void 0:Ne.steps)==null?void 0:Re[n],ae=i.useMemo(()=>U!=null&&U.name?U.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${n}`,[U,n]),ge=i.useMemo(()=>{if(!I||!ae)return null;const s=I[`${a}:${ae}`];return(s==null?void 0:s.configJson)||null},[I,ae,a]),oe=i.useMemo(()=>j?Object.values(j).map(s=>({id:s.id,name:s.name||s.title||"Formulaire sans nom"})):[],[j]),Ee=i.useMemo(()=>ee?Array.isArray(ee)?ee.map(s=>({id:s.id,name:s.name||"Template sans nom"})):Object.values(ee).map(s=>({id:s.id,name:s.name||"Template sans nom"})):[],[ee]),G=y.find(s=>s.id===t),ve=i.useMemo(()=>{var Y,B,J;if(!z.length)return[];const s=[...new Set(le.map(H=>H.partner_id).filter(Boolean))],x=[];I&&Object.values(I).forEach(H=>{var se,Ce,De,Me;const te=(Ce=(se=H.configJson)==null?void 0:se.actionConfig)==null?void 0:Ce.partnerId;te&&((Me=(De=H.configJson)==null?void 0:De.actionConfig)==null?void 0:Me.targetAudience)==="PARTENAIRE"&&x.push(te)});const c=[...new Set([...s,...x])];if(c.length===0)return[];const T=(J=(B=(Y=f[a])==null?void 0:Y.steps)==null?void 0:B[n])==null?void 0:J.name;return c.map(H=>{const te=z.find(he=>he.id===H),se=le.filter(he=>he.partner_id===H),De=!(se.length>0)&&x.includes(H),Me=se.some(he=>he.step_name===T&&(he.status==="pending"||he.status==="in_progress")),Ie=I&&Object.values(I).some(he=>{var fe,_e,Ae,we;return((_e=(fe=he.configJson)==null?void 0:fe.actionConfig)==null?void 0:_e.partnerId)===H&&((we=(Ae=he.configJson)==null?void 0:Ae.actionConfig)==null?void 0:we.targetAudience)==="PARTENAIRE"&&he.moduleId===(T||"").toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,"")});return{id:H,name:(te==null?void 0:te.companyName)||(te==null?void 0:te.name)||(te==null?void 0:te.email)||"Partenaire inconnu",specialty:(te==null?void 0:te.specialty)||null,missionsCount:se.length,hasActiveStep:Me,isV2Only:De,isV2CurrentStep:Ie,lastMission:se[0]||null}}).sort((H,te)=>H.hasActiveStep&&!te.hasActiveStep?-1:!H.hasActiveStep&&te.hasActiveStep?1:H.isV2CurrentStep&&!te.isV2CurrentStep?-1:!H.isV2CurrentStep&&te.isV2CurrentStep?1:H.missionsCount>0&&te.missionsCount===0?-1:H.missionsCount===0&&te.missionsCount>0?1:0)},[le,z,f,a,n,I]);i.useEffect(()=>{if(!Z&&ve.length>0){const s=ve.find(x=>x.hasActiveStep||x.isV2CurrentStep);me(s?s.id:ve[0].id)}},[ve,Z]);const ke=i.useMemo(()=>Object.values(h).filter(s=>{var c;if(s.projectId!==a)return!1;const x=(c=s.stepsConfig)==null?void 0:c[n];return x&&x.actions&&x.actions.length>0}),[h,a,n]),Fe=i.useCallback(async(s=null)=>{var Y;const x=ke[0];if(!x){v.warn("Aucun prompt disponible");return}const c=(Y=x.stepsConfig)==null?void 0:Y[n];if(!c||!c.actions){v.warn("Aucune action dans la config de l'Ã©tape");return}const T=[...c.actions].sort((B,J)=>(B.order||0)-(J.order||0));if(s){const B=T.findIndex(J=>J.id===s);if(B!==-1&&B+1<T.length){const J=T[B+1];v.info("ðŸŽ¯ Action suivante trouvÃ©e",{completedActionId:s,nextActionId:J.id,nextActionType:J.type}),await We(x,J.id);return}else{v.warn("Pas d'action suivante",{completedActionId:s,totalActions:T.length});return}}await We(x)},[ke,n]);xr({prospectId:t,projectType:a,currentStepIndex:n,prompt:ke[0],sendNextAction:Fe}),i.useEffect(()=>{requestAnimationFrame(()=>{var s;(s=M.current)==null||s.scrollIntoView({behavior:"smooth",block:"end"})})},[D,W]);const Te=async()=>{if(!(!u.trim()&&!q))try{let s=null;if(q){if(q.size>10485760){K({title:"âŒ Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}v.debug("ðŸ“¤ Uploading file from admin chat",{name:q.name,size:q.size,type:q.type});const{data:{user:T}}=await pe.auth.getUser(),Y=await F({file:q,uploadedBy:T==null?void 0:T.id});Y&&(s={id:Y.id,name:Y.file_name,size:Y.file_size,type:Y.file_type,storagePath:Y.storage_path},v.debug("âœ… File uploaded successfully",s))}const x={sender:"pro",text:u,file:s,channel:W,...W==="internal"&&{metadata:{sender_id:(r==null?void 0:r.user_id)||null,sender_name:(r==null?void 0:r.name)||"Admin",target_user_id:A||null}},...W==="partner"&&Z&&{partnerId:Z}};m(t,a,x),R(""),S(null),requestAnimationFrame(()=>{var c;(c=M.current)==null||c.scrollIntoView({behavior:"smooth",block:"end"})}),s&&K({title:"âœ… Fichier envoyÃ©",description:`${s.name} a Ã©tÃ© envoyÃ© avec succÃ¨s.`})}catch(s){v.error("âŒ Error sending message with file",s),K({title:"âŒ Erreur",description:`Impossible d'envoyer le fichier : ${s.message}`,variant:"destructive"})}},Ye=s=>{s.target.files&&s.target.files[0]&&S(s.target.files[0])},$e=async s=>{if(!s||!s.storagePath){K({title:"âŒ Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{v.debug("ðŸ“¥ Downloading file",{storagePath:s.storagePath});const{data:x,error:c}=await pe.storage.from("project-files").createSignedUrl(s.storagePath,3600);if(c)throw c;window.open(x.signedUrl,"_blank"),K({title:"âœ… TÃ©lÃ©chargement",description:`${s.name} s'ouvre dans un nouvel onglet.`})}catch(x){v.error("âŒ Error downloading file",x),K({title:"âŒ Erreur",description:`Impossible de tÃ©lÃ©charger le fichier : ${x.message}`,variant:"destructive"})}},Ke=(s,x,c)=>{var H;const T=y.find(te=>te.id===s);if(!T)return;const Y={...T.formData||{},...c};k({...T,formData:Y});const B={sender:"client",text:`A complÃ©tÃ© le formulaire : ${((H=_[x])==null?void 0:H.name)||"Formulaire"}.`};if(m(s,a,B),Object.values(h).find(te=>{var Ce,De;if(te.projectId!==a)return!1;const se=(Ce=te.stepsConfig)==null?void 0:Ce[n];return se!=null&&se.autoCompleteStep?(De=se.actions)==null?void 0:De.some(Me=>Me.type==="show_form"&&Me.formId===x):!1})){const te=ge==null?void 0:ge.actions;if(te&&te.length>1){K({title:"âœ… Formulaire reÃ§u",description:"Il reste d'autres actions Ã  complÃ©ter pour cette Ã©tape.",className:"bg-blue-500 text-white"});return}b(t,a,n),K({title:"Ã‰tape terminÃ©e !",description:"L'Ã©tape a Ã©tÃ© automatiquement marquÃ©e comme terminÃ©e.",className:"bg-green-500 text-white"})}},We=async(s,x=null)=>{var T,Y,B,J,H,te,se,Ce;const c=(T=s.stepsConfig)==null?void 0:T[n];if(c&&c.actions&&c.actions.length>0){const De=D,Me=[...c.actions].sort((fe,_e)=>(fe.order||0)-(_e.order||0));let Ie=Me,he=!1;if(x){const fe=Me.find(_e=>_e.id===x);if(!fe){v.warn("Action spÃ©cifique introuvable",{specificActionId:x});return}v.info("ðŸŽ¯ ExÃ©cution action spÃ©cifique (forcÃ©e)",{actionId:x,actionType:fe.type}),Ie=[fe],he=!0}for(const fe of Ie)if(!(!he&&De.some(Ae=>Ae.promptId===s.id&&Ae.stepIndex===n&&(Ae.text===fe.message||Ae.formId===fe.formId&&fe.type==="show_form")))){if(fe.message){const _e={sender:"pro",text:fe.message,promptId:s.id,stepIndex:n,actionId:fe.id};m(t,a,_e)}if(fe.type==="show_form"&&fe.formId){const _e={sender:"pro",formId:fe.formId,promptId:s.id,stepIndex:n,actionId:fe.id};m(t,a,_e);const Ae=((J=(B=(Y=f[a])==null?void 0:Y.steps)==null?void 0:B[n])==null?void 0:J.name)||"Ã‰tape inconnue";try{const we=await O({prospectId:t,projectType:a,formId:fe.formId,currentStepIndex:n,promptId:s.id,messageTimestamp:Date.now(),status:"pending",stepName:Ae,actionId:fe.id});if(!we.success)v.error("âŒ Ã‰chec enregistrement formulaire:",we.error),K({title:"Erreur",description:"Le formulaire n'a pas pu Ãªtre enregistrÃ©.",variant:"destructive"});else try{const Ue=((H=_[fe.formId])==null?void 0:H.name)||fe.formId;await w({prospectId:t,projectType:a,title:"Formulaire envoyÃ©",description:`Le formulaire ${Ue} a Ã©tÃ© envoyÃ© Ã  ${(G==null?void 0:G.name)||"le client"}.`,createdBy:(o==null?void 0:o.user_id)||null,createdByName:(o==null?void 0:o.name)||"Admin"})}catch(Ue){v.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",Ue)}}catch(we){v.error("âŒ Exception enregistrement formulaire:",we),K({title:"Erreur",description:"Le formulaire n'a pas pu Ãªtre enregistrÃ©.",variant:"destructive"})}}if(fe.type==="start_signature"&&fe.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de gÃ©nÃ©rer le contrat");v.info("ðŸ”¥ GÃ©nÃ©ration contrat via workflow sÃ©quentiel",{templateId:fe.templateId,prospectId:t,projectType:a,organizationId:r.organization_id,formId:fe.formId});const{data:_e,error:Ae}=await pe.from("prospects").select("form_data").eq("id",t).single(),we=((se=(te=_e==null?void 0:_e.form_data)==null?void 0:te[a])==null?void 0:se[fe.formId])||{};v.info("ðŸ“‹ DonnÃ©es formulaire extraites",{formId:fe.formId,dataKeys:Object.keys(we)}),K({title:"ðŸ“„ GÃ©nÃ©ration du contrat...",description:"CrÃ©ation du PDF en cours",className:"bg-blue-500 text-white"});const Ue=await ka({templateId:fe.templateId,projectType:a,prospectId:t,formData:we,organizationId:r==null?void 0:r.organization_id});if(Ue.success){const Et=Ue.fileData.id;v.debug("CrÃ©ation procÃ©dure de signature...",{fileId:Et,prospectId:t,projectType:a});const{data:Ms}=await pe.from("signature_procedures").select("*").eq("file_id",Et).eq("prospect_id",t).eq("status","pending").maybeSingle();let st=Ms;if(!st){const ft=crypto.randomUUID(),At=new Date;At.setDate(At.getDate()+7);const Yt=[{role:"principal",name:(G==null?void 0:G.name)||"Client",email:G==null?void 0:G.email,phone:(G==null?void 0:G.phone)||null,access_token:ft,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de crÃ©er la procÃ©dure de signature");const Os=typeof(G==null?void 0:G.name)=="string"&&G.name.trim()!==""?G.name:((Ce=G==null?void 0:G.email)==null?void 0:Ce.split("@")[0])||"Client",Ls=G==null?void 0:G.email,{data:zs,error:Pt}=await pe.from("signature_procedures").insert({prospect_id:t,project_type:a,file_id:Et,access_token:ft,access_token_expires_at:At.toISOString(),status:"pending",signers:Yt,organization_id:r.organization_id,signer_name:Os,signer_email:Ls}).select().single();if(Pt)throw v.error("Erreur crÃ©ation signature_procedures",Pt),Pt;st=zs,v.debug("ProcÃ©dure de signature crÃ©Ã©e",{procedureId:st.id,signersCount:Yt.length})}const $s=`https://evatime.fr/signature/${st.id}?token=${st.access_token}`,{data:Fs}=await pe.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",a).eq("sender","pro").ilike("text",`%/signature/${st.id}%`).maybeSingle();Fs||(await pe.from("chat_messages").insert({prospect_id:t,project_type:a,sender:"pro",text:`<a href="${$s}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">ðŸ‘‰ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id,channel:"client"}),v.debug("Lien de signature envoyÃ© dans le chat")),K({title:"âœ… Contrat gÃ©nÃ©rÃ© !",description:"Le contrat a Ã©tÃ© crÃ©Ã© et le lien de signature envoyÃ©.",className:"bg-green-500 text-white"});try{await w({prospectId:t,projectType:a,title:"Contrat gÃ©nÃ©rÃ©",description:`Le contrat a Ã©tÃ© gÃ©nÃ©rÃ© et envoyÃ© Ã  ${(G==null?void 0:G.name)||"le client"}.`,createdBy:(o==null?void 0:o.user_id)||null,createdByName:(o==null?void 0:o.name)||"Admin"})}catch(ft){v.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",ft)}}else throw new Error(Ue.error||"Erreur inconnue")}catch(_e){v.error("âŒ Exception gÃ©nÃ©ration contrat:",_e),K({title:"Erreur",description:`Impossible de gÃ©nÃ©rer le contrat: ${_e.message}`,variant:"destructive"})}break}}je(!1)},ze=D.filter(s=>!s.channel||s.channel==="client"),ye=D.filter(s=>s.channel==="partner"),ce=Z?ye.filter(s=>s.partnerId===Z):ye,ie=D.filter(s=>s.channel==="internal"),d=W==="partner"?ce:W==="internal"?ie:ze,[A,X]=i.useState(null),re=i.useMemo(()=>{const s=(p||[]).filter(se=>se.user_id!==(r==null?void 0:r.user_id)).filter(se=>se.role!=="Partner"),x=G==null?void 0:G.ownerId,c=s.find(se=>se.user_id===x),T=c!=null&&c.manager_id?s.find(se=>se.id===c.manager_id):null,Y=new Set;c&&Y.add(c.user_id),T&&Y.add(T.user_id);const B={"Global Admin":0,Admin:1,Manager:2,Commercial:3},J=s.filter(se=>!Y.has(se.user_id)).sort((se,Ce)=>(B[se.role]??9)-(B[Ce.role]??9)),H=[];c&&H.push({...c,tag:"ðŸ‘‘ Owner"}),T&&H.push({...T,tag:"ðŸ‘¤ Manager"});let te=null;return J.forEach(se=>{se.role!==te&&(te=se.role,H.push({isSeparator:!0,role:te})),H.push(se)}),H},[p,r,G==null?void 0:G.ownerId]);return i.useEffect(()=>{if(!A&&(G!=null&&G.ownerId)){const s=G.ownerId===(r==null?void 0:r.user_id),x=re.find(c=>!c.isSeparator);s&&x?X(x.user_id):s||X(G.ownerId)}},[G==null?void 0:G.ownerId,r==null?void 0:r.user_id,re]),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex mb-3 rounded-xl overflow-hidden border-2 border-gray-200",children:[e.jsxs("button",{onClick:()=>C("client"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${W==="client"?"bg-blue-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["ðŸ’¬ Client",ze.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${W==="client"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ze.length})]}),e.jsxs("button",{onClick:()=>C("partner"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${W==="partner"?"bg-orange-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["ðŸŸ  Partenaire",ce.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${W==="partner"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ce.length})]}),e.jsxs("button",{onClick:()=>C("internal"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${W==="internal"?"bg-purple-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["ðŸ‘¥ Interne",ie.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${W==="internal"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ie.length})]})]}),W==="internal"&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("span",{className:"text-sm text-purple-600 font-bold whitespace-nowrap",children:"â†’ Ã€ :"}),e.jsxs("select",{value:A||"",onChange:s=>X(s.target.value),className:"flex-1 text-sm border-2 border-purple-300 rounded-xl px-3 py-2.5 bg-purple-50 text-purple-900 font-semibold focus:ring-2 focus:ring-purple-400 focus:border-purple-400 focus:outline-none appearance-none cursor-pointer shadow-sm",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237c3aed' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"},children:[re.filter(s=>!s.isSeparator).length===0&&e.jsx("option",{value:"",children:"Aucun collÃ¨gue disponible"}),re.map((s,x)=>s.isSeparator?e.jsx("optgroup",{label:`â”€â”€ ${s.role} â”€â”€`},`sep-${x}`):e.jsx("option",{value:s.user_id,children:s.tag?`${s.tag}  Â·  ${s.name||s.email}`:s.name||s.email},s.user_id))]})]}),W==="partner"&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("span",{className:"text-sm text-orange-600 font-bold whitespace-nowrap",children:"ðŸŸ  Ã€ :"}),e.jsxs("select",{value:Z||"",onChange:s=>me(s.target.value),className:"flex-1 text-sm border-2 border-orange-300 rounded-xl px-3 py-2.5 bg-orange-50 text-orange-900 font-semibold focus:ring-2 focus:ring-orange-400 focus:border-orange-400 focus:outline-none appearance-none cursor-pointer shadow-sm",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23ea580c' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"},children:[ve.length===0&&e.jsx("option",{value:"",children:"Aucun partenaire sur ce projet"}),ve.map(s=>e.jsxs("option",{value:s.id,children:[s.hasActiveStep?"âš¡ ":s.isV2CurrentStep?"ðŸ”œ ":"",s.name,s.specialty?` Â· ${s.specialty}`:"",s.missionsCount>0?` (${s.missionsCount} mission${s.missionsCount>1?"s":""})`:" (configurÃ© V2)"]},s.id))]})]}),e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[d.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400 text-sm",children:W==="partner"?"ðŸŸ  Aucun message partenaire":W==="internal"?"ðŸ‘¥ Aucun message interne":"ðŸ’¬ Aucun message client"}),d.map((s,x)=>{var se,Ce,De,Me;const c=s.sender==="pro"||s.sender==="admin",T=s.sender==="partner",Y=s.sender==="client",B=s.channel==="internal",J=B&&((se=s.metadata)==null?void 0:se.sender_id)===(r==null?void 0:r.user_id),H=B&&!J,te=B?J:c;return e.jsxs("div",{className:`flex items-end gap-2 ${te?"justify-end":"justify-start"}`,children:[Y&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(G==null?void 0:G.name.charAt(0))||"?"}),T&&(()=>{const Ie=ve.find(fe=>fe.id===s.partnerId),he=Ie?Ie.name.charAt(0).toUpperCase():"P";return e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center font-bold text-white text-xs",title:(Ie==null?void 0:Ie.name)||"Partenaire",children:he})})(),H&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-400 flex items-center justify-center font-bold text-white text-xs",children:(((Ce=s.metadata)==null?void 0:Ce.sender_name)||"?").charAt(0).toUpperCase()}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${B?J?"bg-purple-500 text-white rounded-br-none p-2.5":"bg-purple-100 text-purple-900 rounded-bl-none p-3 border border-purple-200":c?"bg-blue-500 text-white rounded-br-none p-2.5":T?"bg-orange-100 text-orange-900 rounded-bl-none p-3 border border-orange-200":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[B&&((De=s.metadata)==null?void 0:De.sender_name)&&e.jsxs("span",{className:`inline-block text-xs font-bold mb-1 ${J?"text-purple-200":"text-purple-600"}`,children:["ðŸ‘¥ ",s.metadata.sender_name]}),T&&e.jsxs("span",{className:"inline-block text-xs font-bold text-orange-600 mb-1",children:["ðŸŸ  ",((Me=ve.find(Ie=>Ie.id===s.partnerId))==null?void 0:Me.name)||"Partenaire"]}),s.channel==="partner"&&c&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-300 mb-1",children:"â†’ Partenaire"}),s.text&&(c&&s.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:s.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:s.text})),s.file&&e.jsxs("button",{onClick:()=>$e(s.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Le,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.file.name}),e.jsx(yt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),s.formId&&_[s.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(Er,{form:_[s.formId],prospectId:t,onFormSubmit:Ke})}),e.jsx("p",{className:`text-xs mt-1 ${B?J?"text-purple-200":"text-purple-400":c?"text-blue-200":T?"text-orange-400":"text-gray-500"}`,children:aa(new Date(s.timestamp),{addSuffix:!0,locale:Ge})})]}),J&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center font-bold text-white text-xs",children:((r==null?void 0:r.name)||"?").charAt(0).toUpperCase()}),c&&!B&&!s.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},x)}),e.jsx("div",{ref:M})]}),q&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Qt,{className:"w-4 h-4"}),e.jsx("span",{children:q.name}),e.jsx("button",{onClick:()=>S(null),className:"text-red-500",children:"Ã—"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{placeholder:W==="internal"?"ðŸ‘¥ Ã‰crire en interne...":W==="partner"?"ðŸŸ  Ã‰crire au partenaire...":"ðŸ’¬ Ã‰crire au client...",className:`pr-28 h-12 ${W==="internal"?"border-purple-300 focus:ring-purple-400":W==="partner"?"border-orange-300 focus:ring-orange-400":""}`,value:u,onChange:s=>R(s.target.value),onKeyPress:s=>s.key==="Enter"&&Te()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(be,{variant:"ghost",size:"icon",onClick:()=>L(!0),title:"Workflow V2 - Actions automatisÃ©es",children:e.jsx(vs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(be,{variant:"ghost",size:"icon",onClick:()=>ne.current.click(),disabled:E,children:e.jsx(Qt,{className:`h-5 w-5 ${E?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:ne,onChange:Ye,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:E}),e.jsx(be,{onClick:Te,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:E,children:E?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(ra,{className:"h-4 w-4"})})]})]}),e.jsx(Ir,{isOpen:Se,onClose:()=>L(!1),prospectId:t,projectType:a,moduleId:ae,moduleName:(U==null?void 0:U.name)||`Ã‰tape ${n+1}`,moduleConfig:ge,context:{organizationId:P||(r==null?void 0:r.organization_id),adminUser:r},availableForms:oe,availableTemplates:Ee})]})},Pr=({steps:t,onUpdateStatus:a,prompts:n,projectType:r,currentStepIndex:g,prospectId:m,completeStepAndProceed:h})=>{var N;if(!t)return null;const[f,_]=i.useState({}),{activeAdminUser:k,appointments:y,updateAppointment:b}=Je(),O=n?Object.values(n).find(F=>F.projectId===r):null,p=(N=O==null?void 0:O.stepsConfig)==null?void 0:N[g],$=i.useMemo(()=>{if(!t[g])return[];const F=t[g].name,E=y.filter(w=>w.type==="task"&&w.contactId===m&&w.projectId===r&&w.step===F);return E.length>0&&v.debug("ðŸ” TÃ¢ches filtrÃ©es pour cette Ã©tape:",{prospectId:m,projectType:r,stepName:F,totalAppointments:y.length,filteredTasks:E.length,tasks:E.map(w=>({id:w.id,title:w.title,contactId:w.contactId,projectId:w.projectId,step:w.step}))}),E},[y,m,r,g,t]),D=(F,E)=>{_(w=>{var S;const o=w[F]||{},u={...o,[E]:!o[E]},R={...w,[F]:u},q=(S=p==null?void 0:p.actions)==null?void 0:S.find(M=>M.id===F);return q&&q.checklist&&q.checklist.every(ne=>u[ne.id])&&p!=null&&p.autoCompleteStep&&(K({title:"âœ… Checklist complÃ©tÃ©e !",description:"Passage automatique Ã  l'Ã©tape suivante...",className:"bg-green-500 text-white"}),h(m,r,g,t)),R})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((F,E)=>{const w=ct[F.status]||ct[He];return e.jsxs(et.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:E*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${w.iconOnly}`,children:F.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${w.text}`,children:F.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[F.subSteps&&F.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[F.subSteps.filter(o=>o.status===Be).length,"/",F.subSteps.length," sous-Ã©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(be,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${w.badge} hover:opacity-90`,onClick:o=>{var S;o.stopPropagation();const u=o.currentTarget,R=u.nextElementSibling,q=u.closest("[data-step-status-container]");!R||!q||((S=q.parentElement)==null||S.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==R&&M.classList.add("hidden")}),R.classList.toggle("hidden"))},children:w.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),a(E,Pe),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),a(E,Be),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),a(E,He),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Marquer Ã  venir"})]})]})]})]}),F.subSteps&&F.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:F.subSteps.map((o,u)=>{const R=ct[o.status]||ct[He];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${o.status===Be?"bg-green-500":o.status===Pe?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:o.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${R.badge}`,children:R.label})]},o.id||u)})}),F.status===Pe&&E===g&&(p==null?void 0:p.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:p.actions.filter(o=>o.hasClientAction===!1&&o.checklist&&o.checklist.length>0).map(o=>{const u=f[o.id]||{},R=o.checklist.length,q=o.checklist.filter(M=>u[M.id]).length,S=q===R;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"ðŸ“‹ Checklist Ã  complÃ©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${S?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[q,"/",R]})]}),e.jsx("div",{className:"space-y-2",children:o.checklist.map(M=>{const ne=u[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:()=>D(o.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ne?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(p==null?void 0:p.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"âš¡ Passage automatique Ã  l'Ã©tape suivante quand tout est cochÃ©"})]},o.id)})}),F.status===Pe&&E===g&&$.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:$.map(o=>{const u=o.status==="effectue",R=o.startTime?new Date(o.startTime):null,q=R&&!isNaN(R.getTime()),S=async()=>{const M=u?"pending":"effectue";await b(o.id,{status:M}),K({title:u?"ðŸ”„ TÃ¢che rÃ©ouverte":"âœ… TÃ¢che terminÃ©e",description:u?"La tÃ¢che a Ã©tÃ© remise en cours":"La tÃ¢che a Ã©tÃ© marquÃ©e comme terminÃ©e",className:u?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:S,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${u?"line-through text-gray-500":""} truncate flex-1`,children:o.title||"TÃ¢che"}),u&&e.jsx(ht,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),q&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["ðŸ“… ",tt(R,"dd/MM/yyyy Ã  HH:mm",{locale:Ge})]})]})]},o.id)})})]})]},E)})})]})},Dr=({prospect:t,projectType:a,supabaseSteps:n,v2Templates:r,onUpdate:g})=>{var le;const{forms:m,prompts:h,completeStepAndProceed:f,activeAdminUser:_,appointments:k,updateAppointment:y}=Je(),{formPanels:b=[],loading:O,updateFormPanel:p}=na(t.id),{sendMessage:$}=Cs(t.id,a),[D,N]=i.useState(null),[F,E]=i.useState({}),[w,o]=i.useState(!1),[u,R]=i.useState(null),[q,S]=i.useState(""),[M,ne]=i.useState(new Set),ue=i.useMemo(()=>{if(!b)return[];const l=b.filter(P=>P.prospectId===t.id&&P.projectType===a).sort((P,z)=>(z.createdAt||0)-(P.createdAt||0));return v.debug("[ProspectForms] Filtering panels",{totalPanels:b.length,prospectId:t.id,projectType:a,filteredCount:l.length,samplePanel:b[0]}),l},[b,t.id,a]);if(i.useEffect(()=>{!ue||ue.length===0||ue.forEach(l=>{var z,xe,I,V;if(M.has(l.panelId)||l.status!=="submitted")return;if(l.lastSubmittedAt){const j=new Date(l.lastSubmittedAt).getTime(),ee=Date.now()-j;if(ee>1e4){v.debug("Form too old, skipping auto-complete",{panelId:l.panelId,ageSeconds:Math.floor(ee/1e3)}),ne(Q=>new Set([...Q,l.panelId]));return}}v.debug("New submitted form detected",{panelId:l.panelId,formId:l.formId,projectType:l.projectType}),v.debug("Available prompts",{count:Object.keys(h).length});let P=null;if(l.promptId&&(v.debug("Searching by promptId",{promptId:l.promptId}),P=h[l.promptId]),P||(P=Object.values(h).find(j=>{var Q,U;if(v.debug("Testing prompt",{name:j.name,projectId:j.projectId,target:l.projectType}),j.projectId!==l.projectType)return!1;const de=(Q=j.stepsConfig)==null?void 0:Q[l.currentStepIndex];return(U=de==null?void 0:de.actions)==null?void 0:U.some(ae=>ae.type==="show_form"&&ae.formId===l.formId)})),v.debug("Prompt found",{name:P==null?void 0:P.name,autoComplete:(xe=(z=P==null?void 0:P.stepsConfig)==null?void 0:z[l.currentStepIndex])==null?void 0:xe.autoCompleteStep}),P){const j=(I=P.stepsConfig)==null?void 0:I[l.currentStepIndex],de=(V=j==null?void 0:j.actions)==null?void 0:V.find(Q=>Q.type==="show_form"&&Q.formId===l.formId),ee=(de==null?void 0:de.verificationMode)||"human";v.debug("Checking auto-complete conditions",{autoCompleteStep:j==null?void 0:j.autoCompleteStep,verificationMode:ee}),j!=null&&j.autoCompleteStep&&ee==="none"&&(v.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),f(t.id,l.projectType,l.currentStepIndex),K({title:"âœ… Ã‰tape terminÃ©e !",description:`${t.name} a complÃ©tÃ© le formulaire. Passage automatique Ã  l'Ã©tape suivante.`,className:"bg-green-500 text-white"}))}ne(j=>new Set([...j,l.panelId]))})},[ue,h,f,t.id,t.name,M]),ue.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const je=l=>{N(l.panelId);const xe=((t.form_data||t.formData||{})[l.projectType]||{})[l.formId]||{};E({...xe,_meta:{projectType:l.projectType,formId:l.formId}})},Se=()=>{N(null),E({})},L=async()=>{const{_meta:l,...P}=F,{projectType:z,formId:xe}=l||{};if(!z||!xe){v.error("âŒ MÃ©tadonnÃ©es manquantes pour la sauvegarde");return}const I=t.form_data||t.formData||{},V={...I,[z]:{...I[z]||{},[xe]:P}},{error:j}=await pe.from("prospects").update({form_data:V}).eq("id",t.id);if(j){v.error("âŒ Erreur sauvegarde formulaire:",j),K({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}K({title:"âœ… SauvegardÃ©",description:"Les modifications ont Ã©tÃ© enregistrÃ©es.",className:"bg-green-500 text-white"}),g&&g({...t,form_data:V,formData:V}),N(null),E({})},W=(l,P)=>{E(z=>({...z,[l]:P}))},C=l=>{var xe,I;const P=Object.values(h).find(V=>V.id===l.promptId||V.projectId===l.projectType),z=(xe=P==null?void 0:P.stepsConfig)==null?void 0:xe[l.currentStepIndex];return(I=z==null?void 0:z.actions)==null?void 0:I.find(V=>V.formId===l.formId)},Z=async l=>{var P,z,xe,I,V,j;try{await p(l.panelId,{status:"approved"});const de=C(l),ee=(de==null?void 0:de.verificationMode)||"human";if(v.debug("ðŸ” Checking verification mode",{verificationMode:ee,shouldSearchTask:ee==="human"}),ee==="human"){v.debug("ðŸ” Searching for related task",{totalAppointments:(k==null?void 0:k.length)||0,prospectId:t.id,projectType:l.projectType,stepName:l.stepName,panel:l});const ye=(k==null?void 0:k.filter(d=>d.type==="task"))||[],ce=ye.filter(d=>d.contactId===t.id);v.debug("ðŸ” Task filtering debug",{allTasks:ye.length,prospectTasks:ce.length,prospectTasksData:ce.map(d=>({id:d.id,title:d.title,contactId:d.contactId,projectId:d.projectId,step:d.step,status:d.status}))}),v.debug("ðŸ” Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:l.projectType,step:l.stepName,status:"pending",titleIncludes:"VÃ©rifier le formulaire"}});let ie=k==null?void 0:k.find(d=>{var re;const A={isTask:d.type==="task",contactMatch:d.contactId===t.id,projectMatch:d.projectId===l.projectType,stepMatch:d.step===l.stepName,isPending:d.status==="pending",titleMatch:(re=d.title)==null?void 0:re.includes("VÃ©rifier le formulaire")},X=Object.values(A).every(Ne=>Ne);return!X&&d.type==="task"&&d.contactId===t.id&&v.warn("ðŸ” Task failed matching:",{taskId:d.id,title:d.title,checks:A,COMPARISON:{taskStep:`"${d.step}"`,panelStep:`"${l.stepName}"`,areEqual:d.step===l.stepName,taskStepType:typeof d.step,panelStepType:typeof l.stepName},taskData:{contactId:d.contactId,projectId:d.projectId,step:d.step,status:d.status},panelData:{projectType:l.projectType,stepName:l.stepName}}),X});ie||(v.warn("âš ï¸ Task not found with exact step, trying fallback without step",{panelStep:l.stepName}),ie=k==null?void 0:k.find(d=>{var A;return d.type==="task"&&d.contactId===t.id&&d.projectId===l.projectType&&d.status==="pending"&&((A=d.title)==null?void 0:A.includes("VÃ©rifier le formulaire"))}),ie&&v.info("âœ… Found task via fallback (without step match)",{taskId:ie.id,taskStep:ie.step})),ie?(v.info("âœ… Found verification task, marking as completed",{taskId:ie.id,prospectId:t.id,title:ie.title}),await y(ie.id,{status:"effectue"}),K({title:"âœ… TÃ¢che mise Ã  jour",description:"La tÃ¢che de vÃ©rification a Ã©tÃ© marquÃ©e comme effectuÃ©e.",className:"bg-blue-500 text-white"})):v.warn("âš ï¸ No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:l.projectType,step:l.stepName,status:"pending",titleContains:"VÃ©rifier le formulaire"}})}else v.debug("â­ï¸ Skipping task search (verificationMode !== human)",{verificationMode:ee});const Q=n==null?void 0:n[l.projectType],U=Q==null?void 0:Q.findIndex(ye=>ye.status==="in_progress"),ae=U!=null&&U>=0?U:l.currentStepIndex||0,ge=(P=Q==null?void 0:Q[ae])==null?void 0:P.name,oe=ge?ge.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,Ee=`${l.projectType}:${oe}`,G=oe&&r?r[Ee]:null,ve=(z=G==null?void 0:G.configJson)==null?void 0:z.actionConfig;v.debug("[V2] Template lookup",{panelProjectType:l.projectType,propProjectType:a,currentStepName:ge,moduleId:oe,templateKey:Ee,v2TemplatesKeys:r?Object.keys(r):[],templateFound:!!G});const ke=ge?_s(ge):null,Fe=(ve==null?void 0:ve.completionTrigger)||(ke==null?void 0:ke.completionTrigger),Te=(xe=G==null?void 0:G.configJson)==null?void 0:xe.actions,Ye=Te&&Te.length>1;let $e=!0;if(Ye){const ye=Te.map((X,re)=>`v2-${oe}-action-${re}`),{data:ce}=await pe.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",l.projectType).eq("status","approved");let ie=new Set;(ce||[]).forEach(X=>{X.action_id&&ye.includes(X.action_id)&&ie.add(X.action_id)});const d=(ce||[]).filter(X=>!X.action_id&&(!X.step_name||X.step_name===ge||X.step_name===oe));if(d.length>0){const X=ye.filter(re=>!ie.has(re));d.forEach((re,Ne)=>{Ne<X.length&&ie.add(X[Ne])}),v.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:d.length,uncoveredIds:X,afterAssignment:[...ie]})}const A=ie.size;$e=A>=Te.length,v.debug("[V2] Multi-actions check",{totalActions:Te.length,expectedActionIds:ye,approvedActionIds:[...ie],panelsTotal:(ce||[]).length,panelsWithActionId:(ce||[]).filter(X=>X.action_id).length,panelsWithoutActionId:d.length,allCompleted:$e}),$e||(v.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:Te.length-A}),K({title:"âœ… Action validÃ©e",description:`Action ${A}/${Te.length} â€” il reste ${Te.length-A} action(s) avant de terminer l'Ã©tape.`,className:"bg-blue-500 text-white"}))}v.debug("[V2] Checking completionTrigger for form approval",{stepName:ge,moduleId:oe,v2TemplateFound:!!G,completionTrigger:Fe,currentStepIdx:ae,hasMultiActions:Ye,allActionsCompleted:$e});const Ke=(Fe==="form_approved"||!Fe)&&$e;let We=Q;if(Q&&((V=(I=Q[ae])==null?void 0:I.subSteps)==null?void 0:V.length)>0){const ye=Q[ae];let ce=-1;if(l.action_id&&(ce=ye.subSteps.findIndex(ie=>ie.id===l.action_id)),ce===-1&&(ce=ye.subSteps.findIndex(ie=>ie.status===Pe),v.debug("[V2] Substep fallback: using first in_progress",{panelActionId:l.action_id,fallbackIndex:ce})),ce!==-1){v.debug("[V2] Updating substep for approved action",{actionId:l.action_id,subStepIndex:ce,subStepName:ye.subSteps[ce].name,allActionsCompleted:$e});const ie=JSON.parse(JSON.stringify(Q));if(ie[ae].subSteps.forEach((d,A)=>{d.status===Pe&&A!==ce&&(d.status=Be)}),ie[ae].subSteps[ce].status=Be,!$e){let d=-1;for(let A=ce+1;A<ie[ae].subSteps.length;A++)if(ie[ae].subSteps[A].status===He){d=A;break}d!==-1&&(ie[ae].subSteps[d].status=Pe,v.debug("[V2] Activated next substep",{completedIndex:ce,nextIndex:d,nextName:ie[ae].subSteps[d].name}))}await updateSupabaseSteps(l.projectType,ie),We=ie,v.info("[V2] Substep updated successfully",{completedSubStep:ce,nextActivated:!$e})}}if(Ke&&We)v.info("[V2] Form approved â†’ completing step",{prospectId:t.id,projectType:l.projectType,currentStepIdx:ae,stepName:ge,trigger:Fe||"default_behavior"}),await f(t.id,l.projectType,ae,We),K({title:"âœ… Ã‰tape validÃ©e automatiquement",description:"La validation du formulaire a dÃ©clenchÃ© le passage Ã  l'Ã©tape suivante",className:"bg-green-500 text-white"});else{const ye=Object.values(h).find(ce=>ce.id===l.promptId||ce.projectId===l.projectType);if(ye){const ce=(j=ye.stepsConfig)==null?void 0:j[l.currentStepIndex];ce!=null&&ce.autoCompleteStep&&(v.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:l.projectType,stepIndex:l.currentStepIndex}),Q?await f(t.id,l.projectType,l.currentStepIndex,Q):v.error("No steps found in supabaseSteps for projectType",{projectType:l.projectType}))}}const ze=l.filledByRole==="partner";if(ze)v.debug("Formulaire partenaire validÃ© â€” pas de message chat au client");else{const ye=(de==null?void 0:de.approvalMessage)||"Merci ! Votre formulaire a Ã©tÃ© validÃ©.",{data:ce}=await pe.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",l.projectType).eq("sender","admin").eq("text",ye).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!ce||ce.length===0?await $({sender:"admin",text:ye,relatedMessageTimestamp:new Date().toISOString()}):v.debug("Message de validation dÃ©jÃ  envoyÃ© rÃ©cemment, skip")}if(ze&&l.formId){const{data:ye,error:ce}=await pe.from("missions").select("id, form_ids, status").eq("prospect_id",t.id).eq("status","submitted");if(!ce&&(ye==null?void 0:ye.length)>0){const ie=ye.find(d=>{var A;return(A=d.form_ids)==null?void 0:A.includes(l.formId)});if(ie){const{error:d}=await pe.from("missions").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",ie.id);d?v.error("âŒ Erreur mise Ã  jour mission â†’ completed",d):v.info("âœ… Mission passÃ©e en completed",{missionId:ie.id})}}}K({title:"âœ… Formulaire validÃ©",description:ze?"Le formulaire partenaire a Ã©tÃ© validÃ©. Mission marquÃ©e comme complÃ©tÃ©e.":"Un message a Ã©tÃ© envoyÃ© au client.",className:"bg-green-500 text-white"})}catch(de){v.error("âŒ Erreur validation formulaire:",de),K({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},me=async(l="")=>{if(u)try{const P=u,z=P.filledByRole==="partner";await p(P.panelId,{status:"rejected",rejectionReason:z?l:null});const xe=C(P),I=(xe==null?void 0:xe.verificationMode)||"human";if(v.debug("ðŸ” Checking verification mode (reject)",{verificationMode:I,shouldSearchTask:I==="human",isPartnerForm:z}),I==="human"){v.debug("ðŸ” Searching for related task (reject)",{totalAppointments:(k==null?void 0:k.length)||0,prospectId:t.id,projectType:P.projectType,stepName:P.stepName}),v.debug("ðŸ” Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:P.projectType,step:P.stepName,status:"pending",titleIncludes:"VÃ©rifier le formulaire"}});let V=k==null?void 0:k.find(j=>{var Q;const de={isTask:j.type==="task",contactMatch:j.contactId===t.id,projectMatch:j.projectId===P.projectType,stepMatch:j.step===P.stepName,isPending:j.status==="pending",titleMatch:(Q=j.title)==null?void 0:Q.includes("VÃ©rifier le formulaire")},ee=Object.values(de).every(U=>U);return!ee&&j.type==="task"&&j.contactId===t.id&&v.warn("ðŸ” Task failed matching (REJECT):",{taskId:j.id,title:j.title,checks:de,COMPARISON:{taskStep:`"${j.step}"`,panelStep:`"${P.stepName}"`,areEqual:j.step===P.stepName,taskStepType:typeof j.step,panelStepType:typeof P.stepName},taskData:{contactId:j.contactId,projectId:j.projectId,step:j.step,status:j.status},panelData:{projectType:P.projectType,stepName:P.stepName}}),ee});V||(v.warn("âš ï¸ Task not found with exact step (reject), trying fallback",{panelStep:P.stepName}),V=k==null?void 0:k.find(j=>{var de;return j.type==="task"&&j.contactId===t.id&&j.projectId===P.projectType&&j.status==="pending"&&((de=j.title)==null?void 0:de.includes("VÃ©rifier le formulaire"))}),V&&v.info("âœ… Found task via fallback (reject, without step match)",{taskId:V.id,taskStep:V.step})),V&&(v.info("âœ… Found verification task, marking as completed (rejected)",{taskId:V.id,prospectId:t.id,title:V.title}),await y(V.id,{status:"effectue"}))}else v.debug("â­ï¸ Skipping task search (reject, verificationMode !== human)",{verificationMode:I});if(z){if(P.formId){const{data:V}=await pe.from("missions").select("id, form_ids").eq("prospect_id",t.id).eq("status","submitted"),j=V==null?void 0:V.find(de=>{var ee;return(ee=de.form_ids)==null?void 0:ee.includes(P.formId)});j&&(await pe.from("missions").update({status:"pending"}).eq("id",j.id),v.info("âœ… Mission remise en pending (admin a refusÃ©)",{missionId:j.id}))}K({title:"âŒ Formulaire rejetÃ©",description:"La mission est revenue dans l'onglet Missions du partenaire.",className:"bg-red-500 text-white"})}else{const j=`${(xe==null?void 0:xe.rejectionMessage)||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :"}

${l}`;await $({sender:"admin",text:j,relatedMessageTimestamp:new Date().toISOString()}),K({title:"âŒ Formulaire rejetÃ©",description:"Un message a Ã©tÃ© envoyÃ© au client.",className:"bg-red-500 text-white"})}o(!1),R(null),S("")}catch(P){v.error("âŒ Erreur rejet formulaire:",P),K({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ue.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:ue.map(l=>{var I,V;const P=m[l.formId];let z={};if(l.filledByRole==="partner"&&l.formData?z=l.formData:z=((t.form_data||t.formData||{})[l.projectType]||{})[l.formId]||{},!P)return null;const xe=l.stepName||((V=(I=n==null?void 0:n[l.projectType])==null?void 0:I[l.currentStepIndex])==null?void 0:V.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:P.name}),xe&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ã‰tape : ",xe]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${l.status==="submitted"?"bg-green-100 text-green-700":l.status==="approved"?"bg-blue-100 text-blue-700":l.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:l.status==="submitted"?"EnvoyÃ©":l.status==="approved"?"ApprouvÃ©":l.status==="rejected"?"RejetÃ©":"En attente"})]}),l.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["âœ… ",l.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(be,{size:"sm",onClick:()=>Z(l),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(ht,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(be,{size:"sm",variant:"outline",onClick:()=>{R(l),o(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),l.status==="rejected"&&l.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:l.rejectionReason.startsWith("Mission impossible")?"â›” Mission dÃ©clarÃ©e impossible par le partenaire":"âŒ Formulaire rejetÃ©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:l.rejectionReason.startsWith("Mission impossible â€” ")?l.rejectionReason.replace("Mission impossible â€” ",""):l.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(P.fields||[]).map(j=>{if(j.show_if_conditions&&j.show_if_conditions.length>0){const U=j.condition_operator||"AND",ae=j.show_if_conditions.map(oe=>{const Ee=z[oe.field];return oe.equals==="has_value"?!!Ee&&Ee!=="":Ee===oe.equals});if(!(U==="AND"?ae.every(oe=>oe===!0):ae.some(oe=>oe===!0)))return null}if(j.show_if){const U=j.show_if.field,ae=j.show_if.equals,ge=z[U];if(!ge||ge!==ae)return null}if((P.fields||[]).some(U=>U.is_repeater&&(U.repeats_fields||[]).includes(j.id)))return null;const ee=z[j.id],Q=j.type==="file"&&typeof ee=="object"&&(ee==null?void 0:ee.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Ve,{className:"text-sm font-medium text-gray-600",children:j.label}),D===l.panelId?Q?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Le,{className:"inline h-4 w-4 mr-2"}),ee.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):j.type==="select"?e.jsxs("select",{value:F[j.id]||"",onChange:U=>W(j.id,U.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(j.options||[]).map((U,ae)=>e.jsx("option",{value:U,children:U},ae))]}):e.jsx(Xe,{type:j.type||"text",value:F[j.id]||"",onChange:U=>W(j.id,U.target.value),placeholder:j.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:Q?e.jsxs("button",{onClick:async()=>{try{const{data:U,error:ae}=await pe.storage.from("project-files").createSignedUrl(ee.storagePath,3600);if(ae)throw ae;window.open(U.signedUrl,"_blank")}catch{K({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsx("span",{children:ee.name}),e.jsx(yt,{className:"h-3 w-3"})]}):typeof ee=="object"&&ee!==null?ee.name?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Le,{className:"h-4 w-4 text-gray-400"})," ",ee.name]}):e.jsx("span",{className:"text-gray-400 italic",children:"DonnÃ©e non affichable"}):ee||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseignÃ©"})}),j.is_repeater&&j.repeats_fields&&j.repeats_fields.length>0&&ee&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(ee)||0},(U,ae)=>{const ge=(P.fields||[]).filter(oe=>j.repeats_fields.includes(oe.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[j.label," #",ae+1]}),ge.map(oe=>{const Ee=`${j.id}_repeat_${ae}_${oe.id}`,G=z[Ee],ve=oe.type==="file"&&typeof G=="object"&&(G==null?void 0:G.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Ve,{className:"text-xs font-medium text-gray-600",children:oe.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:ve?e.jsxs("button",{onClick:async()=>{try{const{data:ke,error:Fe}=await pe.storage.from("project-files").createSignedUrl(G.storagePath,3600);if(Fe)throw Fe;window.open(ke.signedUrl,"_blank")}catch{K({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Le,{className:"h-3 w-3"}),e.jsx("span",{children:G.name}),e.jsx(yt,{className:"h-3 w-3"})]}):typeof G=="object"&&G!==null?G.name||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"DonnÃ©e non affichable"}):G||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseignÃ©"})})]},Ee)})]},ae)})})]},j.id)})}),l.filledByRole==="partner"&&z.__partner_comment__&&e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg px-3 py-2 mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-orange-700 mb-1",children:"ðŸ’¬ Commentaire du partenaire"}),e.jsx("p",{className:"text-sm text-orange-900",children:z.__partner_comment__})]}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D===l.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(be,{variant:"outline",size:"sm",onClick:Se,children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(be,{size:"sm",onClick:L,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Jt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>je(l),children:[e.jsx(Nt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},l.panelId)})}),e.jsx(vt,{open:w,onOpenChange:o,children:e.jsxs(wt,{className:"max-w-lg",children:[e.jsxs(_t,{children:[e.jsx(St,{children:"Rejeter le formulaire"}),e.jsx(Ss,{children:"Expliquez au client pourquoi le formulaire est rejetÃ©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((le=C(u))==null?void 0:le.rejectionMessage)||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ve,{children:"Raison du refus"}),e.jsx("textarea",{value:q,onChange:l=>S(l.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Wt,{children:[e.jsx(be,{variant:"outline",onClick:()=>{o(!1),R(null),S("")},children:"Annuler"}),e.jsx(be,{onClick:()=>me(q),disabled:!q.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},Tr=({prospect:t,projectType:a,onUpdate:n})=>{const{forms:r}=Je(),[g,m]=i.useState(null),[h,f]=i.useState({}),_=i.useMemo(()=>Object.values(r).filter(p=>p.audience==="internal"&&(p.projectIds||[]).includes(a)),[r,a]);i.useEffect(()=>{if(t&&t.form_data){const p=t.form_data[a]||{};f(p)}},[t,a]);const k=p=>{m(p)},y=()=>{if(m(null),t&&t.form_data){const p=t.form_data[a]||{};f(p)}},b=(p,$,D)=>{f(N=>({...N,[p]:{...N[p]||{},[$]:D}}))},O=async()=>{try{const p={...t.form_data||{},[a]:h},$={...t,form_data:p,formData:p};await n($),K({title:"âœ… Formulaire enregistrÃ©",description:"Les donnÃ©es du formulaire interne ont Ã©tÃ© sauvegardÃ©es.",className:"bg-green-500 text-white"}),m(null)}catch(p){v.error("Erreur sauvegarde formulaire interne:",p),K({title:"âŒ Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[_.length," formulaire(s)"]})]}),_.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'CrÃ©ez un formulaire avec "Interne (Ã©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:_.map(p=>{const $=h[p.id]||{},D=g===p.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:p.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (Ã©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(p.fields||[]).map(N=>{if(N.show_if_conditions&&N.show_if_conditions.length>0){const w=N.condition_operator||"AND",o=N.show_if_conditions.map(R=>{const q=$[R.field];return R.equals==="has_value"?!!q&&q!=="":q===R.equals});if(!(w==="AND"?o.every(R=>R===!0):o.some(R=>R===!0)))return null}if(N.show_if){const w=N.show_if.field,o=N.show_if.equals,u=$[w];if(!u||u!==o)return null}if((p.fields||[]).some(w=>w.is_repeater&&(w.repeats_fields||[]).includes(N.id)))return null;const E=$[N.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Ve,{className:"text-sm font-medium text-gray-600",children:[N.label,N.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),D?N.type==="textarea"?e.jsx("textarea",{value:E,onChange:w=>b(p.id,N.id,w.target.value),placeholder:N.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):N.type==="select"?e.jsxs("select",{value:E,onChange:w=>b(p.id,N.id,w.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(N.options||[]).map((w,o)=>e.jsx("option",{value:w,children:w},o))]}):e.jsx(Xe,{type:N.type||"text",value:E,onChange:w=>b(p.id,N.id,w.target.value),placeholder:N.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:E||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseignÃ©"})}),N.is_repeater&&N.repeats_fields&&N.repeats_fields.length>0&&E&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(E)||0},(w,o)=>{const u=(p.fields||[]).filter(R=>N.repeats_fields.includes(R.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[N.label," #",o+1]}),u.map(R=>{const q=`${N.id}_repeat_${o}_${R.id}`,S=$[q]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Ve,{className:"text-xs font-medium text-gray-600",children:R.label}),D?R.type==="textarea"?e.jsx("textarea",{value:S,onChange:M=>b(p.id,q,M.target.value),placeholder:R.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):R.type==="select"?e.jsxs("select",{value:S,onChange:M=>b(p.id,q,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(R.options||[]).map((M,ne)=>e.jsx("option",{value:M,children:M},ne))]}):e.jsx(Xe,{type:R.type||"text",value:S,onChange:M=>b(p.id,q,M.target.value),placeholder:R.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:S||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseignÃ©"})})]},q)})]},o)})})]},N.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D?e.jsxs(e.Fragment,{children:[e.jsxs(be,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(be,{size:"sm",onClick:O,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Jt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>k(p.id),children:[e.jsx(Nt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},p.id)})})]})},Rr=t=>{switch(t.type){case"email":return e.jsx(Ct,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(lt,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(ia,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(It,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(mt,{className:"h-4 w-4 text-gray-400"}):e.jsx(la,{className:"h-4 w-4 text-gray-400"})}},Mr=({prospect:t,onBack:a,onUpdate:n,onEditingChange:r})=>{var Re;const{getProjectSteps:g,completeStepAndProceed:m,updateProjectSteps:h,markNotificationAsRead:f,projectsData:_,formContactConfig:k,currentUser:y,userProjects:b,setUserProjects:O,getProjectInfo:p,updateProjectInfo:$,activeAdminUser:D,prompts:N,notifications:F}=Je(),{supabaseUserId:E}=ot(),{users:w,loading:o}=pt(),{projectStepsStatus:u,updateProjectSteps:R}=va(t.id),{organizationId:q}=xt(),{templates:S}=ks(q||(D==null?void 0:D.organization_id),null),[M,ne]=ws(),ue=M.get("project")||t._selectedProjectType,je=M.get("notificationId"),Se=M.get("channel"),[L,W]=i.useState(ue||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:C,addProjectEvent:Z}=it({projectType:L||"",prospectId:t.id,enabled:!!L&&!!t.id,activeAdminUser:D}),[me,le]=i.useState(!1),[l,P]=i.useState(t);i.useEffect(()=>{P(t)},[t]);const[z,xe]=i.useState(!1),I=i.useMemo(()=>L?p(t.id,L)||{}:{},[L,p,t.id]),[V,j]=i.useState((I==null?void 0:I.status)||"actif"),[de,ee]=i.useState({}),Q=I==null?void 0:I.amount,U=i.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[ae,ge]=i.useState(""),[oe,Ee]=i.useState(!1),G=i.useMemo(()=>[{value:"unassigned",label:"Non assignÃ©"},...w.map(s=>({value:s.user_id,label:s.name}))],[w]),ve=i.useMemo(()=>{var x;if(!L)return[];if(u[L])return u[L].map(c=>ls(c,L,S)).map(is);const s=(x=_[L])==null?void 0:x.steps;if(s&&s.length>0){const c=JSON.parse(JSON.stringify(s));return c[0].status="in_progress",c.map(T=>ls(T,L,S)).map(is)}return[]},[L,u,_,S]),ke=ve.findIndex(s=>s.status===Pe),Fe=ve[ke]||ve.find(s=>s.status===He)||ve[0];i.useEffect(()=>{if(je){f(parseInt(je));const s=new URLSearchParams(M);s.delete("notificationId"),ne(s,{replace:!0})}},[je,f,ne,M]),i.useEffect(()=>{var x;const s=M.get("project");s&&s!==L&&((x=t.tags)!=null&&x.includes(s))&&W(s)},[M,t.tags]),i.useEffect(()=>{if(!(t!=null&&t.id)||!L||!F||!f)return;const s=F.filter(x=>!x.read&&x.prospectId===t.id&&x.projectType===L);s.length>0&&s.forEach(x=>{f(x.id)})},[t==null?void 0:t.id,L,F,f]),i.useEffect(()=>{v.debug("Prospect prop changed",{name:t.name}),P(t)},[t]),i.useEffect(()=>{oe||(Q==null||Q===""?ge(""):ge(Q.toString()))},[Q,oe]),i.useEffect(()=>{(async()=>{var T;if(!L||!t.id)return;const{data:x,error:c}=await pe.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",L).maybeSingle();c?(v.error("Erreur chargement project status:",c),j("actif")):(T=x==null?void 0:x.data)!=null&&T.status?j(x.data.status):j("actif")})()},[L,t.id]),i.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:x,error:c}=await pe.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(x){const T={};x.forEach(Y=>{T[Y.project_type]=Y.status||"actif"}),ee(T)}})()},[t.id,t.tags]),i.useEffect(()=>{r&&r(me)},[me,r]),i.useEffect(()=>{if(!t.id)return;const s=pe.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async x=>{var se;const{new:c,old:T}=x;if(c.status!=="signed"||(T==null?void 0:T.status)==="signed")return;const Y=c.project_type;v.info("[V2 Signature Listener] Signature completed",{procedureId:c.id,projectType:Y,prospectId:c.prospect_id});const B=u==null?void 0:u[Y];if(!B||B.length===0){v.warn("[V2 Signature Listener] No steps found for project type",{projectType:Y});return}const J=B.findIndex(Ce=>Ce.status==="in_progress");if(J===-1){v.warn("[V2 Signature Listener] No current step in_progress",{projectType:Y});return}const H=(se=B[J])==null?void 0:se.name;if(!H){v.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:J});return}const te=_s(H);if((te==null?void 0:te.completionTrigger)!=="signature"){v.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:H,completionTrigger:(te==null?void 0:te.completionTrigger)||"null"});return}v.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:Y,currentStepIdx:J,stepName:H});try{await m(t.id,Y,J,B),K({title:"âœ… Ã‰tape validÃ©e automatiquement",description:`La signature a dÃ©clenchÃ© la validation de "${H}"`,className:"bg-green-500 text-white"})}catch(Ce){v.error("[V2 Signature Listener] Error completing step",Ce)}}).subscribe();return()=>{pe.removeChannel(s)}},[t.id,u,m]);const Te=s=>{W(s),ne(x=>(x.set("project",s),x),{replace:!0})},Ye=async s=>{if(!L||!t.id)return;const x=V;j(s);try{const{error:c}=await pe.from("project_infos").upsert({prospect_id:t.id,project_type:L,status:s,data:(I==null?void 0:I.data)||{}},{onConflict:"prospect_id,project_type"});if(c)throw c;const T={actif:"rÃ©activÃ©",abandon:"abandonnÃ©",archive:"archivÃ©"},{error:Y}=await pe.from("project_history").insert({prospect_id:t.id,project_type:L,event_type:"status",description:`Projet ${T[s]||s}`,organization_id:D==null?void 0:D.organization_id,metadata:{old_status:x,new_status:s}});Y&&v.error("Erreur historique:",Y),$(t.id,L,(B={})=>({...B,status:s})),ee(B=>({...B,[L]:s})),K({title:"âœ… Statut mis Ã  jour",description:`Le projet est maintenant "${T[s]}".`,className:"bg-green-500 text-white"})}catch(c){v.error("Erreur lors du changement de statut:",c),j(x),K({title:"âŒ Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},$e=s=>{ge(s)},Ke=s=>{if(!L)return;const x=s.replace(",",".").trim();if(x===""){$(t.id,L,(Y={})=>{if(!Y.amount)return Y;const B={...Y};return delete B.amount,B}),ge("");return}const c=parseFloat(x);if(Number.isNaN(c)||c<0){ge(Q==null?"":Q.toString());return}const T=Math.round(c*100)/100;$(t.id,L,(Y={})=>({...Y,amount:T})),ge(T.toFixed(2))},We=()=>{Ke(ae),Ee(!1)},ze=s=>{s.key==="Enter"&&(s.preventDefault(),Ke(s.currentTarget.value),s.currentTarget.blur(),Ee(!1))},ye=async(s,x)=>{var T,Y;const c=ve[s];if(x===Be&&((T=c==null?void 0:c.subSteps)==null?void 0:T.length)>0&&!kr(c)){K({title:"Sous-Ã©tapes en cours",description:"Vous devez valider chaque sous-Ã©tape avant de terminer cette Ã©tape.",variant:"destructive"});return}if(x===Pe&&((Y=c==null?void 0:c.subSteps)==null?void 0:Y.length)>0){const B=JSON.parse(JSON.stringify(ve)),J=B[s];J.status=Pe,J.subSteps=J.subSteps.map((H,te)=>({...H,status:te===0?Pe:He})),await R(L,B),C&&await C({event_type:"pipeline",title:"Ã‰tape relancÃ©e",description:`Sous-Ã©tapes rÃ©initialisÃ©es pour Â« ${J.name} Â»`,metadata:{step_id:(J==null?void 0:J.id)||null,step_name:(J==null?void 0:J.name)||null,previous_status:(c==null?void 0:c.status)||null,new_status:Pe,project_type:L},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)});return}if(x===Be){const B=JSON.parse(JSON.stringify(ve));B[s].status="completed";let J=s+1;if(J<B.length&&(B[J].status="in_progress"),await R(L,B),C){const H=J<B.length?B[J]:null;await C({event_type:"pipeline",title:"Ã‰tape du pipeline mise Ã  jour",description:c&&H?`Ã‰tape Â« ${c.name} Â» complÃ©tÃ©e â†’ passage Ã  Â« ${H.name} Â»`:`Ã‰tape Â« ${c.name} Â» complÃ©tÃ©e`,metadata:{previous_step_id:(c==null?void 0:c.id)||null,previous_step_name:(c==null?void 0:c.name)||null,previous_step_status:(c==null?void 0:c.status)||null,new_step_id:(H==null?void 0:H.id)||null,new_step_name:(H==null?void 0:H.name)||null,new_step_status:"in_progress",project_type:L},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}if(J<B.length&&B[J].globalStepId){const H=B[J].globalStepId,te={...t,status:H};n(te),K({title:"ðŸ“Š Pipeline mis Ã  jour",description:"Le prospect a Ã©tÃ© dÃ©placÃ© dans le pipeline"})}}else{const B=ve.map((H,te)=>{let se=H.status;return te===s&&(se=x),{...H,status:se}});if(await R(L,B),C){const H=B[s];await C({event_type:"pipeline",title:"Ã‰tape du pipeline mise Ã  jour",description:`Ã‰tape Â« ${H.name} Â» passÃ©e de Â« ${c.status==="pending"?"Ã€ venir":c.status==="in_progress"?"En cours":"TerminÃ©"} Â» Ã  Â« ${x==="pending"?"Ã€ venir":x==="in_progress"?"En cours":"TerminÃ©"} Â»`,metadata:{step_id:(H==null?void 0:H.id)||null,step_name:(H==null?void 0:H.name)||null,previous_status:(c==null?void 0:c.status)||null,new_status:x,project_type:L},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}const J=B[s];if(J.globalStepId&&x==="in_progress"){const H={...t,status:J.globalStepId};n(H)}}},ce=async s=>{var c,T;const x=l.tags||[];if(!x.includes(s)){const Y={...l,tags:[...x,s]};if(P(Y),n(Y),W(s),y&&t.id===y.id&&!b.includes(s)){const J=[...b,s];O(J)}const B=(c=_[s])==null?void 0:c.steps;if(B&&B.length>0)try{const J=JSON.parse(JSON.stringify(B));J[0].status="in_progress",await R(s,J),v.debug("Steps initialized in Supabase",{projectType:s})}catch(J){v.error("Steps initialization error:",J)}K({title:"âœ… Projet ajoutÃ© !",description:`Le projet ${(T=_[s])==null?void 0:T.title} a Ã©tÃ© associÃ© au prospect.`})}xe(!1)},ie=()=>{const s=l.tags||[];return Object.values(_).filter(x=>x.isPublic&&!s.includes(x.type))},d=async s=>{switch(s){case"Appel":l.phone&&(window.location.href=`tel:${l.phone}`);break;case"Mail":l.email&&(window.location.href=`mailto:${l.email}`);break;case"WhatsApp":if(l.phone){const x=l.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${x}`,"_blank")}else K({title:"NumÃ©ro de tÃ©lÃ©phone manquant",description:"Ce contact n'a pas de numÃ©ro de tÃ©lÃ©phone.",variant:"destructive"});break;case"GPS":if(t.address){const x=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${x}`:window.open(`https://www.google.com/maps/search/?api=1&query=${x}`,"_blank")}break;case"Invitation":if(!l.email){K({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const x=`${window.location.origin}/dashboard`,c=q||(D==null?void 0:D.organization_id);console.log("[handleActionClick] ðŸ“§ Sending magic link to:",l.email,"org:",c);const{error:T}=await pe.auth.signInWithOtp({email:l.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:x,data:{organization_id:c}}});T?(console.error("[handleActionClick] âŒ Magic link error:",T),K({title:"âŒ Erreur envoi invitation",description:T.message,variant:"destructive"})):(console.log("[handleActionClick] âœ… Magic link sent to:",l.email),K({title:"âœ… Invitation envoyÃ©e",description:`Magic link envoyÃ© Ã  ${l.email}`,className:"bg-green-500 text-white"}))}catch(x){console.error("[handleActionClick] ðŸ’¥ Exception:",x),K({title:"âŒ Erreur",description:x.message,variant:"destructive"})}break;default:K({title:`Action: ${s}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},A=()=>{const s=window.scrollY;le(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:s,behavior:"instant"})})})},X=()=>{try{n(l),le(!1),K({title:"âœ… Prospect mis Ã  jour",description:"Les informations du prospect ont Ã©tÃ© enregistrÃ©es."})}catch(s){v.error("âŒ Erreur sauvegarde:",s),K({title:"âŒ Erreur",description:s.message,variant:"destructive"})}},re=(s,x)=>{P(c=>({...c,[s]:x}))},Ne=s=>{let x=s;s==="unassigned"?x=null:s==="user-1"&&E&&(x=E),P(c=>({...c,ownerId:x}))};return _[L],i.useEffect(()=>{const s=document.createElement("style");return s.id="disable-auto-scroll",s.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(s),()=>{const x=document.getElementById("disable-auto-scroll");x&&x.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(et.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(be,{variant:"ghost",size:"icon",onClick:a,className:"rounded-full hover:bg-gray-100",children:e.jsx(Zs,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:l.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associÃ©s"}),e.jsx(be,{size:"icon",className:"rounded-full",onClick:()=>xe(!0),children:e.jsx(Lt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(l.tags||[]).map(s=>{var c;const x=de[s]||"actif";return e.jsxs("button",{onClick:()=>Te(s),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${L===s?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((c=_[s])==null?void 0:c.title)||s}),x==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${L===s?"text-red-200":"text-red-600"}`,children:"(AbandonnÃ©)"}),x==="archive"&&e.jsx("span",{className:`text-xs font-medium ${L===s?"text-gray-300":"text-gray-500"}`,children:"(ArchivÃ©)"})]},s)}),(!l.tags||l.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associÃ©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:lt,label:"Appel"},{icon:Ct,label:"Mail"},{icon:zt,label:"WhatsApp"},{icon:It,label:"GPS"},{icon:Us,label:"Invitation",highlight:!l.userId}].map(({icon:s,label:x,highlight:c})=>e.jsxs("button",{onClick:()=>d(x),className:`flex flex-col items-center space-x-1 transition-colors group ${c?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${c?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(s,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:x})]},x))})]}),e.jsx($r,{prospectId:t.id,projectType:L}),e.jsx(Dr,{prospect:l,projectType:L,supabaseSteps:u,v2Templates:S,onUpdate:s=>{P(s),n&&n(s)}}),e.jsx(Tr,{prospect:l,projectType:L,onUpdate:s=>{P(s),n&&n(s)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),me?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:X,children:e.jsx(Jt,{className:"h-4 w-4"})}),e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>le(!1),children:e.jsx(Ze,{className:"h-4 w-4"})})]}):e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:A,children:e.jsx(Nt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[k.map(s=>e.jsxs("div",{className:"flex items-start space-x-3",children:[Rr(s),e.jsxs("div",{className:"flex-1",children:[e.jsx(Ve,{htmlFor:s.id,className:"text-xs text-gray-500",children:s.name.replace("*","")}),me?e.jsx(Xe,{id:s.id,name:s.id,type:s.type,value:l[s.id]||"",onChange:x=>re(s.id,x.target.value),className:"h-8 text-sm",placeholder:s.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:l[s.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseignÃ©"})})]})]},s.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(mt,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Ve,{className:"text-xs text-gray-500",children:"Suivi par"}),me?e.jsx(Na,{options:G,value:l.ownerId||"unassigned",onSelect:Ne,placeholder:"SÃ©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouvÃ©."}):e.jsx("p",{className:"text-gray-700",children:((Re=w.find(s=>s.user_id===l.ownerId))==null?void 0:Re.name)||"Non assignÃ©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(Da,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Ve,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(mt,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Ve,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assignÃ©"})]})]})]})]})]}),e.jsx(vr,{prospectId:t.id,projectType:L,currentStep:Fe,statusConfig:ct,activeAdminUser:D,children:L&&e.jsx(Ar,{prospectId:t.id,projectType:L,currentStepIndex:ke!==-1?ke:0,activeAdminUser:D,initialChannel:Se})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[L&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>Ee(!oe),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:oe?"Annuler":"Modifier le montant",children:oe?e.jsx(Ze,{className:"h-4 w-4 text-gray-600"}):e.jsx(Nt,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),oe?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"â‚¬"}),e.jsx(Xe,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:ae,onChange:s=>$e(s.target.value),onKeyDown:ze,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(be,{size:"sm",onClick:We,className:"h-8",children:e.jsx(ht,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof Q=="number"?U.format(Q):"0,00 â‚¬"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Ã‰tapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(qt,{value:V,onValueChange:Ye,children:[e.jsx(Vt,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${V==="actif"?"bg-green-100 text-green-700":V==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Bt,{})}),e.jsxs(Ht,{className:"w-44",children:[e.jsx(qe,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx(qe,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"AbandonnÃ©"}),e.jsx(qe,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"ArchivÃ©"})]})]})]})}),e.jsx(Pr,{steps:ve,onUpdateStatus:ye,prompts:N,projectType:L,currentStepIndex:ke,prospectId:t.id,completeStepAndProceed:m})]})]})]})]}),e.jsx(vt,{open:z,onOpenChange:xe,children:e.jsxs(wt,{className:"sm:max-w-md",children:[e.jsxs(_t,{children:[e.jsx(St,{children:"Ajouter un projet"}),e.jsx(Ss,{children:"SÃ©lectionnez un projet Ã  associer Ã  ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:ie().length>0?ie().map(s=>e.jsxs(be,{variant:"outline",onClick:()=>ce(s.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:s.icon}),e.jsx("span",{className:"font-medium",children:s.title})]},s.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont dÃ©jÃ  associÃ©s Ã  ce prospect."})})]})})]})},$r=({prospectId:t,projectType:a})=>{var W;const{activeAdminUser:n,prospects:r,projectsData:g,appointments:m,agendaLoading:h,updateAppointment:f,deleteAppointment:_,addAppointment:k,addCall:y,addTask:b,updateCall:O,updateTask:p}=Je(),{users:$,loading:D}=pt(),{supabaseUserId:N}=ot(),[F,E]=i.useState(null),[w,o]=i.useState(null),[u,R]=i.useState(null),[q,S]=i.useState(!1),[M,ne]=i.useState(null),ue=i.useMemo(()=>!m||m.length===0?[]:m.filter(Z=>{var le;if(Z.contactId!==t||a&&Z.projectId!==a)return!1;const me=(le=Z.status)==null?void 0:le.toLowerCase();return!(me!=="pending"&&me!=="prevu")}).sort((Z,me)=>{const le=new Date(Z.start),l=new Date(me.start);return le-l}),[m,t,a]),je=(C,Z)=>{R(C)},Se=()=>{E(null),o(null),R(null)},L=C=>{R(null),ne({...C,type:C.type}),S(!0)};return h?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"ActivitÃ© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activitÃ©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["ActivitÃ©s Ã  venir ",a&&`(${(W=g[a])==null?void 0:W.title})`]})}),ue.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activitÃ© future planifiÃ©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:ue.map(C=>{const Z=new Date(C.start),me={physical:{icon:ut,color:"blue",label:"ðŸ“ RDV"},virtual:{icon:ut,color:"purple",label:"ðŸŽ¥ Visio"},call:{icon:lt,color:"green",label:"ðŸ“ž Appel"},task:{icon:ht,color:"yellow",label:"âœ… TÃ¢che"}},le=me[C.type]||me.physical,l=le.icon,P={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},z={effectue:"EffectuÃ©",annule:"AnnulÃ©",reporte:"ReportÃ©",pending:"PrÃ©vu"};return e.jsxs("div",{onClick:()=>je(C,C.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${le.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(l,{className:`h-5 w-5 text-${le.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:C.title||le.label}),C.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:C.notes}),C.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["ðŸ“ ",C.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${le.color}-700 bg-${le.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:tt(Z,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:tt(Z,"HH:mm")})]})]}),z[C.status]&&C.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${P[C.status]}`,children:z[C.status]})]},C.id)})})]}),e.jsx(Fr,{event:u,onClose:Se,onReport:()=>{},onEdit:L,prospects:r,supabaseUsers:$,updateAppointment:f,deleteAppointment:_,projectsData:g}),q&&e.jsx(Is,{open:q,onOpenChange:C=>{C||ne(null),S(C)},initialData:M||{contactId:t,projectId:a},defaultAssignedUserId:N,addAppointment:k,addCall:y,addTask:b,updateAppointment:f,updateCall:O,updateTask:p,prospects:r||[],users:$||[],projectsData:g||{}})]})},Fr=({event:t,onClose:a,onReport:n,onEdit:r,prospects:g,supabaseUsers:m,updateAppointment:h,deleteAppointment:f,projectsData:_})=>{var w;const[k,y]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!g||!m||!h||!f||!_)return null;const b=g.find(o=>o.id===t.contactId),O=m.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(b?m.find(o=>o.user_id===b.ownerId):null),p=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",$=(o,u,R={})=>{try{const q=new Date(o);return isNaN(q.getTime())?"Date invalide":tt(q,u,R)}catch{return"Date invalide"}},D=o=>{y(o),h(t.id,{status:o}),setTimeout(()=>{a(),o==="reporte"&&n(t)},300)},N=()=>{f(t.id),K({title:"âœ… RDV supprimÃ©",description:"Le rendez-vous a Ã©tÃ© retirÃ© de votre agenda."}),a()},F=o=>{if(!b){K({title:"Contact non trouvÃ©",variant:"destructive"});return}switch(o){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:K({title:`Action: ${o}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activitÃ©"},effectue:{color:"bg-green-500",label:"EffectuÃ©"},annule:{color:"bg-red-500",label:"AnnulÃ©"},reporte:{color:"bg-yellow-500",label:"ReportÃ©"}};return e.jsx(vt,{open:!!t,onOpenChange:o=>!o&&a(),children:e.jsxs(wt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:a,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ze,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p($(t.start,"eeee d MMMM",{locale:Ge}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Ge})," - ",$(t.end,"HH:mm",{locale:Ge})]})]}),e.jsx(_t,{className:"p-0 text-left space-y-1",children:e.jsx(St,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(nt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (AssignÃ©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:lt,label:"Appel"},{icon:Ct,label:"Mail"},{icon:zt,label:"WhatsApp"},{icon:It,label:"GPS"}].map(({icon:o,label:u})=>e.jsxs("button",{onClick:()=>F(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[k].color}`,children:e.jsxs(qt,{onValueChange:D,value:k,children:[e.jsx(Vt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Bt,{placeholder:"Qualifier votre activitÃ©"})}),e.jsxs(Ht,{children:[e.jsx(qe,{value:"pending",disabled:!0,children:"Qualifier votre activitÃ©"}),e.jsx(qe,{value:"effectue",children:"EffectuÃ©"}),e.jsx(qe,{value:"annule",children:"AnnulÃ©"}),e.jsx(qe,{value:"reporte",children:"ReportÃ©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activitÃ©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((w=_[t.projectId])==null?void 0:w.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ã‰tape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(Wt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(us,{children:[e.jsx(ms,{asChild:!0,children:e.jsxs(be,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Gt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(gs,{children:[e.jsxs(xs,{children:[e.jsx(ps,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(hs,{children:"Cette action est irrÃ©versible. Le rendez-vous sera dÃ©finitivement supprimÃ©."})]}),e.jsxs(fs,{children:[e.jsx(bs,{children:"Annuler"}),e.jsx(js,{onClick:N,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(be,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activitÃ©"})]})]})})};function Or(t,a){const n=t.prospect,r=a.prospect;return!n||!r?!1:n.id===r.id&&(n.updatedAt||n.updated_at)===(r.updatedAt||r.updated_at)}const Lr=jt.memo(Mr,Or),os=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],zr=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" "):"",Qe=t=>(t||"").toString().trim().toUpperCase(),qr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},Vr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFIÃ‰",name:"QualifiÃ©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"NÃ‰GOCIATION",name:"NÃ©gociation"},{id:"closed",label:"FERMÃ‰",name:"FermÃ©"}],cs=50,ds=50,Ur=()=>{var ce,ie;const t=Je(),[a,n]=ws(),{organizationId:r}=xt(),[g,m]=i.useState(null),[h,f]=i.useState(!1),[_,k]=i.useState("all"),[y,b]=i.useState(null),[O,p]=i.useState(!1),[$,D]=i.useState([]),[N,F]=i.useState(!1),E=i.useRef(null),[w,o]=i.useState(""),u=i.useRef(null),[R,q]=i.useState(!1),[S,M]=i.useState(!1),[ne,ue]=i.useState({}),{users:je,loading:Se}=pt(),{authUserId:L}=ot(),W=t==null?void 0:t.addProspect,{prospects:C=[],prospectsLoading:Z=!0,allProjectSteps:me={},allStepsLoading:le=!0,updateProspect:l=async()=>{},projectsData:P={},activeAdminUser:z=null,users:xe={},globalPipelineSteps:I=[],pipelineLoading:V=!0,getProjectSteps:j=()=>[],adminReady:de=!1}=t||{},ee=i.useMemo(()=>je.reduce((d,A)=>(d[A.user_id]={id:A.id,user_id:A.user_id,name:A.name,email:A.email,role:A.role,phone:A.phone,avatarUrl:A.avatar_url,managerId:A.manager_id,accessRights:A.access_rights},d),{}),[je]);i.useEffect(()=>{de&&!Z&&!le&&!S&&M(!0)},[de,Z,le,S]);const Q=C,U=l,ae=(C==null?void 0:C.find(d=>d.id===g))||null,ge=i.useMemo(()=>!I||I.length===0?Vr:I.map((d,A)=>{const X=Qe(d.label),re=d.color||qr[X]||os[A%os.length];return{id:d.id,label:d.label,name:zr(d.label),color:re}}),[I]),oe=i.useMemo(()=>{if(!z)return[];if(z.role==="Global Admin"||z.role==="Admin")return Object.values(ee);const d=z.access_rights||z.accessRights,A=[z.user_id,...(d==null?void 0:d.users)||[]];return Object.values(ee).filter(X=>A.includes(X.user_id))},[z,ee]),Ee=i.useMemo(()=>{const d=oe.map(A=>({value:A.user_id,label:A.name}));return oe.length>1?[{value:"all",label:"Tous les utilisateurs"},...d]:d},[oe]);i.useEffect(()=>{z&&y===null&&(oe.length>1?b("all"):oe.length===1&&b(oe[0].user_id))},[z,y,oe]),i.useEffect(()=>{if(!N)return;const d=A=>{E.current&&!E.current.contains(A.target)&&F(!1)};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[N]);const G=i.useMemo(()=>{const d=new Set;return Q.forEach(A=>{(A.tags||[]).forEach(X=>d.add(X))}),Array.from(d)},[Q]),ve=$.length===0?"Tags":$.length===1?((ce=P[$[0]])==null?void 0:ce.title)||$[0]:`${$.length} tags`,ke=i.useMemo(()=>{const d=Q.filter(X=>{if(!z)return!1;if(z.role==="Global Admin"||z.role==="Admin")return!0;const re=z.access_rights||z.accessRights;return[z.user_id,...(re==null?void 0:re.users)||[]].includes(X.ownerId)});v.debug("[FinalPipeline] Prospects count",{total:Q.length,visible:d.length});let A=d;if($.length>0&&(A=A.filter(X=>{const re=X.tags||[];return $.some(Ne=>re.includes(Ne))})),y&&y!=="all"&&(A=A.filter(X=>X.ownerId===y)),w.trim()){const X=w.toLowerCase();A=A.filter(re=>(re.name||"").toLowerCase().includes(X)||(re.email||"").toLowerCase().includes(X)||(re.city||"").toLowerCase().includes(X)||(re.phone||"").toLowerCase().includes(X))}return _==="mine"&&L?A.filter(X=>X.ownerId===L):A},[Q,_,L,y,$,w]),{stagesWithCounts:Fe,prospectsByStage:Te}=i.useMemo(()=>{var x;const d=ge.reduce((c,T)=>(c[T.id]=[],c),{}),A=((x=ge[0])==null?void 0:x.id)||"fallback-stage",X=new Set(ge.map(c=>c.id)),re=new Map(ge.map(c=>[Qe(c.label),c.id])),Ne=c=>{const T=[];return c.projectType&&P[c.projectType]&&T.push(c.projectType),Array.isArray(c.tags)&&c.tags.forEach(Y=>{P[Y]&&!T.includes(Y)&&T.push(Y)}),T},Re=c=>{const T=[];if(!I.length){const B=c.stage||A,J=X.has(B)?B:A;return T.push({stageId:J,prospect:c}),T}if(typeof j!="function")return T.push({stageId:A,prospect:c}),T;const Y=Ne(c);return Y.length?(Y.forEach(B=>{var Me;const J=`${c.id}-${B}`,H=me[J]||(typeof j=="function"?j(c.id,B):[])||[],te=((Me=P[B])==null?void 0:Me.steps)||[];if(!H.length){T.push({stageId:A,prospect:c,projectType:B});return}const se=H.find(Ie=>Ie.status==="in_progress"||Ie.status==="current")||H.find(Ie=>Ie.status==="pending")||H[H.length-1];if(!se){T.push({stageId:A,prospect:c,projectType:B});return}const De=(()=>{if(se.globalStepId&&X.has(se.globalStepId))return se.globalStepId;if(se.globalStepId){const Ae=Qe(se.globalStepId),we=re.get(Ae);if(we&&X.has(we))return we}const Ie=H.indexOf(se);let he=null;if(Ie>=0&&te[Ie]&&(he=te[Ie]),!he){const Ae=Qe(se.name||se.label);he=te.find(we=>Qe(we.name||we.label)===Ae)}if(he!=null&&he.globalStepId&&X.has(he.globalStepId))return he.globalStepId;if(he!=null&&he.globalStepId){const Ae=Qe(he.globalStepId),we=re.get(Ae);if(we&&X.has(we))return we}if(he&&(he.label||he.name)){const Ae=Qe(he.label||he.name),we=re.get(Ae);if(we&&X.has(we))return we}const fe=Qe(se.label||se.name),_e=re.get(fe);return _e&&X.has(_e)?_e:A})();T.push({stageId:De,prospect:c,projectType:B,activeStep:se})}),T):(T.push({stageId:A,prospect:c}),T)};return ke.forEach(c=>{Re(c).forEach(({stageId:Y,projectType:B,activeStep:J})=>{d[Y]||(d[Y]=[]),d[Y].push({prospect:c,projectType:B,activeStep:J})})}),{stagesWithCounts:ge.map(c=>{var T;return{...c,count:((T=d[c.id])==null?void 0:T.length)||0}}),prospectsByStage:d}},[ge,ke,I,j,P]);i.useEffect(()=>{const d=a.get("prospect"),A=a.get("project"),X=`${d}-${A}`;if(u.current===X)return;if(!d){g!==null&&(m(null),u.current=null);return}(Q.find(Ne=>Ne.id===d)||null)&&(m(d),u.current=X)},[a,Q]);const Ye=d=>{D(A=>A.includes(d)?A.filter(X=>X!==d):[...A,d])},$e=i.useCallback((d,A)=>{m(d.id),n(X=>{const re=new URLSearchParams(X);return re.set("prospect",d.id),A?re.set("project",A):re.delete("project"),re})},[n]),Ke=i.useCallback(d=>{ue(A=>({...A,[d]:(A[d]||cs)+ds}))},[]),We=()=>{m(null);const d=new URLSearchParams(a);d.delete("prospect"),d.delete("project"),n(d)},ze=async d=>{var A,X;try{if(!W)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const re=((A=I[0])==null?void 0:A.step_id)||((X=I[0])==null?void 0:X.id);console.log("[handleAddProspect] calling addProspect",{name:d.name,email:d.email,status:re,ownerId:z==null?void 0:z.user_id,sendInvitation:d.sendInvitation,allData:d});const Ne=await W({...d,status:re,ownerId:z==null?void 0:z.user_id});if(console.log("[handleAddProspect] result",Ne),!(Ne!=null&&Ne.id))throw new Error("Prospect non crÃ©Ã© - rÃ©sultat vide");if(console.log("[handleAddProspect] ðŸ” sendInvitation check:",{sendInvitation:d.sendInvitation,email:Ne.email,willSend:d.sendInvitation&&Ne.email}),d.sendInvitation&&Ne.email)try{const Re=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] ðŸ“§ Sending magic link to:",Ne.email.trim(),"redirect:",Re,"org:",r);const{error:s}=await pe.auth.signInWithOtp({email:Ne.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:Re,data:{organization_id:r}}});s?(console.error("[handleAddProspect] âŒ invitation error",s),K({title:"Prospect crÃ©Ã©",description:`âš ï¸ Invitation non envoyÃ©e: ${s.message}`,variant:"warning"})):(console.log("[handleAddProspect] âœ… invitation sent to",Ne.email),K({title:"âœ… Prospect crÃ©Ã©",description:`Invitation envoyÃ©e Ã  ${Ne.email}`,className:"bg-green-500 text-white"}))}catch(Re){console.error("[handleAddProspect] ðŸ’¥ invitation exception",Re),K({title:"Prospect crÃ©Ã©",description:`âš ï¸ Erreur envoi invitation: ${Re.message}`,variant:"warning"})}else console.log("[handleAddProspect] â­ï¸ Skipping invitation:",{reason:d.sendInvitation?"no email":"sendInvitation=false"});f(!1)}catch(re){console.error("âŒ handleAddProspect error",re),K({title:"Erreur",description:re.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},ye=d=>{try{U&&(U(d),K({title:"Prospect mis Ã  jour",description:"Les informations ont Ã©tÃ© sauvegardÃ©es."}))}catch{K({title:"Erreur",description:"Impossible de mettre Ã  jour le prospect.",variant:"destructive"})}};return ae&&ae.id?e.jsx(et.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(oa,{name:"Fiche Prospect",children:e.jsx(Lr,{prospect:ae,onBack:We,onUpdate:ye,onEditingChange:q})})}):S?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(nt,{className:"w-4 h-4"}),e.jsxs("span",{children:[ke.length," prospect",ke.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:E,className:"relative inline-block text-left",children:[e.jsxs(be,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>F(d=>!d),children:[e.jsx("span",{children:ve}),e.jsx(Tt,{className:"h-4 w-4"})]}),N&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[G.map(d=>{var A;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:$.includes(d),onChange:()=>Ye(d),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((A=P[d])==null?void 0:A.title)||d})]},d)}),$.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>D([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la sÃ©lection"})]})]})})]}),e.jsxs(ca,{open:O,onOpenChange:p,children:[e.jsx(da,{asChild:!0,children:e.jsxs(be,{variant:"outline",role:"combobox","aria-expanded":O,className:"w-[230px] justify-between",children:[e.jsx(nt,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:y==="all"?"Tous les utilisateurs":((ie=ee[y])==null?void 0:ie.name)||"Utilisateur"}),e.jsx(Tt,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(ua,{className:"w-[200px] p-0",children:e.jsxs(ma,{children:[e.jsx(ga,{placeholder:"Rechercher..."}),e.jsxs(xa,{children:[e.jsx(pa,{children:"Aucun utilisateur"}),e.jsx(ha,{children:Ee.map(d=>e.jsxs(fa,{value:d.label,onSelect:()=>{b(d.value),p(!1)},children:[e.jsx(ht,{className:at("mr-2 h-4 w-4",y===d.value?"opacity-100":"opacity-0")}),d.label]},d.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ba,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Xe,{type:"text",placeholder:"Rechercher un prospect...",value:w,onChange:d=>o(d.target.value),className:"pl-9 pr-4"}),w&&e.jsx("button",{onClick:()=>o(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"Ã—"})]}),e.jsxs(be,{onClick:()=>f(!0),children:[e.jsx(Lt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Fe.map(d=>e.jsxs(et.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${d.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:d.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(Te[d.id]||[]).filter(A=>{if($.length===0)return!0;const{projectType:X}=A;return $.some(re=>re.toUpperCase()===(X||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const A=(Te[d.id]||[]).filter(s=>{if($.length===0)return!0;const{projectType:x}=s;return $.some(c=>c.toUpperCase()===(x||"").toUpperCase())}),X=ne[d.id]||cs,re=A.slice(0,X),Ne=A.length>X,Re=A.length-X;return e.jsxs(e.Fragment,{children:[re.map((s,x)=>{var De;const{prospect:c,projectType:T,activeStep:Y}=s,B=`${c.id}-${T||"default"}-${d.id}-${x}`,J=c.projectType||c.tags&&c.tags[0]||"Projet",H=T&&((De=P[T])!=null&&De.title)?P[T].title:J,te=(Y==null?void 0:Y.label)||(Y==null?void 0:Y.name)||d.name,se=d.color||"bg-blue-100 text-blue-700",Ce=`${c.id}-${T||H}-${d.id}-${x}`;return e.jsx(et.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(gr,{prospect:{...c,_projectContext:{projectType:T||J,projectTitle:H,stepLabel:te,projectColor:se}},onClick:()=>$e(c,T||c.projectType||(Array.isArray(c.tags)?c.tags[0]:J)),compact:!0,sortableId:Ce,projectsData:P})},B)}),Ne&&e.jsxs("button",{onClick:()=>Ke(d.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(Re,ds)," de plus (",Re," restants)"]}),A.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(nt,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},d.id))})})}),e.jsx(ja,{open:h,onOpenChange:f,onAddProspect:ze}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(d=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},d))})})})]})};export{Ur as default};
