import{c as Dt,r as n,R as ht,u as ks,j as e,m as Qe,C as ot,l as v,s as je,a as ut,b as Be,d as As,e as st,f as Es,g as Ct,h as mt,B as be,P as Tt,i as Ve,D as bt,k as jt,X as Je,n as yt,o as Nt,U as tt,p as at,M as vt,q as Rt,t as wt,S as Ft,v as $t,w as Mt,x as Lt,y as $e,z as Ot,A as rs,E as ns,T as zt,F as is,G as ls,H as os,I as cs,J as ds,K as us,L as ms,N as G,O as Le,Q as Ps,V as gs,W as Ds,Y as xs,Z as Bt,_ as Ts,$ as Rs,a0 as Ue,a1 as Fs,a2 as $s,a3 as Ms,a4 as ct,a5 as Ls,a6 as hs,a7 as ps,a8 as Os,a9 as zs,aa as Me,ab as He,ac as gt,ad as fs,ae as bs,af as qs,ag as Vs,ah as Bs,ai as Hs,aj as Ws,ak as Gs,al as Js,am as Xs,an as Ys,ao as Ks,ap as Qs,aq as Zs,ar as Us,as as ea,at as ta,au as sa,av as aa,aw as ra,ax as na}from"./index-1b94575a.js";import{u as rt,A as js,C as ia}from"./Agenda-bb9ff687.js";import{S as la}from"./SearchableSelect-61aa2d27.js";import{u as oa}from"./useSupabaseProjectStepsStatus-f3f5d337.js";import{u as ys}from"./useSupabaseProjectFiles-64b19dad.js";import{F as ca,a as da,P as ua,b as ma,e as ga,u as Ns,S as qt,c as xa}from"./useSupabaseWorkflowModuleTemplates-6db447de.js";import{f as Ze,V as ha}from"./index-13659cef.js";import{D as pt}from"./download-38822198.js";import{i as pa}from"./workflowV2Config-f801420c.js";import{P as ft}from"./pen-square-17cdf69b.js";import{P as Ht}from"./paperclip-25f309cd.js";import"./external-link-ca9ac2be.js";const fa=Dt("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),ba=Dt("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),ja=Dt("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function ya(){for(var t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return n.useMemo(()=>r=>{s.forEach(m=>m(r))},s)}const Na=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function va(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function wa(t){return"nodeType"in t}function vs(t){var s,a;return t?va(t)?t:wa(t)&&(s=(a=t.ownerDocument)==null?void 0:a.defaultView)!=null?s:window:window}const St=Na?n.useLayoutEffect:n.useEffect;function ws(t){const s=n.useRef(t);return St(()=>{s.current=t}),n.useCallback(function(){for(var a=arguments.length,r=new Array(a),m=0;m<a;m++)r[m]=arguments[m];return s.current==null?void 0:s.current(...r)},[])}function kt(t,s){s===void 0&&(s=[t]);const a=n.useRef(t);return St(()=>{a.current!==t&&(a.current=t)},s),a}function At(t){const s=ws(t),a=n.useRef(null),r=n.useCallback(m=>{m!==a.current&&(s==null||s(m,a.current)),a.current=m},[]);return[a,r]}let It={};function Ss(t,s){return n.useMemo(()=>{if(s)return s;const a=It[t]==null?0:It[t]+1;return It[t]=a,t+"-"+a},[t,s])}function Sa(t){if(!t)return!1;const{KeyboardEvent:s}=vs(t.target);return s&&t instanceof s}const dt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:a}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:a}=t;return"scaleX("+s+") scaleY("+a+")"}},Transform:{toString(t){if(t)return[dt.Translate.toString(t),dt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:a,easing:r}=t;return s+" "+a+"ms "+r}}});var lt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(lt||(lt={}));function Wt(){}const _a=Object.freeze({x:0,y:0});function Ia(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Ca(t,s,a){const r=Ia(s);if(!r)return t;const{scaleX:m,scaleY:g,x,y:h}=r,w=t.left-x-(1-m)*parseFloat(a),I=t.top-h-(1-g)*parseFloat(a.slice(a.indexOf(" ")+1)),y=m?t.width/m:t.width,f=g?t.height/g:t.height;return{width:y,height:f,top:I,right:w+y,bottom:I+f,left:w}}const ka={ignoreTransform:!1};function Vt(t,s){s===void 0&&(s=ka);let a=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:I,transformOrigin:y}=vs(t).getComputedStyle(t);I&&(a=Ca(a,I,y))}const{top:r,left:m,width:g,height:x,bottom:h,right:w}=a;return{top:r,left:m,width:g,height:x,bottom:h,right:w}}function Gt(t){return Vt(t,{ignoreTransform:!0})}var et;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(et||(et={}));var Jt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Jt||(Jt={}));var Fe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Fe||(Fe={}));Fe.Space,Fe.Enter,Fe.Esc,Fe.Space,Fe.Enter,Fe.Tab;var Xt;(function(t){t[t.RightClick=2]="RightClick"})(Xt||(Xt={}));var Yt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Yt||(Yt={}));var Kt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Kt||(Kt={}));et.Backward+"",et.Forward+"",et.Backward+"",et.Forward+"";var Et;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(Et||(Et={}));var Pt;(function(t){t.Optimized="optimized"})(Pt||(Pt={}));function Aa(t){let{callback:s,disabled:a}=t;const r=ws(s),m=n.useMemo(()=>{if(a||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:g}=window;return new g(r)},[a]);return n.useEffect(()=>()=>m==null?void 0:m.disconnect(),[m]),m}function Ea(t,s){return n.useMemo(()=>t.reduce((a,r)=>{let{eventName:m,handler:g}=r;return a[m]=x=>{g(x,s)},a},{}),[t,s])}Et.WhileDragging,Pt.Optimized;const Pa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Wt,draggableNodes:new Map,over:null,measureDroppableContainers:Wt},_s=n.createContext(Pa),Da=n.createContext({..._a,scaleX:1,scaleY:1});var Qt;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Qt||(Qt={}));const Ta=n.createContext(null),Zt="button",Ra="Draggable";function Fa(t){let{id:s,data:a,disabled:r=!1,attributes:m}=t;const g=Ss(Ra),{activators:x,activatorEvent:h,active:w,activeNodeRect:I,ariaDescribedById:y,draggableNodes:f,over:L}=n.useContext(_s),{role:p=Zt,roleDescription:$="draggable",tabIndex:D=0}=m??{},j=(w==null?void 0:w.id)===s,C=n.useContext(j?Da:Ta),[P,N]=At(),[i,d]=At(),T=Ea(x,s),B=kt(a);St(()=>(f.set(s,{id:s,key:g,node:P,activatorNode:i,data:B}),()=>{const M=f.get(s);M&&M.key===g&&f.delete(s)}),[f,s]);const S=n.useMemo(()=>({role:p,tabIndex:D,"aria-disabled":r,"aria-pressed":j&&p===Zt?!0:void 0,"aria-roledescription":$,"aria-describedby":y.draggable}),[r,p,D,j,$,y.draggable]);return{active:w,activatorEvent:h,activeNodeRect:I,attributes:S,isDragging:j,listeners:r?void 0:T,node:P,over:L,setNodeRef:N,setActivatorNodeRef:d,transform:C}}const $a="Droppable",Ma={timeout:25};function La(t){let{data:s,disabled:a=!1,id:r,resizeObserverConfig:m}=t;const g=Ss($a),{active:x,dispatch:h,over:w,measureDroppableContainers:I}=n.useContext(_s),y=n.useRef({disabled:a}),f=n.useRef(!1),L=n.useRef(null),p=n.useRef(null),{disabled:$,updateMeasurementsFor:D,timeout:j}={...Ma,...m},C=kt(D??r),P=n.useCallback(()=>{if(!f.current){f.current=!0;return}p.current!=null&&clearTimeout(p.current),p.current=setTimeout(()=>{I(Array.isArray(C.current)?C.current:[C.current]),p.current=null},j)},[j]),N=Aa({callback:P,disabled:$||!x}),i=n.useCallback((S,M)=>{N&&(M&&(N.unobserve(M),f.current=!1),S&&N.observe(S))},[N]),[d,T]=At(i),B=kt(s);return n.useEffect(()=>{!N||!d.current||(N.disconnect(),f.current=!1,N.observe(d.current))},[d,N]),n.useEffect(()=>(h({type:lt.RegisterDroppable,element:{id:r,key:g,disabled:a,node:d,rect:L,data:B}}),()=>h({type:lt.UnregisterDroppable,key:g,id:r})),[r]),n.useEffect(()=>{a!==y.current.disabled&&(h({type:lt.SetDroppableDisabled,id:r,key:g,disabled:a}),y.current.disabled=a)},[r,g,a,h]),{active:x,rect:L,isOver:(w==null?void 0:w.id)===r,node:d,over:w,setNodeRef:T}}function Is(t,s,a){const r=t.slice();return r.splice(a<0?r.length+a:a,0,r.splice(s,1)[0]),r}function xt(t){return t!==null&&t>=0}const Oa=t=>{let{rects:s,activeIndex:a,overIndex:r,index:m}=t;const g=Is(s,r,a),x=s[m],h=g[m];return!h||!x?null:{x:h.left-x.left,y:h.top-x.top,scaleX:h.width/x.width,scaleY:h.height/x.height}},za="Sortable",qa=ht.createContext({activeIndex:-1,containerId:za,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Oa,disabled:{draggable:!1,droppable:!1}}),Va=t=>{let{id:s,items:a,activeIndex:r,overIndex:m}=t;return Is(a,r,m).indexOf(s)},Ba=t=>{let{containerId:s,isSorting:a,wasDragging:r,index:m,items:g,newIndex:x,previousItems:h,previousContainerId:w,transition:I}=t;return!I||!r||h!==g&&m===x?!1:a?!0:x!==m&&s===w},Ha={duration:200,easing:"ease"},Cs="transform",Wa=dt.Transition.toString({property:Cs,duration:0,easing:"linear"}),Ga={roleDescription:"sortable"};function Ja(t){let{disabled:s,index:a,node:r,rect:m}=t;const[g,x]=n.useState(null),h=n.useRef(a);return St(()=>{if(!s&&a!==h.current&&r.current){const w=m.current;if(w){const I=Vt(r.current,{ignoreTransform:!0}),y={x:w.left-I.left,y:w.top-I.top,scaleX:w.width/I.width,scaleY:w.height/I.height};(y.x||y.y)&&x(y)}}a!==h.current&&(h.current=a)},[s,a,r,m]),n.useEffect(()=>{g&&x(null)},[g]),g}function Xa(t){let{animateLayoutChanges:s=Ba,attributes:a,disabled:r,data:m,getNewIndex:g=Va,id:x,strategy:h,resizeObserverConfig:w,transition:I=Ha}=t;const{items:y,containerId:f,activeIndex:L,disabled:p,disableTransforms:$,sortedRects:D,overIndex:j,useDragOverlay:C,strategy:P}=n.useContext(qa),N=Ya(r,p),i=y.indexOf(x),d=n.useMemo(()=>({sortable:{containerId:f,index:i,items:y},...m}),[f,m,i,y]),T=n.useMemo(()=>y.slice(y.indexOf(x)),[y,x]),{rect:B,node:S,isOver:M,setNodeRef:ne}=La({id:x,data:d,disabled:N.droppable,resizeObserverConfig:{updateMeasurementsFor:T,...w}}),{active:ce,activatorEvent:ue,activeNodeRect:H,attributes:xe,setNodeRef:K,listeners:k,isDragging:J,over:he,setActivatorNodeRef:W,transform:o}=Fa({id:x,data:d,attributes:{...Ga,...a},disabled:N.draggable}),F=ya(ne,K),z=!!ce,ae=z&&!$&&xt(L)&&xt(j),R=!C&&J,q=R&&ae?o:null,le=ae?q??(h??P)({rects:D,activeNodeRect:H,activeIndex:L,overIndex:j,index:i}):null,U=xt(L)&&xt(j)?g({id:x,items:y,activeIndex:L,overIndex:j}):i,Q=ce==null?void 0:ce.id,Z=n.useRef({activeId:Q,items:y,newIndex:U,containerId:f}),te=y!==Z.current.items,ge=s({active:ce,containerId:f,isDragging:J,isSorting:z,id:x,index:i,items:y,newIndex:Z.current.newIndex,previousItems:Z.current.items,previousContainerId:Z.current.containerId,transition:I,wasDragging:Z.current.activeId!=null}),me=Ja({disabled:!ge,index:i,node:S,rect:B});return n.useEffect(()=>{z&&Z.current.newIndex!==U&&(Z.current.newIndex=U),f!==Z.current.containerId&&(Z.current.containerId=f),y!==Z.current.items&&(Z.current.items=y)},[z,U,f,y]),n.useEffect(()=>{if(Q===Z.current.activeId)return;if(Q&&!Z.current.activeId){Z.current.activeId=Q;return}const pe=setTimeout(()=>{Z.current.activeId=Q},50);return()=>clearTimeout(pe)},[Q]),{active:ce,activeIndex:L,attributes:xe,data:d,rect:B,index:i,newIndex:U,items:y,isOver:M,isSorting:z,isDragging:J,listeners:k,node:S,overIndex:j,over:he,setNodeRef:F,setActivatorNodeRef:W,setDroppableNodeRef:ne,setDraggableNodeRef:K,transform:me??le,transition:Ie()};function Ie(){if(me||te&&Z.current.newIndex===i)return Wa;if(!(R&&!Sa(ue)||!I)&&(z||ge))return dt.Transition.toString({...I,property:Cs})}}function Ya(t,s){var a,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(a=t==null?void 0:t.draggable)!=null?a:s.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:s.droppable}}Fe.Down,Fe.Right,Fe.Up,Fe.Left;const Ka=t=>(t||"").toString().trim().toUpperCase(),Qa=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const a=t.prospect,r=s.prospect;if(a.id!==r.id||a.name!==r.name||a.hasAppointment!==r.hasAppointment||a.updatedAt!==r.updatedAt)return!1;const m=a._projectContext||{},g=r._projectContext||{};if(m.projectType!==g.projectType||m.projectTitle!==g.projectTitle||m.stepLabel!==g.stepLabel)return!1;const x=a.tags||[],h=r.tags||[];return!(x.length!==h.length||x.some((w,I)=>w!==h[I])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},Za=({prospect:t,onClick:s,sortableId:a,projectsData:r={}})=>{var j,C,P,N,i,d,T;ks();const m=Array.isArray(t.tags)?t.tags:[],g=((j=t._projectContext)==null?void 0:j.projectTitle)||((C=t._projectContext)==null?void 0:C.projectType)||null,x=((P=t._projectContext)==null?void 0:P.projectType)||null;(N=t._projectContext)!=null&&N.stepLabel;const h=g?Ka(g):null,w=a||(h?`${t.id}-${h}`:`${t.id}-${((i=t._projectContext)==null?void 0:i.projectType)||"default"}`),{attributes:I,listeners:y,setNodeRef:f,transform:L,transition:p,isDragging:$}=Xa({id:w,data:{prospect:t}}),D={transform:dt.Transform.toString(L),transition:p,zIndex:$?10:"auto",opacity:$?.8:1};return e.jsx("div",{ref:f,style:D,...I,...y,children:e.jsxs(Qe.div,{layoutId:`prospect-card-${w}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(ot,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[g&&m.includes(((d=t._projectContext)==null?void 0:d.projectType)||g)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((T=r[x])==null?void 0:T.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:g})}),m.filter(B=>B!==x).map(B=>{var ne,ce;const S=((ne=r[B])==null?void 0:ne.title)||B,M=((ce=r[B])==null?void 0:ce.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:S},B)})]})]})})},Ua=n.memo(Za,Qa);function er({prospectId:t,projectType:s,currentStepIndex:a,prompt:r,sendNextAction:m}){const g=n.useRef(new Set);n.useRef(!1),n.useEffect(()=>{if(!t||!s||a===void 0||!r)return;v.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:a,promptName:r==null?void 0:r.name});const x=je.channel(`workflow-forms-${t}-${s}-${a}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async h=>{const w=h.new;v.info("üîç Form panel UPDATE re√ßu",{panelId:w.id,prospectId:w.prospect_id,projectType:w.project_type,status:w.status,actionId:w.action_id,expectedProjectType:s});const I=w.project_type===s,y=w.status==="approved",f=!!w.action_id;if(I&&y&&f){const L=`${t}-${s}-${a}-${w.action_id}`;if(g.current.has(L)){v.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:L});return}g.current.add(L),v.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:w.form_id,actionId:w.action_id}),setTimeout(()=>{v.info("üöÄ Envoi action suivante",{completedActionId:w.action_id}),m(w.action_id)},2e3)}}).subscribe();return()=>{je.removeChannel(x)}},[t,s,a,r,m])}function tr({projectType:t,prospectId:s,enabled:a=!0}){const[r,m]=n.useState([]),[g,x]=n.useState(!1),[h,w]=n.useState(!1),[I,y]=n.useState(null),{organizationId:f}=ut(),L=n.useCallback(async()=>{if(!(!t||!a))try{x(!0),y(null);let j=je.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(j=j.eq("prospect_id",s));const{data:C,error:P}=await j;if(P)throw P;m(C||[])}catch(j){v.error("Erreur r√©cup√©ration project notes:",{error:j.message}),y(j.message)}finally{x(!1)}},[t,s,a]);n.useEffect(()=>{if(!t||!a)return;L();const j=je.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},C=>{m(P=>{const{eventType:N,new:i,old:d}=C;return N==="INSERT"?[i,...P]:N==="UPDATE"?P.map(T=>T.id===i.id?i:T):N==="DELETE"?P.filter(T=>T.id!==d.id):P})}).subscribe();return()=>{je.removeChannel(j)}},[t,a,L]);const p=n.useCallback(async({content:j,createdBy:C,createdByName:P})=>{if(!(!t||!(j!=null&&j.trim())))try{if(w(!0),y(null),!f)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:N,error:i}=await je.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:j.trim(),created_by:C||null,created_by_name:P||null,organization_id:f}]).select().single();if(i)throw i;return m(d=>[N,...d]),N}catch(N){throw v.error("Erreur ajout project note:",{error:N.message}),y(N.message),N}finally{w(!1)}},[t,s,f]),$=n.useCallback(async(j,{content:C})=>{if(!(!j||!(C!=null&&C.trim())))try{w(!0),y(null);const{data:P,error:N}=await je.from("project_notes").update({content:C.trim(),updated_at:new Date().toISOString()}).eq("id",j).select().single();if(N)throw N;return m(i=>i.map(d=>d.id===j?P:d)),P}catch(P){throw v.error("Erreur update project note:",{error:P.message}),y(P.message),P}finally{w(!1)}},[]),D=n.useCallback(async j=>{if(j)try{w(!0),y(null);const{error:C}=await je.from("project_notes").delete().eq("id",j);if(C)throw C;m(P=>P.filter(N=>N.id!==j))}catch(C){throw v.error("Erreur suppression project note:",{error:C.message}),y(C.message),C}finally{w(!1)}},[]);return{notes:r,loading:g,saving:h,error:I,addNote:p,updateNote:$,deleteNote:D,refetch:L}}function sr({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r}){var i;const{activeAdminUser:m}=Be(),g=r||m,[x,h]=n.useState(""),[w,I]=n.useState(!1),{getTemplateByType:y}=As(),f=y(t),L=(f==null?void 0:f.title)||t,{notes:p,loading:$,saving:D,error:j,addNote:C}=tr({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:P}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:g}),N=async()=>{if(x.trim())try{const d=await C({content:x,createdBy:(g==null?void 0:g.id)||(a==null?void 0:a.id),createdByName:(g==null?void 0:g.name)||(g==null?void 0:g.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)});d&&P&&await P({event_type:"note",title:"Note ajout√©e",description:d.content||x.trim(),metadata:{source:"notes_tab"},createdBy:(g==null?void 0:g.id)||(a==null?void 0:a.id),createdByName:(g==null?void 0:g.name)||(g==null?void 0:g.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),h("")}catch(d){v.error(d)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${L}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:x,onChange:d=>h(d.target.value),disabled:!t||D}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:N,disabled:!x.trim()||!t||D,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:D?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),j&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",j]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),p&&p.length>3&&e.jsx("button",{onClick:()=>I(!w),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:w?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx(Es,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",p.length,")"]}),e.jsx(Ct,{className:"w-4 h-4"})]})})]}),$&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!$&&(p==null?void 0:p.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(i=w?p:p==null?void 0:p.slice(0,3))==null?void 0:i.map(d=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:d.created_by_name||d.created_by?`Par ${d.created_by_name||d.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:d.created_at&&new Date(d.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:d.content})]},d.id))})]})]})}const ar=({prospectId:t,projectType:s,activeAdminUser:a})=>{const{projectsData:r,appointments:m,updateAppointment:g,deleteAppointment:x,addAppointment:h,addCall:w,addTask:I,updateCall:y,updateTask:f,prospects:L}=Be(),[p,$]=n.useState(!1),[D,j]=n.useState(null),[C,P]=n.useState(null),{users:N}=mt(),{supabaseUserId:i}=rt(),{history:d,loading:T}=st({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),B=n.useMemo(()=>!d||d.length===0?[]:d.filter(k=>k.event_type==="activity").sort((k,J)=>new Date(J.created_at)-new Date(k.created_at)),[d]),S=n.useMemo(()=>{const k={};return B.forEach(he=>{var o;const W=(o=he.metadata)==null?void 0:o.appointment_id;W&&(k[W]||(k[W]=[]),k[W].push(he))}),Object.entries(k).map(([he,W])=>{var z;const F=W.sort((ae,R)=>new Date(R.created_at)-new Date(ae.created_at))[0];return{...F,currentStatus:((z=F.metadata)==null?void 0:z.status)||(F.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[B]),M=n.useMemo(()=>S?S.filter(k=>k.currentStatus==="pending"):[],[S]),ne=n.useMemo(()=>S?S.filter(k=>k.currentStatus!=="pending"):[],[S]),ce=k=>{switch((k==null?void 0:k.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(ot,{className:"h-4 w-4"});case"virtual":return e.jsx(ha,{className:"h-4 w-4"});case"call":return e.jsx(at,{className:"h-4 w-4"});case"task":return e.jsx(ia,{className:"h-4 w-4"});default:return e.jsx(ot,{className:"h-4 w-4"})}},ue=k=>{const J=(k==null?void 0:k.activity_type)||"appointment",he=k==null?void 0:k.status;if(he==="effectue"||he==="completed")return"text-green-600 bg-green-50";if(he==="annule")return"text-red-600 bg-red-50";if(he==="reporte")return"text-yellow-600 bg-yellow-50";switch(J){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},H=k=>{var J;return!m||!((J=k.metadata)!=null&&J.appointment_id)?null:m.find(he=>he.id===k.metadata.appointment_id)},xe=k=>{const J=H(k);J&&j(J)},K=k=>{j(null),P({...k,type:k.type}),$(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(be,{onClick:()=>{$(!p)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Tt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),p&&e.jsx(js,{open:p,onOpenChange:k=>{k||P(null),$(k)},initialData:C||{contactId:t,projectId:s},defaultAssignedUserId:i,addAppointment:h,addCall:w,addTask:I,updateAppointment:g,updateCall:y,updateTask:f,prospects:L||[],users:N||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),T?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(k=>{const J=H(k),he=(J==null?void 0:J.title)||k.title||"Activit√©",W=J!=null&&J.start?new Date(J.start):new Date(k.created_at);return e.jsxs("div",{onClick:()=>xe(k),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${ue(k.metadata)}`,children:ce(k.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:he}),(J==null?void 0:J.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:J.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Ze(W,"d MMM '√†' HH:mm",{locale:Ve})})]})]},k.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",ne.length,")"]}),T?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ne.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:ne.map(k=>{const J=H(k),he=(J==null?void 0:J.title)||k.title||"Activit√©",W=J!=null&&J.start?new Date(J.start):new Date(k.created_at),o={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[k.currentStatus]||k.currentStatus;return e.jsxs("div",{onClick:()=>xe(k),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${ue(k.metadata)}`,children:ce(k.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:he}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[o," ‚Ä¢ ",Ze(W,"d MMM yyyy '√†' HH:mm",{locale:Ve})]})]})]},k.id)})})]}),D&&e.jsx(rr,{event:D,onClose:()=>j(null),onReport:()=>{},onEdit:K,prospects:L,supabaseUsers:N,updateAppointment:g,deleteAppointment:x,projectsData:r})]})},rr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:m,supabaseUsers:g,updateAppointment:x,deleteAppointment:h,projectsData:w})=>{var N;const[I,y]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!m||!g||!x||!h||!w)return null;const f=m.find(i=>i.id===t.contactId),L=g.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(f?g.find(i=>i.user_id===f.ownerId):null),p=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",$=(i,d,T={})=>{try{const B=new Date(i);return isNaN(B.getTime())?"Date invalide":Ze(B,d,T)}catch{return"Date invalide"}},D=i=>{y(i),x(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},j=()=>{h(t.id),G({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},C=i=>{if(!f){G({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":f.phone&&(window.location.href=`tel:${f.phone}`);break;case"Mail":f.email&&(window.location.href=`mailto:${f.email}`);break;case"WhatsApp":if(f.phone){let d=f.phone.replace(/\D/g,"");d.startsWith("0")&&(d=`33${d.substring(1)}`);const T=encodeURIComponent("Bonjour");window.open(`https://wa.me/${d}?text=${T}`,"_blank")}break;case"GPS":if(f.address){const d=encodeURIComponent(f.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${d}`:window.open(`https://www.google.com/maps/search/?api=1&query=${d}`,"_blank")}break;default:G({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},P={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p($(t.start,"eeee d MMMM",{locale:Ve}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Ve})," - ",$(t.end,"HH:mm",{locale:Ve})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),f&&e.jsxs("p",{className:"text-sm",children:[f.name," (Client)"]}),L&&e.jsxs("p",{className:"text-sm",children:[L.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Rt,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:i,label:d})=>e.jsxs("button",{onClick:()=>C(d),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:d})]},d))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${P[I].color}`,children:e.jsxs(Ft,{onValueChange:D,value:I,children:[e.jsx($t,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Mt,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx($e,{value:"effectue",children:"Effectu√©"}),e.jsx($e,{value:"annule",children:"Annul√©"}),e.jsx($e,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((N=w[t.projectId])==null?void 0:N.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(f==null?void 0:f.name)||"N/A"})]})]})]}),e.jsxs(Ot,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(rs,{children:[e.jsx(ns,{asChild:!0,children:e.jsxs(be,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsx(os,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(cs,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ds,{children:[e.jsx(us,{children:"Annuler"}),e.jsx(ms,{onClick:j,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(be,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})},nr=({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r})=>{const{activeAdminUser:m}=Be(),{organizationId:g}=ut(),x=r||m,[h,w]=n.useState(null),{files:I,loading:y,uploading:f,deleting:L,error:p,uploadFile:$,deleteFile:D}=ys({projectType:t,prospectId:s,organizationId:g,enabled:!!t}),{addHistoryEvent:j}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:x}),C=async S=>{const M=Array.from(S.target.files||[]);if(M.length!==0)try{const ne=M.map(async ce=>{w(ce);const ue=await $({file:ce,uploadedBy:a==null?void 0:a.id});return ue&&j&&await j({event_type:"file",title:"Fichier ajout√©",description:ue.file_name,metadata:{size:ue.file_size,type:ue.file_type,storage_path:ue.storage_path},createdBy:(x==null?void 0:x.id)||(a==null?void 0:a.id),createdByName:(x==null?void 0:x.name)||(x==null?void 0:x.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),ue});await Promise.all(ne),w(null),S.target.value=""}catch(ne){v.error("Error uploading files:",ne),w(null)}},P=async S=>{try{const{data:M,error:ne}=await je.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(ne){v.error("Error creating signed URL:",ne);return}const ue=await(await fetch(M.signedUrl)).blob(),H=window.URL.createObjectURL(ue),xe=document.createElement("a");xe.href=H,xe.download=S.file_name,document.body.appendChild(xe),xe.click(),document.body.removeChild(xe),window.URL.revokeObjectURL(H)}catch(M){v.error("Error downloading file:",M)}},N=async S=>{try{v.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:S.storage_path});const{data:M,error:ne}=await je.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(ne){v.error("Error creating signed URL:",ne);return}v.debug("‚úÖ Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){v.error("Error viewing file:",M)}},i=async S=>{if(confirm(`Supprimer le fichier "${S.file_name}" ?`))try{await D(S.id,S.storage_path)}catch(M){v.error("Error deleting file:",M)}},d=S=>S!=null&&S.startsWith("image/")?e.jsx(Ds,{className:"h-5 w-5 text-blue-500"}):S==="application/pdf"?e.jsx(Le,{className:"h-5 w-5 text-red-500"}):e.jsx(ca,{className:"h-5 w-5 text-gray-500"}),T=S=>S?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(S)):"",B=S=>S?S<1024?`${S} o`:S<1024*1024?`${(S/1024).toFixed(1)} Ko`:`${(S/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Ps,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:f?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:C,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:f,multiple:!0})]})}),p&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:p}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",I.length,")"]}),y?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):I.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:I.map(S=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:d(S.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[S.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:S.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:S.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:S.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[B(S.file_size)," ‚Ä¢ ",T(S.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[S.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>N(S),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:L,children:e.jsx(gs,{className:"h-4 w-4"})}),S.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>P(S),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:L,children:e.jsx(pt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>i(S),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:L,children:e.jsx(zt,{className:"h-4 w-4"})})]})]},S.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},ir=({prospectId:t,projectType:s,activeAdminUser:a})=>{const[r,m]=n.useState("notes"),{supabaseUserId:g}=rt(),x=[{id:"notes",label:"Notes",icon:Le},{id:"activity",label:"Activit√©",icon:fa},{id:"files",label:"Fichiers",icon:da}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:x.map(({id:h,label:w,icon:I})=>e.jsxs("button",{onClick:()=>m(h),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===h?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx("span",{children:w})]},h))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(sr,{prospectId:t,projectType:s,currentUser:{id:g},activeAdminUser:a}),r==="activity"&&e.jsx(ar,{prospectId:t,projectType:s,activeAdminUser:a}),r==="files"&&e.jsx(nr,{prospectId:t,projectType:s,currentUser:{id:g},activeAdminUser:a})]})]})},lr=({projectType:t,prospectId:s,activeAdminUser:a})=>{const{history:r,loading:m,error:g}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:a});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),m&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),g&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",g]}),!m&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(x=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:x.title||x.event_type}),x.description&&e.jsx("p",{className:"text-xs text-gray-600",children:x.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(x.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(x.created_by_name||x.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",x.created_by_name||x.created_by]})]})]})]})]},x.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},or=({children:t,prospectId:s,projectType:a,currentStep:r,statusConfig:m,activeAdminUser:g})=>{var x,h,w;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(Qe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((x=m[r.status])==null?void 0:x.iconOnly)||m.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((h=m[r.status])==null?void 0:h.badge)||m.pending.badge}`,children:((w=m[r.status])==null?void 0:w.label)||m.pending.label})]}),t]},r.name),!r&&!a&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Le,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),a&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ir,{prospectId:s,projectType:a,activeAdminUser:g}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(lr,{prospectId:s,projectType:a,activeAdminUser:g})]})]})},cr={CLIENT:ct,COMMERCIAL:Ls,PARTENAIRE:tt},dr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},ur={FORM:Le,SIGNATURE:ua},mr={FORM:"Formulaire",SIGNATURE:"Signature"},gr=({isOpen:t,onClose:s,prospectId:a,projectType:r,moduleId:m,moduleName:g,moduleConfig:x,context:h={},availableForms:w=[],availableTemplates:I=[]})=>{var z,ae;const[y,f]=n.useState(null),[L,p]=n.useState(!1),[$,D]=n.useState(null),[j,C]=n.useState(!1),P=pa(),N=n.useMemo(()=>x?x.actions&&x.actions.length>0?x.actions:x.actionConfig?[{order:1,status:"pending",actionConfig:x.actionConfig}]:[]:[],[x]),[i,d]=n.useState({}),[T,B]=n.useState(!1);n.useEffect(()=>{if(!t||!a||!m||N.length<=1){d({});return}(async()=>{B(!0);try{const q=N.map((Q,Z)=>`v2-${m}-action-${Z}`),{data:u,error:le}=await je.from("client_form_panels").select("id, action_id, status").eq("prospect_id",a).eq("project_type",r).in("action_id",q),U={};if(!le&&u&&u.length>0){for(const Q of u)Q.action_id&&(Q.status==="approved"||Q.status==="submitted")&&(U[Q.action_id]=Q.status);console.log("[V2 Robot] Action statuses by action_id:",U)}else{const{data:Q}=await je.from("client_form_panels").select("id, step_name, status").eq("prospect_id",a).eq("project_type",r).in("status",["approved","submitted"]);if(Q){const Z=Q.filter(te=>!te.step_name||te.step_name===g||te.step_name===m);Z.forEach((te,ge)=>{ge<N.length&&(U[`v2-${m}-action-${ge}`]=te.status)}),console.log("[V2 Robot] Fallback legacy statuses:",U,"from",Z.length,"panels")}}d(U)}catch(q){console.error("[V2 Robot] Error fetching action statuses:",q)}finally{B(!1)}})()},[t,a,r,g,m,N.length]);const S=n.useMemo(()=>N.map((R,q)=>{const u=`v2-${m}-action-${q}`,le=i[u];return{...R,actionId:u,realStatus:le==="approved"?"validated":le==="submitted"?"submitted":"pending"}}),[N,i,m]),[M,ne]=n.useState(0);n.useEffect(()=>{if(t&&S.length>0&&!T){const R=S.findIndex(q=>q.realStatus!=="validated");ne(R>=0?R:S.length-1)}},[t,S,T]);const ce=S[M]||null,ue=S.length,H=ue>1,xe=n.useMemo(()=>{if(!ce)return!1;const R=ce.actionConfig;return!(!R||!R.actionType||!(Array.isArray(R.targetAudience)?R.targetAudience.length>0:!!R.targetAudience))},[ce]),K=(ce==null?void 0:ce.actionConfig)||null,k=()=>{if(!xe||!K){G({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:K.allowedFormIds,currentActionFull:ce,allActions:S.map((R,q)=>{var u;return{index:q,formIds:(u=R.actionConfig)==null?void 0:u.allowedFormIds}})});try{const R=Array.isArray(K.targetAudience)?K.targetAudience[0]:K.targetAudience,q=ma({moduleId:m,moduleName:g,projectType:r,prospectId:a,actionIndex:M,actionConfig:{...K,targetAudience:R||"CLIENT"},message:""});f(q),D(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",q)}catch(R){console.error("[V2 Robot] Erreur g√©n√©ration:",R),G({title:"Erreur",description:R.message,variant:"destructive"})}},J=async()=>{if(!y){G({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!P){G({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}p(!0),D(null);try{const R={...y,_meta:{...y._meta,isSimulation:!1}},q=await ga(R,h);D(q),q.success?(G({title:"‚úÖ Action ex√©cut√©e",description:q.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):G({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:q.message,variant:"destructive"})}catch(R){console.error("[V2 Robot] Erreur ex√©cution:",R),D({success:!1,status:"error",message:R.message}),G({title:"Erreur",description:R.message,variant:"destructive"})}finally{p(!1)}},he=()=>{y&&(navigator.clipboard.writeText(JSON.stringify(y,null,2)),G({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},W=ht.useRef(M);n.useEffect(()=>{const R=W.current!==M;if(W.current=M,R&&(f(null),D(null)),t&&xe&&!T&&(!y||R)){const q=setTimeout(()=>{k()},R?50:0);return()=>clearTimeout(q)}},[t,xe,T,M]),n.useEffect(()=>{t||(f(null),D(null),C(!1),ne(0))},[t]);const o=R=>{const q=w.find(u=>u.id===R);return(q==null?void 0:q.name)||R},F=R=>{const q=I.find(u=>u.id===R);return(q==null?void 0:q.name)||R};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(xs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[g||m,H&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",M+1,"/",ue]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Je,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[H&&xe&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",M+1," sur ",ue]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," termin√©e",M>1?"s":"",")"]})]}),!xe&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Bt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>{G({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Ts,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),xe&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:H?`Action ${M+1}/${ue}`:"Action configur√©e"}),P&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(K==null?void 0:K.actionType)&&e.jsxs(e.Fragment,{children:[ht.createElement(ur[K.actionType]||Le,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:mr[K.actionType]||K.actionType})]})}),(K==null?void 0:K.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(K.targetAudience)?K.targetAudience:[K.targetAudience]).map(R=>{const q=cr[R]||ct;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(q,{className:"h-3.5 w-3.5"}),dr[R]||R]},R)})]}),((z=K==null?void 0:K.allowedFormIds)==null?void 0:z.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",K.allowedFormIds.map(R=>o(R)).join(", ")]}),((ae=K==null?void 0:K.allowedTemplateIds)==null?void 0:ae.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",K.allowedTemplateIds.map(R=>F(R)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(K==null?void 0:K.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(K==null?void 0:K.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),y&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>C(!j),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Rs,{className:Ue("h-4 w-4 transition-transform",j&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:R=>{R.stopPropagation(),he()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(Fs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),j&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(y,null,2)})]}),$&&e.jsxs("div",{className:Ue("rounded-lg p-4 flex items-start gap-3",$.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[$.success?e.jsx($s,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Bt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Ue("font-medium text-sm",$.success?"text-green-800":"text-red-800"),children:[$.status==="executed"&&"Ex√©cut√© avec succ√®s",$.status==="simulated"&&"Simulation uniquement",$.status==="blocked"&&"Ex√©cution bloqu√©e",$.status==="error"&&"Erreur"]}),e.jsx("p",{className:Ue("text-sm mt-1",$.success?"text-green-700":"text-red-700"),children:$.message})]})]})]})]}),xe&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(be,{variant:"outline",onClick:k,disabled:L,children:[e.jsx(gs,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(be,{onClick:J,disabled:!y||L||!P,className:Ue(!P&&"opacity-50 cursor-not-allowed"),children:[L?e.jsx(Ms,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ja,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},Oe="completed",ke="in_progress",ze="pending",it={[Oe]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[ke]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[ze]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Ut=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||ze}))};if(t.status!==ke)return s;if(!s.subSteps.some(r=>r.status===ke)){const r=s.subSteps.findIndex(m=>m.status===ze);r!==-1&&(s.subSteps=s.subSteps.map((m,g)=>({...m,status:g===r?ke:m.status})))}return s},es=(t,s,a)=>{var I;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,m=r?`${s}:${r}`:null,g=m&&a?a[m]:null,x=(I=g==null?void 0:g.configJson)==null?void 0:I.actions;if(!x||x.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const y=t.subSteps.map((f,L)=>{var j,C;const p=x[L],D=((C=(j=p==null?void 0:p.config)==null?void 0:j.objective)==null?void 0:C.trim())||(p==null?void 0:p.title)||(p==null?void 0:p.label);return{...f,name:D||f.name||`Action ${L+1}`}});return{...t,subSteps:y}}const h=t.status||ze,w=x.map((y,f)=>{var L;return{id:y.id||`v2-${r}-action-${f}`,name:((L=y.config)==null?void 0:L.objective)&&y.config.objective.trim()||y.title||y.label||`Action ${f+1}`,status:h===Oe?Oe:h===ke&&f===0?ke:ze}});return{...t,subSteps:w,status:h}},xr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===Oe),hr=({form:t,prospectId:s,onFormSubmit:a})=>{const[r,m]=n.useState({}),g=(h,w)=>{m(I=>({...I,[h]:w}))},x=()=>{a(s,t.id,r),G({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(h=>{if(h.show_if_conditions&&h.show_if_conditions.length>0){const I=h.condition_operator||"AND",y=h.show_if_conditions.map(L=>{const p=r[L.field];return L.equals==="has_value"?!!p&&p!=="":p===L.equals});if(!(I==="AND"?y.every(L=>L===!0):y.some(L=>L===!0)))return null}if(h.show_if){const I=h.show_if.field,y=h.show_if.equals,f=r[I];if(!f||f!==y)return null}return(t.fields||[]).some(I=>I.is_repeater&&(I.repeats_fields||[]).includes(h.id))?null:e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${h.id}`,children:h.label}),e.jsx(He,{id:`${t.id}-${h.id}`,type:h.type,value:typeof r[h.id]=="object"?"":r[h.id]||"",onChange:I=>g(h.id,I.target.value),placeholder:h.placeholder||""}),h.is_repeater&&h.repeats_fields&&h.repeats_fields.length>0&&r[h.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[h.id])||0},(I,y)=>{const f=(t.fields||[]).filter(L=>h.repeats_fields.includes(L.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[h.label," #",y+1]}),f.map(L=>{const p=`${h.id}_repeat_${y}_${L.id}`,$=r[p];return e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${p}`,children:L.label}),e.jsx(He,{id:`${t.id}-${p}`,type:L.type,value:typeof $=="object"?"":$||"",onChange:D=>g(p,D.target.value),placeholder:L.placeholder||""})]},p)})]},y)})})]},h.id)}),e.jsx(be,{onClick:x,className:"w-full",children:"Soumettre"})]})},pr=({prospectId:t,projectType:s,currentStepIndex:a,activeAdminUser:r})=>{var Ee,De;const{addChatMessage:m,prompts:g,projectsData:x,forms:h,updateProspect:w,prospects:I,completeStepAndProceed:y,registerClientForm:f}=Be();mt();const{messages:L,loading:p}=bs(t,s),{uploadFile:$,uploading:D}=ys({projectType:s,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:j}=st({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),{user:C}=rt(),[P,N]=n.useState(""),[i,d]=n.useState(null),T=n.useRef(null),B=n.useRef(null),[S,M]=n.useState(!1),[ne,ce]=n.useState(!1),[ue,H]=n.useState("client"),{organizationId:xe}=ut(),{templates:K,loading:k}=Ns(xe||(r==null?void 0:r.organization_id),s),{forms:J,loading:he}=qs(xe||(r==null?void 0:r.organization_id)),{templates:W,loading:o}=Vs(xe||(r==null?void 0:r.organization_id)),F=(De=(Ee=x[s])==null?void 0:Ee.steps)==null?void 0:De[a],z=n.useMemo(()=>F!=null&&F.name?F.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`,[F,a]),ae=n.useMemo(()=>{if(!K||!z)return null;const _=K[`${s}:${z}`];return(_==null?void 0:_.configJson)||null},[K,z,s]),R=n.useMemo(()=>J?Object.values(J).map(_=>({id:_.id,name:_.name||_.title||"Formulaire sans nom"})):[],[J]),q=n.useMemo(()=>W?Array.isArray(W)?W.map(_=>({id:_.id,name:_.name||"Template sans nom"})):Object.values(W).map(_=>({id:_.id,name:_.name||"Template sans nom"})):[],[W]),u=I.find(_=>_.id===t),le=n.useMemo(()=>Object.values(g).filter(_=>{var de;if(_.projectId!==s)return!1;const ye=(de=_.stepsConfig)==null?void 0:de[a];return ye&&ye.actions&&ye.actions.length>0}),[g,s,a]),U=n.useCallback(async(_=null)=>{var Se;const ye=le[0];if(!ye){v.warn("Aucun prompt disponible");return}const de=(Se=ye.stepsConfig)==null?void 0:Se[a];if(!de||!de.actions){v.warn("Aucune action dans la config de l'√©tape");return}const we=[...de.actions].sort((Ae,fe)=>(Ae.order||0)-(fe.order||0));if(_){const Ae=we.findIndex(fe=>fe.id===_);if(Ae!==-1&&Ae+1<we.length){const fe=we[Ae+1];v.info("üéØ Action suivante trouv√©e",{completedActionId:_,nextActionId:fe.id,nextActionType:fe.type}),await me(ye,fe.id);return}else{v.warn("Pas d'action suivante",{completedActionId:_,totalActions:we.length});return}}await me(ye)},[le,a]);er({prospectId:t,projectType:s,currentStepIndex:a,prompt:le[0],sendNextAction:U}),n.useEffect(()=>{requestAnimationFrame(()=>{var _;(_=T.current)==null||_.scrollIntoView({behavior:"smooth",block:"end"})})},[L]);const Q=async()=>{if(!(!P.trim()&&!i))try{let _=null;if(i){if(i.size>10485760){G({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}v.debug("üì§ Uploading file from admin chat",{name:i.name,size:i.size,type:i.type});const{data:{user:we}}=await je.auth.getUser(),Se=await $({file:i,uploadedBy:we==null?void 0:we.id});Se&&(_={id:Se.id,name:Se.file_name,size:Se.file_size,type:Se.file_type,storagePath:Se.storage_path},v.debug("‚úÖ File uploaded successfully",_))}m(t,s,{sender:"pro",text:P,file:_,channel:ue}),N(""),d(null),requestAnimationFrame(()=>{var de;(de=T.current)==null||de.scrollIntoView({behavior:"smooth",block:"end"})}),_&&G({title:"‚úÖ Fichier envoy√©",description:`${_.name} a √©t√© envoy√© avec succ√®s.`})}catch(_){v.error("‚ùå Error sending message with file",_),G({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${_.message}`,variant:"destructive"})}},Z=_=>{_.target.files&&_.target.files[0]&&d(_.target.files[0])},te=async _=>{if(!_||!_.storagePath){G({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{v.debug("üì• Downloading file",{storagePath:_.storagePath});const{data:ye,error:de}=await je.storage.from("project-files").createSignedUrl(_.storagePath,3600);if(de)throw de;window.open(ye.signedUrl,"_blank"),G({title:"‚úÖ T√©l√©chargement",description:`${_.name} s'ouvre dans un nouvel onglet.`})}catch(ye){v.error("‚ùå Error downloading file",ye),G({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${ye.message}`,variant:"destructive"})}},ge=(_,ye,de)=>{var oe;const we=I.find(re=>re.id===_);if(!we)return;const Se={...we.formData||{},...de};w({...we,formData:Se});const Ae={sender:"client",text:`A compl√©t√© le formulaire : ${((oe=h[ye])==null?void 0:oe.name)||"Formulaire"}.`};if(m(_,s,Ae),Object.values(g).find(re=>{var E,V;if(re.projectId!==s)return!1;const l=(E=re.stepsConfig)==null?void 0:E[a];return l!=null&&l.autoCompleteStep?(V=l.actions)==null?void 0:V.some(se=>se.type==="show_form"&&se.formId===ye):!1})){const re=ae==null?void 0:ae.actions;if(re&&re.length>1){G({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}y(t,s,a),G({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},me=async(_,ye=null)=>{var we,Se,Ae,fe,oe,re,l,E;const de=(we=_.stepsConfig)==null?void 0:we[a];if(de&&de.actions&&de.actions.length>0){const V=L,se=[...de.actions].sort((b,A)=>(b.order||0)-(A.order||0));let Ne=se,c=!1;if(ye){const b=se.find(A=>A.id===ye);if(!b){v.warn("Action sp√©cifique introuvable",{specificActionId:ye});return}v.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:ye,actionType:b.type}),Ne=[b],c=!0}for(const b of Ne)if(!(!c&&V.some(O=>O.promptId===_.id&&O.stepIndex===a&&(O.text===b.message||O.formId===b.formId&&b.type==="show_form")))){if(b.message){const A={sender:"pro",text:b.message,promptId:_.id,stepIndex:a,actionId:b.id};m(t,s,A)}if(b.type==="show_form"&&b.formId){const A={sender:"pro",formId:b.formId,promptId:_.id,stepIndex:a,actionId:b.id};m(t,s,A);const O=((fe=(Ae=(Se=x[s])==null?void 0:Se.steps)==null?void 0:Ae[a])==null?void 0:fe.name)||"√âtape inconnue";try{const X=await f({prospectId:t,projectType:s,formId:b.formId,currentStepIndex:a,promptId:_.id,messageTimestamp:Date.now(),status:"pending",stepName:O,actionId:b.id});if(!X.success)v.error("‚ùå √âchec enregistrement formulaire:",X.error),G({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const Y=((oe=h[b.formId])==null?void 0:oe.name)||b.formId;await j({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${Y} a √©t√© envoy√© √† ${(u==null?void 0:u.name)||"le client"}.`,createdBy:(C==null?void 0:C.user_id)||null,createdByName:(C==null?void 0:C.name)||"Admin"})}catch(Y){v.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Y)}}catch(X){v.error("‚ùå Exception enregistrement formulaire:",X),G({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(b.type==="start_signature"&&b.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");v.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:b.templateId,prospectId:t,projectType:s,organizationId:r.organization_id,formId:b.formId});const{data:A,error:O}=await je.from("prospects").select("form_data").eq("id",t).single(),X=((l=(re=A==null?void 0:A.form_data)==null?void 0:re[s])==null?void 0:l[b.formId])||{};v.info("üìã Donn√©es formulaire extraites",{formId:b.formId,dataKeys:Object.keys(X)}),G({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const Y=await xa({templateId:b.templateId,projectType:s,prospectId:t,formData:X,organizationId:r==null?void 0:r.organization_id});if(Y.success){const ee=Y.fileData.id;v.debug("Cr√©ation proc√©dure de signature...",{fileId:ee,prospectId:t,projectType:s});const{data:ie}=await je.from("signature_procedures").select("*").eq("file_id",ee).eq("prospect_id",t).eq("status","pending").maybeSingle();let ve=ie;if(!ve){const Xe=crypto.randomUUID(),We=new Date;We.setDate(We.getDate()+7);const nt=[{role:"principal",name:(u==null?void 0:u.name)||"Client",email:u==null?void 0:u.email,phone:(u==null?void 0:u.phone)||null,access_token:Xe,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const qe=typeof(u==null?void 0:u.name)=="string"&&u.name.trim()!==""?u.name:((E=u==null?void 0:u.email)==null?void 0:E.split("@")[0])||"Client",Ce=u==null?void 0:u.email,{data:_t,error:Ye}=await je.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:ee,access_token:Xe,access_token_expires_at:We.toISOString(),status:"pending",signers:nt,organization_id:r.organization_id,signer_name:qe,signer_email:Ce}).select().single();if(Ye)throw v.error("Erreur cr√©ation signature_procedures",Ye),Ye;ve=_t,v.debug("Proc√©dure de signature cr√©√©e",{procedureId:ve.id,signersCount:nt.length})}const Re=`https://evatime.fr/signature/${ve.id}?token=${ve.access_token}`,{data:_e}=await je.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${ve.id}%`).maybeSingle();_e||(await je.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${Re}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id,channel:"client"}),v.debug("Lien de signature envoy√© dans le chat")),G({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await j({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(u==null?void 0:u.name)||"le client"}.`,createdBy:(C==null?void 0:C.user_id)||null,createdByName:(C==null?void 0:C.name)||"Admin"})}catch(Xe){v.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Xe)}}else throw new Error(Y.error||"Erreur inconnue")}catch(A){v.error("‚ùå Exception g√©n√©ration contrat:",A),G({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${A.message}`,variant:"destructive"})}break}}M(!1)},Ie=L.filter(_=>!_.channel||_.channel==="client"),pe=L.filter(_=>_.channel==="partner"),Pe=ue==="partner"?pe:Ie;return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex mb-3 rounded-xl overflow-hidden border-2 border-gray-200",children:[e.jsxs("button",{onClick:()=>H("client"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${ue==="client"?"bg-blue-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üí¨ Client",Ie.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${ue==="client"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:Ie.length})]}),e.jsxs("button",{onClick:()=>H("partner"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${ue==="partner"?"bg-orange-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üü† Partenaire",pe.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${ue==="partner"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:pe.length})]})]}),e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[Pe.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400 text-sm",children:ue==="partner"?"üü† Aucun message partenaire":"üí¨ Aucun message client"}),Pe.map((_,ye)=>{const de=_.sender==="pro"||_.sender==="admin",we=_.sender==="partner",Se=_.sender==="client";return e.jsxs("div",{className:`flex items-end gap-2 ${de?"justify-end":"justify-start"}`,children:[Se&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(u==null?void 0:u.name.charAt(0))||"?"}),we&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center font-bold text-white text-xs",children:"P"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${de?"bg-blue-500 text-white rounded-br-none p-2.5":we?"bg-orange-100 text-orange-900 rounded-bl-none p-3 border border-orange-200":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[we&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-600 mb-1",children:"üü† Partenaire"}),_.channel==="partner"&&de&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-300 mb-1",children:"‚Üí Partenaire"}),_.text&&(de&&_.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:_.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:_.text})),_.file&&e.jsxs("button",{onClick:()=>te(_.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Le,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:_.file.name}),e.jsx(pt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),_.formId&&h[_.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(hr,{form:h[_.formId],prospectId:t,onFormSubmit:ge})}),e.jsx("p",{className:`text-xs mt-1 ${de?"text-blue-200":we?"text-orange-400":"text-gray-500"}`,children:Bs(new Date(_.timestamp),{addSuffix:!0,locale:Ve})})]}),de&&!_.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},ye)}),e.jsx("div",{ref:T})]}),i&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Ht,{className:"w-4 h-4"}),e.jsx("span",{children:i.name}),e.jsx("button",{onClick:()=>d(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{placeholder:ue==="partner"?"üü† √âcrire au partenaire...":"üí¨ √âcrire au client...",className:`pr-28 h-12 ${ue==="partner"?"border-orange-300 focus:ring-orange-400":""}`,value:P,onChange:_=>N(_.target.value),onKeyPress:_=>_.key==="Enter"&&Q()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(be,{variant:"ghost",size:"icon",onClick:()=>ce(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(xs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(be,{variant:"ghost",size:"icon",onClick:()=>B.current.click(),disabled:D,children:e.jsx(Ht,{className:`h-5 w-5 ${D?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:B,onChange:Z,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:D}),e.jsx(be,{onClick:Q,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:D,children:D?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Hs,{className:"h-4 w-4"})})]})]}),e.jsx(gr,{isOpen:ne,onClose:()=>ce(!1),prospectId:t,projectType:s,moduleId:z,moduleName:(F==null?void 0:F.name)||`√âtape ${a+1}`,moduleConfig:ae,context:{organizationId:xe||(r==null?void 0:r.organization_id),adminUser:r},availableForms:R,availableTemplates:q})]})},fr=({steps:t,onUpdateStatus:s,prompts:a,projectType:r,currentStepIndex:m,prospectId:g,completeStepAndProceed:x})=>{var j;if(!t)return null;const[h,w]=n.useState({}),{activeAdminUser:I,appointments:y,updateAppointment:f}=Be(),L=a?Object.values(a).find(C=>C.projectId===r):null,p=(j=L==null?void 0:L.stepsConfig)==null?void 0:j[m],$=n.useMemo(()=>{if(!t[m])return[];const C=t[m].name,P=y.filter(N=>N.type==="task"&&N.contactId===g&&N.projectId===r&&N.step===C);return P.length>0&&v.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:g,projectType:r,stepName:C,totalAppointments:y.length,filteredTasks:P.length,tasks:P.map(N=>({id:N.id,title:N.title,contactId:N.contactId,projectId:N.projectId,step:N.step}))}),P},[y,g,r,m,t]),D=(C,P)=>{w(N=>{var S;const i=N[C]||{},d={...i,[P]:!i[P]},T={...N,[C]:d},B=(S=p==null?void 0:p.actions)==null?void 0:S.find(M=>M.id===C);return B&&B.checklist&&B.checklist.every(ne=>d[ne.id])&&p!=null&&p.autoCompleteStep&&(G({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),x(g,r,m,t)),T})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((C,P)=>{const N=it[C.status]||it[ze];return e.jsxs(Qe.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:P*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${N.iconOnly}`,children:C.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${N.text}`,children:C.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[C.subSteps&&C.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[C.subSteps.filter(i=>i.status===Oe).length,"/",C.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(be,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${N.badge} hover:opacity-90`,onClick:i=>{var S;i.stopPropagation();const d=i.currentTarget,T=d.nextElementSibling,B=d.closest("[data-step-status-container]");!T||!B||((S=B.parentElement)==null||S.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==T&&M.classList.add("hidden")}),T.classList.toggle("hidden"))},children:N.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:i=>{var d;i.stopPropagation(),i.preventDefault(),s(P,ke),(d=i.currentTarget.parentElement)==null||d.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:i=>{var d;i.stopPropagation(),i.preventDefault(),s(P,Oe),(d=i.currentTarget.parentElement)==null||d.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:i=>{var d;i.stopPropagation(),i.preventDefault(),s(P,ze),(d=i.currentTarget.parentElement)==null||d.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),C.subSteps&&C.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:C.subSteps.map((i,d)=>{const T=it[i.status]||it[ze];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${i.status===Oe?"bg-green-500":i.status===ke?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:i.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${T.badge}`,children:T.label})]},i.id||d)})}),C.status===ke&&P===m&&(p==null?void 0:p.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:p.actions.filter(i=>i.hasClientAction===!1&&i.checklist&&i.checklist.length>0).map(i=>{const d=h[i.id]||{},T=i.checklist.length,B=i.checklist.filter(M=>d[M.id]).length,S=B===T;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${S?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[B,"/",T]})]}),e.jsx("div",{className:"space-y-2",children:i.checklist.map(M=>{const ne=d[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:()=>D(i.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ne?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(p==null?void 0:p.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},i.id)})}),C.status===ke&&P===m&&$.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:$.map(i=>{const d=i.status==="effectue",T=i.startTime?new Date(i.startTime):null,B=T&&!isNaN(T.getTime()),S=async()=>{const M=d?"pending":"effectue";await f(i.id,{status:M}),G({title:d?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:d?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:d?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:S,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${d?"line-through text-gray-500":""} truncate flex-1`,children:i.title||"T√¢che"}),d&&e.jsx(gt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),B&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Ze(T,"dd/MM/yyyy √† HH:mm",{locale:Ve})]})]})]},i.id)})})]})]},P)})})]})},br=({prospect:t,projectType:s,supabaseSteps:a,v2Templates:r,onUpdate:m})=>{var W;const{forms:g,prompts:x,completeStepAndProceed:h,activeAdminUser:w,appointments:I,updateAppointment:y}=Be(),{formPanels:f=[],loading:L,updateFormPanel:p}=Ws(t.id),{sendMessage:$}=bs(t.id,s),[D,j]=n.useState(null),[C,P]=n.useState({}),[N,i]=n.useState(!1),[d,T]=n.useState(null),[B,S]=n.useState(""),[M,ne]=n.useState(new Set),ce=n.useMemo(()=>{if(!f)return[];const o=f.filter(F=>F.prospectId===t.id&&F.projectType===s).sort((F,z)=>(z.createdAt||0)-(F.createdAt||0));return v.debug("[ProspectForms] Filtering panels",{totalPanels:f.length,prospectId:t.id,projectType:s,filteredCount:o.length,samplePanel:f[0]}),o},[f,t.id,s]);if(n.useEffect(()=>{!ce||ce.length===0||ce.forEach(o=>{var z,ae,R,q;if(M.has(o.panelId)||o.status!=="submitted")return;if(o.lastSubmittedAt){const u=new Date(o.lastSubmittedAt).getTime(),U=Date.now()-u;if(U>1e4){v.debug("Form too old, skipping auto-complete",{panelId:o.panelId,ageSeconds:Math.floor(U/1e3)}),ne(Q=>new Set([...Q,o.panelId]));return}}v.debug("New submitted form detected",{panelId:o.panelId,formId:o.formId,projectType:o.projectType}),v.debug("Available prompts",{count:Object.keys(x).length});let F=null;if(o.promptId&&(v.debug("Searching by promptId",{promptId:o.promptId}),F=x[o.promptId]),F||(F=Object.values(x).find(u=>{var Q,Z;if(v.debug("Testing prompt",{name:u.name,projectId:u.projectId,target:o.projectType}),u.projectId!==o.projectType)return!1;const le=(Q=u.stepsConfig)==null?void 0:Q[o.currentStepIndex];return(Z=le==null?void 0:le.actions)==null?void 0:Z.some(te=>te.type==="show_form"&&te.formId===o.formId)})),v.debug("Prompt found",{name:F==null?void 0:F.name,autoComplete:(ae=(z=F==null?void 0:F.stepsConfig)==null?void 0:z[o.currentStepIndex])==null?void 0:ae.autoCompleteStep}),F){const u=(R=F.stepsConfig)==null?void 0:R[o.currentStepIndex],le=(q=u==null?void 0:u.actions)==null?void 0:q.find(Q=>Q.type==="show_form"&&Q.formId===o.formId),U=(le==null?void 0:le.verificationMode)||"human";v.debug("Checking auto-complete conditions",{autoCompleteStep:u==null?void 0:u.autoCompleteStep,verificationMode:U}),u!=null&&u.autoCompleteStep&&U==="none"&&(v.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),h(t.id,o.projectType,o.currentStepIndex),G({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}ne(u=>new Set([...u,o.panelId]))})},[ce,x,h,t.id,t.name,M]),ce.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const ue=o=>{j(o.panelId);const ae=((t.form_data||t.formData||{})[o.projectType]||{})[o.formId]||{};P({...ae,_meta:{projectType:o.projectType,formId:o.formId}})},H=()=>{j(null),P({})},xe=async()=>{const{_meta:o,...F}=C,{projectType:z,formId:ae}=o||{};if(!z||!ae){v.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const R=t.form_data||t.formData||{},q={...R,[z]:{...R[z]||{},[ae]:F}},{error:u}=await je.from("prospects").update({form_data:q}).eq("id",t.id);if(u){v.error("‚ùå Erreur sauvegarde formulaire:",u),G({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}G({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),m&&m({...t,form_data:q,formData:q}),j(null),P({})},K=(o,F)=>{P(z=>({...z,[o]:F}))},k=o=>{var ae,R;const F=Object.values(x).find(q=>q.id===o.promptId||q.projectId===o.projectType),z=(ae=F==null?void 0:F.stepsConfig)==null?void 0:ae[o.currentStepIndex];return(R=z==null?void 0:z.actions)==null?void 0:R.find(q=>q.formId===o.formId)},J=async o=>{var F,z,ae,R,q,u;try{await p(o.panelId,{status:"approved"});const le=k(o),U=(le==null?void 0:le.verificationMode)||"human";if(v.debug("üîç Checking verification mode",{verificationMode:U,shouldSearchTask:U==="human"}),U==="human"){v.debug("üîç Searching for related task",{totalAppointments:(I==null?void 0:I.length)||0,prospectId:t.id,projectType:o.projectType,stepName:o.stepName,panel:o});const fe=(I==null?void 0:I.filter(l=>l.type==="task"))||[],oe=fe.filter(l=>l.contactId===t.id);v.debug("üîç Task filtering debug",{allTasks:fe.length,prospectTasks:oe.length,prospectTasksData:oe.map(l=>({id:l.id,title:l.title,contactId:l.contactId,projectId:l.projectId,step:l.step,status:l.status}))}),v.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:o.projectType,step:o.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let re=I==null?void 0:I.find(l=>{var se;const E={isTask:l.type==="task",contactMatch:l.contactId===t.id,projectMatch:l.projectId===o.projectType,stepMatch:l.step===o.stepName,isPending:l.status==="pending",titleMatch:(se=l.title)==null?void 0:se.includes("V√©rifier le formulaire")},V=Object.values(E).every(Ne=>Ne);return!V&&l.type==="task"&&l.contactId===t.id&&v.warn("üîç Task failed matching:",{taskId:l.id,title:l.title,checks:E,COMPARISON:{taskStep:`"${l.step}"`,panelStep:`"${o.stepName}"`,areEqual:l.step===o.stepName,taskStepType:typeof l.step,panelStepType:typeof o.stepName},taskData:{contactId:l.contactId,projectId:l.projectId,step:l.step,status:l.status},panelData:{projectType:o.projectType,stepName:o.stepName}}),V});re||(v.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:o.stepName}),re=I==null?void 0:I.find(l=>{var E;return l.type==="task"&&l.contactId===t.id&&l.projectId===o.projectType&&l.status==="pending"&&((E=l.title)==null?void 0:E.includes("V√©rifier le formulaire"))}),re&&v.info("‚úÖ Found task via fallback (without step match)",{taskId:re.id,taskStep:re.step})),re?(v.info("‚úÖ Found verification task, marking as completed",{taskId:re.id,prospectId:t.id,title:re.title}),await y(re.id,{status:"effectue"}),G({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):v.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:o.projectType,step:o.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else v.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:U});const Q=a==null?void 0:a[o.projectType],Z=Q==null?void 0:Q.findIndex(fe=>fe.status==="in_progress"),te=Z!=null&&Z>=0?Z:o.currentStepIndex||0,ge=(F=Q==null?void 0:Q[te])==null?void 0:F.name,me=ge?ge.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,Ie=`${o.projectType}:${me}`,pe=me&&r?r[Ie]:null,Pe=(z=pe==null?void 0:pe.configJson)==null?void 0:z.actionConfig;v.debug("[V2] Template lookup",{panelProjectType:o.projectType,propProjectType:s,currentStepName:ge,moduleId:me,templateKey:Ie,v2TemplatesKeys:r?Object.keys(r):[],templateFound:!!pe});const Ee=ge?ps(ge):null,De=(Pe==null?void 0:Pe.completionTrigger)||(Ee==null?void 0:Ee.completionTrigger),_=(ae=pe==null?void 0:pe.configJson)==null?void 0:ae.actions,ye=_&&_.length>1;let de=!0;if(ye){const fe=_.map((V,se)=>`v2-${me}-action-${se}`),{data:oe}=await je.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",o.projectType).eq("status","approved");let re=new Set;(oe||[]).forEach(V=>{V.action_id&&fe.includes(V.action_id)&&re.add(V.action_id)});const l=(oe||[]).filter(V=>!V.action_id&&(!V.step_name||V.step_name===ge||V.step_name===me));if(l.length>0){const V=fe.filter(se=>!re.has(se));l.forEach((se,Ne)=>{Ne<V.length&&re.add(V[Ne])}),v.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:l.length,uncoveredIds:V,afterAssignment:[...re]})}const E=re.size;de=E>=_.length,v.debug("[V2] Multi-actions check",{totalActions:_.length,expectedActionIds:fe,approvedActionIds:[...re],panelsTotal:(oe||[]).length,panelsWithActionId:(oe||[]).filter(V=>V.action_id).length,panelsWithoutActionId:l.length,allCompleted:de}),de||(v.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:_.length-E}),G({title:"‚úÖ Action valid√©e",description:`Action ${E}/${_.length} ‚Äî il reste ${_.length-E} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}v.debug("[V2] Checking completionTrigger for form approval",{stepName:ge,moduleId:me,v2TemplateFound:!!pe,completionTrigger:De,currentStepIdx:te,hasMultiActions:ye,allActionsCompleted:de});const we=(De==="form_approved"||!De)&&de;let Se=Q;if(Q&&((q=(R=Q[te])==null?void 0:R.subSteps)==null?void 0:q.length)>0){const fe=Q[te];let oe=-1;if(o.action_id&&(oe=fe.subSteps.findIndex(re=>re.id===o.action_id)),oe===-1&&(oe=fe.subSteps.findIndex(re=>re.status===ke),v.debug("[V2] Substep fallback: using first in_progress",{panelActionId:o.action_id,fallbackIndex:oe})),oe!==-1){v.debug("[V2] Updating substep for approved action",{actionId:o.action_id,subStepIndex:oe,subStepName:fe.subSteps[oe].name,allActionsCompleted:de});const re=JSON.parse(JSON.stringify(Q));if(re[te].subSteps.forEach((l,E)=>{l.status===ke&&E!==oe&&(l.status=Oe)}),re[te].subSteps[oe].status=Oe,!de){let l=-1;for(let E=oe+1;E<re[te].subSteps.length;E++)if(re[te].subSteps[E].status===ze){l=E;break}l!==-1&&(re[te].subSteps[l].status=ke,v.debug("[V2] Activated next substep",{completedIndex:oe,nextIndex:l,nextName:re[te].subSteps[l].name}))}await updateSupabaseSteps(o.projectType,re),Se=re,v.info("[V2] Substep updated successfully",{completedSubStep:oe,nextActivated:!de})}}if(we&&Se)v.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:o.projectType,currentStepIdx:te,stepName:ge,trigger:De||"default_behavior"}),await h(t.id,o.projectType,te,Se),G({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const fe=Object.values(x).find(oe=>oe.id===o.promptId||oe.projectId===o.projectType);if(fe){const oe=(u=fe.stepsConfig)==null?void 0:u[o.currentStepIndex];oe!=null&&oe.autoCompleteStep&&(v.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:o.projectType,stepIndex:o.currentStepIndex}),Q?await h(t.id,o.projectType,o.currentStepIndex,Q):v.error("No steps found in supabaseSteps for projectType",{projectType:o.projectType}))}}const Ae=o.filledByRole==="partner";if(Ae)v.debug("Formulaire partenaire valid√© ‚Äî pas de message chat au client");else{const fe=(le==null?void 0:le.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:oe}=await je.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",o.projectType).eq("sender","admin").eq("text",fe).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!oe||oe.length===0?await $({sender:"admin",text:fe,relatedMessageTimestamp:new Date().toISOString()}):v.debug("Message de validation d√©j√† envoy√© r√©cemment, skip")}G({title:"‚úÖ Formulaire valid√©",description:Ae?"Le formulaire partenaire a √©t√© valid√©.":"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(le){v.error("‚ùå Erreur validation formulaire:",le),G({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},he=async(o="")=>{if(d)try{const F=d,z=F.filledByRole==="partner";await p(F.panelId,{status:"rejected",rejectionReason:z?o:null});const ae=k(F),R=(ae==null?void 0:ae.verificationMode)||"human";if(v.debug("üîç Checking verification mode (reject)",{verificationMode:R,shouldSearchTask:R==="human",isPartnerForm:z}),R==="human"){v.debug("üîç Searching for related task (reject)",{totalAppointments:(I==null?void 0:I.length)||0,prospectId:t.id,projectType:F.projectType,stepName:F.stepName}),v.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:F.projectType,step:F.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let q=I==null?void 0:I.find(u=>{var Q;const le={isTask:u.type==="task",contactMatch:u.contactId===t.id,projectMatch:u.projectId===F.projectType,stepMatch:u.step===F.stepName,isPending:u.status==="pending",titleMatch:(Q=u.title)==null?void 0:Q.includes("V√©rifier le formulaire")},U=Object.values(le).every(Z=>Z);return!U&&u.type==="task"&&u.contactId===t.id&&v.warn("üîç Task failed matching (REJECT):",{taskId:u.id,title:u.title,checks:le,COMPARISON:{taskStep:`"${u.step}"`,panelStep:`"${F.stepName}"`,areEqual:u.step===F.stepName,taskStepType:typeof u.step,panelStepType:typeof F.stepName},taskData:{contactId:u.contactId,projectId:u.projectId,step:u.step,status:u.status},panelData:{projectType:F.projectType,stepName:F.stepName}}),U});q||(v.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:F.stepName}),q=I==null?void 0:I.find(u=>{var le;return u.type==="task"&&u.contactId===t.id&&u.projectId===F.projectType&&u.status==="pending"&&((le=u.title)==null?void 0:le.includes("V√©rifier le formulaire"))}),q&&v.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:q.id,taskStep:q.step})),q&&(v.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:q.id,prospectId:t.id,title:q.title}),await y(q.id,{status:"effectue"}))}else v.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:R});if(z)G({title:"‚ùå Formulaire rejet√©",description:"Le partenaire verra la raison du refus sur sa mission.",className:"bg-red-500 text-white"});else{const u=`${(ae==null?void 0:ae.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${o}`;await $({sender:"admin",text:u,relatedMessageTimestamp:new Date().toISOString()}),G({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"})}i(!1),T(null),S("")}catch(F){v.error("‚ùå Erreur rejet formulaire:",F),G({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ce.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:ce.map(o=>{var R,q;const F=g[o.formId];let z={};if(o.filledByRole==="partner"&&o.formData?z=o.formData:z=((t.form_data||t.formData||{})[o.projectType]||{})[o.formId]||{},!F)return null;const ae=o.stepName||((q=(R=a==null?void 0:a[o.projectType])==null?void 0:R[o.currentStepIndex])==null?void 0:q.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:F.name}),ae&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",ae]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${o.status==="submitted"?"bg-green-100 text-green-700":o.status==="approved"?"bg-blue-100 text-blue-700":o.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:o.status==="submitted"?"Envoy√©":o.status==="approved"?"Approuv√©":o.status==="rejected"?"Rejet√©":"En attente"})]}),o.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["‚úÖ ",o.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(be,{size:"sm",onClick:()=>J(o),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(gt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(be,{size:"sm",variant:"outline",onClick:()=>{T(o),i(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),o.status==="rejected"&&o.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:o.rejectionReason.startsWith("Mission impossible")?"‚õî Mission d√©clar√©e impossible par le partenaire":"‚ùå Formulaire rejet√©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:o.rejectionReason.startsWith("Mission impossible ‚Äî ")?o.rejectionReason.replace("Mission impossible ‚Äî ",""):o.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(F.fields||[]).map(u=>{if(u.show_if_conditions&&u.show_if_conditions.length>0){const Z=u.condition_operator||"AND",te=u.show_if_conditions.map(me=>{const Ie=z[me.field];return me.equals==="has_value"?!!Ie&&Ie!=="":Ie===me.equals});if(!(Z==="AND"?te.every(me=>me===!0):te.some(me=>me===!0)))return null}if(u.show_if){const Z=u.show_if.field,te=u.show_if.equals,ge=z[Z];if(!ge||ge!==te)return null}if((F.fields||[]).some(Z=>Z.is_repeater&&(Z.repeats_fields||[]).includes(u.id)))return null;const U=z[u.id],Q=u.type==="file"&&typeof U=="object"&&(U==null?void 0:U.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-sm font-medium text-gray-600",children:u.label}),D===o.panelId?Q?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Le,{className:"inline h-4 w-4 mr-2"}),U.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):u.type==="select"?e.jsxs("select",{value:C[u.id]||"",onChange:Z=>K(u.id,Z.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(u.options||[]).map((Z,te)=>e.jsx("option",{value:Z,children:Z},te))]}):e.jsx(He,{type:u.type||"text",value:C[u.id]||"",onChange:Z=>K(u.id,Z.target.value),placeholder:u.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:Q?e.jsxs("button",{onClick:async()=>{try{const{data:Z,error:te}=await je.storage.from("project-files").createSignedUrl(U.storagePath,3600);if(te)throw te;window.open(Z.signedUrl,"_blank")}catch{G({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsx("span",{children:U.name}),e.jsx(pt,{className:"h-3 w-3"})]}):U||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),u.is_repeater&&u.repeats_fields&&u.repeats_fields.length>0&&U&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(U)||0},(Z,te)=>{const ge=(F.fields||[]).filter(me=>u.repeats_fields.includes(me.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[u.label," #",te+1]}),ge.map(me=>{const Ie=`${u.id}_repeat_${te}_${me.id}`,pe=z[Ie],Pe=me.type==="file"&&typeof pe=="object"&&(pe==null?void 0:pe.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:me.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:Pe?e.jsxs("button",{onClick:async()=>{try{const{data:Ee,error:De}=await je.storage.from("project-files").createSignedUrl(pe.storagePath,3600);if(De)throw De;window.open(Ee.signedUrl,"_blank")}catch{G({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Le,{className:"h-3 w-3"}),e.jsx("span",{children:pe.name}),e.jsx(pt,{className:"h-3 w-3"})]}):pe||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},Ie)})]},te)})})]},u.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D===o.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(be,{variant:"outline",size:"sm",onClick:H,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(be,{size:"sm",onClick:xe,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(qt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>ue(o),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},o.panelId)})}),e.jsx(bt,{open:N,onOpenChange:i,children:e.jsxs(jt,{className:"max-w-lg",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Rejeter le formulaire"}),e.jsx(fs,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((W=k(d))==null?void 0:W.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Me,{children:"Raison du refus"}),e.jsx("textarea",{value:B,onChange:o=>S(o.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Ot,{children:[e.jsx(be,{variant:"outline",onClick:()=>{i(!1),T(null),S("")},children:"Annuler"}),e.jsx(be,{onClick:()=>he(B),disabled:!B.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},jr=({prospect:t,projectType:s,onUpdate:a})=>{const{forms:r}=Be(),[m,g]=n.useState(null),[x,h]=n.useState({}),w=n.useMemo(()=>Object.values(r).filter(p=>p.audience==="internal"&&(p.projectIds||[]).includes(s)),[r,s]);n.useEffect(()=>{if(t&&t.form_data){const p=t.form_data[s]||{};h(p)}},[t,s]);const I=p=>{g(p)},y=()=>{if(g(null),t&&t.form_data){const p=t.form_data[s]||{};h(p)}},f=(p,$,D)=>{h(j=>({...j,[p]:{...j[p]||{},[$]:D}}))},L=async()=>{try{const p={...t.form_data||{},[s]:x},$={...t,form_data:p,formData:p};await a($),G({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),g(null)}catch(p){v.error("Erreur sauvegarde formulaire interne:",p),G({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[w.length," formulaire(s)"]})]}),w.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:w.map(p=>{const $=x[p.id]||{},D=m===p.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:p.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(p.fields||[]).map(j=>{if(j.show_if_conditions&&j.show_if_conditions.length>0){const N=j.condition_operator||"AND",i=j.show_if_conditions.map(T=>{const B=$[T.field];return T.equals==="has_value"?!!B&&B!=="":B===T.equals});if(!(N==="AND"?i.every(T=>T===!0):i.some(T=>T===!0)))return null}if(j.show_if){const N=j.show_if.field,i=j.show_if.equals,d=$[N];if(!d||d!==i)return null}if((p.fields||[]).some(N=>N.is_repeater&&(N.repeats_fields||[]).includes(j.id)))return null;const P=$[j.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Me,{className:"text-sm font-medium text-gray-600",children:[j.label,j.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),D?j.type==="textarea"?e.jsx("textarea",{value:P,onChange:N=>f(p.id,j.id,N.target.value),placeholder:j.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):j.type==="select"?e.jsxs("select",{value:P,onChange:N=>f(p.id,j.id,N.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(j.options||[]).map((N,i)=>e.jsx("option",{value:N,children:N},i))]}):e.jsx(He,{type:j.type||"text",value:P,onChange:N=>f(p.id,j.id,N.target.value),placeholder:j.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:P||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),j.is_repeater&&j.repeats_fields&&j.repeats_fields.length>0&&P&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(P)||0},(N,i)=>{const d=(p.fields||[]).filter(T=>j.repeats_fields.includes(T.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[j.label," #",i+1]}),d.map(T=>{const B=`${j.id}_repeat_${i}_${T.id}`,S=$[B]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:T.label}),D?T.type==="textarea"?e.jsx("textarea",{value:S,onChange:M=>f(p.id,B,M.target.value),placeholder:T.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):T.type==="select"?e.jsxs("select",{value:S,onChange:M=>f(p.id,B,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(T.options||[]).map((M,ne)=>e.jsx("option",{value:M,children:M},ne))]}):e.jsx(He,{type:T.type||"text",value:S,onChange:M=>f(p.id,B,M.target.value),placeholder:T.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:S||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},B)})]},i)})})]},j.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D?e.jsxs(e.Fragment,{children:[e.jsxs(be,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(be,{size:"sm",onClick:L,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(qt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(be,{variant:"outline",size:"sm",onClick:()=>I(p.id),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},p.id)})})]})},yr=t=>{switch(t.type){case"email":return e.jsx(vt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(at,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Gs,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(wt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(Js,{className:"h-4 w-4 text-gray-400"})}},Nr=({prospect:t,onBack:s,onUpdate:a,onEditingChange:r})=>{var Ne;const{getProjectSteps:m,completeStepAndProceed:g,updateProjectSteps:x,markNotificationAsRead:h,projectsData:w,formContactConfig:I,currentUser:y,userProjects:f,setUserProjects:L,getProjectInfo:p,updateProjectInfo:$,activeAdminUser:D,prompts:j,notifications:C}=Be(),{supabaseUserId:P}=rt(),{users:N,loading:i}=mt(),{projectStepsStatus:d,updateProjectSteps:T}=oa(t.id),{organizationId:B}=ut(),{templates:S}=Ns(B||(D==null?void 0:D.organization_id),null),[M,ne]=hs(),ce=M.get("project")||t._selectedProjectType,ue=M.get("notificationId"),[H,xe]=n.useState(ce||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:K,addProjectEvent:k}=st({projectType:H||"",prospectId:t.id,enabled:!!H&&!!t.id,activeAdminUser:D}),[J,he]=n.useState(!1),[W,o]=n.useState(t);n.useEffect(()=>{o(t)},[t]);const[F,z]=n.useState(!1),ae=n.useMemo(()=>H?p(t.id,H)||{}:{},[H,p,t.id]),[R,q]=n.useState((ae==null?void 0:ae.status)||"actif"),[u,le]=n.useState({}),U=ae==null?void 0:ae.amount,Q=n.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[Z,te]=n.useState(""),[ge,me]=n.useState(!1),Ie=n.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...N.map(c=>({value:c.user_id,label:c.name}))],[N]),pe=n.useMemo(()=>{var b;if(!H)return[];if(d[H])return d[H].map(A=>es(A,H,S)).map(Ut);const c=(b=w[H])==null?void 0:b.steps;if(c&&c.length>0){const A=JSON.parse(JSON.stringify(c));return A[0].status="in_progress",A.map(O=>es(O,H,S)).map(Ut)}return[]},[H,d,w,S]),Pe=pe.findIndex(c=>c.status===ke),Ee=pe[Pe]||pe.find(c=>c.status===ze)||pe[0];n.useEffect(()=>{if(ue){h(parseInt(ue));const c=new URLSearchParams(M);c.delete("notificationId"),ne(c,{replace:!0})}},[ue,h,ne,M]),n.useEffect(()=>{var b;const c=M.get("project");c&&c!==H&&((b=t.tags)!=null&&b.includes(c))&&xe(c)},[M,t.tags]),n.useEffect(()=>{if(!(t!=null&&t.id)||!H||!C||!h)return;const c=C.filter(b=>!b.read&&b.prospectId===t.id&&b.projectType===H);c.length>0&&c.forEach(b=>{h(b.id)})},[t==null?void 0:t.id,H,C,h]),n.useEffect(()=>{v.debug("Prospect prop changed",{name:t.name}),o(t)},[t]),n.useEffect(()=>{ge||(U==null||U===""?te(""):te(U.toString()))},[U,ge]),n.useEffect(()=>{(async()=>{var O;if(!H||!t.id)return;const{data:b,error:A}=await je.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",H).maybeSingle();A?(v.error("Erreur chargement project status:",A),q("actif")):(O=b==null?void 0:b.data)!=null&&O.status?q(b.data.status):q("actif")})()},[H,t.id]),n.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:b,error:A}=await je.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(b){const O={};b.forEach(X=>{O[X.project_type]=X.status||"actif"}),le(O)}})()},[t.id,t.tags]),n.useEffect(()=>{r&&r(J)},[J,r]),n.useEffect(()=>{if(!t.id)return;const c=je.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async b=>{var Re;const{new:A,old:O}=b;if(A.status!=="signed"||(O==null?void 0:O.status)==="signed")return;const X=A.project_type;v.info("[V2 Signature Listener] Signature completed",{procedureId:A.id,projectType:X,prospectId:A.prospect_id});const Y=d==null?void 0:d[X];if(!Y||Y.length===0){v.warn("[V2 Signature Listener] No steps found for project type",{projectType:X});return}const ee=Y.findIndex(_e=>_e.status==="in_progress");if(ee===-1){v.warn("[V2 Signature Listener] No current step in_progress",{projectType:X});return}const ie=(Re=Y[ee])==null?void 0:Re.name;if(!ie){v.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:ee});return}const ve=ps(ie);if((ve==null?void 0:ve.completionTrigger)!=="signature"){v.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:ie,completionTrigger:(ve==null?void 0:ve.completionTrigger)||"null"});return}v.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:X,currentStepIdx:ee,stepName:ie});try{await g(t.id,X,ee,Y),G({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${ie}"`,className:"bg-green-500 text-white"})}catch(_e){v.error("[V2 Signature Listener] Error completing step",_e)}}).subscribe();return()=>{je.removeChannel(c)}},[t.id,d,g]);const De=c=>{xe(c),ne(b=>(b.set("project",c),b),{replace:!0})},_=async c=>{if(!H||!t.id)return;const b=R;q(c);try{const{error:A}=await je.from("project_infos").upsert({prospect_id:t.id,project_type:H,status:c,data:(ae==null?void 0:ae.data)||{}},{onConflict:"prospect_id,project_type"});if(A)throw A;const O={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:X}=await je.from("project_history").insert({prospect_id:t.id,project_type:H,event_type:"status",description:`Projet ${O[c]||c}`,organization_id:D==null?void 0:D.organization_id,metadata:{old_status:b,new_status:c}});X&&v.error("Erreur historique:",X),$(t.id,H,(Y={})=>({...Y,status:c})),le(Y=>({...Y,[H]:c})),G({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${O[c]}".`,className:"bg-green-500 text-white"})}catch(A){v.error("Erreur lors du changement de statut:",A),q(b),G({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},ye=c=>{te(c)},de=c=>{if(!H)return;const b=c.replace(",",".").trim();if(b===""){$(t.id,H,(X={})=>{if(!X.amount)return X;const Y={...X};return delete Y.amount,Y}),te("");return}const A=parseFloat(b);if(Number.isNaN(A)||A<0){te(U==null?"":U.toString());return}const O=Math.round(A*100)/100;$(t.id,H,(X={})=>({...X,amount:O})),te(O.toFixed(2))},we=()=>{de(Z),me(!1)},Se=c=>{c.key==="Enter"&&(c.preventDefault(),de(c.currentTarget.value),c.currentTarget.blur(),me(!1))},Ae=async(c,b)=>{var O,X;const A=pe[c];if(b===Oe&&((O=A==null?void 0:A.subSteps)==null?void 0:O.length)>0&&!xr(A)){G({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(b===ke&&((X=A==null?void 0:A.subSteps)==null?void 0:X.length)>0){const Y=JSON.parse(JSON.stringify(pe)),ee=Y[c];ee.status=ke,ee.subSteps=ee.subSteps.map((ie,ve)=>({...ie,status:ve===0?ke:ze})),await T(H,Y),K&&await K({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${ee.name} ¬ª`,metadata:{step_id:(ee==null?void 0:ee.id)||null,step_name:(ee==null?void 0:ee.name)||null,previous_status:(A==null?void 0:A.status)||null,new_status:ke,project_type:H},createdBy:P,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)});return}if(b===Oe){const Y=JSON.parse(JSON.stringify(pe));Y[c].status="completed";let ee=c+1;if(ee<Y.length&&(Y[ee].status="in_progress"),await T(H,Y),K){const ie=ee<Y.length?Y[ee]:null;await K({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:A&&ie?`√âtape ¬´ ${A.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${ie.name} ¬ª`:`√âtape ¬´ ${A.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(A==null?void 0:A.id)||null,previous_step_name:(A==null?void 0:A.name)||null,previous_step_status:(A==null?void 0:A.status)||null,new_step_id:(ie==null?void 0:ie.id)||null,new_step_name:(ie==null?void 0:ie.name)||null,new_step_status:"in_progress",project_type:H},createdBy:P,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}if(ee<Y.length&&Y[ee].globalStepId){const ie=Y[ee].globalStepId,ve={...t,status:ie};a(ve),G({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const Y=pe.map((ie,ve)=>{let Re=ie.status;return ve===c&&(Re=b),{...ie,status:Re}});if(await T(H,Y),K){const ie=Y[c];await K({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${ie.name} ¬ª pass√©e de ¬´ ${A.status==="pending"?"√Ä venir":A.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${b==="pending"?"√Ä venir":b==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(ie==null?void 0:ie.id)||null,step_name:(ie==null?void 0:ie.name)||null,previous_status:(A==null?void 0:A.status)||null,new_status:b,project_type:H},createdBy:P,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}const ee=Y[c];if(ee.globalStepId&&b==="in_progress"){const ie={...t,status:ee.globalStepId};a(ie)}}},fe=async c=>{var A,O;const b=W.tags||[];if(!b.includes(c)){const X={...W,tags:[...b,c]};if(o(X),a(X),xe(c),y&&t.id===y.id&&!f.includes(c)){const ee=[...f,c];L(ee)}const Y=(A=w[c])==null?void 0:A.steps;if(Y&&Y.length>0)try{const ee=JSON.parse(JSON.stringify(Y));ee[0].status="in_progress",await T(c,ee),v.debug("Steps initialized in Supabase",{projectType:c})}catch(ee){v.error("Steps initialization error:",ee)}G({title:"‚úÖ Projet ajout√© !",description:`Le projet ${(O=w[c])==null?void 0:O.title} a √©t√© associ√© au prospect.`})}z(!1)},oe=()=>{const c=W.tags||[];return Object.values(w).filter(b=>b.isPublic&&!c.includes(b.type))},re=async c=>{switch(c){case"Appel":W.phone&&(window.location.href=`tel:${W.phone}`);break;case"Mail":W.email&&(window.location.href=`mailto:${W.email}`);break;case"WhatsApp":if(W.phone){const b=W.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${b}`,"_blank")}else G({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const b=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${b}`:window.open(`https://www.google.com/maps/search/?api=1&query=${b}`,"_blank")}break;case"Invitation":if(!W.email){G({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const b=`${window.location.origin}/dashboard`,A=B||(D==null?void 0:D.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",W.email,"org:",A);const{error:O}=await je.auth.signInWithOtp({email:W.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:b,data:{organization_id:A}}});O?(console.error("[handleActionClick] ‚ùå Magic link error:",O),G({title:"‚ùå Erreur envoi invitation",description:O.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",W.email),G({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${W.email}`,className:"bg-green-500 text-white"}))}catch(b){console.error("[handleActionClick] üí• Exception:",b),G({title:"‚ùå Erreur",description:b.message,variant:"destructive"})}break;default:G({title:`Action: ${c}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},l=()=>{const c=window.scrollY;he(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:c,behavior:"instant"})})})},E=()=>{try{a(W),he(!1),G({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(c){v.error("‚ùå Erreur sauvegarde:",c),G({title:"‚ùå Erreur",description:c.message,variant:"destructive"})}},V=(c,b)=>{o(A=>({...A,[c]:b}))},se=c=>{let b=c;c==="unassigned"?b=null:c==="user-1"&&P&&(b=P),o(A=>({...A,ownerId:b}))};return w[H],n.useEffect(()=>{const c=document.createElement("style");return c.id="disable-auto-scroll",c.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(c),()=>{const b=document.getElementById("disable-auto-scroll");b&&b.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Qe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(be,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Os,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:W.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(be,{size:"icon",className:"rounded-full",onClick:()=>z(!0),children:e.jsx(Tt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(W.tags||[]).map(c=>{var A;const b=u[c]||"actif";return e.jsxs("button",{onClick:()=>De(c),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${H===c?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((A=w[c])==null?void 0:A.title)||c}),b==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${H===c?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),b==="archive"&&e.jsx("span",{className:`text-xs font-medium ${H===c?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},c)}),(!W.tags||W.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Rt,label:"WhatsApp"},{icon:wt,label:"GPS"},{icon:zs,label:"Invitation",highlight:!W.userId}].map(({icon:c,label:b,highlight:A})=>e.jsxs("button",{onClick:()=>re(b),className:`flex flex-col items-center space-x-1 transition-colors group ${A?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${A?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(c,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:b})]},b))})]}),e.jsx(vr,{prospectId:t.id,projectType:H}),e.jsx(br,{prospect:W,projectType:H,supabaseSteps:d,v2Templates:S,onUpdate:c=>{o(c),a&&a(c)}}),e.jsx(jr,{prospect:W,projectType:H,onUpdate:c=>{o(c),a&&a(c)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),J?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:E,children:e.jsx(qt,{className:"h-4 w-4"})}),e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>he(!1),children:e.jsx(Je,{className:"h-4 w-4"})})]}):e.jsx(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:l,children:e.jsx(ft,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[I.map(c=>e.jsxs("div",{className:"flex items-start space-x-3",children:[yr(c),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{htmlFor:c.id,className:"text-xs text-gray-500",children:c.name.replace("*","")}),J?e.jsx(He,{id:c.id,name:c.id,type:c.type,value:W[c.id]||"",onChange:b=>V(c.id,b.target.value),className:"h-8 text-sm",placeholder:c.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:W[c.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},c.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"Suivi par"}),J?e.jsx(la,{options:Ie,value:W.ownerId||"unassigned",onSelect:se,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((Ne=N.find(c=>c.user_id===W.ownerId))==null?void 0:Ne.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(or,{prospectId:t.id,projectType:H,currentStep:Ee,statusConfig:it,activeAdminUser:D,children:H&&e.jsx(pr,{prospectId:t.id,projectType:H,currentStepIndex:Pe!==-1?Pe:0,activeAdminUser:D})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[H&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>me(!ge),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:ge?"Annuler":"Modifier le montant",children:ge?e.jsx(Je,{className:"h-4 w-4 text-gray-600"}):e.jsx(ft,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),ge?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(He,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:Z,onChange:c=>ye(c.target.value),onKeyDown:Se,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(be,{size:"sm",onClick:we,className:"h-8",children:e.jsx(gt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof U=="number"?Q.format(U):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Ft,{value:R,onValueChange:_,children:[e.jsx($t,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${R==="actif"?"bg-green-100 text-green-700":R==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Mt,{})}),e.jsxs(Lt,{className:"w-44",children:[e.jsx($e,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx($e,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx($e,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(fr,{steps:pe,onUpdateStatus:Ae,prompts:j,projectType:H,currentStepIndex:Pe,prospectId:t.id,completeStepAndProceed:g})]})]})]})]}),e.jsx(bt,{open:F,onOpenChange:z,children:e.jsxs(jt,{className:"sm:max-w-md",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Ajouter un projet"}),e.jsx(fs,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:oe().length>0?oe().map(c=>e.jsxs(be,{variant:"outline",onClick:()=>fe(c.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:c.icon}),e.jsx("span",{className:"font-medium",children:c.title})]},c.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},vr=({prospectId:t,projectType:s})=>{var K;const{activeAdminUser:a,prospects:r,projectsData:m,appointments:g,agendaLoading:x,updateAppointment:h,deleteAppointment:w,addAppointment:I,addCall:y,addTask:f,updateCall:L,updateTask:p}=Be(),{users:$,loading:D}=mt(),{supabaseUserId:j}=rt(),[C,P]=n.useState(null),[N,i]=n.useState(null),[d,T]=n.useState(null),[B,S]=n.useState(!1),[M,ne]=n.useState(null),ce=n.useMemo(()=>!g||g.length===0?[]:g.filter(J=>{var W;if(J.contactId!==t||s&&J.projectId!==s)return!1;const he=(W=J.status)==null?void 0:W.toLowerCase();return!(he!=="pending"&&he!=="prevu")}).sort((J,he)=>{const W=new Date(J.start),o=new Date(he.start);return W-o}),[g,t,s]),ue=(k,J)=>{T(k)},H=()=>{P(null),i(null),T(null)},xe=k=>{T(null),ne({...k,type:k.type}),S(!0)};return x?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(K=m[s])==null?void 0:K.title})`]})}),ce.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:ce.map(k=>{const J=new Date(k.start),he={physical:{icon:ot,color:"blue",label:"üìç RDV"},virtual:{icon:ot,color:"purple",label:"üé• Visio"},call:{icon:at,color:"green",label:"üìû Appel"},task:{icon:gt,color:"yellow",label:"‚úÖ T√¢che"}},W=he[k.type]||he.physical,o=W.icon,F={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},z={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>ue(k,k.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${W.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(o,{className:`h-5 w-5 text-${W.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:k.title||W.label}),k.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:k.notes}),k.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",k.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${W.color}-700 bg-${W.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Ze(J,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Ze(J,"HH:mm")})]})]}),z[k.status]&&k.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${F[k.status]}`,children:z[k.status]})]},k.id)})})]}),e.jsx(wr,{event:d,onClose:H,onReport:()=>{},onEdit:xe,prospects:r,supabaseUsers:$,updateAppointment:h,deleteAppointment:w,projectsData:m}),B&&e.jsx(js,{open:B,onOpenChange:k=>{k||ne(null),S(k)},initialData:M||{contactId:t,projectId:s},defaultAssignedUserId:j,addAppointment:I,addCall:y,addTask:f,updateAppointment:h,updateCall:L,updateTask:p,prospects:r||[],users:$||[],projectsData:m||{}})]})},wr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:m,supabaseUsers:g,updateAppointment:x,deleteAppointment:h,projectsData:w})=>{var N;const[I,y]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!m||!g||!x||!h||!w)return null;const f=m.find(i=>i.id===t.contactId),L=g.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(f?g.find(i=>i.user_id===f.ownerId):null),p=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",$=(i,d,T={})=>{try{const B=new Date(i);return isNaN(B.getTime())?"Date invalide":Ze(B,d,T)}catch{return"Date invalide"}},D=i=>{y(i),x(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},j=()=>{h(t.id),G({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},C=i=>{if(!f){G({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":f.phone&&(window.location.href=`tel:${f.phone}`);break;case"Mail":f.email&&(window.location.href=`mailto:${f.email}`);break;case"WhatsApp":if(f.phone){let d=f.phone.replace(/\D/g,"");d.startsWith("0")&&(d=`33${d.substring(1)}`);const T=encodeURIComponent("Bonjour");window.open(`https://wa.me/${d}?text=${T}`,"_blank")}break;case"GPS":if(f.address){const d=encodeURIComponent(f.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${d}`:window.open(`https://www.google.com/maps/search/?api=1&query=${d}`,"_blank")}break;default:G({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},P={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p($(t.start,"eeee d MMMM",{locale:Ve}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Ve})," - ",$(t.end,"HH:mm",{locale:Ve})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),f&&e.jsxs("p",{className:"text-sm",children:[f.name," (Client)"]}),L&&e.jsxs("p",{className:"text-sm",children:[L.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Rt,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:i,label:d})=>e.jsxs("button",{onClick:()=>C(d),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:d})]},d))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${P[I].color}`,children:e.jsxs(Ft,{onValueChange:D,value:I,children:[e.jsx($t,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Mt,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx($e,{value:"effectue",children:"Effectu√©"}),e.jsx($e,{value:"annule",children:"Annul√©"}),e.jsx($e,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((N=w[t.projectId])==null?void 0:N.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(f==null?void 0:f.name)||"N/A"})]})]})]}),e.jsxs(Ot,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(rs,{children:[e.jsx(ns,{asChild:!0,children:e.jsxs(be,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsx(os,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(cs,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ds,{children:[e.jsx(us,{children:"Annuler"}),e.jsx(ms,{onClick:j,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(be,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})};function Sr(t,s){const a=t.prospect,r=s.prospect;return!a||!r?!1:a.id===r.id&&(a.updatedAt||a.updated_at)===(r.updatedAt||r.updated_at)}const _r=ht.memo(Nr,Sr),ts=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Ir=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",Ge=t=>(t||"").toString().trim().toUpperCase(),Cr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},kr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],ss=50,as=50,qr=()=>{var oe,re;const t=Be(),[s,a]=hs(),{organizationId:r}=ut(),[m,g]=n.useState(null),[x,h]=n.useState(!1),[w,I]=n.useState("all"),[y,f]=n.useState(null),[L,p]=n.useState(!1),[$,D]=n.useState([]),[j,C]=n.useState(!1),P=n.useRef(null),[N,i]=n.useState(""),d=n.useRef(null),[T,B]=n.useState(!1),[S,M]=n.useState(!1),[ne,ce]=n.useState({}),{users:ue,loading:H}=mt(),{authUserId:xe}=rt(),K=t==null?void 0:t.addProspect,{prospects:k=[],prospectsLoading:J=!0,allProjectSteps:he={},allStepsLoading:W=!0,updateProspect:o=async()=>{},projectsData:F={},activeAdminUser:z=null,users:ae={},globalPipelineSteps:R=[],pipelineLoading:q=!0,getProjectSteps:u=()=>[],adminReady:le=!1}=t||{},U=n.useMemo(()=>ue.reduce((l,E)=>(l[E.user_id]={id:E.id,user_id:E.user_id,name:E.name,email:E.email,role:E.role,phone:E.phone,avatarUrl:E.avatar_url,managerId:E.manager_id,accessRights:E.access_rights},l),{}),[ue]);n.useEffect(()=>{le&&!J&&!W&&!S&&M(!0)},[le,J,W,S]);const Q=k,Z=o,te=(k==null?void 0:k.find(l=>l.id===m))||null,ge=n.useMemo(()=>!R||R.length===0?kr:R.map((l,E)=>{const V=Ge(l.label),se=l.color||Cr[V]||ts[E%ts.length];return{id:l.id,label:l.label,name:Ir(l.label),color:se}}),[R]),me=n.useMemo(()=>{if(!z)return[];if(z.role==="Global Admin"||z.role==="Admin")return Object.values(U);const l=z.access_rights||z.accessRights,E=[z.user_id,...(l==null?void 0:l.users)||[]];return Object.values(U).filter(V=>E.includes(V.user_id))},[z,U]),Ie=n.useMemo(()=>{const l=me.map(E=>({value:E.user_id,label:E.name}));return me.length>1?[{value:"all",label:"Tous les utilisateurs"},...l]:l},[me]);n.useEffect(()=>{z&&y===null&&(me.length>1?f("all"):me.length===1&&f(me[0].user_id))},[z,y,me]),n.useEffect(()=>{if(!j)return;const l=E=>{P.current&&!P.current.contains(E.target)&&C(!1)};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[j]);const pe=n.useMemo(()=>{const l=new Set;return Q.forEach(E=>{(E.tags||[]).forEach(V=>l.add(V))}),Array.from(l)},[Q]),Pe=$.length===0?"Tags":$.length===1?((oe=F[$[0]])==null?void 0:oe.title)||$[0]:`${$.length} tags`,Ee=n.useMemo(()=>{const l=Q.filter(V=>{if(!z)return!1;if(z.role==="Global Admin"||z.role==="Admin")return!0;const se=z.access_rights||z.accessRights;return[z.user_id,...(se==null?void 0:se.users)||[]].includes(V.ownerId)});v.debug("[FinalPipeline] Prospects count",{total:Q.length,visible:l.length});let E=l;if($.length>0&&(E=E.filter(V=>{const se=V.tags||[];return $.some(Ne=>se.includes(Ne))})),y&&y!=="all"&&(E=E.filter(V=>V.ownerId===y)),N.trim()){const V=N.toLowerCase();E=E.filter(se=>(se.name||"").toLowerCase().includes(V)||(se.email||"").toLowerCase().includes(V)||(se.city||"").toLowerCase().includes(V)||(se.phone||"").toLowerCase().includes(V))}return w==="mine"&&xe?E.filter(V=>V.ownerId===xe):E},[Q,w,xe,y,$,N]),{stagesWithCounts:De,prospectsByStage:_}=n.useMemo(()=>{var A;const l=ge.reduce((O,X)=>(O[X.id]=[],O),{}),E=((A=ge[0])==null?void 0:A.id)||"fallback-stage",V=new Set(ge.map(O=>O.id)),se=new Map(ge.map(O=>[Ge(O.label),O.id])),Ne=O=>{const X=[];return O.projectType&&F[O.projectType]&&X.push(O.projectType),Array.isArray(O.tags)&&O.tags.forEach(Y=>{F[Y]&&!X.includes(Y)&&X.push(Y)}),X},c=O=>{const X=[];if(!R.length){const ee=O.stage||E,ie=V.has(ee)?ee:E;return X.push({stageId:ie,prospect:O}),X}if(typeof u!="function")return X.push({stageId:E,prospect:O}),X;const Y=Ne(O);return Y.length?(Y.forEach(ee=>{var nt;const ie=`${O.id}-${ee}`,ve=he[ie]||(typeof u=="function"?u(O.id,ee):[])||[],Re=((nt=F[ee])==null?void 0:nt.steps)||[];if(!ve.length){X.push({stageId:E,prospect:O,projectType:ee});return}const _e=ve.find(qe=>qe.status==="in_progress"||qe.status==="current")||ve.find(qe=>qe.status==="pending")||ve[ve.length-1];if(!_e){X.push({stageId:E,prospect:O,projectType:ee});return}const We=(()=>{if(_e.globalStepId&&V.has(_e.globalStepId))return _e.globalStepId;if(_e.globalStepId){const Ke=Ge(_e.globalStepId),Te=se.get(Ke);if(Te&&V.has(Te))return Te}const qe=ve.indexOf(_e);let Ce=null;if(qe>=0&&Re[qe]&&(Ce=Re[qe]),!Ce){const Ke=Ge(_e.name||_e.label);Ce=Re.find(Te=>Ge(Te.name||Te.label)===Ke)}if(Ce!=null&&Ce.globalStepId&&V.has(Ce.globalStepId))return Ce.globalStepId;if(Ce!=null&&Ce.globalStepId){const Ke=Ge(Ce.globalStepId),Te=se.get(Ke);if(Te&&V.has(Te))return Te}if(Ce&&(Ce.label||Ce.name)){const Ke=Ge(Ce.label||Ce.name),Te=se.get(Ke);if(Te&&V.has(Te))return Te}const _t=Ge(_e.label||_e.name),Ye=se.get(_t);return Ye&&V.has(Ye)?Ye:E})();X.push({stageId:We,prospect:O,projectType:ee,activeStep:_e})}),X):(X.push({stageId:E,prospect:O}),X)};return Ee.forEach(O=>{c(O).forEach(({stageId:Y,projectType:ee,activeStep:ie})=>{l[Y]||(l[Y]=[]),l[Y].push({prospect:O,projectType:ee,activeStep:ie})})}),{stagesWithCounts:ge.map(O=>{var X;return{...O,count:((X=l[O.id])==null?void 0:X.length)||0}}),prospectsByStage:l}},[ge,Ee,R,u,F]);n.useEffect(()=>{const l=s.get("prospect"),E=s.get("project"),V=`${l}-${E}`;if(d.current===V)return;if(!l){m!==null&&(g(null),d.current=null);return}(Q.find(Ne=>Ne.id===l)||null)&&(g(l),d.current=V)},[s,Q]);const ye=l=>{D(E=>E.includes(l)?E.filter(V=>V!==l):[...E,l])},de=n.useCallback((l,E)=>{g(l.id),a(V=>{const se=new URLSearchParams(V);return se.set("prospect",l.id),E?se.set("project",E):se.delete("project"),se})},[a]),we=n.useCallback(l=>{ce(E=>({...E,[l]:(E[l]||ss)+as}))},[]),Se=()=>{g(null);const l=new URLSearchParams(s);l.delete("prospect"),l.delete("project"),a(l)},Ae=async l=>{var E,V;try{if(!K)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const se=((E=R[0])==null?void 0:E.step_id)||((V=R[0])==null?void 0:V.id);console.log("[handleAddProspect] calling addProspect",{name:l.name,email:l.email,status:se,ownerId:z==null?void 0:z.user_id,sendInvitation:l.sendInvitation,allData:l});const Ne=await K({...l,status:se,ownerId:z==null?void 0:z.user_id});if(console.log("[handleAddProspect] result",Ne),!(Ne!=null&&Ne.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:l.sendInvitation,email:Ne.email,willSend:l.sendInvitation&&Ne.email}),l.sendInvitation&&Ne.email)try{const c=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",Ne.email.trim(),"redirect:",c,"org:",r);const{error:b}=await je.auth.signInWithOtp({email:Ne.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:c,data:{organization_id:r}}});b?(console.error("[handleAddProspect] ‚ùå invitation error",b),G({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${b.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",Ne.email),G({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${Ne.email}`,className:"bg-green-500 text-white"}))}catch(c){console.error("[handleAddProspect] üí• invitation exception",c),G({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${c.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:l.sendInvitation?"no email":"sendInvitation=false"});h(!1)}catch(se){console.error("‚ùå handleAddProspect error",se),G({title:"Erreur",description:se.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},fe=l=>{try{Z&&(Z(l),G({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{G({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return te&&te.id?e.jsx(Qe.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Xs,{name:"Fiche Prospect",children:e.jsx(_r,{prospect:te,onBack:Se,onUpdate:fe,onEditingChange:B})})}):S?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(tt,{className:"w-4 h-4"}),e.jsxs("span",{children:[Ee.length," prospect",Ee.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:P,className:"relative inline-block text-left",children:[e.jsxs(be,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>C(l=>!l),children:[e.jsx("span",{children:Pe}),e.jsx(Ct,{className:"h-4 w-4"})]}),j&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[pe.map(l=>{var E;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:$.includes(l),onChange:()=>ye(l),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((E=F[l])==null?void 0:E.title)||l})]},l)}),$.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>D([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(Ys,{open:L,onOpenChange:p,children:[e.jsx(Ks,{asChild:!0,children:e.jsxs(be,{variant:"outline",role:"combobox","aria-expanded":L,className:"w-[230px] justify-between",children:[e.jsx(tt,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:y==="all"?"Tous les utilisateurs":((re=U[y])==null?void 0:re.name)||"Utilisateur"}),e.jsx(Ct,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(Qs,{className:"w-[200px] p-0",children:e.jsxs(Zs,{children:[e.jsx(Us,{placeholder:"Rechercher..."}),e.jsxs(ea,{children:[e.jsx(ta,{children:"Aucun utilisateur"}),e.jsx(sa,{children:Ie.map(l=>e.jsxs(aa,{value:l.label,onSelect:()=>{f(l.value),p(!1)},children:[e.jsx(gt,{className:Ue("mr-2 h-4 w-4",y===l.value?"opacity-100":"opacity-0")}),l.label]},l.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ra,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(He,{type:"text",placeholder:"Rechercher un prospect...",value:N,onChange:l=>i(l.target.value),className:"pl-9 pr-4"}),N&&e.jsx("button",{onClick:()=>i(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(be,{onClick:()=>h(!0),children:[e.jsx(Tt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:De.map(l=>e.jsxs(Qe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${l.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:l.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(_[l.id]||[]).filter(E=>{if($.length===0)return!0;const{projectType:V}=E;return $.some(se=>se.toUpperCase()===(V||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const E=(_[l.id]||[]).filter(b=>{if($.length===0)return!0;const{projectType:A}=b;return $.some(O=>O.toUpperCase()===(A||"").toUpperCase())}),V=ne[l.id]||ss,se=E.slice(0,V),Ne=E.length>V,c=E.length-V;return e.jsxs(e.Fragment,{children:[se.map((b,A)=>{var We;const{prospect:O,projectType:X,activeStep:Y}=b,ee=`${O.id}-${X||"default"}-${l.id}-${A}`,ie=O.projectType||O.tags&&O.tags[0]||"Projet",ve=X&&((We=F[X])!=null&&We.title)?F[X].title:ie,Re=(Y==null?void 0:Y.label)||(Y==null?void 0:Y.name)||l.name,_e=l.color||"bg-blue-100 text-blue-700",Xe=`${O.id}-${X||ve}-${l.id}-${A}`;return e.jsx(Qe.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(Ua,{prospect:{...O,_projectContext:{projectType:X||ie,projectTitle:ve,stepLabel:Re,projectColor:_e}},onClick:()=>de(O,X||O.projectType||(Array.isArray(O.tags)?O.tags[0]:ie)),compact:!0,sortableId:Xe,projectsData:F})},ee)}),Ne&&e.jsxs("button",{onClick:()=>we(l.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(c,as)," de plus (",c," restants)"]}),E.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(tt,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},l.id))})})}),e.jsx(na,{open:x,onOpenChange:h,onAddProspect:Ae}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(l=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},l))})})})]})};export{qr as default};
