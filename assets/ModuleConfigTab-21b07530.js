import{c as Se,r as d,j as e,$ as b,W as Re,B as _,ax as ne,f as Me,g as ze,b2 as re,N as te,U as Ae,ab as Z,a0 as qe,b3 as oe,b4 as ae,b5 as Le,b6 as Ie,a6 as De,aT as ce,a1 as W,R as Ve,_ as Je,X as le,aM as Be,Z as ie,P as $e,b7 as Ue,O as Pe,T as Ge,L as z,b8 as Ke,b9 as He,ba as Xe,s as H}from"./index-1b6444d8.js";import{d as We,b as Ze,g as he,e as Qe,v as Ye,P as ke,f as es,h as ss,i as ts,j as rs,S as fe,a as as,F as be}from"./useSupabaseWorkflowModuleTemplates-1ea36ef7.js";import{i as ns}from"./workflowV2Config-f801420c.js";import{R as je}from"./rocket-e62b5a10.js";import{D as ls}from"./download-b1c2a3d7.js";const Ne=Se("BookOpen",[["path",{d:"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z",key:"vv98re"}],["path",{d:"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",key:"1cyq3y"}]]),de=Se("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);function is({moduleId:s,projectType:x,prospectId:n,actionConfig:r,availableForms:g=[],availableTemplates:f=[],className:L}){var k;const[E,$]=d.useState(!1),[l,T]=d.useState(null),[U,F]=d.useState(!1),[p,j]=d.useState(null),[R,V]=d.useState(!1),[A,M]=d.useState(null),X=n||"mock-prospect-"+Date.now().toString(36),u=d.useMemo(()=>ns(),[]),i=d.useMemo(()=>n&&!n.startsWith("mock-"),[n]),O=d.useMemo(()=>!(!r||!r.actionType||!r.targetAudience),[r]),v=d.useMemo(()=>l?u?i?l.actionType==="SIGNATURE"&&!(l.templateIds||[]).length?{canExecute:!1,reason:"S√©lectionnez un template pour g√©n√©rer le contrat"}:We(l):{canExecute:!1,reason:"prospectId r√©el requis"}:{canExecute:!1,reason:"Flag EXECUTION_FROM_V2 d√©sactiv√©"}:{canExecute:!1,reason:"G√©n√©rez d'abord un ActionOrder"},[l,u,i]),P=d.useCallback(m=>m.map(C=>{const I=g.find(K=>K.id===C);return I?I.name:C}),[g]),q=d.useCallback(m=>m.map(C=>{const I=f.find(K=>K.id===C);return I?I.name:C}),[f]),J=d.useCallback(()=>{j(null),F(!1);try{const m=Ze({moduleId:s,projectType:x,prospectId:X,actionConfig:r,message:`Action ${r.actionType} g√©n√©r√©e par V2 Simulator`});T(m),$(!0),console.log("[V2 Simulator] ActionOrder g√©n√©r√©",m)}catch(m){j(m.message),T(null)}},[s,x,X,r]),a=d.useCallback(()=>{if(!l)return;const m=he(l);navigator.clipboard.writeText(m).then(()=>{F(!0),setTimeout(()=>F(!1),2e3)})},[l]),o=d.useCallback(async()=>{if(l&&v.canExecute){V(!0),M(null),j(null);try{const m={...l,_meta:{...l._meta,isSimulation:!1}};console.log("[V2 Simulator] üöÄ Ex√©cution V2‚ÜíV1",m);const C=await Qe(m);M(C),console.log("[V2 Simulator] R√©sultat ex√©cution",C)}catch(m){j(`Erreur ex√©cution: ${m.message}`),M({success:!1,status:"error",message:m.message})}finally{V(!1)}}},[l,v]),y=d.useMemo(()=>l?Ye(l):null,[l]);return e.jsxs("div",{className:b("border rounded-lg overflow-hidden",L),children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-blue-50 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5 text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:u?"ActionOrder V2‚ÜíV1":"Simulation ActionOrder"}),e.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium bg-purple-100 text-purple-700 rounded",children:"V2"}),u&&e.jsxs("span",{className:"px-1.5 py-0.5 text-[10px] font-medium bg-green-100 text-green-700 rounded flex items-center gap-1",children:[e.jsx(je,{className:"h-3 w-3"}),"EXEC ON"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_,{size:"sm",variant:O?"default":"outline",onClick:J,disabled:!O,className:b("gap-1.5",O&&"bg-purple-600 hover:bg-purple-700"),children:[e.jsx(ne,{className:"h-4 w-4"}),"Simuler"]}),u&&l&&e.jsx(_,{size:"sm",variant:v.canExecute?"default":"outline",onClick:o,disabled:!v.canExecute||R,className:b("gap-1.5",v.canExecute&&"bg-green-600 hover:bg-green-700"),title:v.canExecute?"Ex√©cuter via V1":v.reason,children:R?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Ex√©cution..."]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-4 w-4"}),"Ex√©cuter"]})}),l&&e.jsx("button",{onClick:()=>$(!E),className:"p-1.5 hover:bg-white/50 rounded transition-colors",children:E?e.jsx(Me,{className:"h-4 w-4 text-gray-500"}):e.jsx(ze,{className:"h-4 w-4 text-gray-500"})})]})]}),p&&e.jsx("div",{className:"p-3 bg-red-50 border-b border-red-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{children:p})]})}),(l==null?void 0:l.actionType)==="SIGNATURE"&&!((k=l.templateIds)!=null&&k.length)&&e.jsx("div",{className:"p-3 bg-amber-50 border-b border-amber-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-700",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"‚ö†Ô∏è S√©lectionnez un template pour g√©n√©rer le contrat"})]})}),l&&E&&e.jsxs("div",{className:"p-3 space-y-4 bg-white",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-2 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:"Action"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[l.actionType==="FORM"?e.jsx(te,{className:"h-4 w-4 text-blue-600"}):e.jsx(ke,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:l.actionType})]})]}),e.jsxs("div",{className:"p-2 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:"Cible"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ae,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:l.target})]})]})]}),l.formIds.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:["Formulaires (",l.formIds.length,")"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:P(l.formIds).map((m,C)=>e.jsx("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs",children:m},C))})]}),l.actionType==="SIGNATURE"&&l.templateIds.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:["Templates contrat (",l.templateIds.length,")"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:q(l.templateIds).map((m,C)=>e.jsx("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs",children:m},C))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:"Message"}),e.jsxs("div",{className:"text-sm text-gray-600 italic",children:['"',l.message,'"']})]}),e.jsxs("div",{className:"flex gap-4 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Gestion: "}),e.jsx("span",{className:"font-medium text-gray-700",children:l.managementMode==="AI"?"‚ú® IA":"üë§ Humain"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"V√©rification: "}),e.jsx("span",{className:"font-medium text-gray-700",children:l.verificationMode==="AI"?"‚ú® IA":"üë§ Humain"})]})]}),y&&!y.valid&&e.jsxs("div",{className:"p-2 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-amber-700",children:[e.jsx(re,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"font-medium",children:"Avertissements:"})]}),e.jsx("ul",{className:"mt-1 text-xs text-amber-600 list-disc list-inside",children:y.errors.map((m,C)=>e.jsx("li",{children:m},C))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase",children:"JSON ActionOrder"}),e.jsx(_,{size:"sm",variant:"ghost",onClick:a,className:"h-6 px-2 text-xs gap-1",children:U?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"text-green-600",children:"Copi√©"})]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"h-3 w-3"}),"Copier"]})})]}),e.jsx("pre",{className:"p-2 bg-gray-900 text-gray-100 rounded-lg text-[10px] overflow-x-auto max-h-48 overflow-y-auto",children:he(l)})]}),A&&e.jsxs("div",{className:b("p-3 rounded-lg border",A.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[A.success?e.jsx(Z,{className:"h-4 w-4 text-green-600"}):e.jsx(re,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:b("text-sm font-medium",A.success?"text-green-700":"text-red-700"),children:A.success?"Ex√©cution r√©ussie":"√âchec ex√©cution"}),e.jsx("span",{className:b("px-1.5 py-0.5 text-[10px] font-medium rounded",A.status==="executed"&&"bg-green-100 text-green-700",A.status==="simulated"&&"bg-purple-100 text-purple-700",A.status==="blocked"&&"bg-amber-100 text-amber-700",A.status==="error"&&"bg-red-100 text-red-700"),children:A.status.toUpperCase()})]}),e.jsx("p",{className:"text-xs text-gray-600",children:A.message}),A.data&&e.jsx("pre",{className:"mt-2 p-2 bg-white/50 rounded text-[10px] text-gray-500 overflow-x-auto",children:JSON.stringify(A.data,null,2)})]}),e.jsx("div",{className:"pt-2 border-t text-center",children:u?e.jsxs("span",{className:"text-[10px] text-green-600 flex items-center justify-center gap-1",children:[e.jsx(oe,{className:"h-3 w-3"}),"Mode ex√©cution V2‚ÜíV1 activ√© (flag ON)"]}):e.jsx("span",{className:"text-[10px] text-gray-400",children:"‚ö†Ô∏è Simulation pure ‚Äî Aucune ex√©cution V1"})})]}),!l&&!p&&e.jsx("div",{className:"p-4 text-center text-xs text-gray-400",children:O?'Cliquez sur "Simuler" pour g√©n√©rer un ActionOrder':"Configurez d'abord le type d'action et la cible"})]})}const cs=[{id:"form_approved",label:"Formulaire valid√©",icon:"üìù",description:"L'√©tape est termin√©e quand un formulaire est approuv√©"},{id:"signature",label:"Signature compl√©t√©e",icon:"‚úçÔ∏è",description:"L'√©tape est termin√©e quand le contrat est sign√©"},{id:"checklist",label:"Checklist compl√©t√©e",icon:"‚úÖ",description:"L'√©tape est termin√©e quand toutes les cases sont coch√©es"},{id:"ia_confirmation",label:"Objectif atteint par √©change IA",icon:"‚ú®",description:"L'√©tape est termin√©e quand l'IA confirme l'objectif atteint"}],B=({icon:s,label:x,readOnly:n=!1,required:r=!1})=>e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[s&&e.jsx(s,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:x}),r&&e.jsx("span",{className:"text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded",children:"Requis"}),n&&e.jsx("span",{className:"text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded",children:"Lecture seule"})]}),ve=({value:s,onChange:x,placeholder:n,disabled:r=!1})=>e.jsx("input",{type:"text",value:s,onChange:g=>x(g.target.value),placeholder:n,disabled:r,className:b("w-full px-3 py-2 text-sm border rounded-lg","focus:ring-2 focus:ring-blue-500 focus:border-blue-500",r&&"bg-gray-50 text-gray-500 cursor-not-allowed")}),ye=({value:s,onChange:x,placeholder:n,rows:r=5,disabled:g=!1})=>e.jsx("textarea",{value:s,onChange:f=>x(f.target.value),placeholder:n,rows:r,disabled:g,className:b("w-full px-3 py-2 text-sm border rounded-lg resize-y","focus:ring-2 focus:ring-blue-500 focus:border-blue-500",g&&"bg-gray-50 text-gray-500 cursor-not-allowed")}),os=({action:s})=>{const x=Xe(s);return e.jsxs("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-full text-xs",title:x.description,children:[e.jsx("span",{children:x.icon}),e.jsx("span",{children:x.label})]})},ds=({selected:s,onChange:x,targets:n})=>e.jsx("div",{className:"grid grid-cols-3 gap-3",children:n.map(r=>{const f=(Array.isArray(s)?s[0]:s)===r.id;return e.jsxs("label",{className:b("flex items-center justify-center gap-2 px-4 py-3 rounded-lg border cursor-pointer transition-all",f?"bg-blue-50 border-blue-300 text-blue-700":"bg-white border-gray-200 text-gray-600 hover:border-gray-300"),children:[e.jsx("input",{type:"radio",name:"targetAudience",value:r.id,checked:f,onChange:()=>x(r.id),className:"sr-only"}),e.jsx("span",{className:"text-lg",children:r.icon}),e.jsx("span",{className:"text-sm font-medium",children:r.label}),f&&e.jsx(W,{className:"h-4 w-4 text-blue-600"})]},r.id)})}),xs=({selected:s,onChange:x,actionTypes:n})=>e.jsx("div",{className:"flex gap-3",children:n.map(r=>{const g=s===r.id,f=r.isMock;return e.jsxs("label",{className:b("flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-all flex-1 relative",g?"bg-purple-50 border-purple-300 text-purple-700":"bg-white border-gray-200 text-gray-600 hover:border-gray-300",f&&"opacity-75"),children:[e.jsx("input",{type:"radio",name:"actionType",value:r.id,checked:g,onChange:()=>x(r.id),className:"sr-only"}),e.jsx("span",{className:"text-lg",children:r.icon}),e.jsx("span",{className:"text-sm font-medium",children:r.label}),f&&e.jsx("span",{className:"text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-medium",children:"Bient√¥t"}),g&&e.jsx(W,{className:"h-4 w-4 text-purple-600"})]},r.id)})}),we=({selected:s=[],onChange:x,forms:n=[]})=>{if(n.length===0)return e.jsx("div",{className:"p-3 bg-gray-50 border border-dashed rounded-lg text-sm text-gray-400 italic",children:"Aucun formulaire disponible. Chargez les formulaires depuis Supabase."});const r=Array.isArray(s)?s:s?[s]:[],g=r.length>0?r[0]:null;return e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto border rounded-lg p-2",children:n.map(f=>{const L=g===f.id;return e.jsxs("label",{className:b("flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer transition-colors",L?"bg-blue-50 border border-blue-200":"hover:bg-gray-50"),children:[e.jsx("input",{type:"radio",name:"formSelection",checked:L,onChange:()=>{x([f.id])},className:"text-blue-600 focus:ring-blue-500"}),e.jsx(te,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm",children:f.name})]},f.id)})})},ms=({selected:s,onChange:x,templates:n=[]})=>n.length===0?e.jsx("div",{className:"p-3 bg-gray-50 border border-dashed rounded-lg text-sm text-gray-400 italic",children:"Aucun template disponible. Chargez les templates depuis Supabase."}):e.jsxs("select",{value:s||"",onChange:r=>x(r.target.value||null),className:"w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:[e.jsx("option",{value:"",children:"-- S√©lectionner un template --"}),n.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),Ce=({label:s,icon:x,selected:n,onChange:r,modes:g})=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[x&&e.jsx(x,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-600",children:s})]}),e.jsx("div",{className:"flex gap-2",children:g.map(f=>{const L=n===f.id;return e.jsxs("button",{type:"button",onClick:()=>r(f.id),className:b("flex items-center gap-1.5 px-3 py-1.5 rounded-lg border text-sm transition-all",L?"bg-indigo-50 border-indigo-300 text-indigo-700":"bg-white border-gray-200 text-gray-600 hover:border-gray-300"),children:[e.jsx("span",{children:f.icon}),e.jsx("span",{children:f.label})]},f.id)})})]}),us=({selected:s=[],onChange:x})=>{const n=[{id:"prospect_info",label:"Infos Prospect",icon:"üë§"},{id:"contract_history",label:"Historique Contrats",icon:"üìú"},{id:"forms_submitted",label:"Formulaires Soumis",icon:"üìù"},{id:"chat_history",label:"Historique Chat",icon:"üí¨"},{id:"documents",label:"Documents",icon:"üìÅ"},{id:"client_projects_history",label:"Historique projets (client)",icon:"üóÇÔ∏è"},{id:"commercial_activity",label:"Activit√© commerciaux",icon:"üìû"},{id:"partner_activity",label:"Activit√© partenaires",icon:"ü§ù"}];return e.jsx("div",{className:"flex flex-wrap gap-2",children:n.map(r=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border bg-green-50 border-green-300 text-green-700 cursor-default",title:"Activ√© par d√©faut (lecture seule)",children:[e.jsx("span",{children:r.icon}),e.jsx("span",{children:r.label})]},r.id))})},gs=({isComplete:s,details:x})=>e.jsx("div",{className:b("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium",s?"bg-green-100 text-green-700":"bg-orange-100 text-orange-700"),title:x,children:s?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Config compl√®te"]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-3.5 w-3.5"}),"Config incompl√®te"]})}),ps=({selected:s,onChange:x})=>e.jsx("div",{className:"space-y-2",children:cs.map(n=>{const r=s===n.id;return e.jsxs("label",{className:b("flex items-start gap-3 p-3 rounded-xl border cursor-pointer transition-all",r?"bg-green-50 border-green-300 shadow-sm":"bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50"),children:[e.jsx("input",{type:"radio",name:"completionTrigger",value:n.id,checked:r,onChange:()=>x(n.id),className:"sr-only"}),e.jsx("span",{className:"text-xl mt-0.5",children:n.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:b("text-sm font-medium",r?"text-green-800":"text-gray-700"),children:n.label}),e.jsx("p",{className:b("text-xs mt-0.5",r?"text-green-600":"text-gray-500"),children:n.description})]}),r&&e.jsx(W,{className:"h-5 w-5 text-green-600 flex-shrink-0 mt-0.5"})]},n.id)})}),hs=({selectedFormIds:s=[],availableForms:x=[],requiredFields:n=[],reminderConfig:r={enabled:!1,delayDays:1},onRequiredFieldsChange:g,onReminderConfigChange:f})=>{const[L,E]=d.useState(!1),[$,l]=d.useState(!1),[T,U]=d.useState([]),[F,p]=d.useState({enabled:!1,delayDays:1,maxRemindersBeforeTask:3}),j=d.useMemo(()=>!s||s.length===0?null:x.find(i=>i.id===s[0]),[s,x]),R=d.useMemo(()=>j!=null&&j.fields?j.fields:[],[j]),V=()=>{U(n||[]),E(!0)},A=()=>{p({enabled:r.enabled||!1,delayDays:r.delayDays||1,maxRemindersBeforeTask:r.maxRemindersBeforeTask||3}),l(!0)},M=u=>{U(i=>i.includes(u)?i.filter(O=>O!==u):[...i,u])},X=()=>{g(T),E(!1),z({title:"‚úÖ Champs requis enregistr√©s",description:`${T.length} champ(s) obligatoire(s)`})};return!s||s.length===0?null:e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-start",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center p-6 bg-blue-50 border border-blue-200 rounded-lg min-h-[120px]",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("p",{className:"text-5xl font-bold text-blue-600",children:n.length}),e.jsx("p",{className:"text-sm font-medium text-blue-900 mt-2",children:n.length>1?"champs requis":n.length===1?"champ requis":"Aucun champ requis"})]}),e.jsxs(_,{variant:"outline",size:"sm",onClick:V,className:"border-blue-300 text-blue-700 hover:bg-blue-100",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"D√©finir"]})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center p-6 bg-purple-50 border border-purple-200 rounded-lg min-h-[120px]",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("p",{className:"text-5xl font-bold text-purple-600",children:r.enabled?r.maxRemindersBeforeTask||3:0}),e.jsx("p",{className:"text-sm font-medium text-purple-900 mt-2",children:r.enabled?`relance${(r.maxRemindersBeforeTask||3)>1?"s":""}`:"Relance d√©sactiv√©e"})]}),e.jsxs(_,{variant:"outline",size:"sm",onClick:A,className:"border-purple-300 text-purple-700 hover:bg-purple-100",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"Configurer"]})]}),L&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Champs requis pour validation"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Formulaire : ",e.jsx("span",{className:"font-medium",children:j==null?void 0:j.name})]})]}),e.jsx("button",{onClick:()=>E(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(le,{className:"h-5 w-5"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:R.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(de,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),e.jsx("p",{children:"Aucun champ disponible dans ce formulaire"})]}):e.jsx("div",{className:"space-y-2",children:R.map(u=>{const i=T.includes(u.id);return e.jsxs("label",{className:b("flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all",i?"bg-blue-50 border-blue-300":"bg-white border-gray-200 hover:bg-gray-50 hover:border-gray-300"),children:[e.jsx("input",{type:"checkbox",checked:i,onChange:()=>M(u.id),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:b("text-sm font-medium",i?"text-blue-900":"text-gray-700"),children:u.label}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[u.type," ",u.required&&"‚Ä¢ Obligatoire dans le formulaire"]})]}),i&&e.jsx(W,{className:"h-5 w-5 text-blue-600"})]},u.id)})})}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[T.length," champ(s) s√©lectionn√©(s)"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{variant:"outline",size:"sm",onClick:()=>E(!1),children:"Annuler"}),e.jsxs(_,{size:"sm",onClick:X,className:"bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Valider"]})]})]})]})}),$&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Configuration de la relance"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Si le formulaire n'est pas valid√©"})]}),e.jsx("button",{onClick:()=>l(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(le,{className:"h-5 w-5"})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-900",children:"Activer la relance"}),e.jsx("p",{className:"text-xs text-purple-600 mt-0.5",children:"Relancer automatiquement le client"})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:F.enabled,onChange:u=>p({...F,enabled:u.target.checked}),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"})]})]}),F.enabled&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"D√©lai de relance"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[1,2,3,4].map(u=>e.jsxs("button",{type:"button",onClick:()=>p({...F,delayDays:u}),className:b("px-3 py-2 text-sm font-medium rounded border transition-all",F.delayDays===u?"bg-purple-600 text-white border-purple-700":"bg-white text-purple-700 border-purple-300 hover:bg-purple-50"),children:["J+",u]},u))}),e.jsxs("p",{className:"text-xs text-purple-600 mt-2",children:["‚è±Ô∏è Relance envoy√©e J+",F.delayDays," si formulaire incomplet"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nombre de relances avant cr√©ation de t√¢che"}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:[1,2,3,4,5].map(u=>e.jsx("button",{type:"button",onClick:()=>p({...F,maxRemindersBeforeTask:u}),className:b("px-3 py-2 text-sm font-medium rounded border transition-all",F.maxRemindersBeforeTask===u?"bg-orange-600 text-white border-orange-700":"bg-white text-orange-700 border-orange-300 hover:bg-orange-50"),children:u},u))}),e.jsxs("p",{className:"text-xs text-orange-600 mt-2",children:["üìã Apr√®s ",F.maxRemindersBeforeTask," relance(s), une t√¢che sera cr√©√©e pour le commercial"]})]})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex items-center justify-end gap-2",children:[e.jsx(_,{variant:"outline",size:"sm",onClick:()=>l(!1),children:"Annuler"}),e.jsxs(_,{size:"sm",onClick:()=>{f(F),l(!1)},className:"bg-purple-600 hover:bg-purple-700 text-white",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Valider"]})]})]})})]})},fs=({moduleId:s,projectType:x,organizationId:n,uploadedBy:r})=>{const g=d.useRef(null),[f,L]=d.useState([]),[E,$]=d.useState([]),[l,T]=d.useState(!1),[U,F]=d.useState(!1),[p,j]=d.useState(!1),[R,V]=d.useState(new Set),A=`ia-knowledge:${x}`,M=async()=>{if(!(!x||!s||!n)){T(!0);try{const{data:a,error:o}=await H.from("project_files").select("*").eq("organization_id",n).like("field_label",`${A}:%`).is("prospect_id",null).contains("module_ids",[s]).order("created_at",{ascending:!1});if(o)throw o;L(a||[])}catch(a){console.error("Error loading IA knowledge files:",a)}finally{T(!1)}}},X=async()=>{if(!(!x||!n))try{const{data:a,error:o}=await H.from("project_files").select("*").eq("organization_id",n).like("field_label",`${A}:%`).is("prospect_id",null).order("created_at",{ascending:!1});if(o)throw o;$(a||[]);const y=new Set((a||[]).filter(k=>{var m;return(m=k.module_ids)==null?void 0:m.includes(s)}).map(k=>k.id));V(y)}catch(a){console.error("Error loading all project files:",a)}};d.useEffect(()=>{M()},[x,s,n]);const u=()=>{X(),j(!0)},i=a=>{V(o=>{const y=new Set(o);return y.has(a)?y.delete(a):y.add(a),y})},O=async()=>{var a;try{for(const o of E){const y=R.has(o.id),k=(a=o.module_ids)==null?void 0:a.includes(s);if(console.log("[Library] File:",o.file_name,"selected:",y,"hasModule:",k),y&&!k){const m=[...o.module_ids||[],s];console.log("[Library] Adding moduleId:",s,"to",o.file_name,"‚Üí",m);const{error:C}=await H.from("project_files").update({module_ids:m}).eq("id",o.id);C&&console.error("[Library] Update error:",C)}else if(!y&&k){const m=(o.module_ids||[]).filter(I=>I!==s);console.log("[Library] Removing moduleId:",s,"from",o.file_name,"‚Üí",m);const{error:C}=await H.from("project_files").update({module_ids:m}).eq("id",o.id);C&&console.error("[Library] Update error:",C)}}z({title:"‚úÖ S√©lection enregistr√©e",description:"Les documents ont √©t√© li√©s √† cette √©tape.",duration:3e3}),j(!1),M()}catch(o){z({title:"‚ùå Erreur",description:o.message,variant:"destructive"})}},v=async a=>{var y;const o=(y=a.target.files)==null?void 0:y[0];if(o){if(!n){z({title:"‚ùå Erreur",description:"Organization ID manquant",variant:"destructive"});return}F(!0);try{const k=o.name.split(".").pop(),m=`${crypto.randomUUID()}.${k}`,C=`ia-knowledge/${x}/${m}`,{error:I}=await H.storage.from("project-files").upload(C,o);if(I)throw I;const{error:K}=await H.from("project_files").insert({project_type:x,prospect_id:null,organization_id:n,file_name:o.name,file_type:o.type,file_size:o.size,storage_path:C,uploaded_by:r||null,field_label:`${A}:${s}`,module_ids:[s]});if(K)throw K;z({title:"‚úÖ Document IA ajout√©",description:`${o.name} est maintenant disponible pour l'IA √† cette √©tape.`,duration:3e3}),M()}catch(k){z({title:"‚ùå Erreur upload",description:k.message,variant:"destructive"})}finally{F(!1),g.current&&(g.current.value="")}}},P=async a=>{if(confirm(`Supprimer "${a.file_name}" de la base de connaissance IA ?`))try{await H.storage.from("project-files").remove([a.storage_path]),await H.from("project_files").delete().eq("id",a.id),z({title:"üóëÔ∏è Document supprim√©",description:`${a.file_name} n'est plus accessible √† l'IA.`,duration:3e3}),M()}catch(o){z({title:"‚ùå Erreur suppression",description:o.message,variant:"destructive"})}},q=async a=>{try{const{data:o,error:y}=await H.storage.from("project-files").download(a.storage_path);if(y)throw y;const k=URL.createObjectURL(o),m=document.createElement("a");m.href=k,m.download=a.file_name,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(k)}catch(o){z({title:"‚ùå Erreur t√©l√©chargement",description:o.message,variant:"destructive"})}},J=a=>a?a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`:"";return!x||!s?e.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700 text-center",children:"S√©lectionnez un projet et une √©tape pour g√©rer les documents IA."}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:g,type:"file",onChange:v,className:"hidden",accept:".pdf,.doc,.docx,.xls,.xlsx,.txt,.md"}),e.jsx(_,{type:"button",variant:"outline",size:"sm",onClick:()=>{var a;return(a=g.current)==null?void 0:a.click()},disabled:U||!n,className:"flex items-center gap-2 border-purple-300 text-purple-700 hover:bg-purple-50",children:U?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"}),"Upload..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"h-4 w-4"}),"Nouveau"]})}),e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:u,disabled:!n,className:"flex items-center gap-2 border-blue-300 text-blue-700 hover:bg-blue-50",children:[e.jsx(as,{className:"h-4 w-4"}),"Biblioth√®que"]})]}),p&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900",children:["üìö Biblioth√®que - ",x]}),e.jsx("p",{className:"text-xs text-gray-500",children:"S√©lectionnez les documents √† utiliser sur cette √©tape"})]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>j(!1),className:"h-8 w-8",children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:E.length===0?e.jsxs("div",{className:"text-center text-gray-400 py-8",children:["Aucun document dans la biblioth√®que.",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:`Uploadez d'abord un document via "Nouveau".`})]}):e.jsx("div",{className:"space-y-2",children:E.map(a=>{var k;const o=R.has(a.id),y=((k=a.module_ids)==null?void 0:k.length)||0;return e.jsxs("div",{onClick:()=>i(a.id),className:`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${o?"bg-blue-50 border-2 border-blue-400":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("div",{className:`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ${o?"bg-blue-500 border-blue-500":"border-gray-300"}`,children:o&&e.jsx(Z,{className:"h-3 w-3 text-white"})}),e.jsx(be,{className:"h-5 w-5 text-purple-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",children:a.file_name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[J(a.file_size)," ‚Ä¢ Utilis√© sur ",y," √©tape",y>1?"s":""]})]})]},a.id)})})}),e.jsxs("div",{className:"p-4 border-t flex items-center justify-end gap-2",children:[e.jsx(_,{variant:"outline",size:"sm",onClick:()=>j(!1),children:"Annuler"}),e.jsxs(_,{size:"sm",onClick:O,className:"bg-blue-600 hover:bg-blue-700",children:["Valider (",R.size," s√©lectionn√©",R.size>1?"s":"",")"]})]})]})}),l?e.jsx("div",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):f.length===0?e.jsx("div",{className:"text-sm text-gray-400 italic",children:"Aucun document IA pour cette √©tape."}):e.jsx("div",{className:"space-y-2",children:f.map(a=>{var o,y;return e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-white border border-purple-100 rounded-lg hover:bg-purple-50/50 transition-colors",children:[e.jsx(be,{className:"h-5 w-5 text-purple-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",children:a.file_name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[J(a.file_size)," ‚Ä¢ ",((o=a.module_ids)==null?void 0:o.length)||1," √©tape",(((y=a.module_ids)==null?void 0:y.length)||1)>1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-gray-500 hover:text-purple-600",onClick:()=>q(a),title:"T√©l√©charger",children:e.jsx(ls,{className:"h-4 w-4"})}),e.jsx(_,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-gray-500 hover:text-red-600",onClick:()=>P(a),title:"Supprimer",children:e.jsx(Ge,{className:"h-4 w-4"})})]})]},a.id)})})]})},ws=({moduleId:s,moduleName:x,isReadOnly:n=!0,prospectId:r=null,projectType:g=null,availableForms:f=[],availableTemplates:L=[],templateOps:E={}})=>{var ue,ge;const{loadTemplate:$,saveTemplate:l,isPersisted:T=!1,isSaving:U=!1,loading:F=!1}=E,[p,j]=d.useState(null),[R,V]=d.useState(null),[A,M]=d.useState(!1),[X,u]=d.useState(!1),[i,O]=d.useState(ae),[v,P]=d.useState([]),[q,J]=d.useState(0),a=d.useRef(!1),o=d.useMemo(()=>Le(s,i),[s,i]);d.useEffect(()=>{if(s){const t=Ie(s);j({...t}),V({...t}),M(!1),u(!1);const c=De(s);O(c),P([]),J(0)}},[s]),d.useEffect(()=>{(async()=>{var c,N;if(s&&g&&$)try{const S=await $(g,s),w=S==null?void 0:S.configJson;if(w){if(j(h=>({...h,...w})),V(h=>({...h,...w})),w.actionConfig&&O(h=>({...h,...w.actionConfig})),w.actions&&Array.isArray(w.actions)&&w.actions.length>0){P(w.actions.map(D=>({order:D.order,status:D.status||"pending",config:D.config||{},actionConfig:D.actionConfig||{...ae}}))),J(0);const h=w.actions[0];h!=null&&h.config&&j(D=>({...D,...h.config})),h!=null&&h.actionConfig&&O(D=>({...D,...h.actionConfig}))}((c=w.actions)==null?void 0:c.length)>1&&w.actions.forEach((h,D)=>{var Q,Y,ee,se;console.log(`[V2 Config Tab] DB Action ${D}:`,{formIds:(Q=h.actionConfig)==null?void 0:Q.allowedFormIds,requiredFields:(Y=h.actionConfig)==null?void 0:Y.requiredFields,target:(ee=h.actionConfig)==null?void 0:ee.targetAudience,type:(se=h.actionConfig)==null?void 0:se.actionType})}),console.log("[V2 Config Tab] Loaded config from Supabase:",{moduleId:s,projectType:g,hasActionConfig:!!w.actionConfig,actionsCount:((N=w.actions)==null?void 0:N.length)||0})}}catch(S){console.warn("[V2 Config Tab] No DB config found, using in-memory:",S.message)}})()},[s,g,$]),d.useEffect(()=>{p&&R&&(M(JSON.stringify(p)!==JSON.stringify(R)),A&&u(!1))},[p,R]),d.useEffect(()=>{p&&v.length===0&&(P([{order:1,status:"pending",config:JSON.parse(JSON.stringify(p)),actionConfig:JSON.parse(JSON.stringify(i))}]),J(0))},[p,v.length]);const y=t=>{var N,S;if(t===q||t<0||t>=v.length)return;a.current=!0,P(w=>{const h=[...w];return h[q]={...h[q],config:JSON.parse(JSON.stringify(p)),actionConfig:JSON.parse(JSON.stringify(i))},h});const c=v[t];c?(console.log(`[V2 Config Tab] switchToAction(${t}):`,{targetFormIds:(N=c.actionConfig)==null?void 0:N.allowedFormIds,targetReqFields:(S=c.actionConfig)==null?void 0:S.requiredFields,leavingFormIds:i==null?void 0:i.allowedFormIds,leavingReqFields:i==null?void 0:i.requiredFields}),j(JSON.parse(JSON.stringify(c.config))),O(JSON.parse(JSON.stringify(c.actionConfig))),J(t),setTimeout(()=>{a.current=!1},0),setTimeout(()=>me(),100)):a.current=!1},k=()=>{a.current=!0;const t={...v[q],config:JSON.parse(JSON.stringify(p)),actionConfig:JSON.parse(JSON.stringify(i))},c=v.length+1,N={order:c,status:"pending",config:JSON.parse(JSON.stringify(t.config)),actionConfig:{...ae}};P(w=>{const h=[...w];return h[q]=t,[...h,N]});const S=v.length;J(S),j(JSON.parse(JSON.stringify(N.config))),O({...ae}),setTimeout(()=>{a.current=!1},0),setTimeout(()=>me(),100),z({title:`‚ûï Action ${c} ajout√©e`,description:`Ordre : ${c} ‚Äî En attente de validation de l'action ${c-1}`,duration:3e3})},m=t=>{if(t===0)return!1;const c=v[t-1];return(c==null?void 0:c.status)!=="validated"},C=t=>{if(v.length<=1)return;a.current=!0;const c=v.filter((w,h)=>h!==t).map((w,h)=>({...w,order:h+1}));P(c);const N=t>=c.length?c.length-1:t;J(N);const S=c[N];S&&(j(JSON.parse(JSON.stringify(S.config))),O(JSON.parse(JSON.stringify(S.actionConfig)))),setTimeout(()=>{a.current=!1},0),z({title:"üóëÔ∏è Action supprim√©e",description:`${c.length} action(s) restante(s)`,duration:3e3})},I=(t,c)=>{j(N=>({...N,[t]:c}))},K=(t,c)=>{j(N=>({...N,buttonLabels:{...N.buttonLabels,[t]:c}}))},Ee=()=>{Ke(s,p),V({...p}),M(!1),u(!0),z({title:"‚úÖ Configuration sauvegard√©e",description:"Modifications appliqu√©es (session uniquement)",duration:3e3}),console.log("[V2 Config Tab] Saved (in-memory)",{moduleId:s,config:p})},_e=async()=>{if(!l||!g){z({title:"‚ö†Ô∏è Persistance non disponible",description:"projectType ou saveTemplate manquant",variant:"destructive",duration:3e3});return}try{const t=v.map((N,S)=>S===q?{...N,config:JSON.parse(JSON.stringify(p)),actionConfig:JSON.parse(JSON.stringify(i))}:N),c={...p,actionConfig:i,actions:t.map(N=>({order:N.order,status:N.status,config:N.config,actionConfig:N.actionConfig}))};await l(g,s,c),z({title:"‚úÖ Configuration persist√©e",description:"Sauvegarde en base r√©ussie ‚Äî sera recharg√©e au prochain refresh",duration:4e3}),console.log("[V2 Config Tab] Saved to Supabase:",{moduleId:s,projectType:g,fullConfig:c})}catch(t){console.error("[V2 Config Tab] Save to DB failed:",t),z({title:"‚ùå Erreur de sauvegarde",description:t.message,variant:"destructive",duration:4e3})}},Fe=()=>{j({...R}),M(!1),u(!1)},G=(t,c)=>{O(N=>{const S={...N,[t]:c};return t==="allowedFormIds"&&(S.requiredFields=[],console.log("[V2 Config Tab] Form changed ‚Üí requiredFields CLEARED")),v.length<=1&&He(s,S),console.log("[V2 Config Tab] ActionConfig updated:",{field:t,value:c,moduleId:s,actionIndex:q}),S})},Te=t=>{j(c=>({...c,knowledgeKey:t}))},xe=d.useRef(null),me=()=>{var t;(t=xe.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"})};return p?e.jsxs("div",{className:"space-y-6",ref:xe,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5 text-blue-600"}),"Configuration IA"]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-0.5",children:["Module : ",x||s]})]}),T?e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Configuration persist√©e"]}):e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 bg-amber-50 text-amber-700 rounded-full text-xs font-medium",children:[e.jsx(oe,{className:"h-3.5 w-3.5"}),"Modifications temporaires"]})]}),e.jsx("div",{className:b("p-3 border rounded-lg",T?"bg-emerald-50 border-emerald-100":"bg-blue-50 border-blue-100"),children:e.jsxs("p",{className:b("text-xs flex items-start gap-2",T?"text-emerald-700":"text-blue-700"),children:[e.jsx(de,{className:"h-4 w-4 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:T?"Cette configuration est enregistr√©e en base. Elle sera recharg√©e automatiquement au prochain refresh.":"Cliquez 'Enregistrer en base' pour persister cette configuration. Elle sera recharg√©e automatiquement apr√®s refresh."})]})}),v.length>1&&e.jsx("div",{className:"sticky top-0 z-20 -mx-6 px-6 py-4 bg-gradient-to-b from-white to-gray-50/80 backdrop-blur-sm border-b border-gray-200 shadow-sm",children:e.jsx("div",{className:"flex items-center gap-0 overflow-x-auto pb-1",children:v.map((t,c)=>{var D,Q,Y,ee,se,pe;const N=m(c),S=q===c,w=t.status==="validated",h=c+1;return e.jsxs(Ve.Fragment,{children:[c>0&&e.jsxs("div",{className:"flex items-center px-1 flex-shrink-0",children:[e.jsx("div",{className:b("w-6 h-0.5 rounded-full",w||((D=v[c-1])==null?void 0:D.status)==="validated"?"bg-emerald-300":"bg-gray-200")}),e.jsx(Je,{className:b("h-4 w-4 -ml-1 flex-shrink-0",w||((Q=v[c-1])==null?void 0:Q.status)==="validated"?"text-emerald-400":"text-gray-300")})]}),e.jsxs("div",{onClick:()=>y(c),className:b("group relative flex items-center gap-3 px-4 py-3 rounded-xl border-2 transition-all flex-shrink-0 min-w-[200px] max-w-[280px] cursor-pointer",S?"bg-blue-50 border-blue-500 shadow-md shadow-blue-100":w?"bg-emerald-50 border-emerald-300 hover:shadow-sm":N?"bg-gray-50/80 border-gray-200 hover:border-blue-300 hover:shadow-sm":"bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm"),children:[e.jsx("div",{className:b("flex items-center justify-center w-9 h-9 rounded-full text-sm font-bold flex-shrink-0 transition-all",S?"bg-blue-600 text-white shadow-sm":w?"bg-emerald-500 text-white":"bg-gray-100 text-gray-500 group-hover:bg-blue-100 group-hover:text-blue-600"),children:w?e.jsx(Z,{className:"h-4 w-4"}):h}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:b("text-sm font-semibold leading-tight",S?"text-blue-800":w?"text-emerald-700":"text-gray-700"),children:["Action ",h]}),e.jsxs("p",{className:b("text-xs mt-0.5 truncate",S?"text-blue-500":"text-gray-400"),children:[((ee=(Y=t.config)==null?void 0:Y.objective)==null?void 0:ee.slice(0,40))||"Pas d'objectif",((pe=(se=t.config)==null?void 0:se.objective)==null?void 0:pe.length)>40?"‚Ä¶":""]})]}),e.jsx("button",{type:"button",onClick:Oe=>{Oe.stopPropagation(),C(c)},className:b("absolute -top-2 -right-2 flex items-center justify-center w-6 h-6 rounded-full bg-white border-2 shadow-sm transition-all","opacity-0 group-hover:opacity-100","border-red-200 text-red-400 hover:bg-red-50 hover:text-red-600 hover:border-red-300"),title:"Supprimer cette action",children:e.jsx(le,{className:"h-3 w-3"})})]})]},c)})})}),e.jsxs("section",{children:[e.jsx(B,{icon:ce,label:"Objectif du module"}),e.jsx(ye,{value:p.objective||"",onChange:t=>I("objective",t),placeholder:"D√©crivez l'objectif principal de ce module...",rows:2})]}),e.jsxs("section",{children:[e.jsx(B,{icon:Be,label:"Instructions IA"}),e.jsx(ye,{value:p.instructions||"",onChange:t=>I("instructions",t),placeholder:"Instructions d√©taill√©es pour l'IA (comportement, r√®gles, contexte)...",rows:6}),e.jsx("p",{className:"text-xs text-gray-400 mt-1.5",children:"Ces instructions guident le comportement de l'IA dans ce module."})]}),e.jsxs("section",{className:"relative bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 -mx-6 px-6 py-6 border border-purple-200/50 rounded-xl shadow-sm overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-purple-100/30 rounded-full blur-3xl -z-0"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full blur-3xl -z-0"}),e.jsxs("div",{className:"relative z-10 flex items-center justify-between mb-6 pb-4 border-b border-purple-200/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-600 rounded-lg shadow-md",children:e.jsx(ne,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-base font-bold text-gray-800 flex items-center gap-2",children:["Configuration Actions V2",e.jsx("span",{className:"px-2 py-0.5 text-[10px] font-semibold bg-white/80 text-purple-700 rounded-full border border-purple-200 shadow-sm",children:"Phase 3"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"D√©finissez les actions automatis√©es du workflow"})]})]}),e.jsx(gs,{isComplete:o.isComplete,details:o.summary})]}),e.jsxs("div",{className:"relative z-10 space-y-5",children:[e.jsxs("div",{children:[e.jsx(B,{icon:Ae,label:"Qui r√©alise l'action ?"}),e.jsx(ds,{selected:Array.isArray(i.targetAudience)?i.targetAudience[0]:i.targetAudience,onChange:t=>G("targetAudience",t),targets:es()})]}),e.jsxs("div",{children:[e.jsx(B,{icon:ne,label:"Type d'action autoris√©e"}),e.jsx(xs,{selected:i.actionType,onChange:t=>G("actionType",t),actionTypes:ss()})]}),i.actionType==="FORM"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(B,{icon:te,label:"Formulaires autoris√©s"}),e.jsx(we,{selected:i.allowedFormIds||[],onChange:t=>G("allowedFormIds",t),forms:f})]}),i.targetAudience==="CLIENT"&&e.jsx("div",{children:e.jsx(hs,{selectedFormIds:i.allowedFormIds||[],availableForms:f,requiredFields:i.requiredFields||[],reminderConfig:i.reminderConfig||{enabled:!1,delayDays:1},onRequiredFieldsChange:t=>G("requiredFields",t),onReminderConfigChange:t=>G("reminderConfig",t)})})]}),i.actionType==="SIGNATURE"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(B,{icon:ke,label:"Template de signature",required:!0}),e.jsx(ms,{selected:i.templateId,onChange:t=>G("templateId",t),templates:L}),!i.templateId&&e.jsxs("p",{className:"text-xs text-amber-600 mt-1 flex items-center gap-1",children:[e.jsx("span",{className:"text-amber-500",children:"‚ö†Ô∏è"}),e.jsx("span",{className:"font-medium",children:"Obligatoire pour g√©n√©rer le contrat PDF"})]})]}),e.jsxs("div",{children:[e.jsx(B,{icon:te,label:"Formulaire(s) de collecte"}),e.jsx(we,{forms:f,selected:i.allowedFormIds||[],onChange:t=>G("allowedFormIds",t)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"S√©lectionnez le formulaire contenant les donn√©es √† injecter dans le contrat"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(Ce,{label:"Mode de gestion",icon:ie,selected:i.managementMode||"AI",onChange:t=>G("managementMode",t),modes:ts()}),e.jsx(Ce,{label:"Mode de v√©rification",icon:oe,selected:i.verificationMode||"HUMAN",onChange:t=>G("verificationMode",t),modes:rs()})]}),e.jsx("div",{className:"border-t border-purple-200/50 my-5"}),e.jsx("div",{children:e.jsx(ps,{selected:i.completionTrigger,onChange:t=>G("completionTrigger",t)})}),e.jsx("div",{className:"border-t border-purple-200/50 my-5"}),e.jsx("div",{children:e.jsx(is,{moduleId:s,projectType:g,prospectId:r,actionConfig:i,availableForms:f,availableTemplates:L})})]})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(B,{icon:te,label:`üìö Documents IA (Base de connaissances)${v.length>1?` ‚Äî Action ${q+1}`:""}`}),e.jsx(fs,{moduleId:v.length>1?`${s}:action-${q+1}`:s,projectType:g,organizationId:E==null?void 0:E.organizationId,uploadedBy:E==null?void 0:E.uploadedBy})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(B,{icon:Ne,label:"Acc√®s aux donn√©es (knowledgeKey)"}),e.jsx(us,{selected:p.knowledgeKey,onChange:Te}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"S√©lectionnez les sources de donn√©es auxquelles l'IA peut acc√©der."})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(B,{icon:ne,label:"Labels des boutons"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"Bouton PROCEED"}),e.jsx(ve,{value:((ue=p.buttonLabels)==null?void 0:ue.proceedLabel)||"",onChange:t=>K("proceedLabel",t),placeholder:"Valider et continuer"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"Bouton NEED_DATA"}),e.jsx(ve,{value:((ge=p.buttonLabels)==null?void 0:ge.needDataLabel)||"",onChange:t=>K("needDataLabel",t),placeholder:"J'ai besoin d'infos"})]})]})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(B,{icon:Ne,label:"Actions autoris√©es",readOnly:!0}),p.allowedActions&&p.allowedActions.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:p.allowedActions.map(t=>e.jsx(os,{action:t},t))}):e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune action configur√©e"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"Liste des actions que l'IA peut effectuer (non modifiable en Phase 1)."})]}),e.jsx("div",{className:"pt-2",children:e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:k,className:"w-full border-dashed border-2 border-blue-300 text-blue-600 hover:bg-blue-50 hover:border-blue-400",children:[e.jsx($e,{className:"h-4 w-4 mr-1.5"}),"Ajouter une action"]})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[X&&e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Sauvegard√© (session)"]}),T&&e.jsxs("span",{className:"text-xs text-emerald-600 flex items-center gap-1 bg-emerald-50 px-2 py-0.5 rounded-full",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Persist√© en base"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_,{variant:"ghost",size:"sm",onClick:Fe,disabled:!A,children:[e.jsx(Ue,{className:"h-4 w-4 mr-1"}),"R√©initialiser"]}),e.jsxs(_,{size:"sm",onClick:Ee,disabled:!A,className:b(A&&"bg-blue-600 hover:bg-blue-700"),children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),"Session"]}),e.jsx(_,{size:"sm",variant:"outline",onClick:_e,disabled:U||!g,className:"border-emerald-500 text-emerald-700 hover:bg-emerald-50",children:U?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 mr-1 animate-spin"}),"Enregistrement..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),"Enregistrer en base"]})})]})]})]}):e.jsxs("div",{className:"p-6 text-center text-gray-400",children:[e.jsx(ce,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Chargement de la configuration..."})]})};export{de as I,ws as M};
