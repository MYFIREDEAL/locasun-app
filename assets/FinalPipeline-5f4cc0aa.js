import{c as Pt,r as n,R as xt,u as Es,j as e,m as Ye,C as it,l as N,s as xe,a as ct,b as Be,d as rs,e as tt,f as Ps,g as It,h as dt,B as he,P as Tt,D as ft,i as bt,X as Je,k as jt,n as yt,U as et,o as st,M as vt,p as Dt,q as Nt,S as Rt,t as Ft,v as $t,w as Mt,x as Me,y as Ot,A as ns,z as is,T as zt,E as ls,F as os,G as cs,H as ds,I as us,J as ms,K as gs,L as X,N as ze,O as Ts,Q as xs,V as Ds,W as ps,Y as Bt,Z as Rs,_ as Fs,$ as Ze,a0 as $s,a1 as Ms,a2 as Os,a3 as lt,a4 as zs,a5 as hs,a6 as fs,a7 as Ls,a8 as qs,a9 as Oe,aa as He,ab as ut,ac as bs,ad as Vs,ae as Bs,af as Hs,ag as Gs,ah as Ws,ai as Js,aj as Xs,ak as Ys,al as Ks,am as Qs,an as Zs,ao as Us,ap as ea,aq as ta,ar as sa,as as aa,at as ra,au as na}from"./index-2c44438a.js";import{u as at,A as js,C as ia}from"./Agenda-ab06b6bd.js";import{S as la}from"./SearchableSelect-92d492dd.js";import{u as oa}from"./useSupabaseProjectStepsStatus-72937a0a.js";import{u as ys,a as vs}from"./useSupabaseProjectFiles-e4426fbd.js";import{F as ca,a as da,P as ua,b as ma,e as ga,u as Ns,S as Lt,c as xa}from"./useSupabaseWorkflowModuleTemplates-8fdc8bfa.js";import{f as Ke,a as Ve,V as pa}from"./index-1c384e96.js";import{D as pt}from"./download-3c767a4d.js";import{i as ha}from"./workflowV2Config-f801420c.js";import{P as ht}from"./pen-square-a19bb5bb.js";import{f as fa,P as Ht}from"./index-bb63382b.js";import"./external-link-d828c213.js";const ba=Pt("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),ja=Pt("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),ya=Pt("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function va(){for(var t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return n.useMemo(()=>r=>{s.forEach(u=>u(r))},s)}const Na=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function wa(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function Sa(t){return"nodeType"in t}function ws(t){var s,a;return t?wa(t)?t:Sa(t)&&(s=(a=t.ownerDocument)==null?void 0:a.defaultView)!=null?s:window:window}const wt=Na?n.useLayoutEffect:n.useEffect;function Ss(t){const s=n.useRef(t);return wt(()=>{s.current=t}),n.useCallback(function(){for(var a=arguments.length,r=new Array(a),u=0;u<a;u++)r[u]=arguments[u];return s.current==null?void 0:s.current(...r)},[])}function Ct(t,s){s===void 0&&(s=[t]);const a=n.useRef(t);return wt(()=>{a.current!==t&&(a.current=t)},s),a}function kt(t){const s=Ss(t),a=n.useRef(null),r=n.useCallback(u=>{u!==a.current&&(s==null||s(u,a.current)),a.current=u},[]);return[a,r]}let _t={};function _s(t,s){return n.useMemo(()=>{if(s)return s;const a=_t[t]==null?0:_t[t]+1;return _t[t]=a,t+"-"+a},[t,s])}function _a(t){if(!t)return!1;const{KeyboardEvent:s}=ws(t.target);return s&&t instanceof s}const ot=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:a}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:a}=t;return"scaleX("+s+") scaleY("+a+")"}},Transform:{toString(t){if(t)return[ot.Translate.toString(t),ot.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:a,easing:r}=t;return s+" "+a+"ms "+r}}});var nt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(nt||(nt={}));function Gt(){}const Ia=Object.freeze({x:0,y:0});function Ca(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function ka(t,s,a){const r=Ca(s);if(!r)return t;const{scaleX:u,scaleY:m,x:g,y:x}=r,w=t.left-g-(1-u)*parseFloat(a),C=t.top-x-(1-m)*parseFloat(a.slice(a.indexOf(" ")+1)),b=u?t.width/u:t.width,h=m?t.height/m:t.height;return{width:b,height:h,top:C,right:w+b,bottom:C+h,left:w}}const Aa={ignoreTransform:!1};function qt(t,s){s===void 0&&(s=Aa);let a=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:C,transformOrigin:b}=ws(t).getComputedStyle(t);C&&(a=ka(a,C,b))}const{top:r,left:u,width:m,height:g,bottom:x,right:w}=a;return{top:r,left:u,width:m,height:g,bottom:x,right:w}}function Wt(t){return qt(t,{ignoreTransform:!0})}var Ue;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(Ue||(Ue={}));var Jt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Jt||(Jt={}));var Fe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Fe||(Fe={}));Fe.Space,Fe.Enter,Fe.Esc,Fe.Space,Fe.Enter,Fe.Tab;var Xt;(function(t){t[t.RightClick=2]="RightClick"})(Xt||(Xt={}));var Yt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Yt||(Yt={}));var Kt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Kt||(Kt={}));Ue.Backward+"",Ue.Forward+"",Ue.Backward+"",Ue.Forward+"";var At;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(At||(At={}));var Et;(function(t){t.Optimized="optimized"})(Et||(Et={}));function Ea(t){let{callback:s,disabled:a}=t;const r=Ss(s),u=n.useMemo(()=>{if(a||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:m}=window;return new m(r)},[a]);return n.useEffect(()=>()=>u==null?void 0:u.disconnect(),[u]),u}function Pa(t,s){return n.useMemo(()=>t.reduce((a,r)=>{let{eventName:u,handler:m}=r;return a[u]=g=>{m(g,s)},a},{}),[t,s])}At.WhileDragging,Et.Optimized;const Ta={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Gt,draggableNodes:new Map,over:null,measureDroppableContainers:Gt},Is=n.createContext(Ta),Da=n.createContext({...Ia,scaleX:1,scaleY:1});var Qt;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Qt||(Qt={}));const Ra=n.createContext(null),Zt="button",Fa="Draggable";function $a(t){let{id:s,data:a,disabled:r=!1,attributes:u}=t;const m=_s(Fa),{activators:g,activatorEvent:x,active:w,activeNodeRect:C,ariaDescribedById:b,draggableNodes:h,over:M}=n.useContext(Is),{role:p=Zt,roleDescription:F="draggable",tabIndex:T=0}=u??{},f=(w==null?void 0:w.id)===s,k=n.useContext(f?Da:Ra),[E,y]=kt(),[i,c]=kt(),R=Pa(g,s),J=Ct(a);wt(()=>(h.set(s,{id:s,key:m,node:E,activatorNode:i,data:J}),()=>{const $=h.get(s);$&&$.key===m&&h.delete(s)}),[h,s]);const S=n.useMemo(()=>({role:p,tabIndex:T,"aria-disabled":r,"aria-pressed":f&&p===Zt?!0:void 0,"aria-roledescription":F,"aria-describedby":b.draggable}),[r,p,T,f,F,b.draggable]);return{active:w,activatorEvent:x,activeNodeRect:C,attributes:S,isDragging:f,listeners:r?void 0:R,node:E,over:M,setNodeRef:y,setActivatorNodeRef:c,transform:k}}const Ma="Droppable",Oa={timeout:25};function za(t){let{data:s,disabled:a=!1,id:r,resizeObserverConfig:u}=t;const m=_s(Ma),{active:g,dispatch:x,over:w,measureDroppableContainers:C}=n.useContext(Is),b=n.useRef({disabled:a}),h=n.useRef(!1),M=n.useRef(null),p=n.useRef(null),{disabled:F,updateMeasurementsFor:T,timeout:f}={...Oa,...u},k=Ct(T??r),E=n.useCallback(()=>{if(!h.current){h.current=!0;return}p.current!=null&&clearTimeout(p.current),p.current=setTimeout(()=>{C(Array.isArray(k.current)?k.current:[k.current]),p.current=null},f)},[f]),y=Ea({callback:E,disabled:F||!g}),i=n.useCallback((S,$)=>{y&&($&&(y.unobserve($),h.current=!1),S&&y.observe(S))},[y]),[c,R]=kt(i),J=Ct(s);return n.useEffect(()=>{!y||!c.current||(y.disconnect(),h.current=!1,y.observe(c.current))},[c,y]),n.useEffect(()=>(x({type:nt.RegisterDroppable,element:{id:r,key:m,disabled:a,node:c,rect:M,data:J}}),()=>x({type:nt.UnregisterDroppable,key:m,id:r})),[r]),n.useEffect(()=>{a!==b.current.disabled&&(x({type:nt.SetDroppableDisabled,id:r,key:m,disabled:a}),b.current.disabled=a)},[r,m,a,x]),{active:g,rect:M,isOver:(w==null?void 0:w.id)===r,node:c,over:w,setNodeRef:R}}function Cs(t,s,a){const r=t.slice();return r.splice(a<0?r.length+a:a,0,r.splice(s,1)[0]),r}function gt(t){return t!==null&&t>=0}const La=t=>{let{rects:s,activeIndex:a,overIndex:r,index:u}=t;const m=Cs(s,r,a),g=s[u],x=m[u];return!x||!g?null:{x:x.left-g.left,y:x.top-g.top,scaleX:x.width/g.width,scaleY:x.height/g.height}},qa="Sortable",Va=xt.createContext({activeIndex:-1,containerId:qa,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:La,disabled:{draggable:!1,droppable:!1}}),Ba=t=>{let{id:s,items:a,activeIndex:r,overIndex:u}=t;return Cs(a,r,u).indexOf(s)},Ha=t=>{let{containerId:s,isSorting:a,wasDragging:r,index:u,items:m,newIndex:g,previousItems:x,previousContainerId:w,transition:C}=t;return!C||!r||x!==m&&u===g?!1:a?!0:g!==u&&s===w},Ga={duration:200,easing:"ease"},ks="transform",Wa=ot.Transition.toString({property:ks,duration:0,easing:"linear"}),Ja={roleDescription:"sortable"};function Xa(t){let{disabled:s,index:a,node:r,rect:u}=t;const[m,g]=n.useState(null),x=n.useRef(a);return wt(()=>{if(!s&&a!==x.current&&r.current){const w=u.current;if(w){const C=qt(r.current,{ignoreTransform:!0}),b={x:w.left-C.left,y:w.top-C.top,scaleX:w.width/C.width,scaleY:w.height/C.height};(b.x||b.y)&&g(b)}}a!==x.current&&(x.current=a)},[s,a,r,u]),n.useEffect(()=>{m&&g(null)},[m]),m}function Ya(t){let{animateLayoutChanges:s=Ha,attributes:a,disabled:r,data:u,getNewIndex:m=Ba,id:g,strategy:x,resizeObserverConfig:w,transition:C=Ga}=t;const{items:b,containerId:h,activeIndex:M,disabled:p,disableTransforms:F,sortedRects:T,overIndex:f,useDragOverlay:k,strategy:E}=n.useContext(Va),y=Ka(r,p),i=b.indexOf(g),c=n.useMemo(()=>({sortable:{containerId:h,index:i,items:b},...u}),[h,u,i,b]),R=n.useMemo(()=>b.slice(b.indexOf(g)),[b,g]),{rect:J,node:S,isOver:$,setNodeRef:le}=za({id:g,data:c,disabled:y.droppable,resizeObserverConfig:{updateMeasurementsFor:R,...w}}),{active:oe,activatorEvent:me,activeNodeRect:G,attributes:fe,setNodeRef:U,listeners:A,isDragging:V,over:ue,setActivatorNodeRef:B,transform:d}=$a({id:g,data:c,attributes:{...Ja,...a},disabled:y.draggable}),z=va(le,U),Z=!!oe,Y=Z&&!F&&gt(M)&&gt(f),v=!k&&V,I=v&&Y?d:null,q=Y?I??(x??E)({rects:T,activeNodeRect:G,activeIndex:M,overIndex:f,index:i}):null,re=gt(M)&&gt(f)?m({id:g,items:b,activeIndex:M,overIndex:f}):i,H=oe==null?void 0:oe.id,W=n.useRef({activeId:H,items:b,newIndex:re,containerId:h}),de=b!==W.current.items,ce=s({active:oe,containerId:h,isDragging:V,isSorting:Z,id:g,index:i,items:b,newIndex:W.current.newIndex,previousItems:W.current.items,previousContainerId:W.current.containerId,transition:C,wasDragging:W.current.activeId!=null}),ye=Xa({disabled:!ce,index:i,node:S,rect:J});return n.useEffect(()=>{Z&&W.current.newIndex!==re&&(W.current.newIndex=re),h!==W.current.containerId&&(W.current.containerId=h),b!==W.current.items&&(W.current.items=b)},[Z,re,h,b]),n.useEffect(()=>{if(H===W.current.activeId)return;if(H&&!W.current.activeId){W.current.activeId=H;return}const ie=setTimeout(()=>{W.current.activeId=H},50);return()=>clearTimeout(ie)},[H]),{active:oe,activeIndex:M,attributes:fe,data:c,rect:J,index:i,newIndex:re,items:b,isOver:$,isSorting:Z,isDragging:V,listeners:A,node:S,overIndex:f,over:ue,setNodeRef:z,setActivatorNodeRef:B,setDroppableNodeRef:le,setDraggableNodeRef:U,transform:ye??q,transition:j()};function j(){if(ye||de&&W.current.newIndex===i)return Wa;if(!(v&&!_a(me)||!C)&&(Z||ce))return ot.Transition.toString({...C,property:ks})}}function Ka(t,s){var a,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(a=t==null?void 0:t.draggable)!=null?a:s.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:s.droppable}}Fe.Down,Fe.Right,Fe.Up,Fe.Left;const Qa=t=>(t||"").toString().trim().toUpperCase(),Za=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const a=t.prospect,r=s.prospect;if(a.id!==r.id||a.name!==r.name||a.hasAppointment!==r.hasAppointment||a.updatedAt!==r.updatedAt)return!1;const u=a._projectContext||{},m=r._projectContext||{};if(u.projectType!==m.projectType||u.projectTitle!==m.projectTitle||u.stepLabel!==m.stepLabel)return!1;const g=a.tags||[],x=r.tags||[];return!(g.length!==x.length||g.some((w,C)=>w!==x[C])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},Ua=({prospect:t,onClick:s,sortableId:a,projectsData:r={}})=>{var f,k,E,y,i,c,R;Es();const u=Array.isArray(t.tags)?t.tags:[],m=((f=t._projectContext)==null?void 0:f.projectTitle)||((k=t._projectContext)==null?void 0:k.projectType)||null,g=((E=t._projectContext)==null?void 0:E.projectType)||null;(y=t._projectContext)!=null&&y.stepLabel;const x=m?Qa(m):null,w=a||(x?`${t.id}-${x}`:`${t.id}-${((i=t._projectContext)==null?void 0:i.projectType)||"default"}`),{attributes:C,listeners:b,setNodeRef:h,transform:M,transition:p,isDragging:F}=Ya({id:w,data:{prospect:t}}),T={transform:ot.Transform.toString(M),transition:p,zIndex:F?10:"auto",opacity:F?.8:1};return e.jsx("div",{ref:h,style:T,...C,...b,children:e.jsxs(Ye.div,{layoutId:`prospect-card-${w}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(it,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[m&&u.includes(((c=t._projectContext)==null?void 0:c.projectType)||m)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((R=r[g])==null?void 0:R.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:m})}),u.filter(J=>J!==g).map(J=>{var le,oe;const S=((le=r[J])==null?void 0:le.title)||J,$=((oe=r[J])==null?void 0:oe.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${$}`,children:S},J)})]})]})})},er=n.memo(Ua,Za);function tr({prospectId:t,projectType:s,currentStepIndex:a,prompt:r,sendNextAction:u}){const m=n.useRef(new Set);n.useRef(!1),n.useEffect(()=>{if(!t||!s||a===void 0||!r)return;N.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:a,promptName:r==null?void 0:r.name});const g=xe.channel(`workflow-forms-${t}-${s}-${a}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async x=>{const w=x.new;N.info("üîç Form panel UPDATE re√ßu",{panelId:w.id,prospectId:w.prospect_id,projectType:w.project_type,status:w.status,actionId:w.action_id,expectedProjectType:s});const C=w.project_type===s,b=w.status==="approved",h=!!w.action_id;if(C&&b&&h){const M=`${t}-${s}-${a}-${w.action_id}`;if(m.current.has(M)){N.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:M});return}m.current.add(M),N.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:w.form_id,actionId:w.action_id}),setTimeout(()=>{N.info("üöÄ Envoi action suivante",{completedActionId:w.action_id}),u(w.action_id)},2e3)}}).subscribe();return()=>{xe.removeChannel(g)}},[t,s,a,r,u])}function sr({projectType:t,prospectId:s,enabled:a=!0}){const[r,u]=n.useState([]),[m,g]=n.useState(!1),[x,w]=n.useState(!1),[C,b]=n.useState(null),{organizationId:h}=ct(),M=n.useCallback(async()=>{if(!(!t||!a))try{g(!0),b(null);let f=xe.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(f=f.eq("prospect_id",s));const{data:k,error:E}=await f;if(E)throw E;u(k||[])}catch(f){N.error("Erreur r√©cup√©ration project notes:",{error:f.message}),b(f.message)}finally{g(!1)}},[t,s,a]);n.useEffect(()=>{if(!t||!a)return;M();const f=xe.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},k=>{u(E=>{const{eventType:y,new:i,old:c}=k;return y==="INSERT"?[i,...E]:y==="UPDATE"?E.map(R=>R.id===i.id?i:R):y==="DELETE"?E.filter(R=>R.id!==c.id):E})}).subscribe();return()=>{xe.removeChannel(f)}},[t,a,M]);const p=n.useCallback(async({content:f,createdBy:k,createdByName:E})=>{if(!(!t||!(f!=null&&f.trim())))try{if(w(!0),b(null),!h)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:y,error:i}=await xe.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:f.trim(),created_by:k||null,created_by_name:E||null,organization_id:h}]).select().single();if(i)throw i;return u(c=>[y,...c]),y}catch(y){throw N.error("Erreur ajout project note:",{error:y.message}),b(y.message),y}finally{w(!1)}},[t,s,h]),F=n.useCallback(async(f,{content:k})=>{if(!(!f||!(k!=null&&k.trim())))try{w(!0),b(null);const{data:E,error:y}=await xe.from("project_notes").update({content:k.trim(),updated_at:new Date().toISOString()}).eq("id",f).select().single();if(y)throw y;return u(i=>i.map(c=>c.id===f?E:c)),E}catch(E){throw N.error("Erreur update project note:",{error:E.message}),b(E.message),E}finally{w(!1)}},[]),T=n.useCallback(async f=>{if(f)try{w(!0),b(null);const{error:k}=await xe.from("project_notes").delete().eq("id",f);if(k)throw k;u(E=>E.filter(y=>y.id!==f))}catch(k){throw N.error("Erreur suppression project note:",{error:k.message}),b(k.message),k}finally{w(!1)}},[]);return{notes:r,loading:m,saving:x,error:C,addNote:p,updateNote:F,deleteNote:T,refetch:M}}function ar({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r}){var i;const{activeAdminUser:u}=Be(),m=r||u,[g,x]=n.useState(""),[w,C]=n.useState(!1),{getTemplateByType:b}=rs(),h=b(t),M=(h==null?void 0:h.title)||t,{notes:p,loading:F,saving:T,error:f,addNote:k}=sr({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:E}=tt({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:m}),y=async()=>{if(g.trim())try{const c=await k({content:g,createdBy:(m==null?void 0:m.id)||(a==null?void 0:a.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)});c&&E&&await E({event_type:"note",title:"Note ajout√©e",description:c.content||g.trim(),metadata:{source:"notes_tab"},createdBy:(m==null?void 0:m.id)||(a==null?void 0:a.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),x("")}catch(c){N.error(c)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${M}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:g,onChange:c=>x(c.target.value),disabled:!t||T}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:y,disabled:!g.trim()||!t||T,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:T?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),f&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",f]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),p&&p.length>3&&e.jsx("button",{onClick:()=>C(!w),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:w?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx(Ps,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",p.length,")"]}),e.jsx(It,{className:"w-4 h-4"})]})})]}),F&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!F&&(p==null?void 0:p.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(i=w?p:p==null?void 0:p.slice(0,3))==null?void 0:i.map(c=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:c.created_by_name||c.created_by?`Par ${c.created_by_name||c.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:c.created_at&&new Date(c.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:c.content})]},c.id))})]})]})}const rr=({prospectId:t,projectType:s,activeAdminUser:a})=>{const{projectsData:r,appointments:u,updateAppointment:m,deleteAppointment:g,addAppointment:x,addCall:w,addTask:C,updateCall:b,updateTask:h,prospects:M}=Be(),[p,F]=n.useState(!1),[T,f]=n.useState(null),[k,E]=n.useState(null),{users:y}=dt(),{supabaseUserId:i}=at(),{history:c,loading:R}=tt({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),J=n.useMemo(()=>!c||c.length===0?[]:c.filter(A=>A.event_type==="activity").sort((A,V)=>new Date(V.created_at)-new Date(A.created_at)),[c]),S=n.useMemo(()=>{const A={};return J.forEach(ue=>{var d;const B=(d=ue.metadata)==null?void 0:d.appointment_id;B&&(A[B]||(A[B]=[]),A[B].push(ue))}),Object.entries(A).map(([ue,B])=>{var Z;const z=B.sort((Y,v)=>new Date(v.created_at)-new Date(Y.created_at))[0];return{...z,currentStatus:((Z=z.metadata)==null?void 0:Z.status)||(z.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[J]),$=n.useMemo(()=>S?S.filter(A=>A.currentStatus==="pending"):[],[S]),le=n.useMemo(()=>S?S.filter(A=>A.currentStatus!=="pending"):[],[S]),oe=A=>{switch((A==null?void 0:A.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(it,{className:"h-4 w-4"});case"virtual":return e.jsx(pa,{className:"h-4 w-4"});case"call":return e.jsx(st,{className:"h-4 w-4"});case"task":return e.jsx(ia,{className:"h-4 w-4"});default:return e.jsx(it,{className:"h-4 w-4"})}},me=A=>{const V=(A==null?void 0:A.activity_type)||"appointment",ue=A==null?void 0:A.status;if(ue==="effectue"||ue==="completed")return"text-green-600 bg-green-50";if(ue==="annule")return"text-red-600 bg-red-50";if(ue==="reporte")return"text-yellow-600 bg-yellow-50";switch(V){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},G=A=>{var V;return!u||!((V=A.metadata)!=null&&V.appointment_id)?null:u.find(ue=>ue.id===A.metadata.appointment_id)},fe=A=>{const V=G(A);V&&f(V)},U=A=>{f(null),E({...A,type:A.type}),F(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(he,{onClick:()=>{F(!p)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Tt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),p&&e.jsx(js,{open:p,onOpenChange:A=>{A||E(null),F(A)},initialData:k||{contactId:t,projectId:s},defaultAssignedUserId:i,addAppointment:x,addCall:w,addTask:C,updateAppointment:m,updateCall:b,updateTask:h,prospects:M||[],users:y||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",$.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):$.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:$.map(A=>{const V=G(A),ue=(V==null?void 0:V.title)||A.title||"Activit√©",B=V!=null&&V.start?new Date(V.start):new Date(A.created_at);return e.jsxs("div",{onClick:()=>fe(A),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${me(A.metadata)}`,children:oe(A.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:ue}),(V==null?void 0:V.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:V.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Ke(B,"d MMM '√†' HH:mm",{locale:Ve})})]})]},A.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",le.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):le.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:le.map(A=>{const V=G(A),ue=(V==null?void 0:V.title)||A.title||"Activit√©",B=V!=null&&V.start?new Date(V.start):new Date(A.created_at),d={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[A.currentStatus]||A.currentStatus;return e.jsxs("div",{onClick:()=>fe(A),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${me(A.metadata)}`,children:oe(A.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:ue}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[d," ‚Ä¢ ",Ke(B,"d MMM yyyy '√†' HH:mm",{locale:Ve})]})]})]},A.id)})})]}),T&&e.jsx(nr,{event:T,onClose:()=>f(null),onReport:()=>{},onEdit:U,prospects:M,supabaseUsers:y,updateAppointment:m,deleteAppointment:g,projectsData:r})]})},nr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:u,supabaseUsers:m,updateAppointment:g,deleteAppointment:x,projectsData:w})=>{var y;const[C,b]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&b(t.status||"pending")},[t]),!t||!u||!m||!g||!x||!w)return null;const h=u.find(i=>i.id===t.contactId),M=m.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(h?m.find(i=>i.user_id===h.ownerId):null),p=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",F=(i,c,R={})=>{try{const J=new Date(i);return isNaN(J.getTime())?"Date invalide":Ke(J,c,R)}catch{return"Date invalide"}},T=i=>{b(i),g(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},f=()=>{x(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},k=i=>{if(!h){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":h.phone&&(window.location.href=`tel:${h.phone}`);break;case"Mail":h.email&&(window.location.href=`mailto:${h.email}`);break;case"WhatsApp":if(h.phone){let c=h.phone.replace(/\D/g,"");c.startsWith("0")&&(c=`33${c.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${c}?text=${R}`,"_blank")}break;case"GPS":if(h.address){const c=encodeURIComponent(h.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${c}`:window.open(`https://www.google.com/maps/search/?api=1&query=${c}`,"_blank")}break;default:X({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(ft,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(bt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p(F(t.start,"eeee d MMMM",{locale:Ve}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[F(t.start,"HH:mm",{locale:Ve})," - ",F(t.end,"HH:mm",{locale:Ve})]})]}),e.jsx(jt,{className:"p-0 text-left space-y-1",children:e.jsx(yt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(et,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),h&&e.jsxs("p",{className:"text-sm",children:[h.name," (Client)"]}),M&&e.jsxs("p",{className:"text-sm",children:[M.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:st,label:"Appel"},{icon:vt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:Nt,label:"GPS"}].map(({icon:i,label:c})=>e.jsxs("button",{onClick:()=>k(c),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:c})]},c))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[C].color}`,children:e.jsxs(Rt,{onValueChange:T,value:C,children:[e.jsx(Ft,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx($t,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Mt,{children:[e.jsx(Me,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Me,{value:"effectue",children:"Effectu√©"}),e.jsx(Me,{value:"annule",children:"Annul√©"}),e.jsx(Me,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((y=w[t.projectId])==null?void 0:y.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(h==null?void 0:h.name)||"N/A"})]})]})]}),e.jsxs(Ot,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(ns,{children:[e.jsx(is,{asChild:!0,children:e.jsxs(he,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ls,{children:[e.jsxs(os,{children:[e.jsx(cs,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(ds,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(us,{children:[e.jsx(ms,{children:"Annuler"}),e.jsx(gs,{onClick:f,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(he,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})},ir=({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r})=>{const{activeAdminUser:u}=Be(),{organizationId:m}=ct(),g=r||u,[x,w]=n.useState(null),{files:C,loading:b,uploading:h,deleting:M,error:p,uploadFile:F,deleteFile:T}=ys({projectType:t,prospectId:s,organizationId:m,enabled:!!t}),{addHistoryEvent:f}=tt({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:g}),k=async S=>{const $=Array.from(S.target.files||[]);if($.length!==0)try{const le=$.map(async oe=>{w(oe);const me=await F({file:oe,uploadedBy:a==null?void 0:a.id});return me&&f&&await f({event_type:"file",title:"Fichier ajout√©",description:me.file_name,metadata:{size:me.file_size,type:me.file_type,storage_path:me.storage_path},createdBy:(g==null?void 0:g.id)||(a==null?void 0:a.id),createdByName:(g==null?void 0:g.name)||(g==null?void 0:g.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),me});await Promise.all(le),w(null),S.target.value=""}catch(le){N.error("Error uploading files:",le),w(null)}},E=async S=>{try{const{data:$,error:le}=await xe.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(le){N.error("Error creating signed URL:",le);return}const me=await(await fetch($.signedUrl)).blob(),G=window.URL.createObjectURL(me),fe=document.createElement("a");fe.href=G,fe.download=S.file_name,document.body.appendChild(fe),fe.click(),document.body.removeChild(fe),window.URL.revokeObjectURL(G)}catch($){N.error("Error downloading file:",$)}},y=async S=>{try{N.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:S.storage_path});const{data:$,error:le}=await xe.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(le){N.error("Error creating signed URL:",le);return}N.debug("‚úÖ Signed URL generated",{url:$.signedUrl}),window.open($.signedUrl,"_blank")}catch($){N.error("Error viewing file:",$)}},i=async S=>{if(confirm(`Supprimer le fichier "${S.file_name}" ?`))try{await T(S.id,S.storage_path)}catch($){N.error("Error deleting file:",$)}},c=S=>S!=null&&S.startsWith("image/")?e.jsx(Ds,{className:"h-5 w-5 text-blue-500"}):S==="application/pdf"?e.jsx(ze,{className:"h-5 w-5 text-red-500"}):e.jsx(ca,{className:"h-5 w-5 text-gray-500"}),R=S=>S?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(S)):"",J=S=>S?S<1024?`${S} o`:S<1024*1024?`${(S/1024).toFixed(1)} Ko`:`${(S/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Ts,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:h?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:k,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:h,multiple:!0})]})}),p&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:p}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",C.length,")"]}),b?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):C.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:C.map(S=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:c(S.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[S.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:S.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:S.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:S.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[J(S.file_size)," ‚Ä¢ ",R(S.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[S.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>y(S),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:M,children:e.jsx(xs,{className:"h-4 w-4"})}),S.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>E(S),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:M,children:e.jsx(pt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>i(S),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:M,children:e.jsx(zt,{className:"h-4 w-4"})})]})]},S.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},lr=({prospectId:t,projectType:s,activeAdminUser:a})=>{const[r,u]=n.useState("notes"),{supabaseUserId:m}=at(),g=[{id:"notes",label:"Notes",icon:ze},{id:"activity",label:"Activit√©",icon:ba},{id:"files",label:"Fichiers",icon:da}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:g.map(({id:x,label:w,icon:C})=>e.jsxs("button",{onClick:()=>u(x),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===x?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx("span",{children:w})]},x))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(ar,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:a}),r==="activity"&&e.jsx(rr,{prospectId:t,projectType:s,activeAdminUser:a}),r==="files"&&e.jsx(ir,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:a})]})]})},or=({projectType:t,prospectId:s,activeAdminUser:a})=>{const{history:r,loading:u,error:m}=tt({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:a});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),u&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),m&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",m]}),!u&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(g=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:g.title||g.event_type}),g.description&&e.jsx("p",{className:"text-xs text-gray-600",children:g.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(g.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(g.created_by_name||g.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",g.created_by_name||g.created_by]})]})]})]})]},g.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},cr=({children:t,prospectId:s,projectType:a,currentStep:r,statusConfig:u,activeAdminUser:m})=>{var g,x,w;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((g=u[r.status])==null?void 0:g.iconOnly)||u.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((x=u[r.status])==null?void 0:x.badge)||u.pending.badge}`,children:((w=u[r.status])==null?void 0:w.label)||u.pending.label})]}),t]},r.name),!r&&!a&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ze,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),a&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(lr,{prospectId:s,projectType:a,activeAdminUser:m}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(or,{prospectId:s,projectType:a,activeAdminUser:m})]})]})},dr={CLIENT:lt,COMMERCIAL:zs,PARTENAIRE:et},ur={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},mr={FORM:ze,SIGNATURE:ua},gr={FORM:"Formulaire",SIGNATURE:"Signature"},xr=({isOpen:t,onClose:s,prospectId:a,projectType:r,moduleId:u,moduleName:m,moduleConfig:g,context:x={},availableForms:w=[],availableTemplates:C=[]})=>{var Z,Y;const[b,h]=n.useState(null),[M,p]=n.useState(!1),[F,T]=n.useState(null),[f,k]=n.useState(!1),E=ha(),y=n.useMemo(()=>g?g.actions&&g.actions.length>0?g.actions:g.actionConfig?[{order:1,status:"pending",actionConfig:g.actionConfig}]:[]:[],[g]),[i,c]=n.useState({}),[R,J]=n.useState(!1);n.useEffect(()=>{if(!t||!a||!u||y.length<=1){c({});return}(async()=>{J(!0);try{const I=y.map((H,W)=>`v2-${u}-action-${W}`),{data:te,error:q}=await xe.from("client_form_panels").select("id, action_id, status").eq("prospect_id",a).eq("project_type",r).in("action_id",I),re={};if(!q&&te&&te.length>0){for(const H of te)H.action_id&&(H.status==="approved"||H.status==="submitted")&&(re[H.action_id]=H.status);console.log("[V2 Robot] Action statuses by action_id:",re)}else{const{data:H}=await xe.from("client_form_panels").select("id, step_name, status").eq("prospect_id",a).eq("project_type",r).in("status",["approved","submitted"]);if(H){const W=H.filter(de=>!de.step_name||de.step_name===m||de.step_name===u);W.forEach((de,ce)=>{ce<y.length&&(re[`v2-${u}-action-${ce}`]=de.status)}),console.log("[V2 Robot] Fallback legacy statuses:",re,"from",W.length,"panels")}}c(re)}catch(I){console.error("[V2 Robot] Error fetching action statuses:",I)}finally{J(!1)}})()},[t,a,r,m,u,y.length]);const S=n.useMemo(()=>y.map((v,I)=>{const te=`v2-${u}-action-${I}`,q=i[te];return{...v,actionId:te,realStatus:q==="approved"?"validated":q==="submitted"?"submitted":"pending"}}),[y,i,u]),[$,le]=n.useState(0);n.useEffect(()=>{if(t&&S.length>0&&!R){const v=S.findIndex(I=>I.realStatus!=="validated");le(v>=0?v:S.length-1)}},[t,S,R]);const oe=S[$]||null,me=S.length,G=me>1,fe=n.useMemo(()=>{if(!oe)return!1;const v=oe.actionConfig;return!(!v||!v.actionType||!(Array.isArray(v.targetAudience)?v.targetAudience.length>0:!!v.targetAudience))},[oe]),U=(oe==null?void 0:oe.actionConfig)||null,A=()=>{if(!fe||!U){X({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:$,actionConfigFormIds:U.allowedFormIds,currentActionFull:oe,allActions:S.map((v,I)=>{var te;return{index:I,formIds:(te=v.actionConfig)==null?void 0:te.allowedFormIds}})});try{const v=Array.isArray(U.targetAudience)?U.targetAudience[0]:U.targetAudience,I=ma({moduleId:u,moduleName:m,projectType:r,prospectId:a,actionIndex:$,actionConfig:{...U,targetAudience:v||"CLIENT"},message:""});h(I),T(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",I)}catch(v){console.error("[V2 Robot] Erreur g√©n√©ration:",v),X({title:"Erreur",description:v.message,variant:"destructive"})}},V=async()=>{if(!b){X({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!E){X({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}p(!0),T(null);try{const v={...b,_meta:{...b._meta,isSimulation:!1}},I=await ga(v,x);T(I),I.success?(X({title:"‚úÖ Action ex√©cut√©e",description:I.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):X({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:I.message,variant:"destructive"})}catch(v){console.error("[V2 Robot] Erreur ex√©cution:",v),T({success:!1,status:"error",message:v.message}),X({title:"Erreur",description:v.message,variant:"destructive"})}finally{p(!1)}},ue=()=>{b&&(navigator.clipboard.writeText(JSON.stringify(b,null,2)),X({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},B=xt.useRef($);n.useEffect(()=>{const v=B.current!==$;if(B.current=$,v&&(h(null),T(null)),t&&fe&&!R&&(!b||v)){const I=setTimeout(()=>{A()},v?50:0);return()=>clearTimeout(I)}},[t,fe,R,$]),n.useEffect(()=>{t||(h(null),T(null),k(!1),le(0))},[t]);const d=v=>{const I=w.find(te=>te.id===v);return(I==null?void 0:I.name)||v},z=v=>{const I=C.find(te=>te.id===v);return(I==null?void 0:I.name)||v};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(ps,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m||u,G&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",$+1,"/",me]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Je,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[G&&fe&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",$+1," sur ",me]}),$>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",$," termin√©e",$>1?"s":"",")"]})]}),!fe&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Bt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(he,{variant:"outline",size:"sm",onClick:()=>{X({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),fe&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:G?`Action ${$+1}/${me}`:"Action configur√©e"}),E&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(U==null?void 0:U.actionType)&&e.jsxs(e.Fragment,{children:[xt.createElement(mr[U.actionType]||ze,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:gr[U.actionType]||U.actionType})]})}),(U==null?void 0:U.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(U.targetAudience)?U.targetAudience:[U.targetAudience]).map(v=>{const I=dr[v]||lt;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(I,{className:"h-3.5 w-3.5"}),ur[v]||v]},v)})]}),((Z=U==null?void 0:U.allowedFormIds)==null?void 0:Z.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",U.allowedFormIds.map(v=>d(v)).join(", ")]}),((Y=U==null?void 0:U.allowedTemplateIds)==null?void 0:Y.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",U.allowedTemplateIds.map(v=>z(v)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(U==null?void 0:U.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(U==null?void 0:U.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),b&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>k(!f),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Fs,{className:Ze("h-4 w-4 transition-transform",f&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:v=>{v.stopPropagation(),ue()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx($s,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),f&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(b,null,2)})]}),F&&e.jsxs("div",{className:Ze("rounded-lg p-4 flex items-start gap-3",F.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[F.success?e.jsx(Ms,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Bt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Ze("font-medium text-sm",F.success?"text-green-800":"text-red-800"),children:[F.status==="executed"&&"Ex√©cut√© avec succ√®s",F.status==="simulated"&&"Simulation uniquement",F.status==="blocked"&&"Ex√©cution bloqu√©e",F.status==="error"&&"Erreur"]}),e.jsx("p",{className:Ze("text-sm mt-1",F.success?"text-green-700":"text-red-700"),children:F.message})]})]})]})]}),fe&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(he,{variant:"outline",onClick:A,disabled:M,children:[e.jsx(xs,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(he,{onClick:V,disabled:!b||M||!E,className:Ze(!E&&"opacity-50 cursor-not-allowed"),children:[M?e.jsx(Os,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ya,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},Le="completed",Ae="in_progress",qe="pending",rt={[Le]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Ae]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[qe]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Ut=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||qe}))};if(t.status!==Ae)return s;if(!s.subSteps.some(r=>r.status===Ae)){const r=s.subSteps.findIndex(u=>u.status===qe);r!==-1&&(s.subSteps=s.subSteps.map((u,m)=>({...u,status:m===r?Ae:u.status})))}return s},es=(t,s,a)=>{var C;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,u=r?`${s}:${r}`:null,m=u&&a?a[u]:null,g=(C=m==null?void 0:m.configJson)==null?void 0:C.actions;if(!g||g.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const b=t.subSteps.map((h,M)=>{var f,k;const p=g[M],T=((k=(f=p==null?void 0:p.config)==null?void 0:f.objective)==null?void 0:k.trim())||(p==null?void 0:p.title)||(p==null?void 0:p.label);return{...h,name:T||h.name||`Action ${M+1}`}});return{...t,subSteps:b}}const x=t.status||qe,w=g.map((b,h)=>{var M;return{id:b.id||`v2-${r}-action-${h}`,name:((M=b.config)==null?void 0:M.objective)&&b.config.objective.trim()||b.title||b.label||`Action ${h+1}`,status:x===Le?Le:x===Ae&&h===0?Ae:qe}});return{...t,subSteps:w,status:x}},pr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===Le),hr=({form:t,prospectId:s,onFormSubmit:a})=>{const[r,u]=n.useState({}),m=(x,w)=>{u(C=>({...C,[x]:w}))},g=()=>{a(s,t.id,r),X({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(x=>{if(x.show_if_conditions&&x.show_if_conditions.length>0){const C=x.condition_operator||"AND",b=x.show_if_conditions.map(M=>{const p=r[M.field];return M.equals==="has_value"?!!p&&p!=="":p===M.equals});if(!(C==="AND"?b.every(M=>M===!0):b.some(M=>M===!0)))return null}if(x.show_if){const C=x.show_if.field,b=x.show_if.equals,h=r[C];if(!h||h!==b)return null}return(t.fields||[]).some(C=>C.is_repeater&&(C.repeats_fields||[]).includes(x.id))?null:e.jsxs("div",{children:[e.jsx(Oe,{htmlFor:`${t.id}-${x.id}`,children:x.label}),e.jsx(He,{id:`${t.id}-${x.id}`,type:x.type,value:typeof r[x.id]=="object"?"":r[x.id]||"",onChange:C=>m(x.id,C.target.value),placeholder:x.placeholder||""}),x.is_repeater&&x.repeats_fields&&x.repeats_fields.length>0&&r[x.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[x.id])||0},(C,b)=>{const h=(t.fields||[]).filter(M=>x.repeats_fields.includes(M.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[x.label," #",b+1]}),h.map(M=>{const p=`${x.id}_repeat_${b}_${M.id}`,F=r[p];return e.jsxs("div",{children:[e.jsx(Oe,{htmlFor:`${t.id}-${p}`,children:M.label}),e.jsx(He,{id:`${t.id}-${p}`,type:M.type,value:typeof F=="object"?"":F||"",onChange:T=>m(p,T.target.value),placeholder:M.placeholder||""})]},p)})]},b)})})]},x.id)}),e.jsx(he,{onClick:g,className:"w-full",children:"Soumettre"})]})},fr=({prospectId:t,projectType:s,currentStepIndex:a,activeAdminUser:r})=>{var ce,ye;const{addChatMessage:u,prompts:m,projectsData:g,forms:x,updateProspect:w,prospects:C,completeStepAndProceed:b,registerClientForm:h}=Be();dt();const{messages:M,loading:p}=vs(t,s),{uploadFile:F,uploading:T}=ys({projectType:s,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:f}=tt({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),{user:k}=at(),[E,y]=n.useState(""),[i,c]=n.useState(null),R=n.useRef(null),J=n.useRef(null),[S,$]=n.useState(!1),[le,oe]=n.useState(!1),{organizationId:me}=ct(),{templates:G,loading:fe}=Ns(me||(r==null?void 0:r.organization_id),s),{forms:U,loading:A}=Vs(me||(r==null?void 0:r.organization_id)),{templates:V,loading:ue}=Bs(me||(r==null?void 0:r.organization_id)),B=(ye=(ce=g[s])==null?void 0:ce.steps)==null?void 0:ye[a],d=n.useMemo(()=>B!=null&&B.name?B.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`,[B,a]),z=n.useMemo(()=>{if(!G||!d)return null;const j=G[`${s}:${d}`];return(j==null?void 0:j.configJson)||null},[G,d,s]),Z=n.useMemo(()=>U?Object.values(U).map(j=>({id:j.id,name:j.name||j.title||"Formulaire sans nom"})):[],[U]),Y=n.useMemo(()=>V?Array.isArray(V)?V.map(j=>({id:j.id,name:j.name||"Template sans nom"})):Object.values(V).map(j=>({id:j.id,name:j.name||"Template sans nom"})):[],[V]),v=C.find(j=>j.id===t),I=n.useMemo(()=>Object.values(m).filter(j=>{var ge;if(j.projectId!==s)return!1;const ie=(ge=j.stepsConfig)==null?void 0:ge[a];return ie&&ie.actions&&ie.actions.length>0}),[m,s,a]),te=n.useCallback(async(j=null)=>{var be;const ie=I[0];if(!ie){N.warn("Aucun prompt disponible");return}const ge=(be=ie.stepsConfig)==null?void 0:be[a];if(!ge||!ge.actions){N.warn("Aucune action dans la config de l'√©tape");return}const ve=[...ge.actions].sort((Ie,Ne)=>(Ie.order||0)-(Ne.order||0));if(j){const Ie=ve.findIndex(Ne=>Ne.id===j);if(Ie!==-1&&Ie+1<ve.length){const Ne=ve[Ie+1];N.info("üéØ Action suivante trouv√©e",{completedActionId:j,nextActionId:Ne.id,nextActionType:Ne.type}),await de(ie,Ne.id);return}else{N.warn("Pas d'action suivante",{completedActionId:j,totalActions:ve.length});return}}await de(ie)},[I,a]);tr({prospectId:t,projectType:s,currentStepIndex:a,prompt:I[0],sendNextAction:te}),n.useEffect(()=>{requestAnimationFrame(()=>{var j;(j=R.current)==null||j.scrollIntoView({behavior:"smooth",block:"end"})})},[M]);const q=async()=>{if(!(!E.trim()&&!i))try{let j=null;if(i){if(i.size>10485760){X({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}N.debug("üì§ Uploading file from admin chat",{name:i.name,size:i.size,type:i.type});const{data:{user:ve}}=await xe.auth.getUser(),be=await F({file:i,uploadedBy:ve==null?void 0:ve.id});be&&(j={id:be.id,name:be.file_name,size:be.file_size,type:be.file_type,storagePath:be.storage_path},N.debug("‚úÖ File uploaded successfully",j))}u(t,s,{sender:"pro",text:E,file:j}),y(""),c(null),requestAnimationFrame(()=>{var ge;(ge=R.current)==null||ge.scrollIntoView({behavior:"smooth",block:"end"})}),j&&X({title:"‚úÖ Fichier envoy√©",description:`${j.name} a √©t√© envoy√© avec succ√®s.`})}catch(j){N.error("‚ùå Error sending message with file",j),X({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${j.message}`,variant:"destructive"})}},re=j=>{j.target.files&&j.target.files[0]&&c(j.target.files[0])},H=async j=>{if(!j||!j.storagePath){X({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{N.debug("üì• Downloading file",{storagePath:j.storagePath});const{data:ie,error:ge}=await xe.storage.from("project-files").createSignedUrl(j.storagePath,3600);if(ge)throw ge;window.open(ie.signedUrl,"_blank"),X({title:"‚úÖ T√©l√©chargement",description:`${j.name} s'ouvre dans un nouvel onglet.`})}catch(ie){N.error("‚ùå Error downloading file",ie),X({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${ie.message}`,variant:"destructive"})}},W=(j,ie,ge)=>{var De;const ve=C.find(_e=>_e.id===j);if(!ve)return;const be={...ve.formData||{},...ge};w({...ve,formData:be});const Ie={sender:"client",text:`A compl√©t√© le formulaire : ${((De=x[ie])==null?void 0:De.name)||"Formulaire"}.`};if(u(j,s,Ie),Object.values(m).find(_e=>{var Re,Se;if(_e.projectId!==s)return!1;const Pe=(Re=_e.stepsConfig)==null?void 0:Re[a];return Pe!=null&&Pe.autoCompleteStep?(Se=Pe.actions)==null?void 0:Se.some(je=>je.type==="show_form"&&je.formId===ie):!1})){const _e=z==null?void 0:z.actions;if(_e&&_e.length>1){X({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}b(t,s,a),X({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},de=async(j,ie=null)=>{var ve,be,Ie,Ne,De,_e,Pe,Re;const ge=(ve=j.stepsConfig)==null?void 0:ve[a];if(ge&&ge.actions&&ge.actions.length>0){const Se=M,je=[...ge.actions].sort((o,P)=>(o.order||0)-(P.order||0));let pe=je,ee=!1;if(ie){const o=je.find(P=>P.id===ie);if(!o){N.warn("Action sp√©cifique introuvable",{specificActionId:ie});return}N.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:ie,actionType:o.type}),pe=[o],ee=!0}for(const o of pe)if(!(!ee&&Se.some(K=>K.promptId===j.id&&K.stepIndex===a&&(K.text===o.message||K.formId===o.formId&&o.type==="show_form")))){if(o.message){const P={sender:"pro",text:o.message,promptId:j.id,stepIndex:a,actionId:o.id};u(t,s,P)}if(o.type==="show_form"&&o.formId){const P={sender:"pro",formId:o.formId,promptId:j.id,stepIndex:a,actionId:o.id};u(t,s,P);const K=((Ne=(Ie=(be=g[s])==null?void 0:be.steps)==null?void 0:Ie[a])==null?void 0:Ne.name)||"√âtape inconnue";try{const ne=await h({prospectId:t,projectType:s,formId:o.formId,currentStepIndex:a,promptId:j.id,messageTimestamp:Date.now(),status:"pending",stepName:K,actionId:o.id});if(!ne.success)N.error("‚ùå √âchec enregistrement formulaire:",ne.error),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const l=((De=x[o.formId])==null?void 0:De.name)||o.formId;await f({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${l} a √©t√© envoy√© √† ${(v==null?void 0:v.name)||"le client"}.`,createdBy:(k==null?void 0:k.user_id)||null,createdByName:(k==null?void 0:k.name)||"Admin"})}catch(l){N.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",l)}}catch(ne){N.error("‚ùå Exception enregistrement formulaire:",ne),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(o.type==="start_signature"&&o.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");N.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:o.templateId,prospectId:t,projectType:s,organizationId:r.organization_id,formId:o.formId});const{data:P,error:K}=await xe.from("prospects").select("form_data").eq("id",t).single(),ne=((Pe=(_e=P==null?void 0:P.form_data)==null?void 0:_e[s])==null?void 0:Pe[o.formId])||{};N.info("üìã Donn√©es formulaire extraites",{formId:o.formId,dataKeys:Object.keys(ne)}),X({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const l=await xa({templateId:o.templateId,projectType:s,prospectId:t,formData:ne,organizationId:r==null?void 0:r.organization_id});if(l.success){const _=l.fileData.id;N.debug("Cr√©ation proc√©dure de signature...",{fileId:_,prospectId:t,projectType:s});const{data:D}=await xe.from("signature_procedures").select("*").eq("file_id",_).eq("prospect_id",t).eq("status","pending").maybeSingle();let se=D;if(!se){const Q=crypto.randomUUID(),ae=new Date;ae.setDate(ae.getDate()+7);const we=[{role:"principal",name:(v==null?void 0:v.name)||"Client",email:v==null?void 0:v.email,phone:(v==null?void 0:v.phone)||null,access_token:Q,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const Ce=typeof(v==null?void 0:v.name)=="string"&&v.name.trim()!==""?v.name:((Re=v==null?void 0:v.email)==null?void 0:Re.split("@")[0])||"Client",$e=v==null?void 0:v.email,{data:Ee,error:Qe}=await xe.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:_,access_token:Q,access_token_expires_at:ae.toISOString(),status:"pending",signers:we,organization_id:r.organization_id,signer_name:Ce,signer_email:$e}).select().single();if(Qe)throw N.error("Erreur cr√©ation signature_procedures",Qe),Qe;se=Ee,N.debug("Proc√©dure de signature cr√©√©e",{procedureId:se.id,signersCount:we.length})}const O=`https://evatime.fr/signature/${se.id}?token=${se.access_token}`,{data:L}=await xe.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${se.id}%`).maybeSingle();L||(await xe.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${O}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id}),N.debug("Lien de signature envoy√© dans le chat")),X({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await f({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(v==null?void 0:v.name)||"le client"}.`,createdBy:(k==null?void 0:k.user_id)||null,createdByName:(k==null?void 0:k.name)||"Admin"})}catch(Q){N.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Q)}}else throw new Error(l.error||"Erreur inconnue")}catch(P){N.error("‚ùå Exception g√©n√©ration contrat:",P),X({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${P.message}`,variant:"destructive"})}break}}$(!1)};return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[M.map((j,ie)=>e.jsxs("div",{className:`flex items-end gap-2 ${j.sender==="pro"?"justify-end":"justify-start"}`,children:[j.sender==="client"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(v==null?void 0:v.name.charAt(0))||"?"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${j.sender==="pro"?"bg-blue-500 text-white rounded-br-none p-2.5":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[j.text&&(j.sender==="pro"&&j.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:j.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:j.text})),j.file&&e.jsxs("button",{onClick:()=>H(j.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(ze,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:j.file.name}),e.jsx(pt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),j.formId&&x[j.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(hr,{form:x[j.formId],prospectId:t,onFormSubmit:W})}),e.jsx("p",{className:`text-xs mt-1 ${j.sender==="pro"?"text-blue-200":"text-gray-500"}`,children:fa(new Date(j.timestamp),{addSuffix:!0,locale:Ve})})]}),j.sender==="pro"&&!j.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},ie)),e.jsx("div",{ref:R})]}),i&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Ht,{className:"w-4 h-4"}),e.jsx("span",{children:i.name}),e.jsx("button",{onClick:()=>c(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{placeholder:"√âcrire au client...",className:"pr-28 h-12",value:E,onChange:j=>y(j.target.value),onKeyPress:j=>j.key==="Enter"&&q()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(he,{variant:"ghost",size:"icon",onClick:()=>oe(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(ps,{className:"h-5 w-5 text-purple-600"})}),e.jsx(he,{variant:"ghost",size:"icon",onClick:()=>J.current.click(),disabled:T,children:e.jsx(Ht,{className:`h-5 w-5 ${T?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:J,onChange:re,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:T}),e.jsx(he,{onClick:q,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:T,children:T?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Hs,{className:"h-4 w-4"})})]})]}),e.jsx(xr,{isOpen:le,onClose:()=>oe(!1),prospectId:t,projectType:s,moduleId:d,moduleName:(B==null?void 0:B.name)||`√âtape ${a+1}`,moduleConfig:z,context:{organizationId:me||(r==null?void 0:r.organization_id),adminUser:r},availableForms:Z,availableTemplates:Y})]})},br=({steps:t,onUpdateStatus:s,prompts:a,projectType:r,currentStepIndex:u,prospectId:m,completeStepAndProceed:g})=>{var f;if(!t)return null;const[x,w]=n.useState({}),{activeAdminUser:C,appointments:b,updateAppointment:h}=Be(),M=a?Object.values(a).find(k=>k.projectId===r):null,p=(f=M==null?void 0:M.stepsConfig)==null?void 0:f[u],F=n.useMemo(()=>{if(!t[u])return[];const k=t[u].name,E=b.filter(y=>y.type==="task"&&y.contactId===m&&y.projectId===r&&y.step===k);return E.length>0&&N.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:m,projectType:r,stepName:k,totalAppointments:b.length,filteredTasks:E.length,tasks:E.map(y=>({id:y.id,title:y.title,contactId:y.contactId,projectId:y.projectId,step:y.step}))}),E},[b,m,r,u,t]),T=(k,E)=>{w(y=>{var S;const i=y[k]||{},c={...i,[E]:!i[E]},R={...y,[k]:c},J=(S=p==null?void 0:p.actions)==null?void 0:S.find($=>$.id===k);return J&&J.checklist&&J.checklist.every(le=>c[le.id])&&p!=null&&p.autoCompleteStep&&(X({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),g(m,r,u,t)),R})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((k,E)=>{const y=rt[k.status]||rt[qe];return e.jsxs(Ye.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:E*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${y.iconOnly}`,children:k.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${y.text}`,children:k.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[k.subSteps&&k.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[k.subSteps.filter(i=>i.status===Le).length,"/",k.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(he,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${y.badge} hover:opacity-90`,onClick:i=>{var S;i.stopPropagation();const c=i.currentTarget,R=c.nextElementSibling,J=c.closest("[data-step-status-container]");!R||!J||((S=J.parentElement)==null||S.querySelectorAll('[data-dropdown="step-status"]').forEach($=>{$!==R&&$.classList.add("hidden")}),R.classList.toggle("hidden"))},children:y.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:i=>{var c;i.stopPropagation(),i.preventDefault(),s(E,Ae),(c=i.currentTarget.parentElement)==null||c.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:i=>{var c;i.stopPropagation(),i.preventDefault(),s(E,Le),(c=i.currentTarget.parentElement)==null||c.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:i=>{var c;i.stopPropagation(),i.preventDefault(),s(E,qe),(c=i.currentTarget.parentElement)==null||c.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),k.subSteps&&k.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:k.subSteps.map((i,c)=>{const R=rt[i.status]||rt[qe];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${i.status===Le?"bg-green-500":i.status===Ae?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:i.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${R.badge}`,children:R.label})]},i.id||c)})}),k.status===Ae&&E===u&&(p==null?void 0:p.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:p.actions.filter(i=>i.hasClientAction===!1&&i.checklist&&i.checklist.length>0).map(i=>{const c=x[i.id]||{},R=i.checklist.length,J=i.checklist.filter($=>c[$.id]).length,S=J===R;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${S?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[J,"/",R]})]}),e.jsx("div",{className:"space-y-2",children:i.checklist.map($=>{const le=c[$.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:le,onChange:()=>T(i.id,$.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${le?"text-purple-500 line-through":"text-purple-800"}`,children:$.text})]},$.id)})}),(p==null?void 0:p.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},i.id)})}),k.status===Ae&&E===u&&F.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:F.map(i=>{const c=i.status==="effectue",R=i.startTime?new Date(i.startTime):null,J=R&&!isNaN(R.getTime()),S=async()=>{const $=c?"pending":"effectue";await h(i.id,{status:$}),X({title:c?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:c?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:c?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:S,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${c?"line-through text-gray-500":""} truncate flex-1`,children:i.title||"T√¢che"}),c&&e.jsx(ut,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),J&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Ke(R,"dd/MM/yyyy √† HH:mm",{locale:Ve})]})]})]},i.id)})})]})]},E)})})]})},jr=({prospect:t,projectType:s,supabaseSteps:a,v2Templates:r,onUpdate:u})=>{var B;const{forms:m,prompts:g,completeStepAndProceed:x,activeAdminUser:w,appointments:C,updateAppointment:b}=Be(),{formPanels:h=[],loading:M,updateFormPanel:p}=Gs(t.id),{sendMessage:F}=vs(t.id,s),[T,f]=n.useState(null),[k,E]=n.useState({}),[y,i]=n.useState(!1),[c,R]=n.useState(null),[J,S]=n.useState(""),[$,le]=n.useState(new Set),oe=n.useMemo(()=>{if(!h)return[];const d=h.filter(z=>z.prospectId===t.id&&z.projectType===s).sort((z,Z)=>(Z.createdAt||0)-(z.createdAt||0));return N.debug("[ProspectForms] Filtering panels",{totalPanels:h.length,prospectId:t.id,projectType:s,filteredCount:d.length,samplePanel:h[0]}),d},[h,t.id,s]);if(n.useEffect(()=>{!oe||oe.length===0||oe.forEach(d=>{var Z,Y,v,I;if($.has(d.panelId)||d.status!=="submitted")return;if(d.lastSubmittedAt){const te=new Date(d.lastSubmittedAt).getTime(),re=Date.now()-te;if(re>1e4){N.debug("Form too old, skipping auto-complete",{panelId:d.panelId,ageSeconds:Math.floor(re/1e3)}),le(H=>new Set([...H,d.panelId]));return}}N.debug("New submitted form detected",{panelId:d.panelId,formId:d.formId,projectType:d.projectType}),N.debug("Available prompts",{count:Object.keys(g).length});let z=null;if(d.promptId&&(N.debug("Searching by promptId",{promptId:d.promptId}),z=g[d.promptId]),z||(z=Object.values(g).find(te=>{var H,W;if(N.debug("Testing prompt",{name:te.name,projectId:te.projectId,target:d.projectType}),te.projectId!==d.projectType)return!1;const q=(H=te.stepsConfig)==null?void 0:H[d.currentStepIndex];return(W=q==null?void 0:q.actions)==null?void 0:W.some(de=>de.type==="show_form"&&de.formId===d.formId)})),N.debug("Prompt found",{name:z==null?void 0:z.name,autoComplete:(Y=(Z=z==null?void 0:z.stepsConfig)==null?void 0:Z[d.currentStepIndex])==null?void 0:Y.autoCompleteStep}),z){const te=(v=z.stepsConfig)==null?void 0:v[d.currentStepIndex],q=(I=te==null?void 0:te.actions)==null?void 0:I.find(H=>H.type==="show_form"&&H.formId===d.formId),re=(q==null?void 0:q.verificationMode)||"human";N.debug("Checking auto-complete conditions",{autoCompleteStep:te==null?void 0:te.autoCompleteStep,verificationMode:re}),te!=null&&te.autoCompleteStep&&re==="none"&&(N.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),x(t.id,d.projectType,d.currentStepIndex),X({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}le(te=>new Set([...te,d.panelId]))})},[oe,g,x,t.id,t.name,$]),oe.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const me=d=>{f(d.panelId);const Y=((t.form_data||t.formData||{})[d.projectType]||{})[d.formId]||{};E({...Y,_meta:{projectType:d.projectType,formId:d.formId}})},G=()=>{f(null),E({})},fe=async()=>{const{_meta:d,...z}=k,{projectType:Z,formId:Y}=d||{};if(!Z||!Y){N.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const v=t.form_data||t.formData||{},I={...v,[Z]:{...v[Z]||{},[Y]:z}},{error:te}=await xe.from("prospects").update({form_data:I}).eq("id",t.id);if(te){N.error("‚ùå Erreur sauvegarde formulaire:",te),X({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}X({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),u&&u({...t,form_data:I,formData:I}),f(null),E({})},U=(d,z)=>{E(Z=>({...Z,[d]:z}))},A=d=>{var Y,v;const z=Object.values(g).find(I=>I.id===d.promptId||I.projectId===d.projectType),Z=(Y=z==null?void 0:z.stepsConfig)==null?void 0:Y[d.currentStepIndex];return(v=Z==null?void 0:Z.actions)==null?void 0:v.find(I=>I.formId===d.formId)},V=async d=>{var z,Z,Y,v,I,te;try{await p(d.panelId,{status:"approved"});const q=A(d),re=(q==null?void 0:q.verificationMode)||"human";if(N.debug("üîç Checking verification mode",{verificationMode:re,shouldSearchTask:re==="human"}),re==="human"){N.debug("üîç Searching for related task",{totalAppointments:(C==null?void 0:C.length)||0,prospectId:t.id,projectType:d.projectType,stepName:d.stepName,panel:d});const Se=(C==null?void 0:C.filter(ee=>ee.type==="task"))||[],je=Se.filter(ee=>ee.contactId===t.id);N.debug("üîç Task filtering debug",{allTasks:Se.length,prospectTasks:je.length,prospectTasksData:je.map(ee=>({id:ee.id,title:ee.title,contactId:ee.contactId,projectId:ee.projectId,step:ee.step,status:ee.status}))}),N.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:d.projectType,step:d.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let pe=C==null?void 0:C.find(ee=>{var K;const o={isTask:ee.type==="task",contactMatch:ee.contactId===t.id,projectMatch:ee.projectId===d.projectType,stepMatch:ee.step===d.stepName,isPending:ee.status==="pending",titleMatch:(K=ee.title)==null?void 0:K.includes("V√©rifier le formulaire")},P=Object.values(o).every(ne=>ne);return!P&&ee.type==="task"&&ee.contactId===t.id&&N.warn("üîç Task failed matching:",{taskId:ee.id,title:ee.title,checks:o,COMPARISON:{taskStep:`"${ee.step}"`,panelStep:`"${d.stepName}"`,areEqual:ee.step===d.stepName,taskStepType:typeof ee.step,panelStepType:typeof d.stepName},taskData:{contactId:ee.contactId,projectId:ee.projectId,step:ee.step,status:ee.status},panelData:{projectType:d.projectType,stepName:d.stepName}}),P});pe||(N.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:d.stepName}),pe=C==null?void 0:C.find(ee=>{var o;return ee.type==="task"&&ee.contactId===t.id&&ee.projectId===d.projectType&&ee.status==="pending"&&((o=ee.title)==null?void 0:o.includes("V√©rifier le formulaire"))}),pe&&N.info("‚úÖ Found task via fallback (without step match)",{taskId:pe.id,taskStep:pe.step})),pe?(N.info("‚úÖ Found verification task, marking as completed",{taskId:pe.id,prospectId:t.id,title:pe.title}),await b(pe.id,{status:"effectue"}),X({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):N.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:d.projectType,step:d.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else N.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:re});const H=a==null?void 0:a[d.projectType],W=(H==null?void 0:H.findIndex(Se=>Se.status==="in_progress"))??d.currentStepIndex,de=(z=H==null?void 0:H[W])==null?void 0:z.name,ce=de?de.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,ye=`${d.projectType}:${ce}`,j=ce&&r?r[ye]:null,ie=(Z=j==null?void 0:j.configJson)==null?void 0:Z.actionConfig;N.debug("[V2] Template lookup",{panelProjectType:d.projectType,propProjectType:s,currentStepName:de,moduleId:ce,templateKey:ye,v2TemplatesKeys:r?Object.keys(r):[],templateFound:!!j});const ge=de?fs(de):null,ve=(ie==null?void 0:ie.completionTrigger)||(ge==null?void 0:ge.completionTrigger),be=(Y=j==null?void 0:j.configJson)==null?void 0:Y.actions,Ie=be&&be.length>1;let Ne=!0;if(Ie){const Se=be.map((o,P)=>`v2-${ce}-action-${P}`),{data:je}=await xe.from("client_form_panels").select("id, action_id").eq("prospect_id",t.id).eq("project_type",d.projectType).eq("status","approved").in("action_id",Se);let pe=new Set((je||[]).map(o=>o.action_id));if(pe.size===0){const{data:o}=await xe.from("client_form_panels").select("id, step_name").eq("prospect_id",t.id).eq("project_type",d.projectType).eq("status","approved");(o||[]).filter(K=>!K.step_name||K.step_name===de||K.step_name===ce).forEach((K,ne)=>{ne<be.length&&pe.add(`v2-${ce}-action-${ne}`)})}const ee=pe.size;Ne=ee>=be.length,N.debug("[V2] Multi-actions check (by action_id)",{totalActions:be.length,approvedActionIds:[...pe],allCompleted:Ne}),Ne||(N.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:be.length-ee}),X({title:"‚úÖ Action valid√©e",description:`Action ${ee}/${be.length} ‚Äî il reste ${be.length-ee} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}N.debug("[V2] Checking completionTrigger for form approval",{stepName:de,moduleId:ce,v2TemplateFound:!!j,completionTrigger:ve,currentStepIdx:W,hasMultiActions:Ie,allActionsCompleted:Ne});const De=(ve==="form_approved"||!ve)&&Ne;let _e=H;if(H&&((I=(v=H[W])==null?void 0:v.subSteps)==null?void 0:I.length)>0&&d.action_id){const Se=H[W],je=Se.subSteps.findIndex(pe=>pe.id===d.action_id);if(je!==-1){N.debug("[V2] Updating substep for approved action",{actionId:d.action_id,subStepIndex:je,subStepName:Se.subSteps[je].name,allActionsCompleted:Ne});const pe=JSON.parse(JSON.stringify(H));if(pe[W].subSteps.forEach((ee,o)=>{ee.status===Ae&&o!==je&&(ee.status=Le)}),pe[W].subSteps[je].status=Le,!Ne){let ee=-1;for(let o=je+1;o<pe[W].subSteps.length;o++)if(pe[W].subSteps[o].status===qe){ee=o;break}ee!==-1&&(pe[W].subSteps[ee].status=Ae,N.debug("[V2] Activated next substep",{completedIndex:je,nextIndex:ee,nextName:pe[W].subSteps[ee].name}))}await updateSupabaseSteps(d.projectType,pe),_e=pe,N.info("[V2] Substep updated successfully",{completedSubStep:je,nextActivated:!Ne})}}if(De&&_e)N.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:d.projectType,currentStepIdx:W,stepName:de,trigger:ve||"default_behavior"}),await x(t.id,d.projectType,W,_e),X({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const Se=Object.values(g).find(je=>je.id===d.promptId||je.projectId===d.projectType);if(Se){const je=(te=Se.stepsConfig)==null?void 0:te[d.currentStepIndex];je!=null&&je.autoCompleteStep&&(N.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:d.projectType,stepIndex:d.currentStepIndex}),H?await x(t.id,d.projectType,d.currentStepIndex,H):N.error("No steps found in supabaseSteps for projectType",{projectType:d.projectType}))}}const Pe=(q==null?void 0:q.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:Re}=await xe.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",d.projectType).eq("sender","admin").eq("text",Pe).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!Re||Re.length===0?await F({sender:"admin",text:Pe,relatedMessageTimestamp:new Date().toISOString()}):N.debug("Message de validation d√©j√† envoy√© r√©cemment, skip"),X({title:"‚úÖ Formulaire valid√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(q){N.error("‚ùå Erreur validation formulaire:",q),X({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},ue=async(d="")=>{if(c)try{const z=c;await p(z.panelId,{status:"rejected"});const Z=A(z),Y=(Z==null?void 0:Z.verificationMode)||"human";if(N.debug("üîç Checking verification mode (reject)",{verificationMode:Y,shouldSearchTask:Y==="human"}),Y==="human"){N.debug("üîç Searching for related task (reject)",{totalAppointments:(C==null?void 0:C.length)||0,prospectId:t.id,projectType:z.projectType,stepName:z.stepName}),N.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:z.projectType,step:z.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let te=C==null?void 0:C.find(q=>{var W;const re={isTask:q.type==="task",contactMatch:q.contactId===t.id,projectMatch:q.projectId===z.projectType,stepMatch:q.step===z.stepName,isPending:q.status==="pending",titleMatch:(W=q.title)==null?void 0:W.includes("V√©rifier le formulaire")},H=Object.values(re).every(de=>de);return!H&&q.type==="task"&&q.contactId===t.id&&N.warn("üîç Task failed matching (REJECT):",{taskId:q.id,title:q.title,checks:re,COMPARISON:{taskStep:`"${q.step}"`,panelStep:`"${z.stepName}"`,areEqual:q.step===z.stepName,taskStepType:typeof q.step,panelStepType:typeof z.stepName},taskData:{contactId:q.contactId,projectId:q.projectId,step:q.step,status:q.status},panelData:{projectType:z.projectType,stepName:z.stepName}}),H});te||(N.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:z.stepName}),te=C==null?void 0:C.find(q=>{var re;return q.type==="task"&&q.contactId===t.id&&q.projectId===z.projectType&&q.status==="pending"&&((re=q.title)==null?void 0:re.includes("V√©rifier le formulaire"))}),te&&N.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:te.id,taskStep:te.step})),te&&(N.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:te.id,prospectId:t.id,title:te.title}),await b(te.id,{status:"effectue"}))}else N.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:Y});const I=`${(Z==null?void 0:Z.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${d}`;await F({sender:"admin",text:I,relatedMessageTimestamp:new Date().toISOString()}),X({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"}),i(!1),R(null),S("")}catch(z){N.error("‚ùå Erreur rejet formulaire:",z),X({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[oe.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:oe.map(d=>{const z=m[d.formId],v=((t.form_data||t.formData||{})[d.projectType]||{})[d.formId]||{};return z?e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:z.name}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",d.stepName||"Non sp√©cifi√©e"]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${d.status==="submitted"?"bg-green-100 text-green-700":d.status==="approved"?"bg-blue-100 text-blue-700":d.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:d.status==="submitted"?"Envoy√©":d.status==="approved"?"Approuv√©":d.status==="rejected"?"Rejet√©":"En attente"})]}),d.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsx("p",{className:"text-sm text-green-700",children:"‚úÖ Client a soumis ce formulaire"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(he,{size:"sm",onClick:()=>V(d),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(ut,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(he,{size:"sm",variant:"outline",onClick:()=>{R(d),i(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(z.fields||[]).map(I=>{if(I.show_if_conditions&&I.show_if_conditions.length>0){const H=I.condition_operator||"AND",W=I.show_if_conditions.map(ce=>{const ye=v[ce.field];return ce.equals==="has_value"?!!ye&&ye!=="":ye===ce.equals});if(!(H==="AND"?W.every(ce=>ce===!0):W.some(ce=>ce===!0)))return null}if(I.show_if){const H=I.show_if.field,W=I.show_if.equals,de=v[H];if(!de||de!==W)return null}if((z.fields||[]).some(H=>H.is_repeater&&(H.repeats_fields||[]).includes(I.id)))return null;const q=v[I.id],re=I.type==="file"&&typeof q=="object"&&(q==null?void 0:q.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Oe,{className:"text-sm font-medium text-gray-600",children:I.label}),T===d.panelId?re?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(ze,{className:"inline h-4 w-4 mr-2"}),q.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):I.type==="select"?e.jsxs("select",{value:k[I.id]||"",onChange:H=>U(I.id,H.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(I.options||[]).map((H,W)=>e.jsx("option",{value:H,children:H},W))]}):e.jsx(He,{type:I.type||"text",value:k[I.id]||"",onChange:H=>U(I.id,H.target.value),placeholder:I.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:re?e.jsxs("button",{onClick:async()=>{try{const{data:H,error:W}=await xe.storage.from("project-files").createSignedUrl(q.storagePath,3600);if(W)throw W;window.open(H.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx("span",{children:q.name}),e.jsx(pt,{className:"h-3 w-3"})]}):q||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),I.is_repeater&&I.repeats_fields&&I.repeats_fields.length>0&&q&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(q)||0},(H,W)=>{const de=(z.fields||[]).filter(ce=>I.repeats_fields.includes(ce.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[I.label," #",W+1]}),de.map(ce=>{const ye=`${I.id}_repeat_${W}_${ce.id}`,j=v[ye],ie=ce.type==="file"&&typeof j=="object"&&(j==null?void 0:j.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Oe,{className:"text-xs font-medium text-gray-600",children:ce.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:ie?e.jsxs("button",{onClick:async()=>{try{const{data:ge,error:ve}=await xe.storage.from("project-files").createSignedUrl(j.storagePath,3600);if(ve)throw ve;window.open(ge.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(ze,{className:"h-3 w-3"}),e.jsx("span",{children:j.name}),e.jsx(pt,{className:"h-3 w-3"})]}):j||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},ye)})]},W)})})]},I.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T===d.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(he,{variant:"outline",size:"sm",onClick:G,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(he,{size:"sm",onClick:fe,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Lt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(he,{variant:"outline",size:"sm",onClick:()=>me(d),children:[e.jsx(ht,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},d.panelId):null})}),e.jsx(ft,{open:y,onOpenChange:i,children:e.jsxs(bt,{className:"max-w-lg",children:[e.jsxs(jt,{children:[e.jsx(yt,{children:"Rejeter le formulaire"}),e.jsx(bs,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((B=A(c))==null?void 0:B.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{children:"Raison du refus"}),e.jsx("textarea",{value:J,onChange:d=>S(d.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Ot,{children:[e.jsx(he,{variant:"outline",onClick:()=>{i(!1),R(null),S("")},children:"Annuler"}),e.jsx(he,{onClick:()=>ue(J),disabled:!J.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},yr=({prospect:t,projectType:s,onUpdate:a})=>{const{forms:r}=Be(),[u,m]=n.useState(null),[g,x]=n.useState({}),w=n.useMemo(()=>Object.values(r).filter(p=>p.audience==="internal"&&(p.projectIds||[]).includes(s)),[r,s]);n.useEffect(()=>{if(t&&t.form_data){const p=t.form_data[s]||{};x(p)}},[t,s]);const C=p=>{m(p)},b=()=>{if(m(null),t&&t.form_data){const p=t.form_data[s]||{};x(p)}},h=(p,F,T)=>{x(f=>({...f,[p]:{...f[p]||{},[F]:T}}))},M=async()=>{try{const p={...t.form_data||{},[s]:g},F={...t,form_data:p,formData:p};await a(F),X({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),m(null)}catch(p){N.error("Erreur sauvegarde formulaire interne:",p),X({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[w.length," formulaire(s)"]})]}),w.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:w.map(p=>{const F=g[p.id]||{},T=u===p.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:p.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(p.fields||[]).map(f=>{if(f.show_if_conditions&&f.show_if_conditions.length>0){const y=f.condition_operator||"AND",i=f.show_if_conditions.map(R=>{const J=F[R.field];return R.equals==="has_value"?!!J&&J!=="":J===R.equals});if(!(y==="AND"?i.every(R=>R===!0):i.some(R=>R===!0)))return null}if(f.show_if){const y=f.show_if.field,i=f.show_if.equals,c=F[y];if(!c||c!==i)return null}if((p.fields||[]).some(y=>y.is_repeater&&(y.repeats_fields||[]).includes(f.id)))return null;const E=F[f.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Oe,{className:"text-sm font-medium text-gray-600",children:[f.label,f.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),T?f.type==="textarea"?e.jsx("textarea",{value:E,onChange:y=>h(p.id,f.id,y.target.value),placeholder:f.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):f.type==="select"?e.jsxs("select",{value:E,onChange:y=>h(p.id,f.id,y.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(f.options||[]).map((y,i)=>e.jsx("option",{value:y,children:y},i))]}):e.jsx(He,{type:f.type||"text",value:E,onChange:y=>h(p.id,f.id,y.target.value),placeholder:f.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:E||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),f.is_repeater&&f.repeats_fields&&f.repeats_fields.length>0&&E&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(E)||0},(y,i)=>{const c=(p.fields||[]).filter(R=>f.repeats_fields.includes(R.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[f.label," #",i+1]}),c.map(R=>{const J=`${f.id}_repeat_${i}_${R.id}`,S=F[J]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Oe,{className:"text-xs font-medium text-gray-600",children:R.label}),T?R.type==="textarea"?e.jsx("textarea",{value:S,onChange:$=>h(p.id,J,$.target.value),placeholder:R.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):R.type==="select"?e.jsxs("select",{value:S,onChange:$=>h(p.id,J,$.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(R.options||[]).map(($,le)=>e.jsx("option",{value:$,children:$},le))]}):e.jsx(He,{type:R.type||"text",value:S,onChange:$=>h(p.id,J,$.target.value),placeholder:R.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:S||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},J)})]},i)})})]},f.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T?e.jsxs(e.Fragment,{children:[e.jsxs(he,{variant:"outline",size:"sm",onClick:b,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(he,{size:"sm",onClick:M,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Lt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(he,{variant:"outline",size:"sm",onClick:()=>C(p.id),children:[e.jsx(ht,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},p.id)})})]})},vr=t=>{switch(t.type){case"email":return e.jsx(vt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(st,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Ws,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(Nt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(lt,{className:"h-4 w-4 text-gray-400"}):e.jsx(Js,{className:"h-4 w-4 text-gray-400"})}},Nr=({prospect:t,onBack:s,onUpdate:a,onEditingChange:r})=>{var ne;const{getProjectSteps:u,completeStepAndProceed:m,updateProjectSteps:g,markNotificationAsRead:x,projectsData:w,formContactConfig:C,currentUser:b,userProjects:h,setUserProjects:M,getProjectInfo:p,updateProjectInfo:F,activeAdminUser:T,prompts:f,notifications:k}=Be(),{supabaseUserId:E}=at(),{users:y,loading:i}=dt(),{projectStepsStatus:c,updateProjectSteps:R}=oa(t.id),{organizationId:J}=ct(),{templates:S}=Ns(J||(T==null?void 0:T.organization_id),null),[$,le]=hs(),oe=$.get("project")||t._selectedProjectType,me=$.get("notificationId"),[G,fe]=n.useState(oe||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:U,addProjectEvent:A}=tt({projectType:G||"",prospectId:t.id,enabled:!!G&&!!t.id,activeAdminUser:T}),[V,ue]=n.useState(!1),[B,d]=n.useState(t);n.useEffect(()=>{d(t)},[t]);const[z,Z]=n.useState(!1),Y=n.useMemo(()=>G?p(t.id,G)||{}:{},[G,p,t.id]),[v,I]=n.useState((Y==null?void 0:Y.status)||"actif"),[te,q]=n.useState({}),re=Y==null?void 0:Y.amount,H=n.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[W,de]=n.useState(""),[ce,ye]=n.useState(!1),j=n.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...y.map(l=>({value:l.user_id,label:l.name}))],[y]),ie=n.useMemo(()=>{var _;if(!G)return[];if(c[G])return c[G].map(D=>es(D,G,S)).map(Ut);const l=(_=w[G])==null?void 0:_.steps;if(l&&l.length>0){const D=JSON.parse(JSON.stringify(l));return D[0].status="in_progress",D.map(se=>es(se,G,S)).map(Ut)}return[]},[G,c,w,S]),ge=ie.findIndex(l=>l.status===Ae),ve=ie[ge]||ie.find(l=>l.status===qe)||ie[0];n.useEffect(()=>{if(me){x(parseInt(me));const l=new URLSearchParams($);l.delete("notificationId"),le(l,{replace:!0})}},[me,x,le,$]),n.useEffect(()=>{var _;const l=$.get("project");l&&l!==G&&((_=t.tags)!=null&&_.includes(l))&&fe(l)},[$,t.tags]),n.useEffect(()=>{if(!(t!=null&&t.id)||!G||!k||!x)return;const l=k.filter(_=>!_.read&&_.prospectId===t.id&&_.projectType===G);l.length>0&&l.forEach(_=>{x(_.id)})},[t==null?void 0:t.id,G,k,x]),n.useEffect(()=>{N.debug("Prospect prop changed",{name:t.name}),d(t)},[t]),n.useEffect(()=>{ce||(re==null||re===""?de(""):de(re.toString()))},[re,ce]),n.useEffect(()=>{(async()=>{var se;if(!G||!t.id)return;const{data:_,error:D}=await xe.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",G).maybeSingle();D?(N.error("Erreur chargement project status:",D),I("actif")):(se=_==null?void 0:_.data)!=null&&se.status?I(_.data.status):I("actif")})()},[G,t.id]),n.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:_,error:D}=await xe.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(_){const se={};_.forEach(O=>{se[O.project_type]=O.status||"actif"}),q(se)}})()},[t.id,t.tags]),n.useEffect(()=>{r&&r(V)},[V,r]),n.useEffect(()=>{if(!t.id)return;const l=xe.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async _=>{var Ce;const{new:D,old:se}=_;if(D.status!=="signed"||(se==null?void 0:se.status)==="signed")return;const O=D.project_type;N.info("[V2 Signature Listener] Signature completed",{procedureId:D.id,projectType:O,prospectId:D.prospect_id});const L=c==null?void 0:c[O];if(!L||L.length===0){N.warn("[V2 Signature Listener] No steps found for project type",{projectType:O});return}const Q=L.findIndex($e=>$e.status==="in_progress");if(Q===-1){N.warn("[V2 Signature Listener] No current step in_progress",{projectType:O});return}const ae=(Ce=L[Q])==null?void 0:Ce.name;if(!ae){N.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:Q});return}const we=fs(ae);if((we==null?void 0:we.completionTrigger)!=="signature"){N.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:ae,completionTrigger:(we==null?void 0:we.completionTrigger)||"null"});return}N.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:O,currentStepIdx:Q,stepName:ae});try{await m(t.id,O,Q,L),X({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${ae}"`,className:"bg-green-500 text-white"})}catch($e){N.error("[V2 Signature Listener] Error completing step",$e)}}).subscribe();return()=>{xe.removeChannel(l)}},[t.id,c,m]);const be=l=>{fe(l),le(_=>(_.set("project",l),_),{replace:!0})},Ie=async l=>{if(!G||!t.id)return;const _=v;I(l);try{const{error:D}=await xe.from("project_infos").upsert({prospect_id:t.id,project_type:G,status:l,data:(Y==null?void 0:Y.data)||{}},{onConflict:"prospect_id,project_type"});if(D)throw D;const se={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:O}=await xe.from("project_history").insert({prospect_id:t.id,project_type:G,event_type:"status",description:`Projet ${se[l]||l}`,organization_id:T==null?void 0:T.organization_id,metadata:{old_status:_,new_status:l}});O&&N.error("Erreur historique:",O),F(t.id,G,(L={})=>({...L,status:l})),q(L=>({...L,[G]:l})),X({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${se[l]}".`,className:"bg-green-500 text-white"})}catch(D){N.error("Erreur lors du changement de statut:",D),I(_),X({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},Ne=l=>{de(l)},De=l=>{if(!G)return;const _=l.replace(",",".").trim();if(_===""){F(t.id,G,(O={})=>{if(!O.amount)return O;const L={...O};return delete L.amount,L}),de("");return}const D=parseFloat(_);if(Number.isNaN(D)||D<0){de(re==null?"":re.toString());return}const se=Math.round(D*100)/100;F(t.id,G,(O={})=>({...O,amount:se})),de(se.toFixed(2))},_e=()=>{De(W),ye(!1)},Pe=l=>{l.key==="Enter"&&(l.preventDefault(),De(l.currentTarget.value),l.currentTarget.blur(),ye(!1))},Re=async(l,_)=>{var se,O;const D=ie[l];if(_===Le&&((se=D==null?void 0:D.subSteps)==null?void 0:se.length)>0&&!pr(D)){X({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(_===Ae&&((O=D==null?void 0:D.subSteps)==null?void 0:O.length)>0){const L=JSON.parse(JSON.stringify(ie)),Q=L[l];Q.status=Ae,Q.subSteps=Q.subSteps.map((ae,we)=>({...ae,status:we===0?Ae:qe})),await R(G,L),U&&await U({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${Q.name} ¬ª`,metadata:{step_id:(Q==null?void 0:Q.id)||null,step_name:(Q==null?void 0:Q.name)||null,previous_status:(D==null?void 0:D.status)||null,new_status:Ae,project_type:G},createdBy:E,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)});return}if(_===Le){const L=JSON.parse(JSON.stringify(ie));L[l].status="completed";let Q=l+1;if(Q<L.length&&(L[Q].status="in_progress"),await R(G,L),U){const ae=Q<L.length?L[Q]:null;await U({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:D&&ae?`√âtape ¬´ ${D.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${ae.name} ¬ª`:`√âtape ¬´ ${D.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(D==null?void 0:D.id)||null,previous_step_name:(D==null?void 0:D.name)||null,previous_step_status:(D==null?void 0:D.status)||null,new_step_id:(ae==null?void 0:ae.id)||null,new_step_name:(ae==null?void 0:ae.name)||null,new_step_status:"in_progress",project_type:G},createdBy:E,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}if(Q<L.length&&L[Q].globalStepId){const ae=L[Q].globalStepId,we={...t,status:ae};a(we),X({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const L=ie.map((ae,we)=>{let Ce=ae.status;return we===l&&(Ce=_),{...ae,status:Ce}});if(await R(G,L),U){const ae=L[l];await U({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${ae.name} ¬ª pass√©e de ¬´ ${D.status==="pending"?"√Ä venir":D.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${_==="pending"?"√Ä venir":_==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(ae==null?void 0:ae.id)||null,step_name:(ae==null?void 0:ae.name)||null,previous_status:(D==null?void 0:D.status)||null,new_status:_,project_type:G},createdBy:E,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}const Q=L[l];if(Q.globalStepId&&_==="in_progress"){const ae={...t,status:Q.globalStepId};a(ae)}}},Se=async l=>{var D,se;const _=B.tags||[];if(!_.includes(l)){const O={...B,tags:[..._,l]};if(d(O),a(O),fe(l),b&&t.id===b.id&&!h.includes(l)){const Q=[...h,l];M(Q)}const L=(D=w[l])==null?void 0:D.steps;if(L&&L.length>0)try{const Q=JSON.parse(JSON.stringify(L));Q[0].status="in_progress",await R(l,Q),N.debug("Steps initialized in Supabase",{projectType:l})}catch(Q){N.error("Steps initialization error:",Q)}X({title:"‚úÖ Projet ajout√© !",description:`Le projet ${(se=w[l])==null?void 0:se.title} a √©t√© associ√© au prospect.`})}Z(!1)},je=()=>{const l=B.tags||[];return Object.values(w).filter(_=>_.isPublic&&!l.includes(_.type))},pe=async l=>{switch(l){case"Appel":B.phone&&(window.location.href=`tel:${B.phone}`);break;case"Mail":B.email&&(window.location.href=`mailto:${B.email}`);break;case"WhatsApp":if(B.phone){const _=B.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${_}`,"_blank")}else X({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const _=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${_}`:window.open(`https://www.google.com/maps/search/?api=1&query=${_}`,"_blank")}break;case"Invitation":if(!B.email){X({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const _=`${window.location.origin}/dashboard`,D=J||(T==null?void 0:T.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",B.email,"org:",D);const{error:se}=await xe.auth.signInWithOtp({email:B.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:_,data:{organization_id:D}}});se?(console.error("[handleActionClick] ‚ùå Magic link error:",se),X({title:"‚ùå Erreur envoi invitation",description:se.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",B.email),X({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${B.email}`,className:"bg-green-500 text-white"}))}catch(_){console.error("[handleActionClick] üí• Exception:",_),X({title:"‚ùå Erreur",description:_.message,variant:"destructive"})}break;default:X({title:`Action: ${l}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},ee=()=>{const l=window.scrollY;ue(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:l,behavior:"instant"})})})},o=()=>{try{a(B),ue(!1),X({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(l){N.error("‚ùå Erreur sauvegarde:",l),X({title:"‚ùå Erreur",description:l.message,variant:"destructive"})}},P=(l,_)=>{d(D=>({...D,[l]:_}))},K=l=>{let _=l;l==="unassigned"?_=null:l==="user-1"&&E&&(_=E),d(D=>({...D,ownerId:_}))};return w[G],n.useEffect(()=>{const l=document.createElement("style");return l.id="disable-auto-scroll",l.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(l),()=>{const _=document.getElementById("disable-auto-scroll");_&&_.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(he,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Ls,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:B.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(he,{size:"icon",className:"rounded-full",onClick:()=>Z(!0),children:e.jsx(Tt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(B.tags||[]).map(l=>{var D;const _=te[l]||"actif";return e.jsxs("button",{onClick:()=>be(l),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${G===l?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((D=w[l])==null?void 0:D.title)||l}),_==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${G===l?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),_==="archive"&&e.jsx("span",{className:`text-xs font-medium ${G===l?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},l)}),(!B.tags||B.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:st,label:"Appel"},{icon:vt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:Nt,label:"GPS"},{icon:qs,label:"Invitation",highlight:!B.userId}].map(({icon:l,label:_,highlight:D})=>e.jsxs("button",{onClick:()=>pe(_),className:`flex flex-col items-center space-x-1 transition-colors group ${D?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${D?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(l,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:_})]},_))})]}),e.jsx(wr,{prospectId:t.id,projectType:G}),e.jsx(jr,{prospect:B,projectType:G,supabaseSteps:c,v2Templates:S,onUpdate:l=>{d(l),a&&a(l)}}),e.jsx(yr,{prospect:B,projectType:G,onUpdate:l=>{d(l),a&&a(l)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),V?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(he,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:o,children:e.jsx(Lt,{className:"h-4 w-4"})}),e.jsx(he,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>ue(!1),children:e.jsx(Je,{className:"h-4 w-4"})})]}):e.jsx(he,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:ee,children:e.jsx(ht,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[C.map(l=>e.jsxs("div",{className:"flex items-start space-x-3",children:[vr(l),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{htmlFor:l.id,className:"text-xs text-gray-500",children:l.name.replace("*","")}),V?e.jsx(He,{id:l.id,name:l.id,type:l.type,value:B[l.id]||"",onChange:_=>P(l.id,_.target.value),className:"h-8 text-sm",placeholder:l.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:B[l.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},l.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(lt,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{className:"text-xs text-gray-500",children:"Suivi par"}),V?e.jsx(la,{options:j,value:B.ownerId||"unassigned",onSelect:K,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((ne=y.find(l=>l.user_id===B.ownerId))==null?void 0:ne.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ja,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(lt,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(cr,{prospectId:t.id,projectType:G,currentStep:ve,statusConfig:rt,activeAdminUser:T,children:G&&e.jsx(fr,{prospectId:t.id,projectType:G,currentStepIndex:ge!==-1?ge:0,activeAdminUser:T})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[G&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>ye(!ce),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:ce?"Annuler":"Modifier le montant",children:ce?e.jsx(Je,{className:"h-4 w-4 text-gray-600"}):e.jsx(ht,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),ce?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(He,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:W,onChange:l=>Ne(l.target.value),onKeyDown:Pe,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(he,{size:"sm",onClick:_e,className:"h-8",children:e.jsx(ut,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof re=="number"?H.format(re):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Rt,{value:v,onValueChange:Ie,children:[e.jsx(Ft,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${v==="actif"?"bg-green-100 text-green-700":v==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx($t,{})}),e.jsxs(Mt,{className:"w-44",children:[e.jsx(Me,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx(Me,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx(Me,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(br,{steps:ie,onUpdateStatus:Re,prompts:f,projectType:G,currentStepIndex:ge,prospectId:t.id,completeStepAndProceed:m})]})]})]})]}),e.jsx(ft,{open:z,onOpenChange:Z,children:e.jsxs(bt,{className:"sm:max-w-md",children:[e.jsxs(jt,{children:[e.jsx(yt,{children:"Ajouter un projet"}),e.jsx(bs,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:je().length>0?je().map(l=>e.jsxs(he,{variant:"outline",onClick:()=>Se(l.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:l.icon}),e.jsx("span",{className:"font-medium",children:l.title})]},l.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},wr=({prospectId:t,projectType:s})=>{var U;const{activeAdminUser:a,prospects:r,projectsData:u,appointments:m,agendaLoading:g,updateAppointment:x,deleteAppointment:w,addAppointment:C,addCall:b,addTask:h,updateCall:M,updateTask:p}=Be(),{users:F,loading:T}=dt(),{supabaseUserId:f}=at(),[k,E]=n.useState(null),[y,i]=n.useState(null),[c,R]=n.useState(null),[J,S]=n.useState(!1),[$,le]=n.useState(null),oe=n.useMemo(()=>!m||m.length===0?[]:m.filter(V=>{var B;if(V.contactId!==t||s&&V.projectId!==s)return!1;const ue=(B=V.status)==null?void 0:B.toLowerCase();return!(ue!=="pending"&&ue!=="prevu")}).sort((V,ue)=>{const B=new Date(V.start),d=new Date(ue.start);return B-d}),[m,t,s]),me=(A,V)=>{R(A)},G=()=>{E(null),i(null),R(null)},fe=A=>{R(null),le({...A,type:A.type}),S(!0)};return g?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(U=u[s])==null?void 0:U.title})`]})}),oe.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:oe.map(A=>{const V=new Date(A.start),ue={physical:{icon:it,color:"blue",label:"üìç RDV"},virtual:{icon:it,color:"purple",label:"üé• Visio"},call:{icon:st,color:"green",label:"üìû Appel"},task:{icon:ut,color:"yellow",label:"‚úÖ T√¢che"}},B=ue[A.type]||ue.physical,d=B.icon,z={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},Z={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>me(A,A.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${B.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(d,{className:`h-5 w-5 text-${B.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:A.title||B.label}),A.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:A.notes}),A.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",A.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${B.color}-700 bg-${B.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Ke(V,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Ke(V,"HH:mm")})]})]}),Z[A.status]&&A.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${z[A.status]}`,children:Z[A.status]})]},A.id)})})]}),e.jsx(Sr,{event:c,onClose:G,onReport:()=>{},onEdit:fe,prospects:r,supabaseUsers:F,updateAppointment:x,deleteAppointment:w,projectsData:u}),J&&e.jsx(js,{open:J,onOpenChange:A=>{A||le(null),S(A)},initialData:$||{contactId:t,projectId:s},defaultAssignedUserId:f,addAppointment:C,addCall:b,addTask:h,updateAppointment:x,updateCall:M,updateTask:p,prospects:r||[],users:F||[],projectsData:u||{}})]})},Sr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:u,supabaseUsers:m,updateAppointment:g,deleteAppointment:x,projectsData:w})=>{var y;const[C,b]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&b(t.status||"pending")},[t]),!t||!u||!m||!g||!x||!w)return null;const h=u.find(i=>i.id===t.contactId),M=m.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(h?m.find(i=>i.user_id===h.ownerId):null),p=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",F=(i,c,R={})=>{try{const J=new Date(i);return isNaN(J.getTime())?"Date invalide":Ke(J,c,R)}catch{return"Date invalide"}},T=i=>{b(i),g(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},f=()=>{x(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},k=i=>{if(!h){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":h.phone&&(window.location.href=`tel:${h.phone}`);break;case"Mail":h.email&&(window.location.href=`mailto:${h.email}`);break;case"WhatsApp":if(h.phone){let c=h.phone.replace(/\D/g,"");c.startsWith("0")&&(c=`33${c.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${c}?text=${R}`,"_blank")}break;case"GPS":if(h.address){const c=encodeURIComponent(h.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${c}`:window.open(`https://www.google.com/maps/search/?api=1&query=${c}`,"_blank")}break;default:X({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(ft,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(bt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p(F(t.start,"eeee d MMMM",{locale:Ve}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[F(t.start,"HH:mm",{locale:Ve})," - ",F(t.end,"HH:mm",{locale:Ve})]})]}),e.jsx(jt,{className:"p-0 text-left space-y-1",children:e.jsx(yt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(et,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),h&&e.jsxs("p",{className:"text-sm",children:[h.name," (Client)"]}),M&&e.jsxs("p",{className:"text-sm",children:[M.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:st,label:"Appel"},{icon:vt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:Nt,label:"GPS"}].map(({icon:i,label:c})=>e.jsxs("button",{onClick:()=>k(c),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:c})]},c))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[C].color}`,children:e.jsxs(Rt,{onValueChange:T,value:C,children:[e.jsx(Ft,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx($t,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Mt,{children:[e.jsx(Me,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Me,{value:"effectue",children:"Effectu√©"}),e.jsx(Me,{value:"annule",children:"Annul√©"}),e.jsx(Me,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((y=w[t.projectId])==null?void 0:y.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(h==null?void 0:h.name)||"N/A"})]})]})]}),e.jsxs(Ot,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(ns,{children:[e.jsx(is,{asChild:!0,children:e.jsxs(he,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ls,{children:[e.jsxs(os,{children:[e.jsx(cs,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(ds,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(us,{children:[e.jsx(ms,{children:"Annuler"}),e.jsx(gs,{onClick:f,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(he,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})};function _r(t,s){const a=t.prospect,r=s.prospect;return!a||!r?!1:a.id===r.id&&(a.updatedAt||a.updated_at)===(r.updatedAt||r.updated_at)}const Ir=xt.memo(Nr,_r),ts=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Cr=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",We=t=>(t||"").toString().trim().toUpperCase(),kr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},Ar=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],ss=50,as=50,Vr=()=>{var pe,ee;const t=Be(),[s,a]=hs(),{organizationId:r}=ct(),[u,m]=n.useState(null),[g,x]=n.useState(!1),[w,C]=n.useState("all"),[b,h]=n.useState(null),[M,p]=n.useState(!1),[F,T]=n.useState([]),[f,k]=n.useState(!1),E=n.useRef(null),[y,i]=n.useState(""),c=n.useRef(null),[R,J]=n.useState(!1),[S,$]=n.useState(!1),[le,oe]=n.useState({}),{users:me,loading:G}=dt(),{authUserId:fe}=at(),{getTemplateByType:U}=rs({organizationId:r}),A=t==null?void 0:t.addProspect,{prospects:V=[],prospectsLoading:ue=!0,allProjectSteps:B={},allStepsLoading:d=!0,updateProspect:z=async()=>{},projectsData:Z={},activeAdminUser:Y=null,users:v={},globalPipelineSteps:I=[],pipelineLoading:te=!0,getProjectSteps:q=()=>[],adminReady:re=!1}=t||{},H=n.useMemo(()=>me.reduce((o,P)=>(o[P.user_id]={id:P.id,user_id:P.user_id,name:P.name,email:P.email,role:P.role,phone:P.phone,avatarUrl:P.avatar_url,managerId:P.manager_id,accessRights:P.access_rights},o),{}),[me]);n.useEffect(()=>{re&&!ue&&!d&&!S&&$(!0)},[re,ue,d,S]);const W=V,de=z,ce=(V==null?void 0:V.find(o=>o.id===u))||null,ye=n.useMemo(()=>!I||I.length===0?Ar:I.map((o,P)=>{const K=We(o.label),ne=o.color||kr[K]||ts[P%ts.length];return{id:o.id,label:o.label,name:Cr(o.label),color:ne}}),[I]),j=n.useMemo(()=>{if(!Y)return[];if(Y.role==="Global Admin"||Y.role==="Admin")return Object.values(H);const o=Y.access_rights||Y.accessRights,P=[Y.user_id,...(o==null?void 0:o.users)||[]];return Object.values(H).filter(K=>P.includes(K.user_id))},[Y,H]),ie=n.useMemo(()=>{const o=j.map(P=>({value:P.user_id,label:P.name}));return j.length>1?[{value:"all",label:"Tous les utilisateurs"},...o]:o},[j]);n.useEffect(()=>{Y&&b===null&&(j.length>1?h("all"):j.length===1&&h(j[0].user_id))},[Y,b,j]),n.useEffect(()=>{if(!f)return;const o=P=>{E.current&&!E.current.contains(P.target)&&k(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[f]);const ge=n.useMemo(()=>{const o=new Set;return W.forEach(P=>{(P.tags||[]).forEach(K=>o.add(K))}),Array.from(o)},[W]),ve=F.length===0?"Tags":F.length===1?((pe=Z[F[0]])==null?void 0:pe.title)||F[0]:`${F.length} tags`,be=n.useMemo(()=>{const o=W.filter(K=>{if(!Y)return!1;if(Y.role==="Global Admin"||Y.role==="Admin")return!0;const ne=Y.access_rights||Y.accessRights;return[Y.user_id,...(ne==null?void 0:ne.users)||[]].includes(K.ownerId)});N.debug("[FinalPipeline] Prospects count",{total:W.length,visible:o.length});let P=o;if(F.length>0&&(P=P.filter(K=>{const ne=K.tags||[];return F.some(l=>ne.includes(l))})),b&&b!=="all"&&(P=P.filter(K=>K.ownerId===b)),y.trim()){const K=y.toLowerCase();P=P.filter(ne=>(ne.name||"").toLowerCase().includes(K)||(ne.email||"").toLowerCase().includes(K)||(ne.city||"").toLowerCase().includes(K)||(ne.phone||"").toLowerCase().includes(K))}return w==="mine"&&fe?P.filter(K=>K.ownerId===fe):P},[W,w,fe,b,F,y]),{stagesWithCounts:Ie,prospectsByStage:Ne}=n.useMemo(()=>{var se;const o=ye.reduce((O,L)=>(O[L.id]=[],O),{}),P=((se=ye[0])==null?void 0:se.id)||"fallback-stage",K=new Set(ye.map(O=>O.id)),ne=new Map(ye.map(O=>[We(O.label),O.id])),l=O=>{const L=[];return O.projectType&&Z[O.projectType]&&L.push(O.projectType),Array.isArray(O.tags)&&O.tags.forEach(Q=>{Z[Q]&&!L.includes(Q)&&L.push(Q)}),L},_=O=>{const L=[];if(!I.length){const ae=O.stage||P,we=K.has(ae)?ae:P;return L.push({stageId:we,prospect:O}),L}if(typeof q!="function")return L.push({stageId:P,prospect:O}),L;const Q=l(O);return Q.length?(Q.forEach(ae=>{var Vt;const we=`${O.id}-${ae}`,Ce=B[we]||(typeof q=="function"?q(O.id,ae):[])||[],$e=((Vt=Z[ae])==null?void 0:Vt.steps)||[];if(!Ce.length){L.push({stageId:P,prospect:O,projectType:ae});return}const Ee=Ce.find(Ge=>Ge.status==="in_progress"||Ge.status==="current")||Ce.find(Ge=>Ge.status==="pending")||Ce[Ce.length-1];if(!Ee){L.push({stageId:P,prospect:O,projectType:ae});return}const mt=(()=>{if(Ee.globalStepId&&K.has(Ee.globalStepId))return Ee.globalStepId;if(Ee.globalStepId){const Xe=We(Ee.globalStepId),Te=ne.get(Xe);if(Te&&K.has(Te))return Te}const Ge=Ce.indexOf(Ee);let ke=null;if(Ge>=0&&$e[Ge]&&(ke=$e[Ge]),!ke){const Xe=We(Ee.name||Ee.label);ke=$e.find(Te=>We(Te.name||Te.label)===Xe)}if(ke!=null&&ke.globalStepId&&K.has(ke.globalStepId))return ke.globalStepId;if(ke!=null&&ke.globalStepId){const Xe=We(ke.globalStepId),Te=ne.get(Xe);if(Te&&K.has(Te))return Te}if(ke&&(ke.label||ke.name)){const Xe=We(ke.label||ke.name),Te=ne.get(Xe);if(Te&&K.has(Te))return Te}const As=We(Ee.label||Ee.name),St=ne.get(As);return St&&K.has(St)?St:P})();L.push({stageId:mt,prospect:O,projectType:ae,activeStep:Ee})}),L):(L.push({stageId:P,prospect:O}),L)};return be.forEach(O=>{_(O).forEach(({stageId:Q,projectType:ae,activeStep:we})=>{o[Q]||(o[Q]=[]),o[Q].push({prospect:O,projectType:ae,activeStep:we})})}),{stagesWithCounts:ye.map(O=>{var L;return{...O,count:((L=o[O.id])==null?void 0:L.length)||0}}),prospectsByStage:o}},[ye,be,I,q,Z]);n.useEffect(()=>{const o=s.get("prospect"),P=s.get("project"),K=`${o}-${P}`;if(c.current===K)return;if(!o){u!==null&&(m(null),c.current=null);return}(W.find(l=>l.id===o)||null)&&(m(o),c.current=K)},[s,W]);const De=o=>{T(P=>P.includes(o)?P.filter(K=>K!==o):[...P,o])},_e=n.useCallback((o,P)=>{m(o.id),a(K=>{const ne=new URLSearchParams(K);return ne.set("prospect",o.id),P?ne.set("project",P):ne.delete("project"),ne})},[a]),Pe=n.useCallback(o=>{oe(P=>({...P,[o]:(P[o]||ss)+as}))},[]),Re=()=>{m(null);const o=new URLSearchParams(s);o.delete("prospect"),o.delete("project"),a(o)},Se=async o=>{var P,K,ne;try{if(!A)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const l=((P=I[0])==null?void 0:P.step_id)||((K=I[0])==null?void 0:K.id);console.log("[handleAddProspect] calling addProspect",{name:o.name,email:o.email,status:l,ownerId:Y==null?void 0:Y.user_id,sendInvitation:o.sendInvitation,allData:o});const _=await A({...o,status:l,ownerId:Y==null?void 0:Y.user_id});if(console.log("[handleAddProspect] result",_),!(_!=null&&_.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(_&&o.tags&&o.tags.length>0)for(const D of o.tags){const se=await U(D),O=(se==null?void 0:se.steps)||((ne=Z[D])==null?void 0:ne.steps);if(O&&O.length>0)try{const L=JSON.parse(JSON.stringify(O));if(L[0].status="in_progress",!r)throw new Error("Organization ID manquant - Impossible de cr√©er les steps projet");const{error:Q}=await xe.from("project_steps_status").upsert({prospect_id:_.id,project_type:D,steps:L,organization_id:r,updated_at:new Date().toISOString()},{onConflict:"prospect_id,project_type"});Q?N.error("Erreur initialisation steps",{projectType:D,error:Q}):N.debug("Steps initialized for project",{projectType:D,prospectId:_.id})}catch(L){N.error("Erreur initialisation steps",{projectType:D,error:L})}}if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:o.sendInvitation,email:_.email,willSend:o.sendInvitation&&_.email}),o.sendInvitation&&_.email)try{const D=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",_.email.trim(),"redirect:",D,"org:",r);const{error:se}=await xe.auth.signInWithOtp({email:_.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:D,data:{organization_id:r}}});se?(console.error("[handleAddProspect] ‚ùå invitation error",se),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${se.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",_.email),X({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${_.email}`,className:"bg-green-500 text-white"}))}catch(D){console.error("[handleAddProspect] üí• invitation exception",D),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${D.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:o.sendInvitation?"no email":"sendInvitation=false"});x(!1)}catch(l){console.error("‚ùå handleAddProspect error",l),X({title:"Erreur",description:l.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},je=o=>{try{de&&(de(o),X({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{X({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return ce&&ce.id?e.jsx(Ye.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Xs,{name:"Fiche Prospect",children:e.jsx(Ir,{prospect:ce,onBack:Re,onUpdate:je,onEditingChange:J})})}):S?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(et,{className:"w-4 h-4"}),e.jsxs("span",{children:[be.length," prospect",be.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:E,className:"relative inline-block text-left",children:[e.jsxs(he,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>k(o=>!o),children:[e.jsx("span",{children:ve}),e.jsx(It,{className:"h-4 w-4"})]}),f&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[ge.map(o=>{var P;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:F.includes(o),onChange:()=>De(o),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((P=Z[o])==null?void 0:P.title)||o})]},o)}),F.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>T([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(Ys,{open:M,onOpenChange:p,children:[e.jsx(Ks,{asChild:!0,children:e.jsxs(he,{variant:"outline",role:"combobox","aria-expanded":M,className:"w-[230px] justify-between",children:[e.jsx(et,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:b==="all"?"Tous les utilisateurs":((ee=H[b])==null?void 0:ee.name)||"Utilisateur"}),e.jsx(It,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(Qs,{className:"w-[200px] p-0",children:e.jsxs(Zs,{children:[e.jsx(Us,{placeholder:"Rechercher..."}),e.jsxs(ea,{children:[e.jsx(ta,{children:"Aucun utilisateur"}),e.jsx(sa,{children:ie.map(o=>e.jsxs(aa,{value:o.label,onSelect:()=>{h(o.value),p(!1)},children:[e.jsx(ut,{className:Ze("mr-2 h-4 w-4",b===o.value?"opacity-100":"opacity-0")}),o.label]},o.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ra,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(He,{type:"text",placeholder:"Rechercher un prospect...",value:y,onChange:o=>i(o.target.value),className:"pl-9 pr-4"}),y&&e.jsx("button",{onClick:()=>i(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(he,{onClick:()=>x(!0),children:[e.jsx(Tt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Ie.map(o=>e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${o.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:o.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(Ne[o.id]||[]).filter(P=>{if(F.length===0)return!0;const{projectType:K}=P;return F.some(ne=>ne.toUpperCase()===(K||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const P=(Ne[o.id]||[]).filter(D=>{if(F.length===0)return!0;const{projectType:se}=D;return F.some(O=>O.toUpperCase()===(se||"").toUpperCase())}),K=le[o.id]||ss,ne=P.slice(0,K),l=P.length>K,_=P.length-K;return e.jsxs(e.Fragment,{children:[ne.map((D,se)=>{var mt;const{prospect:O,projectType:L,activeStep:Q}=D,ae=`${O.id}-${L||"default"}-${o.id}-${se}`,we=O.projectType||O.tags&&O.tags[0]||"Projet",Ce=L&&((mt=Z[L])!=null&&mt.title)?Z[L].title:we,$e=(Q==null?void 0:Q.label)||(Q==null?void 0:Q.name)||o.name,Ee=o.color||"bg-blue-100 text-blue-700",Qe=`${O.id}-${L||Ce}-${o.id}-${se}`;return e.jsx(Ye.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(er,{prospect:{...O,_projectContext:{projectType:L||we,projectTitle:Ce,stepLabel:$e,projectColor:Ee}},onClick:()=>_e(O,L||O.projectType||(Array.isArray(O.tags)?O.tags[0]:we)),compact:!0,sortableId:Qe,projectsData:Z})},ae)}),l&&e.jsxs("button",{onClick:()=>Pe(o.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(_,as)," de plus (",_," restants)"]}),P.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(et,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},o.id))})})}),e.jsx(na,{open:g,onOpenChange:x,onAddProspect:Se}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(o=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},o))})})})]})};export{Vr as default};
