import{c as Tt,r as i,R as pt,u as Ts,j as e,m as Ke,C as ot,l as I,s as pe,a as ut,b as He,d as Rs,e as st,f as $s,g as kt,h as mt,B as xe,P as Rt,i as Be,D as bt,k as jt,X as Ye,n as yt,o as Nt,U as tt,p as at,M as vt,q as $t,t as wt,S as Ft,v as Mt,w as Ot,x as Lt,y as Fe,z as zt,A as is,E as ls,T as qt,F as os,G as cs,H as ds,I as us,J as ms,K as gs,L as xs,N as X,O as Oe,Q as Fs,V as ps,W as Ms,Y as hs,Z as Wt,_ as Os,$ as Ls,a0 as Ue,a1 as zs,a2 as qs,a3 as Vs,a4 as ct,a5 as Bs,a6 as fs,a7 as bs,a8 as Hs,a9 as Ws,aa as Me,ab as Je,ac as gt,ad as js,ae as ys,af as Gs,ag as Js,ah as Xs,ai as Ys,aj as Ks,ak as Qs,al as Zs,am as Us,an as ea,ao as ta,ap as sa,aq as aa,ar as ra,as as na,at as ia,au as la,av as oa,aw as ca,ax as da}from"./index-cd4748d9.js";import{u as rt,A as Ns,C as ua}from"./Agenda-db4e36f2.js";import{S as ma}from"./SearchableSelect-a9388500.js";import{u as ga}from"./useSupabaseProjectStepsStatus-4a4979da.js";import{u as vs}from"./useSupabaseProjectFiles-022385d7.js";import{F as xa,a as pa,P as ha,b as fa,e as ba,u as ws,S as Vt,c as ja}from"./useSupabaseWorkflowModuleTemplates-bc314ff4.js";import{f as Qe,V as ya}from"./index-cf1a271f.js";import{D as ht}from"./download-5f75c0fe.js";import{i as Na}from"./workflowV2Config-b482875b.js";import{P as ft}from"./pen-square-006e98f3.js";import{P as Gt}from"./paperclip-d2705635.js";import"./external-link-9624a154.js";const va=Tt("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),wa=Tt("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),_a=Tt("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function Sa(){for(var t=arguments.length,s=new Array(t),r=0;r<t;r++)s[r]=arguments[r];return i.useMemo(()=>a=>{s.forEach(g=>g(a))},s)}const Ia=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function Ca(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function ka(t){return"nodeType"in t}function _s(t){var s,r;return t?Ca(t)?t:ka(t)&&(s=(r=t.ownerDocument)==null?void 0:r.defaultView)!=null?s:window:window}const _t=Ia?i.useLayoutEffect:i.useEffect;function Ss(t){const s=i.useRef(t);return _t(()=>{s.current=t}),i.useCallback(function(){for(var r=arguments.length,a=new Array(r),g=0;g<r;g++)a[g]=arguments[g];return s.current==null?void 0:s.current(...a)},[])}function Et(t,s){s===void 0&&(s=[t]);const r=i.useRef(t);return _t(()=>{r.current!==t&&(r.current=t)},s),r}function At(t){const s=Ss(t),r=i.useRef(null),a=i.useCallback(g=>{g!==r.current&&(s==null||s(g,r.current)),r.current=g},[]);return[r,a]}let Ct={};function Is(t,s){return i.useMemo(()=>{if(s)return s;const r=Ct[t]==null?0:Ct[t]+1;return Ct[t]=r,t+"-"+r},[t,s])}function Ea(t){if(!t)return!1;const{KeyboardEvent:s}=_s(t.target);return s&&t instanceof s}const dt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:r}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(r?Math.round(r):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:r}=t;return"scaleX("+s+") scaleY("+r+")"}},Transform:{toString(t){if(t)return[dt.Translate.toString(t),dt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:r,easing:a}=t;return s+" "+r+"ms "+a}}});var lt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(lt||(lt={}));function Jt(){}const Aa=Object.freeze({x:0,y:0});function Pa(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Da(t,s,r){const a=Pa(s);if(!a)return t;const{scaleX:g,scaleY:m,x:h,y:f}=a,C=t.left-h-(1-g)*parseFloat(r),P=t.top-f-(1-m)*parseFloat(r.slice(r.indexOf(" ")+1)),N=g?t.width/g:t.width,b=m?t.height/m:t.height;return{width:N,height:b,top:P,right:C+N,bottom:P+b,left:C}}const Ta={ignoreTransform:!1};function Bt(t,s){s===void 0&&(s=Ta);let r=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:P,transformOrigin:N}=_s(t).getComputedStyle(t);P&&(r=Da(r,P,N))}const{top:a,left:g,width:m,height:h,bottom:f,right:C}=r;return{top:a,left:g,width:m,height:h,bottom:f,right:C}}function Xt(t){return Bt(t,{ignoreTransform:!0})}var et;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(et||(et={}));var Yt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Yt||(Yt={}));var $e;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})($e||($e={}));$e.Space,$e.Enter,$e.Esc,$e.Space,$e.Enter,$e.Tab;var Kt;(function(t){t[t.RightClick=2]="RightClick"})(Kt||(Kt={}));var Qt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Qt||(Qt={}));var Zt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Zt||(Zt={}));et.Backward+"",et.Forward+"",et.Backward+"",et.Forward+"";var Pt;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(Pt||(Pt={}));var Dt;(function(t){t.Optimized="optimized"})(Dt||(Dt={}));function Ra(t){let{callback:s,disabled:r}=t;const a=Ss(s),g=i.useMemo(()=>{if(r||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:m}=window;return new m(a)},[r]);return i.useEffect(()=>()=>g==null?void 0:g.disconnect(),[g]),g}function $a(t,s){return i.useMemo(()=>t.reduce((r,a)=>{let{eventName:g,handler:m}=a;return r[g]=h=>{m(h,s)},r},{}),[t,s])}Pt.WhileDragging,Dt.Optimized;const Fa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Jt,draggableNodes:new Map,over:null,measureDroppableContainers:Jt},Cs=i.createContext(Fa),Ma=i.createContext({...Aa,scaleX:1,scaleY:1});var Ut;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Ut||(Ut={}));const Oa=i.createContext(null),es="button",La="Draggable";function za(t){let{id:s,data:r,disabled:a=!1,attributes:g}=t;const m=Is(La),{activators:h,activatorEvent:f,active:C,activeNodeRect:P,ariaDescribedById:N,draggableNodes:b,over:z}=i.useContext(Cs),{role:p=es,roleDescription:O="draggable",tabIndex:T=0}=g??{},_=(C==null?void 0:C.id)===s,L=i.useContext(_?Ma:Oa),[D,S]=At(),[o,u]=At(),R=$a(h,s),B=Et(r);_t(()=>(b.set(s,{id:s,key:m,node:D,activatorNode:o,data:B}),()=>{const $=b.get(s);$&&$.key===m&&b.delete(s)}),[b,s]);const k=i.useMemo(()=>({role:p,tabIndex:T,"aria-disabled":a,"aria-pressed":_&&p===es?!0:void 0,"aria-roledescription":O,"aria-describedby":N.draggable}),[a,p,T,_,O,N.draggable]);return{active:C,activatorEvent:f,activeNodeRect:P,attributes:k,isDragging:_,listeners:a?void 0:R,node:D,over:z,setNodeRef:S,setActivatorNodeRef:u,transform:L}}const qa="Droppable",Va={timeout:25};function Ba(t){let{data:s,disabled:r=!1,id:a,resizeObserverConfig:g}=t;const m=Is(qa),{active:h,dispatch:f,over:C,measureDroppableContainers:P}=i.useContext(Cs),N=i.useRef({disabled:r}),b=i.useRef(!1),z=i.useRef(null),p=i.useRef(null),{disabled:O,updateMeasurementsFor:T,timeout:_}={...Va,...g},L=Et(T??a),D=i.useCallback(()=>{if(!b.current){b.current=!0;return}p.current!=null&&clearTimeout(p.current),p.current=setTimeout(()=>{P(Array.isArray(L.current)?L.current:[L.current]),p.current=null},_)},[_]),S=Ra({callback:D,disabled:O||!h}),o=i.useCallback((k,$)=>{S&&($&&(S.unobserve($),b.current=!1),k&&S.observe(k))},[S]),[u,R]=At(o),B=Et(s);return i.useEffect(()=>{!S||!u.current||(S.disconnect(),b.current=!1,S.observe(u.current))},[u,S]),i.useEffect(()=>(f({type:lt.RegisterDroppable,element:{id:a,key:m,disabled:r,node:u,rect:z,data:B}}),()=>f({type:lt.UnregisterDroppable,key:m,id:a})),[a]),i.useEffect(()=>{r!==N.current.disabled&&(f({type:lt.SetDroppableDisabled,id:a,key:m,disabled:r}),N.current.disabled=r)},[a,m,r,f]),{active:h,rect:z,isOver:(C==null?void 0:C.id)===a,node:u,over:C,setNodeRef:R}}function ks(t,s,r){const a=t.slice();return a.splice(r<0?a.length+r:r,0,a.splice(s,1)[0]),a}function xt(t){return t!==null&&t>=0}const Ha=t=>{let{rects:s,activeIndex:r,overIndex:a,index:g}=t;const m=ks(s,a,r),h=s[g],f=m[g];return!f||!h?null:{x:f.left-h.left,y:f.top-h.top,scaleX:f.width/h.width,scaleY:f.height/h.height}},Wa="Sortable",Ga=pt.createContext({activeIndex:-1,containerId:Wa,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Ha,disabled:{draggable:!1,droppable:!1}}),Ja=t=>{let{id:s,items:r,activeIndex:a,overIndex:g}=t;return ks(r,a,g).indexOf(s)},Xa=t=>{let{containerId:s,isSorting:r,wasDragging:a,index:g,items:m,newIndex:h,previousItems:f,previousContainerId:C,transition:P}=t;return!P||!a||f!==m&&g===h?!1:r?!0:h!==g&&s===C},Ya={duration:200,easing:"ease"},Es="transform",Ka=dt.Transition.toString({property:Es,duration:0,easing:"linear"}),Qa={roleDescription:"sortable"};function Za(t){let{disabled:s,index:r,node:a,rect:g}=t;const[m,h]=i.useState(null),f=i.useRef(r);return _t(()=>{if(!s&&r!==f.current&&a.current){const C=g.current;if(C){const P=Bt(a.current,{ignoreTransform:!0}),N={x:C.left-P.left,y:C.top-P.top,scaleX:C.width/P.width,scaleY:C.height/P.height};(N.x||N.y)&&h(N)}}r!==f.current&&(f.current=r)},[s,r,a,g]),i.useEffect(()=>{m&&h(null)},[m]),m}function Ua(t){let{animateLayoutChanges:s=Xa,attributes:r,disabled:a,data:g,getNewIndex:m=Ja,id:h,strategy:f,resizeObserverConfig:C,transition:P=Ya}=t;const{items:N,containerId:b,activeIndex:z,disabled:p,disableTransforms:O,sortedRects:T,overIndex:_,useDragOverlay:L,strategy:D}=i.useContext(Ga),S=er(a,p),o=N.indexOf(h),u=i.useMemo(()=>({sortable:{containerId:b,index:o,items:N},...g}),[b,g,o,N]),R=i.useMemo(()=>N.slice(N.indexOf(h)),[N,h]),{rect:B,node:k,isOver:$,setNodeRef:ne}=Ba({id:h,data:u,disabled:S.droppable,resizeObserverConfig:{updateMeasurementsFor:R,...C}}),{active:oe,activatorEvent:he,activeNodeRect:ve,attributes:q,setNodeRef:W,listeners:E,isDragging:Q,over:le,setActivatorNodeRef:de,transform:l}=za({id:h,data:u,attributes:{...Qa,...r},disabled:S.draggable}),M=Sa(ne,W),V=!!oe,ue=V&&!O&&xt(z)&&xt(_),A=!L&&Q,H=A&&ue?l:null,ce=ue?H??(f??D)({rects:T,activeNodeRect:ve,activeIndex:z,overIndex:_,index:o}):null,se=xt(z)&&xt(_)?m({id:h,items:N,activeIndex:z,overIndex:_}):o,w=oe==null?void 0:oe.id,Z=i.useRef({activeId:w,items:N,newIndex:se,containerId:b}),re=N!==Z.current.items,me=s({active:oe,containerId:b,isDragging:Q,isSorting:V,id:h,index:o,items:N,newIndex:Z.current.newIndex,previousItems:Z.current.items,previousContainerId:Z.current.containerId,transition:P,wasDragging:Z.current.activeId!=null}),ie=Za({disabled:!me,index:o,node:k,rect:B});return i.useEffect(()=>{V&&Z.current.newIndex!==se&&(Z.current.newIndex=se),b!==Z.current.containerId&&(Z.current.containerId=b),N!==Z.current.items&&(Z.current.items=N)},[V,se,b,N]),i.useEffect(()=>{if(w===Z.current.activeId)return;if(w&&!Z.current.activeId){Z.current.activeId=w;return}const ye=setTimeout(()=>{Z.current.activeId=w},50);return()=>clearTimeout(ye)},[w]),{active:oe,activeIndex:z,attributes:q,data:u,rect:B,index:o,newIndex:se,items:N,isOver:$,isSorting:V,isDragging:Q,listeners:E,node:k,overIndex:_,over:le,setNodeRef:M,setActivatorNodeRef:de,setDroppableNodeRef:ne,setDraggableNodeRef:W,transform:ie??ce,transition:Se()};function Se(){if(ie||re&&Z.current.newIndex===o)return Ka;if(!(A&&!Ea(he)||!P)&&(V||me))return dt.Transition.toString({...P,property:Es})}}function er(t,s){var r,a;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(r=t==null?void 0:t.draggable)!=null?r:s.draggable,droppable:(a=t==null?void 0:t.droppable)!=null?a:s.droppable}}$e.Down,$e.Right,$e.Up,$e.Left;const tr=t=>(t||"").toString().trim().toUpperCase(),sr=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const r=t.prospect,a=s.prospect;if(r.id!==a.id||r.name!==a.name||r.hasAppointment!==a.hasAppointment||r.updatedAt!==a.updatedAt)return!1;const g=r._projectContext||{},m=a._projectContext||{};if(g.projectType!==m.projectType||g.projectTitle!==m.projectTitle||g.stepLabel!==m.stepLabel)return!1;const h=r.tags||[],f=a.tags||[];return!(h.length!==f.length||h.some((C,P)=>C!==f[P])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},ar=({prospect:t,onClick:s,sortableId:r,projectsData:a={}})=>{var _,L,D,S,o,u,R;Ts();const g=Array.isArray(t.tags)?t.tags:[],m=((_=t._projectContext)==null?void 0:_.projectTitle)||((L=t._projectContext)==null?void 0:L.projectType)||null,h=((D=t._projectContext)==null?void 0:D.projectType)||null;(S=t._projectContext)!=null&&S.stepLabel;const f=m?tr(m):null,C=r||(f?`${t.id}-${f}`:`${t.id}-${((o=t._projectContext)==null?void 0:o.projectType)||"default"}`),{attributes:P,listeners:N,setNodeRef:b,transform:z,transition:p,isDragging:O}=Ua({id:C,data:{prospect:t}}),T={transform:dt.Transform.toString(z),transition:p,zIndex:O?10:"auto",opacity:O?.8:1};return e.jsx("div",{ref:b,style:T,...P,...N,children:e.jsxs(Ke.div,{layoutId:`prospect-card-${C}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(ot,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[m&&g.includes(((u=t._projectContext)==null?void 0:u.projectType)||m)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((R=a[h])==null?void 0:R.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:m})}),g.filter(B=>B!==h).map(B=>{var ne,oe;const k=((ne=a[B])==null?void 0:ne.title)||B,$=((oe=a[B])==null?void 0:oe.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${$}`,children:k},B)})]})]})})},rr=i.memo(ar,sr);function nr({prospectId:t,projectType:s,currentStepIndex:r,prompt:a,sendNextAction:g}){const m=i.useRef(new Set);i.useRef(!1),i.useEffect(()=>{if(!t||!s||r===void 0||!a)return;I.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:r,promptName:a==null?void 0:a.name});const h=pe.channel(`workflow-forms-${t}-${s}-${r}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async f=>{const C=f.new;I.info("üîç Form panel UPDATE re√ßu",{panelId:C.id,prospectId:C.prospect_id,projectType:C.project_type,status:C.status,actionId:C.action_id,expectedProjectType:s});const P=C.project_type===s,N=C.status==="approved",b=!!C.action_id;if(P&&N&&b){const z=`${t}-${s}-${r}-${C.action_id}`;if(m.current.has(z)){I.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:z});return}m.current.add(z),I.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:C.form_id,actionId:C.action_id}),setTimeout(()=>{I.info("üöÄ Envoi action suivante",{completedActionId:C.action_id}),g(C.action_id)},2e3)}}).subscribe();return()=>{pe.removeChannel(h)}},[t,s,r,a,g])}function ir({projectType:t,prospectId:s,enabled:r=!0}){const[a,g]=i.useState([]),[m,h]=i.useState(!1),[f,C]=i.useState(!1),[P,N]=i.useState(null),{organizationId:b}=ut(),z=i.useCallback(async()=>{if(!(!t||!r))try{h(!0),N(null);let _=pe.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(_=_.eq("prospect_id",s));const{data:L,error:D}=await _;if(D)throw D;g(L||[])}catch(_){I.error("Erreur r√©cup√©ration project notes:",{error:_.message}),N(_.message)}finally{h(!1)}},[t,s,r]);i.useEffect(()=>{if(!t||!r)return;z();const _=pe.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},L=>{g(D=>{const{eventType:S,new:o,old:u}=L;return S==="INSERT"?[o,...D]:S==="UPDATE"?D.map(R=>R.id===o.id?o:R):S==="DELETE"?D.filter(R=>R.id!==u.id):D})}).subscribe();return()=>{pe.removeChannel(_)}},[t,r,z]);const p=i.useCallback(async({content:_,createdBy:L,createdByName:D})=>{if(!(!t||!(_!=null&&_.trim())))try{if(C(!0),N(null),!b)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:S,error:o}=await pe.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:_.trim(),created_by:L||null,created_by_name:D||null,organization_id:b}]).select().single();if(o)throw o;return g(u=>[S,...u]),S}catch(S){throw I.error("Erreur ajout project note:",{error:S.message}),N(S.message),S}finally{C(!1)}},[t,s,b]),O=i.useCallback(async(_,{content:L})=>{if(!(!_||!(L!=null&&L.trim())))try{C(!0),N(null);const{data:D,error:S}=await pe.from("project_notes").update({content:L.trim(),updated_at:new Date().toISOString()}).eq("id",_).select().single();if(S)throw S;return g(o=>o.map(u=>u.id===_?D:u)),D}catch(D){throw I.error("Erreur update project note:",{error:D.message}),N(D.message),D}finally{C(!1)}},[]),T=i.useCallback(async _=>{if(_)try{C(!0),N(null);const{error:L}=await pe.from("project_notes").delete().eq("id",_);if(L)throw L;g(D=>D.filter(S=>S.id!==_))}catch(L){throw I.error("Erreur suppression project note:",{error:L.message}),N(L.message),L}finally{C(!1)}},[]);return{notes:a,loading:m,saving:f,error:P,addNote:p,updateNote:O,deleteNote:T,refetch:z}}function lr({projectType:t,prospectId:s,currentUser:r,activeAdminUser:a}){var o;const{activeAdminUser:g}=He(),m=a||g,[h,f]=i.useState(""),[C,P]=i.useState(!1),{getTemplateByType:N}=Rs(),b=N(t),z=(b==null?void 0:b.title)||t,{notes:p,loading:O,saving:T,error:_,addNote:L}=ir({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:D}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:m}),S=async()=>{if(h.trim())try{const u=await L({content:h,createdBy:(m==null?void 0:m.id)||(r==null?void 0:r.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(r==null?void 0:r.full_name)||(r==null?void 0:r.email)});u&&D&&await D({event_type:"note",title:"Note ajout√©e",description:u.content||h.trim(),metadata:{source:"notes_tab"},createdBy:(m==null?void 0:m.id)||(r==null?void 0:r.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(r==null?void 0:r.full_name)||(r==null?void 0:r.email)}),f("")}catch(u){I.error(u)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${z}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:h,onChange:u=>f(u.target.value),disabled:!t||T}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:S,disabled:!h.trim()||!t||T,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:T?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),_&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",_]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),p&&p.length>3&&e.jsx("button",{onClick:()=>P(!C),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:C?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx($s,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",p.length,")"]}),e.jsx(kt,{className:"w-4 h-4"})]})})]}),O&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!O&&(p==null?void 0:p.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(o=C?p:p==null?void 0:p.slice(0,3))==null?void 0:o.map(u=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:u.created_by_name||u.created_by?`Par ${u.created_by_name||u.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:u.created_at&&new Date(u.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:u.content})]},u.id))})]})]})}const or=({prospectId:t,projectType:s,activeAdminUser:r})=>{const{projectsData:a,appointments:g,updateAppointment:m,deleteAppointment:h,addAppointment:f,addCall:C,addTask:P,updateCall:N,updateTask:b,prospects:z}=He(),[p,O]=i.useState(!1),[T,_]=i.useState(null),[L,D]=i.useState(null),{users:S}=mt(),{supabaseUserId:o}=rt(),{history:u,loading:R}=st({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),B=i.useMemo(()=>!u||u.length===0?[]:u.filter(E=>E.event_type==="activity").sort((E,Q)=>new Date(Q.created_at)-new Date(E.created_at)),[u]),k=i.useMemo(()=>{const E={};return B.forEach(le=>{var l;const de=(l=le.metadata)==null?void 0:l.appointment_id;de&&(E[de]||(E[de]=[]),E[de].push(le))}),Object.entries(E).map(([le,de])=>{var V;const M=de.sort((ue,A)=>new Date(A.created_at)-new Date(ue.created_at))[0];return{...M,currentStatus:((V=M.metadata)==null?void 0:V.status)||(M.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[B]),$=i.useMemo(()=>k?k.filter(E=>E.currentStatus==="pending"):[],[k]),ne=i.useMemo(()=>k?k.filter(E=>E.currentStatus!=="pending"):[],[k]),oe=E=>{switch((E==null?void 0:E.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(ot,{className:"h-4 w-4"});case"virtual":return e.jsx(ya,{className:"h-4 w-4"});case"call":return e.jsx(at,{className:"h-4 w-4"});case"task":return e.jsx(ua,{className:"h-4 w-4"});default:return e.jsx(ot,{className:"h-4 w-4"})}},he=E=>{const Q=(E==null?void 0:E.activity_type)||"appointment",le=E==null?void 0:E.status;if(le==="effectue"||le==="completed")return"text-green-600 bg-green-50";if(le==="annule")return"text-red-600 bg-red-50";if(le==="reporte")return"text-yellow-600 bg-yellow-50";switch(Q){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},ve=E=>{var Q;return!g||!((Q=E.metadata)!=null&&Q.appointment_id)?null:g.find(le=>le.id===E.metadata.appointment_id)},q=E=>{const Q=ve(E);Q&&_(Q)},W=E=>{_(null),D({...E,type:E.type}),O(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(xe,{onClick:()=>{O(!p)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),p&&e.jsx(Ns,{open:p,onOpenChange:E=>{E||D(null),O(E)},initialData:L||{contactId:t,projectId:s},defaultAssignedUserId:o,addAppointment:f,addCall:C,addTask:P,updateAppointment:m,updateCall:N,updateTask:b,prospects:z||[],users:S||[],projectsData:a||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",$.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):$.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:$.map(E=>{const Q=ve(E),le=(Q==null?void 0:Q.title)||E.title||"Activit√©",de=Q!=null&&Q.start?new Date(Q.start):new Date(E.created_at);return e.jsxs("div",{onClick:()=>q(E),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${he(E.metadata)}`,children:oe(E.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:le}),(Q==null?void 0:Q.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:Q.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Qe(de,"d MMM '√†' HH:mm",{locale:Be})})]})]},E.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",ne.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ne.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:ne.map(E=>{const Q=ve(E),le=(Q==null?void 0:Q.title)||E.title||"Activit√©",de=Q!=null&&Q.start?new Date(Q.start):new Date(E.created_at),l={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[E.currentStatus]||E.currentStatus;return e.jsxs("div",{onClick:()=>q(E),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${he(E.metadata)}`,children:oe(E.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:le}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[l," ‚Ä¢ ",Qe(de,"d MMM yyyy '√†' HH:mm",{locale:Be})]})]})]},E.id)})})]}),T&&e.jsx(cr,{event:T,onClose:()=>_(null),onReport:()=>{},onEdit:W,prospects:z,supabaseUsers:S,updateAppointment:m,deleteAppointment:h,projectsData:a})]})},cr=({event:t,onClose:s,onReport:r,onEdit:a,prospects:g,supabaseUsers:m,updateAppointment:h,deleteAppointment:f,projectsData:C})=>{var S;const[P,N]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&N(t.status||"pending")},[t]),!t||!g||!m||!h||!f||!C)return null;const b=g.find(o=>o.id===t.contactId),z=m.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(b?m.find(o=>o.user_id===b.ownerId):null),p=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",O=(o,u,R={})=>{try{const B=new Date(o);return isNaN(B.getTime())?"Date invalide":Qe(B,u,R)}catch{return"Date invalide"}},T=o=>{N(o),h(t.id,{status:o}),setTimeout(()=>{s(),o==="reporte"&&r(t)},300)},_=()=>{f(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},L=o=>{if(!b){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(o){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:X({title:`Action: ${o}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},D={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:o=>!o&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ye,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p(O(t.start,"eeee d MMMM",{locale:Be}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[O(t.start,"HH:mm",{locale:Be})," - ",O(t.end,"HH:mm",{locale:Be})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),z&&e.jsxs("p",{className:"text-sm",children:[z.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:$t,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:o,label:u})=>e.jsxs("button",{onClick:()=>L(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${D[P].color}`,children:e.jsxs(Ft,{onValueChange:T,value:P,children:[e.jsx(Mt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ot,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx(Fe,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Fe,{value:"effectue",children:"Effectu√©"}),e.jsx(Fe,{value:"annule",children:"Annul√©"}),e.jsx(Fe,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((S=C[t.projectId])==null?void 0:S.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(zt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(is,{children:[e.jsx(ls,{asChild:!0,children:e.jsxs(xe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(qt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(os,{children:[e.jsxs(cs,{children:[e.jsx(ds,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(us,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ms,{children:[e.jsx(gs,{children:"Annuler"}),e.jsx(xs,{onClick:_,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(xe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>a(t),children:"Modifier l'activit√©"})]})]})})},dr=({projectType:t,prospectId:s,currentUser:r,activeAdminUser:a})=>{const{activeAdminUser:g}=He(),{organizationId:m}=ut(),h=a||g,[f,C]=i.useState(null),{files:P,loading:N,uploading:b,deleting:z,error:p,uploadFile:O,deleteFile:T}=vs({projectType:t,prospectId:s,organizationId:m,enabled:!!t}),{addHistoryEvent:_}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:h}),L=async k=>{const $=Array.from(k.target.files||[]);if($.length!==0)try{const ne=$.map(async oe=>{C(oe);const he=await O({file:oe,uploadedBy:r==null?void 0:r.id});return he&&_&&await _({event_type:"file",title:"Fichier ajout√©",description:he.file_name,metadata:{size:he.file_size,type:he.file_type,storage_path:he.storage_path},createdBy:(h==null?void 0:h.id)||(r==null?void 0:r.id),createdByName:(h==null?void 0:h.name)||(h==null?void 0:h.email)||(r==null?void 0:r.full_name)||(r==null?void 0:r.email)}),he});await Promise.all(ne),C(null),k.target.value=""}catch(ne){I.error("Error uploading files:",ne),C(null)}},D=async k=>{try{const{data:$,error:ne}=await pe.storage.from("project-files").createSignedUrl(k.storage_path,3600);if(ne){I.error("Error creating signed URL:",ne);return}const he=await(await fetch($.signedUrl)).blob(),ve=window.URL.createObjectURL(he),q=document.createElement("a");q.href=ve,q.download=k.file_name,document.body.appendChild(q),q.click(),document.body.removeChild(q),window.URL.revokeObjectURL(ve)}catch($){I.error("Error downloading file:",$)}},S=async k=>{try{I.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:k.storage_path});const{data:$,error:ne}=await pe.storage.from("project-files").createSignedUrl(k.storage_path,3600);if(ne){I.error("Error creating signed URL:",ne);return}I.debug("‚úÖ Signed URL generated",{url:$.signedUrl}),window.open($.signedUrl,"_blank")}catch($){I.error("Error viewing file:",$)}},o=async k=>{if(confirm(`Supprimer le fichier "${k.file_name}" ?`))try{await T(k.id,k.storage_path)}catch($){I.error("Error deleting file:",$)}},u=k=>k!=null&&k.startsWith("image/")?e.jsx(Ms,{className:"h-5 w-5 text-blue-500"}):k==="application/pdf"?e.jsx(Oe,{className:"h-5 w-5 text-red-500"}):e.jsx(xa,{className:"h-5 w-5 text-gray-500"}),R=k=>k?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(k)):"",B=k=>k?k<1024?`${k} o`:k<1024*1024?`${(k/1024).toFixed(1)} Ko`:`${(k/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Fs,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:b?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:L,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:b,multiple:!0})]})}),p&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:p}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",P.length,")"]}),N?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):P.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:P.map(k=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:u(k.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[k.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:k.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:k.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:k.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[B(k.file_size)," ‚Ä¢ ",R(k.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[k.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>S(k),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:z,children:e.jsx(ps,{className:"h-4 w-4"})}),k.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>D(k),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:z,children:e.jsx(ht,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>o(k),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:z,children:e.jsx(qt,{className:"h-4 w-4"})})]})]},k.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},ur=({prospectId:t,projectType:s,activeAdminUser:r})=>{const[a,g]=i.useState("notes"),{supabaseUserId:m}=rt(),h=[{id:"notes",label:"Notes",icon:Oe},{id:"activity",label:"Activit√©",icon:va},{id:"files",label:"Fichiers",icon:pa}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:h.map(({id:f,label:C,icon:P})=>e.jsxs("button",{onClick:()=>g(f),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${a===f?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx("span",{children:C})]},f))})}),e.jsxs("div",{className:"min-h-[200px]",children:[a==="notes"&&e.jsx(lr,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:r}),a==="activity"&&e.jsx(or,{prospectId:t,projectType:s,activeAdminUser:r}),a==="files"&&e.jsx(dr,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:r})]})]})},mr=({projectType:t,prospectId:s,activeAdminUser:r})=>{const{history:a,loading:g,error:m}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:r});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),g&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),m&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",m]}),!g&&a.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:a.map(h=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.title||h.event_type}),h.description&&e.jsx("p",{className:"text-xs text-gray-600",children:h.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(h.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(h.created_by_name||h.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",h.created_by_name||h.created_by]})]})]})]})]},h.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},gr=({children:t,prospectId:s,projectType:r,currentStep:a,statusConfig:g,activeAdminUser:m})=>{var h,f,C;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[a&&e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((h=g[a.status])==null?void 0:h.iconOnly)||g.pending.iconOnly}`,children:a.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:a.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((f=g[a.status])==null?void 0:f.badge)||g.pending.badge}`,children:((C=g[a.status])==null?void 0:C.label)||g.pending.label})]}),t]},a.name),!a&&!r&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Oe,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),r&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ur,{prospectId:s,projectType:r,activeAdminUser:m}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(mr,{prospectId:s,projectType:r,activeAdminUser:m})]})]})},xr={CLIENT:ct,COMMERCIAL:Bs,PARTENAIRE:tt},pr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},hr={FORM:Oe,SIGNATURE:ha},fr={FORM:"Formulaire",SIGNATURE:"Signature"},br=({isOpen:t,onClose:s,prospectId:r,projectType:a,moduleId:g,moduleName:m,moduleConfig:h,context:f={},availableForms:C=[],availableTemplates:P=[]})=>{var V,ue;const[N,b]=i.useState(null),[z,p]=i.useState(!1),[O,T]=i.useState(null),[_,L]=i.useState(!1),D=Na(),S=i.useMemo(()=>h?h.actions&&h.actions.length>0?h.actions:h.actionConfig?[{order:1,status:"pending",actionConfig:h.actionConfig}]:[]:[],[h]),[o,u]=i.useState({}),[R,B]=i.useState(!1);i.useEffect(()=>{if(!t||!r||!g||S.length<=1){u({});return}(async()=>{B(!0);try{const H=S.map((w,Z)=>`v2-${g}-action-${Z}`),{data:y,error:ce}=await pe.from("client_form_panels").select("id, action_id, status").eq("prospect_id",r).eq("project_type",a).in("action_id",H),se={};if(!ce&&y&&y.length>0){for(const w of y)w.action_id&&(w.status==="approved"||w.status==="submitted")&&(se[w.action_id]=w.status);console.log("[V2 Robot] Action statuses by action_id:",se)}else{const{data:w}=await pe.from("client_form_panels").select("id, step_name, status").eq("prospect_id",r).eq("project_type",a).in("status",["approved","submitted"]);if(w){const Z=w.filter(re=>!re.step_name||re.step_name===m||re.step_name===g);Z.forEach((re,me)=>{me<S.length&&(se[`v2-${g}-action-${me}`]=re.status)}),console.log("[V2 Robot] Fallback legacy statuses:",se,"from",Z.length,"panels")}}u(se)}catch(H){console.error("[V2 Robot] Error fetching action statuses:",H)}finally{B(!1)}})()},[t,r,a,m,g,S.length]);const k=i.useMemo(()=>S.map((A,H)=>{const y=`v2-${g}-action-${H}`,ce=o[y];return{...A,actionId:y,realStatus:ce==="approved"?"validated":ce==="submitted"?"submitted":"pending"}}),[S,o,g]),[$,ne]=i.useState(0);i.useEffect(()=>{if(t&&k.length>0&&!R){const A=k.findIndex(H=>H.realStatus!=="validated");ne(A>=0?A:k.length-1)}},[t,k,R]);const oe=k[$]||null,he=k.length,ve=he>1,q=i.useMemo(()=>{if(!oe)return!1;const A=oe.actionConfig;return!(!A||!A.actionType||!(Array.isArray(A.targetAudience)?A.targetAudience.length>0:!!A.targetAudience))},[oe]),W=(oe==null?void 0:oe.actionConfig)||null,E=()=>{if(!q||!W){X({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:$,actionConfigFormIds:W.allowedFormIds,currentActionFull:oe,allActions:k.map((A,H)=>{var y;return{index:H,formIds:(y=A.actionConfig)==null?void 0:y.allowedFormIds}})});try{const A=Array.isArray(W.targetAudience)?W.targetAudience[0]:W.targetAudience,H=fa({moduleId:g,moduleName:m,projectType:a,prospectId:r,actionIndex:$,actionConfig:{...W,targetAudience:A||"CLIENT"},message:""});b(H),T(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",H)}catch(A){console.error("[V2 Robot] Erreur g√©n√©ration:",A),X({title:"Erreur",description:A.message,variant:"destructive"})}},Q=async()=>{if(!N){X({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!D){X({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}p(!0),T(null);try{const A={...N,_meta:{...N._meta,isSimulation:!1}},H=await ba(A,f);T(H),H.success?(X({title:"‚úÖ Action ex√©cut√©e",description:H.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):X({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:H.message,variant:"destructive"})}catch(A){console.error("[V2 Robot] Erreur ex√©cution:",A),T({success:!1,status:"error",message:A.message}),X({title:"Erreur",description:A.message,variant:"destructive"})}finally{p(!1)}},le=()=>{N&&(navigator.clipboard.writeText(JSON.stringify(N,null,2)),X({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},de=pt.useRef($);i.useEffect(()=>{const A=de.current!==$;if(de.current=$,A&&(b(null),T(null)),t&&q&&!R&&(!N||A)){const H=setTimeout(()=>{E()},A?50:0);return()=>clearTimeout(H)}},[t,q,R,$]),i.useEffect(()=>{t||(b(null),T(null),L(!1),ne(0))},[t]);const l=A=>{const H=C.find(y=>y.id===A);return(H==null?void 0:H.name)||A},M=A=>{const H=P.find(y=>y.id===A);return(H==null?void 0:H.name)||A};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(hs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m||g,ve&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",$+1,"/",he]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ye,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[ve&&q&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",$+1," sur ",he]}),$>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",$," termin√©e",$>1?"s":"",")"]})]}),!q&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Wt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(xe,{variant:"outline",size:"sm",onClick:()=>{X({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Os,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),q&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:ve?`Action ${$+1}/${he}`:"Action configur√©e"}),D&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(W==null?void 0:W.actionType)&&e.jsxs(e.Fragment,{children:[pt.createElement(hr[W.actionType]||Oe,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:fr[W.actionType]||W.actionType})]})}),(W==null?void 0:W.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(W.targetAudience)?W.targetAudience:[W.targetAudience]).map(A=>{const H=xr[A]||ct;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(H,{className:"h-3.5 w-3.5"}),pr[A]||A]},A)})]}),((V=W==null?void 0:W.allowedFormIds)==null?void 0:V.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",W.allowedFormIds.map(A=>l(A)).join(", ")]}),((ue=W==null?void 0:W.allowedTemplateIds)==null?void 0:ue.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",W.allowedTemplateIds.map(A=>M(A)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(W==null?void 0:W.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(W==null?void 0:W.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),N&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>L(!_),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Ls,{className:Ue("h-4 w-4 transition-transform",_&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:A=>{A.stopPropagation(),le()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(zs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),_&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(N,null,2)})]}),O&&e.jsxs("div",{className:Ue("rounded-lg p-4 flex items-start gap-3",O.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[O.success?e.jsx(qs,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Wt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Ue("font-medium text-sm",O.success?"text-green-800":"text-red-800"),children:[O.status==="executed"&&"Ex√©cut√© avec succ√®s",O.status==="simulated"&&"Simulation uniquement",O.status==="blocked"&&"Ex√©cution bloqu√©e",O.status==="error"&&"Erreur"]}),e.jsx("p",{className:Ue("text-sm mt-1",O.success?"text-green-700":"text-red-700"),children:O.message})]})]})]})]}),q&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(xe,{variant:"outline",onClick:E,disabled:z,children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(xe,{onClick:Q,disabled:!N||z||!D,className:Ue(!D&&"opacity-50 cursor-not-allowed"),children:[z?e.jsx(Vs,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(_a,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},Le="completed",Ce="in_progress",ze="pending",it={[Le]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Ce]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[ze]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},ts=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(a=>({...a,status:a.status||ze}))};if(t.status!==Ce)return s;if(!s.subSteps.some(a=>a.status===Ce)){const a=s.subSteps.findIndex(g=>g.status===ze);a!==-1&&(s.subSteps=s.subSteps.map((g,m)=>({...g,status:m===a?Ce:g.status})))}return s},ss=(t,s,r)=>{var P;if(!t)return t;const a=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,g=a?`${s}:${a}`:null,m=g&&r?r[g]:null,h=(P=m==null?void 0:m.configJson)==null?void 0:P.actions;if(!h||h.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const N=t.subSteps.map((b,z)=>{var _,L;const p=h[z],T=((L=(_=p==null?void 0:p.config)==null?void 0:_.objective)==null?void 0:L.trim())||(p==null?void 0:p.title)||(p==null?void 0:p.label);return{...b,name:T||b.name||`Action ${z+1}`}});return{...t,subSteps:N}}const f=t.status||ze,C=h.map((N,b)=>{var z;return{id:N.id||`v2-${a}-action-${b}`,name:((z=N.config)==null?void 0:z.objective)&&N.config.objective.trim()||N.title||N.label||`Action ${b+1}`,status:f===Le?Le:f===Ce&&b===0?Ce:ze}});return{...t,subSteps:C,status:f}},jr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===Le),yr=({form:t,prospectId:s,onFormSubmit:r})=>{const[a,g]=i.useState({}),m=(f,C)=>{g(P=>({...P,[f]:C}))},h=()=>{r(s,t.id,a),X({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(f=>{if(f.show_if_conditions&&f.show_if_conditions.length>0){const P=f.condition_operator||"AND",N=f.show_if_conditions.map(z=>{const p=a[z.field];return z.equals==="has_value"?!!p&&p!=="":p===z.equals});if(!(P==="AND"?N.every(z=>z===!0):N.some(z=>z===!0)))return null}if(f.show_if){const P=f.show_if.field,N=f.show_if.equals,b=a[P];if(!b||b!==N)return null}return(t.fields||[]).some(P=>P.is_repeater&&(P.repeats_fields||[]).includes(f.id))?null:e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${f.id}`,children:f.label}),e.jsx(Je,{id:`${t.id}-${f.id}`,type:f.type,value:typeof a[f.id]=="object"?"":a[f.id]||"",onChange:P=>m(f.id,P.target.value),placeholder:f.placeholder||""}),f.is_repeater&&f.repeats_fields&&f.repeats_fields.length>0&&a[f.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(a[f.id])||0},(P,N)=>{const b=(t.fields||[]).filter(z=>f.repeats_fields.includes(z.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[f.label," #",N+1]}),b.map(z=>{const p=`${f.id}_repeat_${N}_${z.id}`,O=a[p];return e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${p}`,children:z.label}),e.jsx(Je,{id:`${t.id}-${p}`,type:z.type,value:typeof O=="object"?"":O||"",onChange:T=>m(p,T.target.value),placeholder:z.placeholder||""})]},p)})]},N)})})]},f.id)}),e.jsx(xe,{onClick:h,className:"w-full",children:"Soumettre"})]})},Nr=({prospectId:t,projectType:s,currentStepIndex:r,activeAdminUser:a,initialChannel:g})=>{var Ge,je;const{addChatMessage:m,prompts:h,projectsData:f,forms:C,updateProspect:P,prospects:N,completeStepAndProceed:b,registerClientForm:z}=He(),{users:p,loading:O}=mt(),{messages:T,loading:_}=ys(t,s),{uploadFile:L,uploading:D}=vs({projectType:s,prospectId:t,organizationId:a==null?void 0:a.organization_id,enabled:!0}),{addProjectEvent:S}=st({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),{user:o}=rt(),[u,R]=i.useState(""),[B,k]=i.useState(null),$=i.useRef(null),ne=i.useRef(null),[oe,he]=i.useState(!1),[ve,q]=i.useState(!1),[W,E]=i.useState(g==="partner"?"partner":g==="internal"?"internal":"client"),{organizationId:Q}=ut(),{templates:le,loading:de}=ws(Q||(a==null?void 0:a.organization_id),s),{forms:l,loading:M}=Gs(Q||(a==null?void 0:a.organization_id)),{templates:V,loading:ue}=Js(Q||(a==null?void 0:a.organization_id)),A=(je=(Ge=f[s])==null?void 0:Ge.steps)==null?void 0:je[r],H=i.useMemo(()=>A!=null&&A.name?A.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${r}`,[A,r]),y=i.useMemo(()=>{if(!le||!H)return null;const d=le[`${s}:${H}`];return(d==null?void 0:d.configJson)||null},[le,H,s]),ce=i.useMemo(()=>l?Object.values(l).map(d=>({id:d.id,name:d.name||d.title||"Formulaire sans nom"})):[],[l]),se=i.useMemo(()=>V?Array.isArray(V)?V.map(d=>({id:d.id,name:d.name||"Template sans nom"})):Object.values(V).map(d=>({id:d.id,name:d.name||"Template sans nom"})):[],[V]),w=N.find(d=>d.id===t),Z=i.useMemo(()=>Object.values(h).filter(d=>{var n;if(d.projectId!==s)return!1;const J=(n=d.stepsConfig)==null?void 0:n[r];return J&&J.actions&&J.actions.length>0}),[h,s,r]),re=i.useCallback(async(d=null)=>{var F;const J=Z[0];if(!J){I.warn("Aucun prompt disponible");return}const n=(F=J.stepsConfig)==null?void 0:F[r];if(!n||!n.actions){I.warn("Aucune action dans la config de l'√©tape");return}const j=[...n.actions].sort((Y,ee)=>(Y.order||0)-(ee.order||0));if(d){const Y=j.findIndex(ee=>ee.id===d);if(Y!==-1&&Y+1<j.length){const ee=j[Y+1];I.info("üéØ Action suivante trouv√©e",{completedActionId:d,nextActionId:ee.id,nextActionType:ee.type}),await we(J,ee.id);return}else{I.warn("Pas d'action suivante",{completedActionId:d,totalActions:j.length});return}}await we(J)},[Z,r]);nr({prospectId:t,projectType:s,currentStepIndex:r,prompt:Z[0],sendNextAction:re}),i.useEffect(()=>{requestAnimationFrame(()=>{var d;(d=$.current)==null||d.scrollIntoView({behavior:"smooth",block:"end"})})},[T,W]);const me=async()=>{if(!(!u.trim()&&!B))try{let d=null;if(B){if(B.size>10485760){X({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}I.debug("üì§ Uploading file from admin chat",{name:B.name,size:B.size,type:B.type});const{data:{user:j}}=await pe.auth.getUser(),F=await L({file:B,uploadedBy:j==null?void 0:j.id});F&&(d={id:F.id,name:F.file_name,size:F.file_size,type:F.file_type,storagePath:F.storage_path},I.debug("‚úÖ File uploaded successfully",d))}const J={sender:"pro",text:u,file:d,channel:W,...W==="internal"&&{metadata:{sender_id:(a==null?void 0:a.user_id)||null,sender_name:(a==null?void 0:a.name)||"Admin",target_user_id:Ee||null}}};m(t,s,J),R(""),k(null),requestAnimationFrame(()=>{var n;(n=$.current)==null||n.scrollIntoView({behavior:"smooth",block:"end"})}),d&&X({title:"‚úÖ Fichier envoy√©",description:`${d.name} a √©t√© envoy√© avec succ√®s.`})}catch(d){I.error("‚ùå Error sending message with file",d),X({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${d.message}`,variant:"destructive"})}},ie=d=>{d.target.files&&d.target.files[0]&&k(d.target.files[0])},Se=async d=>{if(!d||!d.storagePath){X({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{I.debug("üì• Downloading file",{storagePath:d.storagePath});const{data:J,error:n}=await pe.storage.from("project-files").createSignedUrl(d.storagePath,3600);if(n)throw n;window.open(J.signedUrl,"_blank"),X({title:"‚úÖ T√©l√©chargement",description:`${d.name} s'ouvre dans un nouvel onglet.`})}catch(J){I.error("‚ùå Error downloading file",J),X({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${J.message}`,variant:"destructive"})}},ye=(d,J,n)=>{var be;const j=N.find(c=>c.id===d);if(!j)return;const F={...j.formData||{},...n};P({...j,formData:F});const Y={sender:"client",text:`A compl√©t√© le formulaire : ${((be=C[J])==null?void 0:be.name)||"Formulaire"}.`};if(m(d,s,Y),Object.values(h).find(c=>{var x,K;if(c.projectId!==s)return!1;const v=(x=c.stepsConfig)==null?void 0:x[r];return v!=null&&v.autoCompleteStep?(K=v.actions)==null?void 0:K.some(te=>te.type==="show_form"&&te.formId===J):!1})){const c=y==null?void 0:y.actions;if(c&&c.length>1){X({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}b(t,s,r),X({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},we=async(d,J=null)=>{var j,F,Y,ee,be,c,v,x;const n=(j=d.stepsConfig)==null?void 0:j[r];if(n&&n.actions&&n.actions.length>0){const K=T,te=[...n.actions].sort((G,ge)=>(G.order||0)-(ge.order||0));let U=te,ae=!1;if(J){const G=te.find(ge=>ge.id===J);if(!G){I.warn("Action sp√©cifique introuvable",{specificActionId:J});return}I.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:J,actionType:G.type}),U=[G],ae=!0}for(const G of U)if(!(!ae&&K.some(fe=>fe.promptId===d.id&&fe.stepIndex===r&&(fe.text===G.message||fe.formId===G.formId&&G.type==="show_form")))){if(G.message){const ge={sender:"pro",text:G.message,promptId:d.id,stepIndex:r,actionId:G.id};m(t,s,ge)}if(G.type==="show_form"&&G.formId){const ge={sender:"pro",formId:G.formId,promptId:d.id,stepIndex:r,actionId:G.id};m(t,s,ge);const fe=((ee=(Y=(F=f[s])==null?void 0:F.steps)==null?void 0:Y[r])==null?void 0:ee.name)||"√âtape inconnue";try{const Pe=await z({prospectId:t,projectType:s,formId:G.formId,currentStepIndex:r,promptId:d.id,messageTimestamp:Date.now(),status:"pending",stepName:fe,actionId:G.id});if(!Pe.success)I.error("‚ùå √âchec enregistrement formulaire:",Pe.error),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const Te=((be=C[G.formId])==null?void 0:be.name)||G.formId;await S({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${Te} a √©t√© envoy√© √† ${(w==null?void 0:w.name)||"le client"}.`,createdBy:(o==null?void 0:o.user_id)||null,createdByName:(o==null?void 0:o.name)||"Admin"})}catch(Te){I.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Te)}}catch(Pe){I.error("‚ùå Exception enregistrement formulaire:",Pe),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(G.type==="start_signature"&&G.templateId)try{if(!(a!=null&&a.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");I.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:G.templateId,prospectId:t,projectType:s,organizationId:a.organization_id,formId:G.formId});const{data:ge,error:fe}=await pe.from("prospects").select("form_data").eq("id",t).single(),Pe=((v=(c=ge==null?void 0:ge.form_data)==null?void 0:c[s])==null?void 0:v[G.formId])||{};I.info("üìã Donn√©es formulaire extraites",{formId:G.formId,dataKeys:Object.keys(Pe)}),X({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const Te=await ja({templateId:G.templateId,projectType:s,prospectId:t,formData:Pe,organizationId:a==null?void 0:a.organization_id});if(Te.success){const Ze=Te.fileData.id;I.debug("Cr√©ation proc√©dure de signature...",{fileId:Ze,prospectId:t,projectType:s});const{data:Ve}=await pe.from("signature_procedures").select("*").eq("file_id",Ze).eq("prospect_id",t).eq("status","pending").maybeSingle();let Ne=Ve;if(!Ne){const Re=crypto.randomUUID(),Ie=new Date;Ie.setDate(Ie.getDate()+7);const Ht=[{role:"principal",name:(w==null?void 0:w.name)||"Client",email:w==null?void 0:w.email,phone:(w==null?void 0:w.phone)||null,access_token:Re,requires_auth:!0,status:"pending",signed_at:null}];if(!(a!=null&&a.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const As=typeof(w==null?void 0:w.name)=="string"&&w.name.trim()!==""?w.name:((x=w==null?void 0:w.email)==null?void 0:x.split("@")[0])||"Client",Ps=w==null?void 0:w.email,{data:Ds,error:It}=await pe.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:Ze,access_token:Re,access_token_expires_at:Ie.toISOString(),status:"pending",signers:Ht,organization_id:a.organization_id,signer_name:As,signer_email:Ps}).select().single();if(It)throw I.error("Erreur cr√©ation signature_procedures",It),It;Ne=Ds,I.debug("Proc√©dure de signature cr√©√©e",{procedureId:Ne.id,signersCount:Ht.length})}const St=`https://evatime.fr/signature/${Ne.id}?token=${Ne.access_token}`,{data:nt}=await pe.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${Ne.id}%`).maybeSingle();nt||(await pe.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${St}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:a==null?void 0:a.organization_id,channel:"client"}),I.debug("Lien de signature envoy√© dans le chat")),X({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await S({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(w==null?void 0:w.name)||"le client"}.`,createdBy:(o==null?void 0:o.user_id)||null,createdByName:(o==null?void 0:o.name)||"Admin"})}catch(Re){I.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Re)}}else throw new Error(Te.error||"Erreur inconnue")}catch(ge){I.error("‚ùå Exception g√©n√©ration contrat:",ge),X({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${ge.message}`,variant:"destructive"})}break}}he(!1)},_e=T.filter(d=>!d.channel||d.channel==="client"),Ae=T.filter(d=>d.channel==="partner"),ke=T.filter(d=>d.channel==="internal"),We=W==="partner"?Ae:W==="internal"?ke:_e,[Ee,qe]=i.useState(null),De=i.useMemo(()=>{const d=(p||[]).filter(v=>v.user_id!==(a==null?void 0:a.user_id)).filter(v=>v.role!=="Partner"),J=w==null?void 0:w.ownerId,n=d.find(v=>v.user_id===J),j=n!=null&&n.manager_id?d.find(v=>v.user_id===n.manager_id):null,F=new Set;n&&F.add(n.user_id),j&&F.add(j.user_id);const Y={"Global Admin":0,Admin:1,Manager:2,Commercial:3},ee=d.filter(v=>!F.has(v.user_id)).sort((v,x)=>(Y[v.role]??9)-(Y[x.role]??9)),be=[];n&&be.push({...n,tag:"üëë Owner"}),j&&be.push({...j,tag:"üë§ Manager"});let c=null;return ee.forEach(v=>{v.role!==c&&(c=v.role,be.push({isSeparator:!0,role:c})),be.push(v)}),be},[p,a,w==null?void 0:w.ownerId]);return i.useEffect(()=>{if(!Ee&&(w!=null&&w.ownerId)){const d=w.ownerId===(a==null?void 0:a.user_id),J=De.find(n=>!n.isSeparator);d&&J?qe(J.user_id):d||qe(w.ownerId)}},[w==null?void 0:w.ownerId,a==null?void 0:a.user_id,De]),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex mb-3 rounded-xl overflow-hidden border-2 border-gray-200",children:[e.jsxs("button",{onClick:()=>E("client"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${W==="client"?"bg-blue-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üí¨ Client",_e.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${W==="client"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:_e.length})]}),e.jsxs("button",{onClick:()=>E("partner"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${W==="partner"?"bg-orange-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üü† Partenaire",Ae.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${W==="partner"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:Ae.length})]}),e.jsxs("button",{onClick:()=>E("internal"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${W==="internal"?"bg-purple-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üë• Interne",ke.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${W==="internal"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ke.length})]})]}),W==="internal"&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("span",{className:"text-sm text-purple-600 font-bold whitespace-nowrap",children:"‚Üí √Ä :"}),e.jsxs("select",{value:Ee||"",onChange:d=>qe(d.target.value),className:"flex-1 text-sm border-2 border-purple-300 rounded-xl px-3 py-2.5 bg-purple-50 text-purple-900 font-semibold focus:ring-2 focus:ring-purple-400 focus:border-purple-400 focus:outline-none appearance-none cursor-pointer shadow-sm",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237c3aed' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"},children:[De.filter(d=>!d.isSeparator).length===0&&e.jsx("option",{value:"",children:"Aucun coll√®gue disponible"}),De.map((d,J)=>d.isSeparator?e.jsx("optgroup",{label:`‚îÄ‚îÄ ${d.role} ‚îÄ‚îÄ`},`sep-${J}`):e.jsx("option",{value:d.user_id,children:d.tag?`${d.tag}  ¬∑  ${d.name||d.email}`:d.name||d.email},d.user_id))]})]}),e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[We.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400 text-sm",children:W==="partner"?"üü† Aucun message partenaire":W==="internal"?"üë• Aucun message interne":"üí¨ Aucun message client"}),We.map((d,J)=>{var v,x,K;const n=d.sender==="pro"||d.sender==="admin",j=d.sender==="partner",F=d.sender==="client",Y=d.channel==="internal",ee=Y&&((v=d.metadata)==null?void 0:v.sender_id)===(a==null?void 0:a.user_id),be=Y&&!ee,c=Y?ee:n;return e.jsxs("div",{className:`flex items-end gap-2 ${c?"justify-end":"justify-start"}`,children:[F&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(w==null?void 0:w.name.charAt(0))||"?"}),j&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center font-bold text-white text-xs",children:"P"}),be&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-400 flex items-center justify-center font-bold text-white text-xs",children:(((x=d.metadata)==null?void 0:x.sender_name)||"?").charAt(0).toUpperCase()}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${Y?ee?"bg-purple-500 text-white rounded-br-none p-2.5":"bg-purple-100 text-purple-900 rounded-bl-none p-3 border border-purple-200":n?"bg-blue-500 text-white rounded-br-none p-2.5":j?"bg-orange-100 text-orange-900 rounded-bl-none p-3 border border-orange-200":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[Y&&((K=d.metadata)==null?void 0:K.sender_name)&&e.jsxs("span",{className:`inline-block text-xs font-bold mb-1 ${ee?"text-purple-200":"text-purple-600"}`,children:["üë• ",d.metadata.sender_name]}),j&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-600 mb-1",children:"üü† Partenaire"}),d.channel==="partner"&&n&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-300 mb-1",children:"‚Üí Partenaire"}),d.text&&(n&&d.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:d.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:d.text})),d.file&&e.jsxs("button",{onClick:()=>Se(d.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Oe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:d.file.name}),e.jsx(ht,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),d.formId&&C[d.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(yr,{form:C[d.formId],prospectId:t,onFormSubmit:ye})}),e.jsx("p",{className:`text-xs mt-1 ${Y?ee?"text-purple-200":"text-purple-400":n?"text-blue-200":j?"text-orange-400":"text-gray-500"}`,children:Xs(new Date(d.timestamp),{addSuffix:!0,locale:Be})})]}),ee&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center font-bold text-white text-xs",children:((a==null?void 0:a.name)||"?").charAt(0).toUpperCase()}),n&&!Y&&!d.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},J)}),e.jsx("div",{ref:$})]}),B&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Gt,{className:"w-4 h-4"}),e.jsx("span",{children:B.name}),e.jsx("button",{onClick:()=>k(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Je,{placeholder:W==="internal"?"üë• √âcrire en interne...":W==="partner"?"üü† √âcrire au partenaire...":"üí¨ √âcrire au client...",className:`pr-28 h-12 ${W==="internal"?"border-purple-300 focus:ring-purple-400":W==="partner"?"border-orange-300 focus:ring-orange-400":""}`,value:u,onChange:d=>R(d.target.value),onKeyPress:d=>d.key==="Enter"&&me()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(xe,{variant:"ghost",size:"icon",onClick:()=>q(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(hs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(xe,{variant:"ghost",size:"icon",onClick:()=>ne.current.click(),disabled:D,children:e.jsx(Gt,{className:`h-5 w-5 ${D?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:ne,onChange:ie,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:D}),e.jsx(xe,{onClick:me,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:D,children:D?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Ys,{className:"h-4 w-4"})})]})]}),e.jsx(br,{isOpen:ve,onClose:()=>q(!1),prospectId:t,projectType:s,moduleId:H,moduleName:(A==null?void 0:A.name)||`√âtape ${r+1}`,moduleConfig:y,context:{organizationId:Q||(a==null?void 0:a.organization_id),adminUser:a},availableForms:ce,availableTemplates:se})]})},vr=({steps:t,onUpdateStatus:s,prompts:r,projectType:a,currentStepIndex:g,prospectId:m,completeStepAndProceed:h})=>{var _;if(!t)return null;const[f,C]=i.useState({}),{activeAdminUser:P,appointments:N,updateAppointment:b}=He(),z=r?Object.values(r).find(L=>L.projectId===a):null,p=(_=z==null?void 0:z.stepsConfig)==null?void 0:_[g],O=i.useMemo(()=>{if(!t[g])return[];const L=t[g].name,D=N.filter(S=>S.type==="task"&&S.contactId===m&&S.projectId===a&&S.step===L);return D.length>0&&I.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:m,projectType:a,stepName:L,totalAppointments:N.length,filteredTasks:D.length,tasks:D.map(S=>({id:S.id,title:S.title,contactId:S.contactId,projectId:S.projectId,step:S.step}))}),D},[N,m,a,g,t]),T=(L,D)=>{C(S=>{var k;const o=S[L]||{},u={...o,[D]:!o[D]},R={...S,[L]:u},B=(k=p==null?void 0:p.actions)==null?void 0:k.find($=>$.id===L);return B&&B.checklist&&B.checklist.every(ne=>u[ne.id])&&p!=null&&p.autoCompleteStep&&(X({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),h(m,a,g,t)),R})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((L,D)=>{const S=it[L.status]||it[ze];return e.jsxs(Ke.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:D*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${S.iconOnly}`,children:L.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${S.text}`,children:L.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[L.subSteps&&L.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[L.subSteps.filter(o=>o.status===Le).length,"/",L.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(xe,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${S.badge} hover:opacity-90`,onClick:o=>{var k;o.stopPropagation();const u=o.currentTarget,R=u.nextElementSibling,B=u.closest("[data-step-status-container]");!R||!B||((k=B.parentElement)==null||k.querySelectorAll('[data-dropdown="step-status"]').forEach($=>{$!==R&&$.classList.add("hidden")}),R.classList.toggle("hidden"))},children:S.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),s(D,Ce),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),s(D,Le),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),s(D,ze),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),L.subSteps&&L.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:L.subSteps.map((o,u)=>{const R=it[o.status]||it[ze];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${o.status===Le?"bg-green-500":o.status===Ce?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:o.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${R.badge}`,children:R.label})]},o.id||u)})}),L.status===Ce&&D===g&&(p==null?void 0:p.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:p.actions.filter(o=>o.hasClientAction===!1&&o.checklist&&o.checklist.length>0).map(o=>{const u=f[o.id]||{},R=o.checklist.length,B=o.checklist.filter($=>u[$.id]).length,k=B===R;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${k?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[B,"/",R]})]}),e.jsx("div",{className:"space-y-2",children:o.checklist.map($=>{const ne=u[$.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:()=>T(o.id,$.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ne?"text-purple-500 line-through":"text-purple-800"}`,children:$.text})]},$.id)})}),(p==null?void 0:p.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},o.id)})}),L.status===Ce&&D===g&&O.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:O.map(o=>{const u=o.status==="effectue",R=o.startTime?new Date(o.startTime):null,B=R&&!isNaN(R.getTime()),k=async()=>{const $=u?"pending":"effectue";await b(o.id,{status:$}),X({title:u?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:u?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:u?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:k,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${u?"line-through text-gray-500":""} truncate flex-1`,children:o.title||"T√¢che"}),u&&e.jsx(gt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),B&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Qe(R,"dd/MM/yyyy √† HH:mm",{locale:Be})]})]})]},o.id)})})]})]},D)})})]})},wr=({prospect:t,projectType:s,supabaseSteps:r,v2Templates:a,onUpdate:g})=>{var de;const{forms:m,prompts:h,completeStepAndProceed:f,activeAdminUser:C,appointments:P,updateAppointment:N}=He(),{formPanels:b=[],loading:z,updateFormPanel:p}=Ks(t.id),{sendMessage:O}=ys(t.id,s),[T,_]=i.useState(null),[L,D]=i.useState({}),[S,o]=i.useState(!1),[u,R]=i.useState(null),[B,k]=i.useState(""),[$,ne]=i.useState(new Set),oe=i.useMemo(()=>{if(!b)return[];const l=b.filter(M=>M.prospectId===t.id&&M.projectType===s).sort((M,V)=>(V.createdAt||0)-(M.createdAt||0));return I.debug("[ProspectForms] Filtering panels",{totalPanels:b.length,prospectId:t.id,projectType:s,filteredCount:l.length,samplePanel:b[0]}),l},[b,t.id,s]);if(i.useEffect(()=>{!oe||oe.length===0||oe.forEach(l=>{var V,ue,A,H;if($.has(l.panelId)||l.status!=="submitted")return;if(l.lastSubmittedAt){const y=new Date(l.lastSubmittedAt).getTime(),se=Date.now()-y;if(se>1e4){I.debug("Form too old, skipping auto-complete",{panelId:l.panelId,ageSeconds:Math.floor(se/1e3)}),ne(w=>new Set([...w,l.panelId]));return}}I.debug("New submitted form detected",{panelId:l.panelId,formId:l.formId,projectType:l.projectType}),I.debug("Available prompts",{count:Object.keys(h).length});let M=null;if(l.promptId&&(I.debug("Searching by promptId",{promptId:l.promptId}),M=h[l.promptId]),M||(M=Object.values(h).find(y=>{var w,Z;if(I.debug("Testing prompt",{name:y.name,projectId:y.projectId,target:l.projectType}),y.projectId!==l.projectType)return!1;const ce=(w=y.stepsConfig)==null?void 0:w[l.currentStepIndex];return(Z=ce==null?void 0:ce.actions)==null?void 0:Z.some(re=>re.type==="show_form"&&re.formId===l.formId)})),I.debug("Prompt found",{name:M==null?void 0:M.name,autoComplete:(ue=(V=M==null?void 0:M.stepsConfig)==null?void 0:V[l.currentStepIndex])==null?void 0:ue.autoCompleteStep}),M){const y=(A=M.stepsConfig)==null?void 0:A[l.currentStepIndex],ce=(H=y==null?void 0:y.actions)==null?void 0:H.find(w=>w.type==="show_form"&&w.formId===l.formId),se=(ce==null?void 0:ce.verificationMode)||"human";I.debug("Checking auto-complete conditions",{autoCompleteStep:y==null?void 0:y.autoCompleteStep,verificationMode:se}),y!=null&&y.autoCompleteStep&&se==="none"&&(I.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),f(t.id,l.projectType,l.currentStepIndex),X({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}ne(y=>new Set([...y,l.panelId]))})},[oe,h,f,t.id,t.name,$]),oe.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const he=l=>{_(l.panelId);const ue=((t.form_data||t.formData||{})[l.projectType]||{})[l.formId]||{};D({...ue,_meta:{projectType:l.projectType,formId:l.formId}})},ve=()=>{_(null),D({})},q=async()=>{const{_meta:l,...M}=L,{projectType:V,formId:ue}=l||{};if(!V||!ue){I.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const A=t.form_data||t.formData||{},H={...A,[V]:{...A[V]||{},[ue]:M}},{error:y}=await pe.from("prospects").update({form_data:H}).eq("id",t.id);if(y){I.error("‚ùå Erreur sauvegarde formulaire:",y),X({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}X({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),g&&g({...t,form_data:H,formData:H}),_(null),D({})},W=(l,M)=>{D(V=>({...V,[l]:M}))},E=l=>{var ue,A;const M=Object.values(h).find(H=>H.id===l.promptId||H.projectId===l.projectType),V=(ue=M==null?void 0:M.stepsConfig)==null?void 0:ue[l.currentStepIndex];return(A=V==null?void 0:V.actions)==null?void 0:A.find(H=>H.formId===l.formId)},Q=async l=>{var M,V,ue,A,H,y;try{await p(l.panelId,{status:"approved"});const ce=E(l),se=(ce==null?void 0:ce.verificationMode)||"human";if(I.debug("üîç Checking verification mode",{verificationMode:se,shouldSearchTask:se==="human"}),se==="human"){I.debug("üîç Searching for related task",{totalAppointments:(P==null?void 0:P.length)||0,prospectId:t.id,projectType:l.projectType,stepName:l.stepName,panel:l});const je=(P==null?void 0:P.filter(n=>n.type==="task"))||[],d=je.filter(n=>n.contactId===t.id);I.debug("üîç Task filtering debug",{allTasks:je.length,prospectTasks:d.length,prospectTasksData:d.map(n=>({id:n.id,title:n.title,contactId:n.contactId,projectId:n.projectId,step:n.step,status:n.status}))}),I.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:l.projectType,step:l.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let J=P==null?void 0:P.find(n=>{var Y;const j={isTask:n.type==="task",contactMatch:n.contactId===t.id,projectMatch:n.projectId===l.projectType,stepMatch:n.step===l.stepName,isPending:n.status==="pending",titleMatch:(Y=n.title)==null?void 0:Y.includes("V√©rifier le formulaire")},F=Object.values(j).every(ee=>ee);return!F&&n.type==="task"&&n.contactId===t.id&&I.warn("üîç Task failed matching:",{taskId:n.id,title:n.title,checks:j,COMPARISON:{taskStep:`"${n.step}"`,panelStep:`"${l.stepName}"`,areEqual:n.step===l.stepName,taskStepType:typeof n.step,panelStepType:typeof l.stepName},taskData:{contactId:n.contactId,projectId:n.projectId,step:n.step,status:n.status},panelData:{projectType:l.projectType,stepName:l.stepName}}),F});J||(I.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:l.stepName}),J=P==null?void 0:P.find(n=>{var j;return n.type==="task"&&n.contactId===t.id&&n.projectId===l.projectType&&n.status==="pending"&&((j=n.title)==null?void 0:j.includes("V√©rifier le formulaire"))}),J&&I.info("‚úÖ Found task via fallback (without step match)",{taskId:J.id,taskStep:J.step})),J?(I.info("‚úÖ Found verification task, marking as completed",{taskId:J.id,prospectId:t.id,title:J.title}),await N(J.id,{status:"effectue"}),X({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):I.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:l.projectType,step:l.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else I.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:se});const w=r==null?void 0:r[l.projectType],Z=w==null?void 0:w.findIndex(je=>je.status==="in_progress"),re=Z!=null&&Z>=0?Z:l.currentStepIndex||0,me=(M=w==null?void 0:w[re])==null?void 0:M.name,ie=me?me.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,Se=`${l.projectType}:${ie}`,ye=ie&&a?a[Se]:null,we=(V=ye==null?void 0:ye.configJson)==null?void 0:V.actionConfig;I.debug("[V2] Template lookup",{panelProjectType:l.projectType,propProjectType:s,currentStepName:me,moduleId:ie,templateKey:Se,v2TemplatesKeys:a?Object.keys(a):[],templateFound:!!ye});const _e=me?bs(me):null,Ae=(we==null?void 0:we.completionTrigger)||(_e==null?void 0:_e.completionTrigger),ke=(ue=ye==null?void 0:ye.configJson)==null?void 0:ue.actions,We=ke&&ke.length>1;let Ee=!0;if(We){const je=ke.map((F,Y)=>`v2-${ie}-action-${Y}`),{data:d}=await pe.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",l.projectType).eq("status","approved");let J=new Set;(d||[]).forEach(F=>{F.action_id&&je.includes(F.action_id)&&J.add(F.action_id)});const n=(d||[]).filter(F=>!F.action_id&&(!F.step_name||F.step_name===me||F.step_name===ie));if(n.length>0){const F=je.filter(Y=>!J.has(Y));n.forEach((Y,ee)=>{ee<F.length&&J.add(F[ee])}),I.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:n.length,uncoveredIds:F,afterAssignment:[...J]})}const j=J.size;Ee=j>=ke.length,I.debug("[V2] Multi-actions check",{totalActions:ke.length,expectedActionIds:je,approvedActionIds:[...J],panelsTotal:(d||[]).length,panelsWithActionId:(d||[]).filter(F=>F.action_id).length,panelsWithoutActionId:n.length,allCompleted:Ee}),Ee||(I.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:ke.length-j}),X({title:"‚úÖ Action valid√©e",description:`Action ${j}/${ke.length} ‚Äî il reste ${ke.length-j} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}I.debug("[V2] Checking completionTrigger for form approval",{stepName:me,moduleId:ie,v2TemplateFound:!!ye,completionTrigger:Ae,currentStepIdx:re,hasMultiActions:We,allActionsCompleted:Ee});const qe=(Ae==="form_approved"||!Ae)&&Ee;let De=w;if(w&&((H=(A=w[re])==null?void 0:A.subSteps)==null?void 0:H.length)>0){const je=w[re];let d=-1;if(l.action_id&&(d=je.subSteps.findIndex(J=>J.id===l.action_id)),d===-1&&(d=je.subSteps.findIndex(J=>J.status===Ce),I.debug("[V2] Substep fallback: using first in_progress",{panelActionId:l.action_id,fallbackIndex:d})),d!==-1){I.debug("[V2] Updating substep for approved action",{actionId:l.action_id,subStepIndex:d,subStepName:je.subSteps[d].name,allActionsCompleted:Ee});const J=JSON.parse(JSON.stringify(w));if(J[re].subSteps.forEach((n,j)=>{n.status===Ce&&j!==d&&(n.status=Le)}),J[re].subSteps[d].status=Le,!Ee){let n=-1;for(let j=d+1;j<J[re].subSteps.length;j++)if(J[re].subSteps[j].status===ze){n=j;break}n!==-1&&(J[re].subSteps[n].status=Ce,I.debug("[V2] Activated next substep",{completedIndex:d,nextIndex:n,nextName:J[re].subSteps[n].name}))}await updateSupabaseSteps(l.projectType,J),De=J,I.info("[V2] Substep updated successfully",{completedSubStep:d,nextActivated:!Ee})}}if(qe&&De)I.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:l.projectType,currentStepIdx:re,stepName:me,trigger:Ae||"default_behavior"}),await f(t.id,l.projectType,re,De),X({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const je=Object.values(h).find(d=>d.id===l.promptId||d.projectId===l.projectType);if(je){const d=(y=je.stepsConfig)==null?void 0:y[l.currentStepIndex];d!=null&&d.autoCompleteStep&&(I.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:l.projectType,stepIndex:l.currentStepIndex}),w?await f(t.id,l.projectType,l.currentStepIndex,w):I.error("No steps found in supabaseSteps for projectType",{projectType:l.projectType}))}}const Ge=l.filledByRole==="partner";if(Ge)I.debug("Formulaire partenaire valid√© ‚Äî pas de message chat au client");else{const je=(ce==null?void 0:ce.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:d}=await pe.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",l.projectType).eq("sender","admin").eq("text",je).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!d||d.length===0?await O({sender:"admin",text:je,relatedMessageTimestamp:new Date().toISOString()}):I.debug("Message de validation d√©j√† envoy√© r√©cemment, skip")}X({title:"‚úÖ Formulaire valid√©",description:Ge?"Le formulaire partenaire a √©t√© valid√©.":"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(ce){I.error("‚ùå Erreur validation formulaire:",ce),X({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},le=async(l="")=>{if(u)try{const M=u,V=M.filledByRole==="partner";await p(M.panelId,{status:"rejected",rejectionReason:V?l:null});const ue=E(M),A=(ue==null?void 0:ue.verificationMode)||"human";if(I.debug("üîç Checking verification mode (reject)",{verificationMode:A,shouldSearchTask:A==="human",isPartnerForm:V}),A==="human"){I.debug("üîç Searching for related task (reject)",{totalAppointments:(P==null?void 0:P.length)||0,prospectId:t.id,projectType:M.projectType,stepName:M.stepName}),I.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:M.projectType,step:M.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let H=P==null?void 0:P.find(y=>{var w;const ce={isTask:y.type==="task",contactMatch:y.contactId===t.id,projectMatch:y.projectId===M.projectType,stepMatch:y.step===M.stepName,isPending:y.status==="pending",titleMatch:(w=y.title)==null?void 0:w.includes("V√©rifier le formulaire")},se=Object.values(ce).every(Z=>Z);return!se&&y.type==="task"&&y.contactId===t.id&&I.warn("üîç Task failed matching (REJECT):",{taskId:y.id,title:y.title,checks:ce,COMPARISON:{taskStep:`"${y.step}"`,panelStep:`"${M.stepName}"`,areEqual:y.step===M.stepName,taskStepType:typeof y.step,panelStepType:typeof M.stepName},taskData:{contactId:y.contactId,projectId:y.projectId,step:y.step,status:y.status},panelData:{projectType:M.projectType,stepName:M.stepName}}),se});H||(I.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:M.stepName}),H=P==null?void 0:P.find(y=>{var ce;return y.type==="task"&&y.contactId===t.id&&y.projectId===M.projectType&&y.status==="pending"&&((ce=y.title)==null?void 0:ce.includes("V√©rifier le formulaire"))}),H&&I.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:H.id,taskStep:H.step})),H&&(I.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:H.id,prospectId:t.id,title:H.title}),await N(H.id,{status:"effectue"}))}else I.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:A});if(V)X({title:"‚ùå Formulaire rejet√©",description:"Le partenaire verra la raison du refus sur sa mission.",className:"bg-red-500 text-white"});else{const y=`${(ue==null?void 0:ue.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${l}`;await O({sender:"admin",text:y,relatedMessageTimestamp:new Date().toISOString()}),X({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"})}o(!1),R(null),k("")}catch(M){I.error("‚ùå Erreur rejet formulaire:",M),X({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[oe.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:oe.map(l=>{var A,H;const M=m[l.formId];let V={};if(l.filledByRole==="partner"&&l.formData?V=l.formData:V=((t.form_data||t.formData||{})[l.projectType]||{})[l.formId]||{},!M)return null;const ue=l.stepName||((H=(A=r==null?void 0:r[l.projectType])==null?void 0:A[l.currentStepIndex])==null?void 0:H.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:M.name}),ue&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",ue]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${l.status==="submitted"?"bg-green-100 text-green-700":l.status==="approved"?"bg-blue-100 text-blue-700":l.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:l.status==="submitted"?"Envoy√©":l.status==="approved"?"Approuv√©":l.status==="rejected"?"Rejet√©":"En attente"})]}),l.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["‚úÖ ",l.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(xe,{size:"sm",onClick:()=>Q(l),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(gt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(xe,{size:"sm",variant:"outline",onClick:()=>{R(l),o(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),l.status==="rejected"&&l.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:l.rejectionReason.startsWith("Mission impossible")?"‚õî Mission d√©clar√©e impossible par le partenaire":"‚ùå Formulaire rejet√©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:l.rejectionReason.startsWith("Mission impossible ‚Äî ")?l.rejectionReason.replace("Mission impossible ‚Äî ",""):l.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(M.fields||[]).map(y=>{if(y.show_if_conditions&&y.show_if_conditions.length>0){const Z=y.condition_operator||"AND",re=y.show_if_conditions.map(ie=>{const Se=V[ie.field];return ie.equals==="has_value"?!!Se&&Se!=="":Se===ie.equals});if(!(Z==="AND"?re.every(ie=>ie===!0):re.some(ie=>ie===!0)))return null}if(y.show_if){const Z=y.show_if.field,re=y.show_if.equals,me=V[Z];if(!me||me!==re)return null}if((M.fields||[]).some(Z=>Z.is_repeater&&(Z.repeats_fields||[]).includes(y.id)))return null;const se=V[y.id],w=y.type==="file"&&typeof se=="object"&&(se==null?void 0:se.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-sm font-medium text-gray-600",children:y.label}),T===l.panelId?w?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Oe,{className:"inline h-4 w-4 mr-2"}),se.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):y.type==="select"?e.jsxs("select",{value:L[y.id]||"",onChange:Z=>W(y.id,Z.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(y.options||[]).map((Z,re)=>e.jsx("option",{value:Z,children:Z},re))]}):e.jsx(Je,{type:y.type||"text",value:L[y.id]||"",onChange:Z=>W(y.id,Z.target.value),placeholder:y.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:w?e.jsxs("button",{onClick:async()=>{try{const{data:Z,error:re}=await pe.storage.from("project-files").createSignedUrl(se.storagePath,3600);if(re)throw re;window.open(Z.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx("span",{children:se.name}),e.jsx(ht,{className:"h-3 w-3"})]}):se||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),y.is_repeater&&y.repeats_fields&&y.repeats_fields.length>0&&se&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(se)||0},(Z,re)=>{const me=(M.fields||[]).filter(ie=>y.repeats_fields.includes(ie.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[y.label," #",re+1]}),me.map(ie=>{const Se=`${y.id}_repeat_${re}_${ie.id}`,ye=V[Se],we=ie.type==="file"&&typeof ye=="object"&&(ye==null?void 0:ye.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:ie.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:we?e.jsxs("button",{onClick:async()=>{try{const{data:_e,error:Ae}=await pe.storage.from("project-files").createSignedUrl(ye.storagePath,3600);if(Ae)throw Ae;window.open(_e.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Oe,{className:"h-3 w-3"}),e.jsx("span",{children:ye.name}),e.jsx(ht,{className:"h-3 w-3"})]}):ye||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},Se)})]},re)})})]},y.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T===l.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(xe,{variant:"outline",size:"sm",onClick:ve,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(xe,{size:"sm",onClick:q,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Vt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(xe,{variant:"outline",size:"sm",onClick:()=>he(l),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},l.panelId)})}),e.jsx(bt,{open:S,onOpenChange:o,children:e.jsxs(jt,{className:"max-w-lg",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Rejeter le formulaire"}),e.jsx(js,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((de=E(u))==null?void 0:de.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Me,{children:"Raison du refus"}),e.jsx("textarea",{value:B,onChange:l=>k(l.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(zt,{children:[e.jsx(xe,{variant:"outline",onClick:()=>{o(!1),R(null),k("")},children:"Annuler"}),e.jsx(xe,{onClick:()=>le(B),disabled:!B.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},_r=({prospect:t,projectType:s,onUpdate:r})=>{const{forms:a}=He(),[g,m]=i.useState(null),[h,f]=i.useState({}),C=i.useMemo(()=>Object.values(a).filter(p=>p.audience==="internal"&&(p.projectIds||[]).includes(s)),[a,s]);i.useEffect(()=>{if(t&&t.form_data){const p=t.form_data[s]||{};f(p)}},[t,s]);const P=p=>{m(p)},N=()=>{if(m(null),t&&t.form_data){const p=t.form_data[s]||{};f(p)}},b=(p,O,T)=>{f(_=>({..._,[p]:{..._[p]||{},[O]:T}}))},z=async()=>{try{const p={...t.form_data||{},[s]:h},O={...t,form_data:p,formData:p};await r(O),X({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),m(null)}catch(p){I.error("Erreur sauvegarde formulaire interne:",p),X({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[C.length," formulaire(s)"]})]}),C.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:C.map(p=>{const O=h[p.id]||{},T=g===p.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:p.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(p.fields||[]).map(_=>{if(_.show_if_conditions&&_.show_if_conditions.length>0){const S=_.condition_operator||"AND",o=_.show_if_conditions.map(R=>{const B=O[R.field];return R.equals==="has_value"?!!B&&B!=="":B===R.equals});if(!(S==="AND"?o.every(R=>R===!0):o.some(R=>R===!0)))return null}if(_.show_if){const S=_.show_if.field,o=_.show_if.equals,u=O[S];if(!u||u!==o)return null}if((p.fields||[]).some(S=>S.is_repeater&&(S.repeats_fields||[]).includes(_.id)))return null;const D=O[_.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Me,{className:"text-sm font-medium text-gray-600",children:[_.label,_.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),T?_.type==="textarea"?e.jsx("textarea",{value:D,onChange:S=>b(p.id,_.id,S.target.value),placeholder:_.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):_.type==="select"?e.jsxs("select",{value:D,onChange:S=>b(p.id,_.id,S.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(_.options||[]).map((S,o)=>e.jsx("option",{value:S,children:S},o))]}):e.jsx(Je,{type:_.type||"text",value:D,onChange:S=>b(p.id,_.id,S.target.value),placeholder:_.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:D||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),_.is_repeater&&_.repeats_fields&&_.repeats_fields.length>0&&D&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(D)||0},(S,o)=>{const u=(p.fields||[]).filter(R=>_.repeats_fields.includes(R.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[_.label," #",o+1]}),u.map(R=>{const B=`${_.id}_repeat_${o}_${R.id}`,k=O[B]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:R.label}),T?R.type==="textarea"?e.jsx("textarea",{value:k,onChange:$=>b(p.id,B,$.target.value),placeholder:R.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):R.type==="select"?e.jsxs("select",{value:k,onChange:$=>b(p.id,B,$.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(R.options||[]).map(($,ne)=>e.jsx("option",{value:$,children:$},ne))]}):e.jsx(Je,{type:R.type||"text",value:k,onChange:$=>b(p.id,B,$.target.value),placeholder:R.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:k||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},B)})]},o)})})]},_.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T?e.jsxs(e.Fragment,{children:[e.jsxs(xe,{variant:"outline",size:"sm",onClick:N,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(xe,{size:"sm",onClick:z,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Vt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(xe,{variant:"outline",size:"sm",onClick:()=>P(p.id),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},p.id)})})]})},Sr=t=>{switch(t.type){case"email":return e.jsx(vt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(at,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Qs,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(wt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(Zs,{className:"h-4 w-4 text-gray-400"})}},Ir=({prospect:t,onBack:s,onUpdate:r,onEditingChange:a})=>{var be;const{getProjectSteps:g,completeStepAndProceed:m,updateProjectSteps:h,markNotificationAsRead:f,projectsData:C,formContactConfig:P,currentUser:N,userProjects:b,setUserProjects:z,getProjectInfo:p,updateProjectInfo:O,activeAdminUser:T,prompts:_,notifications:L}=He(),{supabaseUserId:D}=rt(),{users:S,loading:o}=mt(),{projectStepsStatus:u,updateProjectSteps:R}=ga(t.id),{organizationId:B}=ut(),{templates:k}=ws(B||(T==null?void 0:T.organization_id),null),[$,ne]=fs(),oe=$.get("project")||t._selectedProjectType,he=$.get("notificationId"),ve=$.get("channel"),[q,W]=i.useState(oe||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:E,addProjectEvent:Q}=st({projectType:q||"",prospectId:t.id,enabled:!!q&&!!t.id,activeAdminUser:T}),[le,de]=i.useState(!1),[l,M]=i.useState(t);i.useEffect(()=>{M(t)},[t]);const[V,ue]=i.useState(!1),A=i.useMemo(()=>q?p(t.id,q)||{}:{},[q,p,t.id]),[H,y]=i.useState((A==null?void 0:A.status)||"actif"),[ce,se]=i.useState({}),w=A==null?void 0:A.amount,Z=i.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[re,me]=i.useState(""),[ie,Se]=i.useState(!1),ye=i.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...S.map(c=>({value:c.user_id,label:c.name}))],[S]),we=i.useMemo(()=>{var v;if(!q)return[];if(u[q])return u[q].map(x=>ss(x,q,k)).map(ts);const c=(v=C[q])==null?void 0:v.steps;if(c&&c.length>0){const x=JSON.parse(JSON.stringify(c));return x[0].status="in_progress",x.map(K=>ss(K,q,k)).map(ts)}return[]},[q,u,C,k]),_e=we.findIndex(c=>c.status===Ce),Ae=we[_e]||we.find(c=>c.status===ze)||we[0];i.useEffect(()=>{if(he){f(parseInt(he));const c=new URLSearchParams($);c.delete("notificationId"),ne(c,{replace:!0})}},[he,f,ne,$]),i.useEffect(()=>{var v;const c=$.get("project");c&&c!==q&&((v=t.tags)!=null&&v.includes(c))&&W(c)},[$,t.tags]),i.useEffect(()=>{if(!(t!=null&&t.id)||!q||!L||!f)return;const c=L.filter(v=>!v.read&&v.prospectId===t.id&&v.projectType===q);c.length>0&&c.forEach(v=>{f(v.id)})},[t==null?void 0:t.id,q,L,f]),i.useEffect(()=>{I.debug("Prospect prop changed",{name:t.name}),M(t)},[t]),i.useEffect(()=>{ie||(w==null||w===""?me(""):me(w.toString()))},[w,ie]),i.useEffect(()=>{(async()=>{var K;if(!q||!t.id)return;const{data:v,error:x}=await pe.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",q).maybeSingle();x?(I.error("Erreur chargement project status:",x),y("actif")):(K=v==null?void 0:v.data)!=null&&K.status?y(v.data.status):y("actif")})()},[q,t.id]),i.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:v,error:x}=await pe.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(v){const K={};v.forEach(te=>{K[te.project_type]=te.status||"actif"}),se(K)}})()},[t.id,t.tags]),i.useEffect(()=>{a&&a(le)},[le,a]),i.useEffect(()=>{if(!t.id)return;const c=pe.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async v=>{var fe;const{new:x,old:K}=v;if(x.status!=="signed"||(K==null?void 0:K.status)==="signed")return;const te=x.project_type;I.info("[V2 Signature Listener] Signature completed",{procedureId:x.id,projectType:te,prospectId:x.prospect_id});const U=u==null?void 0:u[te];if(!U||U.length===0){I.warn("[V2 Signature Listener] No steps found for project type",{projectType:te});return}const ae=U.findIndex(Pe=>Pe.status==="in_progress");if(ae===-1){I.warn("[V2 Signature Listener] No current step in_progress",{projectType:te});return}const G=(fe=U[ae])==null?void 0:fe.name;if(!G){I.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:ae});return}const ge=bs(G);if((ge==null?void 0:ge.completionTrigger)!=="signature"){I.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:G,completionTrigger:(ge==null?void 0:ge.completionTrigger)||"null"});return}I.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:te,currentStepIdx:ae,stepName:G});try{await m(t.id,te,ae,U),X({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${G}"`,className:"bg-green-500 text-white"})}catch(Pe){I.error("[V2 Signature Listener] Error completing step",Pe)}}).subscribe();return()=>{pe.removeChannel(c)}},[t.id,u,m]);const ke=c=>{W(c),ne(v=>(v.set("project",c),v),{replace:!0})},We=async c=>{if(!q||!t.id)return;const v=H;y(c);try{const{error:x}=await pe.from("project_infos").upsert({prospect_id:t.id,project_type:q,status:c,data:(A==null?void 0:A.data)||{}},{onConflict:"prospect_id,project_type"});if(x)throw x;const K={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:te}=await pe.from("project_history").insert({prospect_id:t.id,project_type:q,event_type:"status",description:`Projet ${K[c]||c}`,organization_id:T==null?void 0:T.organization_id,metadata:{old_status:v,new_status:c}});te&&I.error("Erreur historique:",te),O(t.id,q,(U={})=>({...U,status:c})),se(U=>({...U,[q]:c})),X({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${K[c]}".`,className:"bg-green-500 text-white"})}catch(x){I.error("Erreur lors du changement de statut:",x),y(v),X({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},Ee=c=>{me(c)},qe=c=>{if(!q)return;const v=c.replace(",",".").trim();if(v===""){O(t.id,q,(te={})=>{if(!te.amount)return te;const U={...te};return delete U.amount,U}),me("");return}const x=parseFloat(v);if(Number.isNaN(x)||x<0){me(w==null?"":w.toString());return}const K=Math.round(x*100)/100;O(t.id,q,(te={})=>({...te,amount:K})),me(K.toFixed(2))},De=()=>{qe(re),Se(!1)},Ge=c=>{c.key==="Enter"&&(c.preventDefault(),qe(c.currentTarget.value),c.currentTarget.blur(),Se(!1))},je=async(c,v)=>{var K,te;const x=we[c];if(v===Le&&((K=x==null?void 0:x.subSteps)==null?void 0:K.length)>0&&!jr(x)){X({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(v===Ce&&((te=x==null?void 0:x.subSteps)==null?void 0:te.length)>0){const U=JSON.parse(JSON.stringify(we)),ae=U[c];ae.status=Ce,ae.subSteps=ae.subSteps.map((G,ge)=>({...G,status:ge===0?Ce:ze})),await R(q,U),E&&await E({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${ae.name} ¬ª`,metadata:{step_id:(ae==null?void 0:ae.id)||null,step_name:(ae==null?void 0:ae.name)||null,previous_status:(x==null?void 0:x.status)||null,new_status:Ce,project_type:q},createdBy:D,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)});return}if(v===Le){const U=JSON.parse(JSON.stringify(we));U[c].status="completed";let ae=c+1;if(ae<U.length&&(U[ae].status="in_progress"),await R(q,U),E){const G=ae<U.length?U[ae]:null;await E({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:x&&G?`√âtape ¬´ ${x.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${G.name} ¬ª`:`√âtape ¬´ ${x.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(x==null?void 0:x.id)||null,previous_step_name:(x==null?void 0:x.name)||null,previous_step_status:(x==null?void 0:x.status)||null,new_step_id:(G==null?void 0:G.id)||null,new_step_name:(G==null?void 0:G.name)||null,new_step_status:"in_progress",project_type:q},createdBy:D,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}if(ae<U.length&&U[ae].globalStepId){const G=U[ae].globalStepId,ge={...t,status:G};r(ge),X({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const U=we.map((G,ge)=>{let fe=G.status;return ge===c&&(fe=v),{...G,status:fe}});if(await R(q,U),E){const G=U[c];await E({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${G.name} ¬ª pass√©e de ¬´ ${x.status==="pending"?"√Ä venir":x.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${v==="pending"?"√Ä venir":v==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(G==null?void 0:G.id)||null,step_name:(G==null?void 0:G.name)||null,previous_status:(x==null?void 0:x.status)||null,new_status:v,project_type:q},createdBy:D,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}const ae=U[c];if(ae.globalStepId&&v==="in_progress"){const G={...t,status:ae.globalStepId};r(G)}}},d=async c=>{var x,K;const v=l.tags||[];if(!v.includes(c)){const te={...l,tags:[...v,c]};if(M(te),r(te),W(c),N&&t.id===N.id&&!b.includes(c)){const ae=[...b,c];z(ae)}const U=(x=C[c])==null?void 0:x.steps;if(U&&U.length>0)try{const ae=JSON.parse(JSON.stringify(U));ae[0].status="in_progress",await R(c,ae),I.debug("Steps initialized in Supabase",{projectType:c})}catch(ae){I.error("Steps initialization error:",ae)}X({title:"‚úÖ Projet ajout√© !",description:`Le projet ${(K=C[c])==null?void 0:K.title} a √©t√© associ√© au prospect.`})}ue(!1)},J=()=>{const c=l.tags||[];return Object.values(C).filter(v=>v.isPublic&&!c.includes(v.type))},n=async c=>{switch(c){case"Appel":l.phone&&(window.location.href=`tel:${l.phone}`);break;case"Mail":l.email&&(window.location.href=`mailto:${l.email}`);break;case"WhatsApp":if(l.phone){const v=l.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${v}`,"_blank")}else X({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const v=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${v}`:window.open(`https://www.google.com/maps/search/?api=1&query=${v}`,"_blank")}break;case"Invitation":if(!l.email){X({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const v=`${window.location.origin}/dashboard`,x=B||(T==null?void 0:T.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",l.email,"org:",x);const{error:K}=await pe.auth.signInWithOtp({email:l.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:v,data:{organization_id:x}}});K?(console.error("[handleActionClick] ‚ùå Magic link error:",K),X({title:"‚ùå Erreur envoi invitation",description:K.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",l.email),X({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${l.email}`,className:"bg-green-500 text-white"}))}catch(v){console.error("[handleActionClick] üí• Exception:",v),X({title:"‚ùå Erreur",description:v.message,variant:"destructive"})}break;default:X({title:`Action: ${c}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},j=()=>{const c=window.scrollY;de(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:c,behavior:"instant"})})})},F=()=>{try{r(l),de(!1),X({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(c){I.error("‚ùå Erreur sauvegarde:",c),X({title:"‚ùå Erreur",description:c.message,variant:"destructive"})}},Y=(c,v)=>{M(x=>({...x,[c]:v}))},ee=c=>{let v=c;c==="unassigned"?v=null:c==="user-1"&&D&&(v=D),M(x=>({...x,ownerId:v}))};return C[q],i.useEffect(()=>{const c=document.createElement("style");return c.id="disable-auto-scroll",c.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(c),()=>{const v=document.getElementById("disable-auto-scroll");v&&v.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(xe,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Hs,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:l.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(xe,{size:"icon",className:"rounded-full",onClick:()=>ue(!0),children:e.jsx(Rt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(l.tags||[]).map(c=>{var x;const v=ce[c]||"actif";return e.jsxs("button",{onClick:()=>ke(c),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${q===c?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((x=C[c])==null?void 0:x.title)||c}),v==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${q===c?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),v==="archive"&&e.jsx("span",{className:`text-xs font-medium ${q===c?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},c)}),(!l.tags||l.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:$t,label:"WhatsApp"},{icon:wt,label:"GPS"},{icon:Ws,label:"Invitation",highlight:!l.userId}].map(({icon:c,label:v,highlight:x})=>e.jsxs("button",{onClick:()=>n(v),className:`flex flex-col items-center space-x-1 transition-colors group ${x?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${x?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(c,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:v})]},v))})]}),e.jsx(Cr,{prospectId:t.id,projectType:q}),e.jsx(wr,{prospect:l,projectType:q,supabaseSteps:u,v2Templates:k,onUpdate:c=>{M(c),r&&r(c)}}),e.jsx(_r,{prospect:l,projectType:q,onUpdate:c=>{M(c),r&&r(c)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),le?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(xe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:F,children:e.jsx(Vt,{className:"h-4 w-4"})}),e.jsx(xe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>de(!1),children:e.jsx(Ye,{className:"h-4 w-4"})})]}):e.jsx(xe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:j,children:e.jsx(ft,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[P.map(c=>e.jsxs("div",{className:"flex items-start space-x-3",children:[Sr(c),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{htmlFor:c.id,className:"text-xs text-gray-500",children:c.name.replace("*","")}),le?e.jsx(Je,{id:c.id,name:c.id,type:c.type,value:l[c.id]||"",onChange:v=>Y(c.id,v.target.value),className:"h-8 text-sm",placeholder:c.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:l[c.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},c.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"Suivi par"}),le?e.jsx(ma,{options:ye,value:l.ownerId||"unassigned",onSelect:ee,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((be=S.find(c=>c.user_id===l.ownerId))==null?void 0:be.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(wa,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(gr,{prospectId:t.id,projectType:q,currentStep:Ae,statusConfig:it,activeAdminUser:T,children:q&&e.jsx(Nr,{prospectId:t.id,projectType:q,currentStepIndex:_e!==-1?_e:0,activeAdminUser:T,initialChannel:ve})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[q&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>Se(!ie),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:ie?"Annuler":"Modifier le montant",children:ie?e.jsx(Ye,{className:"h-4 w-4 text-gray-600"}):e.jsx(ft,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),ie?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(Je,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:re,onChange:c=>Ee(c.target.value),onKeyDown:Ge,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(xe,{size:"sm",onClick:De,className:"h-8",children:e.jsx(gt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof w=="number"?Z.format(w):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Ft,{value:H,onValueChange:We,children:[e.jsx(Mt,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${H==="actif"?"bg-green-100 text-green-700":H==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Ot,{})}),e.jsxs(Lt,{className:"w-44",children:[e.jsx(Fe,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx(Fe,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx(Fe,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(vr,{steps:we,onUpdateStatus:je,prompts:_,projectType:q,currentStepIndex:_e,prospectId:t.id,completeStepAndProceed:m})]})]})]})]}),e.jsx(bt,{open:V,onOpenChange:ue,children:e.jsxs(jt,{className:"sm:max-w-md",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Ajouter un projet"}),e.jsx(js,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:J().length>0?J().map(c=>e.jsxs(xe,{variant:"outline",onClick:()=>d(c.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:c.icon}),e.jsx("span",{className:"font-medium",children:c.title})]},c.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},Cr=({prospectId:t,projectType:s})=>{var W;const{activeAdminUser:r,prospects:a,projectsData:g,appointments:m,agendaLoading:h,updateAppointment:f,deleteAppointment:C,addAppointment:P,addCall:N,addTask:b,updateCall:z,updateTask:p}=He(),{users:O,loading:T}=mt(),{supabaseUserId:_}=rt(),[L,D]=i.useState(null),[S,o]=i.useState(null),[u,R]=i.useState(null),[B,k]=i.useState(!1),[$,ne]=i.useState(null),oe=i.useMemo(()=>!m||m.length===0?[]:m.filter(Q=>{var de;if(Q.contactId!==t||s&&Q.projectId!==s)return!1;const le=(de=Q.status)==null?void 0:de.toLowerCase();return!(le!=="pending"&&le!=="prevu")}).sort((Q,le)=>{const de=new Date(Q.start),l=new Date(le.start);return de-l}),[m,t,s]),he=(E,Q)=>{R(E)},ve=()=>{D(null),o(null),R(null)},q=E=>{R(null),ne({...E,type:E.type}),k(!0)};return h?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(W=g[s])==null?void 0:W.title})`]})}),oe.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:oe.map(E=>{const Q=new Date(E.start),le={physical:{icon:ot,color:"blue",label:"üìç RDV"},virtual:{icon:ot,color:"purple",label:"üé• Visio"},call:{icon:at,color:"green",label:"üìû Appel"},task:{icon:gt,color:"yellow",label:"‚úÖ T√¢che"}},de=le[E.type]||le.physical,l=de.icon,M={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},V={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>he(E,E.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${de.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(l,{className:`h-5 w-5 text-${de.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:E.title||de.label}),E.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:E.notes}),E.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",E.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${de.color}-700 bg-${de.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Qe(Q,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Qe(Q,"HH:mm")})]})]}),V[E.status]&&E.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${M[E.status]}`,children:V[E.status]})]},E.id)})})]}),e.jsx(kr,{event:u,onClose:ve,onReport:()=>{},onEdit:q,prospects:a,supabaseUsers:O,updateAppointment:f,deleteAppointment:C,projectsData:g}),B&&e.jsx(Ns,{open:B,onOpenChange:E=>{E||ne(null),k(E)},initialData:$||{contactId:t,projectId:s},defaultAssignedUserId:_,addAppointment:P,addCall:N,addTask:b,updateAppointment:f,updateCall:z,updateTask:p,prospects:a||[],users:O||[],projectsData:g||{}})]})},kr=({event:t,onClose:s,onReport:r,onEdit:a,prospects:g,supabaseUsers:m,updateAppointment:h,deleteAppointment:f,projectsData:C})=>{var S;const[P,N]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&N(t.status||"pending")},[t]),!t||!g||!m||!h||!f||!C)return null;const b=g.find(o=>o.id===t.contactId),z=m.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(b?m.find(o=>o.user_id===b.ownerId):null),p=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",O=(o,u,R={})=>{try{const B=new Date(o);return isNaN(B.getTime())?"Date invalide":Qe(B,u,R)}catch{return"Date invalide"}},T=o=>{N(o),h(t.id,{status:o}),setTimeout(()=>{s(),o==="reporte"&&r(t)},300)},_=()=>{f(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},L=o=>{if(!b){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(o){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:X({title:`Action: ${o}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},D={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:o=>!o&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ye,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p(O(t.start,"eeee d MMMM",{locale:Be}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[O(t.start,"HH:mm",{locale:Be})," - ",O(t.end,"HH:mm",{locale:Be})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),z&&e.jsxs("p",{className:"text-sm",children:[z.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:$t,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:o,label:u})=>e.jsxs("button",{onClick:()=>L(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${D[P].color}`,children:e.jsxs(Ft,{onValueChange:T,value:P,children:[e.jsx(Mt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ot,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx(Fe,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Fe,{value:"effectue",children:"Effectu√©"}),e.jsx(Fe,{value:"annule",children:"Annul√©"}),e.jsx(Fe,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((S=C[t.projectId])==null?void 0:S.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(zt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(is,{children:[e.jsx(ls,{asChild:!0,children:e.jsxs(xe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(qt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(os,{children:[e.jsxs(cs,{children:[e.jsx(ds,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(us,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ms,{children:[e.jsx(gs,{children:"Annuler"}),e.jsx(xs,{onClick:_,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(xe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>a(t),children:"Modifier l'activit√©"})]})]})})};function Er(t,s){const r=t.prospect,a=s.prospect;return!r||!a?!1:r.id===a.id&&(r.updatedAt||r.updated_at)===(a.updatedAt||a.updated_at)}const Ar=pt.memo(Ir,Er),as=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Pr=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",Xe=t=>(t||"").toString().trim().toUpperCase(),Dr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},Tr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],rs=50,ns=50,Gr=()=>{var d,J;const t=He(),[s,r]=fs(),{organizationId:a}=ut(),[g,m]=i.useState(null),[h,f]=i.useState(!1),[C,P]=i.useState("all"),[N,b]=i.useState(null),[z,p]=i.useState(!1),[O,T]=i.useState([]),[_,L]=i.useState(!1),D=i.useRef(null),[S,o]=i.useState(""),u=i.useRef(null),[R,B]=i.useState(!1),[k,$]=i.useState(!1),[ne,oe]=i.useState({}),{users:he,loading:ve}=mt(),{authUserId:q}=rt(),W=t==null?void 0:t.addProspect,{prospects:E=[],prospectsLoading:Q=!0,allProjectSteps:le={},allStepsLoading:de=!0,updateProspect:l=async()=>{},projectsData:M={},activeAdminUser:V=null,users:ue={},globalPipelineSteps:A=[],pipelineLoading:H=!0,getProjectSteps:y=()=>[],adminReady:ce=!1}=t||{},se=i.useMemo(()=>he.reduce((n,j)=>(n[j.user_id]={id:j.id,user_id:j.user_id,name:j.name,email:j.email,role:j.role,phone:j.phone,avatarUrl:j.avatar_url,managerId:j.manager_id,accessRights:j.access_rights},n),{}),[he]);i.useEffect(()=>{ce&&!Q&&!de&&!k&&$(!0)},[ce,Q,de,k]);const w=E,Z=l,re=(E==null?void 0:E.find(n=>n.id===g))||null,me=i.useMemo(()=>!A||A.length===0?Tr:A.map((n,j)=>{const F=Xe(n.label),Y=n.color||Dr[F]||as[j%as.length];return{id:n.id,label:n.label,name:Pr(n.label),color:Y}}),[A]),ie=i.useMemo(()=>{if(!V)return[];if(V.role==="Global Admin"||V.role==="Admin")return Object.values(se);const n=V.access_rights||V.accessRights,j=[V.user_id,...(n==null?void 0:n.users)||[]];return Object.values(se).filter(F=>j.includes(F.user_id))},[V,se]),Se=i.useMemo(()=>{const n=ie.map(j=>({value:j.user_id,label:j.name}));return ie.length>1?[{value:"all",label:"Tous les utilisateurs"},...n]:n},[ie]);i.useEffect(()=>{V&&N===null&&(ie.length>1?b("all"):ie.length===1&&b(ie[0].user_id))},[V,N,ie]),i.useEffect(()=>{if(!_)return;const n=j=>{D.current&&!D.current.contains(j.target)&&L(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[_]);const ye=i.useMemo(()=>{const n=new Set;return w.forEach(j=>{(j.tags||[]).forEach(F=>n.add(F))}),Array.from(n)},[w]),we=O.length===0?"Tags":O.length===1?((d=M[O[0]])==null?void 0:d.title)||O[0]:`${O.length} tags`,_e=i.useMemo(()=>{const n=w.filter(F=>{if(!V)return!1;if(V.role==="Global Admin"||V.role==="Admin")return!0;const Y=V.access_rights||V.accessRights;return[V.user_id,...(Y==null?void 0:Y.users)||[]].includes(F.ownerId)});I.debug("[FinalPipeline] Prospects count",{total:w.length,visible:n.length});let j=n;if(O.length>0&&(j=j.filter(F=>{const Y=F.tags||[];return O.some(ee=>Y.includes(ee))})),N&&N!=="all"&&(j=j.filter(F=>F.ownerId===N)),S.trim()){const F=S.toLowerCase();j=j.filter(Y=>(Y.name||"").toLowerCase().includes(F)||(Y.email||"").toLowerCase().includes(F)||(Y.city||"").toLowerCase().includes(F)||(Y.phone||"").toLowerCase().includes(F))}return C==="mine"&&q?j.filter(F=>F.ownerId===q):j},[w,C,q,N,O,S]),{stagesWithCounts:Ae,prospectsByStage:ke}=i.useMemo(()=>{var v;const n=me.reduce((x,K)=>(x[K.id]=[],x),{}),j=((v=me[0])==null?void 0:v.id)||"fallback-stage",F=new Set(me.map(x=>x.id)),Y=new Map(me.map(x=>[Xe(x.label),x.id])),ee=x=>{const K=[];return x.projectType&&M[x.projectType]&&K.push(x.projectType),Array.isArray(x.tags)&&x.tags.forEach(te=>{M[te]&&!K.includes(te)&&K.push(te)}),K},be=x=>{const K=[];if(!A.length){const U=x.stage||j,ae=F.has(U)?U:j;return K.push({stageId:ae,prospect:x}),K}if(typeof y!="function")return K.push({stageId:j,prospect:x}),K;const te=ee(x);return te.length?(te.forEach(U=>{var Ze;const ae=`${x.id}-${U}`,G=le[ae]||(typeof y=="function"?y(x.id,U):[])||[],ge=((Ze=M[U])==null?void 0:Ze.steps)||[];if(!G.length){K.push({stageId:j,prospect:x,projectType:U});return}const fe=G.find(Ve=>Ve.status==="in_progress"||Ve.status==="current")||G.find(Ve=>Ve.status==="pending")||G[G.length-1];if(!fe){K.push({stageId:j,prospect:x,projectType:U});return}const Te=(()=>{if(fe.globalStepId&&F.has(fe.globalStepId))return fe.globalStepId;if(fe.globalStepId){const Re=Xe(fe.globalStepId),Ie=Y.get(Re);if(Ie&&F.has(Ie))return Ie}const Ve=G.indexOf(fe);let Ne=null;if(Ve>=0&&ge[Ve]&&(Ne=ge[Ve]),!Ne){const Re=Xe(fe.name||fe.label);Ne=ge.find(Ie=>Xe(Ie.name||Ie.label)===Re)}if(Ne!=null&&Ne.globalStepId&&F.has(Ne.globalStepId))return Ne.globalStepId;if(Ne!=null&&Ne.globalStepId){const Re=Xe(Ne.globalStepId),Ie=Y.get(Re);if(Ie&&F.has(Ie))return Ie}if(Ne&&(Ne.label||Ne.name)){const Re=Xe(Ne.label||Ne.name),Ie=Y.get(Re);if(Ie&&F.has(Ie))return Ie}const St=Xe(fe.label||fe.name),nt=Y.get(St);return nt&&F.has(nt)?nt:j})();K.push({stageId:Te,prospect:x,projectType:U,activeStep:fe})}),K):(K.push({stageId:j,prospect:x}),K)};return _e.forEach(x=>{be(x).forEach(({stageId:te,projectType:U,activeStep:ae})=>{n[te]||(n[te]=[]),n[te].push({prospect:x,projectType:U,activeStep:ae})})}),{stagesWithCounts:me.map(x=>{var K;return{...x,count:((K=n[x.id])==null?void 0:K.length)||0}}),prospectsByStage:n}},[me,_e,A,y,M]);i.useEffect(()=>{const n=s.get("prospect"),j=s.get("project"),F=`${n}-${j}`;if(u.current===F)return;if(!n){g!==null&&(m(null),u.current=null);return}(w.find(ee=>ee.id===n)||null)&&(m(n),u.current=F)},[s,w]);const We=n=>{T(j=>j.includes(n)?j.filter(F=>F!==n):[...j,n])},Ee=i.useCallback((n,j)=>{m(n.id),r(F=>{const Y=new URLSearchParams(F);return Y.set("prospect",n.id),j?Y.set("project",j):Y.delete("project"),Y})},[r]),qe=i.useCallback(n=>{oe(j=>({...j,[n]:(j[n]||rs)+ns}))},[]),De=()=>{m(null);const n=new URLSearchParams(s);n.delete("prospect"),n.delete("project"),r(n)},Ge=async n=>{var j,F;try{if(!W)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const Y=((j=A[0])==null?void 0:j.step_id)||((F=A[0])==null?void 0:F.id);console.log("[handleAddProspect] calling addProspect",{name:n.name,email:n.email,status:Y,ownerId:V==null?void 0:V.user_id,sendInvitation:n.sendInvitation,allData:n});const ee=await W({...n,status:Y,ownerId:V==null?void 0:V.user_id});if(console.log("[handleAddProspect] result",ee),!(ee!=null&&ee.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:n.sendInvitation,email:ee.email,willSend:n.sendInvitation&&ee.email}),n.sendInvitation&&ee.email)try{const be=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",ee.email.trim(),"redirect:",be,"org:",a);const{error:c}=await pe.auth.signInWithOtp({email:ee.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:be,data:{organization_id:a}}});c?(console.error("[handleAddProspect] ‚ùå invitation error",c),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${c.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",ee.email),X({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${ee.email}`,className:"bg-green-500 text-white"}))}catch(be){console.error("[handleAddProspect] üí• invitation exception",be),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${be.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:n.sendInvitation?"no email":"sendInvitation=false"});f(!1)}catch(Y){console.error("‚ùå handleAddProspect error",Y),X({title:"Erreur",description:Y.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},je=n=>{try{Z&&(Z(n),X({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{X({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return re&&re.id?e.jsx(Ke.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Us,{name:"Fiche Prospect",children:e.jsx(Ar,{prospect:re,onBack:De,onUpdate:je,onEditingChange:B})})}):k?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(tt,{className:"w-4 h-4"}),e.jsxs("span",{children:[_e.length," prospect",_e.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:D,className:"relative inline-block text-left",children:[e.jsxs(xe,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>L(n=>!n),children:[e.jsx("span",{children:we}),e.jsx(kt,{className:"h-4 w-4"})]}),_&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[ye.map(n=>{var j;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:O.includes(n),onChange:()=>We(n),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((j=M[n])==null?void 0:j.title)||n})]},n)}),O.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>T([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(ea,{open:z,onOpenChange:p,children:[e.jsx(ta,{asChild:!0,children:e.jsxs(xe,{variant:"outline",role:"combobox","aria-expanded":z,className:"w-[230px] justify-between",children:[e.jsx(tt,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:N==="all"?"Tous les utilisateurs":((J=se[N])==null?void 0:J.name)||"Utilisateur"}),e.jsx(kt,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(sa,{className:"w-[200px] p-0",children:e.jsxs(aa,{children:[e.jsx(ra,{placeholder:"Rechercher..."}),e.jsxs(na,{children:[e.jsx(ia,{children:"Aucun utilisateur"}),e.jsx(la,{children:Se.map(n=>e.jsxs(oa,{value:n.label,onSelect:()=>{b(n.value),p(!1)},children:[e.jsx(gt,{className:Ue("mr-2 h-4 w-4",N===n.value?"opacity-100":"opacity-0")}),n.label]},n.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ca,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Je,{type:"text",placeholder:"Rechercher un prospect...",value:S,onChange:n=>o(n.target.value),className:"pl-9 pr-4"}),S&&e.jsx("button",{onClick:()=>o(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(xe,{onClick:()=>f(!0),children:[e.jsx(Rt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Ae.map(n=>e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${n.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:n.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(ke[n.id]||[]).filter(j=>{if(O.length===0)return!0;const{projectType:F}=j;return O.some(Y=>Y.toUpperCase()===(F||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const j=(ke[n.id]||[]).filter(c=>{if(O.length===0)return!0;const{projectType:v}=c;return O.some(x=>x.toUpperCase()===(v||"").toUpperCase())}),F=ne[n.id]||rs,Y=j.slice(0,F),ee=j.length>F,be=j.length-F;return e.jsxs(e.Fragment,{children:[Y.map((c,v)=>{var Te;const{prospect:x,projectType:K,activeStep:te}=c,U=`${x.id}-${K||"default"}-${n.id}-${v}`,ae=x.projectType||x.tags&&x.tags[0]||"Projet",G=K&&((Te=M[K])!=null&&Te.title)?M[K].title:ae,ge=(te==null?void 0:te.label)||(te==null?void 0:te.name)||n.name,fe=n.color||"bg-blue-100 text-blue-700",Pe=`${x.id}-${K||G}-${n.id}-${v}`;return e.jsx(Ke.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(rr,{prospect:{...x,_projectContext:{projectType:K||ae,projectTitle:G,stepLabel:ge,projectColor:fe}},onClick:()=>Ee(x,K||x.projectType||(Array.isArray(x.tags)?x.tags[0]:ae)),compact:!0,sortableId:Pe,projectsData:M})},U)}),ee&&e.jsxs("button",{onClick:()=>qe(n.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(be,ns)," de plus (",be," restants)"]}),j.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(tt,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},n.id))})})}),e.jsx(da,{open:h,onOpenChange:f,onAddProspect:Ge}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(n=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},n))})})})]})};export{Gr as default};
