import{c as Dt,r as i,R as ht,u as ks,j as e,m as Ke,C as ot,l as w,s as je,a as ut,b as He,d as As,e as st,f as Es,g as Ct,h as mt,B as fe,P as Tt,i as Be,D as bt,k as jt,X as Ye,n as yt,o as Nt,U as tt,p as at,M as vt,q as Rt,t as wt,S as Ft,v as $t,w as Mt,x as Lt,y as Le,z as Ot,A as rs,E as ns,T as zt,F as is,G as ls,H as os,I as cs,J as ds,K as us,L as ms,N as W,O as ze,Q as Ps,V as gs,W as Ds,Y as xs,Z as Bt,_ as Ts,$ as Rs,a0 as Ue,a1 as Fs,a2 as $s,a3 as Ms,a4 as ct,a5 as Ls,a6 as hs,a7 as ps,a8 as Os,a9 as zs,aa as Oe,ab as Ge,ac as gt,ad as fs,ae as bs,af as qs,ag as Vs,ah as Bs,ai as Hs,aj as Ws,ak as Gs,al as Js,am as Xs,an as Ys,ao as Ks,ap as Qs,aq as Zs,ar as Us,as as ea,at as ta,au as sa,av as aa,aw as ra,ax as na}from"./index-c6b8cbd5.js";import{u as rt,A as js,C as ia}from"./Agenda-93797fb8.js";import{S as la}from"./SearchableSelect-f2bf3698.js";import{u as oa}from"./useSupabaseProjectStepsStatus-0e6f45dc.js";import{u as ys}from"./useSupabaseProjectFiles-008651bb.js";import{F as ca,a as da,P as ua,b as ma,e as ga,u as Ns,S as qt,c as xa}from"./useSupabaseWorkflowModuleTemplates-a1990ef3.js";import{f as Qe,V as ha}from"./index-b4f80ce9.js";import{D as pt}from"./download-9deaf03a.js";import{i as pa}from"./workflowV2Config-b482875b.js";import{P as ft}from"./pen-square-e640af32.js";import{P as Ht}from"./paperclip-d86ee327.js";import"./external-link-f1ea9be8.js";const fa=Dt("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),ba=Dt("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),ja=Dt("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function ya(){for(var t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return i.useMemo(()=>r=>{s.forEach(g=>g(r))},s)}const Na=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function va(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function wa(t){return"nodeType"in t}function vs(t){var s,a;return t?va(t)?t:wa(t)&&(s=(a=t.ownerDocument)==null?void 0:a.defaultView)!=null?s:window:window}const St=Na?i.useLayoutEffect:i.useEffect;function ws(t){const s=i.useRef(t);return St(()=>{s.current=t}),i.useCallback(function(){for(var a=arguments.length,r=new Array(a),g=0;g<a;g++)r[g]=arguments[g];return s.current==null?void 0:s.current(...r)},[])}function kt(t,s){s===void 0&&(s=[t]);const a=i.useRef(t);return St(()=>{a.current!==t&&(a.current=t)},s),a}function At(t){const s=ws(t),a=i.useRef(null),r=i.useCallback(g=>{g!==a.current&&(s==null||s(g,a.current)),a.current=g},[]);return[a,r]}let It={};function Ss(t,s){return i.useMemo(()=>{if(s)return s;const a=It[t]==null?0:It[t]+1;return It[t]=a,t+"-"+a},[t,s])}function Sa(t){if(!t)return!1;const{KeyboardEvent:s}=vs(t.target);return s&&t instanceof s}const dt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:a}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:a}=t;return"scaleX("+s+") scaleY("+a+")"}},Transform:{toString(t){if(t)return[dt.Translate.toString(t),dt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:a,easing:r}=t;return s+" "+a+"ms "+r}}});var lt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(lt||(lt={}));function Wt(){}const _a=Object.freeze({x:0,y:0});function Ia(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Ca(t,s,a){const r=Ia(s);if(!r)return t;const{scaleX:g,scaleY:u,x:h,y:p}=r,S=t.left-h-(1-g)*parseFloat(a),A=t.top-p-(1-u)*parseFloat(a.slice(a.indexOf(" ")+1)),y=g?t.width/g:t.width,f=u?t.height/u:t.height;return{width:y,height:f,top:A,right:S+y,bottom:A+f,left:S}}const ka={ignoreTransform:!1};function Vt(t,s){s===void 0&&(s=ka);let a=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:A,transformOrigin:y}=vs(t).getComputedStyle(t);A&&(a=Ca(a,A,y))}const{top:r,left:g,width:u,height:h,bottom:p,right:S}=a;return{top:r,left:g,width:u,height:h,bottom:p,right:S}}function Gt(t){return Vt(t,{ignoreTransform:!0})}var et;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(et||(et={}));var Jt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Jt||(Jt={}));var Fe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Fe||(Fe={}));Fe.Space,Fe.Enter,Fe.Esc,Fe.Space,Fe.Enter,Fe.Tab;var Xt;(function(t){t[t.RightClick=2]="RightClick"})(Xt||(Xt={}));var Yt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Yt||(Yt={}));var Kt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Kt||(Kt={}));et.Backward+"",et.Forward+"",et.Backward+"",et.Forward+"";var Et;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(Et||(Et={}));var Pt;(function(t){t.Optimized="optimized"})(Pt||(Pt={}));function Aa(t){let{callback:s,disabled:a}=t;const r=ws(s),g=i.useMemo(()=>{if(a||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:u}=window;return new u(r)},[a]);return i.useEffect(()=>()=>g==null?void 0:g.disconnect(),[g]),g}function Ea(t,s){return i.useMemo(()=>t.reduce((a,r)=>{let{eventName:g,handler:u}=r;return a[g]=h=>{u(h,s)},a},{}),[t,s])}Et.WhileDragging,Pt.Optimized;const Pa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Wt,draggableNodes:new Map,over:null,measureDroppableContainers:Wt},_s=i.createContext(Pa),Da=i.createContext({..._a,scaleX:1,scaleY:1});var Qt;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Qt||(Qt={}));const Ta=i.createContext(null),Zt="button",Ra="Draggable";function Fa(t){let{id:s,data:a,disabled:r=!1,attributes:g}=t;const u=Ss(Ra),{activators:h,activatorEvent:p,active:S,activeNodeRect:A,ariaDescribedById:y,draggableNodes:f,over:O}=i.useContext(_s),{role:x=Zt,roleDescription:$="draggable",tabIndex:T=0}=g??{},b=(S==null?void 0:S.id)===s,R=i.useContext(b?Da:Ta),[C,v]=At(),[o,c]=At(),D=Ea(h,s),B=kt(a);St(()=>(f.set(s,{id:s,key:u,node:C,activatorNode:o,data:B}),()=>{const M=f.get(s);M&&M.key===u&&f.delete(s)}),[f,s]);const I=i.useMemo(()=>({role:x,tabIndex:T,"aria-disabled":r,"aria-pressed":b&&x===Zt?!0:void 0,"aria-roledescription":$,"aria-describedby":y.draggable}),[r,x,T,b,$,y.draggable]);return{active:S,activatorEvent:p,activeNodeRect:A,attributes:I,isDragging:b,listeners:r?void 0:D,node:C,over:O,setNodeRef:v,setActivatorNodeRef:c,transform:R}}const $a="Droppable",Ma={timeout:25};function La(t){let{data:s,disabled:a=!1,id:r,resizeObserverConfig:g}=t;const u=Ss($a),{active:h,dispatch:p,over:S,measureDroppableContainers:A}=i.useContext(_s),y=i.useRef({disabled:a}),f=i.useRef(!1),O=i.useRef(null),x=i.useRef(null),{disabled:$,updateMeasurementsFor:T,timeout:b}={...Ma,...g},R=kt(T??r),C=i.useCallback(()=>{if(!f.current){f.current=!0;return}x.current!=null&&clearTimeout(x.current),x.current=setTimeout(()=>{A(Array.isArray(R.current)?R.current:[R.current]),x.current=null},b)},[b]),v=Aa({callback:C,disabled:$||!h}),o=i.useCallback((I,M)=>{v&&(M&&(v.unobserve(M),f.current=!1),I&&v.observe(I))},[v]),[c,D]=At(o),B=kt(s);return i.useEffect(()=>{!v||!c.current||(v.disconnect(),f.current=!1,v.observe(c.current))},[c,v]),i.useEffect(()=>(p({type:lt.RegisterDroppable,element:{id:r,key:u,disabled:a,node:c,rect:O,data:B}}),()=>p({type:lt.UnregisterDroppable,key:u,id:r})),[r]),i.useEffect(()=>{a!==y.current.disabled&&(p({type:lt.SetDroppableDisabled,id:r,key:u,disabled:a}),y.current.disabled=a)},[r,u,a,p]),{active:h,rect:O,isOver:(S==null?void 0:S.id)===r,node:c,over:S,setNodeRef:D}}function Is(t,s,a){const r=t.slice();return r.splice(a<0?r.length+a:a,0,r.splice(s,1)[0]),r}function xt(t){return t!==null&&t>=0}const Oa=t=>{let{rects:s,activeIndex:a,overIndex:r,index:g}=t;const u=Is(s,r,a),h=s[g],p=u[g];return!p||!h?null:{x:p.left-h.left,y:p.top-h.top,scaleX:p.width/h.width,scaleY:p.height/h.height}},za="Sortable",qa=ht.createContext({activeIndex:-1,containerId:za,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Oa,disabled:{draggable:!1,droppable:!1}}),Va=t=>{let{id:s,items:a,activeIndex:r,overIndex:g}=t;return Is(a,r,g).indexOf(s)},Ba=t=>{let{containerId:s,isSorting:a,wasDragging:r,index:g,items:u,newIndex:h,previousItems:p,previousContainerId:S,transition:A}=t;return!A||!r||p!==u&&g===h?!1:a?!0:h!==g&&s===S},Ha={duration:200,easing:"ease"},Cs="transform",Wa=dt.Transition.toString({property:Cs,duration:0,easing:"linear"}),Ga={roleDescription:"sortable"};function Ja(t){let{disabled:s,index:a,node:r,rect:g}=t;const[u,h]=i.useState(null),p=i.useRef(a);return St(()=>{if(!s&&a!==p.current&&r.current){const S=g.current;if(S){const A=Vt(r.current,{ignoreTransform:!0}),y={x:S.left-A.left,y:S.top-A.top,scaleX:S.width/A.width,scaleY:S.height/A.height};(y.x||y.y)&&h(y)}}a!==p.current&&(p.current=a)},[s,a,r,g]),i.useEffect(()=>{u&&h(null)},[u]),u}function Xa(t){let{animateLayoutChanges:s=Ba,attributes:a,disabled:r,data:g,getNewIndex:u=Va,id:h,strategy:p,resizeObserverConfig:S,transition:A=Ha}=t;const{items:y,containerId:f,activeIndex:O,disabled:x,disableTransforms:$,sortedRects:T,overIndex:b,useDragOverlay:R,strategy:C}=i.useContext(qa),v=Ya(r,x),o=y.indexOf(h),c=i.useMemo(()=>({sortable:{containerId:f,index:o,items:y},...g}),[f,g,o,y]),D=i.useMemo(()=>y.slice(y.indexOf(h)),[y,h]),{rect:B,node:I,isOver:M,setNodeRef:re}=La({id:h,data:c,disabled:v.droppable,resizeObserverConfig:{updateMeasurementsFor:D,...S}}),{active:ce,activatorEvent:be,activeNodeRect:ye,attributes:z,setNodeRef:Q,listeners:_,isDragging:X,over:de,setActivatorNodeRef:ue,transform:n}=Fa({id:h,data:c,attributes:{...Ga,...a},disabled:v.draggable}),F=ya(re,Q),L=!!ce,ie=L&&!$&&xt(O)&&xt(b),k=!R&&X,q=k&&ie?n:null,H=ie?q??(p??C)({rects:T,activeNodeRect:ye,activeIndex:O,overIndex:b,index:o}):null,U=xt(O)&&xt(b)?u({id:h,items:y,activeIndex:O,overIndex:b}):o,G=ce==null?void 0:ce.id,Y=i.useRef({activeId:G,items:y,newIndex:U,containerId:f}),ae=y!==Y.current.items,ge=s({active:ce,containerId:f,isDragging:X,isSorting:L,id:h,index:o,items:y,newIndex:Y.current.newIndex,previousItems:Y.current.items,previousContainerId:Y.current.containerId,transition:A,wasDragging:Y.current.activeId!=null}),le=Ja({disabled:!ge,index:o,node:I,rect:B});return i.useEffect(()=>{L&&Y.current.newIndex!==U&&(Y.current.newIndex=U),f!==Y.current.containerId&&(Y.current.containerId=f),y!==Y.current.items&&(Y.current.items=y)},[L,U,f,y]),i.useEffect(()=>{if(G===Y.current.activeId)return;if(G&&!Y.current.activeId){Y.current.activeId=G;return}const ve=setTimeout(()=>{Y.current.activeId=G},50);return()=>clearTimeout(ve)},[G]),{active:ce,activeIndex:O,attributes:z,data:c,rect:B,index:o,newIndex:U,items:y,isOver:M,isSorting:L,isDragging:X,listeners:_,node:I,overIndex:b,over:de,setNodeRef:F,setActivatorNodeRef:ue,setDroppableNodeRef:re,setDraggableNodeRef:Q,transform:le??H,transition:Ce()};function Ce(){if(le||ae&&Y.current.newIndex===o)return Wa;if(!(k&&!Sa(be)||!A)&&(L||ge))return dt.Transition.toString({...A,property:Cs})}}function Ya(t,s){var a,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(a=t==null?void 0:t.draggable)!=null?a:s.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:s.droppable}}Fe.Down,Fe.Right,Fe.Up,Fe.Left;const Ka=t=>(t||"").toString().trim().toUpperCase(),Qa=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const a=t.prospect,r=s.prospect;if(a.id!==r.id||a.name!==r.name||a.hasAppointment!==r.hasAppointment||a.updatedAt!==r.updatedAt)return!1;const g=a._projectContext||{},u=r._projectContext||{};if(g.projectType!==u.projectType||g.projectTitle!==u.projectTitle||g.stepLabel!==u.stepLabel)return!1;const h=a.tags||[],p=r.tags||[];return!(h.length!==p.length||h.some((S,A)=>S!==p[A])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},Za=({prospect:t,onClick:s,sortableId:a,projectsData:r={}})=>{var b,R,C,v,o,c,D;ks();const g=Array.isArray(t.tags)?t.tags:[],u=((b=t._projectContext)==null?void 0:b.projectTitle)||((R=t._projectContext)==null?void 0:R.projectType)||null,h=((C=t._projectContext)==null?void 0:C.projectType)||null;(v=t._projectContext)!=null&&v.stepLabel;const p=u?Ka(u):null,S=a||(p?`${t.id}-${p}`:`${t.id}-${((o=t._projectContext)==null?void 0:o.projectType)||"default"}`),{attributes:A,listeners:y,setNodeRef:f,transform:O,transition:x,isDragging:$}=Xa({id:S,data:{prospect:t}}),T={transform:dt.Transform.toString(O),transition:x,zIndex:$?10:"auto",opacity:$?.8:1};return e.jsx("div",{ref:f,style:T,...A,...y,children:e.jsxs(Ke.div,{layoutId:`prospect-card-${S}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(ot,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[u&&g.includes(((c=t._projectContext)==null?void 0:c.projectType)||u)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((D=r[h])==null?void 0:D.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:u})}),g.filter(B=>B!==h).map(B=>{var re,ce;const I=((re=r[B])==null?void 0:re.title)||B,M=((ce=r[B])==null?void 0:ce.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:I},B)})]})]})})},Ua=i.memo(Za,Qa);function er({prospectId:t,projectType:s,currentStepIndex:a,prompt:r,sendNextAction:g}){const u=i.useRef(new Set);i.useRef(!1),i.useEffect(()=>{if(!t||!s||a===void 0||!r)return;w.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:a,promptName:r==null?void 0:r.name});const h=je.channel(`workflow-forms-${t}-${s}-${a}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async p=>{const S=p.new;w.info("üîç Form panel UPDATE re√ßu",{panelId:S.id,prospectId:S.prospect_id,projectType:S.project_type,status:S.status,actionId:S.action_id,expectedProjectType:s});const A=S.project_type===s,y=S.status==="approved",f=!!S.action_id;if(A&&y&&f){const O=`${t}-${s}-${a}-${S.action_id}`;if(u.current.has(O)){w.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:O});return}u.current.add(O),w.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:S.form_id,actionId:S.action_id}),setTimeout(()=>{w.info("üöÄ Envoi action suivante",{completedActionId:S.action_id}),g(S.action_id)},2e3)}}).subscribe();return()=>{je.removeChannel(h)}},[t,s,a,r,g])}function tr({projectType:t,prospectId:s,enabled:a=!0}){const[r,g]=i.useState([]),[u,h]=i.useState(!1),[p,S]=i.useState(!1),[A,y]=i.useState(null),{organizationId:f}=ut(),O=i.useCallback(async()=>{if(!(!t||!a))try{h(!0),y(null);let b=je.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(b=b.eq("prospect_id",s));const{data:R,error:C}=await b;if(C)throw C;g(R||[])}catch(b){w.error("Erreur r√©cup√©ration project notes:",{error:b.message}),y(b.message)}finally{h(!1)}},[t,s,a]);i.useEffect(()=>{if(!t||!a)return;O();const b=je.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},R=>{g(C=>{const{eventType:v,new:o,old:c}=R;return v==="INSERT"?[o,...C]:v==="UPDATE"?C.map(D=>D.id===o.id?o:D):v==="DELETE"?C.filter(D=>D.id!==c.id):C})}).subscribe();return()=>{je.removeChannel(b)}},[t,a,O]);const x=i.useCallback(async({content:b,createdBy:R,createdByName:C})=>{if(!(!t||!(b!=null&&b.trim())))try{if(S(!0),y(null),!f)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:v,error:o}=await je.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:b.trim(),created_by:R||null,created_by_name:C||null,organization_id:f}]).select().single();if(o)throw o;return g(c=>[v,...c]),v}catch(v){throw w.error("Erreur ajout project note:",{error:v.message}),y(v.message),v}finally{S(!1)}},[t,s,f]),$=i.useCallback(async(b,{content:R})=>{if(!(!b||!(R!=null&&R.trim())))try{S(!0),y(null);const{data:C,error:v}=await je.from("project_notes").update({content:R.trim(),updated_at:new Date().toISOString()}).eq("id",b).select().single();if(v)throw v;return g(o=>o.map(c=>c.id===b?C:c)),C}catch(C){throw w.error("Erreur update project note:",{error:C.message}),y(C.message),C}finally{S(!1)}},[]),T=i.useCallback(async b=>{if(b)try{S(!0),y(null);const{error:R}=await je.from("project_notes").delete().eq("id",b);if(R)throw R;g(C=>C.filter(v=>v.id!==b))}catch(R){throw w.error("Erreur suppression project note:",{error:R.message}),y(R.message),R}finally{S(!1)}},[]);return{notes:r,loading:u,saving:p,error:A,addNote:x,updateNote:$,deleteNote:T,refetch:O}}function sr({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r}){var o;const{activeAdminUser:g}=He(),u=r||g,[h,p]=i.useState(""),[S,A]=i.useState(!1),{getTemplateByType:y}=As(),f=y(t),O=(f==null?void 0:f.title)||t,{notes:x,loading:$,saving:T,error:b,addNote:R}=tr({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:C}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:u}),v=async()=>{if(h.trim())try{const c=await R({content:h,createdBy:(u==null?void 0:u.id)||(a==null?void 0:a.id),createdByName:(u==null?void 0:u.name)||(u==null?void 0:u.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)});c&&C&&await C({event_type:"note",title:"Note ajout√©e",description:c.content||h.trim(),metadata:{source:"notes_tab"},createdBy:(u==null?void 0:u.id)||(a==null?void 0:a.id),createdByName:(u==null?void 0:u.name)||(u==null?void 0:u.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),p("")}catch(c){w.error(c)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${O}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:h,onChange:c=>p(c.target.value),disabled:!t||T}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:v,disabled:!h.trim()||!t||T,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:T?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),b&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",b]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),x&&x.length>3&&e.jsx("button",{onClick:()=>A(!S),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:S?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx(Es,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",x.length,")"]}),e.jsx(Ct,{className:"w-4 h-4"})]})})]}),$&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!$&&(x==null?void 0:x.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(o=S?x:x==null?void 0:x.slice(0,3))==null?void 0:o.map(c=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:c.created_by_name||c.created_by?`Par ${c.created_by_name||c.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:c.created_at&&new Date(c.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:c.content})]},c.id))})]})]})}const ar=({prospectId:t,projectType:s,activeAdminUser:a})=>{const{projectsData:r,appointments:g,updateAppointment:u,deleteAppointment:h,addAppointment:p,addCall:S,addTask:A,updateCall:y,updateTask:f,prospects:O}=He(),[x,$]=i.useState(!1),[T,b]=i.useState(null),[R,C]=i.useState(null),{users:v}=mt(),{supabaseUserId:o}=rt(),{history:c,loading:D}=st({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),B=i.useMemo(()=>!c||c.length===0?[]:c.filter(_=>_.event_type==="activity").sort((_,X)=>new Date(X.created_at)-new Date(_.created_at)),[c]),I=i.useMemo(()=>{const _={};return B.forEach(de=>{var n;const ue=(n=de.metadata)==null?void 0:n.appointment_id;ue&&(_[ue]||(_[ue]=[]),_[ue].push(de))}),Object.entries(_).map(([de,ue])=>{var L;const F=ue.sort((ie,k)=>new Date(k.created_at)-new Date(ie.created_at))[0];return{...F,currentStatus:((L=F.metadata)==null?void 0:L.status)||(F.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[B]),M=i.useMemo(()=>I?I.filter(_=>_.currentStatus==="pending"):[],[I]),re=i.useMemo(()=>I?I.filter(_=>_.currentStatus!=="pending"):[],[I]),ce=_=>{switch((_==null?void 0:_.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(ot,{className:"h-4 w-4"});case"virtual":return e.jsx(ha,{className:"h-4 w-4"});case"call":return e.jsx(at,{className:"h-4 w-4"});case"task":return e.jsx(ia,{className:"h-4 w-4"});default:return e.jsx(ot,{className:"h-4 w-4"})}},be=_=>{const X=(_==null?void 0:_.activity_type)||"appointment",de=_==null?void 0:_.status;if(de==="effectue"||de==="completed")return"text-green-600 bg-green-50";if(de==="annule")return"text-red-600 bg-red-50";if(de==="reporte")return"text-yellow-600 bg-yellow-50";switch(X){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},ye=_=>{var X;return!g||!((X=_.metadata)!=null&&X.appointment_id)?null:g.find(de=>de.id===_.metadata.appointment_id)},z=_=>{const X=ye(_);X&&b(X)},Q=_=>{b(null),C({..._,type:_.type}),$(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(fe,{onClick:()=>{$(!x)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Tt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),x&&e.jsx(js,{open:x,onOpenChange:_=>{_||C(null),$(_)},initialData:R||{contactId:t,projectId:s},defaultAssignedUserId:o,addAppointment:p,addCall:S,addTask:A,updateAppointment:u,updateCall:y,updateTask:f,prospects:O||[],users:v||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),D?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(_=>{const X=ye(_),de=(X==null?void 0:X.title)||_.title||"Activit√©",ue=X!=null&&X.start?new Date(X.start):new Date(_.created_at);return e.jsxs("div",{onClick:()=>z(_),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${be(_.metadata)}`,children:ce(_.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:de}),(X==null?void 0:X.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:X.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Qe(ue,"d MMM '√†' HH:mm",{locale:Be})})]})]},_.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",re.length,")"]}),D?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):re.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:re.map(_=>{const X=ye(_),de=(X==null?void 0:X.title)||_.title||"Activit√©",ue=X!=null&&X.start?new Date(X.start):new Date(_.created_at),n={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[_.currentStatus]||_.currentStatus;return e.jsxs("div",{onClick:()=>z(_),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${be(_.metadata)}`,children:ce(_.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:de}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[n," ‚Ä¢ ",Qe(ue,"d MMM yyyy '√†' HH:mm",{locale:Be})]})]})]},_.id)})})]}),T&&e.jsx(rr,{event:T,onClose:()=>b(null),onReport:()=>{},onEdit:Q,prospects:O,supabaseUsers:v,updateAppointment:u,deleteAppointment:h,projectsData:r})]})},rr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:g,supabaseUsers:u,updateAppointment:h,deleteAppointment:p,projectsData:S})=>{var v;const[A,y]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!g||!u||!h||!p||!S)return null;const f=g.find(o=>o.id===t.contactId),O=u.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(f?u.find(o=>o.user_id===f.ownerId):null),x=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",$=(o,c,D={})=>{try{const B=new Date(o);return isNaN(B.getTime())?"Date invalide":Qe(B,c,D)}catch{return"Date invalide"}},T=o=>{y(o),h(t.id,{status:o}),setTimeout(()=>{s(),o==="reporte"&&a(t)},300)},b=()=>{p(t.id),W({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},R=o=>{if(!f){W({title:"Contact non trouv√©",variant:"destructive"});return}switch(o){case"Appel":f.phone&&(window.location.href=`tel:${f.phone}`);break;case"Mail":f.email&&(window.location.href=`mailto:${f.email}`);break;case"WhatsApp":if(f.phone){let c=f.phone.replace(/\D/g,"");c.startsWith("0")&&(c=`33${c.substring(1)}`);const D=encodeURIComponent("Bonjour");window.open(`https://wa.me/${c}?text=${D}`,"_blank")}break;case"GPS":if(f.address){const c=encodeURIComponent(f.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${c}`:window.open(`https://www.google.com/maps/search/?api=1&query=${c}`,"_blank")}break;default:W({title:`Action: ${o}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},C={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:o=>!o&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ye,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:x($(t.start,"eeee d MMMM",{locale:Be}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Be})," - ",$(t.end,"HH:mm",{locale:Be})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),f&&e.jsxs("p",{className:"text-sm",children:[f.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Rt,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:o,label:c})=>e.jsxs("button",{onClick:()=>R(c),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:c})]},c))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${C[A].color}`,children:e.jsxs(Ft,{onValueChange:T,value:A,children:[e.jsx($t,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Mt,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx(Le,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Le,{value:"effectue",children:"Effectu√©"}),e.jsx(Le,{value:"annule",children:"Annul√©"}),e.jsx(Le,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((v=S[t.projectId])==null?void 0:v.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(f==null?void 0:f.name)||"N/A"})]})]})]}),e.jsxs(Ot,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(rs,{children:[e.jsx(ns,{asChild:!0,children:e.jsxs(fe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsx(os,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(cs,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ds,{children:[e.jsx(us,{children:"Annuler"}),e.jsx(ms,{onClick:b,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(fe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})},nr=({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r})=>{const{activeAdminUser:g}=He(),{organizationId:u}=ut(),h=r||g,[p,S]=i.useState(null),{files:A,loading:y,uploading:f,deleting:O,error:x,uploadFile:$,deleteFile:T}=ys({projectType:t,prospectId:s,organizationId:u,enabled:!!t}),{addHistoryEvent:b}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:h}),R=async I=>{const M=Array.from(I.target.files||[]);if(M.length!==0)try{const re=M.map(async ce=>{S(ce);const be=await $({file:ce,uploadedBy:a==null?void 0:a.id});return be&&b&&await b({event_type:"file",title:"Fichier ajout√©",description:be.file_name,metadata:{size:be.file_size,type:be.file_type,storage_path:be.storage_path},createdBy:(h==null?void 0:h.id)||(a==null?void 0:a.id),createdByName:(h==null?void 0:h.name)||(h==null?void 0:h.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),be});await Promise.all(re),S(null),I.target.value=""}catch(re){w.error("Error uploading files:",re),S(null)}},C=async I=>{try{const{data:M,error:re}=await je.storage.from("project-files").createSignedUrl(I.storage_path,3600);if(re){w.error("Error creating signed URL:",re);return}const be=await(await fetch(M.signedUrl)).blob(),ye=window.URL.createObjectURL(be),z=document.createElement("a");z.href=ye,z.download=I.file_name,document.body.appendChild(z),z.click(),document.body.removeChild(z),window.URL.revokeObjectURL(ye)}catch(M){w.error("Error downloading file:",M)}},v=async I=>{try{w.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:I.storage_path});const{data:M,error:re}=await je.storage.from("project-files").createSignedUrl(I.storage_path,3600);if(re){w.error("Error creating signed URL:",re);return}w.debug("‚úÖ Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){w.error("Error viewing file:",M)}},o=async I=>{if(confirm(`Supprimer le fichier "${I.file_name}" ?`))try{await T(I.id,I.storage_path)}catch(M){w.error("Error deleting file:",M)}},c=I=>I!=null&&I.startsWith("image/")?e.jsx(Ds,{className:"h-5 w-5 text-blue-500"}):I==="application/pdf"?e.jsx(ze,{className:"h-5 w-5 text-red-500"}):e.jsx(ca,{className:"h-5 w-5 text-gray-500"}),D=I=>I?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(I)):"",B=I=>I?I<1024?`${I} o`:I<1024*1024?`${(I/1024).toFixed(1)} Ko`:`${(I/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Ps,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:f?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:R,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:f,multiple:!0})]})}),x&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:x}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",A.length,")"]}),y?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):A.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:A.map(I=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:c(I.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[I.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:I.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:I.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:I.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[B(I.file_size)," ‚Ä¢ ",D(I.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[I.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>v(I),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:O,children:e.jsx(gs,{className:"h-4 w-4"})}),I.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>C(I),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:O,children:e.jsx(pt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>o(I),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:O,children:e.jsx(zt,{className:"h-4 w-4"})})]})]},I.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},ir=({prospectId:t,projectType:s,activeAdminUser:a})=>{const[r,g]=i.useState("notes"),{supabaseUserId:u}=rt(),h=[{id:"notes",label:"Notes",icon:ze},{id:"activity",label:"Activit√©",icon:fa},{id:"files",label:"Fichiers",icon:da}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:h.map(({id:p,label:S,icon:A})=>e.jsxs("button",{onClick:()=>g(p),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===p?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(A,{className:"h-4 w-4"}),e.jsx("span",{children:S})]},p))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(sr,{prospectId:t,projectType:s,currentUser:{id:u},activeAdminUser:a}),r==="activity"&&e.jsx(ar,{prospectId:t,projectType:s,activeAdminUser:a}),r==="files"&&e.jsx(nr,{prospectId:t,projectType:s,currentUser:{id:u},activeAdminUser:a})]})]})},lr=({projectType:t,prospectId:s,activeAdminUser:a})=>{const{history:r,loading:g,error:u}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:a});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),g&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),u&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",u]}),!g&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(h=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.title||h.event_type}),h.description&&e.jsx("p",{className:"text-xs text-gray-600",children:h.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(h.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(h.created_by_name||h.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",h.created_by_name||h.created_by]})]})]})]})]},h.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},or=({children:t,prospectId:s,projectType:a,currentStep:r,statusConfig:g,activeAdminUser:u})=>{var h,p,S;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((h=g[r.status])==null?void 0:h.iconOnly)||g.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((p=g[r.status])==null?void 0:p.badge)||g.pending.badge}`,children:((S=g[r.status])==null?void 0:S.label)||g.pending.label})]}),t]},r.name),!r&&!a&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ze,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),a&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ir,{prospectId:s,projectType:a,activeAdminUser:u}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(lr,{prospectId:s,projectType:a,activeAdminUser:u})]})]})},cr={CLIENT:ct,COMMERCIAL:Ls,PARTENAIRE:tt},dr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},ur={FORM:ze,SIGNATURE:ua},mr={FORM:"Formulaire",SIGNATURE:"Signature"},gr=({isOpen:t,onClose:s,prospectId:a,projectType:r,moduleId:g,moduleName:u,moduleConfig:h,context:p={},availableForms:S=[],availableTemplates:A=[]})=>{var L,ie;const[y,f]=i.useState(null),[O,x]=i.useState(!1),[$,T]=i.useState(null),[b,R]=i.useState(!1),C=pa(),v=i.useMemo(()=>h?h.actions&&h.actions.length>0?h.actions:h.actionConfig?[{order:1,status:"pending",actionConfig:h.actionConfig}]:[]:[],[h]),[o,c]=i.useState({}),[D,B]=i.useState(!1);i.useEffect(()=>{if(!t||!a||!g||v.length<=1){c({});return}(async()=>{B(!0);try{const q=v.map((G,Y)=>`v2-${g}-action-${Y}`),{data:N,error:H}=await je.from("client_form_panels").select("id, action_id, status").eq("prospect_id",a).eq("project_type",r).in("action_id",q),U={};if(!H&&N&&N.length>0){for(const G of N)G.action_id&&(G.status==="approved"||G.status==="submitted")&&(U[G.action_id]=G.status);console.log("[V2 Robot] Action statuses by action_id:",U)}else{const{data:G}=await je.from("client_form_panels").select("id, step_name, status").eq("prospect_id",a).eq("project_type",r).in("status",["approved","submitted"]);if(G){const Y=G.filter(ae=>!ae.step_name||ae.step_name===u||ae.step_name===g);Y.forEach((ae,ge)=>{ge<v.length&&(U[`v2-${g}-action-${ge}`]=ae.status)}),console.log("[V2 Robot] Fallback legacy statuses:",U,"from",Y.length,"panels")}}c(U)}catch(q){console.error("[V2 Robot] Error fetching action statuses:",q)}finally{B(!1)}})()},[t,a,r,u,g,v.length]);const I=i.useMemo(()=>v.map((k,q)=>{const N=`v2-${g}-action-${q}`,H=o[N];return{...k,actionId:N,realStatus:H==="approved"?"validated":H==="submitted"?"submitted":"pending"}}),[v,o,g]),[M,re]=i.useState(0);i.useEffect(()=>{if(t&&I.length>0&&!D){const k=I.findIndex(q=>q.realStatus!=="validated");re(k>=0?k:I.length-1)}},[t,I,D]);const ce=I[M]||null,be=I.length,ye=be>1,z=i.useMemo(()=>{if(!ce)return!1;const k=ce.actionConfig;return!(!k||!k.actionType||!(Array.isArray(k.targetAudience)?k.targetAudience.length>0:!!k.targetAudience))},[ce]),Q=(ce==null?void 0:ce.actionConfig)||null,_=()=>{if(!z||!Q){W({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:Q.allowedFormIds,currentActionFull:ce,allActions:I.map((k,q)=>{var N;return{index:q,formIds:(N=k.actionConfig)==null?void 0:N.allowedFormIds}})});try{const k=Array.isArray(Q.targetAudience)?Q.targetAudience[0]:Q.targetAudience,q=ma({moduleId:g,moduleName:u,projectType:r,prospectId:a,actionIndex:M,actionConfig:{...Q,targetAudience:k||"CLIENT"},message:""});f(q),T(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",q)}catch(k){console.error("[V2 Robot] Erreur g√©n√©ration:",k),W({title:"Erreur",description:k.message,variant:"destructive"})}},X=async()=>{if(!y){W({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!C){W({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}x(!0),T(null);try{const k={...y,_meta:{...y._meta,isSimulation:!1}},q=await ga(k,p);T(q),q.success?(W({title:"‚úÖ Action ex√©cut√©e",description:q.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):W({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:q.message,variant:"destructive"})}catch(k){console.error("[V2 Robot] Erreur ex√©cution:",k),T({success:!1,status:"error",message:k.message}),W({title:"Erreur",description:k.message,variant:"destructive"})}finally{x(!1)}},de=()=>{y&&(navigator.clipboard.writeText(JSON.stringify(y,null,2)),W({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},ue=ht.useRef(M);i.useEffect(()=>{const k=ue.current!==M;if(ue.current=M,k&&(f(null),T(null)),t&&z&&!D&&(!y||k)){const q=setTimeout(()=>{_()},k?50:0);return()=>clearTimeout(q)}},[t,z,D,M]),i.useEffect(()=>{t||(f(null),T(null),R(!1),re(0))},[t]);const n=k=>{const q=S.find(N=>N.id===k);return(q==null?void 0:q.name)||k},F=k=>{const q=A.find(N=>N.id===k);return(q==null?void 0:q.name)||k};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(xs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[u||g,ye&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",M+1,"/",be]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ye,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[ye&&z&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",M+1," sur ",be]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," termin√©e",M>1?"s":"",")"]})]}),!z&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Bt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(fe,{variant:"outline",size:"sm",onClick:()=>{W({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Ts,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),z&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:ye?`Action ${M+1}/${be}`:"Action configur√©e"}),C&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(Q==null?void 0:Q.actionType)&&e.jsxs(e.Fragment,{children:[ht.createElement(ur[Q.actionType]||ze,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:mr[Q.actionType]||Q.actionType})]})}),(Q==null?void 0:Q.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(Q.targetAudience)?Q.targetAudience:[Q.targetAudience]).map(k=>{const q=cr[k]||ct;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(q,{className:"h-3.5 w-3.5"}),dr[k]||k]},k)})]}),((L=Q==null?void 0:Q.allowedFormIds)==null?void 0:L.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",Q.allowedFormIds.map(k=>n(k)).join(", ")]}),((ie=Q==null?void 0:Q.allowedTemplateIds)==null?void 0:ie.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",Q.allowedTemplateIds.map(k=>F(k)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(Q==null?void 0:Q.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(Q==null?void 0:Q.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),y&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>R(!b),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Rs,{className:Ue("h-4 w-4 transition-transform",b&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:k=>{k.stopPropagation(),de()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(Fs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),b&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(y,null,2)})]}),$&&e.jsxs("div",{className:Ue("rounded-lg p-4 flex items-start gap-3",$.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[$.success?e.jsx($s,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Bt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Ue("font-medium text-sm",$.success?"text-green-800":"text-red-800"),children:[$.status==="executed"&&"Ex√©cut√© avec succ√®s",$.status==="simulated"&&"Simulation uniquement",$.status==="blocked"&&"Ex√©cution bloqu√©e",$.status==="error"&&"Erreur"]}),e.jsx("p",{className:Ue("text-sm mt-1",$.success?"text-green-700":"text-red-700"),children:$.message})]})]})]})]}),z&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(fe,{variant:"outline",onClick:_,disabled:O,children:[e.jsx(gs,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(fe,{onClick:X,disabled:!y||O||!C,className:Ue(!C&&"opacity-50 cursor-not-allowed"),children:[O?e.jsx(Ms,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ja,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},qe="completed",Ee="in_progress",Ve="pending",it={[qe]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Ee]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[Ve]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Ut=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||Ve}))};if(t.status!==Ee)return s;if(!s.subSteps.some(r=>r.status===Ee)){const r=s.subSteps.findIndex(g=>g.status===Ve);r!==-1&&(s.subSteps=s.subSteps.map((g,u)=>({...g,status:u===r?Ee:g.status})))}return s},es=(t,s,a)=>{var A;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,g=r?`${s}:${r}`:null,u=g&&a?a[g]:null,h=(A=u==null?void 0:u.configJson)==null?void 0:A.actions;if(!h||h.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const y=t.subSteps.map((f,O)=>{var b,R;const x=h[O],T=((R=(b=x==null?void 0:x.config)==null?void 0:b.objective)==null?void 0:R.trim())||(x==null?void 0:x.title)||(x==null?void 0:x.label);return{...f,name:T||f.name||`Action ${O+1}`}});return{...t,subSteps:y}}const p=t.status||Ve,S=h.map((y,f)=>{var O;return{id:y.id||`v2-${r}-action-${f}`,name:((O=y.config)==null?void 0:O.objective)&&y.config.objective.trim()||y.title||y.label||`Action ${f+1}`,status:p===qe?qe:p===Ee&&f===0?Ee:Ve}});return{...t,subSteps:S,status:p}},xr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===qe),hr=({form:t,prospectId:s,onFormSubmit:a})=>{const[r,g]=i.useState({}),u=(p,S)=>{g(A=>({...A,[p]:S}))},h=()=>{a(s,t.id,r),W({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(p=>{if(p.show_if_conditions&&p.show_if_conditions.length>0){const A=p.condition_operator||"AND",y=p.show_if_conditions.map(O=>{const x=r[O.field];return O.equals==="has_value"?!!x&&x!=="":x===O.equals});if(!(A==="AND"?y.every(O=>O===!0):y.some(O=>O===!0)))return null}if(p.show_if){const A=p.show_if.field,y=p.show_if.equals,f=r[A];if(!f||f!==y)return null}return(t.fields||[]).some(A=>A.is_repeater&&(A.repeats_fields||[]).includes(p.id))?null:e.jsxs("div",{children:[e.jsx(Oe,{htmlFor:`${t.id}-${p.id}`,children:p.label}),e.jsx(Ge,{id:`${t.id}-${p.id}`,type:p.type,value:typeof r[p.id]=="object"?"":r[p.id]||"",onChange:A=>u(p.id,A.target.value),placeholder:p.placeholder||""}),p.is_repeater&&p.repeats_fields&&p.repeats_fields.length>0&&r[p.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[p.id])||0},(A,y)=>{const f=(t.fields||[]).filter(O=>p.repeats_fields.includes(O.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[p.label," #",y+1]}),f.map(O=>{const x=`${p.id}_repeat_${y}_${O.id}`,$=r[x];return e.jsxs("div",{children:[e.jsx(Oe,{htmlFor:`${t.id}-${x}`,children:O.label}),e.jsx(Ge,{id:`${t.id}-${x}`,type:O.type,value:typeof $=="object"?"":$||"",onChange:T=>u(x,T.target.value),placeholder:O.placeholder||""})]},x)})]},y)})})]},p.id)}),e.jsx(fe,{onClick:h,className:"w-full",children:"Soumettre"})]})},pr=({prospectId:t,projectType:s,currentStepIndex:a,activeAdminUser:r,initialChannel:g})=>{var Te,Pe;const{addChatMessage:u,prompts:h,projectsData:p,forms:S,updateProspect:A,prospects:y,completeStepAndProceed:f,registerClientForm:O}=He();mt();const{messages:x,loading:$}=bs(t,s),{uploadFile:T,uploading:b}=ys({projectType:s,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:R}=st({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),{user:C}=rt(),[v,o]=i.useState(""),[c,D]=i.useState(null),B=i.useRef(null),I=i.useRef(null),[M,re]=i.useState(!1),[ce,be]=i.useState(!1),[ye,z]=i.useState(g==="partner"?"partner":"client"),{organizationId:Q}=ut(),{templates:_,loading:X}=Ns(Q||(r==null?void 0:r.organization_id),s),{forms:de,loading:ue}=qs(Q||(r==null?void 0:r.organization_id)),{templates:n,loading:F}=Vs(Q||(r==null?void 0:r.organization_id)),L=(Pe=(Te=p[s])==null?void 0:Te.steps)==null?void 0:Pe[a],ie=i.useMemo(()=>L!=null&&L.name?L.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`,[L,a]),k=i.useMemo(()=>{if(!_||!ie)return null;const P=_[`${s}:${ie}`];return(P==null?void 0:P.configJson)||null},[_,ie,s]),q=i.useMemo(()=>de?Object.values(de).map(P=>({id:P.id,name:P.name||P.title||"Formulaire sans nom"})):[],[de]),N=i.useMemo(()=>n?Array.isArray(n)?n.map(P=>({id:P.id,name:P.name||"Template sans nom"})):Object.values(n).map(P=>({id:P.id,name:P.name||"Template sans nom"})):[],[n]),H=y.find(P=>P.id===t),U=i.useMemo(()=>Object.values(h).filter(P=>{var xe;if(P.projectId!==s)return!1;const me=(xe=P.stepsConfig)==null?void 0:xe[a];return me&&me.actions&&me.actions.length>0}),[h,s,a]),G=i.useCallback(async(P=null)=>{var Se;const me=U[0];if(!me){w.warn("Aucun prompt disponible");return}const xe=(Se=me.stepsConfig)==null?void 0:Se[a];if(!xe||!xe.actions){w.warn("Aucune action dans la config de l'√©tape");return}const Ne=[...xe.actions].sort((he,se)=>(he.order||0)-(se.order||0));if(P){const he=Ne.findIndex(se=>se.id===P);if(he!==-1&&he+1<Ne.length){const se=Ne[he+1];w.info("üéØ Action suivante trouv√©e",{completedActionId:P,nextActionId:se.id,nextActionType:se.type}),await Ce(me,se.id);return}else{w.warn("Pas d'action suivante",{completedActionId:P,totalActions:Ne.length});return}}await Ce(me)},[U,a]);er({prospectId:t,projectType:s,currentStepIndex:a,prompt:U[0],sendNextAction:G}),i.useEffect(()=>{requestAnimationFrame(()=>{var P;(P=B.current)==null||P.scrollIntoView({behavior:"smooth",block:"end"})})},[x,ye]);const Y=async()=>{if(!(!v.trim()&&!c))try{let P=null;if(c){if(c.size>10485760){W({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}w.debug("üì§ Uploading file from admin chat",{name:c.name,size:c.size,type:c.type});const{data:{user:Ne}}=await je.auth.getUser(),Se=await T({file:c,uploadedBy:Ne==null?void 0:Ne.id});Se&&(P={id:Se.id,name:Se.file_name,size:Se.file_size,type:Se.file_type,storagePath:Se.storage_path},w.debug("‚úÖ File uploaded successfully",P))}u(t,s,{sender:"pro",text:v,file:P,channel:ye}),o(""),D(null),requestAnimationFrame(()=>{var xe;(xe=B.current)==null||xe.scrollIntoView({behavior:"smooth",block:"end"})}),P&&W({title:"‚úÖ Fichier envoy√©",description:`${P.name} a √©t√© envoy√© avec succ√®s.`})}catch(P){w.error("‚ùå Error sending message with file",P),W({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${P.message}`,variant:"destructive"})}},ae=P=>{P.target.files&&P.target.files[0]&&D(P.target.files[0])},ge=async P=>{if(!P||!P.storagePath){W({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{w.debug("üì• Downloading file",{storagePath:P.storagePath});const{data:me,error:xe}=await je.storage.from("project-files").createSignedUrl(P.storagePath,3600);if(xe)throw xe;window.open(me.signedUrl,"_blank"),W({title:"‚úÖ T√©l√©chargement",description:`${P.name} s'ouvre dans un nouvel onglet.`})}catch(me){w.error("‚ùå Error downloading file",me),W({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${me.message}`,variant:"destructive"})}},le=(P,me,xe)=>{var oe;const Ne=y.find(l=>l.id===P);if(!Ne)return;const Se={...Ne.formData||{},...xe};A({...Ne,formData:Se});const he={sender:"client",text:`A compl√©t√© le formulaire : ${((oe=S[me])==null?void 0:oe.name)||"Formulaire"}.`};if(u(P,s,he),Object.values(h).find(l=>{var V,ee;if(l.projectId!==s)return!1;const E=(V=l.stepsConfig)==null?void 0:V[a];return E!=null&&E.autoCompleteStep?(ee=E.actions)==null?void 0:ee.some(pe=>pe.type==="show_form"&&pe.formId===me):!1})){const l=k==null?void 0:k.actions;if(l&&l.length>1){W({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}f(t,s,a),W({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},Ce=async(P,me=null)=>{var Ne,Se,he,se,oe,l,E,V;const xe=(Ne=P.stepsConfig)==null?void 0:Ne[a];if(xe&&xe.actions&&xe.actions.length>0){const ee=x,pe=[...xe.actions].sort((j,m)=>(j.order||0)-(m.order||0));let De=pe,d=!1;if(me){const j=pe.find(m=>m.id===me);if(!j){w.warn("Action sp√©cifique introuvable",{specificActionId:me});return}w.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:me,actionType:j.type}),De=[j],d=!0}for(const j of De)if(!(!d&&ee.some(J=>J.promptId===P.id&&J.stepIndex===a&&(J.text===j.message||J.formId===j.formId&&j.type==="show_form")))){if(j.message){const m={sender:"pro",text:j.message,promptId:P.id,stepIndex:a,actionId:j.id};u(t,s,m)}if(j.type==="show_form"&&j.formId){const m={sender:"pro",formId:j.formId,promptId:P.id,stepIndex:a,actionId:j.id};u(t,s,m);const J=((se=(he=(Se=p[s])==null?void 0:Se.steps)==null?void 0:he[a])==null?void 0:se.name)||"√âtape inconnue";try{const Z=await O({prospectId:t,projectType:s,formId:j.formId,currentStepIndex:a,promptId:P.id,messageTimestamp:Date.now(),status:"pending",stepName:J,actionId:j.id});if(!Z.success)w.error("‚ùå √âchec enregistrement formulaire:",Z.error),W({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const K=((oe=S[j.formId])==null?void 0:oe.name)||j.formId;await R({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${K} a √©t√© envoy√© √† ${(H==null?void 0:H.name)||"le client"}.`,createdBy:(C==null?void 0:C.user_id)||null,createdByName:(C==null?void 0:C.name)||"Admin"})}catch(K){w.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",K)}}catch(Z){w.error("‚ùå Exception enregistrement formulaire:",Z),W({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(j.type==="start_signature"&&j.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");w.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:j.templateId,prospectId:t,projectType:s,organizationId:r.organization_id,formId:j.formId});const{data:m,error:J}=await je.from("prospects").select("form_data").eq("id",t).single(),Z=((E=(l=m==null?void 0:m.form_data)==null?void 0:l[s])==null?void 0:E[j.formId])||{};w.info("üìã Donn√©es formulaire extraites",{formId:j.formId,dataKeys:Object.keys(Z)}),W({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const K=await xa({templateId:j.templateId,projectType:s,prospectId:t,formData:Z,organizationId:r==null?void 0:r.organization_id});if(K.success){const te=K.fileData.id;w.debug("Cr√©ation proc√©dure de signature...",{fileId:te,prospectId:t,projectType:s});const{data:ne}=await je.from("signature_procedures").select("*").eq("file_id",te).eq("prospect_id",t).eq("status","pending").maybeSingle();let we=ne;if(!we){const We=crypto.randomUUID(),Ze=new Date;Ze.setDate(Ze.getDate()+7);const $e=[{role:"principal",name:(H==null?void 0:H.name)||"Client",email:H==null?void 0:H.email,phone:(H==null?void 0:H.phone)||null,access_token:We,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const Ae=typeof(H==null?void 0:H.name)=="string"&&H.name.trim()!==""?H.name:((V=H==null?void 0:H.email)==null?void 0:V.split("@")[0])||"Client",_t=H==null?void 0:H.email,{data:nt,error:Me}=await je.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:te,access_token:We,access_token_expires_at:Ze.toISOString(),status:"pending",signers:$e,organization_id:r.organization_id,signer_name:Ae,signer_email:_t}).select().single();if(Me)throw w.error("Erreur cr√©ation signature_procedures",Me),Me;we=nt,w.debug("Proc√©dure de signature cr√©√©e",{procedureId:we.id,signersCount:$e.length})}const _e=`https://evatime.fr/signature/${we.id}?token=${we.access_token}`,{data:Je}=await je.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${we.id}%`).maybeSingle();Je||(await je.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${_e}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id,channel:"client"}),w.debug("Lien de signature envoy√© dans le chat")),W({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await R({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(H==null?void 0:H.name)||"le client"}.`,createdBy:(C==null?void 0:C.user_id)||null,createdByName:(C==null?void 0:C.name)||"Admin"})}catch(We){w.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",We)}}else throw new Error(K.error||"Erreur inconnue")}catch(m){w.error("‚ùå Exception g√©n√©ration contrat:",m),W({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${m.message}`,variant:"destructive"})}break}}re(!1)},ve=x.filter(P=>!P.channel||P.channel==="client"),Ie=x.filter(P=>P.channel==="partner"),ke=ye==="partner"?Ie:ve;return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex mb-3 rounded-xl overflow-hidden border-2 border-gray-200",children:[e.jsxs("button",{onClick:()=>z("client"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${ye==="client"?"bg-blue-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üí¨ Client",ve.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${ye==="client"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ve.length})]}),e.jsxs("button",{onClick:()=>z("partner"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${ye==="partner"?"bg-orange-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üü† Partenaire",Ie.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${ye==="partner"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:Ie.length})]})]}),e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[ke.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400 text-sm",children:ye==="partner"?"üü† Aucun message partenaire":"üí¨ Aucun message client"}),ke.map((P,me)=>{const xe=P.sender==="pro"||P.sender==="admin",Ne=P.sender==="partner",Se=P.sender==="client";return e.jsxs("div",{className:`flex items-end gap-2 ${xe?"justify-end":"justify-start"}`,children:[Se&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(H==null?void 0:H.name.charAt(0))||"?"}),Ne&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center font-bold text-white text-xs",children:"P"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${xe?"bg-blue-500 text-white rounded-br-none p-2.5":Ne?"bg-orange-100 text-orange-900 rounded-bl-none p-3 border border-orange-200":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[Ne&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-600 mb-1",children:"üü† Partenaire"}),P.channel==="partner"&&xe&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-300 mb-1",children:"‚Üí Partenaire"}),P.text&&(xe&&P.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:P.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:P.text})),P.file&&e.jsxs("button",{onClick:()=>ge(P.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(ze,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:P.file.name}),e.jsx(pt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),P.formId&&S[P.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(hr,{form:S[P.formId],prospectId:t,onFormSubmit:le})}),e.jsx("p",{className:`text-xs mt-1 ${xe?"text-blue-200":Ne?"text-orange-400":"text-gray-500"}`,children:Bs(new Date(P.timestamp),{addSuffix:!0,locale:Be})})]}),xe&&!P.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},me)}),e.jsx("div",{ref:B})]}),c&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Ht,{className:"w-4 h-4"}),e.jsx("span",{children:c.name}),e.jsx("button",{onClick:()=>D(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ge,{placeholder:ye==="partner"?"üü† √âcrire au partenaire...":"üí¨ √âcrire au client...",className:`pr-28 h-12 ${ye==="partner"?"border-orange-300 focus:ring-orange-400":""}`,value:v,onChange:P=>o(P.target.value),onKeyPress:P=>P.key==="Enter"&&Y()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(fe,{variant:"ghost",size:"icon",onClick:()=>be(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(xs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(fe,{variant:"ghost",size:"icon",onClick:()=>I.current.click(),disabled:b,children:e.jsx(Ht,{className:`h-5 w-5 ${b?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:I,onChange:ae,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:b}),e.jsx(fe,{onClick:Y,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:b,children:b?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Hs,{className:"h-4 w-4"})})]})]}),e.jsx(gr,{isOpen:ce,onClose:()=>be(!1),prospectId:t,projectType:s,moduleId:ie,moduleName:(L==null?void 0:L.name)||`√âtape ${a+1}`,moduleConfig:k,context:{organizationId:Q||(r==null?void 0:r.organization_id),adminUser:r},availableForms:q,availableTemplates:N})]})},fr=({steps:t,onUpdateStatus:s,prompts:a,projectType:r,currentStepIndex:g,prospectId:u,completeStepAndProceed:h})=>{var b;if(!t)return null;const[p,S]=i.useState({}),{activeAdminUser:A,appointments:y,updateAppointment:f}=He(),O=a?Object.values(a).find(R=>R.projectId===r):null,x=(b=O==null?void 0:O.stepsConfig)==null?void 0:b[g],$=i.useMemo(()=>{if(!t[g])return[];const R=t[g].name,C=y.filter(v=>v.type==="task"&&v.contactId===u&&v.projectId===r&&v.step===R);return C.length>0&&w.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:u,projectType:r,stepName:R,totalAppointments:y.length,filteredTasks:C.length,tasks:C.map(v=>({id:v.id,title:v.title,contactId:v.contactId,projectId:v.projectId,step:v.step}))}),C},[y,u,r,g,t]),T=(R,C)=>{S(v=>{var I;const o=v[R]||{},c={...o,[C]:!o[C]},D={...v,[R]:c},B=(I=x==null?void 0:x.actions)==null?void 0:I.find(M=>M.id===R);return B&&B.checklist&&B.checklist.every(re=>c[re.id])&&x!=null&&x.autoCompleteStep&&(W({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),h(u,r,g,t)),D})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((R,C)=>{const v=it[R.status]||it[Ve];return e.jsxs(Ke.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:C*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${v.iconOnly}`,children:R.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${v.text}`,children:R.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[R.subSteps&&R.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[R.subSteps.filter(o=>o.status===qe).length,"/",R.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(fe,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${v.badge} hover:opacity-90`,onClick:o=>{var I;o.stopPropagation();const c=o.currentTarget,D=c.nextElementSibling,B=c.closest("[data-step-status-container]");!D||!B||((I=B.parentElement)==null||I.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==D&&M.classList.add("hidden")}),D.classList.toggle("hidden"))},children:v.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:o=>{var c;o.stopPropagation(),o.preventDefault(),s(C,Ee),(c=o.currentTarget.parentElement)==null||c.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:o=>{var c;o.stopPropagation(),o.preventDefault(),s(C,qe),(c=o.currentTarget.parentElement)==null||c.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:o=>{var c;o.stopPropagation(),o.preventDefault(),s(C,Ve),(c=o.currentTarget.parentElement)==null||c.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),R.subSteps&&R.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:R.subSteps.map((o,c)=>{const D=it[o.status]||it[Ve];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${o.status===qe?"bg-green-500":o.status===Ee?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:o.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${D.badge}`,children:D.label})]},o.id||c)})}),R.status===Ee&&C===g&&(x==null?void 0:x.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:x.actions.filter(o=>o.hasClientAction===!1&&o.checklist&&o.checklist.length>0).map(o=>{const c=p[o.id]||{},D=o.checklist.length,B=o.checklist.filter(M=>c[M.id]).length,I=B===D;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${I?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[B,"/",D]})]}),e.jsx("div",{className:"space-y-2",children:o.checklist.map(M=>{const re=c[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:re,onChange:()=>T(o.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${re?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(x==null?void 0:x.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},o.id)})}),R.status===Ee&&C===g&&$.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:$.map(o=>{const c=o.status==="effectue",D=o.startTime?new Date(o.startTime):null,B=D&&!isNaN(D.getTime()),I=async()=>{const M=c?"pending":"effectue";await f(o.id,{status:M}),W({title:c?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:c?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:c?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:I,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${c?"line-through text-gray-500":""} truncate flex-1`,children:o.title||"T√¢che"}),c&&e.jsx(gt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),B&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Qe(D,"dd/MM/yyyy √† HH:mm",{locale:Be})]})]})]},o.id)})})]})]},C)})})]})},br=({prospect:t,projectType:s,supabaseSteps:a,v2Templates:r,onUpdate:g})=>{var ue;const{forms:u,prompts:h,completeStepAndProceed:p,activeAdminUser:S,appointments:A,updateAppointment:y}=He(),{formPanels:f=[],loading:O,updateFormPanel:x}=Ws(t.id),{sendMessage:$}=bs(t.id,s),[T,b]=i.useState(null),[R,C]=i.useState({}),[v,o]=i.useState(!1),[c,D]=i.useState(null),[B,I]=i.useState(""),[M,re]=i.useState(new Set),ce=i.useMemo(()=>{if(!f)return[];const n=f.filter(F=>F.prospectId===t.id&&F.projectType===s).sort((F,L)=>(L.createdAt||0)-(F.createdAt||0));return w.debug("[ProspectForms] Filtering panels",{totalPanels:f.length,prospectId:t.id,projectType:s,filteredCount:n.length,samplePanel:f[0]}),n},[f,t.id,s]);if(i.useEffect(()=>{!ce||ce.length===0||ce.forEach(n=>{var L,ie,k,q;if(M.has(n.panelId)||n.status!=="submitted")return;if(n.lastSubmittedAt){const N=new Date(n.lastSubmittedAt).getTime(),U=Date.now()-N;if(U>1e4){w.debug("Form too old, skipping auto-complete",{panelId:n.panelId,ageSeconds:Math.floor(U/1e3)}),re(G=>new Set([...G,n.panelId]));return}}w.debug("New submitted form detected",{panelId:n.panelId,formId:n.formId,projectType:n.projectType}),w.debug("Available prompts",{count:Object.keys(h).length});let F=null;if(n.promptId&&(w.debug("Searching by promptId",{promptId:n.promptId}),F=h[n.promptId]),F||(F=Object.values(h).find(N=>{var G,Y;if(w.debug("Testing prompt",{name:N.name,projectId:N.projectId,target:n.projectType}),N.projectId!==n.projectType)return!1;const H=(G=N.stepsConfig)==null?void 0:G[n.currentStepIndex];return(Y=H==null?void 0:H.actions)==null?void 0:Y.some(ae=>ae.type==="show_form"&&ae.formId===n.formId)})),w.debug("Prompt found",{name:F==null?void 0:F.name,autoComplete:(ie=(L=F==null?void 0:F.stepsConfig)==null?void 0:L[n.currentStepIndex])==null?void 0:ie.autoCompleteStep}),F){const N=(k=F.stepsConfig)==null?void 0:k[n.currentStepIndex],H=(q=N==null?void 0:N.actions)==null?void 0:q.find(G=>G.type==="show_form"&&G.formId===n.formId),U=(H==null?void 0:H.verificationMode)||"human";w.debug("Checking auto-complete conditions",{autoCompleteStep:N==null?void 0:N.autoCompleteStep,verificationMode:U}),N!=null&&N.autoCompleteStep&&U==="none"&&(w.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),p(t.id,n.projectType,n.currentStepIndex),W({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}re(N=>new Set([...N,n.panelId]))})},[ce,h,p,t.id,t.name,M]),ce.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const be=n=>{b(n.panelId);const ie=((t.form_data||t.formData||{})[n.projectType]||{})[n.formId]||{};C({...ie,_meta:{projectType:n.projectType,formId:n.formId}})},ye=()=>{b(null),C({})},z=async()=>{const{_meta:n,...F}=R,{projectType:L,formId:ie}=n||{};if(!L||!ie){w.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const k=t.form_data||t.formData||{},q={...k,[L]:{...k[L]||{},[ie]:F}},{error:N}=await je.from("prospects").update({form_data:q}).eq("id",t.id);if(N){w.error("‚ùå Erreur sauvegarde formulaire:",N),W({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}W({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),g&&g({...t,form_data:q,formData:q}),b(null),C({})},Q=(n,F)=>{C(L=>({...L,[n]:F}))},_=n=>{var ie,k;const F=Object.values(h).find(q=>q.id===n.promptId||q.projectId===n.projectType),L=(ie=F==null?void 0:F.stepsConfig)==null?void 0:ie[n.currentStepIndex];return(k=L==null?void 0:L.actions)==null?void 0:k.find(q=>q.formId===n.formId)},X=async n=>{var F,L,ie,k,q,N;try{await x(n.panelId,{status:"approved"});const H=_(n),U=(H==null?void 0:H.verificationMode)||"human";if(w.debug("üîç Checking verification mode",{verificationMode:U,shouldSearchTask:U==="human"}),U==="human"){w.debug("üîç Searching for related task",{totalAppointments:(A==null?void 0:A.length)||0,prospectId:t.id,projectType:n.projectType,stepName:n.stepName,panel:n});const he=(A==null?void 0:A.filter(l=>l.type==="task"))||[],se=he.filter(l=>l.contactId===t.id);w.debug("üîç Task filtering debug",{allTasks:he.length,prospectTasks:se.length,prospectTasksData:se.map(l=>({id:l.id,title:l.title,contactId:l.contactId,projectId:l.projectId,step:l.step,status:l.status}))}),w.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:n.projectType,step:n.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let oe=A==null?void 0:A.find(l=>{var ee;const E={isTask:l.type==="task",contactMatch:l.contactId===t.id,projectMatch:l.projectId===n.projectType,stepMatch:l.step===n.stepName,isPending:l.status==="pending",titleMatch:(ee=l.title)==null?void 0:ee.includes("V√©rifier le formulaire")},V=Object.values(E).every(pe=>pe);return!V&&l.type==="task"&&l.contactId===t.id&&w.warn("üîç Task failed matching:",{taskId:l.id,title:l.title,checks:E,COMPARISON:{taskStep:`"${l.step}"`,panelStep:`"${n.stepName}"`,areEqual:l.step===n.stepName,taskStepType:typeof l.step,panelStepType:typeof n.stepName},taskData:{contactId:l.contactId,projectId:l.projectId,step:l.step,status:l.status},panelData:{projectType:n.projectType,stepName:n.stepName}}),V});oe||(w.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:n.stepName}),oe=A==null?void 0:A.find(l=>{var E;return l.type==="task"&&l.contactId===t.id&&l.projectId===n.projectType&&l.status==="pending"&&((E=l.title)==null?void 0:E.includes("V√©rifier le formulaire"))}),oe&&w.info("‚úÖ Found task via fallback (without step match)",{taskId:oe.id,taskStep:oe.step})),oe?(w.info("‚úÖ Found verification task, marking as completed",{taskId:oe.id,prospectId:t.id,title:oe.title}),await y(oe.id,{status:"effectue"}),W({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):w.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:n.projectType,step:n.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else w.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:U});const G=a==null?void 0:a[n.projectType],Y=G==null?void 0:G.findIndex(he=>he.status==="in_progress"),ae=Y!=null&&Y>=0?Y:n.currentStepIndex||0,ge=(F=G==null?void 0:G[ae])==null?void 0:F.name,le=ge?ge.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,Ce=`${n.projectType}:${le}`,ve=le&&r?r[Ce]:null,Ie=(L=ve==null?void 0:ve.configJson)==null?void 0:L.actionConfig;w.debug("[V2] Template lookup",{panelProjectType:n.projectType,propProjectType:s,currentStepName:ge,moduleId:le,templateKey:Ce,v2TemplatesKeys:r?Object.keys(r):[],templateFound:!!ve});const ke=ge?ps(ge):null,Te=(Ie==null?void 0:Ie.completionTrigger)||(ke==null?void 0:ke.completionTrigger),Pe=(ie=ve==null?void 0:ve.configJson)==null?void 0:ie.actions,P=Pe&&Pe.length>1;let me=!0;if(P){const he=Pe.map((V,ee)=>`v2-${le}-action-${ee}`),{data:se}=await je.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",n.projectType).eq("status","approved");let oe=new Set;(se||[]).forEach(V=>{V.action_id&&he.includes(V.action_id)&&oe.add(V.action_id)});const l=(se||[]).filter(V=>!V.action_id&&(!V.step_name||V.step_name===ge||V.step_name===le));if(l.length>0){const V=he.filter(ee=>!oe.has(ee));l.forEach((ee,pe)=>{pe<V.length&&oe.add(V[pe])}),w.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:l.length,uncoveredIds:V,afterAssignment:[...oe]})}const E=oe.size;me=E>=Pe.length,w.debug("[V2] Multi-actions check",{totalActions:Pe.length,expectedActionIds:he,approvedActionIds:[...oe],panelsTotal:(se||[]).length,panelsWithActionId:(se||[]).filter(V=>V.action_id).length,panelsWithoutActionId:l.length,allCompleted:me}),me||(w.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:Pe.length-E}),W({title:"‚úÖ Action valid√©e",description:`Action ${E}/${Pe.length} ‚Äî il reste ${Pe.length-E} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}w.debug("[V2] Checking completionTrigger for form approval",{stepName:ge,moduleId:le,v2TemplateFound:!!ve,completionTrigger:Te,currentStepIdx:ae,hasMultiActions:P,allActionsCompleted:me});const xe=(Te==="form_approved"||!Te)&&me;let Ne=G;if(G&&((q=(k=G[ae])==null?void 0:k.subSteps)==null?void 0:q.length)>0){const he=G[ae];let se=-1;if(n.action_id&&(se=he.subSteps.findIndex(oe=>oe.id===n.action_id)),se===-1&&(se=he.subSteps.findIndex(oe=>oe.status===Ee),w.debug("[V2] Substep fallback: using first in_progress",{panelActionId:n.action_id,fallbackIndex:se})),se!==-1){w.debug("[V2] Updating substep for approved action",{actionId:n.action_id,subStepIndex:se,subStepName:he.subSteps[se].name,allActionsCompleted:me});const oe=JSON.parse(JSON.stringify(G));if(oe[ae].subSteps.forEach((l,E)=>{l.status===Ee&&E!==se&&(l.status=qe)}),oe[ae].subSteps[se].status=qe,!me){let l=-1;for(let E=se+1;E<oe[ae].subSteps.length;E++)if(oe[ae].subSteps[E].status===Ve){l=E;break}l!==-1&&(oe[ae].subSteps[l].status=Ee,w.debug("[V2] Activated next substep",{completedIndex:se,nextIndex:l,nextName:oe[ae].subSteps[l].name}))}await updateSupabaseSteps(n.projectType,oe),Ne=oe,w.info("[V2] Substep updated successfully",{completedSubStep:se,nextActivated:!me})}}if(xe&&Ne)w.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:n.projectType,currentStepIdx:ae,stepName:ge,trigger:Te||"default_behavior"}),await p(t.id,n.projectType,ae,Ne),W({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const he=Object.values(h).find(se=>se.id===n.promptId||se.projectId===n.projectType);if(he){const se=(N=he.stepsConfig)==null?void 0:N[n.currentStepIndex];se!=null&&se.autoCompleteStep&&(w.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:n.projectType,stepIndex:n.currentStepIndex}),G?await p(t.id,n.projectType,n.currentStepIndex,G):w.error("No steps found in supabaseSteps for projectType",{projectType:n.projectType}))}}const Se=n.filledByRole==="partner";if(Se)w.debug("Formulaire partenaire valid√© ‚Äî pas de message chat au client");else{const he=(H==null?void 0:H.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:se}=await je.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",n.projectType).eq("sender","admin").eq("text",he).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!se||se.length===0?await $({sender:"admin",text:he,relatedMessageTimestamp:new Date().toISOString()}):w.debug("Message de validation d√©j√† envoy√© r√©cemment, skip")}W({title:"‚úÖ Formulaire valid√©",description:Se?"Le formulaire partenaire a √©t√© valid√©.":"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(H){w.error("‚ùå Erreur validation formulaire:",H),W({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},de=async(n="")=>{if(c)try{const F=c,L=F.filledByRole==="partner";await x(F.panelId,{status:"rejected",rejectionReason:L?n:null});const ie=_(F),k=(ie==null?void 0:ie.verificationMode)||"human";if(w.debug("üîç Checking verification mode (reject)",{verificationMode:k,shouldSearchTask:k==="human",isPartnerForm:L}),k==="human"){w.debug("üîç Searching for related task (reject)",{totalAppointments:(A==null?void 0:A.length)||0,prospectId:t.id,projectType:F.projectType,stepName:F.stepName}),w.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:F.projectType,step:F.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let q=A==null?void 0:A.find(N=>{var G;const H={isTask:N.type==="task",contactMatch:N.contactId===t.id,projectMatch:N.projectId===F.projectType,stepMatch:N.step===F.stepName,isPending:N.status==="pending",titleMatch:(G=N.title)==null?void 0:G.includes("V√©rifier le formulaire")},U=Object.values(H).every(Y=>Y);return!U&&N.type==="task"&&N.contactId===t.id&&w.warn("üîç Task failed matching (REJECT):",{taskId:N.id,title:N.title,checks:H,COMPARISON:{taskStep:`"${N.step}"`,panelStep:`"${F.stepName}"`,areEqual:N.step===F.stepName,taskStepType:typeof N.step,panelStepType:typeof F.stepName},taskData:{contactId:N.contactId,projectId:N.projectId,step:N.step,status:N.status},panelData:{projectType:F.projectType,stepName:F.stepName}}),U});q||(w.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:F.stepName}),q=A==null?void 0:A.find(N=>{var H;return N.type==="task"&&N.contactId===t.id&&N.projectId===F.projectType&&N.status==="pending"&&((H=N.title)==null?void 0:H.includes("V√©rifier le formulaire"))}),q&&w.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:q.id,taskStep:q.step})),q&&(w.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:q.id,prospectId:t.id,title:q.title}),await y(q.id,{status:"effectue"}))}else w.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:k});if(L)W({title:"‚ùå Formulaire rejet√©",description:"Le partenaire verra la raison du refus sur sa mission.",className:"bg-red-500 text-white"});else{const N=`${(ie==null?void 0:ie.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${n}`;await $({sender:"admin",text:N,relatedMessageTimestamp:new Date().toISOString()}),W({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"})}o(!1),D(null),I("")}catch(F){w.error("‚ùå Erreur rejet formulaire:",F),W({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ce.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:ce.map(n=>{var k,q;const F=u[n.formId];let L={};if(n.filledByRole==="partner"&&n.formData?L=n.formData:L=((t.form_data||t.formData||{})[n.projectType]||{})[n.formId]||{},!F)return null;const ie=n.stepName||((q=(k=a==null?void 0:a[n.projectType])==null?void 0:k[n.currentStepIndex])==null?void 0:q.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:F.name}),ie&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",ie]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${n.status==="submitted"?"bg-green-100 text-green-700":n.status==="approved"?"bg-blue-100 text-blue-700":n.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:n.status==="submitted"?"Envoy√©":n.status==="approved"?"Approuv√©":n.status==="rejected"?"Rejet√©":"En attente"})]}),n.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["‚úÖ ",n.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(fe,{size:"sm",onClick:()=>X(n),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(gt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(fe,{size:"sm",variant:"outline",onClick:()=>{D(n),o(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),n.status==="rejected"&&n.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:n.rejectionReason.startsWith("Mission impossible")?"‚õî Mission d√©clar√©e impossible par le partenaire":"‚ùå Formulaire rejet√©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:n.rejectionReason.startsWith("Mission impossible ‚Äî ")?n.rejectionReason.replace("Mission impossible ‚Äî ",""):n.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(F.fields||[]).map(N=>{if(N.show_if_conditions&&N.show_if_conditions.length>0){const Y=N.condition_operator||"AND",ae=N.show_if_conditions.map(le=>{const Ce=L[le.field];return le.equals==="has_value"?!!Ce&&Ce!=="":Ce===le.equals});if(!(Y==="AND"?ae.every(le=>le===!0):ae.some(le=>le===!0)))return null}if(N.show_if){const Y=N.show_if.field,ae=N.show_if.equals,ge=L[Y];if(!ge||ge!==ae)return null}if((F.fields||[]).some(Y=>Y.is_repeater&&(Y.repeats_fields||[]).includes(N.id)))return null;const U=L[N.id],G=N.type==="file"&&typeof U=="object"&&(U==null?void 0:U.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Oe,{className:"text-sm font-medium text-gray-600",children:N.label}),T===n.panelId?G?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(ze,{className:"inline h-4 w-4 mr-2"}),U.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):N.type==="select"?e.jsxs("select",{value:R[N.id]||"",onChange:Y=>Q(N.id,Y.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(N.options||[]).map((Y,ae)=>e.jsx("option",{value:Y,children:Y},ae))]}):e.jsx(Ge,{type:N.type||"text",value:R[N.id]||"",onChange:Y=>Q(N.id,Y.target.value),placeholder:N.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:G?e.jsxs("button",{onClick:async()=>{try{const{data:Y,error:ae}=await je.storage.from("project-files").createSignedUrl(U.storagePath,3600);if(ae)throw ae;window.open(Y.signedUrl,"_blank")}catch{W({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx("span",{children:U.name}),e.jsx(pt,{className:"h-3 w-3"})]}):U||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),N.is_repeater&&N.repeats_fields&&N.repeats_fields.length>0&&U&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(U)||0},(Y,ae)=>{const ge=(F.fields||[]).filter(le=>N.repeats_fields.includes(le.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[N.label," #",ae+1]}),ge.map(le=>{const Ce=`${N.id}_repeat_${ae}_${le.id}`,ve=L[Ce],Ie=le.type==="file"&&typeof ve=="object"&&(ve==null?void 0:ve.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Oe,{className:"text-xs font-medium text-gray-600",children:le.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:Ie?e.jsxs("button",{onClick:async()=>{try{const{data:ke,error:Te}=await je.storage.from("project-files").createSignedUrl(ve.storagePath,3600);if(Te)throw Te;window.open(ke.signedUrl,"_blank")}catch{W({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(ze,{className:"h-3 w-3"}),e.jsx("span",{children:ve.name}),e.jsx(pt,{className:"h-3 w-3"})]}):ve||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},Ce)})]},ae)})})]},N.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T===n.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(fe,{variant:"outline",size:"sm",onClick:ye,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(fe,{size:"sm",onClick:z,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(qt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(fe,{variant:"outline",size:"sm",onClick:()=>be(n),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},n.panelId)})}),e.jsx(bt,{open:v,onOpenChange:o,children:e.jsxs(jt,{className:"max-w-lg",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Rejeter le formulaire"}),e.jsx(fs,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((ue=_(c))==null?void 0:ue.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{children:"Raison du refus"}),e.jsx("textarea",{value:B,onChange:n=>I(n.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Ot,{children:[e.jsx(fe,{variant:"outline",onClick:()=>{o(!1),D(null),I("")},children:"Annuler"}),e.jsx(fe,{onClick:()=>de(B),disabled:!B.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},jr=({prospect:t,projectType:s,onUpdate:a})=>{const{forms:r}=He(),[g,u]=i.useState(null),[h,p]=i.useState({}),S=i.useMemo(()=>Object.values(r).filter(x=>x.audience==="internal"&&(x.projectIds||[]).includes(s)),[r,s]);i.useEffect(()=>{if(t&&t.form_data){const x=t.form_data[s]||{};p(x)}},[t,s]);const A=x=>{u(x)},y=()=>{if(u(null),t&&t.form_data){const x=t.form_data[s]||{};p(x)}},f=(x,$,T)=>{p(b=>({...b,[x]:{...b[x]||{},[$]:T}}))},O=async()=>{try{const x={...t.form_data||{},[s]:h},$={...t,form_data:x,formData:x};await a($),W({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),u(null)}catch(x){w.error("Erreur sauvegarde formulaire interne:",x),W({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[S.length," formulaire(s)"]})]}),S.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:S.map(x=>{const $=h[x.id]||{},T=g===x.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:x.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(x.fields||[]).map(b=>{if(b.show_if_conditions&&b.show_if_conditions.length>0){const v=b.condition_operator||"AND",o=b.show_if_conditions.map(D=>{const B=$[D.field];return D.equals==="has_value"?!!B&&B!=="":B===D.equals});if(!(v==="AND"?o.every(D=>D===!0):o.some(D=>D===!0)))return null}if(b.show_if){const v=b.show_if.field,o=b.show_if.equals,c=$[v];if(!c||c!==o)return null}if((x.fields||[]).some(v=>v.is_repeater&&(v.repeats_fields||[]).includes(b.id)))return null;const C=$[b.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Oe,{className:"text-sm font-medium text-gray-600",children:[b.label,b.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),T?b.type==="textarea"?e.jsx("textarea",{value:C,onChange:v=>f(x.id,b.id,v.target.value),placeholder:b.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):b.type==="select"?e.jsxs("select",{value:C,onChange:v=>f(x.id,b.id,v.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(b.options||[]).map((v,o)=>e.jsx("option",{value:v,children:v},o))]}):e.jsx(Ge,{type:b.type||"text",value:C,onChange:v=>f(x.id,b.id,v.target.value),placeholder:b.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:C||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),b.is_repeater&&b.repeats_fields&&b.repeats_fields.length>0&&C&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(C)||0},(v,o)=>{const c=(x.fields||[]).filter(D=>b.repeats_fields.includes(D.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[b.label," #",o+1]}),c.map(D=>{const B=`${b.id}_repeat_${o}_${D.id}`,I=$[B]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Oe,{className:"text-xs font-medium text-gray-600",children:D.label}),T?D.type==="textarea"?e.jsx("textarea",{value:I,onChange:M=>f(x.id,B,M.target.value),placeholder:D.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):D.type==="select"?e.jsxs("select",{value:I,onChange:M=>f(x.id,B,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(D.options||[]).map((M,re)=>e.jsx("option",{value:M,children:M},re))]}):e.jsx(Ge,{type:D.type||"text",value:I,onChange:M=>f(x.id,B,M.target.value),placeholder:D.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:I||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},B)})]},o)})})]},b.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T?e.jsxs(e.Fragment,{children:[e.jsxs(fe,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(fe,{size:"sm",onClick:O,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(qt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(fe,{variant:"outline",size:"sm",onClick:()=>A(x.id),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},x.id)})})]})},yr=t=>{switch(t.type){case"email":return e.jsx(vt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(at,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Gs,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(wt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(Js,{className:"h-4 w-4 text-gray-400"})}},Nr=({prospect:t,onBack:s,onUpdate:a,onEditingChange:r})=>{var De;const{getProjectSteps:g,completeStepAndProceed:u,updateProjectSteps:h,markNotificationAsRead:p,projectsData:S,formContactConfig:A,currentUser:y,userProjects:f,setUserProjects:O,getProjectInfo:x,updateProjectInfo:$,activeAdminUser:T,prompts:b,notifications:R}=He(),{supabaseUserId:C}=rt(),{users:v,loading:o}=mt(),{projectStepsStatus:c,updateProjectSteps:D}=oa(t.id),{organizationId:B}=ut(),{templates:I}=Ns(B||(T==null?void 0:T.organization_id),null),[M,re]=hs(),ce=M.get("project")||t._selectedProjectType,be=M.get("notificationId"),ye=M.get("channel"),[z,Q]=i.useState(ce||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:_,addProjectEvent:X}=st({projectType:z||"",prospectId:t.id,enabled:!!z&&!!t.id,activeAdminUser:T}),[de,ue]=i.useState(!1),[n,F]=i.useState(t);i.useEffect(()=>{F(t)},[t]);const[L,ie]=i.useState(!1),k=i.useMemo(()=>z?x(t.id,z)||{}:{},[z,x,t.id]),[q,N]=i.useState((k==null?void 0:k.status)||"actif"),[H,U]=i.useState({}),G=k==null?void 0:k.amount,Y=i.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[ae,ge]=i.useState(""),[le,Ce]=i.useState(!1),ve=i.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...v.map(d=>({value:d.user_id,label:d.name}))],[v]),Ie=i.useMemo(()=>{var j;if(!z)return[];if(c[z])return c[z].map(m=>es(m,z,I)).map(Ut);const d=(j=S[z])==null?void 0:j.steps;if(d&&d.length>0){const m=JSON.parse(JSON.stringify(d));return m[0].status="in_progress",m.map(J=>es(J,z,I)).map(Ut)}return[]},[z,c,S,I]),ke=Ie.findIndex(d=>d.status===Ee),Te=Ie[ke]||Ie.find(d=>d.status===Ve)||Ie[0];i.useEffect(()=>{if(be){p(parseInt(be));const d=new URLSearchParams(M);d.delete("notificationId"),re(d,{replace:!0})}},[be,p,re,M]),i.useEffect(()=>{var j;const d=M.get("project");d&&d!==z&&((j=t.tags)!=null&&j.includes(d))&&Q(d)},[M,t.tags]),i.useEffect(()=>{if(!(t!=null&&t.id)||!z||!R||!p)return;const d=R.filter(j=>!j.read&&j.prospectId===t.id&&j.projectType===z);d.length>0&&d.forEach(j=>{p(j.id)})},[t==null?void 0:t.id,z,R,p]),i.useEffect(()=>{w.debug("Prospect prop changed",{name:t.name}),F(t)},[t]),i.useEffect(()=>{le||(G==null||G===""?ge(""):ge(G.toString()))},[G,le]),i.useEffect(()=>{(async()=>{var J;if(!z||!t.id)return;const{data:j,error:m}=await je.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",z).maybeSingle();m?(w.error("Erreur chargement project status:",m),N("actif")):(J=j==null?void 0:j.data)!=null&&J.status?N(j.data.status):N("actif")})()},[z,t.id]),i.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:j,error:m}=await je.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(j){const J={};j.forEach(Z=>{J[Z.project_type]=Z.status||"actif"}),U(J)}})()},[t.id,t.tags]),i.useEffect(()=>{r&&r(de)},[de,r]),i.useEffect(()=>{if(!t.id)return;const d=je.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async j=>{var _e;const{new:m,old:J}=j;if(m.status!=="signed"||(J==null?void 0:J.status)==="signed")return;const Z=m.project_type;w.info("[V2 Signature Listener] Signature completed",{procedureId:m.id,projectType:Z,prospectId:m.prospect_id});const K=c==null?void 0:c[Z];if(!K||K.length===0){w.warn("[V2 Signature Listener] No steps found for project type",{projectType:Z});return}const te=K.findIndex(Je=>Je.status==="in_progress");if(te===-1){w.warn("[V2 Signature Listener] No current step in_progress",{projectType:Z});return}const ne=(_e=K[te])==null?void 0:_e.name;if(!ne){w.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:te});return}const we=ps(ne);if((we==null?void 0:we.completionTrigger)!=="signature"){w.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:ne,completionTrigger:(we==null?void 0:we.completionTrigger)||"null"});return}w.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:Z,currentStepIdx:te,stepName:ne});try{await u(t.id,Z,te,K),W({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${ne}"`,className:"bg-green-500 text-white"})}catch(Je){w.error("[V2 Signature Listener] Error completing step",Je)}}).subscribe();return()=>{je.removeChannel(d)}},[t.id,c,u]);const Pe=d=>{Q(d),re(j=>(j.set("project",d),j),{replace:!0})},P=async d=>{if(!z||!t.id)return;const j=q;N(d);try{const{error:m}=await je.from("project_infos").upsert({prospect_id:t.id,project_type:z,status:d,data:(k==null?void 0:k.data)||{}},{onConflict:"prospect_id,project_type"});if(m)throw m;const J={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:Z}=await je.from("project_history").insert({prospect_id:t.id,project_type:z,event_type:"status",description:`Projet ${J[d]||d}`,organization_id:T==null?void 0:T.organization_id,metadata:{old_status:j,new_status:d}});Z&&w.error("Erreur historique:",Z),$(t.id,z,(K={})=>({...K,status:d})),U(K=>({...K,[z]:d})),W({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${J[d]}".`,className:"bg-green-500 text-white"})}catch(m){w.error("Erreur lors du changement de statut:",m),N(j),W({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},me=d=>{ge(d)},xe=d=>{if(!z)return;const j=d.replace(",",".").trim();if(j===""){$(t.id,z,(Z={})=>{if(!Z.amount)return Z;const K={...Z};return delete K.amount,K}),ge("");return}const m=parseFloat(j);if(Number.isNaN(m)||m<0){ge(G==null?"":G.toString());return}const J=Math.round(m*100)/100;$(t.id,z,(Z={})=>({...Z,amount:J})),ge(J.toFixed(2))},Ne=()=>{xe(ae),Ce(!1)},Se=d=>{d.key==="Enter"&&(d.preventDefault(),xe(d.currentTarget.value),d.currentTarget.blur(),Ce(!1))},he=async(d,j)=>{var J,Z;const m=Ie[d];if(j===qe&&((J=m==null?void 0:m.subSteps)==null?void 0:J.length)>0&&!xr(m)){W({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(j===Ee&&((Z=m==null?void 0:m.subSteps)==null?void 0:Z.length)>0){const K=JSON.parse(JSON.stringify(Ie)),te=K[d];te.status=Ee,te.subSteps=te.subSteps.map((ne,we)=>({...ne,status:we===0?Ee:Ve})),await D(z,K),_&&await _({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${te.name} ¬ª`,metadata:{step_id:(te==null?void 0:te.id)||null,step_name:(te==null?void 0:te.name)||null,previous_status:(m==null?void 0:m.status)||null,new_status:Ee,project_type:z},createdBy:C,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)});return}if(j===qe){const K=JSON.parse(JSON.stringify(Ie));K[d].status="completed";let te=d+1;if(te<K.length&&(K[te].status="in_progress"),await D(z,K),_){const ne=te<K.length?K[te]:null;await _({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:m&&ne?`√âtape ¬´ ${m.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${ne.name} ¬ª`:`√âtape ¬´ ${m.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(m==null?void 0:m.id)||null,previous_step_name:(m==null?void 0:m.name)||null,previous_step_status:(m==null?void 0:m.status)||null,new_step_id:(ne==null?void 0:ne.id)||null,new_step_name:(ne==null?void 0:ne.name)||null,new_step_status:"in_progress",project_type:z},createdBy:C,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}if(te<K.length&&K[te].globalStepId){const ne=K[te].globalStepId,we={...t,status:ne};a(we),W({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const K=Ie.map((ne,we)=>{let _e=ne.status;return we===d&&(_e=j),{...ne,status:_e}});if(await D(z,K),_){const ne=K[d];await _({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${ne.name} ¬ª pass√©e de ¬´ ${m.status==="pending"?"√Ä venir":m.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${j==="pending"?"√Ä venir":j==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(ne==null?void 0:ne.id)||null,step_name:(ne==null?void 0:ne.name)||null,previous_status:(m==null?void 0:m.status)||null,new_status:j,project_type:z},createdBy:C,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}const te=K[d];if(te.globalStepId&&j==="in_progress"){const ne={...t,status:te.globalStepId};a(ne)}}},se=async d=>{var m,J;const j=n.tags||[];if(!j.includes(d)){const Z={...n,tags:[...j,d]};if(F(Z),a(Z),Q(d),y&&t.id===y.id&&!f.includes(d)){const te=[...f,d];O(te)}const K=(m=S[d])==null?void 0:m.steps;if(K&&K.length>0)try{const te=JSON.parse(JSON.stringify(K));te[0].status="in_progress",await D(d,te),w.debug("Steps initialized in Supabase",{projectType:d})}catch(te){w.error("Steps initialization error:",te)}W({title:"‚úÖ Projet ajout√© !",description:`Le projet ${(J=S[d])==null?void 0:J.title} a √©t√© associ√© au prospect.`})}ie(!1)},oe=()=>{const d=n.tags||[];return Object.values(S).filter(j=>j.isPublic&&!d.includes(j.type))},l=async d=>{switch(d){case"Appel":n.phone&&(window.location.href=`tel:${n.phone}`);break;case"Mail":n.email&&(window.location.href=`mailto:${n.email}`);break;case"WhatsApp":if(n.phone){const j=n.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${j}`,"_blank")}else W({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const j=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${j}`:window.open(`https://www.google.com/maps/search/?api=1&query=${j}`,"_blank")}break;case"Invitation":if(!n.email){W({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const j=`${window.location.origin}/dashboard`,m=B||(T==null?void 0:T.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",n.email,"org:",m);const{error:J}=await je.auth.signInWithOtp({email:n.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:j,data:{organization_id:m}}});J?(console.error("[handleActionClick] ‚ùå Magic link error:",J),W({title:"‚ùå Erreur envoi invitation",description:J.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",n.email),W({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${n.email}`,className:"bg-green-500 text-white"}))}catch(j){console.error("[handleActionClick] üí• Exception:",j),W({title:"‚ùå Erreur",description:j.message,variant:"destructive"})}break;default:W({title:`Action: ${d}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},E=()=>{const d=window.scrollY;ue(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:d,behavior:"instant"})})})},V=()=>{try{a(n),ue(!1),W({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(d){w.error("‚ùå Erreur sauvegarde:",d),W({title:"‚ùå Erreur",description:d.message,variant:"destructive"})}},ee=(d,j)=>{F(m=>({...m,[d]:j}))},pe=d=>{let j=d;d==="unassigned"?j=null:d==="user-1"&&C&&(j=C),F(m=>({...m,ownerId:j}))};return S[z],i.useEffect(()=>{const d=document.createElement("style");return d.id="disable-auto-scroll",d.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(d),()=>{const j=document.getElementById("disable-auto-scroll");j&&j.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(fe,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Os,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:n.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(fe,{size:"icon",className:"rounded-full",onClick:()=>ie(!0),children:e.jsx(Tt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(n.tags||[]).map(d=>{var m;const j=H[d]||"actif";return e.jsxs("button",{onClick:()=>Pe(d),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${z===d?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((m=S[d])==null?void 0:m.title)||d}),j==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${z===d?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),j==="archive"&&e.jsx("span",{className:`text-xs font-medium ${z===d?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},d)}),(!n.tags||n.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Rt,label:"WhatsApp"},{icon:wt,label:"GPS"},{icon:zs,label:"Invitation",highlight:!n.userId}].map(({icon:d,label:j,highlight:m})=>e.jsxs("button",{onClick:()=>l(j),className:`flex flex-col items-center space-x-1 transition-colors group ${m?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${m?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(d,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:j})]},j))})]}),e.jsx(vr,{prospectId:t.id,projectType:z}),e.jsx(br,{prospect:n,projectType:z,supabaseSteps:c,v2Templates:I,onUpdate:d=>{F(d),a&&a(d)}}),e.jsx(jr,{prospect:n,projectType:z,onUpdate:d=>{F(d),a&&a(d)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),de?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(fe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:V,children:e.jsx(qt,{className:"h-4 w-4"})}),e.jsx(fe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>ue(!1),children:e.jsx(Ye,{className:"h-4 w-4"})})]}):e.jsx(fe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:E,children:e.jsx(ft,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[A.map(d=>e.jsxs("div",{className:"flex items-start space-x-3",children:[yr(d),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{htmlFor:d.id,className:"text-xs text-gray-500",children:d.name.replace("*","")}),de?e.jsx(Ge,{id:d.id,name:d.id,type:d.type,value:n[d.id]||"",onChange:j=>ee(d.id,j.target.value),className:"h-8 text-sm",placeholder:d.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:n[d.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},d.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{className:"text-xs text-gray-500",children:"Suivi par"}),de?e.jsx(la,{options:ve,value:n.ownerId||"unassigned",onSelect:pe,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((De=v.find(d=>d.user_id===n.ownerId))==null?void 0:De.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Oe,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(or,{prospectId:t.id,projectType:z,currentStep:Te,statusConfig:it,activeAdminUser:T,children:z&&e.jsx(pr,{prospectId:t.id,projectType:z,currentStepIndex:ke!==-1?ke:0,activeAdminUser:T,initialChannel:ye})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[z&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>Ce(!le),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:le?"Annuler":"Modifier le montant",children:le?e.jsx(Ye,{className:"h-4 w-4 text-gray-600"}):e.jsx(ft,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),le?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(Ge,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:ae,onChange:d=>me(d.target.value),onKeyDown:Se,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(fe,{size:"sm",onClick:Ne,className:"h-8",children:e.jsx(gt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof G=="number"?Y.format(G):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Ft,{value:q,onValueChange:P,children:[e.jsx($t,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${q==="actif"?"bg-green-100 text-green-700":q==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Mt,{})}),e.jsxs(Lt,{className:"w-44",children:[e.jsx(Le,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx(Le,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx(Le,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(fr,{steps:Ie,onUpdateStatus:he,prompts:b,projectType:z,currentStepIndex:ke,prospectId:t.id,completeStepAndProceed:u})]})]})]})]}),e.jsx(bt,{open:L,onOpenChange:ie,children:e.jsxs(jt,{className:"sm:max-w-md",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Ajouter un projet"}),e.jsx(fs,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:oe().length>0?oe().map(d=>e.jsxs(fe,{variant:"outline",onClick:()=>se(d.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:d.icon}),e.jsx("span",{className:"font-medium",children:d.title})]},d.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},vr=({prospectId:t,projectType:s})=>{var Q;const{activeAdminUser:a,prospects:r,projectsData:g,appointments:u,agendaLoading:h,updateAppointment:p,deleteAppointment:S,addAppointment:A,addCall:y,addTask:f,updateCall:O,updateTask:x}=He(),{users:$,loading:T}=mt(),{supabaseUserId:b}=rt(),[R,C]=i.useState(null),[v,o]=i.useState(null),[c,D]=i.useState(null),[B,I]=i.useState(!1),[M,re]=i.useState(null),ce=i.useMemo(()=>!u||u.length===0?[]:u.filter(X=>{var ue;if(X.contactId!==t||s&&X.projectId!==s)return!1;const de=(ue=X.status)==null?void 0:ue.toLowerCase();return!(de!=="pending"&&de!=="prevu")}).sort((X,de)=>{const ue=new Date(X.start),n=new Date(de.start);return ue-n}),[u,t,s]),be=(_,X)=>{D(_)},ye=()=>{C(null),o(null),D(null)},z=_=>{D(null),re({..._,type:_.type}),I(!0)};return h?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(Q=g[s])==null?void 0:Q.title})`]})}),ce.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:ce.map(_=>{const X=new Date(_.start),de={physical:{icon:ot,color:"blue",label:"üìç RDV"},virtual:{icon:ot,color:"purple",label:"üé• Visio"},call:{icon:at,color:"green",label:"üìû Appel"},task:{icon:gt,color:"yellow",label:"‚úÖ T√¢che"}},ue=de[_.type]||de.physical,n=ue.icon,F={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},L={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>be(_,_.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${ue.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(n,{className:`h-5 w-5 text-${ue.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:_.title||ue.label}),_.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:_.notes}),_.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",_.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${ue.color}-700 bg-${ue.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Qe(X,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Qe(X,"HH:mm")})]})]}),L[_.status]&&_.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${F[_.status]}`,children:L[_.status]})]},_.id)})})]}),e.jsx(wr,{event:c,onClose:ye,onReport:()=>{},onEdit:z,prospects:r,supabaseUsers:$,updateAppointment:p,deleteAppointment:S,projectsData:g}),B&&e.jsx(js,{open:B,onOpenChange:_=>{_||re(null),I(_)},initialData:M||{contactId:t,projectId:s},defaultAssignedUserId:b,addAppointment:A,addCall:y,addTask:f,updateAppointment:p,updateCall:O,updateTask:x,prospects:r||[],users:$||[],projectsData:g||{}})]})},wr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:g,supabaseUsers:u,updateAppointment:h,deleteAppointment:p,projectsData:S})=>{var v;const[A,y]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!g||!u||!h||!p||!S)return null;const f=g.find(o=>o.id===t.contactId),O=u.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(f?u.find(o=>o.user_id===f.ownerId):null),x=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",$=(o,c,D={})=>{try{const B=new Date(o);return isNaN(B.getTime())?"Date invalide":Qe(B,c,D)}catch{return"Date invalide"}},T=o=>{y(o),h(t.id,{status:o}),setTimeout(()=>{s(),o==="reporte"&&a(t)},300)},b=()=>{p(t.id),W({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},R=o=>{if(!f){W({title:"Contact non trouv√©",variant:"destructive"});return}switch(o){case"Appel":f.phone&&(window.location.href=`tel:${f.phone}`);break;case"Mail":f.email&&(window.location.href=`mailto:${f.email}`);break;case"WhatsApp":if(f.phone){let c=f.phone.replace(/\D/g,"");c.startsWith("0")&&(c=`33${c.substring(1)}`);const D=encodeURIComponent("Bonjour");window.open(`https://wa.me/${c}?text=${D}`,"_blank")}break;case"GPS":if(f.address){const c=encodeURIComponent(f.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${c}`:window.open(`https://www.google.com/maps/search/?api=1&query=${c}`,"_blank")}break;default:W({title:`Action: ${o}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},C={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:o=>!o&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ye,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:x($(t.start,"eeee d MMMM",{locale:Be}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Be})," - ",$(t.end,"HH:mm",{locale:Be})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),f&&e.jsxs("p",{className:"text-sm",children:[f.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Rt,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:o,label:c})=>e.jsxs("button",{onClick:()=>R(c),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:c})]},c))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${C[A].color}`,children:e.jsxs(Ft,{onValueChange:T,value:A,children:[e.jsx($t,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Mt,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx(Le,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Le,{value:"effectue",children:"Effectu√©"}),e.jsx(Le,{value:"annule",children:"Annul√©"}),e.jsx(Le,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((v=S[t.projectId])==null?void 0:v.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(f==null?void 0:f.name)||"N/A"})]})]})]}),e.jsxs(Ot,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(rs,{children:[e.jsx(ns,{asChild:!0,children:e.jsxs(fe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsx(os,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(cs,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ds,{children:[e.jsx(us,{children:"Annuler"}),e.jsx(ms,{onClick:b,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(fe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})};function Sr(t,s){const a=t.prospect,r=s.prospect;return!a||!r?!1:a.id===r.id&&(a.updatedAt||a.updated_at)===(r.updatedAt||r.updated_at)}const _r=ht.memo(Nr,Sr),ts=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Ir=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",Xe=t=>(t||"").toString().trim().toUpperCase(),Cr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},kr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],ss=50,as=50,qr=()=>{var se,oe;const t=He(),[s,a]=hs(),{organizationId:r}=ut(),[g,u]=i.useState(null),[h,p]=i.useState(!1),[S,A]=i.useState("all"),[y,f]=i.useState(null),[O,x]=i.useState(!1),[$,T]=i.useState([]),[b,R]=i.useState(!1),C=i.useRef(null),[v,o]=i.useState(""),c=i.useRef(null),[D,B]=i.useState(!1),[I,M]=i.useState(!1),[re,ce]=i.useState({}),{users:be,loading:ye}=mt(),{authUserId:z}=rt(),Q=t==null?void 0:t.addProspect,{prospects:_=[],prospectsLoading:X=!0,allProjectSteps:de={},allStepsLoading:ue=!0,updateProspect:n=async()=>{},projectsData:F={},activeAdminUser:L=null,users:ie={},globalPipelineSteps:k=[],pipelineLoading:q=!0,getProjectSteps:N=()=>[],adminReady:H=!1}=t||{},U=i.useMemo(()=>be.reduce((l,E)=>(l[E.user_id]={id:E.id,user_id:E.user_id,name:E.name,email:E.email,role:E.role,phone:E.phone,avatarUrl:E.avatar_url,managerId:E.manager_id,accessRights:E.access_rights},l),{}),[be]);i.useEffect(()=>{H&&!X&&!ue&&!I&&M(!0)},[H,X,ue,I]);const G=_,Y=n,ae=(_==null?void 0:_.find(l=>l.id===g))||null,ge=i.useMemo(()=>!k||k.length===0?kr:k.map((l,E)=>{const V=Xe(l.label),ee=l.color||Cr[V]||ts[E%ts.length];return{id:l.id,label:l.label,name:Ir(l.label),color:ee}}),[k]),le=i.useMemo(()=>{if(!L)return[];if(L.role==="Global Admin"||L.role==="Admin")return Object.values(U);const l=L.access_rights||L.accessRights,E=[L.user_id,...(l==null?void 0:l.users)||[]];return Object.values(U).filter(V=>E.includes(V.user_id))},[L,U]),Ce=i.useMemo(()=>{const l=le.map(E=>({value:E.user_id,label:E.name}));return le.length>1?[{value:"all",label:"Tous les utilisateurs"},...l]:l},[le]);i.useEffect(()=>{L&&y===null&&(le.length>1?f("all"):le.length===1&&f(le[0].user_id))},[L,y,le]),i.useEffect(()=>{if(!b)return;const l=E=>{C.current&&!C.current.contains(E.target)&&R(!1)};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[b]);const ve=i.useMemo(()=>{const l=new Set;return G.forEach(E=>{(E.tags||[]).forEach(V=>l.add(V))}),Array.from(l)},[G]),Ie=$.length===0?"Tags":$.length===1?((se=F[$[0]])==null?void 0:se.title)||$[0]:`${$.length} tags`,ke=i.useMemo(()=>{const l=G.filter(V=>{if(!L)return!1;if(L.role==="Global Admin"||L.role==="Admin")return!0;const ee=L.access_rights||L.accessRights;return[L.user_id,...(ee==null?void 0:ee.users)||[]].includes(V.ownerId)});w.debug("[FinalPipeline] Prospects count",{total:G.length,visible:l.length});let E=l;if($.length>0&&(E=E.filter(V=>{const ee=V.tags||[];return $.some(pe=>ee.includes(pe))})),y&&y!=="all"&&(E=E.filter(V=>V.ownerId===y)),v.trim()){const V=v.toLowerCase();E=E.filter(ee=>(ee.name||"").toLowerCase().includes(V)||(ee.email||"").toLowerCase().includes(V)||(ee.city||"").toLowerCase().includes(V)||(ee.phone||"").toLowerCase().includes(V))}return S==="mine"&&z?E.filter(V=>V.ownerId===z):E},[G,S,z,y,$,v]),{stagesWithCounts:Te,prospectsByStage:Pe}=i.useMemo(()=>{var j;const l=ge.reduce((m,J)=>(m[J.id]=[],m),{}),E=((j=ge[0])==null?void 0:j.id)||"fallback-stage",V=new Set(ge.map(m=>m.id)),ee=new Map(ge.map(m=>[Xe(m.label),m.id])),pe=m=>{const J=[];return m.projectType&&F[m.projectType]&&J.push(m.projectType),Array.isArray(m.tags)&&m.tags.forEach(Z=>{F[Z]&&!J.includes(Z)&&J.push(Z)}),J},De=m=>{const J=[];if(!k.length){const K=m.stage||E,te=V.has(K)?K:E;return J.push({stageId:te,prospect:m}),J}if(typeof N!="function")return J.push({stageId:E,prospect:m}),J;const Z=pe(m);return Z.length?(Z.forEach(K=>{var Ze;const te=`${m.id}-${K}`,ne=de[te]||(typeof N=="function"?N(m.id,K):[])||[],we=((Ze=F[K])==null?void 0:Ze.steps)||[];if(!ne.length){J.push({stageId:E,prospect:m,projectType:K});return}const _e=ne.find($e=>$e.status==="in_progress"||$e.status==="current")||ne.find($e=>$e.status==="pending")||ne[ne.length-1];if(!_e){J.push({stageId:E,prospect:m,projectType:K});return}const We=(()=>{if(_e.globalStepId&&V.has(_e.globalStepId))return _e.globalStepId;if(_e.globalStepId){const Me=Xe(_e.globalStepId),Re=ee.get(Me);if(Re&&V.has(Re))return Re}const $e=ne.indexOf(_e);let Ae=null;if($e>=0&&we[$e]&&(Ae=we[$e]),!Ae){const Me=Xe(_e.name||_e.label);Ae=we.find(Re=>Xe(Re.name||Re.label)===Me)}if(Ae!=null&&Ae.globalStepId&&V.has(Ae.globalStepId))return Ae.globalStepId;if(Ae!=null&&Ae.globalStepId){const Me=Xe(Ae.globalStepId),Re=ee.get(Me);if(Re&&V.has(Re))return Re}if(Ae&&(Ae.label||Ae.name)){const Me=Xe(Ae.label||Ae.name),Re=ee.get(Me);if(Re&&V.has(Re))return Re}const _t=Xe(_e.label||_e.name),nt=ee.get(_t);return nt&&V.has(nt)?nt:E})();J.push({stageId:We,prospect:m,projectType:K,activeStep:_e})}),J):(J.push({stageId:E,prospect:m}),J)};return ke.forEach(m=>{De(m).forEach(({stageId:Z,projectType:K,activeStep:te})=>{l[Z]||(l[Z]=[]),l[Z].push({prospect:m,projectType:K,activeStep:te})})}),{stagesWithCounts:ge.map(m=>{var J;return{...m,count:((J=l[m.id])==null?void 0:J.length)||0}}),prospectsByStage:l}},[ge,ke,k,N,F]);i.useEffect(()=>{const l=s.get("prospect"),E=s.get("project"),V=`${l}-${E}`;if(c.current===V)return;if(!l){g!==null&&(u(null),c.current=null);return}(G.find(pe=>pe.id===l)||null)&&(u(l),c.current=V)},[s,G]);const P=l=>{T(E=>E.includes(l)?E.filter(V=>V!==l):[...E,l])},me=i.useCallback((l,E)=>{u(l.id),a(V=>{const ee=new URLSearchParams(V);return ee.set("prospect",l.id),E?ee.set("project",E):ee.delete("project"),ee})},[a]),xe=i.useCallback(l=>{ce(E=>({...E,[l]:(E[l]||ss)+as}))},[]),Ne=()=>{u(null);const l=new URLSearchParams(s);l.delete("prospect"),l.delete("project"),a(l)},Se=async l=>{var E,V;try{if(!Q)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const ee=((E=k[0])==null?void 0:E.step_id)||((V=k[0])==null?void 0:V.id);console.log("[handleAddProspect] calling addProspect",{name:l.name,email:l.email,status:ee,ownerId:L==null?void 0:L.user_id,sendInvitation:l.sendInvitation,allData:l});const pe=await Q({...l,status:ee,ownerId:L==null?void 0:L.user_id});if(console.log("[handleAddProspect] result",pe),!(pe!=null&&pe.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:l.sendInvitation,email:pe.email,willSend:l.sendInvitation&&pe.email}),l.sendInvitation&&pe.email)try{const De=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",pe.email.trim(),"redirect:",De,"org:",r);const{error:d}=await je.auth.signInWithOtp({email:pe.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:De,data:{organization_id:r}}});d?(console.error("[handleAddProspect] ‚ùå invitation error",d),W({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${d.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",pe.email),W({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${pe.email}`,className:"bg-green-500 text-white"}))}catch(De){console.error("[handleAddProspect] üí• invitation exception",De),W({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${De.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:l.sendInvitation?"no email":"sendInvitation=false"});p(!1)}catch(ee){console.error("‚ùå handleAddProspect error",ee),W({title:"Erreur",description:ee.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},he=l=>{try{Y&&(Y(l),W({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{W({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return ae&&ae.id?e.jsx(Ke.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Xs,{name:"Fiche Prospect",children:e.jsx(_r,{prospect:ae,onBack:Ne,onUpdate:he,onEditingChange:B})})}):I?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(tt,{className:"w-4 h-4"}),e.jsxs("span",{children:[ke.length," prospect",ke.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:C,className:"relative inline-block text-left",children:[e.jsxs(fe,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>R(l=>!l),children:[e.jsx("span",{children:Ie}),e.jsx(Ct,{className:"h-4 w-4"})]}),b&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[ve.map(l=>{var E;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:$.includes(l),onChange:()=>P(l),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((E=F[l])==null?void 0:E.title)||l})]},l)}),$.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>T([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(Ys,{open:O,onOpenChange:x,children:[e.jsx(Ks,{asChild:!0,children:e.jsxs(fe,{variant:"outline",role:"combobox","aria-expanded":O,className:"w-[230px] justify-between",children:[e.jsx(tt,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:y==="all"?"Tous les utilisateurs":((oe=U[y])==null?void 0:oe.name)||"Utilisateur"}),e.jsx(Ct,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(Qs,{className:"w-[200px] p-0",children:e.jsxs(Zs,{children:[e.jsx(Us,{placeholder:"Rechercher..."}),e.jsxs(ea,{children:[e.jsx(ta,{children:"Aucun utilisateur"}),e.jsx(sa,{children:Ce.map(l=>e.jsxs(aa,{value:l.label,onSelect:()=>{f(l.value),x(!1)},children:[e.jsx(gt,{className:Ue("mr-2 h-4 w-4",y===l.value?"opacity-100":"opacity-0")}),l.label]},l.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ra,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Ge,{type:"text",placeholder:"Rechercher un prospect...",value:v,onChange:l=>o(l.target.value),className:"pl-9 pr-4"}),v&&e.jsx("button",{onClick:()=>o(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(fe,{onClick:()=>p(!0),children:[e.jsx(Tt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Te.map(l=>e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${l.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:l.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(Pe[l.id]||[]).filter(E=>{if($.length===0)return!0;const{projectType:V}=E;return $.some(ee=>ee.toUpperCase()===(V||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const E=(Pe[l.id]||[]).filter(d=>{if($.length===0)return!0;const{projectType:j}=d;return $.some(m=>m.toUpperCase()===(j||"").toUpperCase())}),V=re[l.id]||ss,ee=E.slice(0,V),pe=E.length>V,De=E.length-V;return e.jsxs(e.Fragment,{children:[ee.map((d,j)=>{var We;const{prospect:m,projectType:J,activeStep:Z}=d,K=`${m.id}-${J||"default"}-${l.id}-${j}`,te=m.projectType||m.tags&&m.tags[0]||"Projet",ne=J&&((We=F[J])!=null&&We.title)?F[J].title:te,we=(Z==null?void 0:Z.label)||(Z==null?void 0:Z.name)||l.name,_e=l.color||"bg-blue-100 text-blue-700",Je=`${m.id}-${J||ne}-${l.id}-${j}`;return e.jsx(Ke.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(Ua,{prospect:{...m,_projectContext:{projectType:J||te,projectTitle:ne,stepLabel:we,projectColor:_e}},onClick:()=>me(m,J||m.projectType||(Array.isArray(m.tags)?m.tags[0]:te)),compact:!0,sortableId:Je,projectsData:F})},K)}),pe&&e.jsxs("button",{onClick:()=>xe(l.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(De,as)," de plus (",De," restants)"]}),E.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(tt,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},l.id))})})}),e.jsx(na,{open:h,onOpenChange:p,onAddProspect:Se}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(l=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},l))})})})]})};export{qr as default};
