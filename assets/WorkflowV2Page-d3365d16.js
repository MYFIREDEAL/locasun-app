import{c as ee,r as d,ae as ue,b as Z,s as J,j as e,a0 as g,a2 as P,b9 as xe,ba as ge,Z as L,a4 as W,O as q,aW as G,_ as he,a$ as se,B as A,a3 as z,bb as be,u as pe,a as fe,af as je,ag as Ne,a8 as ye,N as $}from"./index-408037a7.js";import{l as v,r as ve,a as we,b as ke,g as Ce,s as Se,c as De,D as H,M as O}from"./workflowV2Config-b482875b.js";import{u as Ae}from"./useSupabaseProjectStepsStatus-9519ce13.js";import{u as _e}from"./useSupabaseProjectFiles-29e4dd5d.js";import{a as te,F as Me,u as Ee}from"./useSupabaseWorkflowModuleTemplates-8a9277c6.js";import{M as Le}from"./ModuleConfigTab-8335ffd5.js";import{E as Pe}from"./external-link-c047358b.js";import{R as K}from"./rocket-547e3498.js";import"./download-edf5abab.js";const Fe=ee("FileSignature",[["path",{d:"M20 19.5v.5a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8.5L18 5.5",key:"kd5d3"}],["path",{d:"M8 18h1",key:"13wk12"}],["path",{d:"M18.42 9.61a2.1 2.1 0 1 1 2.97 2.97L16.95 17 13 18l.99-3.95 4.43-4.44Z",key:"johvi5"}]]),ae=ee("HelpCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);function Re(s,a){const[t,r]=d.useState(0),[l,h]=d.useState([]),[c,j]=d.useState(!1),{projectStepsStatus:i,loading:u,error:p}=Ae(s,{enabled:!!s}),{messages:b,loading:x}=ue(s,a),{files:y,loading:D}=_e({projectType:a,prospectId:s,enabled:!!s&&!!a}),{clientFormPanels:S}=Z(),{prospects:k,projectsData:N}=Z();d.useEffect(()=>{if(!s||!a)return;(async()=>{j(!0);try{const{data:f,error:I}=await J.from("signature_procedures").select("id, status, signer_name, created_at, signed_at, file_id, project_files!signature_procedures_file_id_fkey(id, file_name, storage_path)").eq("prospect_id",s).eq("project_type",a).order("created_at",{ascending:!1});I?v("Erreur chargement signature_procedures",{error:I.message}):(v("Contrats/PDB charg√©s",{count:(f==null?void 0:f.length)||0}),h(f||[]))}catch(f){v("Exception signature_procedures",{error:f.message})}finally{j(!1)}})()},[s,a]);const _=d.useMemo(()=>(k==null?void 0:k.find(n=>n.id===s))||null,[k,s]),o=d.useMemo(()=>(N==null?void 0:N[a])||null,[N,a]),C=d.useMemo(()=>{v("DEBUG projectStepsStatus",{projectStepsStatus:i,projectType:a,keys:i?Object.keys(i):[],stepsLoading:u,stepsError:p});const n=i==null?void 0:i[a];return n&&n.length>0?(v("Steps depuis Supabase",{count:n.length}),n):o!=null&&o.steps?(v("Steps depuis template (fallback)",{count:o.steps.length}),o.steps):(v("Aucun step trouv√©",{projectType:a,hasProjectStepsStatus:!!i}),[])},[i,a,o,u,p]),m=d.useMemo(()=>C[t]||null,[C,t]),M=d.useMemo(()=>(m==null?void 0:m.id)||null,[m]),R=d.useMemo(()=>{const n=C.findIndex(f=>f.status==="in_progress");return n!==-1?n:0},[C]),V=d.useMemo(()=>!S||!m?[]:S.filter(n=>n.prospectId===s&&n.projectType===a),[S,s,a,m]),U=d.useMemo(()=>b||[],[b]),B=d.useMemo(()=>!y||y.length===0?[]:y.map(n=>{var f;return{id:n.id,type:"file",name:n.file_name||n.name||"Document sans nom",url:n.storage_path?`${(f=J.storage.from("project-files").getPublicUrl(n.storage_path).data)==null?void 0:f.publicUrl}`:null,uploadedAt:n.created_at,category:n.field_label||n.category||"Document"}}),[y]),E=d.useMemo(()=>!l||l.length===0?[]:l.map(n=>{var f;return{id:n.id,type:"contract",name:((f=n.project_files)==null?void 0:f.file_name)||`Contrat - ${n.signer_name||"Sans nom"}`,status:n.status,signerName:n.signer_name,signedAt:n.signed_at,uploadedAt:n.created_at,category:"Contrat/PDB"}}),[l]),w=d.useMemo(()=>[...E,...B].sort((f,I)=>new Date(I.uploadedAt)-new Date(f.uploadedAt)),[B,E]);d.useEffect(()=>{if(!u&&C.length>0&&t===0){const n=C.findIndex(f=>f.status==="in_progress");n!==-1&&n!==t&&(v("Initialisation sur step in_progress",{index:n}),r(n))}},[u,C,t]);const oe=n=>{Ce("navigateToStep",{from:t,to:n,isUserAction:!0}),n>=0&&n<C.length&&(v("Navigation step (visuelle)",{from:t,to:n}),r(n))},de=()=>{const n={stepId:M,stepName:m==null?void 0:m.name,stepStatus:m==null?void 0:m.status,prospectId:s,projectType:a,timestamp:new Date().toISOString()};return Se(()=>(console.error("[V2 PROCEED] ‚õî Action r√©elle appel√©e mais non impl√©ment√©e"),{success:!1,message:"Action non impl√©ment√©e"}),n)},me=()=>{const n={stepId:M,stepName:m==null?void 0:m.name,prospectId:s,projectType:a,timestamp:new Date().toISOString()};return De(()=>(console.error("[V2 NEED_DATA] ‚õî Action r√©elle appel√©e mais non impl√©ment√©e"),{success:!1,message:"Action non impl√©ment√©e"}),n)};return d.useEffect(()=>{ve()},[]),{prospect:_,projectTemplate:o,steps:C,activeStep:m,activeStepId:M,activeStepIndex:t,currentStepIndex:R,activeStepForms:V,projectMessages:U,projectDocuments:w,projectFiles:y,signatureProcedures:l,loading:u||x||D||c,error:p||null,isReadOnly:!0,isMockProceed:we(),isRoutingDisabled:ke(),navigateToStep:oe,setActiveStepIndex:r,handleProceed:de,handleNeedData:me}}const Q={completed:{icon:P,iconClass:"text-green-500",labelClass:"text-green-600",label:"Termin√©",clickable:!0},in_progress:{icon:xe,iconClass:"text-blue-500 fill-blue-500",labelClass:"text-blue-600",label:"En cours",clickable:!0},pending:{icon:ge,iconClass:"text-gray-300",labelClass:"text-gray-400",label:"√Ä venir",clickable:!1}},Be=({step:s,index:a,isActive:t,onSelect:r,itemRef:l})=>{const h=s.status||"pending",c=Q[h]||Q.pending,j=c.icon,i=c.clickable,u=()=>{i&&r&&r(a,s)},p=b=>{(b.key==="Enter"||b.key===" ")&&i&&(b.preventDefault(),u())};return e.jsxs("div",{ref:l,role:"button",tabIndex:i?0:-1,"aria-selected":t,"aria-disabled":!i,onClick:u,onKeyDown:p,className:g("w-full flex items-center gap-3 p-3 rounded-lg text-left transition-all duration-200","focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1",t&&"bg-blue-50 border-2 border-blue-500 shadow-sm",!t&&i&&"bg-gray-50 border-2 border-transparent hover:bg-gray-100 hover:border-gray-200 cursor-pointer",!t&&!i&&"bg-gray-50 border-2 border-transparent opacity-60 cursor-not-allowed"),children:[e.jsx("div",{className:g("flex-shrink-0",c.iconClass),children:e.jsx(j,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:g("text-sm font-medium truncate",t?"text-blue-900":"text-gray-900"),children:[s.icon||"üìã"," ",s.name||`Module ${a+1}`]}),e.jsx("p",{className:g("text-xs",c.labelClass),children:c.label})]}),t&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"})})]})},Ie=({steps:s=[],activeStepIndex:a=0,activeStepId:t,onSelectStep:r,className:l})=>{const h=d.useRef(null),c=d.useRef([]),j=t?s.findIndex(x=>x.id===t):a,i=j>=0?j:0;d.useEffect(()=>{const x=c.current[i];x&&h.current&&x.scrollIntoView({behavior:"smooth",block:"nearest"})},[i]);const u=s.filter(x=>x.status==="completed").length,p=s.length,b=p>0?Math.round(u/p*100):0;return!s||s.length===0?e.jsx("div",{className:g("bg-white rounded-xl shadow-sm border p-4",l),children:e.jsx("p",{className:"text-sm text-gray-400 text-center",children:"Aucun module configur√©"})}):e.jsxs("div",{className:g("bg-white rounded-xl shadow-sm border",l),children:[e.jsxs("div",{className:"px-4 py-3 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wide",children:"Modules"}),e.jsxs("span",{className:"text-xs text-gray-400",children:[u,"/",p]})]}),e.jsx("div",{className:"h-1.5 bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-green-500 transition-all duration-500",style:{width:`${b}%`}})})]}),e.jsx("div",{ref:h,className:"p-3 space-y-2 max-h-[calc(100vh-300px)] overflow-y-auto",role:"listbox","aria-label":"Modules du workflow",children:s.map((x,y)=>e.jsx(Be,{step:x,index:y,isActive:y===i,onSelect:r,itemRef:D=>c.current[y]=D},x.id||y))}),e.jsx("div",{className:"px-4 py-2 border-t bg-gray-50 rounded-b-xl",children:e.jsxs("p",{className:"text-xs text-gray-400 text-center",children:[b,"% compl√©t√©"]})})]})},T=({icon:s,title:a,count:t,className:r})=>e.jsxs("div",{className:g("flex items-center justify-between mb-3",r),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s&&e.jsx(s,{className:"h-4 w-4 text-gray-400"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:a})]}),t!==void 0&&e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full",children:t})]}),ne=({prospect:s})=>s?e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(W,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 truncate",children:s.name||"Client sans nom"}),s.email&&e.jsx("p",{className:"text-sm text-gray-500 truncate",children:s.email}),s.phone&&e.jsx("p",{className:"text-sm text-gray-500",children:s.phone}),s.company_name&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["üè¢ ",s.company_name]})]})]})}):e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 text-center",children:e.jsx("p",{className:"text-sm text-gray-400",children:"Aucune info client"})}),re=({forms:s=[]})=>{if(!s||s.length===0)return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-200",children:[e.jsx(q,{className:"h-6 w-6 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Aucun formulaire"})]});const a=t=>{const r={pending:{label:"En attente",class:"bg-amber-100 text-amber-700",icon:se},submitted:{label:"Soumis",class:"bg-blue-100 text-blue-700",icon:P},approved:{label:"Approuv√©",class:"bg-green-100 text-green-700",icon:P},rejected:{label:"Rejet√©",class:"bg-red-100 text-red-700",icon:L}};return r[t]||r.pending};return e.jsx("div",{className:"space-y-2",children:s.map((t,r)=>{const l=a(t.status),h=l.icon;return e.jsxs("div",{className:"bg-white border rounded-lg p-3 hover:shadow-sm transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(q,{className:"h-4 w-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 truncate",children:t.title||t.name||`Formulaire ${r+1}`})]}),e.jsxs("div",{className:g("flex items-center gap-1 px-2 py-0.5 rounded-full text-xs",l.class),children:[e.jsx(h,{className:"h-3 w-3"}),l.label]})]}),t.submitted_at&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1 ml-6",children:["Soumis le ",new Date(t.submitted_at).toLocaleDateString("fr-FR")]})]},t.id||r)})})},le=({documents:s=[]})=>{if(!s||s.length===0)return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-200",children:[e.jsx(te,{className:"h-6 w-6 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Aucun document"})]});const a=t=>{const r={pending:{label:"En attente",class:"bg-amber-100 text-amber-700",icon:se},signed:{label:"Sign√©",class:"bg-green-100 text-green-700",icon:P},expired:{label:"Expir√©",class:"bg-red-100 text-red-700",icon:L}};return r[t]||r.pending};return e.jsx("div",{className:"space-y-2",children:s.map((t,r)=>{const l=t.type==="contract",h=l?Fe:Me,c=l?a(t.status):null,j=c==null?void 0:c.icon;return e.jsxs("div",{className:g("bg-white border rounded-lg p-3 hover:shadow-sm transition-shadow",l&&"border-l-4 border-l-blue-400"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx(h,{className:g("h-4 w-4 flex-shrink-0",l?"text-blue-500":"text-gray-400")}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"text-sm text-gray-700 truncate block",children:t.name||t.file_name||`Document ${r+1}`}),t.category&&e.jsx("span",{className:"text-xs text-gray-400",children:t.category})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&c&&e.jsxs("div",{className:g("flex items-center gap-1 px-2 py-0.5 rounded-full text-xs",c.class),children:[e.jsx(j,{className:"h-3 w-3"}),c.label]}),t.url&&e.jsx("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:text-blue-700",title:"Voir le document",children:e.jsx(Pe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 ml-6 text-xs text-gray-400",children:[t.uploadedAt&&e.jsxs("span",{children:["Ajout√© le ",new Date(t.uploadedAt).toLocaleDateString("fr-FR")]}),l&&t.signerName&&e.jsxs("span",{children:["‚Ä¢ Signataire: ",t.signerName]}),l&&t.signedAt&&e.jsxs("span",{className:"text-green-600",children:["‚Ä¢ Sign√© le ",new Date(t.signedAt).toLocaleDateString("fr-FR")]})]})]},t.id||r)})})},ce=({messages:s=[]})=>{const a=s.slice(-5);return!s||s.length===0?e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-200",children:[e.jsx(G,{className:"h-6 w-6 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Aucun message"})]}):e.jsxs("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:[a.map((t,r)=>{const l=t.sender_type==="admin"||t.is_admin;return e.jsxs("div",{className:g("p-2 rounded-lg text-sm",l?"bg-blue-50 ml-4":"bg-gray-50 mr-4"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:g("text-xs font-medium",l?"text-blue-600":"text-gray-600"),children:l?"üë§ Admin":"üë• Client"}),t.created_at&&e.jsx("span",{className:"text-xs text-gray-400",children:new Date(t.created_at).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-gray-700 line-clamp-2",children:t.content||t.message||"..."})]},t.id||r)}),s.length>5&&e.jsxs("p",{className:"text-xs text-gray-400 text-center py-1",children:["+ ",s.length-5," messages pr√©c√©dents"]})]})},ie=({status:s})=>{const a={completed:{label:"‚úÖ Termin√©",class:"bg-green-100 text-green-700"},in_progress:{label:"üîÑ En cours",class:"bg-blue-100 text-blue-700"},pending:{label:"‚è≥ √Ä venir",class:"bg-gray-100 text-gray-500"}},t=a[s]||a.pending;return e.jsx("div",{className:g("px-3 py-1 rounded-full text-sm font-medium",t.class),children:t.label})},F=({step:s,stepIndex:a=0,totalSteps:t=0,prospect:r,prospectId:l,projectType:h,forms:c=[],documents:j=[],messages:i=[],isReadOnly:u=!0,availableForms:p=[],availableTemplates:b=[],formsLoading:x=!1,templatesLoading:y=!1,templateOps:D={},children:S,className:k})=>{const[N,_]=d.useState("contact"),o=[{id:"contact",label:"Contact",icon:W},{id:"workflow-v2",label:"Workflow V2",icon:he}];if(!s)return e.jsx("div",{className:g("bg-white rounded-xl shadow-sm border",k),children:e.jsxs("div",{className:"px-6 py-12 text-center",children:[e.jsx(L,{className:"h-8 w-8 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500",children:"Aucun module s√©lectionn√©"})]})});const C=s.name?s.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`;return e.jsxs("div",{className:g("bg-white rounded-xl shadow-sm border",k),children:[e.jsxs("div",{className:"px-6 py-5 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:[s.icon||"üìã"," ",s.name||"Module"]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Module ",a+1," sur ",t]})]}),e.jsx(ie,{status:s.status})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-3 p-3 bg-gray-50 rounded-lg",children:s.description})]}),e.jsx("div",{className:"px-6 pt-4 border-b",children:e.jsx("nav",{className:"flex gap-1","aria-label":"Tabs",children:o.map(m=>{const M=m.icon,R=N===m.id;return e.jsxs("button",{onClick:()=>_(m.id),className:g("flex items-center gap-2 px-4 py-2.5 text-sm font-medium rounded-t-lg transition-colors","border-b-2 -mb-px",R?"border-blue-600 text-blue-600 bg-blue-50/50":"border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"),children:[e.jsx(M,{className:"h-4 w-4"}),m.label]},m.id)})})}),e.jsxs("div",{className:"px-6 py-6",children:[N==="contact"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("section",{children:[e.jsx(T,{icon:W,title:"Client"}),e.jsx(ne,{prospect:r})]}),e.jsxs("section",{children:[e.jsx(T,{icon:q,title:"Formulaires",count:c.length}),e.jsx(re,{forms:c})]}),e.jsxs("section",{children:[e.jsx(T,{icon:te,title:"Documents",count:j.length}),e.jsx(le,{documents:j})]}),e.jsxs("section",{children:[e.jsx(T,{icon:G,title:"Historique",count:i.length}),e.jsx(ce,{messages:i})]})]}),N==="workflow-v2"&&e.jsx(Le,{moduleId:C,moduleName:s.name||"Module",isReadOnly:u,prospectId:l,projectType:h,availableForms:p,availableTemplates:b,templateOps:D})]}),S&&N==="contact"&&e.jsx("div",{className:"px-6 py-4 border-t bg-gray-50 rounded-b-xl",children:S}),!S&&u&&N==="contact"&&e.jsx("div",{className:"px-6 py-3 border-t bg-amber-50 rounded-b-xl",children:e.jsx("p",{className:"text-xs text-amber-600 text-center",children:"‚ö†Ô∏è Mode lecture seule ‚Äî Actions d√©sactiv√©es"})})]})};F.ClientInfoCard=ne;F.FormsList=re;F.DocumentsList=le;F.ChatPreview=ce;F.StatusBadge=ie;const X=1500,Y=({onProceed:s,onNeedData:a,isReadOnly:t=!0,disabled:r=!1,proceedLabel:l=H.proceed,needDataLabel:h=H.needData,stepStatus:c="in_progress",className:j,showToast:i})=>{const[u,p]=d.useState("idle"),[b,x]=d.useState("idle"),y=async()=>{if(!(r||u!=="idle")){v("ActionButtons: PROCEED cliqu√©",{isReadOnly:t,stepStatus:c}),p("loading");try{const o=s==null?void 0:s();v("ActionButtons: PROCEED r√©sultat",o),setTimeout(()=>{p("success"),setTimeout(()=>{p("idle")},X)},300),i&&(o!=null&&o.mock)&&i(O.proceed)}catch(o){v("ActionButtons: PROCEED erreur",o),p("idle")}}},D=async()=>{if(!(r||b!=="idle")){v("ActionButtons: NEED_DATA cliqu√©",{isReadOnly:t,stepStatus:c}),x("loading");try{const o=a==null?void 0:a();v("ActionButtons: NEED_DATA r√©sultat",o),setTimeout(()=>{x("success"),setTimeout(()=>{x("idle")},X)},300),i&&(o!=null&&o.mock)&&i(O.needData)}catch(o){v("ActionButtons: NEED_DATA erreur",o),x("idle")}}},S=()=>{switch(u){case"loading":return e.jsx(z,{className:"h-4 w-4 animate-spin"});case"success":return e.jsx(P,{className:"h-4 w-4"});default:return e.jsx(K,{className:"h-4 w-4"})}},k=()=>{switch(b){case"loading":return e.jsx(z,{className:"h-4 w-4 animate-spin"});case"success":return e.jsx(G,{className:"h-4 w-4"});default:return e.jsx(ae,{className:"h-4 w-4"})}},N=r||c==="completed"||u!=="idle",_=r||b!=="idle";return e.jsxs("div",{className:g("flex items-center justify-between",j),children:[e.jsxs("div",{className:"flex-1",children:[t&&e.jsxs("p",{className:"text-xs text-amber-600 flex items-center gap-1",children:[e.jsx("span",{className:"inline-block w-2 h-2 bg-amber-400 rounded-full animate-pulse"}),"Mode lecture ‚Äî Actions simul√©es"]}),c==="completed"&&!t&&e.jsxs("p",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(P,{className:"h-3 w-3"}),"Module termin√©"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(A,{variant:"outline",onClick:D,disabled:_,className:g("gap-2 transition-all",b==="success"&&"border-green-500 text-green-600"),children:[k(),h]}),e.jsxs(A,{onClick:y,disabled:N,className:g("gap-2 transition-all",u==="success"?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700",c==="completed"&&"opacity-50 cursor-not-allowed"),children:[S(),c==="completed"?"D√©j√† valid√©":l]})]})]})};Y.Compact=({onProceed:s,onNeedData:a,disabled:t,stepStatus:r})=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(A,{size:"sm",variant:"outline",onClick:a,disabled:t,className:"gap-1",children:[e.jsx(ae,{className:"h-3 w-3"}),"Info"]}),e.jsxs(A,{size:"sm",onClick:s,disabled:t||r==="completed",className:"gap-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(K,{className:"h-3 w-3"}),r==="completed"?"‚úì":"Go"]})]});Y.ProceedOnly=({onProceed:s,disabled:a,label:t=H.proceed,stepStatus:r})=>e.jsxs(A,{onClick:s,disabled:a||r==="completed",className:"gap-2 bg-blue-600 hover:bg-blue-700",children:[e.jsx(K,{className:"h-4 w-4"}),r==="completed"?"D√©j√† valid√©":t]});const Ze=()=>{const{prospectId:s,projectType:a}=be(),t=pe(),{prospect:r,steps:l,activeStep:h,activeStepIndex:c,activeStepForms:j,projectMessages:i,projectDocuments:u,loading:p,error:b,isReadOnly:x,navigateToStep:y,handleProceed:D,handleNeedData:S}=Re(s,a),{organizationId:k}=fe(),{forms:N,loading:_}=je(k),{templates:o,loading:C}=Ne(k),m=d.useMemo(()=>N?Object.values(N).map(w=>({id:w.id,name:w.name,audience:w.audience||"client",fields:w.fields||[]})):[],[N]),M=d.useMemo(()=>o?o.map(w=>({id:w.id,name:w.name,projectType:w.projectType})):[],[o]),R=Ee(k,a),V=()=>{D().mock&&$(O.proceed)},U=()=>{S().mock&&$(O.needData)},B=w=>{y(w)},E=()=>{t("/admin/pipeline")};return p?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(z,{className:"h-8 w-8 animate-spin text-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Chargement du workflow..."})]})}):b?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(L,{className:"h-8 w-8 text-red-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700 font-medium",children:"Erreur de chargement"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:b.message||"Erreur inconnue"}),e.jsx(A,{onClick:E,className:"mt-4",children:"Retour au pipeline"})]})}):!l||l.length===0?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(L,{className:"h-8 w-8 text-amber-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700 font-medium",children:"Aucune √©tape configur√©e"}),e.jsxs("p",{className:"text-gray-500 text-sm mt-1",children:[`Ce projet n'a pas d'√©tapes d√©finies pour le type "`,a,'"']}),e.jsx(A,{onClick:E,className:"mt-4",children:"Retour au pipeline"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(A,{variant:"ghost",size:"icon",onClick:E,children:e.jsx(ye,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-semibold text-gray-900",children:["Workflow V2 ",e.jsx("span",{className:"text-blue-600",children:"LIVE"})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:[a," ‚Ä¢ Prospect: ",s==null?void 0:s.slice(0,8),"..."]})]})]}),x&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-amber-100 text-amber-700 rounded-full text-sm font-medium",children:[e.jsx(L,{className:"h-4 w-4"}),"Mode lecture seule"]})]})}),e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-8",children:e.jsxs("div",{className:"flex gap-8",children:[e.jsx("div",{className:"w-72 flex-shrink-0",children:e.jsx(Ie,{steps:l,activeStepIndex:c,onSelectStep:B,className:"sticky top-6"})}),e.jsx("div",{className:"flex-1",children:e.jsx(F,{step:h,stepIndex:c,totalSteps:l.length,prospect:r,prospectId:s,projectType:a,forms:j,documents:u,messages:i,isReadOnly:x,availableForms:m,availableTemplates:M,formsLoading:_,templatesLoading:C,templateOps:R,children:e.jsx(Y,{onProceed:V,onNeedData:U,isReadOnly:x,stepStatus:h==null?void 0:h.status,showToast:$})})})]})})]})};export{Ze as default};
