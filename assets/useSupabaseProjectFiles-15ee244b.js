import{r as f,s as h,l as w}from"./index-6b6c909f.js";function T(e=null,r=null){const[a,i]=f.useState([]),[E,_]=f.useState(!0),[F,S]=f.useState(null),y=t=>({id:t.id,sender:t.sender,text:t.text,file:t.file,formId:t.form_id,completedFormId:t.completed_form_id,promptId:t.prompt_id,stepIndex:t.step_index,relatedMessageTimestamp:t.related_message_timestamp,read:t.read,timestamp:t.created_at,createdAt:t.created_at});return f.useEffect(()=>{if(!e||!r){_(!1);return}(async()=>{try{_(!0);const{data:n,error:l}=await h.from("chat_messages").select("*").eq("prospect_id",e).eq("project_type",r).order("created_at",{ascending:!0});if(l)throw l;const u=(n||[]).map(y);i(u),S(null)}catch(n){w.error("❌ Error loading chat messages:",n),S(n.message)}finally{_(!1)}})();const m=h.channel(`chat-${e}-${r}-${Math.random().toString(36).slice(2)}`).on("postgres_changes",{event:"*",schema:"public",table:"chat_messages",filter:`prospect_id=eq.${e}`},n=>{if(!(n.new&&n.new.project_type!==r))if(n.eventType==="INSERT"){const l=y(n.new);i(u=>u.some(d=>d.id===l.id)?u:[...u,l])}else if(n.eventType==="UPDATE"){const l=y(n.new);i(u=>u.map(d=>d.id===l.id?l:d))}else n.eventType==="DELETE"&&i(l=>l.filter(u=>u.id!==n.old.id))}).subscribe();return()=>{h.removeChannel(m)}},[e,r]),{messages:a,loading:E,error:F,sendMessage:async t=>{try{if(a.some(d=>t.promptId?d.promptId===t.promptId&&d.stepIndex===t.stepIndex&&d.text===t.text&&d.sender===t.sender:t.completedFormId?d.completedFormId===t.completedFormId&&d.sender===t.sender&&d.relatedMessageTimestamp===t.relatedMessageTimestamp:!1))return{success:!0,duplicate:!0};const n={prospect_id:e,project_type:r,sender:t.sender,text:t.text||null,file:t.file||null,form_id:t.formId||null,completed_form_id:t.completedFormId||null,prompt_id:t.promptId||null,step_index:t.stepIndex!==void 0?t.stepIndex:null,related_message_timestamp:t.relatedMessageTimestamp||null,read:!1},{data:l,error:u}=await h.from("chat_messages").insert([n]).select().single();if(u)throw u;return{success:!0,data:y(l)}}catch(m){return w.error("❌ Error sending message:",m),{success:!1,error:m.message}}},markAsRead:async t=>{try{const{error:m}=await h.from("chat_messages").update({read:!0}).in("id",t);if(m)throw m;return{success:!0}}catch(m){return w.error("❌ Error marking messages as read:",m),{success:!1,error:m.message}}}}}const o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));function k(e,r=0){return(o[e[r+0]]+o[e[r+1]]+o[e[r+2]]+o[e[r+3]]+"-"+o[e[r+4]]+o[e[r+5]]+"-"+o[e[r+6]]+o[e[r+7]]+"-"+o[e[r+8]]+o[e[r+9]]+"-"+o[e[r+10]]+o[e[r+11]]+o[e[r+12]]+o[e[r+13]]+o[e[r+14]]+o[e[r+15]]).toLowerCase()}let b;const A=new Uint8Array(16);function L(){if(!b){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");b=crypto.getRandomValues.bind(crypto)}return b(A)}const P=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),C={randomUUID:P};function V(e,r,a){var E;e=e||{};const i=e.random??((E=e.rng)==null?void 0:E.call(e))??L();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,r){if(a=a||0,a<0||a+16>r.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);for(let _=0;_<16;++_)r[a+_]=i[_];return r}return k(i)}function z(e,r,a){return C.randomUUID&&!r&&!e?C.randomUUID():V(e,r,a)}function M({projectType:e,prospectId:r,organizationId:a=null,enabled:i=!0}){const[E,_]=f.useState([]),[F,S]=f.useState(!1),[y,R]=f.useState(!1),[q,t]=f.useState(!1),[m,n]=f.useState(null),l=f.useCallback(async()=>{if(!(!e||!i))try{S(!0),n(null);let s=h.from("project_files").select("*").eq("project_type",e).order("created_at",{ascending:!1});r&&(s=s.eq("prospect_id",r));const{data:g,error:c}=await s;if(c)throw c;_(g||[])}catch(s){w.error("Error fetching project files:",s),n(s.message)}finally{S(!1)}},[e,r,i]);f.useEffect(()=>{if(!e||!i)return;l();const s=h.channel(`project-files-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"project_files",filter:`project_type=eq.${e}`},g=>{w.debug("Realtime event",{eventType:g.eventType}),_(c=>{var v;const{eventType:p,new:U,old:x}=g;if(p==="INSERT")return[U,...c];if(p==="DELETE"){const I=(x==null?void 0:x.id)||((v=g.old)==null?void 0:v.id);return c.filter($=>$.id!==I)}return p==="UPDATE"?c.map(I=>I.id===U.id?U:I):c})}).subscribe();return()=>{h.removeChannel(s)}},[e,i,l]);const u=f.useCallback(async({file:s,uploadedBy:g,fieldLabel:c=null})=>{if(!(!s||!e))try{R(!0),n(null);const p=s.name.split(".").pop(),U=`${z()}.${p}`,x=`${e}/${U}`,{error:v}=await h.storage.from("project-files").upload(x,s);if(v)throw v;const{data:I,error:$}=await h.from("project_files").insert([{project_type:e,prospect_id:r||null,organization_id:a||null,file_name:s.name,file_type:s.type,file_size:s.size,storage_path:x,uploaded_by:g||null,field_label:c}]).select().single();if($)throw $;return I}catch(p){throw w.error("Error uploading file:",p),n(p.message),p}finally{R(!1)}},[e,r]),d=f.useCallback(async(s,g)=>{if(!(!s||!g))try{t(!0),n(null);const{error:c}=await h.storage.from("project-files").remove([g]);if(c)throw c;const{error:p}=await h.from("project_files").delete().eq("id",s);if(p)throw p}catch(c){throw w.error("Error deleting file:",c),n(c.message),c}finally{t(!1)}},[]);return{files:E,loading:F,uploading:y,deleting:q,error:m,uploadFile:u,deleteFile:d,refetch:l}}export{T as a,M as u};
