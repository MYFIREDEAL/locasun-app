import{c as Ee,r as d,j as e,$ as j,W as ze,B as T,ax as ne,f as Ie,g as Le,b2 as ae,N as te,U as Te,ab as Z,a0 as De,b3 as de,b4 as Ve,b5 as re,b6 as Je,b7 as Be,a6 as $e,aT as ce,a1 as W,R as Pe,_ as Ue,X as le,aM as Ge,a9 as oe,S as Ke,t as He,v as Xe,w as We,x as Ze,ay as Qe,aI as Ye,Z as ie,P as es,b8 as ss,O as ts,T as as,L as M,b9 as rs,ba as ns,bb as ls,s as H}from"./index-12ff6558.js";import{d as is,b as cs,g as je,e as os,v as ds,P as _e,f as xs,h as ms,i as us,j as gs,S as Ne,a as ps,F as ve}from"./useSupabaseWorkflowModuleTemplates-3106a9f3.js";import{i as hs}from"./workflowV2Config-f801420c.js";import{R as ye}from"./rocket-65760c42.js";import{D as fs}from"./download-1a29af9e.js";const we=Ee("BookOpen",[["path",{d:"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z",key:"vv98re"}],["path",{d:"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",key:"1cyq3y"}]]),xe=Ee("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);function bs({moduleId:t,projectType:x,prospectId:l,actionConfig:r,availableForms:g=[],availableTemplates:b=[],className:z}){var S;const[k,G]=d.useState(!1),[i,R]=d.useState(null),[K,_]=d.useState(!1),[V,E]=d.useState(null),[h,F]=d.useState(!1),[C,q]=d.useState(null),B=l||"mock-prospect-"+Date.now().toString(36),u=d.useMemo(()=>hs(),[]),O=d.useMemo(()=>l&&!l.startsWith("mock-"),[l]),I=d.useMemo(()=>!(!r||!r.actionType||!r.targetAudience),[r]),o=d.useMemo(()=>i?u?O?i.actionType==="SIGNATURE"&&!(i.templateIds||[]).length?{canExecute:!1,reason:"SÃ©lectionnez un template pour gÃ©nÃ©rer le contrat"}:is(i):{canExecute:!1,reason:"prospectId rÃ©el requis"}:{canExecute:!1,reason:"Flag EXECUTION_FROM_V2 dÃ©sactivÃ©"}:{canExecute:!1,reason:"GÃ©nÃ©rez d'abord un ActionOrder"},[i,u,O]),$=d.useCallback(m=>m.map(y=>{const J=g.find(X=>X.id===y);return J?J.name:y}),[g]),A=d.useCallback(m=>m.map(y=>{const J=b.find(X=>X.id===y);return J?J.name:y}),[b]),P=d.useCallback(()=>{E(null),_(!1);try{const m=cs({moduleId:t,projectType:x,prospectId:B,actionConfig:r,message:`Action ${r.actionType} gÃ©nÃ©rÃ©e par V2 Simulator`});R(m),G(!0),console.log("[V2 Simulator] ActionOrder gÃ©nÃ©rÃ©",m)}catch(m){E(m.message),R(null)}},[t,x,B,r]),a=d.useCallback(()=>{if(!i)return;const m=je(i);navigator.clipboard.writeText(m).then(()=>{_(!0),setTimeout(()=>_(!1),2e3)})},[i]),n=d.useCallback(async()=>{if(i&&o.canExecute){F(!0),q(null),E(null);try{const m={...i,_meta:{...i._meta,isSimulation:!1}};console.log("[V2 Simulator] ðŸš€ ExÃ©cution V2â†’V1",m);const y=await os(m);q(y),console.log("[V2 Simulator] RÃ©sultat exÃ©cution",y)}catch(m){E(`Erreur exÃ©cution: ${m.message}`),q({success:!1,status:"error",message:m.message})}finally{F(!1)}}},[i,o]),p=d.useMemo(()=>i?ds(i):null,[i]);return e.jsxs("div",{className:j("border rounded-lg overflow-hidden",z),children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-blue-50 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-5 w-5 text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:u?"ActionOrder V2â†’V1":"Simulation ActionOrder"}),e.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium bg-purple-100 text-purple-700 rounded",children:"V2"}),u&&e.jsxs("span",{className:"px-1.5 py-0.5 text-[10px] font-medium bg-green-100 text-green-700 rounded flex items-center gap-1",children:[e.jsx(ye,{className:"h-3 w-3"}),"EXEC ON"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(T,{size:"sm",variant:I?"default":"outline",onClick:P,disabled:!I,className:j("gap-1.5",I&&"bg-purple-600 hover:bg-purple-700"),children:[e.jsx(ne,{className:"h-4 w-4"}),"Simuler"]}),u&&i&&e.jsx(T,{size:"sm",variant:o.canExecute?"default":"outline",onClick:n,disabled:!o.canExecute||h,className:j("gap-1.5",o.canExecute&&"bg-green-600 hover:bg-green-700"),title:o.canExecute?"ExÃ©cuter via V1":o.reason,children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"ExÃ©cution..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"h-4 w-4"}),"ExÃ©cuter"]})}),i&&e.jsx("button",{onClick:()=>G(!k),className:"p-1.5 hover:bg-white/50 rounded transition-colors",children:k?e.jsx(Ie,{className:"h-4 w-4 text-gray-500"}):e.jsx(Le,{className:"h-4 w-4 text-gray-500"})})]})]}),V&&e.jsx("div",{className:"p-3 bg-red-50 border-b border-red-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsx("span",{children:V})]})}),(i==null?void 0:i.actionType)==="SIGNATURE"&&!((S=i.templateIds)!=null&&S.length)&&e.jsx("div",{className:"p-3 bg-amber-50 border-b border-amber-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-700",children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"âš ï¸ SÃ©lectionnez un template pour gÃ©nÃ©rer le contrat"})]})}),i&&k&&e.jsxs("div",{className:"p-3 space-y-4 bg-white",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-2 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:"Action"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[i.actionType==="FORM"?e.jsx(te,{className:"h-4 w-4 text-blue-600"}):e.jsx(_e,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:i.actionType})]})]}),e.jsxs("div",{className:"p-2 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:"Cible"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Te,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:i.target})]})]})]}),i.formIds.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:["Formulaires (",i.formIds.length,")"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:$(i.formIds).map((m,y)=>e.jsx("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs",children:m},y))})]}),i.actionType==="SIGNATURE"&&i.templateIds.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:["Templates contrat (",i.templateIds.length,")"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:A(i.templateIds).map((m,y)=>e.jsx("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs",children:m},y))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase mb-1",children:"Message"}),e.jsxs("div",{className:"text-sm text-gray-600 italic",children:['"',i.message,'"']})]}),e.jsxs("div",{className:"flex gap-4 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Gestion: "}),e.jsx("span",{className:"font-medium text-gray-700",children:i.managementMode==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"VÃ©rification: "}),e.jsx("span",{className:"font-medium text-gray-700",children:i.verificationMode==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"})]})]}),p&&!p.valid&&e.jsxs("div",{className:"p-2 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-amber-700",children:[e.jsx(ae,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"font-medium",children:"Avertissements:"})]}),e.jsx("ul",{className:"mt-1 text-xs text-amber-600 list-disc list-inside",children:p.errors.map((m,y)=>e.jsx("li",{children:m},y))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"text-[10px] font-medium text-gray-400 uppercase",children:"JSON ActionOrder"}),e.jsx(T,{size:"sm",variant:"ghost",onClick:a,className:"h-6 px-2 text-xs gap-1",children:K?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"text-green-600",children:"CopiÃ©"})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"h-3 w-3"}),"Copier"]})})]}),e.jsx("pre",{className:"p-2 bg-gray-900 text-gray-100 rounded-lg text-[10px] overflow-x-auto max-h-48 overflow-y-auto",children:je(i)})]}),C&&e.jsxs("div",{className:j("p-3 rounded-lg border",C.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[C.success?e.jsx(Z,{className:"h-4 w-4 text-green-600"}):e.jsx(ae,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:j("text-sm font-medium",C.success?"text-green-700":"text-red-700"),children:C.success?"ExÃ©cution rÃ©ussie":"Ã‰chec exÃ©cution"}),e.jsx("span",{className:j("px-1.5 py-0.5 text-[10px] font-medium rounded",C.status==="executed"&&"bg-green-100 text-green-700",C.status==="simulated"&&"bg-purple-100 text-purple-700",C.status==="blocked"&&"bg-amber-100 text-amber-700",C.status==="error"&&"bg-red-100 text-red-700"),children:C.status.toUpperCase()})]}),e.jsx("p",{className:"text-xs text-gray-600",children:C.message}),C.data&&e.jsx("pre",{className:"mt-2 p-2 bg-white/50 rounded text-[10px] text-gray-500 overflow-x-auto",children:JSON.stringify(C.data,null,2)})]}),e.jsx("div",{className:"pt-2 border-t text-center",children:u?e.jsxs("span",{className:"text-[10px] text-green-600 flex items-center justify-center gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),"Mode exÃ©cution V2â†’V1 activÃ© (flag ON)"]}):e.jsx("span",{className:"text-[10px] text-gray-400",children:"âš ï¸ Simulation pure â€” Aucune exÃ©cution V1"})})]}),!i&&!V&&e.jsx("div",{className:"p-4 text-center text-xs text-gray-400",children:I?'Cliquez sur "Simuler" pour gÃ©nÃ©rer un ActionOrder':"Configurez d'abord le type d'action et la cible"})]})}const js=[{id:"form_approved",label:"Formulaire validÃ©",icon:"ðŸ“",description:"L'Ã©tape est terminÃ©e quand un formulaire est approuvÃ©"},{id:"signature",label:"Signature complÃ©tÃ©e",icon:"âœï¸",description:"L'Ã©tape est terminÃ©e quand le contrat est signÃ©"},{id:"checklist",label:"Checklist complÃ©tÃ©e",icon:"âœ…",description:"L'Ã©tape est terminÃ©e quand toutes les cases sont cochÃ©es"},{id:"ia_confirmation",label:"Objectif atteint par Ã©change IA",icon:"âœ¨",description:"L'Ã©tape est terminÃ©e quand l'IA confirme l'objectif atteint"}],U=({icon:t,label:x,readOnly:l=!1,required:r=!1})=>e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[t&&e.jsx(t,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:x}),r&&e.jsx("span",{className:"text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded",children:"Requis"}),l&&e.jsx("span",{className:"text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded",children:"Lecture seule"})]}),Ce=({value:t,onChange:x,placeholder:l,disabled:r=!1})=>e.jsx("input",{type:"text",value:t,onChange:g=>x(g.target.value),placeholder:l,disabled:r,className:j("w-full px-3 py-2 text-sm border rounded-lg","focus:ring-2 focus:ring-blue-500 focus:border-blue-500",r&&"bg-gray-50 text-gray-500 cursor-not-allowed")}),Se=({value:t,onChange:x,placeholder:l,rows:r=5,disabled:g=!1})=>e.jsx("textarea",{value:t,onChange:b=>x(b.target.value),placeholder:l,rows:r,disabled:g,className:j("w-full px-3 py-2 text-sm border rounded-lg resize-y","focus:ring-2 focus:ring-blue-500 focus:border-blue-500",g&&"bg-gray-50 text-gray-500 cursor-not-allowed")}),Ns=({action:t})=>{const x=ls(t);return e.jsxs("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-full text-xs",title:x.description,children:[e.jsx("span",{children:x.icon}),e.jsx("span",{children:x.label})]})},vs=({selected:t,onChange:x,targets:l})=>e.jsx("div",{className:"grid grid-cols-3 gap-3",children:l.map(r=>{const b=(Array.isArray(t)?t[0]:t)===r.id;return e.jsxs("label",{className:j("flex items-center justify-center gap-2 px-4 py-3 rounded-lg border cursor-pointer transition-all",b?"bg-blue-50 border-blue-300 text-blue-700":"bg-white border-gray-200 text-gray-600 hover:border-gray-300"),children:[e.jsx("input",{type:"radio",name:"targetAudience",value:r.id,checked:b,onChange:()=>x(r.id),className:"sr-only"}),e.jsx("span",{className:"text-lg",children:r.icon}),e.jsx("span",{className:"text-sm font-medium",children:r.label}),b&&e.jsx(W,{className:"h-4 w-4 text-blue-600"})]},r.id)})}),ys=({selected:t,onChange:x,actionTypes:l})=>e.jsx("div",{className:"flex gap-3",children:l.map(r=>{const g=t===r.id,b=r.isMock;return e.jsxs("label",{className:j("flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-all flex-1 relative",g?"bg-purple-50 border-purple-300 text-purple-700":"bg-white border-gray-200 text-gray-600 hover:border-gray-300",b&&"opacity-75"),children:[e.jsx("input",{type:"radio",name:"actionType",value:r.id,checked:g,onChange:()=>x(r.id),className:"sr-only"}),e.jsx("span",{className:"text-lg",children:r.icon}),e.jsx("span",{className:"text-sm font-medium",children:r.label}),b&&e.jsx("span",{className:"text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-medium",children:"BientÃ´t"}),g&&e.jsx(W,{className:"h-4 w-4 text-purple-600"})]},r.id)})}),Ae=({selected:t=[],onChange:x,forms:l=[]})=>{if(l.length===0)return e.jsx("div",{className:"p-3 bg-gray-50 border border-dashed rounded-lg text-sm text-gray-400 italic",children:"Aucun formulaire disponible. Chargez les formulaires depuis Supabase."});const r=Array.isArray(t)?t:t?[t]:[],g=r.length>0?r[0]:null;return e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto border rounded-lg p-2",children:l.map(b=>{const z=g===b.id;return e.jsxs("label",{className:j("flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer transition-colors",z?"bg-blue-50 border border-blue-200":"hover:bg-gray-50"),children:[e.jsx("input",{type:"radio",name:"formSelection",checked:z,onChange:()=>{x([b.id])},className:"text-blue-600 focus:ring-blue-500"}),e.jsx(te,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm",children:b.name})]},b.id)})})},ws=({selected:t,onChange:x,templates:l=[]})=>l.length===0?e.jsx("div",{className:"p-3 bg-gray-50 border border-dashed rounded-lg text-sm text-gray-400 italic",children:"Aucun template disponible. Chargez les templates depuis Supabase."}):e.jsxs("select",{value:t||"",onChange:r=>x(r.target.value||null),className:"w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner un template --"}),l.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),ke=({label:t,icon:x,selected:l,onChange:r,modes:g})=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[x&&e.jsx(x,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-600",children:t})]}),e.jsx("div",{className:"flex gap-2",children:g.map(b=>{const z=l===b.id;return e.jsxs("button",{type:"button",onClick:()=>r(b.id),className:j("flex items-center gap-1.5 px-3 py-1.5 rounded-lg border text-sm transition-all",z?"bg-indigo-50 border-indigo-300 text-indigo-700":"bg-white border-gray-200 text-gray-600 hover:border-gray-300"),children:[e.jsx("span",{children:b.icon}),e.jsx("span",{children:b.label})]},b.id)})})]}),Cs=({selected:t=[],onChange:x})=>{const l=[{id:"prospect_info",label:"Infos Prospect",icon:"ðŸ‘¤"},{id:"contract_history",label:"Historique Contrats",icon:"ðŸ“œ"},{id:"forms_submitted",label:"Formulaires Soumis",icon:"ðŸ“"},{id:"chat_history",label:"Historique Chat",icon:"ðŸ’¬"},{id:"documents",label:"Documents",icon:"ðŸ“"},{id:"client_projects_history",label:"Historique projets (client)",icon:"ðŸ—‚ï¸"},{id:"commercial_activity",label:"ActivitÃ© commerciaux",icon:"ðŸ“ž"},{id:"partner_activity",label:"ActivitÃ© partenaires",icon:"ðŸ¤"}];return e.jsx("div",{className:"flex flex-wrap gap-2",children:l.map(r=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs border bg-green-50 border-green-300 text-green-700 cursor-default",title:"ActivÃ© par dÃ©faut (lecture seule)",children:[e.jsx("span",{children:r.icon}),e.jsx("span",{children:r.label})]},r.id))})},Ss=({isComplete:t,details:x})=>e.jsx("div",{className:j("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium",t?"bg-green-100 text-green-700":"bg-orange-100 text-orange-700"),title:x,children:t?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Config complÃ¨te"]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"h-3.5 w-3.5"}),"Config incomplÃ¨te"]})}),As=({selected:t,onChange:x})=>e.jsx("div",{className:"space-y-2",children:js.map(l=>{const r=t===l.id;return e.jsxs("label",{className:j("flex items-start gap-3 p-3 rounded-xl border cursor-pointer transition-all",r?"bg-green-50 border-green-300 shadow-sm":"bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50"),children:[e.jsx("input",{type:"radio",name:"completionTrigger",value:l.id,checked:r,onChange:()=>x(l.id),className:"sr-only"}),e.jsx("span",{className:"text-xl mt-0.5",children:l.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:j("text-sm font-medium",r?"text-green-800":"text-gray-700"),children:l.label}),e.jsx("p",{className:j("text-xs mt-0.5",r?"text-green-600":"text-gray-500"),children:l.description})]}),r&&e.jsx(W,{className:"h-5 w-5 text-green-600 flex-shrink-0 mt-0.5"})]},l.id)})}),ks=({selectedFormIds:t=[],availableForms:x=[],requiredFields:l=[],reminderConfig:r={enabled:!1,delayDays:1},onRequiredFieldsChange:g,onReminderConfigChange:b})=>{const[z,k]=d.useState(!1),[G,i]=d.useState(!1),[R,K]=d.useState([]),[_,V]=d.useState({enabled:!1,delayDays:1,maxRemindersBeforeTask:3}),E=d.useMemo(()=>!t||t.length===0?null:x.find(O=>O.id===t[0]),[t,x]),h=d.useMemo(()=>E!=null&&E.fields?E.fields:[],[E]),F=()=>{K(l||[]),k(!0)},C=()=>{V({enabled:r.enabled||!1,delayDays:r.delayDays||1,maxRemindersBeforeTask:r.maxRemindersBeforeTask||3}),i(!0)},q=u=>{K(O=>O.includes(u)?O.filter(I=>I!==u):[...O,u])},B=()=>{g(R),k(!1),M({title:"âœ… Champs requis enregistrÃ©s",description:`${R.length} champ(s) obligatoire(s)`})};return!t||t.length===0?null:e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-start",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center p-6 bg-blue-50 border border-blue-200 rounded-lg min-h-[120px]",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("p",{className:"text-5xl font-bold text-blue-600",children:l.length}),e.jsx("p",{className:"text-sm font-medium text-blue-900 mt-2",children:l.length>1?"champs requis":l.length===1?"champ requis":"Aucun champ requis"})]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:F,className:"border-blue-300 text-blue-700 hover:bg-blue-100",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"DÃ©finir"]})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center p-6 bg-purple-50 border border-purple-200 rounded-lg min-h-[120px]",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("p",{className:"text-5xl font-bold text-purple-600",children:r.enabled?r.maxRemindersBeforeTask||3:0}),e.jsx("p",{className:"text-sm font-medium text-purple-900 mt-2",children:r.enabled?`relance${(r.maxRemindersBeforeTask||3)>1?"s":""}`:"Relance dÃ©sactivÃ©e"})]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:C,className:"border-purple-300 text-purple-700 hover:bg-purple-100",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"Configurer"]})]}),z&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Champs requis pour validation"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Formulaire : ",e.jsx("span",{className:"font-medium",children:E==null?void 0:E.name})]})]}),e.jsx("button",{onClick:()=>k(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(le,{className:"h-5 w-5"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:h.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(xe,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),e.jsx("p",{children:"Aucun champ disponible dans ce formulaire"})]}):e.jsx("div",{className:"space-y-2",children:h.map(u=>{const O=R.includes(u.id);return e.jsxs("label",{className:j("flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all",O?"bg-blue-50 border-blue-300":"bg-white border-gray-200 hover:bg-gray-50 hover:border-gray-300"),children:[e.jsx("input",{type:"checkbox",checked:O,onChange:()=>q(u.id),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:j("text-sm font-medium",O?"text-blue-900":"text-gray-700"),children:u.label}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[u.type," ",u.required&&"â€¢ Obligatoire dans le formulaire"]})]}),O&&e.jsx(W,{className:"h-5 w-5 text-blue-600"})]},u.id)})})}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[R.length," champ(s) sÃ©lectionnÃ©(s)"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{variant:"outline",size:"sm",onClick:()=>k(!1),children:"Annuler"}),e.jsxs(T,{size:"sm",onClick:B,className:"bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Valider"]})]})]})]})}),G&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Configuration de la relance"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Si le formulaire n'est pas validÃ©"})]}),e.jsx("button",{onClick:()=>i(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(le,{className:"h-5 w-5"})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-900",children:"Activer la relance"}),e.jsx("p",{className:"text-xs text-purple-600 mt-0.5",children:"Relancer automatiquement le client"})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_.enabled,onChange:u=>V({..._,enabled:u.target.checked}),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"})]})]}),_.enabled&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"DÃ©lai de relance"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[1,2,3,4].map(u=>e.jsxs("button",{type:"button",onClick:()=>V({..._,delayDays:u}),className:j("px-3 py-2 text-sm font-medium rounded border transition-all",_.delayDays===u?"bg-purple-600 text-white border-purple-700":"bg-white text-purple-700 border-purple-300 hover:bg-purple-50"),children:["J+",u]},u))}),e.jsxs("p",{className:"text-xs text-purple-600 mt-2",children:["â±ï¸ Relance envoyÃ©e J+",_.delayDays," si formulaire incomplet"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nombre de relances avant crÃ©ation de tÃ¢che"}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:[1,2,3,4,5].map(u=>e.jsx("button",{type:"button",onClick:()=>V({..._,maxRemindersBeforeTask:u}),className:j("px-3 py-2 text-sm font-medium rounded border transition-all",_.maxRemindersBeforeTask===u?"bg-orange-600 text-white border-orange-700":"bg-white text-orange-700 border-orange-300 hover:bg-orange-50"),children:u},u))}),e.jsxs("p",{className:"text-xs text-orange-600 mt-2",children:["ðŸ“‹ AprÃ¨s ",_.maxRemindersBeforeTask," relance(s), une tÃ¢che sera crÃ©Ã©e pour le commercial"]})]})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex items-center justify-end gap-2",children:[e.jsx(T,{variant:"outline",size:"sm",onClick:()=>i(!1),children:"Annuler"}),e.jsxs(T,{size:"sm",onClick:()=>{b(_),i(!1)},className:"bg-purple-600 hover:bg-purple-700 text-white",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Valider"]})]})]})})]})},Es=({moduleId:t,projectType:x,organizationId:l,uploadedBy:r})=>{const g=d.useRef(null),[b,z]=d.useState([]),[k,G]=d.useState([]),[i,R]=d.useState(!1),[K,_]=d.useState(!1),[V,E]=d.useState(!1),[h,F]=d.useState(new Set),C=`ia-knowledge:${x}`,q=async()=>{if(!(!x||!t||!l)){R(!0);try{const{data:a,error:n}=await H.from("project_files").select("*").eq("organization_id",l).like("field_label",`${C}:%`).is("prospect_id",null).contains("module_ids",[t]).order("created_at",{ascending:!1});if(n)throw n;z(a||[])}catch(a){console.error("Error loading IA knowledge files:",a)}finally{R(!1)}}},B=async()=>{if(!(!x||!l))try{const{data:a,error:n}=await H.from("project_files").select("*").eq("organization_id",l).like("field_label",`${C}:%`).is("prospect_id",null).order("created_at",{ascending:!1});if(n)throw n;G(a||[]);const p=new Set((a||[]).filter(S=>{var m;return(m=S.module_ids)==null?void 0:m.includes(t)}).map(S=>S.id));F(p)}catch(a){console.error("Error loading all project files:",a)}};d.useEffect(()=>{q()},[x,t,l]);const u=()=>{B(),E(!0)},O=a=>{F(n=>{const p=new Set(n);return p.has(a)?p.delete(a):p.add(a),p})},I=async()=>{var a;try{for(const n of k){const p=h.has(n.id),S=(a=n.module_ids)==null?void 0:a.includes(t);if(console.log("[Library] File:",n.file_name,"selected:",p,"hasModule:",S),p&&!S){const m=[...n.module_ids||[],t];console.log("[Library] Adding moduleId:",t,"to",n.file_name,"â†’",m);const{error:y}=await H.from("project_files").update({module_ids:m}).eq("id",n.id);y&&console.error("[Library] Update error:",y)}else if(!p&&S){const m=(n.module_ids||[]).filter(J=>J!==t);console.log("[Library] Removing moduleId:",t,"from",n.file_name,"â†’",m);const{error:y}=await H.from("project_files").update({module_ids:m}).eq("id",n.id);y&&console.error("[Library] Update error:",y)}}M({title:"âœ… SÃ©lection enregistrÃ©e",description:"Les documents ont Ã©tÃ© liÃ©s Ã  cette Ã©tape.",duration:3e3}),E(!1),q()}catch(n){M({title:"âŒ Erreur",description:n.message,variant:"destructive"})}},o=async a=>{var p;const n=(p=a.target.files)==null?void 0:p[0];if(n){if(!l){M({title:"âŒ Erreur",description:"Organization ID manquant",variant:"destructive"});return}_(!0);try{const S=n.name.split(".").pop(),m=`${crypto.randomUUID()}.${S}`,y=`ia-knowledge/${x}/${m}`,{error:J}=await H.storage.from("project-files").upload(y,n);if(J)throw J;const{error:X}=await H.from("project_files").insert({project_type:x,prospect_id:null,organization_id:l,file_name:n.name,file_type:n.type,file_size:n.size,storage_path:y,uploaded_by:r||null,field_label:`${C}:${t}`,module_ids:[t]});if(X)throw X;M({title:"âœ… Document IA ajoutÃ©",description:`${n.name} est maintenant disponible pour l'IA Ã  cette Ã©tape.`,duration:3e3}),q()}catch(S){M({title:"âŒ Erreur upload",description:S.message,variant:"destructive"})}finally{_(!1),g.current&&(g.current.value="")}}},$=async a=>{if(confirm(`Supprimer "${a.file_name}" de la base de connaissance IA ?`))try{await H.storage.from("project-files").remove([a.storage_path]),await H.from("project_files").delete().eq("id",a.id),M({title:"ðŸ—‘ï¸ Document supprimÃ©",description:`${a.file_name} n'est plus accessible Ã  l'IA.`,duration:3e3}),q()}catch(n){M({title:"âŒ Erreur suppression",description:n.message,variant:"destructive"})}},A=async a=>{try{const{data:n,error:p}=await H.storage.from("project-files").download(a.storage_path);if(p)throw p;const S=URL.createObjectURL(n),m=document.createElement("a");m.href=S,m.download=a.file_name,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(S)}catch(n){M({title:"âŒ Erreur tÃ©lÃ©chargement",description:n.message,variant:"destructive"})}},P=a=>a?a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`:"";return!x||!t?e.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700 text-center",children:"SÃ©lectionnez un projet et une Ã©tape pour gÃ©rer les documents IA."}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:g,type:"file",onChange:o,className:"hidden",accept:".pdf,.doc,.docx,.xls,.xlsx,.txt,.md"}),e.jsx(T,{type:"button",variant:"outline",size:"sm",onClick:()=>{var a;return(a=g.current)==null?void 0:a.click()},disabled:K||!l,className:"flex items-center gap-2 border-purple-300 text-purple-700 hover:bg-purple-50",children:K?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"}),"Upload..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ts,{className:"h-4 w-4"}),"Nouveau"]})}),e.jsxs(T,{type:"button",variant:"outline",size:"sm",onClick:u,disabled:!l,className:"flex items-center gap-2 border-blue-300 text-blue-700 hover:bg-blue-50",children:[e.jsx(ps,{className:"h-4 w-4"}),"BibliothÃ¨que"]})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900",children:["ðŸ“š BibliothÃ¨que - ",x]}),e.jsx("p",{className:"text-xs text-gray-500",children:"SÃ©lectionnez les documents Ã  utiliser sur cette Ã©tape"})]}),e.jsx(T,{variant:"ghost",size:"icon",onClick:()=>E(!1),className:"h-8 w-8",children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:k.length===0?e.jsxs("div",{className:"text-center text-gray-400 py-8",children:["Aucun document dans la bibliothÃ¨que.",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:`Uploadez d'abord un document via "Nouveau".`})]}):e.jsx("div",{className:"space-y-2",children:k.map(a=>{var S;const n=h.has(a.id),p=((S=a.module_ids)==null?void 0:S.length)||0;return e.jsxs("div",{onClick:()=>O(a.id),className:`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${n?"bg-blue-50 border-2 border-blue-400":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("div",{className:`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ${n?"bg-blue-500 border-blue-500":"border-gray-300"}`,children:n&&e.jsx(Z,{className:"h-3 w-3 text-white"})}),e.jsx(ve,{className:"h-5 w-5 text-purple-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",children:a.file_name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[P(a.file_size)," â€¢ UtilisÃ© sur ",p," Ã©tape",p>1?"s":""]})]})]},a.id)})})}),e.jsxs("div",{className:"p-4 border-t flex items-center justify-end gap-2",children:[e.jsx(T,{variant:"outline",size:"sm",onClick:()=>E(!1),children:"Annuler"}),e.jsxs(T,{size:"sm",onClick:I,className:"bg-blue-600 hover:bg-blue-700",children:["Valider (",h.size," sÃ©lectionnÃ©",h.size>1?"s":"",")"]})]})]})}),i?e.jsx("div",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):b.length===0?e.jsx("div",{className:"text-sm text-gray-400 italic",children:"Aucun document IA pour cette Ã©tape."}):e.jsx("div",{className:"space-y-2",children:b.map(a=>{var n,p;return e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-white border border-purple-100 rounded-lg hover:bg-purple-50/50 transition-colors",children:[e.jsx(ve,{className:"h-5 w-5 text-purple-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",children:a.file_name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[P(a.file_size)," â€¢ ",((n=a.module_ids)==null?void 0:n.length)||1," Ã©tape",(((p=a.module_ids)==null?void 0:p.length)||1)>1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-gray-500 hover:text-purple-600",onClick:()=>A(a),title:"TÃ©lÃ©charger",children:e.jsx(fs,{className:"h-4 w-4"})}),e.jsx(T,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-gray-500 hover:text-red-600",onClick:()=>$(a),title:"Supprimer",children:e.jsx(as,{className:"h-4 w-4"})})]})]},a.id)})})]})},Ms=({moduleId:t,moduleName:x,isReadOnly:l=!0,prospectId:r=null,projectType:g=null,availableForms:b=[],availableTemplates:z=[],templateOps:k={}})=>{var he,fe;const{loadTemplate:G,saveTemplate:i,isPersisted:R=!1,isSaving:K=!1,loading:_=!1,organizationId:V=null}=k,{partners:E=[]}=Ve(V),[h,F]=d.useState(null),[C,q]=d.useState(null),[B,u]=d.useState(!1),[O,I]=d.useState(!1),[o,$]=d.useState(re),[A,P]=d.useState([]),[a,n]=d.useState(0),p=d.useRef(!1),S=d.useMemo(()=>Je(t,o),[t,o]);d.useEffect(()=>{if(t){const s=Be(t);F({...s}),q({...s}),u(!1),I(!1);const c=$e(t);$(c),P([]),n(0)}},[t]),d.useEffect(()=>{(async()=>{var c,N;if(t&&g&&G)try{const w=await G(g,t),v=w==null?void 0:w.configJson;if(v){if(F(f=>({...f,...v})),q(f=>({...f,...v})),v.actionConfig&&$(f=>({...f,...v.actionConfig})),v.actions&&Array.isArray(v.actions)&&v.actions.length>0){P(v.actions.map(D=>({order:D.order,status:D.status||"pending",config:D.config||{},actionConfig:D.actionConfig||{...re}}))),n(0);const f=v.actions[0];f!=null&&f.config&&F(D=>({...D,...f.config})),f!=null&&f.actionConfig&&$(D=>({...D,...f.actionConfig}))}((c=v.actions)==null?void 0:c.length)>1&&v.actions.forEach((f,D)=>{var Q,Y,ee,se;console.log(`[V2 Config Tab] DB Action ${D}:`,{formIds:(Q=f.actionConfig)==null?void 0:Q.allowedFormIds,requiredFields:(Y=f.actionConfig)==null?void 0:Y.requiredFields,target:(ee=f.actionConfig)==null?void 0:ee.targetAudience,type:(se=f.actionConfig)==null?void 0:se.actionType})}),console.log("[V2 Config Tab] Loaded config from Supabase:",{moduleId:t,projectType:g,hasActionConfig:!!v.actionConfig,actionsCount:((N=v.actions)==null?void 0:N.length)||0})}}catch(w){console.warn("[V2 Config Tab] No DB config found, using in-memory:",w.message)}})()},[t,g,G]),d.useEffect(()=>{h&&C&&(u(JSON.stringify(h)!==JSON.stringify(C)),B&&I(!1))},[h,C]),d.useEffect(()=>{h&&A.length===0&&(P([{order:1,status:"pending",config:JSON.parse(JSON.stringify(h)),actionConfig:JSON.parse(JSON.stringify(o))}]),n(0))},[h,A.length]);const m=s=>{var N,w;if(s===a||s<0||s>=A.length)return;p.current=!0,P(v=>{const f=[...v];return f[a]={...f[a],config:JSON.parse(JSON.stringify(h)),actionConfig:JSON.parse(JSON.stringify(o))},f});const c=A[s];c?(console.log(`[V2 Config Tab] switchToAction(${s}):`,{targetFormIds:(N=c.actionConfig)==null?void 0:N.allowedFormIds,targetReqFields:(w=c.actionConfig)==null?void 0:w.requiredFields,leavingFormIds:o==null?void 0:o.allowedFormIds,leavingReqFields:o==null?void 0:o.requiredFields}),F(JSON.parse(JSON.stringify(c.config))),$(JSON.parse(JSON.stringify(c.actionConfig))),n(s),setTimeout(()=>{p.current=!1},0),setTimeout(()=>pe(),100)):p.current=!1},y=()=>{p.current=!0;const s={...A[a],config:JSON.parse(JSON.stringify(h)),actionConfig:JSON.parse(JSON.stringify(o))},c=A.length+1,N={order:c,status:"pending",config:JSON.parse(JSON.stringify(s.config)),actionConfig:{...re}};P(v=>{const f=[...v];return f[a]=s,[...f,N]});const w=A.length;n(w),F(JSON.parse(JSON.stringify(N.config))),$({...re}),setTimeout(()=>{p.current=!1},0),setTimeout(()=>pe(),100),M({title:`âž• Action ${c} ajoutÃ©e`,description:`Ordre : ${c} â€” En attente de validation de l'action ${c-1}`,duration:3e3})},J=s=>{if(s===0)return!1;const c=A[s-1];return(c==null?void 0:c.status)!=="validated"},X=s=>{if(A.length<=1)return;p.current=!0;const c=A.filter((v,f)=>f!==s).map((v,f)=>({...v,order:f+1}));P(c);const N=s>=c.length?c.length-1:s;n(N);const w=c[N];w&&(F(JSON.parse(JSON.stringify(w.config))),$(JSON.parse(JSON.stringify(w.actionConfig)))),setTimeout(()=>{p.current=!1},0),M({title:"ðŸ—‘ï¸ Action supprimÃ©e",description:`${c.length} action(s) restante(s)`,duration:3e3})},me=(s,c)=>{F(N=>({...N,[s]:c}))},ue=(s,c)=>{F(N=>({...N,buttonLabels:{...N.buttonLabels,[s]:c}}))},Fe=()=>{rs(t,h),q({...h}),u(!1),I(!0),M({title:"âœ… Configuration sauvegardÃ©e",description:"Modifications appliquÃ©es (session uniquement)",duration:3e3}),console.log("[V2 Config Tab] Saved (in-memory)",{moduleId:t,config:h})},Oe=async()=>{if(!i||!g){M({title:"âš ï¸ Persistance non disponible",description:"projectType ou saveTemplate manquant",variant:"destructive",duration:3e3});return}try{const s=A.map((N,w)=>w===a?{...N,config:JSON.parse(JSON.stringify(h)),actionConfig:JSON.parse(JSON.stringify(o))}:N),c={...h,actionConfig:o,actions:s.map(N=>({order:N.order,status:N.status,config:N.config,actionConfig:N.actionConfig}))};await i(g,t,c),M({title:"âœ… Configuration persistÃ©e",description:"Sauvegarde en base rÃ©ussie â€” sera rechargÃ©e au prochain refresh",duration:4e3}),console.log("[V2 Config Tab] Saved to Supabase:",{moduleId:t,projectType:g,fullConfig:c})}catch(s){console.error("[V2 Config Tab] Save to DB failed:",s),M({title:"âŒ Erreur de sauvegarde",description:s.message,variant:"destructive",duration:4e3})}},Re=()=>{F({...C}),u(!1),I(!1)},L=(s,c)=>{$(N=>{const w={...N,[s]:c};return s==="allowedFormIds"&&(w.requiredFields=[],console.log("[V2 Config Tab] Form changed â†’ requiredFields CLEARED")),A.length<=1&&ns(t,w),console.log("[V2 Config Tab] ActionConfig updated:",{field:s,value:c,moduleId:t,actionIndex:a}),w})},Me=s=>{F(c=>({...c,knowledgeKey:s}))},ge=d.useRef(null),pe=()=>{var s;(s=ge.current)==null||s.scrollIntoView({behavior:"smooth",block:"start"})};return h?e.jsxs("div",{className:"space-y-6",ref:ge,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5 text-blue-600"}),"Configuration IA"]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-0.5",children:["Module : ",x||t]})]}),R?e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Configuration persistÃ©e"]}):e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 bg-amber-50 text-amber-700 rounded-full text-xs font-medium",children:[e.jsx(de,{className:"h-3.5 w-3.5"}),"Modifications temporaires"]})]}),e.jsx("div",{className:j("p-3 border rounded-lg",R?"bg-emerald-50 border-emerald-100":"bg-blue-50 border-blue-100"),children:e.jsxs("p",{className:j("text-xs flex items-start gap-2",R?"text-emerald-700":"text-blue-700"),children:[e.jsx(xe,{className:"h-4 w-4 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:R?"Cette configuration est enregistrÃ©e en base. Elle sera rechargÃ©e automatiquement au prochain refresh.":"Cliquez 'Enregistrer en base' pour persister cette configuration. Elle sera rechargÃ©e automatiquement aprÃ¨s refresh."})]})}),A.length>1&&e.jsx("div",{className:"sticky top-0 z-20 -mx-6 px-6 py-4 bg-gradient-to-b from-white to-gray-50/80 backdrop-blur-sm border-b border-gray-200 shadow-sm",children:e.jsx("div",{className:"flex items-center gap-0 overflow-x-auto pb-1",children:A.map((s,c)=>{var D,Q,Y,ee,se,be;const N=J(c),w=a===c,v=s.status==="validated",f=c+1;return e.jsxs(Pe.Fragment,{children:[c>0&&e.jsxs("div",{className:"flex items-center px-1 flex-shrink-0",children:[e.jsx("div",{className:j("w-6 h-0.5 rounded-full",v||((D=A[c-1])==null?void 0:D.status)==="validated"?"bg-emerald-300":"bg-gray-200")}),e.jsx(Ue,{className:j("h-4 w-4 -ml-1 flex-shrink-0",v||((Q=A[c-1])==null?void 0:Q.status)==="validated"?"text-emerald-400":"text-gray-300")})]}),e.jsxs("div",{onClick:()=>m(c),className:j("group relative flex items-center gap-3 px-4 py-3 rounded-xl border-2 transition-all flex-shrink-0 min-w-[200px] max-w-[280px] cursor-pointer",w?"bg-blue-50 border-blue-500 shadow-md shadow-blue-100":v?"bg-emerald-50 border-emerald-300 hover:shadow-sm":N?"bg-gray-50/80 border-gray-200 hover:border-blue-300 hover:shadow-sm":"bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm"),children:[e.jsx("div",{className:j("flex items-center justify-center w-9 h-9 rounded-full text-sm font-bold flex-shrink-0 transition-all",w?"bg-blue-600 text-white shadow-sm":v?"bg-emerald-500 text-white":"bg-gray-100 text-gray-500 group-hover:bg-blue-100 group-hover:text-blue-600"),children:v?e.jsx(Z,{className:"h-4 w-4"}):f}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:j("text-sm font-semibold leading-tight",w?"text-blue-800":v?"text-emerald-700":"text-gray-700"),children:["Action ",f]}),e.jsxs("p",{className:j("text-xs mt-0.5 truncate",w?"text-blue-500":"text-gray-400"),children:[((ee=(Y=s.config)==null?void 0:Y.objective)==null?void 0:ee.slice(0,40))||"Pas d'objectif",((be=(se=s.config)==null?void 0:se.objective)==null?void 0:be.length)>40?"â€¦":""]})]}),e.jsx("button",{type:"button",onClick:qe=>{qe.stopPropagation(),X(c)},className:j("absolute -top-2 -right-2 flex items-center justify-center w-6 h-6 rounded-full bg-white border-2 shadow-sm transition-all","opacity-0 group-hover:opacity-100","border-red-200 text-red-400 hover:bg-red-50 hover:text-red-600 hover:border-red-300"),title:"Supprimer cette action",children:e.jsx(le,{className:"h-3 w-3"})})]})]},c)})})}),e.jsxs("section",{children:[e.jsx(U,{icon:ce,label:"Objectif du module"}),e.jsx(Se,{value:h.objective||"",onChange:s=>me("objective",s),placeholder:"DÃ©crivez l'objectif principal de ce module...",rows:2})]}),e.jsxs("section",{children:[e.jsx(U,{icon:Ge,label:"Instructions IA"}),e.jsx(Se,{value:h.instructions||"",onChange:s=>me("instructions",s),placeholder:"Instructions dÃ©taillÃ©es pour l'IA (comportement, rÃ¨gles, contexte)...",rows:6}),e.jsx("p",{className:"text-xs text-gray-400 mt-1.5",children:"Ces instructions guident le comportement de l'IA dans ce module."})]}),e.jsxs("section",{className:"relative bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 -mx-6 px-6 py-6 border border-purple-200/50 rounded-xl shadow-sm overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-purple-100/30 rounded-full blur-3xl -z-0"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full blur-3xl -z-0"}),e.jsxs("div",{className:"relative z-10 flex items-center justify-between mb-6 pb-4 border-b border-purple-200/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-600 rounded-lg shadow-md",children:e.jsx(ne,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-base font-bold text-gray-800 flex items-center gap-2",children:["Configuration Actions V2",e.jsx("span",{className:"px-2 py-0.5 text-[10px] font-semibold bg-white/80 text-purple-700 rounded-full border border-purple-200 shadow-sm",children:"Phase 3"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"DÃ©finissez les actions automatisÃ©es du workflow"})]})]}),e.jsx(Ss,{isComplete:S.isComplete,details:S.summary})]}),e.jsxs("div",{className:"relative z-10 space-y-5",children:[e.jsxs("div",{children:[e.jsx(U,{icon:Te,label:"Qui rÃ©alise l'action ?"}),e.jsx(vs,{selected:Array.isArray(o.targetAudience)?o.targetAudience[0]:o.targetAudience,onChange:s=>L("targetAudience",s),targets:xs()})]}),e.jsxs("div",{children:[e.jsx(U,{icon:ne,label:"Type d'action autorisÃ©e"}),e.jsx(ys,{selected:o.actionType,onChange:s=>L("actionType",s),actionTypes:ms()})]}),o.actionType==="FORM"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(U,{icon:te,label:"Formulaires autorisÃ©s"}),e.jsx(Ae,{selected:o.allowedFormIds||[],onChange:s=>L("allowedFormIds",s),forms:b})]}),o.targetAudience==="CLIENT"&&e.jsx("div",{children:e.jsx(ks,{selectedFormIds:o.allowedFormIds||[],availableForms:b,requiredFields:o.requiredFields||[],reminderConfig:o.reminderConfig||{enabled:!1,delayDays:1},onRequiredFieldsChange:s=>L("requiredFields",s),onReminderConfigChange:s=>L("reminderConfig",s)})})]}),o.actionType==="SIGNATURE"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(U,{icon:_e,label:"Template de signature",required:!0}),e.jsx(ws,{selected:o.templateId,onChange:s=>L("templateId",s),templates:z}),!o.templateId&&e.jsxs("p",{className:"text-xs text-amber-600 mt-1 flex items-center gap-1",children:[e.jsx("span",{className:"text-amber-500",children:"âš ï¸"}),e.jsx("span",{className:"font-medium",children:"Obligatoire pour gÃ©nÃ©rer le contrat PDF"})]})]}),e.jsxs("div",{children:[e.jsx(U,{icon:te,label:"Formulaire(s) de collecte"}),e.jsx(Ae,{forms:b,selected:o.allowedFormIds||[],onChange:s=>L("allowedFormIds",s)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"SÃ©lectionnez le formulaire contenant les donnÃ©es Ã  injecter dans le contrat"})]})]}),o.targetAudience==="PARTENAIRE"&&e.jsxs("div",{className:"space-y-4 p-4 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsxs("div",{children:[e.jsx(oe,{className:"text-sm font-medium",children:"Partenaire destinataire"}),e.jsxs(Ke,{value:o.partnerId||"",onValueChange:s=>L("partnerId",s),children:[e.jsx(He,{className:"mt-1",children:e.jsx(Xe,{placeholder:"SÃ©lectionner un partenaire..."})}),e.jsx(We,{children:E.map(s=>e.jsx(Ze,{value:s.id,children:s.company_name||s.name},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(oe,{className:"text-sm font-medium",children:"Instructions pour le partenaire"}),e.jsx(Qe,{value:o.instructions||"",onChange:s=>L("instructions",s.target.value),placeholder:"DÃ©crivez la mission...",className:"mt-1 min-h-[100px]"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ye,{id:"is-blocking",checked:o.isBlocking!==!1,onCheckedChange:s=>L("isBlocking",s)}),e.jsx(oe,{htmlFor:"is-blocking",className:"text-sm font-medium cursor-pointer",children:"Mission bloquante (workflow bloquÃ© tant que mission non complÃ©tÃ©e)"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(ke,{label:"Mode de gestion",icon:ie,selected:o.managementMode||"AI",onChange:s=>L("managementMode",s),modes:us()}),e.jsx(ke,{label:"Mode de vÃ©rification",icon:de,selected:o.verificationMode||"HUMAN",onChange:s=>L("verificationMode",s),modes:gs()})]}),e.jsx("div",{className:"border-t border-purple-200/50 my-5"}),e.jsx("div",{children:e.jsx(As,{selected:o.completionTrigger,onChange:s=>L("completionTrigger",s)})}),e.jsx("div",{className:"border-t border-purple-200/50 my-5"}),e.jsx("div",{children:e.jsx(bs,{moduleId:t,projectType:g,prospectId:r,actionConfig:o,availableForms:b,availableTemplates:z})})]})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(U,{icon:te,label:`ðŸ“š Documents IA (Base de connaissances)${A.length>1?` â€” Action ${a+1}`:""}`}),e.jsx(Es,{moduleId:A.length>1?`${t}:action-${a+1}`:t,projectType:g,organizationId:k==null?void 0:k.organizationId,uploadedBy:k==null?void 0:k.uploadedBy})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(U,{icon:we,label:"AccÃ¨s aux donnÃ©es (knowledgeKey)"}),e.jsx(Cs,{selected:h.knowledgeKey,onChange:Me}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"SÃ©lectionnez les sources de donnÃ©es auxquelles l'IA peut accÃ©der."})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(U,{icon:ne,label:"Labels des boutons"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"Bouton PROCEED"}),e.jsx(Ce,{value:((he=h.buttonLabels)==null?void 0:he.proceedLabel)||"",onChange:s=>ue("proceedLabel",s),placeholder:"Valider et continuer"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"Bouton NEED_DATA"}),e.jsx(Ce,{value:((fe=h.buttonLabels)==null?void 0:fe.needDataLabel)||"",onChange:s=>ue("needDataLabel",s),placeholder:"J'ai besoin d'infos"})]})]})]}),e.jsxs("section",{className:"mt-8",children:[e.jsx(U,{icon:we,label:"Actions autorisÃ©es",readOnly:!0}),h.allowedActions&&h.allowedActions.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:h.allowedActions.map(s=>e.jsx(Ns,{action:s},s))}):e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune action configurÃ©e"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"Liste des actions que l'IA peut effectuer (non modifiable en Phase 1)."})]}),e.jsx("div",{className:"pt-2",children:e.jsxs(T,{type:"button",variant:"outline",size:"sm",onClick:y,className:"w-full border-dashed border-2 border-blue-300 text-blue-600 hover:bg-blue-50 hover:border-blue-400",children:[e.jsx(es,{className:"h-4 w-4 mr-1.5"}),"Ajouter une action"]})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[O&&e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"SauvegardÃ© (session)"]}),R&&e.jsxs("span",{className:"text-xs text-emerald-600 flex items-center gap-1 bg-emerald-50 px-2 py-0.5 rounded-full",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"PersistÃ© en base"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(T,{variant:"ghost",size:"sm",onClick:Re,disabled:!B,children:[e.jsx(ss,{className:"h-4 w-4 mr-1"}),"RÃ©initialiser"]}),e.jsxs(T,{size:"sm",onClick:Fe,disabled:!B,className:j(B&&"bg-blue-600 hover:bg-blue-700"),children:[e.jsx(Ne,{className:"h-4 w-4 mr-1"}),"Session"]}),e.jsx(T,{size:"sm",variant:"outline",onClick:Oe,disabled:K||!g,className:"border-emerald-500 text-emerald-700 hover:bg-emerald-50",children:K?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 mr-1 animate-spin"}),"Enregistrement..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"h-4 w-4 mr-1"}),"Enregistrer en base"]})})]})]})]}):e.jsxs("div",{className:"p-6 text-center text-gray-400",children:[e.jsx(ce,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Chargement de la configuration..."})]})};export{xe as I,Ms as M};
