import{r as a,a as w,s as p,l as f}from"./index-a55a9305.js";function q(s,{enabled:i=!0}={}){const[S,u]=a.useState({}),[g,_]=a.useState(!0),[E,l]=a.useState(null),c=a.useRef(!1),{organizationId:j}=w();a.useEffect(()=>{i&&s&&h()},[s,i]),a.useEffect(()=>{if(!i||!s)return;const t=p.channel(`project-steps-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"project_steps_status",filter:`prospect_id=eq.${s}`},e=>{if(c.current){c.current=!1;return}e.eventType==="INSERT"||e.eventType==="UPDATE"?u(r=>({...r,[e.new.project_type]:e.new.steps})):e.eventType==="DELETE"&&u(r=>{const{[e.old.project_type]:n,...o}=r;return o})}).subscribe();return()=>{p.removeChannel(t)}},[s,i]);const h=async()=>{try{_(!0),l(null);const{data:t,error:e}=await p.from("project_steps_status").select("*").eq("prospect_id",s);if(e)throw e;const r=(t||[]).reduce((n,o)=>(n[o.project_type]=o.steps,n),{});u(r)}catch(t){f.error("Erreur fetch project steps:",{error:t.message}),l(t.message)}finally{_(!1)}};return{projectStepsStatus:S,loading:g,error:E,updateProjectSteps:async(t,e)=>{try{if(c.current=!0,!j)throw new Error("organization_id manquant");const{data:r,error:n}=await p.from("project_steps_status").upsert({prospect_id:s,project_type:t,steps:e,organization_id:j,updated_at:new Date().toISOString()},{onConflict:"prospect_id,project_type"}).select().single();if(n)throw n;return u(o=>({...o,[t]:e})),r}catch(r){throw f.error("Erreur update project steps:",{error:r.message}),c.current=!1,r}},deleteProjectSteps:async t=>{try{c.current=!0;const{error:e}=await p.from("project_steps_status").delete().eq("prospect_id",s).eq("project_type",t);if(e)throw e;u(r=>{const{[t]:n,...o}=r;return o})}catch(e){throw f.error("Erreur delete project steps:",{error:e.message}),c.current=!1,e}},refresh:()=>{s&&h()}}}export{q as u};
