import{c as Et,r as n,R as gt,u as ks,j as e,m as Ye,C as nt,l as w,s as be,a as ot,b as Ve,d as As,e as et,f as Es,g as _t,h as ct,B as fe,P as Pt,D as pt,i as ft,X as Je,k as bt,n as jt,U as Ue,o as tt,M as yt,p as Dt,q as vt,S as Tt,t as Rt,v as Ft,w as $t,x as $e,y as Mt,A as as,z as rs,T as Lt,E as ns,F as is,G as ls,H as os,I as cs,J as ds,K as us,L as J,N as Le,O as Ps,Q as ms,V as Ds,W as gs,Y as Vt,Z as Ts,_ as Rs,$ as Qe,a0 as Fs,a1 as $s,a2 as Ms,a3 as it,a4 as Ls,a5 as xs,a6 as hs,a7 as Os,a8 as zs,a9 as Me,aa as Be,ab as dt,ac as ps,ad as qs,ae as Vs,af as Bs,ag as Hs,ah as Ws,ai as Gs,aj as Js,ak as Xs,al as Ys,am as Ks,an as Qs,ao as Zs,ap as Us,aq as ea,ar as ta,as as sa,at as aa,au as ra}from"./index-2d2c89a6.js";import{u as st,A as fs,C as na}from"./Agenda-84f37757.js";import{S as ia}from"./SearchableSelect-f72bc401.js";import{u as la}from"./useSupabaseProjectStepsStatus-9440beac.js";import{u as bs,a as js}from"./useSupabaseProjectFiles-cbd97c05.js";import{F as oa,a as ca,P as da,b as ua,e as ma,u as ys,S as Ot,c as ga}from"./useSupabaseWorkflowModuleTemplates-c816c73e.js";import{f as Ke,a as qe,V as xa}from"./index-eebc9e69.js";import{D as xt}from"./download-a3f5877b.js";import{i as ha}from"./workflowV2Config-b482875b.js";import{P as ht}from"./pen-square-1f06ad36.js";import{f as pa,P as Bt}from"./index-048a1b9c.js";import"./external-link-90b9a07a.js";const fa=Et("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),ba=Et("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),ja=Et("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function ya(){for(var t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return n.useMemo(()=>r=>{s.forEach(u=>u(r))},s)}const va=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function Na(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function wa(t){return"nodeType"in t}function vs(t){var s,a;return t?Na(t)?t:wa(t)&&(s=(a=t.ownerDocument)==null?void 0:a.defaultView)!=null?s:window:window}const Nt=va?n.useLayoutEffect:n.useEffect;function Ns(t){const s=n.useRef(t);return Nt(()=>{s.current=t}),n.useCallback(function(){for(var a=arguments.length,r=new Array(a),u=0;u<a;u++)r[u]=arguments[u];return s.current==null?void 0:s.current(...r)},[])}function It(t,s){s===void 0&&(s=[t]);const a=n.useRef(t);return Nt(()=>{a.current!==t&&(a.current=t)},s),a}function Ct(t){const s=Ns(t),a=n.useRef(null),r=n.useCallback(u=>{u!==a.current&&(s==null||s(u,a.current)),a.current=u},[]);return[a,r]}let St={};function ws(t,s){return n.useMemo(()=>{if(s)return s;const a=St[t]==null?0:St[t]+1;return St[t]=a,t+"-"+a},[t,s])}function Sa(t){if(!t)return!1;const{KeyboardEvent:s}=vs(t.target);return s&&t instanceof s}const lt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:a}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:a}=t;return"scaleX("+s+") scaleY("+a+")"}},Transform:{toString(t){if(t)return[lt.Translate.toString(t),lt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:a,easing:r}=t;return s+" "+a+"ms "+r}}});var rt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(rt||(rt={}));function Ht(){}const _a=Object.freeze({x:0,y:0});function Ia(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Ca(t,s,a){const r=Ia(s);if(!r)return t;const{scaleX:u,scaleY:m,x:g,y:x}=r,S=t.left-g-(1-u)*parseFloat(a),I=t.top-x-(1-m)*parseFloat(a.slice(a.indexOf(" ")+1)),y=u?t.width/u:t.width,p=m?t.height/m:t.height;return{width:y,height:p,top:I,right:S+y,bottom:I+p,left:S}}const ka={ignoreTransform:!1};function zt(t,s){s===void 0&&(s=ka);let a=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:I,transformOrigin:y}=vs(t).getComputedStyle(t);I&&(a=Ca(a,I,y))}const{top:r,left:u,width:m,height:g,bottom:x,right:S}=a;return{top:r,left:u,width:m,height:g,bottom:x,right:S}}function Wt(t){return zt(t,{ignoreTransform:!0})}var Ze;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(Ze||(Ze={}));var Gt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Gt||(Gt={}));var Fe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Fe||(Fe={}));Fe.Space,Fe.Enter,Fe.Esc,Fe.Space,Fe.Enter,Fe.Tab;var Jt;(function(t){t[t.RightClick=2]="RightClick"})(Jt||(Jt={}));var Xt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Xt||(Xt={}));var Yt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Yt||(Yt={}));Ze.Backward+"",Ze.Forward+"",Ze.Backward+"",Ze.Forward+"";var kt;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(kt||(kt={}));var At;(function(t){t.Optimized="optimized"})(At||(At={}));function Aa(t){let{callback:s,disabled:a}=t;const r=Ns(s),u=n.useMemo(()=>{if(a||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:m}=window;return new m(r)},[a]);return n.useEffect(()=>()=>u==null?void 0:u.disconnect(),[u]),u}function Ea(t,s){return n.useMemo(()=>t.reduce((a,r)=>{let{eventName:u,handler:m}=r;return a[u]=g=>{m(g,s)},a},{}),[t,s])}kt.WhileDragging,At.Optimized;const Pa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Ht,draggableNodes:new Map,over:null,measureDroppableContainers:Ht},Ss=n.createContext(Pa),Da=n.createContext({..._a,scaleX:1,scaleY:1});var Kt;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Kt||(Kt={}));const Ta=n.createContext(null),Qt="button",Ra="Draggable";function Fa(t){let{id:s,data:a,disabled:r=!1,attributes:u}=t;const m=ws(Ra),{activators:g,activatorEvent:x,active:S,activeNodeRect:I,ariaDescribedById:y,draggableNodes:p,over:L}=n.useContext(Ss),{role:h=Qt,roleDescription:R="draggable",tabIndex:P=0}=u??{},j=(S==null?void 0:S.id)===s,k=n.useContext(j?Da:Ta),[E,v]=Ct(),[i,d]=Ct(),D=Ea(g,s),W=It(a);Nt(()=>(p.set(s,{id:s,key:m,node:E,activatorNode:i,data:W}),()=>{const F=p.get(s);F&&F.key===m&&p.delete(s)}),[p,s]);const _=n.useMemo(()=>({role:h,tabIndex:P,"aria-disabled":r,"aria-pressed":j&&h===Qt?!0:void 0,"aria-roledescription":R,"aria-describedby":y.draggable}),[r,h,P,j,R,y.draggable]);return{active:S,activatorEvent:x,activeNodeRect:I,attributes:_,isDragging:j,listeners:r?void 0:D,node:E,over:L,setNodeRef:v,setActivatorNodeRef:d,transform:k}}const $a="Droppable",Ma={timeout:25};function La(t){let{data:s,disabled:a=!1,id:r,resizeObserverConfig:u}=t;const m=ws($a),{active:g,dispatch:x,over:S,measureDroppableContainers:I}=n.useContext(Ss),y=n.useRef({disabled:a}),p=n.useRef(!1),L=n.useRef(null),h=n.useRef(null),{disabled:R,updateMeasurementsFor:P,timeout:j}={...Ma,...u},k=It(P??r),E=n.useCallback(()=>{if(!p.current){p.current=!0;return}h.current!=null&&clearTimeout(h.current),h.current=setTimeout(()=>{I(Array.isArray(k.current)?k.current:[k.current]),h.current=null},j)},[j]),v=Aa({callback:E,disabled:R||!g}),i=n.useCallback((_,F)=>{v&&(F&&(v.unobserve(F),p.current=!1),_&&v.observe(_))},[v]),[d,D]=Ct(i),W=It(s);return n.useEffect(()=>{!v||!d.current||(v.disconnect(),p.current=!1,v.observe(d.current))},[d,v]),n.useEffect(()=>(x({type:rt.RegisterDroppable,element:{id:r,key:m,disabled:a,node:d,rect:L,data:W}}),()=>x({type:rt.UnregisterDroppable,key:m,id:r})),[r]),n.useEffect(()=>{a!==y.current.disabled&&(x({type:rt.SetDroppableDisabled,id:r,key:m,disabled:a}),y.current.disabled=a)},[r,m,a,x]),{active:g,rect:L,isOver:(S==null?void 0:S.id)===r,node:d,over:S,setNodeRef:D}}function _s(t,s,a){const r=t.slice();return r.splice(a<0?r.length+a:a,0,r.splice(s,1)[0]),r}function mt(t){return t!==null&&t>=0}const Oa=t=>{let{rects:s,activeIndex:a,overIndex:r,index:u}=t;const m=_s(s,r,a),g=s[u],x=m[u];return!x||!g?null:{x:x.left-g.left,y:x.top-g.top,scaleX:x.width/g.width,scaleY:x.height/g.height}},za="Sortable",qa=gt.createContext({activeIndex:-1,containerId:za,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Oa,disabled:{draggable:!1,droppable:!1}}),Va=t=>{let{id:s,items:a,activeIndex:r,overIndex:u}=t;return _s(a,r,u).indexOf(s)},Ba=t=>{let{containerId:s,isSorting:a,wasDragging:r,index:u,items:m,newIndex:g,previousItems:x,previousContainerId:S,transition:I}=t;return!I||!r||x!==m&&u===g?!1:a?!0:g!==u&&s===S},Ha={duration:200,easing:"ease"},Is="transform",Wa=lt.Transition.toString({property:Is,duration:0,easing:"linear"}),Ga={roleDescription:"sortable"};function Ja(t){let{disabled:s,index:a,node:r,rect:u}=t;const[m,g]=n.useState(null),x=n.useRef(a);return Nt(()=>{if(!s&&a!==x.current&&r.current){const S=u.current;if(S){const I=zt(r.current,{ignoreTransform:!0}),y={x:S.left-I.left,y:S.top-I.top,scaleX:S.width/I.width,scaleY:S.height/I.height};(y.x||y.y)&&g(y)}}a!==x.current&&(x.current=a)},[s,a,r,u]),n.useEffect(()=>{m&&g(null)},[m]),m}function Xa(t){let{animateLayoutChanges:s=Ba,attributes:a,disabled:r,data:u,getNewIndex:m=Va,id:g,strategy:x,resizeObserverConfig:S,transition:I=Ha}=t;const{items:y,containerId:p,activeIndex:L,disabled:h,disableTransforms:R,sortedRects:P,overIndex:j,useDragOverlay:k,strategy:E}=n.useContext(qa),v=Ya(r,h),i=y.indexOf(g),d=n.useMemo(()=>({sortable:{containerId:p,index:i,items:y},...u}),[p,u,i,y]),D=n.useMemo(()=>y.slice(y.indexOf(g)),[y,g]),{rect:W,node:_,isOver:F,setNodeRef:ie}=La({id:g,data:d,disabled:v.droppable,resizeObserverConfig:{updateMeasurementsFor:D,...S}}),{active:oe,activatorEvent:he,activeNodeRect:H,attributes:je,setNodeRef:X,listeners:A,isDragging:G,over:xe,setActivatorNodeRef:B,transform:o}=Fa({id:g,data:d,attributes:{...Ga,...a},disabled:v.draggable}),$=ya(ie,X),q=!!oe,ne=q&&!R&&mt(L)&&mt(j),f=!k&&G,V=f&&ne?o:null,ce=ne?V??(x??E)({rects:P,activeNodeRect:H,activeIndex:L,overIndex:j,index:i}):null,Z=mt(L)&&mt(j)?m({id:g,items:y,activeIndex:L,overIndex:j}):i,Y=oe==null?void 0:oe.id,K=n.useRef({activeId:Y,items:y,newIndex:Z,containerId:p}),se=y!==K.current.items,ue=s({active:oe,containerId:p,isDragging:G,isSorting:q,id:g,index:i,items:y,newIndex:K.current.newIndex,previousItems:K.current.items,previousContainerId:K.current.containerId,transition:I,wasDragging:K.current.activeId!=null}),de=Ja({disabled:!ue,index:i,node:_,rect:W});return n.useEffect(()=>{q&&K.current.newIndex!==Z&&(K.current.newIndex=Z),p!==K.current.containerId&&(K.current.containerId=p),y!==K.current.items&&(K.current.items=y)},[q,Z,p,y]),n.useEffect(()=>{if(Y===K.current.activeId)return;if(Y&&!K.current.activeId){K.current.activeId=Y;return}const U=setTimeout(()=>{K.current.activeId=Y},50);return()=>clearTimeout(U)},[Y]),{active:oe,activeIndex:L,attributes:je,data:d,rect:W,index:i,newIndex:Z,items:y,isOver:F,isSorting:q,isDragging:G,listeners:A,node:_,overIndex:j,over:xe,setNodeRef:$,setActivatorNodeRef:B,setDroppableNodeRef:ie,setDraggableNodeRef:X,transform:de??ce,transition:C()};function C(){if(de||se&&K.current.newIndex===i)return Wa;if(!(f&&!Sa(he)||!I)&&(q||ue))return lt.Transition.toString({...I,property:Is})}}function Ya(t,s){var a,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(a=t==null?void 0:t.draggable)!=null?a:s.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:s.droppable}}Fe.Down,Fe.Right,Fe.Up,Fe.Left;const Ka=t=>(t||"").toString().trim().toUpperCase(),Qa=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const a=t.prospect,r=s.prospect;if(a.id!==r.id||a.name!==r.name||a.hasAppointment!==r.hasAppointment||a.updatedAt!==r.updatedAt)return!1;const u=a._projectContext||{},m=r._projectContext||{};if(u.projectType!==m.projectType||u.projectTitle!==m.projectTitle||u.stepLabel!==m.stepLabel)return!1;const g=a.tags||[],x=r.tags||[];return!(g.length!==x.length||g.some((S,I)=>S!==x[I])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},Za=({prospect:t,onClick:s,sortableId:a,projectsData:r={}})=>{var j,k,E,v,i,d,D;ks();const u=Array.isArray(t.tags)?t.tags:[],m=((j=t._projectContext)==null?void 0:j.projectTitle)||((k=t._projectContext)==null?void 0:k.projectType)||null,g=((E=t._projectContext)==null?void 0:E.projectType)||null;(v=t._projectContext)!=null&&v.stepLabel;const x=m?Ka(m):null,S=a||(x?`${t.id}-${x}`:`${t.id}-${((i=t._projectContext)==null?void 0:i.projectType)||"default"}`),{attributes:I,listeners:y,setNodeRef:p,transform:L,transition:h,isDragging:R}=Xa({id:S,data:{prospect:t}}),P={transform:lt.Transform.toString(L),transition:h,zIndex:R?10:"auto",opacity:R?.8:1};return e.jsx("div",{ref:p,style:P,...I,...y,children:e.jsxs(Ye.div,{layoutId:`prospect-card-${S}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(nt,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[m&&u.includes(((d=t._projectContext)==null?void 0:d.projectType)||m)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((D=r[g])==null?void 0:D.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:m})}),u.filter(W=>W!==g).map(W=>{var ie,oe;const _=((ie=r[W])==null?void 0:ie.title)||W,F=((oe=r[W])==null?void 0:oe.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${F}`,children:_},W)})]})]})})},Ua=n.memo(Za,Qa);function er({prospectId:t,projectType:s,currentStepIndex:a,prompt:r,sendNextAction:u}){const m=n.useRef(new Set);n.useRef(!1),n.useEffect(()=>{if(!t||!s||a===void 0||!r)return;w.info("ðŸ”„ Workflow action trigger activÃ©",{prospectId:t,projectType:s,currentStepIndex:a,promptName:r==null?void 0:r.name});const g=be.channel(`workflow-forms-${t}-${s}-${a}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async x=>{const S=x.new;w.info("ðŸ” Form panel UPDATE reÃ§u",{panelId:S.id,prospectId:S.prospect_id,projectType:S.project_type,status:S.status,actionId:S.action_id,expectedProjectType:s});const I=S.project_type===s,y=S.status==="approved",p=!!S.action_id;if(I&&y&&p){const L=`${t}-${s}-${a}-${S.action_id}`;if(m.current.has(L)){w.warn("âš ï¸ Action dÃ©jÃ  exÃ©cutÃ©e, skip",{actionKey:L});return}m.current.add(L),w.info("âœ… Formulaire approuvÃ© â†’ Action suivante dans 2s",{formId:S.form_id,actionId:S.action_id}),setTimeout(()=>{w.info("ðŸš€ Envoi action suivante",{completedActionId:S.action_id}),u(S.action_id)},2e3)}}).subscribe();return()=>{be.removeChannel(g)}},[t,s,a,r,u])}function tr({projectType:t,prospectId:s,enabled:a=!0}){const[r,u]=n.useState([]),[m,g]=n.useState(!1),[x,S]=n.useState(!1),[I,y]=n.useState(null),{organizationId:p}=ot(),L=n.useCallback(async()=>{if(!(!t||!a))try{g(!0),y(null);let j=be.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(j=j.eq("prospect_id",s));const{data:k,error:E}=await j;if(E)throw E;u(k||[])}catch(j){w.error("Erreur rÃ©cupÃ©ration project notes:",{error:j.message}),y(j.message)}finally{g(!1)}},[t,s,a]);n.useEffect(()=>{if(!t||!a)return;L();const j=be.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},k=>{u(E=>{const{eventType:v,new:i,old:d}=k;return v==="INSERT"?[i,...E]:v==="UPDATE"?E.map(D=>D.id===i.id?i:D):v==="DELETE"?E.filter(D=>D.id!==d.id):E})}).subscribe();return()=>{be.removeChannel(j)}},[t,a,L]);const h=n.useCallback(async({content:j,createdBy:k,createdByName:E})=>{if(!(!t||!(j!=null&&j.trim())))try{if(S(!0),y(null),!p)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:v,error:i}=await be.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:j.trim(),created_by:k||null,created_by_name:E||null,organization_id:p}]).select().single();if(i)throw i;return u(d=>[v,...d]),v}catch(v){throw w.error("Erreur ajout project note:",{error:v.message}),y(v.message),v}finally{S(!1)}},[t,s,p]),R=n.useCallback(async(j,{content:k})=>{if(!(!j||!(k!=null&&k.trim())))try{S(!0),y(null);const{data:E,error:v}=await be.from("project_notes").update({content:k.trim(),updated_at:new Date().toISOString()}).eq("id",j).select().single();if(v)throw v;return u(i=>i.map(d=>d.id===j?E:d)),E}catch(E){throw w.error("Erreur update project note:",{error:E.message}),y(E.message),E}finally{S(!1)}},[]),P=n.useCallback(async j=>{if(j)try{S(!0),y(null);const{error:k}=await be.from("project_notes").delete().eq("id",j);if(k)throw k;u(E=>E.filter(v=>v.id!==j))}catch(k){throw w.error("Erreur suppression project note:",{error:k.message}),y(k.message),k}finally{S(!1)}},[]);return{notes:r,loading:m,saving:x,error:I,addNote:h,updateNote:R,deleteNote:P,refetch:L}}function sr({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r}){var i;const{activeAdminUser:u}=Ve(),m=r||u,[g,x]=n.useState(""),[S,I]=n.useState(!1),{getTemplateByType:y}=As(),p=y(t),L=(p==null?void 0:p.title)||t,{notes:h,loading:R,saving:P,error:j,addNote:k}=tr({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:E}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:m}),v=async()=>{if(g.trim())try{const d=await k({content:g,createdBy:(m==null?void 0:m.id)||(a==null?void 0:a.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)});d&&E&&await E({event_type:"note",title:"Note ajoutÃ©e",description:d.content||g.trim(),metadata:{source:"notes_tab"},createdBy:(m==null?void 0:m.id)||(a==null?void 0:a.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),x("")}catch(d){w.error(d)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${L}`:"Aucun projet sÃ©lectionnÃ©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne liÃ©e Ã  ce projetâ€¦",value:g,onChange:d=>x(d.target.value),disabled:!t||P}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"ðŸ–¼ï¸"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:v,disabled:!g.trim()||!t||P,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:P?"Enregistrementâ€¦":"Enregistrer la note"})]}),j&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",j]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes prÃ©cÃ©dentes"}),h&&h.length>3&&e.jsx("button",{onClick:()=>I(!S),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:S?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"RÃ©duire"}),e.jsx(Es,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",h.length,")"]}),e.jsx(_t,{className:"w-4 h-4"})]})})]}),R&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notesâ€¦"}),!R&&(h==null?void 0:h.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(i=S?h:h==null?void 0:h.slice(0,3))==null?void 0:i.map(d=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:d.created_by_name||d.created_by?`Par ${d.created_by_name||d.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:d.created_at&&new Date(d.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:d.content})]},d.id))})]})]})}const ar=({prospectId:t,projectType:s,activeAdminUser:a})=>{const{projectsData:r,appointments:u,updateAppointment:m,deleteAppointment:g,addAppointment:x,addCall:S,addTask:I,updateCall:y,updateTask:p,prospects:L}=Ve(),[h,R]=n.useState(!1),[P,j]=n.useState(null),[k,E]=n.useState(null),{users:v}=ct(),{supabaseUserId:i}=st(),{history:d,loading:D}=et({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),W=n.useMemo(()=>!d||d.length===0?[]:d.filter(A=>A.event_type==="activity").sort((A,G)=>new Date(G.created_at)-new Date(A.created_at)),[d]),_=n.useMemo(()=>{const A={};return W.forEach(xe=>{var o;const B=(o=xe.metadata)==null?void 0:o.appointment_id;B&&(A[B]||(A[B]=[]),A[B].push(xe))}),Object.entries(A).map(([xe,B])=>{var q;const $=B.sort((ne,f)=>new Date(f.created_at)-new Date(ne.created_at))[0];return{...$,currentStatus:((q=$.metadata)==null?void 0:q.status)||($.title==="ActivitÃ© supprimÃ©e"?"deleted":"pending")}})},[W]),F=n.useMemo(()=>_?_.filter(A=>A.currentStatus==="pending"):[],[_]),ie=n.useMemo(()=>_?_.filter(A=>A.currentStatus!=="pending"):[],[_]),oe=A=>{switch((A==null?void 0:A.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(nt,{className:"h-4 w-4"});case"virtual":return e.jsx(xa,{className:"h-4 w-4"});case"call":return e.jsx(tt,{className:"h-4 w-4"});case"task":return e.jsx(na,{className:"h-4 w-4"});default:return e.jsx(nt,{className:"h-4 w-4"})}},he=A=>{const G=(A==null?void 0:A.activity_type)||"appointment",xe=A==null?void 0:A.status;if(xe==="effectue"||xe==="completed")return"text-green-600 bg-green-50";if(xe==="annule")return"text-red-600 bg-red-50";if(xe==="reporte")return"text-yellow-600 bg-yellow-50";switch(G){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},H=A=>{var G;return!u||!((G=A.metadata)!=null&&G.appointment_id)?null:u.find(xe=>xe.id===A.metadata.appointment_id)},je=A=>{const G=H(A);G&&j(G)},X=A=>{j(null),E({...A,type:A.type}),R(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"ActivitÃ©s du projet"}),e.jsxs(fe,{onClick:()=>{R(!h)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"}),"Ajouter une activitÃ©"]})]}),h&&e.jsx(fs,{open:h,onOpenChange:A=>{A||E(null),R(A)},initialData:k||{contactId:t,projectId:s},defaultAssignedUserId:i,addAppointment:x,addCall:S,addTask:I,updateAppointment:m,updateCall:y,updateTask:p,prospects:L||[],users:v||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",F.length,")"]}),D?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activitÃ©s..."}):F.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activitÃ© en cours"}):e.jsx("div",{className:"space-y-2",children:F.map(A=>{const G=H(A),xe=(G==null?void 0:G.title)||A.title||"ActivitÃ©",B=G!=null&&G.start?new Date(G.start):new Date(A.created_at);return e.jsxs("div",{onClick:()=>je(A),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${he(A.metadata)}`,children:oe(A.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:xe}),(G==null?void 0:G.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:G.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Ke(B,"d MMM 'Ã ' HH:mm",{locale:qe})})]})]},A.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["PassÃ©es (",ie.length,")"]}),D?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ie.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activitÃ© passÃ©e"}):e.jsx("div",{className:"space-y-2",children:ie.map(A=>{const G=H(A),xe=(G==null?void 0:G.title)||A.title||"ActivitÃ©",B=G!=null&&G.start?new Date(G.start):new Date(A.created_at),o={effectue:"âœ… EffectuÃ©",annule:"âŒ AnnulÃ©",reporte:"ðŸ“… ReportÃ©",deleted:"ðŸ—‘ï¸ SupprimÃ©",completed:"âœ… TerminÃ©"}[A.currentStatus]||A.currentStatus;return e.jsxs("div",{onClick:()=>je(A),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${he(A.metadata)}`,children:oe(A.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:xe}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[o," â€¢ ",Ke(B,"d MMM yyyy 'Ã ' HH:mm",{locale:qe})]})]})]},A.id)})})]}),P&&e.jsx(rr,{event:P,onClose:()=>j(null),onReport:()=>{},onEdit:X,prospects:L,supabaseUsers:v,updateAppointment:m,deleteAppointment:g,projectsData:r})]})},rr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:u,supabaseUsers:m,updateAppointment:g,deleteAppointment:x,projectsData:S})=>{var v;const[I,y]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!u||!m||!g||!x||!S)return null;const p=u.find(i=>i.id===t.contactId),L=m.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(p?m.find(i=>i.user_id===p.ownerId):null),h=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",R=(i,d,D={})=>{try{const W=new Date(i);return isNaN(W.getTime())?"Date invalide":Ke(W,d,D)}catch{return"Date invalide"}},P=i=>{y(i),g(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},j=()=>{x(t.id),J({title:"âœ… RDV supprimÃ©",description:"Le rendez-vous a Ã©tÃ© retirÃ© de votre agenda."}),s()},k=i=>{if(!p){J({title:"Contact non trouvÃ©",variant:"destructive"});return}switch(i){case"Appel":p.phone&&(window.location.href=`tel:${p.phone}`);break;case"Mail":p.email&&(window.location.href=`mailto:${p.email}`);break;case"WhatsApp":if(p.phone){let d=p.phone.replace(/\D/g,"");d.startsWith("0")&&(d=`33${d.substring(1)}`);const D=encodeURIComponent("Bonjour");window.open(`https://wa.me/${d}?text=${D}`,"_blank")}break;case"GPS":if(p.address){const d=encodeURIComponent(p.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${d}`:window.open(`https://www.google.com/maps/search/?api=1&query=${d}`,"_blank")}break;default:J({title:`Action: ${i}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activitÃ©"},effectue:{color:"bg-green-500",label:"EffectuÃ©"},annule:{color:"bg-red-500",label:"AnnulÃ©"},reporte:{color:"bg-yellow-500",label:"ReportÃ©"}};return e.jsx(pt,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(ft,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:h(R(t.start,"eeee d MMMM",{locale:qe}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[R(t.start,"HH:mm",{locale:qe})," - ",R(t.end,"HH:mm",{locale:qe})]})]}),e.jsx(bt,{className:"p-0 text-left space-y-1",children:e.jsx(jt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(Ue,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),p&&e.jsxs("p",{className:"text-sm",children:[p.name," (Client)"]}),L&&e.jsxs("p",{className:"text-sm",children:[L.name," (AssignÃ©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"}].map(({icon:i,label:d})=>e.jsxs("button",{onClick:()=>k(d),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:d})]},d))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[I].color}`,children:e.jsxs(Tt,{onValueChange:P,value:I,children:[e.jsx(Rt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ft,{placeholder:"Qualifier votre activitÃ©"})}),e.jsxs($t,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activitÃ©"}),e.jsx($e,{value:"effectue",children:"EffectuÃ©"}),e.jsx($e,{value:"annule",children:"AnnulÃ©"}),e.jsx($e,{value:"reporte",children:"ReportÃ©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activitÃ©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((v=S[t.projectId])==null?void 0:v.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ã‰tape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(p==null?void 0:p.name)||"N/A"})]})]})]}),e.jsxs(Mt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(as,{children:[e.jsx(rs,{asChild:!0,children:e.jsxs(fe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Lt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(os,{children:"Cette action est irrÃ©versible. Le rendez-vous sera dÃ©finitivement supprimÃ©."})]}),e.jsxs(cs,{children:[e.jsx(ds,{children:"Annuler"}),e.jsx(us,{onClick:j,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(fe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activitÃ©"})]})]})})},nr=({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r})=>{const{activeAdminUser:u}=Ve(),{organizationId:m}=ot(),g=r||u,[x,S]=n.useState(null),{files:I,loading:y,uploading:p,deleting:L,error:h,uploadFile:R,deleteFile:P}=bs({projectType:t,prospectId:s,organizationId:m,enabled:!!t}),{addHistoryEvent:j}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:g}),k=async _=>{const F=Array.from(_.target.files||[]);if(F.length!==0)try{const ie=F.map(async oe=>{S(oe);const he=await R({file:oe,uploadedBy:a==null?void 0:a.id});return he&&j&&await j({event_type:"file",title:"Fichier ajoutÃ©",description:he.file_name,metadata:{size:he.file_size,type:he.file_type,storage_path:he.storage_path},createdBy:(g==null?void 0:g.id)||(a==null?void 0:a.id),createdByName:(g==null?void 0:g.name)||(g==null?void 0:g.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),he});await Promise.all(ie),S(null),_.target.value=""}catch(ie){w.error("Error uploading files:",ie),S(null)}},E=async _=>{try{const{data:F,error:ie}=await be.storage.from("project-files").createSignedUrl(_.storage_path,3600);if(ie){w.error("Error creating signed URL:",ie);return}const he=await(await fetch(F.signedUrl)).blob(),H=window.URL.createObjectURL(he),je=document.createElement("a");je.href=H,je.download=_.file_name,document.body.appendChild(je),je.click(),document.body.removeChild(je),window.URL.revokeObjectURL(H)}catch(F){w.error("Error downloading file:",F)}},v=async _=>{try{w.debug("ðŸ‘ï¸ Generating signed URL for view",{storagePath:_.storage_path});const{data:F,error:ie}=await be.storage.from("project-files").createSignedUrl(_.storage_path,3600);if(ie){w.error("Error creating signed URL:",ie);return}w.debug("âœ… Signed URL generated",{url:F.signedUrl}),window.open(F.signedUrl,"_blank")}catch(F){w.error("Error viewing file:",F)}},i=async _=>{if(confirm(`Supprimer le fichier "${_.file_name}" ?`))try{await P(_.id,_.storage_path)}catch(F){w.error("Error deleting file:",F)}},d=_=>_!=null&&_.startsWith("image/")?e.jsx(Ds,{className:"h-5 w-5 text-blue-500"}):_==="application/pdf"?e.jsx(Le,{className:"h-5 w-5 text-red-500"}):e.jsx(oa,{className:"h-5 w-5 text-gray-500"}),D=_=>_?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(_)):"",W=_=>_?_<1024?`${_} o`:_<1024*1024?`${(_/1024).toFixed(1)} Ko`:`${(_/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Ps,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:p?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents â€¢ SÃ©lection multiple possible â€¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:k,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:p,multiple:!0})]})}),h&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:h}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",I.length,")"]}),y?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):I.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:I.map(_=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:d(_.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[_.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:_.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:_.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:_.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[W(_.file_size)," â€¢ ",D(_.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[_.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>v(_),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:L,children:e.jsx(ms,{className:"h-4 w-4"})}),_.field_label==="Document signÃ©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"âœ“ SignÃ©"}),e.jsx("button",{onClick:()=>E(_),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"TÃ©lÃ©charger",disabled:L,children:e.jsx(xt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"â³ En attente"}),e.jsx("button",{onClick:()=>i(_),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:L,children:e.jsx(Lt,{className:"h-4 w-4"})})]})]},_.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stockÃ©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"SÃ©lectionnez un projet pour voir les fichiers"})]})},ir=({prospectId:t,projectType:s,activeAdminUser:a})=>{const[r,u]=n.useState("notes"),{supabaseUserId:m}=st(),g=[{id:"notes",label:"Notes",icon:Le},{id:"activity",label:"ActivitÃ©",icon:fa},{id:"files",label:"Fichiers",icon:ca}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:g.map(({id:x,label:S,icon:I})=>e.jsxs("button",{onClick:()=>u(x),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===x?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx("span",{children:S})]},x))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(sr,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:a}),r==="activity"&&e.jsx(ar,{prospectId:t,projectType:s,activeAdminUser:a}),r==="files"&&e.jsx(nr,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:a})]})]})},lr=({projectType:t,prospectId:s,activeAdminUser:a})=>{const{history:r,loading:u,error:m}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:a});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),u&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historiqueâ€¦"}),m&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",m]}),!u&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun Ã©vÃ©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(g=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:g.title||g.event_type}),g.description&&e.jsx("p",{className:"text-xs text-gray-600",children:g.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(g.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(g.created_by_name||g.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Par ",g.created_by_name||g.created_by]})]})]})]})]},g.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"SÃ©lectionnez un projet"})})},or=({children:t,prospectId:s,projectType:a,currentStep:r,statusConfig:u,activeAdminUser:m})=>{var g,x,S;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((g=u[r.status])==null?void 0:g.iconOnly)||u.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((x=u[r.status])==null?void 0:x.badge)||u.pending.badge}`,children:((S=u[r.status])==null?void 0:S.label)||u.pending.label})]}),t]},r.name),!r&&!a&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Le,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet sÃ©lectionnÃ©"}),e.jsx("p",{className:"text-gray-500",children:"SÃ©lectionnez un projet dans la liste ci-dessus pour voir le suivi dÃ©taillÃ©."})]})]}),a&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ir,{prospectId:s,projectType:a,activeAdminUser:m}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(lr,{prospectId:s,projectType:a,activeAdminUser:m})]})]})},cr={CLIENT:it,COMMERCIAL:Ls,PARTENAIRE:Ue},dr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},ur={FORM:Le,SIGNATURE:da},mr={FORM:"Formulaire",SIGNATURE:"Signature"},gr=({isOpen:t,onClose:s,prospectId:a,projectType:r,moduleId:u,moduleName:m,moduleConfig:g,context:x={},availableForms:S=[],availableTemplates:I=[]})=>{var q,ne;const[y,p]=n.useState(null),[L,h]=n.useState(!1),[R,P]=n.useState(null),[j,k]=n.useState(!1),E=ha(),v=n.useMemo(()=>g?g.actions&&g.actions.length>0?g.actions:g.actionConfig?[{order:1,status:"pending",actionConfig:g.actionConfig}]:[]:[],[g]),[i,d]=n.useState({}),[D,W]=n.useState(!1);n.useEffect(()=>{if(!t||!a||!u||v.length<=1){d({});return}(async()=>{W(!0);try{const V=v.map((Y,K)=>`v2-${u}-action-${K}`),{data:N,error:ce}=await be.from("client_form_panels").select("id, action_id, status").eq("prospect_id",a).eq("project_type",r).in("action_id",V),Z={};if(!ce&&N&&N.length>0){for(const Y of N)Y.action_id&&(Y.status==="approved"||Y.status==="submitted")&&(Z[Y.action_id]=Y.status);console.log("[V2 Robot] Action statuses by action_id:",Z)}else{const{data:Y}=await be.from("client_form_panels").select("id, step_name, status").eq("prospect_id",a).eq("project_type",r).in("status",["approved","submitted"]);if(Y){const K=Y.filter(se=>!se.step_name||se.step_name===m||se.step_name===u);K.forEach((se,ue)=>{ue<v.length&&(Z[`v2-${u}-action-${ue}`]=se.status)}),console.log("[V2 Robot] Fallback legacy statuses:",Z,"from",K.length,"panels")}}d(Z)}catch(V){console.error("[V2 Robot] Error fetching action statuses:",V)}finally{W(!1)}})()},[t,a,r,m,u,v.length]);const _=n.useMemo(()=>v.map((f,V)=>{const N=`v2-${u}-action-${V}`,ce=i[N];return{...f,actionId:N,realStatus:ce==="approved"?"validated":ce==="submitted"?"submitted":"pending"}}),[v,i,u]),[F,ie]=n.useState(0);n.useEffect(()=>{if(t&&_.length>0&&!D){const f=_.findIndex(V=>V.realStatus!=="validated");ie(f>=0?f:_.length-1)}},[t,_,D]);const oe=_[F]||null,he=_.length,H=he>1,je=n.useMemo(()=>{if(!oe)return!1;const f=oe.actionConfig;return!(!f||!f.actionType||!(Array.isArray(f.targetAudience)?f.targetAudience.length>0:!!f.targetAudience))},[oe]),X=(oe==null?void 0:oe.actionConfig)||null,A=()=>{if(!je||!X){J({title:"Configuration incomplÃ¨te",description:"Aucune action configurÃ©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:F,actionConfigFormIds:X.allowedFormIds,currentActionFull:oe,allActions:_.map((f,V)=>{var N;return{index:V,formIds:(N=f.actionConfig)==null?void 0:N.allowedFormIds}})});try{const f=Array.isArray(X.targetAudience)?X.targetAudience[0]:X.targetAudience,V=ua({moduleId:u,moduleName:m,projectType:r,prospectId:a,actionIndex:F,actionConfig:{...X,targetAudience:f||"CLIENT"},message:""});p(V),P(null),console.log("[V2 Robot] ActionOrder gÃ©nÃ©rÃ©:",V)}catch(f){console.error("[V2 Robot] Erreur gÃ©nÃ©ration:",f),J({title:"Erreur",description:f.message,variant:"destructive"})}},G=async()=>{if(!y){J({title:"Aucun ordre",description:"Simulez d'abord pour gÃ©nÃ©rer un ActionOrder.",variant:"destructive"});return}if(!E){J({title:"ExÃ©cution dÃ©sactivÃ©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}h(!0),P(null);try{const f={...y,_meta:{...y._meta,isSimulation:!1}},V=await ma(f,x);P(V),V.success?(J({title:"âœ… Action exÃ©cutÃ©e",description:V.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):J({title:"âš ï¸ ExÃ©cution bloquÃ©e",description:V.message,variant:"destructive"})}catch(f){console.error("[V2 Robot] Erreur exÃ©cution:",f),P({success:!1,status:"error",message:f.message}),J({title:"Erreur",description:f.message,variant:"destructive"})}finally{h(!1)}},xe=()=>{y&&(navigator.clipboard.writeText(JSON.stringify(y,null,2)),J({title:"CopiÃ© !",description:"ActionOrder JSON copiÃ© dans le presse-papiers."}))},B=gt.useRef(F);n.useEffect(()=>{const f=B.current!==F;if(B.current=F,f&&(p(null),P(null)),t&&je&&!D&&(!y||f)){const V=setTimeout(()=>{A()},f?50:0);return()=>clearTimeout(V)}},[t,je,D,F]),n.useEffect(()=>{t||(p(null),P(null),k(!1),ie(0))},[t]);const o=f=>{const V=S.find(N=>N.id===f);return(V==null?void 0:V.name)||f},$=f=>{const V=I.find(N=>N.id===f);return(V==null?void 0:V.name)||f};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(gs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m||u,H&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["â€” Action ",F+1,"/",he]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Je,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[H&&je&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["ðŸ“‹ Ã‰tape ",F+1," sur ",he]}),F>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",F," terminÃ©e",F>1?"s":"",")"]})]}),!je&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Vt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est dÃ©finie pour cette Ã©tape."}),e.jsxs(fe,{variant:"outline",size:"sm",onClick:()=>{J({title:"Configurer cette Ã©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Ts,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),je&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:H?`Action ${F+1}/${he}`:"Action configurÃ©e"}),E&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(X==null?void 0:X.actionType)&&e.jsxs(e.Fragment,{children:[gt.createElement(ur[X.actionType]||Le,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:mr[X.actionType]||X.actionType})]})}),(X==null?void 0:X.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(X.targetAudience)?X.targetAudience:[X.targetAudience]).map(f=>{const V=cr[f]||it;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(V,{className:"h-3.5 w-3.5"}),dr[f]||f]},f)})]}),((q=X==null?void 0:X.allowedFormIds)==null?void 0:q.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",X.allowedFormIds.map(f=>o(f)).join(", ")]}),((ne=X==null?void 0:X.allowedTemplateIds)==null?void 0:ne.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",X.allowedTemplateIds.map(f=>$(f)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(X==null?void 0:X.managementMode)==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"]}),e.jsxs("span",{children:["VÃ©rif: ",(X==null?void 0:X.verificationMode)==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"]})]})]}),y&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>k(!j),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Rs,{className:Qe("h-4 w-4 transition-transform",j&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:f=>{f.stopPropagation(),xe()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(Fs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),j&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(y,null,2)})]}),R&&e.jsxs("div",{className:Qe("rounded-lg p-4 flex items-start gap-3",R.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[R.success?e.jsx($s,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Vt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Qe("font-medium text-sm",R.success?"text-green-800":"text-red-800"),children:[R.status==="executed"&&"ExÃ©cutÃ© avec succÃ¨s",R.status==="simulated"&&"Simulation uniquement",R.status==="blocked"&&"ExÃ©cution bloquÃ©e",R.status==="error"&&"Erreur"]}),e.jsx("p",{className:Qe("text-sm mt-1",R.success?"text-green-700":"text-red-700"),children:R.message})]})]})]})]}),je&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(fe,{variant:"outline",onClick:A,disabled:L,children:[e.jsx(ms,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(fe,{onClick:G,disabled:!y||L||!E,className:Qe(!E&&"opacity-50 cursor-not-allowed"),children:[L?e.jsx(Ms,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ja,{className:"h-4 w-4 mr-2"}),"ExÃ©cuter"]})]})]})}):null},Oe="completed",ke="in_progress",ze="pending",at={[Oe]:{label:"TerminÃ©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[ke]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[ze]:{label:"Ã€ venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Zt=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||ze}))};if(t.status!==ke)return s;if(!s.subSteps.some(r=>r.status===ke)){const r=s.subSteps.findIndex(u=>u.status===ze);r!==-1&&(s.subSteps=s.subSteps.map((u,m)=>({...u,status:m===r?ke:u.status})))}return s},Ut=(t,s,a)=>{var I;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,u=r?`${s}:${r}`:null,m=u&&a?a[u]:null,g=(I=m==null?void 0:m.configJson)==null?void 0:I.actions;if(!g||g.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const y=t.subSteps.map((p,L)=>{var j,k;const h=g[L],P=((k=(j=h==null?void 0:h.config)==null?void 0:j.objective)==null?void 0:k.trim())||(h==null?void 0:h.title)||(h==null?void 0:h.label);return{...p,name:P||p.name||`Action ${L+1}`}});return{...t,subSteps:y}}const x=t.status||ze,S=g.map((y,p)=>{var L;return{id:y.id||`v2-${r}-action-${p}`,name:((L=y.config)==null?void 0:L.objective)&&y.config.objective.trim()||y.title||y.label||`Action ${p+1}`,status:x===Oe?Oe:x===ke&&p===0?ke:ze}});return{...t,subSteps:S,status:x}},xr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===Oe),hr=({form:t,prospectId:s,onFormSubmit:a})=>{const[r,u]=n.useState({}),m=(x,S)=>{u(I=>({...I,[x]:S}))},g=()=>{a(s,t.id,r),J({title:"RÃ©ponses enregistrÃ©es",description:`Les rÃ©ponses au formulaire "${t.name}" ont Ã©tÃ© sauvegardÃ©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(x=>{if(x.show_if_conditions&&x.show_if_conditions.length>0){const I=x.condition_operator||"AND",y=x.show_if_conditions.map(L=>{const h=r[L.field];return L.equals==="has_value"?!!h&&h!=="":h===L.equals});if(!(I==="AND"?y.every(L=>L===!0):y.some(L=>L===!0)))return null}if(x.show_if){const I=x.show_if.field,y=x.show_if.equals,p=r[I];if(!p||p!==y)return null}return(t.fields||[]).some(I=>I.is_repeater&&(I.repeats_fields||[]).includes(x.id))?null:e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${x.id}`,children:x.label}),e.jsx(Be,{id:`${t.id}-${x.id}`,type:x.type,value:typeof r[x.id]=="object"?"":r[x.id]||"",onChange:I=>m(x.id,I.target.value),placeholder:x.placeholder||""}),x.is_repeater&&x.repeats_fields&&x.repeats_fields.length>0&&r[x.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[x.id])||0},(I,y)=>{const p=(t.fields||[]).filter(L=>x.repeats_fields.includes(L.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[x.label," #",y+1]}),p.map(L=>{const h=`${x.id}_repeat_${y}_${L.id}`,R=r[h];return e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${h}`,children:L.label}),e.jsx(Be,{id:`${t.id}-${h}`,type:L.type,value:typeof R=="object"?"":R||"",onChange:P=>m(h,P.target.value),placeholder:L.placeholder||""})]},h)})]},y)})})]},x.id)}),e.jsx(fe,{onClick:g,className:"w-full",children:"Soumettre"})]})},pr=({prospectId:t,projectType:s,currentStepIndex:a,activeAdminUser:r})=>{var ue,de;const{addChatMessage:u,prompts:m,projectsData:g,forms:x,updateProspect:S,prospects:I,completeStepAndProceed:y,registerClientForm:p}=Ve();ct();const{messages:L,loading:h}=js(t,s),{uploadFile:R,uploading:P}=bs({projectType:s,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:j}=et({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),{user:k}=st(),[E,v]=n.useState(""),[i,d]=n.useState(null),D=n.useRef(null),W=n.useRef(null),[_,F]=n.useState(!1),[ie,oe]=n.useState(!1),{organizationId:he}=ot(),{templates:H,loading:je}=ys(he||(r==null?void 0:r.organization_id),s),{forms:X,loading:A}=qs(he||(r==null?void 0:r.organization_id)),{templates:G,loading:xe}=Vs(he||(r==null?void 0:r.organization_id)),B=(de=(ue=g[s])==null?void 0:ue.steps)==null?void 0:de[a],o=n.useMemo(()=>B!=null&&B.name?B.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`,[B,a]),$=n.useMemo(()=>{if(!H||!o)return null;const C=H[`${s}:${o}`];return(C==null?void 0:C.configJson)||null},[H,o,s]),q=n.useMemo(()=>X?Object.values(X).map(C=>({id:C.id,name:C.name||C.title||"Formulaire sans nom"})):[],[X]),ne=n.useMemo(()=>G?Array.isArray(G)?G.map(C=>({id:C.id,name:C.name||"Template sans nom"})):Object.values(G).map(C=>({id:C.id,name:C.name||"Template sans nom"})):[],[G]),f=I.find(C=>C.id===t),V=n.useMemo(()=>Object.values(m).filter(C=>{var pe;if(C.projectId!==s)return!1;const U=(pe=C.stepsConfig)==null?void 0:pe[a];return U&&U.actions&&U.actions.length>0}),[m,s,a]),N=n.useCallback(async(C=null)=>{var Ne;const U=V[0];if(!U){w.warn("Aucun prompt disponible");return}const pe=(Ne=U.stepsConfig)==null?void 0:Ne[a];if(!pe||!pe.actions){w.warn("Aucune action dans la config de l'Ã©tape");return}const ye=[...pe.actions].sort((Se,Ce)=>(Se.order||0)-(Ce.order||0));if(C){const Se=ye.findIndex(Ce=>Ce.id===C);if(Se!==-1&&Se+1<ye.length){const Ce=ye[Se+1];w.info("ðŸŽ¯ Action suivante trouvÃ©e",{completedActionId:C,nextActionId:Ce.id,nextActionType:Ce.type}),await se(U,Ce.id);return}else{w.warn("Pas d'action suivante",{completedActionId:C,totalActions:ye.length});return}}await se(U)},[V,a]);er({prospectId:t,projectType:s,currentStepIndex:a,prompt:V[0],sendNextAction:N}),n.useEffect(()=>{requestAnimationFrame(()=>{var C;(C=D.current)==null||C.scrollIntoView({behavior:"smooth",block:"end"})})},[L]);const ce=async()=>{if(!(!E.trim()&&!i))try{let C=null;if(i){if(i.size>10485760){J({title:"âŒ Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}w.debug("ðŸ“¤ Uploading file from admin chat",{name:i.name,size:i.size,type:i.type});const{data:{user:ye}}=await be.auth.getUser(),Ne=await R({file:i,uploadedBy:ye==null?void 0:ye.id});Ne&&(C={id:Ne.id,name:Ne.file_name,size:Ne.file_size,type:Ne.file_type,storagePath:Ne.storage_path},w.debug("âœ… File uploaded successfully",C))}u(t,s,{sender:"pro",text:E,file:C}),v(""),d(null),requestAnimationFrame(()=>{var pe;(pe=D.current)==null||pe.scrollIntoView({behavior:"smooth",block:"end"})}),C&&J({title:"âœ… Fichier envoyÃ©",description:`${C.name} a Ã©tÃ© envoyÃ© avec succÃ¨s.`})}catch(C){w.error("âŒ Error sending message with file",C),J({title:"âŒ Erreur",description:`Impossible d'envoyer le fichier : ${C.message}`,variant:"destructive"})}},Z=C=>{C.target.files&&C.target.files[0]&&d(C.target.files[0])},Y=async C=>{if(!C||!C.storagePath){J({title:"âŒ Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{w.debug("ðŸ“¥ Downloading file",{storagePath:C.storagePath});const{data:U,error:pe}=await be.storage.from("project-files").createSignedUrl(C.storagePath,3600);if(pe)throw pe;window.open(U.signedUrl,"_blank"),J({title:"âœ… TÃ©lÃ©chargement",description:`${C.name} s'ouvre dans un nouvel onglet.`})}catch(U){w.error("âŒ Error downloading file",U),J({title:"âŒ Erreur",description:`Impossible de tÃ©lÃ©charger le fichier : ${U.message}`,variant:"destructive"})}},K=(C,U,pe)=>{var Ie;const ye=I.find(Ee=>Ee.id===C);if(!ye)return;const Ne={...ye.formData||{},...pe};S({...ye,formData:Ne});const Se={sender:"client",text:`A complÃ©tÃ© le formulaire : ${((Ie=x[U])==null?void 0:Ie.name)||"Formulaire"}.`};if(u(C,s,Se),Object.values(m).find(Ee=>{var Re,ve;if(Ee.projectId!==s)return!1;const Pe=(Re=Ee.stepsConfig)==null?void 0:Re[a];return Pe!=null&&Pe.autoCompleteStep?(ve=Pe.actions)==null?void 0:ve.some(le=>le.type==="show_form"&&le.formId===U):!1})){const Ee=$==null?void 0:$.actions;if(Ee&&Ee.length>1){J({title:"âœ… Formulaire reÃ§u",description:"Il reste d'autres actions Ã  complÃ©ter pour cette Ã©tape.",className:"bg-blue-500 text-white"});return}y(t,s,a),J({title:"Ã‰tape terminÃ©e !",description:"L'Ã©tape a Ã©tÃ© automatiquement marquÃ©e comme terminÃ©e.",className:"bg-green-500 text-white"})}},se=async(C,U=null)=>{var ye,Ne,Se,Ce,Ie,Ee,Pe,Re;const pe=(ye=C.stepsConfig)==null?void 0:ye[a];if(pe&&pe.actions&&pe.actions.length>0){const ve=L,le=[...pe.actions].sort((b,M)=>(b.order||0)-(M.order||0));let me=le,l=!1;if(U){const b=le.find(M=>M.id===U);if(!b){w.warn("Action spÃ©cifique introuvable",{specificActionId:U});return}w.info("ðŸŽ¯ ExÃ©cution action spÃ©cifique (forcÃ©e)",{actionId:U,actionType:b.type}),me=[b],l=!0}for(const b of me)if(!(!l&&ve.some(ae=>ae.promptId===C.id&&ae.stepIndex===a&&(ae.text===b.message||ae.formId===b.formId&&b.type==="show_form")))){if(b.message){const M={sender:"pro",text:b.message,promptId:C.id,stepIndex:a,actionId:b.id};u(t,s,M)}if(b.type==="show_form"&&b.formId){const M={sender:"pro",formId:b.formId,promptId:C.id,stepIndex:a,actionId:b.id};u(t,s,M);const ae=((Ce=(Se=(Ne=g[s])==null?void 0:Ne.steps)==null?void 0:Se[a])==null?void 0:Ce.name)||"Ã‰tape inconnue";try{const ge=await p({prospectId:t,projectType:s,formId:b.formId,currentStepIndex:a,promptId:C.id,messageTimestamp:Date.now(),status:"pending",stepName:ae,actionId:b.id});if(!ge.success)w.error("âŒ Ã‰chec enregistrement formulaire:",ge.error),J({title:"Erreur",description:"Le formulaire n'a pas pu Ãªtre enregistrÃ©.",variant:"destructive"});else try{const c=((Ie=x[b.formId])==null?void 0:Ie.name)||b.formId;await j({prospectId:t,projectType:s,title:"Formulaire envoyÃ©",description:`Le formulaire ${c} a Ã©tÃ© envoyÃ© Ã  ${(f==null?void 0:f.name)||"le client"}.`,createdBy:(k==null?void 0:k.user_id)||null,createdByName:(k==null?void 0:k.name)||"Admin"})}catch(c){w.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",c)}}catch(ge){w.error("âŒ Exception enregistrement formulaire:",ge),J({title:"Erreur",description:"Le formulaire n'a pas pu Ãªtre enregistrÃ©.",variant:"destructive"})}}if(b.type==="start_signature"&&b.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de gÃ©nÃ©rer le contrat");w.info("ðŸ”¥ GÃ©nÃ©ration contrat via workflow sÃ©quentiel",{templateId:b.templateId,prospectId:t,projectType:s,organizationId:r.organization_id,formId:b.formId});const{data:M,error:ae}=await be.from("prospects").select("form_data").eq("id",t).single(),ge=((Pe=(Ee=M==null?void 0:M.form_data)==null?void 0:Ee[s])==null?void 0:Pe[b.formId])||{};w.info("ðŸ“‹ DonnÃ©es formulaire extraites",{formId:b.formId,dataKeys:Object.keys(ge)}),J({title:"ðŸ“„ GÃ©nÃ©ration du contrat...",description:"CrÃ©ation du PDF en cours",className:"bg-blue-500 text-white"});const c=await ga({templateId:b.templateId,projectType:s,prospectId:t,formData:ge,organizationId:r==null?void 0:r.organization_id});if(c.success){const T=c.fileData.id;w.debug("CrÃ©ation procÃ©dure de signature...",{fileId:T,prospectId:t,projectType:s});const{data:z}=await be.from("signature_procedures").select("*").eq("file_id",T).eq("prospect_id",t).eq("status","pending").maybeSingle();let O=z;if(!O){const te=crypto.randomUUID(),re=new Date;re.setDate(re.getDate()+7);const we=[{role:"principal",name:(f==null?void 0:f.name)||"Client",email:f==null?void 0:f.email,phone:(f==null?void 0:f.phone)||null,access_token:te,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de crÃ©er la procÃ©dure de signature");const Te=typeof(f==null?void 0:f.name)=="string"&&f.name.trim()!==""?f.name:((Re=f==null?void 0:f.email)==null?void 0:Re.split("@")[0])||"Client",_e=f==null?void 0:f.email,{data:ut,error:He}=await be.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:T,access_token:te,access_token_expires_at:re.toISOString(),status:"pending",signers:we,organization_id:r.organization_id,signer_name:Te,signer_email:_e}).select().single();if(He)throw w.error("Erreur crÃ©ation signature_procedures",He),He;O=ut,w.debug("ProcÃ©dure de signature crÃ©Ã©e",{procedureId:O.id,signersCount:we.length})}const Q=`https://evatime.fr/signature/${O.id}?token=${O.access_token}`,{data:ee}=await be.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${O.id}%`).maybeSingle();ee||(await be.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${Q}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">ðŸ‘‰ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id}),w.debug("Lien de signature envoyÃ© dans le chat")),J({title:"âœ… Contrat gÃ©nÃ©rÃ© !",description:"Le contrat a Ã©tÃ© crÃ©Ã© et le lien de signature envoyÃ©.",className:"bg-green-500 text-white"});try{await j({prospectId:t,projectType:s,title:"Contrat gÃ©nÃ©rÃ©",description:`Le contrat a Ã©tÃ© gÃ©nÃ©rÃ© et envoyÃ© Ã  ${(f==null?void 0:f.name)||"le client"}.`,createdBy:(k==null?void 0:k.user_id)||null,createdByName:(k==null?void 0:k.name)||"Admin"})}catch(te){w.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",te)}}else throw new Error(c.error||"Erreur inconnue")}catch(M){w.error("âŒ Exception gÃ©nÃ©ration contrat:",M),J({title:"Erreur",description:`Impossible de gÃ©nÃ©rer le contrat: ${M.message}`,variant:"destructive"})}break}}F(!1)};return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[L.map((C,U)=>e.jsxs("div",{className:`flex items-end gap-2 ${C.sender==="pro"?"justify-end":"justify-start"}`,children:[C.sender==="client"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(f==null?void 0:f.name.charAt(0))||"?"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${C.sender==="pro"?"bg-blue-500 text-white rounded-br-none p-2.5":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[C.text&&(C.sender==="pro"&&C.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:C.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:C.text})),C.file&&e.jsxs("button",{onClick:()=>Y(C.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Le,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:C.file.name}),e.jsx(xt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),C.formId&&x[C.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(hr,{form:x[C.formId],prospectId:t,onFormSubmit:K})}),e.jsx("p",{className:`text-xs mt-1 ${C.sender==="pro"?"text-blue-200":"text-gray-500"}`,children:pa(new Date(C.timestamp),{addSuffix:!0,locale:qe})})]}),C.sender==="pro"&&!C.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},U)),e.jsx("div",{ref:D})]}),i&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Bt,{className:"w-4 h-4"}),e.jsx("span",{children:i.name}),e.jsx("button",{onClick:()=>d(null),className:"text-red-500",children:"Ã—"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Be,{placeholder:"Ã‰crire au client...",className:"pr-28 h-12",value:E,onChange:C=>v(C.target.value),onKeyPress:C=>C.key==="Enter"&&ce()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(fe,{variant:"ghost",size:"icon",onClick:()=>oe(!0),title:"Workflow V2 - Actions automatisÃ©es",children:e.jsx(gs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(fe,{variant:"ghost",size:"icon",onClick:()=>W.current.click(),disabled:P,children:e.jsx(Bt,{className:`h-5 w-5 ${P?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:W,onChange:Z,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:P}),e.jsx(fe,{onClick:ce,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:P,children:P?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Bs,{className:"h-4 w-4"})})]})]}),e.jsx(gr,{isOpen:ie,onClose:()=>oe(!1),prospectId:t,projectType:s,moduleId:o,moduleName:(B==null?void 0:B.name)||`Ã‰tape ${a+1}`,moduleConfig:$,context:{organizationId:he||(r==null?void 0:r.organization_id),adminUser:r},availableForms:q,availableTemplates:ne})]})},fr=({steps:t,onUpdateStatus:s,prompts:a,projectType:r,currentStepIndex:u,prospectId:m,completeStepAndProceed:g})=>{var j;if(!t)return null;const[x,S]=n.useState({}),{activeAdminUser:I,appointments:y,updateAppointment:p}=Ve(),L=a?Object.values(a).find(k=>k.projectId===r):null,h=(j=L==null?void 0:L.stepsConfig)==null?void 0:j[u],R=n.useMemo(()=>{if(!t[u])return[];const k=t[u].name,E=y.filter(v=>v.type==="task"&&v.contactId===m&&v.projectId===r&&v.step===k);return E.length>0&&w.debug("ðŸ” TÃ¢ches filtrÃ©es pour cette Ã©tape:",{prospectId:m,projectType:r,stepName:k,totalAppointments:y.length,filteredTasks:E.length,tasks:E.map(v=>({id:v.id,title:v.title,contactId:v.contactId,projectId:v.projectId,step:v.step}))}),E},[y,m,r,u,t]),P=(k,E)=>{S(v=>{var _;const i=v[k]||{},d={...i,[E]:!i[E]},D={...v,[k]:d},W=(_=h==null?void 0:h.actions)==null?void 0:_.find(F=>F.id===k);return W&&W.checklist&&W.checklist.every(ie=>d[ie.id])&&h!=null&&h.autoCompleteStep&&(J({title:"âœ… Checklist complÃ©tÃ©e !",description:"Passage automatique Ã  l'Ã©tape suivante...",className:"bg-green-500 text-white"}),g(m,r,u,t)),D})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((k,E)=>{const v=at[k.status]||at[ze];return e.jsxs(Ye.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:E*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${v.iconOnly}`,children:k.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${v.text}`,children:k.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[k.subSteps&&k.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[k.subSteps.filter(i=>i.status===Oe).length,"/",k.subSteps.length," sous-Ã©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(fe,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${v.badge} hover:opacity-90`,onClick:i=>{var _;i.stopPropagation();const d=i.currentTarget,D=d.nextElementSibling,W=d.closest("[data-step-status-container]");!D||!W||((_=W.parentElement)==null||_.querySelectorAll('[data-dropdown="step-status"]').forEach(F=>{F!==D&&F.classList.add("hidden")}),D.classList.toggle("hidden"))},children:v.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:i=>{var d;i.stopPropagation(),i.preventDefault(),s(E,ke),(d=i.currentTarget.parentElement)==null||d.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:i=>{var d;i.stopPropagation(),i.preventDefault(),s(E,Oe),(d=i.currentTarget.parentElement)==null||d.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:i=>{var d;i.stopPropagation(),i.preventDefault(),s(E,ze),(d=i.currentTarget.parentElement)==null||d.classList.add("hidden")},children:"Marquer Ã  venir"})]})]})]})]}),k.subSteps&&k.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:k.subSteps.map((i,d)=>{const D=at[i.status]||at[ze];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${i.status===Oe?"bg-green-500":i.status===ke?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:i.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${D.badge}`,children:D.label})]},i.id||d)})}),k.status===ke&&E===u&&(h==null?void 0:h.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:h.actions.filter(i=>i.hasClientAction===!1&&i.checklist&&i.checklist.length>0).map(i=>{const d=x[i.id]||{},D=i.checklist.length,W=i.checklist.filter(F=>d[F.id]).length,_=W===D;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"ðŸ“‹ Checklist Ã  complÃ©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${_?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[W,"/",D]})]}),e.jsx("div",{className:"space-y-2",children:i.checklist.map(F=>{const ie=d[F.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ie,onChange:()=>P(i.id,F.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ie?"text-purple-500 line-through":"text-purple-800"}`,children:F.text})]},F.id)})}),(h==null?void 0:h.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"âš¡ Passage automatique Ã  l'Ã©tape suivante quand tout est cochÃ©"})]},i.id)})}),k.status===ke&&E===u&&R.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:R.map(i=>{const d=i.status==="effectue",D=i.startTime?new Date(i.startTime):null,W=D&&!isNaN(D.getTime()),_=async()=>{const F=d?"pending":"effectue";await p(i.id,{status:F}),J({title:d?"ðŸ”„ TÃ¢che rÃ©ouverte":"âœ… TÃ¢che terminÃ©e",description:d?"La tÃ¢che a Ã©tÃ© remise en cours":"La tÃ¢che a Ã©tÃ© marquÃ©e comme terminÃ©e",className:d?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:_,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${d?"line-through text-gray-500":""} truncate flex-1`,children:i.title||"TÃ¢che"}),d&&e.jsx(dt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),W&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["ðŸ“… ",Ke(D,"dd/MM/yyyy Ã  HH:mm",{locale:qe})]})]})]},i.id)})})]})]},E)})})]})},br=({prospect:t,projectType:s,supabaseSteps:a,v2Templates:r,onUpdate:u})=>{var B;const{forms:m,prompts:g,completeStepAndProceed:x,activeAdminUser:S,appointments:I,updateAppointment:y}=Ve(),{formPanels:p=[],loading:L,updateFormPanel:h}=Hs(t.id),{sendMessage:R}=js(t.id,s),[P,j]=n.useState(null),[k,E]=n.useState({}),[v,i]=n.useState(!1),[d,D]=n.useState(null),[W,_]=n.useState(""),[F,ie]=n.useState(new Set),oe=n.useMemo(()=>{if(!p)return[];const o=p.filter($=>$.prospectId===t.id&&$.projectType===s).sort(($,q)=>(q.createdAt||0)-($.createdAt||0));return w.debug("[ProspectForms] Filtering panels",{totalPanels:p.length,prospectId:t.id,projectType:s,filteredCount:o.length,samplePanel:p[0]}),o},[p,t.id,s]);if(n.useEffect(()=>{!oe||oe.length===0||oe.forEach(o=>{var q,ne,f,V;if(F.has(o.panelId)||o.status!=="submitted")return;if(o.lastSubmittedAt){const N=new Date(o.lastSubmittedAt).getTime(),Z=Date.now()-N;if(Z>1e4){w.debug("Form too old, skipping auto-complete",{panelId:o.panelId,ageSeconds:Math.floor(Z/1e3)}),ie(Y=>new Set([...Y,o.panelId]));return}}w.debug("New submitted form detected",{panelId:o.panelId,formId:o.formId,projectType:o.projectType}),w.debug("Available prompts",{count:Object.keys(g).length});let $=null;if(o.promptId&&(w.debug("Searching by promptId",{promptId:o.promptId}),$=g[o.promptId]),$||($=Object.values(g).find(N=>{var Y,K;if(w.debug("Testing prompt",{name:N.name,projectId:N.projectId,target:o.projectType}),N.projectId!==o.projectType)return!1;const ce=(Y=N.stepsConfig)==null?void 0:Y[o.currentStepIndex];return(K=ce==null?void 0:ce.actions)==null?void 0:K.some(se=>se.type==="show_form"&&se.formId===o.formId)})),w.debug("Prompt found",{name:$==null?void 0:$.name,autoComplete:(ne=(q=$==null?void 0:$.stepsConfig)==null?void 0:q[o.currentStepIndex])==null?void 0:ne.autoCompleteStep}),$){const N=(f=$.stepsConfig)==null?void 0:f[o.currentStepIndex],ce=(V=N==null?void 0:N.actions)==null?void 0:V.find(Y=>Y.type==="show_form"&&Y.formId===o.formId),Z=(ce==null?void 0:ce.verificationMode)||"human";w.debug("Checking auto-complete conditions",{autoCompleteStep:N==null?void 0:N.autoCompleteStep,verificationMode:Z}),N!=null&&N.autoCompleteStep&&Z==="none"&&(w.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),x(t.id,o.projectType,o.currentStepIndex),J({title:"âœ… Ã‰tape terminÃ©e !",description:`${t.name} a complÃ©tÃ© le formulaire. Passage automatique Ã  l'Ã©tape suivante.`,className:"bg-green-500 text-white"}))}ie(N=>new Set([...N,o.panelId]))})},[oe,g,x,t.id,t.name,F]),oe.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const he=o=>{j(o.panelId);const ne=((t.form_data||t.formData||{})[o.projectType]||{})[o.formId]||{};E({...ne,_meta:{projectType:o.projectType,formId:o.formId}})},H=()=>{j(null),E({})},je=async()=>{const{_meta:o,...$}=k,{projectType:q,formId:ne}=o||{};if(!q||!ne){w.error("âŒ MÃ©tadonnÃ©es manquantes pour la sauvegarde");return}const f=t.form_data||t.formData||{},V={...f,[q]:{...f[q]||{},[ne]:$}},{error:N}=await be.from("prospects").update({form_data:V}).eq("id",t.id);if(N){w.error("âŒ Erreur sauvegarde formulaire:",N),J({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}J({title:"âœ… SauvegardÃ©",description:"Les modifications ont Ã©tÃ© enregistrÃ©es.",className:"bg-green-500 text-white"}),u&&u({...t,form_data:V,formData:V}),j(null),E({})},X=(o,$)=>{E(q=>({...q,[o]:$}))},A=o=>{var ne,f;const $=Object.values(g).find(V=>V.id===o.promptId||V.projectId===o.projectType),q=(ne=$==null?void 0:$.stepsConfig)==null?void 0:ne[o.currentStepIndex];return(f=q==null?void 0:q.actions)==null?void 0:f.find(V=>V.formId===o.formId)},G=async o=>{var $,q,ne,f,V,N;try{await h(o.panelId,{status:"approved"});const ce=A(o),Z=(ce==null?void 0:ce.verificationMode)||"human";if(w.debug("ðŸ” Checking verification mode",{verificationMode:Z,shouldSearchTask:Z==="human"}),Z==="human"){w.debug("ðŸ” Searching for related task",{totalAppointments:(I==null?void 0:I.length)||0,prospectId:t.id,projectType:o.projectType,stepName:o.stepName,panel:o});const ve=(I==null?void 0:I.filter(l=>l.type==="task"))||[],le=ve.filter(l=>l.contactId===t.id);w.debug("ðŸ” Task filtering debug",{allTasks:ve.length,prospectTasks:le.length,prospectTasksData:le.map(l=>({id:l.id,title:l.title,contactId:l.contactId,projectId:l.projectId,step:l.step,status:l.status}))}),w.debug("ðŸ” Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:o.projectType,step:o.stepName,status:"pending",titleIncludes:"VÃ©rifier le formulaire"}});let me=I==null?void 0:I.find(l=>{var ae;const b={isTask:l.type==="task",contactMatch:l.contactId===t.id,projectMatch:l.projectId===o.projectType,stepMatch:l.step===o.stepName,isPending:l.status==="pending",titleMatch:(ae=l.title)==null?void 0:ae.includes("VÃ©rifier le formulaire")},M=Object.values(b).every(ge=>ge);return!M&&l.type==="task"&&l.contactId===t.id&&w.warn("ðŸ” Task failed matching:",{taskId:l.id,title:l.title,checks:b,COMPARISON:{taskStep:`"${l.step}"`,panelStep:`"${o.stepName}"`,areEqual:l.step===o.stepName,taskStepType:typeof l.step,panelStepType:typeof o.stepName},taskData:{contactId:l.contactId,projectId:l.projectId,step:l.step,status:l.status},panelData:{projectType:o.projectType,stepName:o.stepName}}),M});me||(w.warn("âš ï¸ Task not found with exact step, trying fallback without step",{panelStep:o.stepName}),me=I==null?void 0:I.find(l=>{var b;return l.type==="task"&&l.contactId===t.id&&l.projectId===o.projectType&&l.status==="pending"&&((b=l.title)==null?void 0:b.includes("VÃ©rifier le formulaire"))}),me&&w.info("âœ… Found task via fallback (without step match)",{taskId:me.id,taskStep:me.step})),me?(w.info("âœ… Found verification task, marking as completed",{taskId:me.id,prospectId:t.id,title:me.title}),await y(me.id,{status:"effectue"}),J({title:"âœ… TÃ¢che mise Ã  jour",description:"La tÃ¢che de vÃ©rification a Ã©tÃ© marquÃ©e comme effectuÃ©e.",className:"bg-blue-500 text-white"})):w.warn("âš ï¸ No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:o.projectType,step:o.stepName,status:"pending",titleContains:"VÃ©rifier le formulaire"}})}else w.debug("â­ï¸ Skipping task search (verificationMode !== human)",{verificationMode:Z});const Y=a==null?void 0:a[o.projectType],K=Y==null?void 0:Y.findIndex(ve=>ve.status==="in_progress"),se=K!=null&&K>=0?K:o.currentStepIndex||0,ue=($=Y==null?void 0:Y[se])==null?void 0:$.name,de=ue?ue.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,C=`${o.projectType}:${de}`,U=de&&r?r[C]:null,pe=(q=U==null?void 0:U.configJson)==null?void 0:q.actionConfig;w.debug("[V2] Template lookup",{panelProjectType:o.projectType,propProjectType:s,currentStepName:ue,moduleId:de,templateKey:C,v2TemplatesKeys:r?Object.keys(r):[],templateFound:!!U});const ye=ue?hs(ue):null,Ne=(pe==null?void 0:pe.completionTrigger)||(ye==null?void 0:ye.completionTrigger),Se=(ne=U==null?void 0:U.configJson)==null?void 0:ne.actions,Ce=Se&&Se.length>1;let Ie=!0;if(Ce){const ve=Se.map((M,ae)=>`v2-${de}-action-${ae}`),{data:le}=await be.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",o.projectType).eq("status","approved");let me=new Set;(le||[]).forEach(M=>{M.action_id&&ve.includes(M.action_id)&&me.add(M.action_id)});const l=(le||[]).filter(M=>!M.action_id&&(!M.step_name||M.step_name===ue||M.step_name===de));if(l.length>0){const M=ve.filter(ae=>!me.has(ae));l.forEach((ae,ge)=>{ge<M.length&&me.add(M[ge])}),w.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:l.length,uncoveredIds:M,afterAssignment:[...me]})}const b=me.size;Ie=b>=Se.length,w.debug("[V2] Multi-actions check",{totalActions:Se.length,expectedActionIds:ve,approvedActionIds:[...me],panelsTotal:(le||[]).length,panelsWithActionId:(le||[]).filter(M=>M.action_id).length,panelsWithoutActionId:l.length,allCompleted:Ie}),Ie||(w.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:Se.length-b}),J({title:"âœ… Action validÃ©e",description:`Action ${b}/${Se.length} â€” il reste ${Se.length-b} action(s) avant de terminer l'Ã©tape.`,className:"bg-blue-500 text-white"}))}w.debug("[V2] Checking completionTrigger for form approval",{stepName:ue,moduleId:de,v2TemplateFound:!!U,completionTrigger:Ne,currentStepIdx:se,hasMultiActions:Ce,allActionsCompleted:Ie});const Ee=(Ne==="form_approved"||!Ne)&&Ie;let Pe=Y;if(Y&&((V=(f=Y[se])==null?void 0:f.subSteps)==null?void 0:V.length)>0){const ve=Y[se];let le=-1;if(o.action_id&&(le=ve.subSteps.findIndex(me=>me.id===o.action_id)),le===-1&&(le=ve.subSteps.findIndex(me=>me.status===ke),w.debug("[V2] Substep fallback: using first in_progress",{panelActionId:o.action_id,fallbackIndex:le})),le!==-1){w.debug("[V2] Updating substep for approved action",{actionId:o.action_id,subStepIndex:le,subStepName:ve.subSteps[le].name,allActionsCompleted:Ie});const me=JSON.parse(JSON.stringify(Y));if(me[se].subSteps.forEach((l,b)=>{l.status===ke&&b!==le&&(l.status=Oe)}),me[se].subSteps[le].status=Oe,!Ie){let l=-1;for(let b=le+1;b<me[se].subSteps.length;b++)if(me[se].subSteps[b].status===ze){l=b;break}l!==-1&&(me[se].subSteps[l].status=ke,w.debug("[V2] Activated next substep",{completedIndex:le,nextIndex:l,nextName:me[se].subSteps[l].name}))}await updateSupabaseSteps(o.projectType,me),Pe=me,w.info("[V2] Substep updated successfully",{completedSubStep:le,nextActivated:!Ie})}}if(Ee&&Pe)w.info("[V2] Form approved â†’ completing step",{prospectId:t.id,projectType:o.projectType,currentStepIdx:se,stepName:ue,trigger:Ne||"default_behavior"}),await x(t.id,o.projectType,se,Pe),J({title:"âœ… Ã‰tape validÃ©e automatiquement",description:"La validation du formulaire a dÃ©clenchÃ© le passage Ã  l'Ã©tape suivante",className:"bg-green-500 text-white"});else{const ve=Object.values(g).find(le=>le.id===o.promptId||le.projectId===o.projectType);if(ve){const le=(N=ve.stepsConfig)==null?void 0:N[o.currentStepIndex];le!=null&&le.autoCompleteStep&&(w.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:o.projectType,stepIndex:o.currentStepIndex}),Y?await x(t.id,o.projectType,o.currentStepIndex,Y):w.error("No steps found in supabaseSteps for projectType",{projectType:o.projectType}))}}const Re=o.filledByRole==="partner";if(Re)w.debug("Formulaire partenaire validÃ© â€” pas de message chat au client");else{const ve=(ce==null?void 0:ce.approvalMessage)||"Merci ! Votre formulaire a Ã©tÃ© validÃ©.",{data:le}=await be.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",o.projectType).eq("sender","admin").eq("text",ve).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!le||le.length===0?await R({sender:"admin",text:ve,relatedMessageTimestamp:new Date().toISOString()}):w.debug("Message de validation dÃ©jÃ  envoyÃ© rÃ©cemment, skip")}J({title:"âœ… Formulaire validÃ©",description:Re?"Le formulaire partenaire a Ã©tÃ© validÃ©.":"Un message a Ã©tÃ© envoyÃ© au client.",className:"bg-green-500 text-white"})}catch(ce){w.error("âŒ Erreur validation formulaire:",ce),J({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},xe=async(o="")=>{if(d)try{const $=d,q=$.filledByRole==="partner";await h($.panelId,{status:"rejected",rejectionReason:q?o:null});const ne=A($),f=(ne==null?void 0:ne.verificationMode)||"human";if(w.debug("ðŸ” Checking verification mode (reject)",{verificationMode:f,shouldSearchTask:f==="human",isPartnerForm:q}),f==="human"){w.debug("ðŸ” Searching for related task (reject)",{totalAppointments:(I==null?void 0:I.length)||0,prospectId:t.id,projectType:$.projectType,stepName:$.stepName}),w.debug("ðŸ” Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:$.projectType,step:$.stepName,status:"pending",titleIncludes:"VÃ©rifier le formulaire"}});let V=I==null?void 0:I.find(N=>{var Y;const ce={isTask:N.type==="task",contactMatch:N.contactId===t.id,projectMatch:N.projectId===$.projectType,stepMatch:N.step===$.stepName,isPending:N.status==="pending",titleMatch:(Y=N.title)==null?void 0:Y.includes("VÃ©rifier le formulaire")},Z=Object.values(ce).every(K=>K);return!Z&&N.type==="task"&&N.contactId===t.id&&w.warn("ðŸ” Task failed matching (REJECT):",{taskId:N.id,title:N.title,checks:ce,COMPARISON:{taskStep:`"${N.step}"`,panelStep:`"${$.stepName}"`,areEqual:N.step===$.stepName,taskStepType:typeof N.step,panelStepType:typeof $.stepName},taskData:{contactId:N.contactId,projectId:N.projectId,step:N.step,status:N.status},panelData:{projectType:$.projectType,stepName:$.stepName}}),Z});V||(w.warn("âš ï¸ Task not found with exact step (reject), trying fallback",{panelStep:$.stepName}),V=I==null?void 0:I.find(N=>{var ce;return N.type==="task"&&N.contactId===t.id&&N.projectId===$.projectType&&N.status==="pending"&&((ce=N.title)==null?void 0:ce.includes("VÃ©rifier le formulaire"))}),V&&w.info("âœ… Found task via fallback (reject, without step match)",{taskId:V.id,taskStep:V.step})),V&&(w.info("âœ… Found verification task, marking as completed (rejected)",{taskId:V.id,prospectId:t.id,title:V.title}),await y(V.id,{status:"effectue"}))}else w.debug("â­ï¸ Skipping task search (reject, verificationMode !== human)",{verificationMode:f});if(q)J({title:"âŒ Formulaire rejetÃ©",description:"Le partenaire verra la raison du refus sur sa mission.",className:"bg-red-500 text-white"});else{const N=`${(ne==null?void 0:ne.rejectionMessage)||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :"}

${o}`;await R({sender:"admin",text:N,relatedMessageTimestamp:new Date().toISOString()}),J({title:"âŒ Formulaire rejetÃ©",description:"Un message a Ã©tÃ© envoyÃ© au client.",className:"bg-red-500 text-white"})}i(!1),D(null),_("")}catch($){w.error("âŒ Erreur rejet formulaire:",$),J({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[oe.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:oe.map(o=>{var f,V;const $=m[o.formId];let q={};if(o.filledByRole==="partner"&&o.formData?q=o.formData:q=((t.form_data||t.formData||{})[o.projectType]||{})[o.formId]||{},!$)return null;const ne=o.stepName||((V=(f=a==null?void 0:a[o.projectType])==null?void 0:f[o.currentStepIndex])==null?void 0:V.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:$.name}),ne&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ã‰tape : ",ne]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${o.status==="submitted"?"bg-green-100 text-green-700":o.status==="approved"?"bg-blue-100 text-blue-700":o.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:o.status==="submitted"?"EnvoyÃ©":o.status==="approved"?"ApprouvÃ©":o.status==="rejected"?"RejetÃ©":"En attente"})]}),o.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["âœ… ",o.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(fe,{size:"sm",onClick:()=>G(o),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(dt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(fe,{size:"sm",variant:"outline",onClick:()=>{D(o),i(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),o.status==="rejected"&&o.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:o.rejectionReason.startsWith("Mission impossible")?"â›” Mission dÃ©clarÃ©e impossible par le partenaire":"âŒ Formulaire rejetÃ©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:o.rejectionReason.startsWith("Mission impossible â€” ")?o.rejectionReason.replace("Mission impossible â€” ",""):o.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:($.fields||[]).map(N=>{if(N.show_if_conditions&&N.show_if_conditions.length>0){const K=N.condition_operator||"AND",se=N.show_if_conditions.map(de=>{const C=q[de.field];return de.equals==="has_value"?!!C&&C!=="":C===de.equals});if(!(K==="AND"?se.every(de=>de===!0):se.some(de=>de===!0)))return null}if(N.show_if){const K=N.show_if.field,se=N.show_if.equals,ue=q[K];if(!ue||ue!==se)return null}if(($.fields||[]).some(K=>K.is_repeater&&(K.repeats_fields||[]).includes(N.id)))return null;const Z=q[N.id],Y=N.type==="file"&&typeof Z=="object"&&(Z==null?void 0:Z.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-sm font-medium text-gray-600",children:N.label}),P===o.panelId?Y?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Le,{className:"inline h-4 w-4 mr-2"}),Z.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):N.type==="select"?e.jsxs("select",{value:k[N.id]||"",onChange:K=>X(N.id,K.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(N.options||[]).map((K,se)=>e.jsx("option",{value:K,children:K},se))]}):e.jsx(Be,{type:N.type||"text",value:k[N.id]||"",onChange:K=>X(N.id,K.target.value),placeholder:N.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:Y?e.jsxs("button",{onClick:async()=>{try{const{data:K,error:se}=await be.storage.from("project-files").createSignedUrl(Z.storagePath,3600);if(se)throw se;window.open(K.signedUrl,"_blank")}catch{J({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsx("span",{children:Z.name}),e.jsx(xt,{className:"h-3 w-3"})]}):Z||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseignÃ©"})}),N.is_repeater&&N.repeats_fields&&N.repeats_fields.length>0&&Z&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(Z)||0},(K,se)=>{const ue=($.fields||[]).filter(de=>N.repeats_fields.includes(de.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[N.label," #",se+1]}),ue.map(de=>{const C=`${N.id}_repeat_${se}_${de.id}`,U=q[C],pe=de.type==="file"&&typeof U=="object"&&(U==null?void 0:U.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:de.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:pe?e.jsxs("button",{onClick:async()=>{try{const{data:ye,error:Ne}=await be.storage.from("project-files").createSignedUrl(U.storagePath,3600);if(Ne)throw Ne;window.open(ye.signedUrl,"_blank")}catch{J({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Le,{className:"h-3 w-3"}),e.jsx("span",{children:U.name}),e.jsx(xt,{className:"h-3 w-3"})]}):U||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseignÃ©"})})]},C)})]},se)})})]},N.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:P===o.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(fe,{variant:"outline",size:"sm",onClick:H,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(fe,{size:"sm",onClick:je,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Ot,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(fe,{variant:"outline",size:"sm",onClick:()=>he(o),children:[e.jsx(ht,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},o.panelId)})}),e.jsx(pt,{open:v,onOpenChange:i,children:e.jsxs(ft,{className:"max-w-lg",children:[e.jsxs(bt,{children:[e.jsx(jt,{children:"Rejeter le formulaire"}),e.jsx(ps,{children:"Expliquez au client pourquoi le formulaire est rejetÃ©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((B=A(d))==null?void 0:B.rejectionMessage)||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Me,{children:"Raison du refus"}),e.jsx("textarea",{value:W,onChange:o=>_(o.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Mt,{children:[e.jsx(fe,{variant:"outline",onClick:()=>{i(!1),D(null),_("")},children:"Annuler"}),e.jsx(fe,{onClick:()=>xe(W),disabled:!W.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},jr=({prospect:t,projectType:s,onUpdate:a})=>{const{forms:r}=Ve(),[u,m]=n.useState(null),[g,x]=n.useState({}),S=n.useMemo(()=>Object.values(r).filter(h=>h.audience==="internal"&&(h.projectIds||[]).includes(s)),[r,s]);n.useEffect(()=>{if(t&&t.form_data){const h=t.form_data[s]||{};x(h)}},[t,s]);const I=h=>{m(h)},y=()=>{if(m(null),t&&t.form_data){const h=t.form_data[s]||{};x(h)}},p=(h,R,P)=>{x(j=>({...j,[h]:{...j[h]||{},[R]:P}}))},L=async()=>{try{const h={...t.form_data||{},[s]:g},R={...t,form_data:h,formData:h};await a(R),J({title:"âœ… Formulaire enregistrÃ©",description:"Les donnÃ©es du formulaire interne ont Ã©tÃ© sauvegardÃ©es.",className:"bg-green-500 text-white"}),m(null)}catch(h){w.error("Erreur sauvegarde formulaire interne:",h),J({title:"âŒ Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[S.length," formulaire(s)"]})]}),S.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'CrÃ©ez un formulaire avec "Interne (Ã©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:S.map(h=>{const R=g[h.id]||{},P=u===h.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:h.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (Ã©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(h.fields||[]).map(j=>{if(j.show_if_conditions&&j.show_if_conditions.length>0){const v=j.condition_operator||"AND",i=j.show_if_conditions.map(D=>{const W=R[D.field];return D.equals==="has_value"?!!W&&W!=="":W===D.equals});if(!(v==="AND"?i.every(D=>D===!0):i.some(D=>D===!0)))return null}if(j.show_if){const v=j.show_if.field,i=j.show_if.equals,d=R[v];if(!d||d!==i)return null}if((h.fields||[]).some(v=>v.is_repeater&&(v.repeats_fields||[]).includes(j.id)))return null;const E=R[j.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Me,{className:"text-sm font-medium text-gray-600",children:[j.label,j.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),P?j.type==="textarea"?e.jsx("textarea",{value:E,onChange:v=>p(h.id,j.id,v.target.value),placeholder:j.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):j.type==="select"?e.jsxs("select",{value:E,onChange:v=>p(h.id,j.id,v.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(j.options||[]).map((v,i)=>e.jsx("option",{value:v,children:v},i))]}):e.jsx(Be,{type:j.type||"text",value:E,onChange:v=>p(h.id,j.id,v.target.value),placeholder:j.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:E||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseignÃ©"})}),j.is_repeater&&j.repeats_fields&&j.repeats_fields.length>0&&E&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(E)||0},(v,i)=>{const d=(h.fields||[]).filter(D=>j.repeats_fields.includes(D.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[j.label," #",i+1]}),d.map(D=>{const W=`${j.id}_repeat_${i}_${D.id}`,_=R[W]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:D.label}),P?D.type==="textarea"?e.jsx("textarea",{value:_,onChange:F=>p(h.id,W,F.target.value),placeholder:D.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):D.type==="select"?e.jsxs("select",{value:_,onChange:F=>p(h.id,W,F.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(D.options||[]).map((F,ie)=>e.jsx("option",{value:F,children:F},ie))]}):e.jsx(Be,{type:D.type||"text",value:_,onChange:F=>p(h.id,W,F.target.value),placeholder:D.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:_||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseignÃ©"})})]},W)})]},i)})})]},j.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:P?e.jsxs(e.Fragment,{children:[e.jsxs(fe,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(fe,{size:"sm",onClick:L,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Ot,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(fe,{variant:"outline",size:"sm",onClick:()=>I(h.id),children:[e.jsx(ht,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},h.id)})})]})},yr=t=>{switch(t.type){case"email":return e.jsx(yt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(tt,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Ws,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(vt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(it,{className:"h-4 w-4 text-gray-400"}):e.jsx(Gs,{className:"h-4 w-4 text-gray-400"})}},vr=({prospect:t,onBack:s,onUpdate:a,onEditingChange:r})=>{var ge;const{getProjectSteps:u,completeStepAndProceed:m,updateProjectSteps:g,markNotificationAsRead:x,projectsData:S,formContactConfig:I,currentUser:y,userProjects:p,setUserProjects:L,getProjectInfo:h,updateProjectInfo:R,activeAdminUser:P,prompts:j,notifications:k}=Ve(),{supabaseUserId:E}=st(),{users:v,loading:i}=ct(),{projectStepsStatus:d,updateProjectSteps:D}=la(t.id),{organizationId:W}=ot(),{templates:_}=ys(W||(P==null?void 0:P.organization_id),null),[F,ie]=xs(),oe=F.get("project")||t._selectedProjectType,he=F.get("notificationId"),[H,je]=n.useState(oe||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:X,addProjectEvent:A}=et({projectType:H||"",prospectId:t.id,enabled:!!H&&!!t.id,activeAdminUser:P}),[G,xe]=n.useState(!1),[B,o]=n.useState(t);n.useEffect(()=>{o(t)},[t]);const[$,q]=n.useState(!1),ne=n.useMemo(()=>H?h(t.id,H)||{}:{},[H,h,t.id]),[f,V]=n.useState((ne==null?void 0:ne.status)||"actif"),[N,ce]=n.useState({}),Z=ne==null?void 0:ne.amount,Y=n.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[K,se]=n.useState(""),[ue,de]=n.useState(!1),C=n.useMemo(()=>[{value:"unassigned",label:"Non assignÃ©"},...v.map(c=>({value:c.user_id,label:c.name}))],[v]),U=n.useMemo(()=>{var T;if(!H)return[];if(d[H])return d[H].map(z=>Ut(z,H,_)).map(Zt);const c=(T=S[H])==null?void 0:T.steps;if(c&&c.length>0){const z=JSON.parse(JSON.stringify(c));return z[0].status="in_progress",z.map(O=>Ut(O,H,_)).map(Zt)}return[]},[H,d,S,_]),pe=U.findIndex(c=>c.status===ke),ye=U[pe]||U.find(c=>c.status===ze)||U[0];n.useEffect(()=>{if(he){x(parseInt(he));const c=new URLSearchParams(F);c.delete("notificationId"),ie(c,{replace:!0})}},[he,x,ie,F]),n.useEffect(()=>{var T;const c=F.get("project");c&&c!==H&&((T=t.tags)!=null&&T.includes(c))&&je(c)},[F,t.tags]),n.useEffect(()=>{if(!(t!=null&&t.id)||!H||!k||!x)return;const c=k.filter(T=>!T.read&&T.prospectId===t.id&&T.projectType===H);c.length>0&&c.forEach(T=>{x(T.id)})},[t==null?void 0:t.id,H,k,x]),n.useEffect(()=>{w.debug("Prospect prop changed",{name:t.name}),o(t)},[t]),n.useEffect(()=>{ue||(Z==null||Z===""?se(""):se(Z.toString()))},[Z,ue]),n.useEffect(()=>{(async()=>{var O;if(!H||!t.id)return;const{data:T,error:z}=await be.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",H).maybeSingle();z?(w.error("Erreur chargement project status:",z),V("actif")):(O=T==null?void 0:T.data)!=null&&O.status?V(T.data.status):V("actif")})()},[H,t.id]),n.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:T,error:z}=await be.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(T){const O={};T.forEach(Q=>{O[Q.project_type]=Q.status||"actif"}),ce(O)}})()},[t.id,t.tags]),n.useEffect(()=>{r&&r(G)},[G,r]),n.useEffect(()=>{if(!t.id)return;const c=be.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async T=>{var Te;const{new:z,old:O}=T;if(z.status!=="signed"||(O==null?void 0:O.status)==="signed")return;const Q=z.project_type;w.info("[V2 Signature Listener] Signature completed",{procedureId:z.id,projectType:Q,prospectId:z.prospect_id});const ee=d==null?void 0:d[Q];if(!ee||ee.length===0){w.warn("[V2 Signature Listener] No steps found for project type",{projectType:Q});return}const te=ee.findIndex(_e=>_e.status==="in_progress");if(te===-1){w.warn("[V2 Signature Listener] No current step in_progress",{projectType:Q});return}const re=(Te=ee[te])==null?void 0:Te.name;if(!re){w.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:te});return}const we=hs(re);if((we==null?void 0:we.completionTrigger)!=="signature"){w.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:re,completionTrigger:(we==null?void 0:we.completionTrigger)||"null"});return}w.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:Q,currentStepIdx:te,stepName:re});try{await m(t.id,Q,te,ee),J({title:"âœ… Ã‰tape validÃ©e automatiquement",description:`La signature a dÃ©clenchÃ© la validation de "${re}"`,className:"bg-green-500 text-white"})}catch(_e){w.error("[V2 Signature Listener] Error completing step",_e)}}).subscribe();return()=>{be.removeChannel(c)}},[t.id,d,m]);const Ne=c=>{je(c),ie(T=>(T.set("project",c),T),{replace:!0})},Se=async c=>{if(!H||!t.id)return;const T=f;V(c);try{const{error:z}=await be.from("project_infos").upsert({prospect_id:t.id,project_type:H,status:c,data:(ne==null?void 0:ne.data)||{}},{onConflict:"prospect_id,project_type"});if(z)throw z;const O={actif:"rÃ©activÃ©",abandon:"abandonnÃ©",archive:"archivÃ©"},{error:Q}=await be.from("project_history").insert({prospect_id:t.id,project_type:H,event_type:"status",description:`Projet ${O[c]||c}`,organization_id:P==null?void 0:P.organization_id,metadata:{old_status:T,new_status:c}});Q&&w.error("Erreur historique:",Q),R(t.id,H,(ee={})=>({...ee,status:c})),ce(ee=>({...ee,[H]:c})),J({title:"âœ… Statut mis Ã  jour",description:`Le projet est maintenant "${O[c]}".`,className:"bg-green-500 text-white"})}catch(z){w.error("Erreur lors du changement de statut:",z),V(T),J({title:"âŒ Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},Ce=c=>{se(c)},Ie=c=>{if(!H)return;const T=c.replace(",",".").trim();if(T===""){R(t.id,H,(Q={})=>{if(!Q.amount)return Q;const ee={...Q};return delete ee.amount,ee}),se("");return}const z=parseFloat(T);if(Number.isNaN(z)||z<0){se(Z==null?"":Z.toString());return}const O=Math.round(z*100)/100;R(t.id,H,(Q={})=>({...Q,amount:O})),se(O.toFixed(2))},Ee=()=>{Ie(K),de(!1)},Pe=c=>{c.key==="Enter"&&(c.preventDefault(),Ie(c.currentTarget.value),c.currentTarget.blur(),de(!1))},Re=async(c,T)=>{var O,Q;const z=U[c];if(T===Oe&&((O=z==null?void 0:z.subSteps)==null?void 0:O.length)>0&&!xr(z)){J({title:"Sous-Ã©tapes en cours",description:"Vous devez valider chaque sous-Ã©tape avant de terminer cette Ã©tape.",variant:"destructive"});return}if(T===ke&&((Q=z==null?void 0:z.subSteps)==null?void 0:Q.length)>0){const ee=JSON.parse(JSON.stringify(U)),te=ee[c];te.status=ke,te.subSteps=te.subSteps.map((re,we)=>({...re,status:we===0?ke:ze})),await D(H,ee),X&&await X({event_type:"pipeline",title:"Ã‰tape relancÃ©e",description:`Sous-Ã©tapes rÃ©initialisÃ©es pour Â« ${te.name} Â»`,metadata:{step_id:(te==null?void 0:te.id)||null,step_name:(te==null?void 0:te.name)||null,previous_status:(z==null?void 0:z.status)||null,new_status:ke,project_type:H},createdBy:E,createdByName:(P==null?void 0:P.name)||(P==null?void 0:P.email)});return}if(T===Oe){const ee=JSON.parse(JSON.stringify(U));ee[c].status="completed";let te=c+1;if(te<ee.length&&(ee[te].status="in_progress"),await D(H,ee),X){const re=te<ee.length?ee[te]:null;await X({event_type:"pipeline",title:"Ã‰tape du pipeline mise Ã  jour",description:z&&re?`Ã‰tape Â« ${z.name} Â» complÃ©tÃ©e â†’ passage Ã  Â« ${re.name} Â»`:`Ã‰tape Â« ${z.name} Â» complÃ©tÃ©e`,metadata:{previous_step_id:(z==null?void 0:z.id)||null,previous_step_name:(z==null?void 0:z.name)||null,previous_step_status:(z==null?void 0:z.status)||null,new_step_id:(re==null?void 0:re.id)||null,new_step_name:(re==null?void 0:re.name)||null,new_step_status:"in_progress",project_type:H},createdBy:E,createdByName:(P==null?void 0:P.name)||(P==null?void 0:P.email)})}if(te<ee.length&&ee[te].globalStepId){const re=ee[te].globalStepId,we={...t,status:re};a(we),J({title:"ðŸ“Š Pipeline mis Ã  jour",description:"Le prospect a Ã©tÃ© dÃ©placÃ© dans le pipeline"})}}else{const ee=U.map((re,we)=>{let Te=re.status;return we===c&&(Te=T),{...re,status:Te}});if(await D(H,ee),X){const re=ee[c];await X({event_type:"pipeline",title:"Ã‰tape du pipeline mise Ã  jour",description:`Ã‰tape Â« ${re.name} Â» passÃ©e de Â« ${z.status==="pending"?"Ã€ venir":z.status==="in_progress"?"En cours":"TerminÃ©"} Â» Ã  Â« ${T==="pending"?"Ã€ venir":T==="in_progress"?"En cours":"TerminÃ©"} Â»`,metadata:{step_id:(re==null?void 0:re.id)||null,step_name:(re==null?void 0:re.name)||null,previous_status:(z==null?void 0:z.status)||null,new_status:T,project_type:H},createdBy:E,createdByName:(P==null?void 0:P.name)||(P==null?void 0:P.email)})}const te=ee[c];if(te.globalStepId&&T==="in_progress"){const re={...t,status:te.globalStepId};a(re)}}},ve=async c=>{var z,O;const T=B.tags||[];if(!T.includes(c)){const Q={...B,tags:[...T,c]};if(o(Q),a(Q),je(c),y&&t.id===y.id&&!p.includes(c)){const te=[...p,c];L(te)}const ee=(z=S[c])==null?void 0:z.steps;if(ee&&ee.length>0)try{const te=JSON.parse(JSON.stringify(ee));te[0].status="in_progress",await D(c,te),w.debug("Steps initialized in Supabase",{projectType:c})}catch(te){w.error("Steps initialization error:",te)}J({title:"âœ… Projet ajoutÃ© !",description:`Le projet ${(O=S[c])==null?void 0:O.title} a Ã©tÃ© associÃ© au prospect.`})}q(!1)},le=()=>{const c=B.tags||[];return Object.values(S).filter(T=>T.isPublic&&!c.includes(T.type))},me=async c=>{switch(c){case"Appel":B.phone&&(window.location.href=`tel:${B.phone}`);break;case"Mail":B.email&&(window.location.href=`mailto:${B.email}`);break;case"WhatsApp":if(B.phone){const T=B.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${T}`,"_blank")}else J({title:"NumÃ©ro de tÃ©lÃ©phone manquant",description:"Ce contact n'a pas de numÃ©ro de tÃ©lÃ©phone.",variant:"destructive"});break;case"GPS":if(t.address){const T=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${T}`:window.open(`https://www.google.com/maps/search/?api=1&query=${T}`,"_blank")}break;case"Invitation":if(!B.email){J({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const T=`${window.location.origin}/dashboard`,z=W||(P==null?void 0:P.organization_id);console.log("[handleActionClick] ðŸ“§ Sending magic link to:",B.email,"org:",z);const{error:O}=await be.auth.signInWithOtp({email:B.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:T,data:{organization_id:z}}});O?(console.error("[handleActionClick] âŒ Magic link error:",O),J({title:"âŒ Erreur envoi invitation",description:O.message,variant:"destructive"})):(console.log("[handleActionClick] âœ… Magic link sent to:",B.email),J({title:"âœ… Invitation envoyÃ©e",description:`Magic link envoyÃ© Ã  ${B.email}`,className:"bg-green-500 text-white"}))}catch(T){console.error("[handleActionClick] ðŸ’¥ Exception:",T),J({title:"âŒ Erreur",description:T.message,variant:"destructive"})}break;default:J({title:`Action: ${c}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},l=()=>{const c=window.scrollY;xe(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:c,behavior:"instant"})})})},b=()=>{try{a(B),xe(!1),J({title:"âœ… Prospect mis Ã  jour",description:"Les informations du prospect ont Ã©tÃ© enregistrÃ©es."})}catch(c){w.error("âŒ Erreur sauvegarde:",c),J({title:"âŒ Erreur",description:c.message,variant:"destructive"})}},M=(c,T)=>{o(z=>({...z,[c]:T}))},ae=c=>{let T=c;c==="unassigned"?T=null:c==="user-1"&&E&&(T=E),o(z=>({...z,ownerId:T}))};return S[H],n.useEffect(()=>{const c=document.createElement("style");return c.id="disable-auto-scroll",c.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(c),()=>{const T=document.getElementById("disable-auto-scroll");T&&T.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(fe,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Os,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:B.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associÃ©s"}),e.jsx(fe,{size:"icon",className:"rounded-full",onClick:()=>q(!0),children:e.jsx(Pt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(B.tags||[]).map(c=>{var z;const T=N[c]||"actif";return e.jsxs("button",{onClick:()=>Ne(c),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${H===c?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((z=S[c])==null?void 0:z.title)||c}),T==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${H===c?"text-red-200":"text-red-600"}`,children:"(AbandonnÃ©)"}),T==="archive"&&e.jsx("span",{className:`text-xs font-medium ${H===c?"text-gray-300":"text-gray-500"}`,children:"(ArchivÃ©)"})]},c)}),(!B.tags||B.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associÃ©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"},{icon:zs,label:"Invitation",highlight:!B.userId}].map(({icon:c,label:T,highlight:z})=>e.jsxs("button",{onClick:()=>me(T),className:`flex flex-col items-center space-x-1 transition-colors group ${z?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${z?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(c,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:T})]},T))})]}),e.jsx(Nr,{prospectId:t.id,projectType:H}),e.jsx(br,{prospect:B,projectType:H,supabaseSteps:d,v2Templates:_,onUpdate:c=>{o(c),a&&a(c)}}),e.jsx(jr,{prospect:B,projectType:H,onUpdate:c=>{o(c),a&&a(c)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),G?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(fe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:b,children:e.jsx(Ot,{className:"h-4 w-4"})}),e.jsx(fe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>xe(!1),children:e.jsx(Je,{className:"h-4 w-4"})})]}):e.jsx(fe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:l,children:e.jsx(ht,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[I.map(c=>e.jsxs("div",{className:"flex items-start space-x-3",children:[yr(c),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{htmlFor:c.id,className:"text-xs text-gray-500",children:c.name.replace("*","")}),G?e.jsx(Be,{id:c.id,name:c.id,type:c.type,value:B[c.id]||"",onChange:T=>M(c.id,T.target.value),className:"h-8 text-sm",placeholder:c.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:B[c.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseignÃ©"})})]})]},c.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(it,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"Suivi par"}),G?e.jsx(ia,{options:C,value:B.ownerId||"unassigned",onSelect:ae,placeholder:"SÃ©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouvÃ©."}):e.jsx("p",{className:"text-gray-700",children:((ge=v.find(c=>c.user_id===B.ownerId))==null?void 0:ge.name)||"Non assignÃ©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(it,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assignÃ©"})]})]})]})]})]}),e.jsx(or,{prospectId:t.id,projectType:H,currentStep:ye,statusConfig:at,activeAdminUser:P,children:H&&e.jsx(pr,{prospectId:t.id,projectType:H,currentStepIndex:pe!==-1?pe:0,activeAdminUser:P})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[H&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>de(!ue),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:ue?"Annuler":"Modifier le montant",children:ue?e.jsx(Je,{className:"h-4 w-4 text-gray-600"}):e.jsx(ht,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),ue?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"â‚¬"}),e.jsx(Be,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:K,onChange:c=>Ce(c.target.value),onKeyDown:Pe,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(fe,{size:"sm",onClick:Ee,className:"h-8",children:e.jsx(dt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof Z=="number"?Y.format(Z):"0,00 â‚¬"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Ã‰tapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Tt,{value:f,onValueChange:Se,children:[e.jsx(Rt,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${f==="actif"?"bg-green-100 text-green-700":f==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Ft,{})}),e.jsxs($t,{className:"w-44",children:[e.jsx($e,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx($e,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"AbandonnÃ©"}),e.jsx($e,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"ArchivÃ©"})]})]})]})}),e.jsx(fr,{steps:U,onUpdateStatus:Re,prompts:j,projectType:H,currentStepIndex:pe,prospectId:t.id,completeStepAndProceed:m})]})]})]})]}),e.jsx(pt,{open:$,onOpenChange:q,children:e.jsxs(ft,{className:"sm:max-w-md",children:[e.jsxs(bt,{children:[e.jsx(jt,{children:"Ajouter un projet"}),e.jsx(ps,{children:"SÃ©lectionnez un projet Ã  associer Ã  ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:le().length>0?le().map(c=>e.jsxs(fe,{variant:"outline",onClick:()=>ve(c.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:c.icon}),e.jsx("span",{className:"font-medium",children:c.title})]},c.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont dÃ©jÃ  associÃ©s Ã  ce prospect."})})]})})]})},Nr=({prospectId:t,projectType:s})=>{var X;const{activeAdminUser:a,prospects:r,projectsData:u,appointments:m,agendaLoading:g,updateAppointment:x,deleteAppointment:S,addAppointment:I,addCall:y,addTask:p,updateCall:L,updateTask:h}=Ve(),{users:R,loading:P}=ct(),{supabaseUserId:j}=st(),[k,E]=n.useState(null),[v,i]=n.useState(null),[d,D]=n.useState(null),[W,_]=n.useState(!1),[F,ie]=n.useState(null),oe=n.useMemo(()=>!m||m.length===0?[]:m.filter(G=>{var B;if(G.contactId!==t||s&&G.projectId!==s)return!1;const xe=(B=G.status)==null?void 0:B.toLowerCase();return!(xe!=="pending"&&xe!=="prevu")}).sort((G,xe)=>{const B=new Date(G.start),o=new Date(xe.start);return B-o}),[m,t,s]),he=(A,G)=>{D(A)},H=()=>{E(null),i(null),D(null)},je=A=>{D(null),ie({...A,type:A.type}),_(!0)};return g?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"ActivitÃ© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activitÃ©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["ActivitÃ©s Ã  venir ",s&&`(${(X=u[s])==null?void 0:X.title})`]})}),oe.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activitÃ© future planifiÃ©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:oe.map(A=>{const G=new Date(A.start),xe={physical:{icon:nt,color:"blue",label:"ðŸ“ RDV"},virtual:{icon:nt,color:"purple",label:"ðŸŽ¥ Visio"},call:{icon:tt,color:"green",label:"ðŸ“ž Appel"},task:{icon:dt,color:"yellow",label:"âœ… TÃ¢che"}},B=xe[A.type]||xe.physical,o=B.icon,$={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},q={effectue:"EffectuÃ©",annule:"AnnulÃ©",reporte:"ReportÃ©",pending:"PrÃ©vu"};return e.jsxs("div",{onClick:()=>he(A,A.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${B.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(o,{className:`h-5 w-5 text-${B.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:A.title||B.label}),A.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:A.notes}),A.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["ðŸ“ ",A.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${B.color}-700 bg-${B.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Ke(G,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Ke(G,"HH:mm")})]})]}),q[A.status]&&A.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${$[A.status]}`,children:q[A.status]})]},A.id)})})]}),e.jsx(wr,{event:d,onClose:H,onReport:()=>{},onEdit:je,prospects:r,supabaseUsers:R,updateAppointment:x,deleteAppointment:S,projectsData:u}),W&&e.jsx(fs,{open:W,onOpenChange:A=>{A||ie(null),_(A)},initialData:F||{contactId:t,projectId:s},defaultAssignedUserId:j,addAppointment:I,addCall:y,addTask:p,updateAppointment:x,updateCall:L,updateTask:h,prospects:r||[],users:R||[],projectsData:u||{}})]})},wr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:u,supabaseUsers:m,updateAppointment:g,deleteAppointment:x,projectsData:S})=>{var v;const[I,y]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!u||!m||!g||!x||!S)return null;const p=u.find(i=>i.id===t.contactId),L=m.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(p?m.find(i=>i.user_id===p.ownerId):null),h=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",R=(i,d,D={})=>{try{const W=new Date(i);return isNaN(W.getTime())?"Date invalide":Ke(W,d,D)}catch{return"Date invalide"}},P=i=>{y(i),g(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},j=()=>{x(t.id),J({title:"âœ… RDV supprimÃ©",description:"Le rendez-vous a Ã©tÃ© retirÃ© de votre agenda."}),s()},k=i=>{if(!p){J({title:"Contact non trouvÃ©",variant:"destructive"});return}switch(i){case"Appel":p.phone&&(window.location.href=`tel:${p.phone}`);break;case"Mail":p.email&&(window.location.href=`mailto:${p.email}`);break;case"WhatsApp":if(p.phone){let d=p.phone.replace(/\D/g,"");d.startsWith("0")&&(d=`33${d.substring(1)}`);const D=encodeURIComponent("Bonjour");window.open(`https://wa.me/${d}?text=${D}`,"_blank")}break;case"GPS":if(p.address){const d=encodeURIComponent(p.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${d}`:window.open(`https://www.google.com/maps/search/?api=1&query=${d}`,"_blank")}break;default:J({title:`Action: ${i}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activitÃ©"},effectue:{color:"bg-green-500",label:"EffectuÃ©"},annule:{color:"bg-red-500",label:"AnnulÃ©"},reporte:{color:"bg-yellow-500",label:"ReportÃ©"}};return e.jsx(pt,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(ft,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:h(R(t.start,"eeee d MMMM",{locale:qe}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[R(t.start,"HH:mm",{locale:qe})," - ",R(t.end,"HH:mm",{locale:qe})]})]}),e.jsx(bt,{className:"p-0 text-left space-y-1",children:e.jsx(jt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(Ue,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),p&&e.jsxs("p",{className:"text-sm",children:[p.name," (Client)"]}),L&&e.jsxs("p",{className:"text-sm",children:[L.name," (AssignÃ©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"}].map(({icon:i,label:d})=>e.jsxs("button",{onClick:()=>k(d),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:d})]},d))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[I].color}`,children:e.jsxs(Tt,{onValueChange:P,value:I,children:[e.jsx(Rt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ft,{placeholder:"Qualifier votre activitÃ©"})}),e.jsxs($t,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activitÃ©"}),e.jsx($e,{value:"effectue",children:"EffectuÃ©"}),e.jsx($e,{value:"annule",children:"AnnulÃ©"}),e.jsx($e,{value:"reporte",children:"ReportÃ©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activitÃ©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((v=S[t.projectId])==null?void 0:v.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ã‰tape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(p==null?void 0:p.name)||"N/A"})]})]})]}),e.jsxs(Mt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(as,{children:[e.jsx(rs,{asChild:!0,children:e.jsxs(fe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Lt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(os,{children:"Cette action est irrÃ©versible. Le rendez-vous sera dÃ©finitivement supprimÃ©."})]}),e.jsxs(cs,{children:[e.jsx(ds,{children:"Annuler"}),e.jsx(us,{onClick:j,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(fe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activitÃ©"})]})]})})};function Sr(t,s){const a=t.prospect,r=s.prospect;return!a||!r?!1:a.id===r.id&&(a.updatedAt||a.updated_at)===(r.updatedAt||r.updated_at)}const _r=gt.memo(vr,Sr),es=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Ir=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",Ge=t=>(t||"").toString().trim().toUpperCase(),Cr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},kr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFIÃ‰",name:"QualifiÃ©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"NÃ‰GOCIATION",name:"NÃ©gociation"},{id:"closed",label:"FERMÃ‰",name:"FermÃ©"}],ts=50,ss=50,qr=()=>{var le,me;const t=Ve(),[s,a]=xs(),{organizationId:r}=ot(),[u,m]=n.useState(null),[g,x]=n.useState(!1),[S,I]=n.useState("all"),[y,p]=n.useState(null),[L,h]=n.useState(!1),[R,P]=n.useState([]),[j,k]=n.useState(!1),E=n.useRef(null),[v,i]=n.useState(""),d=n.useRef(null),[D,W]=n.useState(!1),[_,F]=n.useState(!1),[ie,oe]=n.useState({}),{users:he,loading:H}=ct(),{authUserId:je}=st(),X=t==null?void 0:t.addProspect,{prospects:A=[],prospectsLoading:G=!0,allProjectSteps:xe={},allStepsLoading:B=!0,updateProspect:o=async()=>{},projectsData:$={},activeAdminUser:q=null,users:ne={},globalPipelineSteps:f=[],pipelineLoading:V=!0,getProjectSteps:N=()=>[],adminReady:ce=!1}=t||{},Z=n.useMemo(()=>he.reduce((l,b)=>(l[b.user_id]={id:b.id,user_id:b.user_id,name:b.name,email:b.email,role:b.role,phone:b.phone,avatarUrl:b.avatar_url,managerId:b.manager_id,accessRights:b.access_rights},l),{}),[he]);n.useEffect(()=>{ce&&!G&&!B&&!_&&F(!0)},[ce,G,B,_]);const Y=A,K=o,se=(A==null?void 0:A.find(l=>l.id===u))||null,ue=n.useMemo(()=>!f||f.length===0?kr:f.map((l,b)=>{const M=Ge(l.label),ae=l.color||Cr[M]||es[b%es.length];return{id:l.id,label:l.label,name:Ir(l.label),color:ae}}),[f]),de=n.useMemo(()=>{if(!q)return[];if(q.role==="Global Admin"||q.role==="Admin")return Object.values(Z);const l=q.access_rights||q.accessRights,b=[q.user_id,...(l==null?void 0:l.users)||[]];return Object.values(Z).filter(M=>b.includes(M.user_id))},[q,Z]),C=n.useMemo(()=>{const l=de.map(b=>({value:b.user_id,label:b.name}));return de.length>1?[{value:"all",label:"Tous les utilisateurs"},...l]:l},[de]);n.useEffect(()=>{q&&y===null&&(de.length>1?p("all"):de.length===1&&p(de[0].user_id))},[q,y,de]),n.useEffect(()=>{if(!j)return;const l=b=>{E.current&&!E.current.contains(b.target)&&k(!1)};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[j]);const U=n.useMemo(()=>{const l=new Set;return Y.forEach(b=>{(b.tags||[]).forEach(M=>l.add(M))}),Array.from(l)},[Y]),pe=R.length===0?"Tags":R.length===1?((le=$[R[0]])==null?void 0:le.title)||R[0]:`${R.length} tags`,ye=n.useMemo(()=>{const l=Y.filter(M=>{if(!q)return!1;if(q.role==="Global Admin"||q.role==="Admin")return!0;const ae=q.access_rights||q.accessRights;return[q.user_id,...(ae==null?void 0:ae.users)||[]].includes(M.ownerId)});w.debug("[FinalPipeline] Prospects count",{total:Y.length,visible:l.length});let b=l;if(R.length>0&&(b=b.filter(M=>{const ae=M.tags||[];return R.some(ge=>ae.includes(ge))})),y&&y!=="all"&&(b=b.filter(M=>M.ownerId===y)),v.trim()){const M=v.toLowerCase();b=b.filter(ae=>(ae.name||"").toLowerCase().includes(M)||(ae.email||"").toLowerCase().includes(M)||(ae.city||"").toLowerCase().includes(M)||(ae.phone||"").toLowerCase().includes(M))}return S==="mine"&&je?b.filter(M=>M.ownerId===je):b},[Y,S,je,y,R,v]),{stagesWithCounts:Ne,prospectsByStage:Se}=n.useMemo(()=>{var z;const l=ue.reduce((O,Q)=>(O[Q.id]=[],O),{}),b=((z=ue[0])==null?void 0:z.id)||"fallback-stage",M=new Set(ue.map(O=>O.id)),ae=new Map(ue.map(O=>[Ge(O.label),O.id])),ge=O=>{const Q=[];return O.projectType&&$[O.projectType]&&Q.push(O.projectType),Array.isArray(O.tags)&&O.tags.forEach(ee=>{$[ee]&&!Q.includes(ee)&&Q.push(ee)}),Q},c=O=>{const Q=[];if(!f.length){const te=O.stage||b,re=M.has(te)?te:b;return Q.push({stageId:re,prospect:O}),Q}if(typeof N!="function")return Q.push({stageId:b,prospect:O}),Q;const ee=ge(O);return ee.length?(ee.forEach(te=>{var qt;const re=`${O.id}-${te}`,we=xe[re]||(typeof N=="function"?N(O.id,te):[])||[],Te=((qt=$[te])==null?void 0:qt.steps)||[];if(!we.length){Q.push({stageId:b,prospect:O,projectType:te});return}const _e=we.find(We=>We.status==="in_progress"||We.status==="current")||we.find(We=>We.status==="pending")||we[we.length-1];if(!_e){Q.push({stageId:b,prospect:O,projectType:te});return}const He=(()=>{if(_e.globalStepId&&M.has(_e.globalStepId))return _e.globalStepId;if(_e.globalStepId){const Xe=Ge(_e.globalStepId),De=ae.get(Xe);if(De&&M.has(De))return De}const We=we.indexOf(_e);let Ae=null;if(We>=0&&Te[We]&&(Ae=Te[We]),!Ae){const Xe=Ge(_e.name||_e.label);Ae=Te.find(De=>Ge(De.name||De.label)===Xe)}if(Ae!=null&&Ae.globalStepId&&M.has(Ae.globalStepId))return Ae.globalStepId;if(Ae!=null&&Ae.globalStepId){const Xe=Ge(Ae.globalStepId),De=ae.get(Xe);if(De&&M.has(De))return De}if(Ae&&(Ae.label||Ae.name)){const Xe=Ge(Ae.label||Ae.name),De=ae.get(Xe);if(De&&M.has(De))return De}const Cs=Ge(_e.label||_e.name),wt=ae.get(Cs);return wt&&M.has(wt)?wt:b})();Q.push({stageId:He,prospect:O,projectType:te,activeStep:_e})}),Q):(Q.push({stageId:b,prospect:O}),Q)};return ye.forEach(O=>{c(O).forEach(({stageId:ee,projectType:te,activeStep:re})=>{l[ee]||(l[ee]=[]),l[ee].push({prospect:O,projectType:te,activeStep:re})})}),{stagesWithCounts:ue.map(O=>{var Q;return{...O,count:((Q=l[O.id])==null?void 0:Q.length)||0}}),prospectsByStage:l}},[ue,ye,f,N,$]);n.useEffect(()=>{const l=s.get("prospect"),b=s.get("project"),M=`${l}-${b}`;if(d.current===M)return;if(!l){u!==null&&(m(null),d.current=null);return}(Y.find(ge=>ge.id===l)||null)&&(m(l),d.current=M)},[s,Y]);const Ce=l=>{P(b=>b.includes(l)?b.filter(M=>M!==l):[...b,l])},Ie=n.useCallback((l,b)=>{m(l.id),a(M=>{const ae=new URLSearchParams(M);return ae.set("prospect",l.id),b?ae.set("project",b):ae.delete("project"),ae})},[a]),Ee=n.useCallback(l=>{oe(b=>({...b,[l]:(b[l]||ts)+ss}))},[]),Pe=()=>{m(null);const l=new URLSearchParams(s);l.delete("prospect"),l.delete("project"),a(l)},Re=async l=>{var b,M;try{if(!X)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const ae=((b=f[0])==null?void 0:b.step_id)||((M=f[0])==null?void 0:M.id);console.log("[handleAddProspect] calling addProspect",{name:l.name,email:l.email,status:ae,ownerId:q==null?void 0:q.user_id,sendInvitation:l.sendInvitation,allData:l});const ge=await X({...l,status:ae,ownerId:q==null?void 0:q.user_id});if(console.log("[handleAddProspect] result",ge),!(ge!=null&&ge.id))throw new Error("Prospect non crÃ©Ã© - rÃ©sultat vide");if(console.log("[handleAddProspect] ðŸ” sendInvitation check:",{sendInvitation:l.sendInvitation,email:ge.email,willSend:l.sendInvitation&&ge.email}),l.sendInvitation&&ge.email)try{const c=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] ðŸ“§ Sending magic link to:",ge.email.trim(),"redirect:",c,"org:",r);const{error:T}=await be.auth.signInWithOtp({email:ge.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:c,data:{organization_id:r}}});T?(console.error("[handleAddProspect] âŒ invitation error",T),J({title:"Prospect crÃ©Ã©",description:`âš ï¸ Invitation non envoyÃ©e: ${T.message}`,variant:"warning"})):(console.log("[handleAddProspect] âœ… invitation sent to",ge.email),J({title:"âœ… Prospect crÃ©Ã©",description:`Invitation envoyÃ©e Ã  ${ge.email}`,className:"bg-green-500 text-white"}))}catch(c){console.error("[handleAddProspect] ðŸ’¥ invitation exception",c),J({title:"Prospect crÃ©Ã©",description:`âš ï¸ Erreur envoi invitation: ${c.message}`,variant:"warning"})}else console.log("[handleAddProspect] â­ï¸ Skipping invitation:",{reason:l.sendInvitation?"no email":"sendInvitation=false"});x(!1)}catch(ae){console.error("âŒ handleAddProspect error",ae),J({title:"Erreur",description:ae.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},ve=l=>{try{K&&(K(l),J({title:"Prospect mis Ã  jour",description:"Les informations ont Ã©tÃ© sauvegardÃ©es."}))}catch{J({title:"Erreur",description:"Impossible de mettre Ã  jour le prospect.",variant:"destructive"})}};return se&&se.id?e.jsx(Ye.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Js,{name:"Fiche Prospect",children:e.jsx(_r,{prospect:se,onBack:Pe,onUpdate:ve,onEditingChange:W})})}):_?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ue,{className:"w-4 h-4"}),e.jsxs("span",{children:[ye.length," prospect",ye.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:E,className:"relative inline-block text-left",children:[e.jsxs(fe,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>k(l=>!l),children:[e.jsx("span",{children:pe}),e.jsx(_t,{className:"h-4 w-4"})]}),j&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[U.map(l=>{var b;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:R.includes(l),onChange:()=>Ce(l),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((b=$[l])==null?void 0:b.title)||l})]},l)}),R.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>P([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la sÃ©lection"})]})]})})]}),e.jsxs(Xs,{open:L,onOpenChange:h,children:[e.jsx(Ys,{asChild:!0,children:e.jsxs(fe,{variant:"outline",role:"combobox","aria-expanded":L,className:"w-[230px] justify-between",children:[e.jsx(Ue,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:y==="all"?"Tous les utilisateurs":((me=Z[y])==null?void 0:me.name)||"Utilisateur"}),e.jsx(_t,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(Ks,{className:"w-[200px] p-0",children:e.jsxs(Qs,{children:[e.jsx(Zs,{placeholder:"Rechercher..."}),e.jsxs(Us,{children:[e.jsx(ea,{children:"Aucun utilisateur"}),e.jsx(ta,{children:C.map(l=>e.jsxs(sa,{value:l.label,onSelect:()=>{p(l.value),h(!1)},children:[e.jsx(dt,{className:Qe("mr-2 h-4 w-4",y===l.value?"opacity-100":"opacity-0")}),l.label]},l.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(aa,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Be,{type:"text",placeholder:"Rechercher un prospect...",value:v,onChange:l=>i(l.target.value),className:"pl-9 pr-4"}),v&&e.jsx("button",{onClick:()=>i(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"Ã—"})]}),e.jsxs(fe,{onClick:()=>x(!0),children:[e.jsx(Pt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Ne.map(l=>e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${l.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:l.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(Se[l.id]||[]).filter(b=>{if(R.length===0)return!0;const{projectType:M}=b;return R.some(ae=>ae.toUpperCase()===(M||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const b=(Se[l.id]||[]).filter(T=>{if(R.length===0)return!0;const{projectType:z}=T;return R.some(O=>O.toUpperCase()===(z||"").toUpperCase())}),M=ie[l.id]||ts,ae=b.slice(0,M),ge=b.length>M,c=b.length-M;return e.jsxs(e.Fragment,{children:[ae.map((T,z)=>{var He;const{prospect:O,projectType:Q,activeStep:ee}=T,te=`${O.id}-${Q||"default"}-${l.id}-${z}`,re=O.projectType||O.tags&&O.tags[0]||"Projet",we=Q&&((He=$[Q])!=null&&He.title)?$[Q].title:re,Te=(ee==null?void 0:ee.label)||(ee==null?void 0:ee.name)||l.name,_e=l.color||"bg-blue-100 text-blue-700",ut=`${O.id}-${Q||we}-${l.id}-${z}`;return e.jsx(Ye.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(Ua,{prospect:{...O,_projectContext:{projectType:Q||re,projectTitle:we,stepLabel:Te,projectColor:_e}},onClick:()=>Ie(O,Q||O.projectType||(Array.isArray(O.tags)?O.tags[0]:re)),compact:!0,sortableId:ut,projectsData:$})},te)}),ge&&e.jsxs("button",{onClick:()=>Ee(l.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(c,ss)," de plus (",c," restants)"]}),b.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(Ue,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},l.id))})})}),e.jsx(ra,{open:g,onOpenChange:x,onAddProspect:Re}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(l=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},l))})})})]})};export{qr as default};
