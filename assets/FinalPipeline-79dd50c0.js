import{c as Tt,r as i,R as pt,u as Ts,j as e,m as Ke,C as ot,l as S,s as ge,a as ut,b as We,d as Rs,e as st,f as Ms,g as kt,h as mt,B as pe,P as Rt,i as He,D as bt,k as jt,X as Ye,n as yt,o as Nt,U as tt,p as at,M as vt,q as Mt,t as wt,S as $t,v as Ft,w as Ot,x as Lt,y as $e,z as zt,A as is,E as ls,T as qt,F as os,G as cs,H as ds,I as us,J as ms,K as gs,L as xs,N as X,O as Oe,Q as $s,V as ps,W as Fs,Y as hs,Z as Wt,_ as Os,$ as Ls,a0 as Ue,a1 as zs,a2 as qs,a3 as Vs,a4 as ct,a5 as Bs,a6 as fs,a7 as bs,a8 as Hs,a9 as Ws,aa as Fe,ab as Je,ac as gt,ad as js,ae as ys,af as Gs,ag as Js,ah as Xs,ai as Ys,aj as Ks,ak as Qs,al as Zs,am as Us,an as ea,ao as ta,ap as sa,aq as aa,ar as ra,as as na,at as ia,au as la,av as oa,aw as ca,ax as da}from"./index-96849cdf.js";import{u as rt,A as Ns,C as ua}from"./Agenda-de384de2.js";import{S as ma}from"./SearchableSelect-6255de57.js";import{u as ga}from"./useSupabaseProjectStepsStatus-c58ecce5.js";import{u as vs}from"./useSupabaseProjectFiles-566ee720.js";import{F as xa,a as pa,P as ha,b as fa,e as ba,u as ws,S as Vt,c as ja}from"./useSupabaseWorkflowModuleTemplates-22c678bb.js";import{f as Qe,V as ya}from"./index-4884effa.js";import{D as ht}from"./download-c0868ab9.js";import{i as Na}from"./workflowV2Config-f801420c.js";import{P as ft}from"./pen-square-74172f8e.js";import{P as Gt}from"./paperclip-5472075b.js";import"./external-link-43bd0df9.js";const va=Tt("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),wa=Tt("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),_a=Tt("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function Sa(){for(var t=arguments.length,s=new Array(t),r=0;r<t;r++)s[r]=arguments[r];return i.useMemo(()=>a=>{s.forEach(g=>g(a))},s)}const Ia=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function Ca(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function ka(t){return"nodeType"in t}function _s(t){var s,r;return t?Ca(t)?t:ka(t)&&(s=(r=t.ownerDocument)==null?void 0:r.defaultView)!=null?s:window:window}const _t=Ia?i.useLayoutEffect:i.useEffect;function Ss(t){const s=i.useRef(t);return _t(()=>{s.current=t}),i.useCallback(function(){for(var r=arguments.length,a=new Array(r),g=0;g<r;g++)a[g]=arguments[g];return s.current==null?void 0:s.current(...a)},[])}function Et(t,s){s===void 0&&(s=[t]);const r=i.useRef(t);return _t(()=>{r.current!==t&&(r.current=t)},s),r}function At(t){const s=Ss(t),r=i.useRef(null),a=i.useCallback(g=>{g!==r.current&&(s==null||s(g,r.current)),r.current=g},[]);return[r,a]}let Ct={};function Is(t,s){return i.useMemo(()=>{if(s)return s;const r=Ct[t]==null?0:Ct[t]+1;return Ct[t]=r,t+"-"+r},[t,s])}function Ea(t){if(!t)return!1;const{KeyboardEvent:s}=_s(t.target);return s&&t instanceof s}const dt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:r}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(r?Math.round(r):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:r}=t;return"scaleX("+s+") scaleY("+r+")"}},Transform:{toString(t){if(t)return[dt.Translate.toString(t),dt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:r,easing:a}=t;return s+" "+r+"ms "+a}}});var lt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(lt||(lt={}));function Jt(){}const Aa=Object.freeze({x:0,y:0});function Pa(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Da(t,s,r){const a=Pa(s);if(!a)return t;const{scaleX:g,scaleY:m,x:h,y:f}=a,C=t.left-h-(1-g)*parseFloat(r),P=t.top-f-(1-m)*parseFloat(r.slice(r.indexOf(" ")+1)),N=g?t.width/g:t.width,b=m?t.height/m:t.height;return{width:N,height:b,top:P,right:C+N,bottom:P+b,left:C}}const Ta={ignoreTransform:!1};function Bt(t,s){s===void 0&&(s=Ta);let r=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:P,transformOrigin:N}=_s(t).getComputedStyle(t);P&&(r=Da(r,P,N))}const{top:a,left:g,width:m,height:h,bottom:f,right:C}=r;return{top:a,left:g,width:m,height:h,bottom:f,right:C}}function Xt(t){return Bt(t,{ignoreTransform:!0})}var et;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(et||(et={}));var Yt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Yt||(Yt={}));var Me;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Me||(Me={}));Me.Space,Me.Enter,Me.Esc,Me.Space,Me.Enter,Me.Tab;var Kt;(function(t){t[t.RightClick=2]="RightClick"})(Kt||(Kt={}));var Qt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Qt||(Qt={}));var Zt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Zt||(Zt={}));et.Backward+"",et.Forward+"",et.Backward+"",et.Forward+"";var Pt;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(Pt||(Pt={}));var Dt;(function(t){t.Optimized="optimized"})(Dt||(Dt={}));function Ra(t){let{callback:s,disabled:r}=t;const a=Ss(s),g=i.useMemo(()=>{if(r||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:m}=window;return new m(a)},[r]);return i.useEffect(()=>()=>g==null?void 0:g.disconnect(),[g]),g}function Ma(t,s){return i.useMemo(()=>t.reduce((r,a)=>{let{eventName:g,handler:m}=a;return r[g]=h=>{m(h,s)},r},{}),[t,s])}Pt.WhileDragging,Dt.Optimized;const $a={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Jt,draggableNodes:new Map,over:null,measureDroppableContainers:Jt},Cs=i.createContext($a),Fa=i.createContext({...Aa,scaleX:1,scaleY:1});var Ut;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Ut||(Ut={}));const Oa=i.createContext(null),es="button",La="Draggable";function za(t){let{id:s,data:r,disabled:a=!1,attributes:g}=t;const m=Is(La),{activators:h,activatorEvent:f,active:C,activeNodeRect:P,ariaDescribedById:N,draggableNodes:b,over:q}=i.useContext(Cs),{role:p=es,roleDescription:O="draggable",tabIndex:T=0}=g??{},_=(C==null?void 0:C.id)===s,L=i.useContext(_?Fa:Oa),[D,I]=At(),[o,u]=At(),R=Ma(h,s),H=Et(r);_t(()=>(b.set(s,{id:s,key:m,node:D,activatorNode:o,data:H}),()=>{const M=b.get(s);M&&M.key===m&&b.delete(s)}),[b,s]);const k=i.useMemo(()=>({role:p,tabIndex:T,"aria-disabled":a,"aria-pressed":_&&p===es?!0:void 0,"aria-roledescription":O,"aria-describedby":N.draggable}),[a,p,T,_,O,N.draggable]);return{active:C,activatorEvent:f,activeNodeRect:P,attributes:k,isDragging:_,listeners:a?void 0:R,node:D,over:q,setNodeRef:I,setActivatorNodeRef:u,transform:L}}const qa="Droppable",Va={timeout:25};function Ba(t){let{data:s,disabled:r=!1,id:a,resizeObserverConfig:g}=t;const m=Is(qa),{active:h,dispatch:f,over:C,measureDroppableContainers:P}=i.useContext(Cs),N=i.useRef({disabled:r}),b=i.useRef(!1),q=i.useRef(null),p=i.useRef(null),{disabled:O,updateMeasurementsFor:T,timeout:_}={...Va,...g},L=Et(T??a),D=i.useCallback(()=>{if(!b.current){b.current=!0;return}p.current!=null&&clearTimeout(p.current),p.current=setTimeout(()=>{P(Array.isArray(L.current)?L.current:[L.current]),p.current=null},_)},[_]),I=Ra({callback:D,disabled:O||!h}),o=i.useCallback((k,M)=>{I&&(M&&(I.unobserve(M),b.current=!1),k&&I.observe(k))},[I]),[u,R]=At(o),H=Et(s);return i.useEffect(()=>{!I||!u.current||(I.disconnect(),b.current=!1,I.observe(u.current))},[u,I]),i.useEffect(()=>(f({type:lt.RegisterDroppable,element:{id:a,key:m,disabled:r,node:u,rect:q,data:H}}),()=>f({type:lt.UnregisterDroppable,key:m,id:a})),[a]),i.useEffect(()=>{r!==N.current.disabled&&(f({type:lt.SetDroppableDisabled,id:a,key:m,disabled:r}),N.current.disabled=r)},[a,m,r,f]),{active:h,rect:q,isOver:(C==null?void 0:C.id)===a,node:u,over:C,setNodeRef:R}}function ks(t,s,r){const a=t.slice();return a.splice(r<0?a.length+r:r,0,a.splice(s,1)[0]),a}function xt(t){return t!==null&&t>=0}const Ha=t=>{let{rects:s,activeIndex:r,overIndex:a,index:g}=t;const m=ks(s,a,r),h=s[g],f=m[g];return!f||!h?null:{x:f.left-h.left,y:f.top-h.top,scaleX:f.width/h.width,scaleY:f.height/h.height}},Wa="Sortable",Ga=pt.createContext({activeIndex:-1,containerId:Wa,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Ha,disabled:{draggable:!1,droppable:!1}}),Ja=t=>{let{id:s,items:r,activeIndex:a,overIndex:g}=t;return ks(r,a,g).indexOf(s)},Xa=t=>{let{containerId:s,isSorting:r,wasDragging:a,index:g,items:m,newIndex:h,previousItems:f,previousContainerId:C,transition:P}=t;return!P||!a||f!==m&&g===h?!1:r?!0:h!==g&&s===C},Ya={duration:200,easing:"ease"},Es="transform",Ka=dt.Transition.toString({property:Es,duration:0,easing:"linear"}),Qa={roleDescription:"sortable"};function Za(t){let{disabled:s,index:r,node:a,rect:g}=t;const[m,h]=i.useState(null),f=i.useRef(r);return _t(()=>{if(!s&&r!==f.current&&a.current){const C=g.current;if(C){const P=Bt(a.current,{ignoreTransform:!0}),N={x:C.left-P.left,y:C.top-P.top,scaleX:C.width/P.width,scaleY:C.height/P.height};(N.x||N.y)&&h(N)}}r!==f.current&&(f.current=r)},[s,r,a,g]),i.useEffect(()=>{m&&h(null)},[m]),m}function Ua(t){let{animateLayoutChanges:s=Xa,attributes:r,disabled:a,data:g,getNewIndex:m=Ja,id:h,strategy:f,resizeObserverConfig:C,transition:P=Ya}=t;const{items:N,containerId:b,activeIndex:q,disabled:p,disableTransforms:O,sortedRects:T,overIndex:_,useDragOverlay:L,strategy:D}=i.useContext(Ga),I=er(a,p),o=N.indexOf(h),u=i.useMemo(()=>({sortable:{containerId:b,index:o,items:N},...g}),[b,g,o,N]),R=i.useMemo(()=>N.slice(N.indexOf(h)),[N,h]),{rect:H,node:k,isOver:M,setNodeRef:ne}=Ba({id:h,data:u,disabled:I.droppable,resizeObserverConfig:{updateMeasurementsFor:R,...C}}),{active:ce,activatorEvent:he,activeNodeRect:ve,attributes:V,setNodeRef:G,listeners:E,isDragging:Q,over:oe,setActivatorNodeRef:de,transform:l}=za({id:h,data:u,attributes:{...Qa,...r},disabled:I.draggable}),$=Sa(ne,G),B=!!ce,ue=B&&!O&&xt(q)&&xt(_),A=!L&&Q,z=A&&ue?l:null,ie=ue?z??(f??D)({rects:T,activeNodeRect:ve,activeIndex:q,overIndex:_,index:o}):null,ee=xt(q)&&xt(_)?m({id:h,items:N,activeIndex:q,overIndex:_}):o,w=ce==null?void 0:ce.id,Z=i.useRef({activeId:w,items:N,newIndex:ee,containerId:b}),re=N!==Z.current.items,me=s({active:ce,containerId:b,isDragging:Q,isSorting:B,id:h,index:o,items:N,newIndex:Z.current.newIndex,previousItems:Z.current.items,previousContainerId:Z.current.containerId,transition:P,wasDragging:Z.current.activeId!=null}),le=Za({disabled:!me,index:o,node:k,rect:H});return i.useEffect(()=>{B&&Z.current.newIndex!==ee&&(Z.current.newIndex=ee),b!==Z.current.containerId&&(Z.current.containerId=b),N!==Z.current.items&&(Z.current.items=N)},[B,ee,b,N]),i.useEffect(()=>{if(w===Z.current.activeId)return;if(w&&!Z.current.activeId){Z.current.activeId=w;return}const ye=setTimeout(()=>{Z.current.activeId=w},50);return()=>clearTimeout(ye)},[w]),{active:ce,activeIndex:q,attributes:V,data:u,rect:H,index:o,newIndex:ee,items:N,isOver:M,isSorting:B,isDragging:Q,listeners:E,node:k,overIndex:_,over:oe,setNodeRef:$,setActivatorNodeRef:de,setDroppableNodeRef:ne,setDraggableNodeRef:G,transform:le??ie,transition:Se()};function Se(){if(le||re&&Z.current.newIndex===o)return Ka;if(!(A&&!Ea(he)||!P)&&(B||me))return dt.Transition.toString({...P,property:Es})}}function er(t,s){var r,a;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(r=t==null?void 0:t.draggable)!=null?r:s.draggable,droppable:(a=t==null?void 0:t.droppable)!=null?a:s.droppable}}Me.Down,Me.Right,Me.Up,Me.Left;const tr=t=>(t||"").toString().trim().toUpperCase(),sr=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const r=t.prospect,a=s.prospect;if(r.id!==a.id||r.name!==a.name||r.hasAppointment!==a.hasAppointment||r.updatedAt!==a.updatedAt)return!1;const g=r._projectContext||{},m=a._projectContext||{};if(g.projectType!==m.projectType||g.projectTitle!==m.projectTitle||g.stepLabel!==m.stepLabel)return!1;const h=r.tags||[],f=a.tags||[];return!(h.length!==f.length||h.some((C,P)=>C!==f[P])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},ar=({prospect:t,onClick:s,sortableId:r,projectsData:a={}})=>{var _,L,D,I,o,u,R;Ts();const g=Array.isArray(t.tags)?t.tags:[],m=((_=t._projectContext)==null?void 0:_.projectTitle)||((L=t._projectContext)==null?void 0:L.projectType)||null,h=((D=t._projectContext)==null?void 0:D.projectType)||null;(I=t._projectContext)!=null&&I.stepLabel;const f=m?tr(m):null,C=r||(f?`${t.id}-${f}`:`${t.id}-${((o=t._projectContext)==null?void 0:o.projectType)||"default"}`),{attributes:P,listeners:N,setNodeRef:b,transform:q,transition:p,isDragging:O}=Ua({id:C,data:{prospect:t}}),T={transform:dt.Transform.toString(q),transition:p,zIndex:O?10:"auto",opacity:O?.8:1};return e.jsx("div",{ref:b,style:T,...P,...N,children:e.jsxs(Ke.div,{layoutId:`prospect-card-${C}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(ot,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[m&&g.includes(((u=t._projectContext)==null?void 0:u.projectType)||m)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((R=a[h])==null?void 0:R.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:m})}),g.filter(H=>H!==h).map(H=>{var ne,ce;const k=((ne=a[H])==null?void 0:ne.title)||H,M=((ce=a[H])==null?void 0:ce.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:k},H)})]})]})})},rr=i.memo(ar,sr);function nr({prospectId:t,projectType:s,currentStepIndex:r,prompt:a,sendNextAction:g}){const m=i.useRef(new Set);i.useRef(!1),i.useEffect(()=>{if(!t||!s||r===void 0||!a)return;S.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:r,promptName:a==null?void 0:a.name});const h=ge.channel(`workflow-forms-${t}-${s}-${r}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async f=>{const C=f.new;S.info("üîç Form panel UPDATE re√ßu",{panelId:C.id,prospectId:C.prospect_id,projectType:C.project_type,status:C.status,actionId:C.action_id,expectedProjectType:s});const P=C.project_type===s,N=C.status==="approved",b=!!C.action_id;if(P&&N&&b){const q=`${t}-${s}-${r}-${C.action_id}`;if(m.current.has(q)){S.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:q});return}m.current.add(q),S.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:C.form_id,actionId:C.action_id}),setTimeout(()=>{S.info("üöÄ Envoi action suivante",{completedActionId:C.action_id}),g(C.action_id)},2e3)}}).subscribe();return()=>{ge.removeChannel(h)}},[t,s,r,a,g])}function ir({projectType:t,prospectId:s,enabled:r=!0}){const[a,g]=i.useState([]),[m,h]=i.useState(!1),[f,C]=i.useState(!1),[P,N]=i.useState(null),{organizationId:b}=ut(),q=i.useCallback(async()=>{if(!(!t||!r))try{h(!0),N(null);let _=ge.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(_=_.eq("prospect_id",s));const{data:L,error:D}=await _;if(D)throw D;g(L||[])}catch(_){S.error("Erreur r√©cup√©ration project notes:",{error:_.message}),N(_.message)}finally{h(!1)}},[t,s,r]);i.useEffect(()=>{if(!t||!r)return;q();const _=ge.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},L=>{g(D=>{const{eventType:I,new:o,old:u}=L;return I==="INSERT"?[o,...D]:I==="UPDATE"?D.map(R=>R.id===o.id?o:R):I==="DELETE"?D.filter(R=>R.id!==u.id):D})}).subscribe();return()=>{ge.removeChannel(_)}},[t,r,q]);const p=i.useCallback(async({content:_,createdBy:L,createdByName:D})=>{if(!(!t||!(_!=null&&_.trim())))try{if(C(!0),N(null),!b)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:I,error:o}=await ge.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:_.trim(),created_by:L||null,created_by_name:D||null,organization_id:b}]).select().single();if(o)throw o;return g(u=>[I,...u]),I}catch(I){throw S.error("Erreur ajout project note:",{error:I.message}),N(I.message),I}finally{C(!1)}},[t,s,b]),O=i.useCallback(async(_,{content:L})=>{if(!(!_||!(L!=null&&L.trim())))try{C(!0),N(null);const{data:D,error:I}=await ge.from("project_notes").update({content:L.trim(),updated_at:new Date().toISOString()}).eq("id",_).select().single();if(I)throw I;return g(o=>o.map(u=>u.id===_?D:u)),D}catch(D){throw S.error("Erreur update project note:",{error:D.message}),N(D.message),D}finally{C(!1)}},[]),T=i.useCallback(async _=>{if(_)try{C(!0),N(null);const{error:L}=await ge.from("project_notes").delete().eq("id",_);if(L)throw L;g(D=>D.filter(I=>I.id!==_))}catch(L){throw S.error("Erreur suppression project note:",{error:L.message}),N(L.message),L}finally{C(!1)}},[]);return{notes:a,loading:m,saving:f,error:P,addNote:p,updateNote:O,deleteNote:T,refetch:q}}function lr({projectType:t,prospectId:s,currentUser:r,activeAdminUser:a}){var o;const{activeAdminUser:g}=We(),m=a||g,[h,f]=i.useState(""),[C,P]=i.useState(!1),{getTemplateByType:N}=Rs(),b=N(t),q=(b==null?void 0:b.title)||t,{notes:p,loading:O,saving:T,error:_,addNote:L}=ir({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:D}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:m}),I=async()=>{if(h.trim())try{const u=await L({content:h,createdBy:(m==null?void 0:m.id)||(r==null?void 0:r.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(r==null?void 0:r.full_name)||(r==null?void 0:r.email)});u&&D&&await D({event_type:"note",title:"Note ajout√©e",description:u.content||h.trim(),metadata:{source:"notes_tab"},createdBy:(m==null?void 0:m.id)||(r==null?void 0:r.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(r==null?void 0:r.full_name)||(r==null?void 0:r.email)}),f("")}catch(u){S.error(u)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${q}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:h,onChange:u=>f(u.target.value),disabled:!t||T}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:I,disabled:!h.trim()||!t||T,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:T?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),_&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",_]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),p&&p.length>3&&e.jsx("button",{onClick:()=>P(!C),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:C?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx(Ms,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",p.length,")"]}),e.jsx(kt,{className:"w-4 h-4"})]})})]}),O&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!O&&(p==null?void 0:p.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(o=C?p:p==null?void 0:p.slice(0,3))==null?void 0:o.map(u=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:u.created_by_name||u.created_by?`Par ${u.created_by_name||u.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:u.created_at&&new Date(u.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:u.content})]},u.id))})]})]})}const or=({prospectId:t,projectType:s,activeAdminUser:r})=>{const{projectsData:a,appointments:g,updateAppointment:m,deleteAppointment:h,addAppointment:f,addCall:C,addTask:P,updateCall:N,updateTask:b,prospects:q}=We(),[p,O]=i.useState(!1),[T,_]=i.useState(null),[L,D]=i.useState(null),{users:I}=mt(),{supabaseUserId:o}=rt(),{history:u,loading:R}=st({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),H=i.useMemo(()=>!u||u.length===0?[]:u.filter(E=>E.event_type==="activity").sort((E,Q)=>new Date(Q.created_at)-new Date(E.created_at)),[u]),k=i.useMemo(()=>{const E={};return H.forEach(oe=>{var l;const de=(l=oe.metadata)==null?void 0:l.appointment_id;de&&(E[de]||(E[de]=[]),E[de].push(oe))}),Object.entries(E).map(([oe,de])=>{var B;const $=de.sort((ue,A)=>new Date(A.created_at)-new Date(ue.created_at))[0];return{...$,currentStatus:((B=$.metadata)==null?void 0:B.status)||($.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[H]),M=i.useMemo(()=>k?k.filter(E=>E.currentStatus==="pending"):[],[k]),ne=i.useMemo(()=>k?k.filter(E=>E.currentStatus!=="pending"):[],[k]),ce=E=>{switch((E==null?void 0:E.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(ot,{className:"h-4 w-4"});case"virtual":return e.jsx(ya,{className:"h-4 w-4"});case"call":return e.jsx(at,{className:"h-4 w-4"});case"task":return e.jsx(ua,{className:"h-4 w-4"});default:return e.jsx(ot,{className:"h-4 w-4"})}},he=E=>{const Q=(E==null?void 0:E.activity_type)||"appointment",oe=E==null?void 0:E.status;if(oe==="effectue"||oe==="completed")return"text-green-600 bg-green-50";if(oe==="annule")return"text-red-600 bg-red-50";if(oe==="reporte")return"text-yellow-600 bg-yellow-50";switch(Q){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},ve=E=>{var Q;return!g||!((Q=E.metadata)!=null&&Q.appointment_id)?null:g.find(oe=>oe.id===E.metadata.appointment_id)},V=E=>{const Q=ve(E);Q&&_(Q)},G=E=>{_(null),D({...E,type:E.type}),O(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(pe,{onClick:()=>{O(!p)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),p&&e.jsx(Ns,{open:p,onOpenChange:E=>{E||D(null),O(E)},initialData:L||{contactId:t,projectId:s},defaultAssignedUserId:o,addAppointment:f,addCall:C,addTask:P,updateAppointment:m,updateCall:N,updateTask:b,prospects:q||[],users:I||[],projectsData:a||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(E=>{const Q=ve(E),oe=(Q==null?void 0:Q.title)||E.title||"Activit√©",de=Q!=null&&Q.start?new Date(Q.start):new Date(E.created_at);return e.jsxs("div",{onClick:()=>V(E),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${he(E.metadata)}`,children:ce(E.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:oe}),(Q==null?void 0:Q.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:Q.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Qe(de,"d MMM '√†' HH:mm",{locale:He})})]})]},E.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",ne.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ne.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:ne.map(E=>{const Q=ve(E),oe=(Q==null?void 0:Q.title)||E.title||"Activit√©",de=Q!=null&&Q.start?new Date(Q.start):new Date(E.created_at),l={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[E.currentStatus]||E.currentStatus;return e.jsxs("div",{onClick:()=>V(E),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${he(E.metadata)}`,children:ce(E.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:oe}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[l," ‚Ä¢ ",Qe(de,"d MMM yyyy '√†' HH:mm",{locale:He})]})]})]},E.id)})})]}),T&&e.jsx(cr,{event:T,onClose:()=>_(null),onReport:()=>{},onEdit:G,prospects:q,supabaseUsers:I,updateAppointment:m,deleteAppointment:h,projectsData:a})]})},cr=({event:t,onClose:s,onReport:r,onEdit:a,prospects:g,supabaseUsers:m,updateAppointment:h,deleteAppointment:f,projectsData:C})=>{var I;const[P,N]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&N(t.status||"pending")},[t]),!t||!g||!m||!h||!f||!C)return null;const b=g.find(o=>o.id===t.contactId),q=m.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(b?m.find(o=>o.user_id===b.ownerId):null),p=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",O=(o,u,R={})=>{try{const H=new Date(o);return isNaN(H.getTime())?"Date invalide":Qe(H,u,R)}catch{return"Date invalide"}},T=o=>{N(o),h(t.id,{status:o}),setTimeout(()=>{s(),o==="reporte"&&r(t)},300)},_=()=>{f(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},L=o=>{if(!b){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(o){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:X({title:`Action: ${o}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},D={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:o=>!o&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ye,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p(O(t.start,"eeee d MMMM",{locale:He}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[O(t.start,"HH:mm",{locale:He})," - ",O(t.end,"HH:mm",{locale:He})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),q&&e.jsxs("p",{className:"text-sm",children:[q.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Mt,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:o,label:u})=>e.jsxs("button",{onClick:()=>L(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${D[P].color}`,children:e.jsxs($t,{onValueChange:T,value:P,children:[e.jsx(Ft,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ot,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx($e,{value:"effectue",children:"Effectu√©"}),e.jsx($e,{value:"annule",children:"Annul√©"}),e.jsx($e,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((I=C[t.projectId])==null?void 0:I.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(zt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(is,{children:[e.jsx(ls,{asChild:!0,children:e.jsxs(pe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(qt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(os,{children:[e.jsxs(cs,{children:[e.jsx(ds,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(us,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ms,{children:[e.jsx(gs,{children:"Annuler"}),e.jsx(xs,{onClick:_,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(pe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>a(t),children:"Modifier l'activit√©"})]})]})})},dr=({projectType:t,prospectId:s,currentUser:r,activeAdminUser:a})=>{const{activeAdminUser:g}=We(),{organizationId:m}=ut(),h=a||g,[f,C]=i.useState(null),{files:P,loading:N,uploading:b,deleting:q,error:p,uploadFile:O,deleteFile:T}=vs({projectType:t,prospectId:s,organizationId:m,enabled:!!t}),{addHistoryEvent:_}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:h}),L=async k=>{const M=Array.from(k.target.files||[]);if(M.length!==0)try{const ne=M.map(async ce=>{C(ce);const he=await O({file:ce,uploadedBy:r==null?void 0:r.id});return he&&_&&await _({event_type:"file",title:"Fichier ajout√©",description:he.file_name,metadata:{size:he.file_size,type:he.file_type,storage_path:he.storage_path},createdBy:(h==null?void 0:h.id)||(r==null?void 0:r.id),createdByName:(h==null?void 0:h.name)||(h==null?void 0:h.email)||(r==null?void 0:r.full_name)||(r==null?void 0:r.email)}),he});await Promise.all(ne),C(null),k.target.value=""}catch(ne){S.error("Error uploading files:",ne),C(null)}},D=async k=>{try{const{data:M,error:ne}=await ge.storage.from("project-files").createSignedUrl(k.storage_path,3600);if(ne){S.error("Error creating signed URL:",ne);return}const he=await(await fetch(M.signedUrl)).blob(),ve=window.URL.createObjectURL(he),V=document.createElement("a");V.href=ve,V.download=k.file_name,document.body.appendChild(V),V.click(),document.body.removeChild(V),window.URL.revokeObjectURL(ve)}catch(M){S.error("Error downloading file:",M)}},I=async k=>{try{S.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:k.storage_path});const{data:M,error:ne}=await ge.storage.from("project-files").createSignedUrl(k.storage_path,3600);if(ne){S.error("Error creating signed URL:",ne);return}S.debug("‚úÖ Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){S.error("Error viewing file:",M)}},o=async k=>{if(confirm(`Supprimer le fichier "${k.file_name}" ?`))try{await T(k.id,k.storage_path)}catch(M){S.error("Error deleting file:",M)}},u=k=>k!=null&&k.startsWith("image/")?e.jsx(Fs,{className:"h-5 w-5 text-blue-500"}):k==="application/pdf"?e.jsx(Oe,{className:"h-5 w-5 text-red-500"}):e.jsx(xa,{className:"h-5 w-5 text-gray-500"}),R=k=>k?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(k)):"",H=k=>k?k<1024?`${k} o`:k<1024*1024?`${(k/1024).toFixed(1)} Ko`:`${(k/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx($s,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:b?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:L,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:b,multiple:!0})]})}),p&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:p}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",P.length,")"]}),N?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):P.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:P.map(k=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:u(k.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[k.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:k.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:k.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:k.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[H(k.file_size)," ‚Ä¢ ",R(k.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[k.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>I(k),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:q,children:e.jsx(ps,{className:"h-4 w-4"})}),k.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>D(k),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:q,children:e.jsx(ht,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>o(k),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:q,children:e.jsx(qt,{className:"h-4 w-4"})})]})]},k.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},ur=({prospectId:t,projectType:s,activeAdminUser:r})=>{const[a,g]=i.useState("notes"),{supabaseUserId:m}=rt(),h=[{id:"notes",label:"Notes",icon:Oe},{id:"activity",label:"Activit√©",icon:va},{id:"files",label:"Fichiers",icon:pa}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:h.map(({id:f,label:C,icon:P})=>e.jsxs("button",{onClick:()=>g(f),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${a===f?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx("span",{children:C})]},f))})}),e.jsxs("div",{className:"min-h-[200px]",children:[a==="notes"&&e.jsx(lr,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:r}),a==="activity"&&e.jsx(or,{prospectId:t,projectType:s,activeAdminUser:r}),a==="files"&&e.jsx(dr,{prospectId:t,projectType:s,currentUser:{id:m},activeAdminUser:r})]})]})},mr=({projectType:t,prospectId:s,activeAdminUser:r})=>{const{history:a,loading:g,error:m}=st({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:r});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),g&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),m&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",m]}),!g&&a.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:a.map(h=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.title||h.event_type}),h.description&&e.jsx("p",{className:"text-xs text-gray-600",children:h.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(h.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(h.created_by_name||h.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",h.created_by_name||h.created_by]})]})]})]})]},h.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},gr=({children:t,prospectId:s,projectType:r,currentStep:a,statusConfig:g,activeAdminUser:m})=>{var h,f,C;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[a&&e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((h=g[a.status])==null?void 0:h.iconOnly)||g.pending.iconOnly}`,children:a.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:a.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((f=g[a.status])==null?void 0:f.badge)||g.pending.badge}`,children:((C=g[a.status])==null?void 0:C.label)||g.pending.label})]}),t]},a.name),!a&&!r&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Oe,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),r&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ur,{prospectId:s,projectType:r,activeAdminUser:m}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(mr,{prospectId:s,projectType:r,activeAdminUser:m})]})]})},xr={CLIENT:ct,COMMERCIAL:Bs,PARTENAIRE:tt},pr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},hr={FORM:Oe,SIGNATURE:ha},fr={FORM:"Formulaire",SIGNATURE:"Signature"},br=({isOpen:t,onClose:s,prospectId:r,projectType:a,moduleId:g,moduleName:m,moduleConfig:h,context:f={},availableForms:C=[],availableTemplates:P=[]})=>{var B,ue;const[N,b]=i.useState(null),[q,p]=i.useState(!1),[O,T]=i.useState(null),[_,L]=i.useState(!1),D=Na(),I=i.useMemo(()=>h?h.actions&&h.actions.length>0?h.actions:h.actionConfig?[{order:1,status:"pending",actionConfig:h.actionConfig}]:[]:[],[h]),[o,u]=i.useState({}),[R,H]=i.useState(!1);i.useEffect(()=>{if(!t||!r||!g||I.length<=1){u({});return}(async()=>{H(!0);try{const z=I.map((w,Z)=>`v2-${g}-action-${Z}`),{data:j,error:ie}=await ge.from("client_form_panels").select("id, action_id, status").eq("prospect_id",r).eq("project_type",a).in("action_id",z),ee={};if(!ie&&j&&j.length>0){for(const w of j)w.action_id&&(w.status==="approved"||w.status==="submitted")&&(ee[w.action_id]=w.status);console.log("[V2 Robot] Action statuses by action_id:",ee)}else{const{data:w}=await ge.from("client_form_panels").select("id, step_name, status").eq("prospect_id",r).eq("project_type",a).in("status",["approved","submitted"]);if(w){const Z=w.filter(re=>!re.step_name||re.step_name===m||re.step_name===g);Z.forEach((re,me)=>{me<I.length&&(ee[`v2-${g}-action-${me}`]=re.status)}),console.log("[V2 Robot] Fallback legacy statuses:",ee,"from",Z.length,"panels")}}u(ee)}catch(z){console.error("[V2 Robot] Error fetching action statuses:",z)}finally{H(!1)}})()},[t,r,a,m,g,I.length]);const k=i.useMemo(()=>I.map((A,z)=>{const j=`v2-${g}-action-${z}`,ie=o[j];return{...A,actionId:j,realStatus:ie==="approved"?"validated":ie==="submitted"?"submitted":"pending"}}),[I,o,g]),[M,ne]=i.useState(0);i.useEffect(()=>{if(t&&k.length>0&&!R){const A=k.findIndex(z=>z.realStatus!=="validated");ne(A>=0?A:k.length-1)}},[t,k,R]);const ce=k[M]||null,he=k.length,ve=he>1,V=i.useMemo(()=>{if(!ce)return!1;const A=ce.actionConfig;return!(!A||!A.actionType||!(Array.isArray(A.targetAudience)?A.targetAudience.length>0:!!A.targetAudience))},[ce]),G=(ce==null?void 0:ce.actionConfig)||null,E=()=>{if(!V||!G){X({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:G.allowedFormIds,currentActionFull:ce,allActions:k.map((A,z)=>{var j;return{index:z,formIds:(j=A.actionConfig)==null?void 0:j.allowedFormIds}})});try{const A=Array.isArray(G.targetAudience)?G.targetAudience[0]:G.targetAudience,z=fa({moduleId:g,moduleName:m,projectType:a,prospectId:r,actionIndex:M,actionConfig:{...G,targetAudience:A||"CLIENT"},message:""});b(z),T(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",z)}catch(A){console.error("[V2 Robot] Erreur g√©n√©ration:",A),X({title:"Erreur",description:A.message,variant:"destructive"})}},Q=async()=>{if(!N){X({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!D){X({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}p(!0),T(null);try{const A={...N,_meta:{...N._meta,isSimulation:!1}},z=await ba(A,f);T(z),z.success?(X({title:"‚úÖ Action ex√©cut√©e",description:z.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):X({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:z.message,variant:"destructive"})}catch(A){console.error("[V2 Robot] Erreur ex√©cution:",A),T({success:!1,status:"error",message:A.message}),X({title:"Erreur",description:A.message,variant:"destructive"})}finally{p(!1)}},oe=()=>{N&&(navigator.clipboard.writeText(JSON.stringify(N,null,2)),X({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},de=pt.useRef(M);i.useEffect(()=>{const A=de.current!==M;if(de.current=M,A&&(b(null),T(null)),t&&V&&!R&&(!N||A)){const z=setTimeout(()=>{E()},A?50:0);return()=>clearTimeout(z)}},[t,V,R,M]),i.useEffect(()=>{t||(b(null),T(null),L(!1),ne(0))},[t]);const l=A=>{const z=C.find(j=>j.id===A);return(z==null?void 0:z.name)||A},$=A=>{const z=P.find(j=>j.id===A);return(z==null?void 0:z.name)||A};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(hs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m||g,ve&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",M+1,"/",he]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ye,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[ve&&V&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",M+1," sur ",he]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," termin√©e",M>1?"s":"",")"]})]}),!V&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Wt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(pe,{variant:"outline",size:"sm",onClick:()=>{X({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Os,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),V&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:ve?`Action ${M+1}/${he}`:"Action configur√©e"}),D&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(G==null?void 0:G.actionType)&&e.jsxs(e.Fragment,{children:[pt.createElement(hr[G.actionType]||Oe,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:fr[G.actionType]||G.actionType})]})}),(G==null?void 0:G.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(G.targetAudience)?G.targetAudience:[G.targetAudience]).map(A=>{const z=xr[A]||ct;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(z,{className:"h-3.5 w-3.5"}),pr[A]||A]},A)})]}),((B=G==null?void 0:G.allowedFormIds)==null?void 0:B.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",G.allowedFormIds.map(A=>l(A)).join(", ")]}),((ue=G==null?void 0:G.allowedTemplateIds)==null?void 0:ue.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",G.allowedTemplateIds.map(A=>$(A)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(G==null?void 0:G.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(G==null?void 0:G.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),N&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>L(!_),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Ls,{className:Ue("h-4 w-4 transition-transform",_&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:A=>{A.stopPropagation(),oe()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(zs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),_&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(N,null,2)})]}),O&&e.jsxs("div",{className:Ue("rounded-lg p-4 flex items-start gap-3",O.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[O.success?e.jsx(qs,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Wt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Ue("font-medium text-sm",O.success?"text-green-800":"text-red-800"),children:[O.status==="executed"&&"Ex√©cut√© avec succ√®s",O.status==="simulated"&&"Simulation uniquement",O.status==="blocked"&&"Ex√©cution bloqu√©e",O.status==="error"&&"Erreur"]}),e.jsx("p",{className:Ue("text-sm mt-1",O.success?"text-green-700":"text-red-700"),children:O.message})]})]})]})]}),V&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(pe,{variant:"outline",onClick:E,disabled:q,children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(pe,{onClick:Q,disabled:!N||q||!D,className:Ue(!D&&"opacity-50 cursor-not-allowed"),children:[q?e.jsx(Vs,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(_a,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},Le="completed",Ce="in_progress",ze="pending",it={[Le]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Ce]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[ze]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},ts=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(a=>({...a,status:a.status||ze}))};if(t.status!==Ce)return s;if(!s.subSteps.some(a=>a.status===Ce)){const a=s.subSteps.findIndex(g=>g.status===ze);a!==-1&&(s.subSteps=s.subSteps.map((g,m)=>({...g,status:m===a?Ce:g.status})))}return s},ss=(t,s,r)=>{var P;if(!t)return t;const a=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,g=a?`${s}:${a}`:null,m=g&&r?r[g]:null,h=(P=m==null?void 0:m.configJson)==null?void 0:P.actions;if(!h||h.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const N=t.subSteps.map((b,q)=>{var _,L;const p=h[q],T=((L=(_=p==null?void 0:p.config)==null?void 0:_.objective)==null?void 0:L.trim())||(p==null?void 0:p.title)||(p==null?void 0:p.label);return{...b,name:T||b.name||`Action ${q+1}`}});return{...t,subSteps:N}}const f=t.status||ze,C=h.map((N,b)=>{var q;return{id:N.id||`v2-${a}-action-${b}`,name:((q=N.config)==null?void 0:q.objective)&&N.config.objective.trim()||N.title||N.label||`Action ${b+1}`,status:f===Le?Le:f===Ce&&b===0?Ce:ze}});return{...t,subSteps:C,status:f}},jr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===Le),yr=({form:t,prospectId:s,onFormSubmit:r})=>{const[a,g]=i.useState({}),m=(f,C)=>{g(P=>({...P,[f]:C}))},h=()=>{r(s,t.id,a),X({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(f=>{if(f.show_if_conditions&&f.show_if_conditions.length>0){const P=f.condition_operator||"AND",N=f.show_if_conditions.map(q=>{const p=a[q.field];return q.equals==="has_value"?!!p&&p!=="":p===q.equals});if(!(P==="AND"?N.every(q=>q===!0):N.some(q=>q===!0)))return null}if(f.show_if){const P=f.show_if.field,N=f.show_if.equals,b=a[P];if(!b||b!==N)return null}return(t.fields||[]).some(P=>P.is_repeater&&(P.repeats_fields||[]).includes(f.id))?null:e.jsxs("div",{children:[e.jsx(Fe,{htmlFor:`${t.id}-${f.id}`,children:f.label}),e.jsx(Je,{id:`${t.id}-${f.id}`,type:f.type,value:typeof a[f.id]=="object"?"":a[f.id]||"",onChange:P=>m(f.id,P.target.value),placeholder:f.placeholder||""}),f.is_repeater&&f.repeats_fields&&f.repeats_fields.length>0&&a[f.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(a[f.id])||0},(P,N)=>{const b=(t.fields||[]).filter(q=>f.repeats_fields.includes(q.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[f.label," #",N+1]}),b.map(q=>{const p=`${f.id}_repeat_${N}_${q.id}`,O=a[p];return e.jsxs("div",{children:[e.jsx(Fe,{htmlFor:`${t.id}-${p}`,children:q.label}),e.jsx(Je,{id:`${t.id}-${p}`,type:q.type,value:typeof O=="object"?"":O||"",onChange:T=>m(p,T.target.value),placeholder:q.placeholder||""})]},p)})]},N)})})]},f.id)}),e.jsx(pe,{onClick:h,className:"w-full",children:"Soumettre"})]})},Nr=({prospectId:t,projectType:s,currentStepIndex:r,activeAdminUser:a,initialChannel:g})=>{var Ve,fe;const{addChatMessage:m,prompts:h,projectsData:f,forms:C,updateProspect:P,prospects:N,completeStepAndProceed:b,registerClientForm:q}=We(),{users:p,loading:O}=mt(),{messages:T,loading:_}=ys(t,s),{uploadFile:L,uploading:D}=vs({projectType:s,prospectId:t,organizationId:a==null?void 0:a.organization_id,enabled:!0}),{addProjectEvent:I}=st({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),{user:o}=rt(),[u,R]=i.useState(""),[H,k]=i.useState(null),M=i.useRef(null),ne=i.useRef(null),[ce,he]=i.useState(!1),[ve,V]=i.useState(!1),[G,E]=i.useState(g==="partner"?"partner":g==="internal"?"internal":"client"),{organizationId:Q}=ut(),{templates:oe,loading:de}=ws(Q||(a==null?void 0:a.organization_id),s),{forms:l,loading:$}=Gs(Q||(a==null?void 0:a.organization_id)),{templates:B,loading:ue}=Js(Q||(a==null?void 0:a.organization_id)),A=(fe=(Ve=f[s])==null?void 0:Ve.steps)==null?void 0:fe[r],z=i.useMemo(()=>A!=null&&A.name?A.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${r}`,[A,r]),j=i.useMemo(()=>{if(!oe||!z)return null;const c=oe[`${s}:${z}`];return(c==null?void 0:c.configJson)||null},[oe,z,s]),ie=i.useMemo(()=>l?Object.values(l).map(c=>({id:c.id,name:c.name||c.title||"Formulaire sans nom"})):[],[l]),ee=i.useMemo(()=>B?Array.isArray(B)?B.map(c=>({id:c.id,name:c.name||"Template sans nom"})):Object.values(B).map(c=>({id:c.id,name:c.name||"Template sans nom"})):[],[B]),w=N.find(c=>c.id===t),Z=i.useMemo(()=>Object.values(h).filter(c=>{var n;if(c.projectId!==s)return!1;const W=(n=c.stepsConfig)==null?void 0:n[r];return W&&W.actions&&W.actions.length>0}),[h,s,r]),re=i.useCallback(async(c=null)=>{var F;const W=Z[0];if(!W){S.warn("Aucun prompt disponible");return}const n=(F=W.stepsConfig)==null?void 0:F[r];if(!n||!n.actions){S.warn("Aucune action dans la config de l'√©tape");return}const y=[...n.actions].sort((Y,te)=>(Y.order||0)-(te.order||0));if(c){const Y=y.findIndex(te=>te.id===c);if(Y!==-1&&Y+1<y.length){const te=y[Y+1];S.info("üéØ Action suivante trouv√©e",{completedActionId:c,nextActionId:te.id,nextActionType:te.type}),await we(W,te.id);return}else{S.warn("Pas d'action suivante",{completedActionId:c,totalActions:y.length});return}}await we(W)},[Z,r]);nr({prospectId:t,projectType:s,currentStepIndex:r,prompt:Z[0],sendNextAction:re}),i.useEffect(()=>{requestAnimationFrame(()=>{var c;(c=M.current)==null||c.scrollIntoView({behavior:"smooth",block:"end"})})},[T,G]);const me=async()=>{if(!(!u.trim()&&!H))try{let c=null;if(H){if(H.size>10485760){X({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}S.debug("üì§ Uploading file from admin chat",{name:H.name,size:H.size,type:H.type});const{data:{user:y}}=await ge.auth.getUser(),F=await L({file:H,uploadedBy:y==null?void 0:y.id});F&&(c={id:F.id,name:F.file_name,size:F.file_size,type:F.file_type,storagePath:F.storage_path},S.debug("‚úÖ File uploaded successfully",c))}const W={sender:"pro",text:u,file:c,channel:G,...G==="internal"&&{metadata:{sender_id:(a==null?void 0:a.user_id)||null,sender_name:(a==null?void 0:a.name)||"Admin",target_user_id:Ee||null}}};m(t,s,W),R(""),k(null),requestAnimationFrame(()=>{var n;(n=M.current)==null||n.scrollIntoView({behavior:"smooth",block:"end"})}),c&&X({title:"‚úÖ Fichier envoy√©",description:`${c.name} a √©t√© envoy√© avec succ√®s.`})}catch(c){S.error("‚ùå Error sending message with file",c),X({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${c.message}`,variant:"destructive"})}},le=c=>{c.target.files&&c.target.files[0]&&k(c.target.files[0])},Se=async c=>{if(!c||!c.storagePath){X({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{S.debug("üì• Downloading file",{storagePath:c.storagePath});const{data:W,error:n}=await ge.storage.from("project-files").createSignedUrl(c.storagePath,3600);if(n)throw n;window.open(W.signedUrl,"_blank"),X({title:"‚úÖ T√©l√©chargement",description:`${c.name} s'ouvre dans un nouvel onglet.`})}catch(W){S.error("‚ùå Error downloading file",W),X({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${W.message}`,variant:"destructive"})}},ye=(c,W,n)=>{var je;const y=N.find(d=>d.id===c);if(!y)return;const F={...y.formData||{},...n};P({...y,formData:F});const Y={sender:"client",text:`A compl√©t√© le formulaire : ${((je=C[W])==null?void 0:je.name)||"Formulaire"}.`};if(m(c,s,Y),Object.values(h).find(d=>{var x,K;if(d.projectId!==s)return!1;const v=(x=d.stepsConfig)==null?void 0:x[r];return v!=null&&v.autoCompleteStep?(K=v.actions)==null?void 0:K.some(se=>se.type==="show_form"&&se.formId===W):!1})){const d=j==null?void 0:j.actions;if(d&&d.length>1){X({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}b(t,s,r),X({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},we=async(c,W=null)=>{var y,F,Y,te,je,d,v,x;const n=(y=c.stepsConfig)==null?void 0:y[r];if(n&&n.actions&&n.actions.length>0){const K=T,se=[...n.actions].sort((J,xe)=>(J.order||0)-(xe.order||0));let U=se,ae=!1;if(W){const J=se.find(xe=>xe.id===W);if(!J){S.warn("Action sp√©cifique introuvable",{specificActionId:W});return}S.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:W,actionType:J.type}),U=[J],ae=!0}for(const J of U)if(!(!ae&&K.some(be=>be.promptId===c.id&&be.stepIndex===r&&(be.text===J.message||be.formId===J.formId&&J.type==="show_form")))){if(J.message){const xe={sender:"pro",text:J.message,promptId:c.id,stepIndex:r,actionId:J.id};m(t,s,xe)}if(J.type==="show_form"&&J.formId){const xe={sender:"pro",formId:J.formId,promptId:c.id,stepIndex:r,actionId:J.id};m(t,s,xe);const be=((te=(Y=(F=f[s])==null?void 0:F.steps)==null?void 0:Y[r])==null?void 0:te.name)||"√âtape inconnue";try{const Pe=await q({prospectId:t,projectType:s,formId:J.formId,currentStepIndex:r,promptId:c.id,messageTimestamp:Date.now(),status:"pending",stepName:be,actionId:J.id});if(!Pe.success)S.error("‚ùå √âchec enregistrement formulaire:",Pe.error),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const Te=((je=C[J.formId])==null?void 0:je.name)||J.formId;await I({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${Te} a √©t√© envoy√© √† ${(w==null?void 0:w.name)||"le client"}.`,createdBy:(o==null?void 0:o.user_id)||null,createdByName:(o==null?void 0:o.name)||"Admin"})}catch(Te){S.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Te)}}catch(Pe){S.error("‚ùå Exception enregistrement formulaire:",Pe),X({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(J.type==="start_signature"&&J.templateId)try{if(!(a!=null&&a.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");S.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:J.templateId,prospectId:t,projectType:s,organizationId:a.organization_id,formId:J.formId});const{data:xe,error:be}=await ge.from("prospects").select("form_data").eq("id",t).single(),Pe=((v=(d=xe==null?void 0:xe.form_data)==null?void 0:d[s])==null?void 0:v[J.formId])||{};S.info("üìã Donn√©es formulaire extraites",{formId:J.formId,dataKeys:Object.keys(Pe)}),X({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const Te=await ja({templateId:J.templateId,projectType:s,prospectId:t,formData:Pe,organizationId:a==null?void 0:a.organization_id});if(Te.success){const Ze=Te.fileData.id;S.debug("Cr√©ation proc√©dure de signature...",{fileId:Ze,prospectId:t,projectType:s});const{data:Be}=await ge.from("signature_procedures").select("*").eq("file_id",Ze).eq("prospect_id",t).eq("status","pending").maybeSingle();let Ne=Be;if(!Ne){const Re=crypto.randomUUID(),Ie=new Date;Ie.setDate(Ie.getDate()+7);const Ht=[{role:"principal",name:(w==null?void 0:w.name)||"Client",email:w==null?void 0:w.email,phone:(w==null?void 0:w.phone)||null,access_token:Re,requires_auth:!0,status:"pending",signed_at:null}];if(!(a!=null&&a.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const As=typeof(w==null?void 0:w.name)=="string"&&w.name.trim()!==""?w.name:((x=w==null?void 0:w.email)==null?void 0:x.split("@")[0])||"Client",Ps=w==null?void 0:w.email,{data:Ds,error:It}=await ge.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:Ze,access_token:Re,access_token_expires_at:Ie.toISOString(),status:"pending",signers:Ht,organization_id:a.organization_id,signer_name:As,signer_email:Ps}).select().single();if(It)throw S.error("Erreur cr√©ation signature_procedures",It),It;Ne=Ds,S.debug("Proc√©dure de signature cr√©√©e",{procedureId:Ne.id,signersCount:Ht.length})}const St=`https://evatime.fr/signature/${Ne.id}?token=${Ne.access_token}`,{data:nt}=await ge.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${Ne.id}%`).maybeSingle();nt||(await ge.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${St}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:a==null?void 0:a.organization_id,channel:"client"}),S.debug("Lien de signature envoy√© dans le chat")),X({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await I({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(w==null?void 0:w.name)||"le client"}.`,createdBy:(o==null?void 0:o.user_id)||null,createdByName:(o==null?void 0:o.name)||"Admin"})}catch(Re){S.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",Re)}}else throw new Error(Te.error||"Erreur inconnue")}catch(xe){S.error("‚ùå Exception g√©n√©ration contrat:",xe),X({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${xe.message}`,variant:"destructive"})}break}}he(!1)},_e=T.filter(c=>!c.channel||c.channel==="client"),Ae=T.filter(c=>c.channel==="partner"),ke=T.filter(c=>c.channel==="internal"),Ge=G==="partner"?Ae:G==="internal"?ke:_e,[Ee,qe]=i.useState(null),De=i.useMemo(()=>{const c=(p||[]).filter(v=>v.user_id!==(a==null?void 0:a.user_id)).filter(v=>v.role!=="Partner"),W=w==null?void 0:w.ownerId,n=c.find(v=>v.user_id===W),y=n!=null&&n.manager_id?c.find(v=>v.id===n.manager_id):null,F=new Set;n&&F.add(n.user_id),y&&F.add(y.user_id);const Y={"Global Admin":0,Admin:1,Manager:2,Commercial:3},te=c.filter(v=>!F.has(v.user_id)).sort((v,x)=>(Y[v.role]??9)-(Y[x.role]??9)),je=[];n&&je.push({...n,tag:"üëë Owner"}),y&&je.push({...y,tag:"üë§ Manager"});let d=null;return te.forEach(v=>{v.role!==d&&(d=v.role,je.push({isSeparator:!0,role:d})),je.push(v)}),je},[p,a,w==null?void 0:w.ownerId]);return i.useEffect(()=>{if(!Ee&&(w!=null&&w.ownerId)){const c=w.ownerId===(a==null?void 0:a.user_id),W=De.find(n=>!n.isSeparator);c&&W?qe(W.user_id):c||qe(w.ownerId)}},[w==null?void 0:w.ownerId,a==null?void 0:a.user_id,De]),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex mb-3 rounded-xl overflow-hidden border-2 border-gray-200",children:[e.jsxs("button",{onClick:()=>E("client"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${G==="client"?"bg-blue-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üí¨ Client",_e.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${G==="client"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:_e.length})]}),e.jsxs("button",{onClick:()=>E("partner"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${G==="partner"?"bg-orange-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üü† Partenaire",Ae.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${G==="partner"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:Ae.length})]}),e.jsxs("button",{onClick:()=>E("internal"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${G==="internal"?"bg-purple-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["üë• Interne",ke.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${G==="internal"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ke.length})]})]}),G==="internal"&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("span",{className:"text-sm text-purple-600 font-bold whitespace-nowrap",children:"‚Üí √Ä :"}),e.jsxs("select",{value:Ee||"",onChange:c=>qe(c.target.value),className:"flex-1 text-sm border-2 border-purple-300 rounded-xl px-3 py-2.5 bg-purple-50 text-purple-900 font-semibold focus:ring-2 focus:ring-purple-400 focus:border-purple-400 focus:outline-none appearance-none cursor-pointer shadow-sm",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237c3aed' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"},children:[De.filter(c=>!c.isSeparator).length===0&&e.jsx("option",{value:"",children:"Aucun coll√®gue disponible"}),De.map((c,W)=>c.isSeparator?e.jsx("optgroup",{label:`‚îÄ‚îÄ ${c.role} ‚îÄ‚îÄ`},`sep-${W}`):e.jsx("option",{value:c.user_id,children:c.tag?`${c.tag}  ¬∑  ${c.name||c.email}`:c.name||c.email},c.user_id))]})]}),e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[Ge.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400 text-sm",children:G==="partner"?"üü† Aucun message partenaire":G==="internal"?"üë• Aucun message interne":"üí¨ Aucun message client"}),Ge.map((c,W)=>{var v,x,K;const n=c.sender==="pro"||c.sender==="admin",y=c.sender==="partner",F=c.sender==="client",Y=c.channel==="internal",te=Y&&((v=c.metadata)==null?void 0:v.sender_id)===(a==null?void 0:a.user_id),je=Y&&!te,d=Y?te:n;return e.jsxs("div",{className:`flex items-end gap-2 ${d?"justify-end":"justify-start"}`,children:[F&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(w==null?void 0:w.name.charAt(0))||"?"}),y&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center font-bold text-white text-xs",children:"P"}),je&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-400 flex items-center justify-center font-bold text-white text-xs",children:(((x=c.metadata)==null?void 0:x.sender_name)||"?").charAt(0).toUpperCase()}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${Y?te?"bg-purple-500 text-white rounded-br-none p-2.5":"bg-purple-100 text-purple-900 rounded-bl-none p-3 border border-purple-200":n?"bg-blue-500 text-white rounded-br-none p-2.5":y?"bg-orange-100 text-orange-900 rounded-bl-none p-3 border border-orange-200":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[Y&&((K=c.metadata)==null?void 0:K.sender_name)&&e.jsxs("span",{className:`inline-block text-xs font-bold mb-1 ${te?"text-purple-200":"text-purple-600"}`,children:["üë• ",c.metadata.sender_name]}),y&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-600 mb-1",children:"üü† Partenaire"}),c.channel==="partner"&&n&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-300 mb-1",children:"‚Üí Partenaire"}),c.text&&(n&&c.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:c.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:c.text})),c.file&&e.jsxs("button",{onClick:()=>Se(c.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Oe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:c.file.name}),e.jsx(ht,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),c.formId&&C[c.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(yr,{form:C[c.formId],prospectId:t,onFormSubmit:ye})}),e.jsx("p",{className:`text-xs mt-1 ${Y?te?"text-purple-200":"text-purple-400":n?"text-blue-200":y?"text-orange-400":"text-gray-500"}`,children:Xs(new Date(c.timestamp),{addSuffix:!0,locale:He})})]}),te&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center font-bold text-white text-xs",children:((a==null?void 0:a.name)||"?").charAt(0).toUpperCase()}),n&&!Y&&!c.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},W)}),e.jsx("div",{ref:M})]}),H&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Gt,{className:"w-4 h-4"}),e.jsx("span",{children:H.name}),e.jsx("button",{onClick:()=>k(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Je,{placeholder:G==="internal"?"üë• √âcrire en interne...":G==="partner"?"üü† √âcrire au partenaire...":"üí¨ √âcrire au client...",className:`pr-28 h-12 ${G==="internal"?"border-purple-300 focus:ring-purple-400":G==="partner"?"border-orange-300 focus:ring-orange-400":""}`,value:u,onChange:c=>R(c.target.value),onKeyPress:c=>c.key==="Enter"&&me()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(pe,{variant:"ghost",size:"icon",onClick:()=>V(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(hs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(pe,{variant:"ghost",size:"icon",onClick:()=>ne.current.click(),disabled:D,children:e.jsx(Gt,{className:`h-5 w-5 ${D?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:ne,onChange:le,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:D}),e.jsx(pe,{onClick:me,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:D,children:D?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Ys,{className:"h-4 w-4"})})]})]}),e.jsx(br,{isOpen:ve,onClose:()=>V(!1),prospectId:t,projectType:s,moduleId:z,moduleName:(A==null?void 0:A.name)||`√âtape ${r+1}`,moduleConfig:j,context:{organizationId:Q||(a==null?void 0:a.organization_id),adminUser:a},availableForms:ie,availableTemplates:ee})]})},vr=({steps:t,onUpdateStatus:s,prompts:r,projectType:a,currentStepIndex:g,prospectId:m,completeStepAndProceed:h})=>{var _;if(!t)return null;const[f,C]=i.useState({}),{activeAdminUser:P,appointments:N,updateAppointment:b}=We(),q=r?Object.values(r).find(L=>L.projectId===a):null,p=(_=q==null?void 0:q.stepsConfig)==null?void 0:_[g],O=i.useMemo(()=>{if(!t[g])return[];const L=t[g].name,D=N.filter(I=>I.type==="task"&&I.contactId===m&&I.projectId===a&&I.step===L);return D.length>0&&S.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:m,projectType:a,stepName:L,totalAppointments:N.length,filteredTasks:D.length,tasks:D.map(I=>({id:I.id,title:I.title,contactId:I.contactId,projectId:I.projectId,step:I.step}))}),D},[N,m,a,g,t]),T=(L,D)=>{C(I=>{var k;const o=I[L]||{},u={...o,[D]:!o[D]},R={...I,[L]:u},H=(k=p==null?void 0:p.actions)==null?void 0:k.find(M=>M.id===L);return H&&H.checklist&&H.checklist.every(ne=>u[ne.id])&&p!=null&&p.autoCompleteStep&&(X({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),h(m,a,g,t)),R})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((L,D)=>{const I=it[L.status]||it[ze];return e.jsxs(Ke.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:D*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${I.iconOnly}`,children:L.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${I.text}`,children:L.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[L.subSteps&&L.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[L.subSteps.filter(o=>o.status===Le).length,"/",L.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(pe,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${I.badge} hover:opacity-90`,onClick:o=>{var k;o.stopPropagation();const u=o.currentTarget,R=u.nextElementSibling,H=u.closest("[data-step-status-container]");!R||!H||((k=H.parentElement)==null||k.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==R&&M.classList.add("hidden")}),R.classList.toggle("hidden"))},children:I.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),s(D,Ce),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),s(D,Le),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:o=>{var u;o.stopPropagation(),o.preventDefault(),s(D,ze),(u=o.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),L.subSteps&&L.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:L.subSteps.map((o,u)=>{const R=it[o.status]||it[ze];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${o.status===Le?"bg-green-500":o.status===Ce?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:o.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${R.badge}`,children:R.label})]},o.id||u)})}),L.status===Ce&&D===g&&(p==null?void 0:p.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:p.actions.filter(o=>o.hasClientAction===!1&&o.checklist&&o.checklist.length>0).map(o=>{const u=f[o.id]||{},R=o.checklist.length,H=o.checklist.filter(M=>u[M.id]).length,k=H===R;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${k?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[H,"/",R]})]}),e.jsx("div",{className:"space-y-2",children:o.checklist.map(M=>{const ne=u[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:()=>T(o.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ne?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(p==null?void 0:p.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},o.id)})}),L.status===Ce&&D===g&&O.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:O.map(o=>{const u=o.status==="effectue",R=o.startTime?new Date(o.startTime):null,H=R&&!isNaN(R.getTime()),k=async()=>{const M=u?"pending":"effectue";await b(o.id,{status:M}),X({title:u?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:u?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:u?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:k,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${u?"line-through text-gray-500":""} truncate flex-1`,children:o.title||"T√¢che"}),u&&e.jsx(gt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),H&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Qe(R,"dd/MM/yyyy √† HH:mm",{locale:He})]})]})]},o.id)})})]})]},D)})})]})},wr=({prospect:t,projectType:s,supabaseSteps:r,v2Templates:a,onUpdate:g})=>{var de;const{forms:m,prompts:h,completeStepAndProceed:f,activeAdminUser:C,appointments:P,updateAppointment:N}=We(),{formPanels:b=[],loading:q,updateFormPanel:p}=Ks(t.id),{sendMessage:O}=ys(t.id,s),[T,_]=i.useState(null),[L,D]=i.useState({}),[I,o]=i.useState(!1),[u,R]=i.useState(null),[H,k]=i.useState(""),[M,ne]=i.useState(new Set),ce=i.useMemo(()=>{if(!b)return[];const l=b.filter($=>$.prospectId===t.id&&$.projectType===s).sort(($,B)=>(B.createdAt||0)-($.createdAt||0));return S.debug("[ProspectForms] Filtering panels",{totalPanels:b.length,prospectId:t.id,projectType:s,filteredCount:l.length,samplePanel:b[0]}),l},[b,t.id,s]);if(i.useEffect(()=>{!ce||ce.length===0||ce.forEach(l=>{var B,ue,A,z;if(M.has(l.panelId)||l.status!=="submitted")return;if(l.lastSubmittedAt){const j=new Date(l.lastSubmittedAt).getTime(),ee=Date.now()-j;if(ee>1e4){S.debug("Form too old, skipping auto-complete",{panelId:l.panelId,ageSeconds:Math.floor(ee/1e3)}),ne(w=>new Set([...w,l.panelId]));return}}S.debug("New submitted form detected",{panelId:l.panelId,formId:l.formId,projectType:l.projectType}),S.debug("Available prompts",{count:Object.keys(h).length});let $=null;if(l.promptId&&(S.debug("Searching by promptId",{promptId:l.promptId}),$=h[l.promptId]),$||($=Object.values(h).find(j=>{var w,Z;if(S.debug("Testing prompt",{name:j.name,projectId:j.projectId,target:l.projectType}),j.projectId!==l.projectType)return!1;const ie=(w=j.stepsConfig)==null?void 0:w[l.currentStepIndex];return(Z=ie==null?void 0:ie.actions)==null?void 0:Z.some(re=>re.type==="show_form"&&re.formId===l.formId)})),S.debug("Prompt found",{name:$==null?void 0:$.name,autoComplete:(ue=(B=$==null?void 0:$.stepsConfig)==null?void 0:B[l.currentStepIndex])==null?void 0:ue.autoCompleteStep}),$){const j=(A=$.stepsConfig)==null?void 0:A[l.currentStepIndex],ie=(z=j==null?void 0:j.actions)==null?void 0:z.find(w=>w.type==="show_form"&&w.formId===l.formId),ee=(ie==null?void 0:ie.verificationMode)||"human";S.debug("Checking auto-complete conditions",{autoCompleteStep:j==null?void 0:j.autoCompleteStep,verificationMode:ee}),j!=null&&j.autoCompleteStep&&ee==="none"&&(S.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),f(t.id,l.projectType,l.currentStepIndex),X({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}ne(j=>new Set([...j,l.panelId]))})},[ce,h,f,t.id,t.name,M]),ce.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const he=l=>{_(l.panelId);const ue=((t.form_data||t.formData||{})[l.projectType]||{})[l.formId]||{};D({...ue,_meta:{projectType:l.projectType,formId:l.formId}})},ve=()=>{_(null),D({})},V=async()=>{const{_meta:l,...$}=L,{projectType:B,formId:ue}=l||{};if(!B||!ue){S.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const A=t.form_data||t.formData||{},z={...A,[B]:{...A[B]||{},[ue]:$}},{error:j}=await ge.from("prospects").update({form_data:z}).eq("id",t.id);if(j){S.error("‚ùå Erreur sauvegarde formulaire:",j),X({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}X({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),g&&g({...t,form_data:z,formData:z}),_(null),D({})},G=(l,$)=>{D(B=>({...B,[l]:$}))},E=l=>{var ue,A;const $=Object.values(h).find(z=>z.id===l.promptId||z.projectId===l.projectType),B=(ue=$==null?void 0:$.stepsConfig)==null?void 0:ue[l.currentStepIndex];return(A=B==null?void 0:B.actions)==null?void 0:A.find(z=>z.formId===l.formId)},Q=async l=>{var $,B,ue,A,z,j;try{await p(l.panelId,{status:"approved"});const ie=E(l),ee=(ie==null?void 0:ie.verificationMode)||"human";if(S.debug("üîç Checking verification mode",{verificationMode:ee,shouldSearchTask:ee==="human"}),ee==="human"){S.debug("üîç Searching for related task",{totalAppointments:(P==null?void 0:P.length)||0,prospectId:t.id,projectType:l.projectType,stepName:l.stepName,panel:l});const fe=(P==null?void 0:P.filter(n=>n.type==="task"))||[],c=fe.filter(n=>n.contactId===t.id);S.debug("üîç Task filtering debug",{allTasks:fe.length,prospectTasks:c.length,prospectTasksData:c.map(n=>({id:n.id,title:n.title,contactId:n.contactId,projectId:n.projectId,step:n.step,status:n.status}))}),S.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:l.projectType,step:l.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let W=P==null?void 0:P.find(n=>{var Y;const y={isTask:n.type==="task",contactMatch:n.contactId===t.id,projectMatch:n.projectId===l.projectType,stepMatch:n.step===l.stepName,isPending:n.status==="pending",titleMatch:(Y=n.title)==null?void 0:Y.includes("V√©rifier le formulaire")},F=Object.values(y).every(te=>te);return!F&&n.type==="task"&&n.contactId===t.id&&S.warn("üîç Task failed matching:",{taskId:n.id,title:n.title,checks:y,COMPARISON:{taskStep:`"${n.step}"`,panelStep:`"${l.stepName}"`,areEqual:n.step===l.stepName,taskStepType:typeof n.step,panelStepType:typeof l.stepName},taskData:{contactId:n.contactId,projectId:n.projectId,step:n.step,status:n.status},panelData:{projectType:l.projectType,stepName:l.stepName}}),F});W||(S.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:l.stepName}),W=P==null?void 0:P.find(n=>{var y;return n.type==="task"&&n.contactId===t.id&&n.projectId===l.projectType&&n.status==="pending"&&((y=n.title)==null?void 0:y.includes("V√©rifier le formulaire"))}),W&&S.info("‚úÖ Found task via fallback (without step match)",{taskId:W.id,taskStep:W.step})),W?(S.info("‚úÖ Found verification task, marking as completed",{taskId:W.id,prospectId:t.id,title:W.title}),await N(W.id,{status:"effectue"}),X({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):S.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:l.projectType,step:l.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else S.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:ee});const w=r==null?void 0:r[l.projectType],Z=w==null?void 0:w.findIndex(fe=>fe.status==="in_progress"),re=Z!=null&&Z>=0?Z:l.currentStepIndex||0,me=($=w==null?void 0:w[re])==null?void 0:$.name,le=me?me.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,Se=`${l.projectType}:${le}`,ye=le&&a?a[Se]:null,we=(B=ye==null?void 0:ye.configJson)==null?void 0:B.actionConfig;S.debug("[V2] Template lookup",{panelProjectType:l.projectType,propProjectType:s,currentStepName:me,moduleId:le,templateKey:Se,v2TemplatesKeys:a?Object.keys(a):[],templateFound:!!ye});const _e=me?bs(me):null,Ae=(we==null?void 0:we.completionTrigger)||(_e==null?void 0:_e.completionTrigger),ke=(ue=ye==null?void 0:ye.configJson)==null?void 0:ue.actions,Ge=ke&&ke.length>1;let Ee=!0;if(Ge){const fe=ke.map((F,Y)=>`v2-${le}-action-${Y}`),{data:c}=await ge.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",l.projectType).eq("status","approved");let W=new Set;(c||[]).forEach(F=>{F.action_id&&fe.includes(F.action_id)&&W.add(F.action_id)});const n=(c||[]).filter(F=>!F.action_id&&(!F.step_name||F.step_name===me||F.step_name===le));if(n.length>0){const F=fe.filter(Y=>!W.has(Y));n.forEach((Y,te)=>{te<F.length&&W.add(F[te])}),S.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:n.length,uncoveredIds:F,afterAssignment:[...W]})}const y=W.size;Ee=y>=ke.length,S.debug("[V2] Multi-actions check",{totalActions:ke.length,expectedActionIds:fe,approvedActionIds:[...W],panelsTotal:(c||[]).length,panelsWithActionId:(c||[]).filter(F=>F.action_id).length,panelsWithoutActionId:n.length,allCompleted:Ee}),Ee||(S.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:ke.length-y}),X({title:"‚úÖ Action valid√©e",description:`Action ${y}/${ke.length} ‚Äî il reste ${ke.length-y} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}S.debug("[V2] Checking completionTrigger for form approval",{stepName:me,moduleId:le,v2TemplateFound:!!ye,completionTrigger:Ae,currentStepIdx:re,hasMultiActions:Ge,allActionsCompleted:Ee});const qe=(Ae==="form_approved"||!Ae)&&Ee;let De=w;if(w&&((z=(A=w[re])==null?void 0:A.subSteps)==null?void 0:z.length)>0){const fe=w[re];let c=-1;if(l.action_id&&(c=fe.subSteps.findIndex(W=>W.id===l.action_id)),c===-1&&(c=fe.subSteps.findIndex(W=>W.status===Ce),S.debug("[V2] Substep fallback: using first in_progress",{panelActionId:l.action_id,fallbackIndex:c})),c!==-1){S.debug("[V2] Updating substep for approved action",{actionId:l.action_id,subStepIndex:c,subStepName:fe.subSteps[c].name,allActionsCompleted:Ee});const W=JSON.parse(JSON.stringify(w));if(W[re].subSteps.forEach((n,y)=>{n.status===Ce&&y!==c&&(n.status=Le)}),W[re].subSteps[c].status=Le,!Ee){let n=-1;for(let y=c+1;y<W[re].subSteps.length;y++)if(W[re].subSteps[y].status===ze){n=y;break}n!==-1&&(W[re].subSteps[n].status=Ce,S.debug("[V2] Activated next substep",{completedIndex:c,nextIndex:n,nextName:W[re].subSteps[n].name}))}await updateSupabaseSteps(l.projectType,W),De=W,S.info("[V2] Substep updated successfully",{completedSubStep:c,nextActivated:!Ee})}}if(qe&&De)S.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:l.projectType,currentStepIdx:re,stepName:me,trigger:Ae||"default_behavior"}),await f(t.id,l.projectType,re,De),X({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const fe=Object.values(h).find(c=>c.id===l.promptId||c.projectId===l.projectType);if(fe){const c=(j=fe.stepsConfig)==null?void 0:j[l.currentStepIndex];c!=null&&c.autoCompleteStep&&(S.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:l.projectType,stepIndex:l.currentStepIndex}),w?await f(t.id,l.projectType,l.currentStepIndex,w):S.error("No steps found in supabaseSteps for projectType",{projectType:l.projectType}))}}const Ve=l.filledByRole==="partner";if(Ve)S.debug("Formulaire partenaire valid√© ‚Äî pas de message chat au client");else{const fe=(ie==null?void 0:ie.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:c}=await ge.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",l.projectType).eq("sender","admin").eq("text",fe).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!c||c.length===0?await O({sender:"admin",text:fe,relatedMessageTimestamp:new Date().toISOString()}):S.debug("Message de validation d√©j√† envoy√© r√©cemment, skip")}if(Ve&&l.formId){const{data:fe,error:c}=await ge.from("missions").select("id, form_ids, status").eq("prospect_id",t.id).eq("status","submitted");if(!c&&(fe==null?void 0:fe.length)>0){const W=fe.find(n=>{var y;return(y=n.form_ids)==null?void 0:y.includes(l.formId)});if(W){const{error:n}=await ge.from("missions").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",W.id);n?S.error("‚ùå Erreur mise √† jour mission ‚Üí completed",n):S.info("‚úÖ Mission pass√©e en completed",{missionId:W.id})}}}X({title:"‚úÖ Formulaire valid√©",description:Ve?"Le formulaire partenaire a √©t√© valid√©. Mission marqu√©e comme compl√©t√©e.":"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(ie){S.error("‚ùå Erreur validation formulaire:",ie),X({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},oe=async(l="")=>{if(u)try{const $=u,B=$.filledByRole==="partner";await p($.panelId,{status:"rejected",rejectionReason:B?l:null});const ue=E($),A=(ue==null?void 0:ue.verificationMode)||"human";if(S.debug("üîç Checking verification mode (reject)",{verificationMode:A,shouldSearchTask:A==="human",isPartnerForm:B}),A==="human"){S.debug("üîç Searching for related task (reject)",{totalAppointments:(P==null?void 0:P.length)||0,prospectId:t.id,projectType:$.projectType,stepName:$.stepName}),S.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:$.projectType,step:$.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let z=P==null?void 0:P.find(j=>{var w;const ie={isTask:j.type==="task",contactMatch:j.contactId===t.id,projectMatch:j.projectId===$.projectType,stepMatch:j.step===$.stepName,isPending:j.status==="pending",titleMatch:(w=j.title)==null?void 0:w.includes("V√©rifier le formulaire")},ee=Object.values(ie).every(Z=>Z);return!ee&&j.type==="task"&&j.contactId===t.id&&S.warn("üîç Task failed matching (REJECT):",{taskId:j.id,title:j.title,checks:ie,COMPARISON:{taskStep:`"${j.step}"`,panelStep:`"${$.stepName}"`,areEqual:j.step===$.stepName,taskStepType:typeof j.step,panelStepType:typeof $.stepName},taskData:{contactId:j.contactId,projectId:j.projectId,step:j.step,status:j.status},panelData:{projectType:$.projectType,stepName:$.stepName}}),ee});z||(S.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:$.stepName}),z=P==null?void 0:P.find(j=>{var ie;return j.type==="task"&&j.contactId===t.id&&j.projectId===$.projectType&&j.status==="pending"&&((ie=j.title)==null?void 0:ie.includes("V√©rifier le formulaire"))}),z&&S.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:z.id,taskStep:z.step})),z&&(S.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:z.id,prospectId:t.id,title:z.title}),await N(z.id,{status:"effectue"}))}else S.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:A});if(B){if($.formId){const{data:z}=await ge.from("missions").select("id, form_ids").eq("prospect_id",t.id).eq("status","submitted"),j=z==null?void 0:z.find(ie=>{var ee;return(ee=ie.form_ids)==null?void 0:ee.includes($.formId)});j&&(await ge.from("missions").update({status:"pending"}).eq("id",j.id),S.info("‚úÖ Mission remise en pending (admin a refus√©)",{missionId:j.id}))}X({title:"‚ùå Formulaire rejet√©",description:"La mission est revenue dans l'onglet Missions du partenaire.",className:"bg-red-500 text-white"})}else{const j=`${(ue==null?void 0:ue.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${l}`;await O({sender:"admin",text:j,relatedMessageTimestamp:new Date().toISOString()}),X({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"})}o(!1),R(null),k("")}catch($){S.error("‚ùå Erreur rejet formulaire:",$),X({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ce.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:ce.map(l=>{var A,z;const $=m[l.formId];let B={};if(l.filledByRole==="partner"&&l.formData?B=l.formData:B=((t.form_data||t.formData||{})[l.projectType]||{})[l.formId]||{},!$)return null;const ue=l.stepName||((z=(A=r==null?void 0:r[l.projectType])==null?void 0:A[l.currentStepIndex])==null?void 0:z.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:$.name}),ue&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",ue]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${l.status==="submitted"?"bg-green-100 text-green-700":l.status==="approved"?"bg-blue-100 text-blue-700":l.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:l.status==="submitted"?"Envoy√©":l.status==="approved"?"Approuv√©":l.status==="rejected"?"Rejet√©":"En attente"})]}),l.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["‚úÖ ",l.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(pe,{size:"sm",onClick:()=>Q(l),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(gt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(pe,{size:"sm",variant:"outline",onClick:()=>{R(l),o(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),l.status==="rejected"&&l.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:l.rejectionReason.startsWith("Mission impossible")?"‚õî Mission d√©clar√©e impossible par le partenaire":"‚ùå Formulaire rejet√©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:l.rejectionReason.startsWith("Mission impossible ‚Äî ")?l.rejectionReason.replace("Mission impossible ‚Äî ",""):l.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:($.fields||[]).map(j=>{if(j.show_if_conditions&&j.show_if_conditions.length>0){const Z=j.condition_operator||"AND",re=j.show_if_conditions.map(le=>{const Se=B[le.field];return le.equals==="has_value"?!!Se&&Se!=="":Se===le.equals});if(!(Z==="AND"?re.every(le=>le===!0):re.some(le=>le===!0)))return null}if(j.show_if){const Z=j.show_if.field,re=j.show_if.equals,me=B[Z];if(!me||me!==re)return null}if(($.fields||[]).some(Z=>Z.is_repeater&&(Z.repeats_fields||[]).includes(j.id)))return null;const ee=B[j.id],w=j.type==="file"&&typeof ee=="object"&&(ee==null?void 0:ee.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Fe,{className:"text-sm font-medium text-gray-600",children:j.label}),T===l.panelId?w?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Oe,{className:"inline h-4 w-4 mr-2"}),ee.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):j.type==="select"?e.jsxs("select",{value:L[j.id]||"",onChange:Z=>G(j.id,Z.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(j.options||[]).map((Z,re)=>e.jsx("option",{value:Z,children:Z},re))]}):e.jsx(Je,{type:j.type||"text",value:L[j.id]||"",onChange:Z=>G(j.id,Z.target.value),placeholder:j.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:w?e.jsxs("button",{onClick:async()=>{try{const{data:Z,error:re}=await ge.storage.from("project-files").createSignedUrl(ee.storagePath,3600);if(re)throw re;window.open(Z.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx("span",{children:ee.name}),e.jsx(ht,{className:"h-3 w-3"})]}):ee||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),j.is_repeater&&j.repeats_fields&&j.repeats_fields.length>0&&ee&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(ee)||0},(Z,re)=>{const me=($.fields||[]).filter(le=>j.repeats_fields.includes(le.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[j.label," #",re+1]}),me.map(le=>{const Se=`${j.id}_repeat_${re}_${le.id}`,ye=B[Se],we=le.type==="file"&&typeof ye=="object"&&(ye==null?void 0:ye.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Fe,{className:"text-xs font-medium text-gray-600",children:le.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:we?e.jsxs("button",{onClick:async()=>{try{const{data:_e,error:Ae}=await ge.storage.from("project-files").createSignedUrl(ye.storagePath,3600);if(Ae)throw Ae;window.open(_e.signedUrl,"_blank")}catch{X({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Oe,{className:"h-3 w-3"}),e.jsx("span",{children:ye.name}),e.jsx(ht,{className:"h-3 w-3"})]}):ye||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},Se)})]},re)})})]},j.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T===l.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(pe,{variant:"outline",size:"sm",onClick:ve,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(pe,{size:"sm",onClick:V,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Vt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(pe,{variant:"outline",size:"sm",onClick:()=>he(l),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},l.panelId)})}),e.jsx(bt,{open:I,onOpenChange:o,children:e.jsxs(jt,{className:"max-w-lg",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Rejeter le formulaire"}),e.jsx(js,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((de=E(u))==null?void 0:de.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{children:"Raison du refus"}),e.jsx("textarea",{value:H,onChange:l=>k(l.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(zt,{children:[e.jsx(pe,{variant:"outline",onClick:()=>{o(!1),R(null),k("")},children:"Annuler"}),e.jsx(pe,{onClick:()=>oe(H),disabled:!H.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},_r=({prospect:t,projectType:s,onUpdate:r})=>{const{forms:a}=We(),[g,m]=i.useState(null),[h,f]=i.useState({}),C=i.useMemo(()=>Object.values(a).filter(p=>p.audience==="internal"&&(p.projectIds||[]).includes(s)),[a,s]);i.useEffect(()=>{if(t&&t.form_data){const p=t.form_data[s]||{};f(p)}},[t,s]);const P=p=>{m(p)},N=()=>{if(m(null),t&&t.form_data){const p=t.form_data[s]||{};f(p)}},b=(p,O,T)=>{f(_=>({..._,[p]:{..._[p]||{},[O]:T}}))},q=async()=>{try{const p={...t.form_data||{},[s]:h},O={...t,form_data:p,formData:p};await r(O),X({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),m(null)}catch(p){S.error("Erreur sauvegarde formulaire interne:",p),X({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[C.length," formulaire(s)"]})]}),C.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:C.map(p=>{const O=h[p.id]||{},T=g===p.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:p.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(p.fields||[]).map(_=>{if(_.show_if_conditions&&_.show_if_conditions.length>0){const I=_.condition_operator||"AND",o=_.show_if_conditions.map(R=>{const H=O[R.field];return R.equals==="has_value"?!!H&&H!=="":H===R.equals});if(!(I==="AND"?o.every(R=>R===!0):o.some(R=>R===!0)))return null}if(_.show_if){const I=_.show_if.field,o=_.show_if.equals,u=O[I];if(!u||u!==o)return null}if((p.fields||[]).some(I=>I.is_repeater&&(I.repeats_fields||[]).includes(_.id)))return null;const D=O[_.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Fe,{className:"text-sm font-medium text-gray-600",children:[_.label,_.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),T?_.type==="textarea"?e.jsx("textarea",{value:D,onChange:I=>b(p.id,_.id,I.target.value),placeholder:_.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):_.type==="select"?e.jsxs("select",{value:D,onChange:I=>b(p.id,_.id,I.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(_.options||[]).map((I,o)=>e.jsx("option",{value:I,children:I},o))]}):e.jsx(Je,{type:_.type||"text",value:D,onChange:I=>b(p.id,_.id,I.target.value),placeholder:_.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:D||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),_.is_repeater&&_.repeats_fields&&_.repeats_fields.length>0&&D&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(D)||0},(I,o)=>{const u=(p.fields||[]).filter(R=>_.repeats_fields.includes(R.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[_.label," #",o+1]}),u.map(R=>{const H=`${_.id}_repeat_${o}_${R.id}`,k=O[H]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Fe,{className:"text-xs font-medium text-gray-600",children:R.label}),T?R.type==="textarea"?e.jsx("textarea",{value:k,onChange:M=>b(p.id,H,M.target.value),placeholder:R.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):R.type==="select"?e.jsxs("select",{value:k,onChange:M=>b(p.id,H,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(R.options||[]).map((M,ne)=>e.jsx("option",{value:M,children:M},ne))]}):e.jsx(Je,{type:R.type||"text",value:k,onChange:M=>b(p.id,H,M.target.value),placeholder:R.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:k||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},H)})]},o)})})]},_.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:T?e.jsxs(e.Fragment,{children:[e.jsxs(pe,{variant:"outline",size:"sm",onClick:N,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(pe,{size:"sm",onClick:q,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Vt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(pe,{variant:"outline",size:"sm",onClick:()=>P(p.id),children:[e.jsx(ft,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},p.id)})})]})},Sr=t=>{switch(t.type){case"email":return e.jsx(vt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(at,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Qs,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(wt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(Zs,{className:"h-4 w-4 text-gray-400"})}},Ir=({prospect:t,onBack:s,onUpdate:r,onEditingChange:a})=>{var je;const{getProjectSteps:g,completeStepAndProceed:m,updateProjectSteps:h,markNotificationAsRead:f,projectsData:C,formContactConfig:P,currentUser:N,userProjects:b,setUserProjects:q,getProjectInfo:p,updateProjectInfo:O,activeAdminUser:T,prompts:_,notifications:L}=We(),{supabaseUserId:D}=rt(),{users:I,loading:o}=mt(),{projectStepsStatus:u,updateProjectSteps:R}=ga(t.id),{organizationId:H}=ut(),{templates:k}=ws(H||(T==null?void 0:T.organization_id),null),[M,ne]=fs(),ce=M.get("project")||t._selectedProjectType,he=M.get("notificationId"),ve=M.get("channel"),[V,G]=i.useState(ce||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:E,addProjectEvent:Q}=st({projectType:V||"",prospectId:t.id,enabled:!!V&&!!t.id,activeAdminUser:T}),[oe,de]=i.useState(!1),[l,$]=i.useState(t);i.useEffect(()=>{$(t)},[t]);const[B,ue]=i.useState(!1),A=i.useMemo(()=>V?p(t.id,V)||{}:{},[V,p,t.id]),[z,j]=i.useState((A==null?void 0:A.status)||"actif"),[ie,ee]=i.useState({}),w=A==null?void 0:A.amount,Z=i.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[re,me]=i.useState(""),[le,Se]=i.useState(!1),ye=i.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...I.map(d=>({value:d.user_id,label:d.name}))],[I]),we=i.useMemo(()=>{var v;if(!V)return[];if(u[V])return u[V].map(x=>ss(x,V,k)).map(ts);const d=(v=C[V])==null?void 0:v.steps;if(d&&d.length>0){const x=JSON.parse(JSON.stringify(d));return x[0].status="in_progress",x.map(K=>ss(K,V,k)).map(ts)}return[]},[V,u,C,k]),_e=we.findIndex(d=>d.status===Ce),Ae=we[_e]||we.find(d=>d.status===ze)||we[0];i.useEffect(()=>{if(he){f(parseInt(he));const d=new URLSearchParams(M);d.delete("notificationId"),ne(d,{replace:!0})}},[he,f,ne,M]),i.useEffect(()=>{var v;const d=M.get("project");d&&d!==V&&((v=t.tags)!=null&&v.includes(d))&&G(d)},[M,t.tags]),i.useEffect(()=>{if(!(t!=null&&t.id)||!V||!L||!f)return;const d=L.filter(v=>!v.read&&v.prospectId===t.id&&v.projectType===V);d.length>0&&d.forEach(v=>{f(v.id)})},[t==null?void 0:t.id,V,L,f]),i.useEffect(()=>{S.debug("Prospect prop changed",{name:t.name}),$(t)},[t]),i.useEffect(()=>{le||(w==null||w===""?me(""):me(w.toString()))},[w,le]),i.useEffect(()=>{(async()=>{var K;if(!V||!t.id)return;const{data:v,error:x}=await ge.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",V).maybeSingle();x?(S.error("Erreur chargement project status:",x),j("actif")):(K=v==null?void 0:v.data)!=null&&K.status?j(v.data.status):j("actif")})()},[V,t.id]),i.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:v,error:x}=await ge.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(v){const K={};v.forEach(se=>{K[se.project_type]=se.status||"actif"}),ee(K)}})()},[t.id,t.tags]),i.useEffect(()=>{a&&a(oe)},[oe,a]),i.useEffect(()=>{if(!t.id)return;const d=ge.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async v=>{var be;const{new:x,old:K}=v;if(x.status!=="signed"||(K==null?void 0:K.status)==="signed")return;const se=x.project_type;S.info("[V2 Signature Listener] Signature completed",{procedureId:x.id,projectType:se,prospectId:x.prospect_id});const U=u==null?void 0:u[se];if(!U||U.length===0){S.warn("[V2 Signature Listener] No steps found for project type",{projectType:se});return}const ae=U.findIndex(Pe=>Pe.status==="in_progress");if(ae===-1){S.warn("[V2 Signature Listener] No current step in_progress",{projectType:se});return}const J=(be=U[ae])==null?void 0:be.name;if(!J){S.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:ae});return}const xe=bs(J);if((xe==null?void 0:xe.completionTrigger)!=="signature"){S.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:J,completionTrigger:(xe==null?void 0:xe.completionTrigger)||"null"});return}S.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:se,currentStepIdx:ae,stepName:J});try{await m(t.id,se,ae,U),X({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${J}"`,className:"bg-green-500 text-white"})}catch(Pe){S.error("[V2 Signature Listener] Error completing step",Pe)}}).subscribe();return()=>{ge.removeChannel(d)}},[t.id,u,m]);const ke=d=>{G(d),ne(v=>(v.set("project",d),v),{replace:!0})},Ge=async d=>{if(!V||!t.id)return;const v=z;j(d);try{const{error:x}=await ge.from("project_infos").upsert({prospect_id:t.id,project_type:V,status:d,data:(A==null?void 0:A.data)||{}},{onConflict:"prospect_id,project_type"});if(x)throw x;const K={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:se}=await ge.from("project_history").insert({prospect_id:t.id,project_type:V,event_type:"status",description:`Projet ${K[d]||d}`,organization_id:T==null?void 0:T.organization_id,metadata:{old_status:v,new_status:d}});se&&S.error("Erreur historique:",se),O(t.id,V,(U={})=>({...U,status:d})),ee(U=>({...U,[V]:d})),X({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${K[d]}".`,className:"bg-green-500 text-white"})}catch(x){S.error("Erreur lors du changement de statut:",x),j(v),X({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},Ee=d=>{me(d)},qe=d=>{if(!V)return;const v=d.replace(",",".").trim();if(v===""){O(t.id,V,(se={})=>{if(!se.amount)return se;const U={...se};return delete U.amount,U}),me("");return}const x=parseFloat(v);if(Number.isNaN(x)||x<0){me(w==null?"":w.toString());return}const K=Math.round(x*100)/100;O(t.id,V,(se={})=>({...se,amount:K})),me(K.toFixed(2))},De=()=>{qe(re),Se(!1)},Ve=d=>{d.key==="Enter"&&(d.preventDefault(),qe(d.currentTarget.value),d.currentTarget.blur(),Se(!1))},fe=async(d,v)=>{var K,se;const x=we[d];if(v===Le&&((K=x==null?void 0:x.subSteps)==null?void 0:K.length)>0&&!jr(x)){X({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(v===Ce&&((se=x==null?void 0:x.subSteps)==null?void 0:se.length)>0){const U=JSON.parse(JSON.stringify(we)),ae=U[d];ae.status=Ce,ae.subSteps=ae.subSteps.map((J,xe)=>({...J,status:xe===0?Ce:ze})),await R(V,U),E&&await E({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${ae.name} ¬ª`,metadata:{step_id:(ae==null?void 0:ae.id)||null,step_name:(ae==null?void 0:ae.name)||null,previous_status:(x==null?void 0:x.status)||null,new_status:Ce,project_type:V},createdBy:D,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)});return}if(v===Le){const U=JSON.parse(JSON.stringify(we));U[d].status="completed";let ae=d+1;if(ae<U.length&&(U[ae].status="in_progress"),await R(V,U),E){const J=ae<U.length?U[ae]:null;await E({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:x&&J?`√âtape ¬´ ${x.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${J.name} ¬ª`:`√âtape ¬´ ${x.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(x==null?void 0:x.id)||null,previous_step_name:(x==null?void 0:x.name)||null,previous_step_status:(x==null?void 0:x.status)||null,new_step_id:(J==null?void 0:J.id)||null,new_step_name:(J==null?void 0:J.name)||null,new_step_status:"in_progress",project_type:V},createdBy:D,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}if(ae<U.length&&U[ae].globalStepId){const J=U[ae].globalStepId,xe={...t,status:J};r(xe),X({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const U=we.map((J,xe)=>{let be=J.status;return xe===d&&(be=v),{...J,status:be}});if(await R(V,U),E){const J=U[d];await E({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${J.name} ¬ª pass√©e de ¬´ ${x.status==="pending"?"√Ä venir":x.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${v==="pending"?"√Ä venir":v==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(J==null?void 0:J.id)||null,step_name:(J==null?void 0:J.name)||null,previous_status:(x==null?void 0:x.status)||null,new_status:v,project_type:V},createdBy:D,createdByName:(T==null?void 0:T.name)||(T==null?void 0:T.email)})}const ae=U[d];if(ae.globalStepId&&v==="in_progress"){const J={...t,status:ae.globalStepId};r(J)}}},c=async d=>{var x,K;const v=l.tags||[];if(!v.includes(d)){const se={...l,tags:[...v,d]};if($(se),r(se),G(d),N&&t.id===N.id&&!b.includes(d)){const ae=[...b,d];q(ae)}const U=(x=C[d])==null?void 0:x.steps;if(U&&U.length>0)try{const ae=JSON.parse(JSON.stringify(U));ae[0].status="in_progress",await R(d,ae),S.debug("Steps initialized in Supabase",{projectType:d})}catch(ae){S.error("Steps initialization error:",ae)}X({title:"‚úÖ Projet ajout√© !",description:`Le projet ${(K=C[d])==null?void 0:K.title} a √©t√© associ√© au prospect.`})}ue(!1)},W=()=>{const d=l.tags||[];return Object.values(C).filter(v=>v.isPublic&&!d.includes(v.type))},n=async d=>{switch(d){case"Appel":l.phone&&(window.location.href=`tel:${l.phone}`);break;case"Mail":l.email&&(window.location.href=`mailto:${l.email}`);break;case"WhatsApp":if(l.phone){const v=l.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${v}`,"_blank")}else X({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const v=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${v}`:window.open(`https://www.google.com/maps/search/?api=1&query=${v}`,"_blank")}break;case"Invitation":if(!l.email){X({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const v=`${window.location.origin}/dashboard`,x=H||(T==null?void 0:T.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",l.email,"org:",x);const{error:K}=await ge.auth.signInWithOtp({email:l.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:v,data:{organization_id:x}}});K?(console.error("[handleActionClick] ‚ùå Magic link error:",K),X({title:"‚ùå Erreur envoi invitation",description:K.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",l.email),X({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${l.email}`,className:"bg-green-500 text-white"}))}catch(v){console.error("[handleActionClick] üí• Exception:",v),X({title:"‚ùå Erreur",description:v.message,variant:"destructive"})}break;default:X({title:`Action: ${d}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},y=()=>{const d=window.scrollY;de(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:d,behavior:"instant"})})})},F=()=>{try{r(l),de(!1),X({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(d){S.error("‚ùå Erreur sauvegarde:",d),X({title:"‚ùå Erreur",description:d.message,variant:"destructive"})}},Y=(d,v)=>{$(x=>({...x,[d]:v}))},te=d=>{let v=d;d==="unassigned"?v=null:d==="user-1"&&D&&(v=D),$(x=>({...x,ownerId:v}))};return C[V],i.useEffect(()=>{const d=document.createElement("style");return d.id="disable-auto-scroll",d.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(d),()=>{const v=document.getElementById("disable-auto-scroll");v&&v.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(pe,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Hs,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:l.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(pe,{size:"icon",className:"rounded-full",onClick:()=>ue(!0),children:e.jsx(Rt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(l.tags||[]).map(d=>{var x;const v=ie[d]||"actif";return e.jsxs("button",{onClick:()=>ke(d),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${V===d?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((x=C[d])==null?void 0:x.title)||d}),v==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${V===d?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),v==="archive"&&e.jsx("span",{className:`text-xs font-medium ${V===d?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},d)}),(!l.tags||l.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Mt,label:"WhatsApp"},{icon:wt,label:"GPS"},{icon:Ws,label:"Invitation",highlight:!l.userId}].map(({icon:d,label:v,highlight:x})=>e.jsxs("button",{onClick:()=>n(v),className:`flex flex-col items-center space-x-1 transition-colors group ${x?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${x?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(d,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:v})]},v))})]}),e.jsx(Cr,{prospectId:t.id,projectType:V}),e.jsx(wr,{prospect:l,projectType:V,supabaseSteps:u,v2Templates:k,onUpdate:d=>{$(d),r&&r(d)}}),e.jsx(_r,{prospect:l,projectType:V,onUpdate:d=>{$(d),r&&r(d)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),oe?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:F,children:e.jsx(Vt,{className:"h-4 w-4"})}),e.jsx(pe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>de(!1),children:e.jsx(Ye,{className:"h-4 w-4"})})]}):e.jsx(pe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:y,children:e.jsx(ft,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[P.map(d=>e.jsxs("div",{className:"flex items-start space-x-3",children:[Sr(d),e.jsxs("div",{className:"flex-1",children:[e.jsx(Fe,{htmlFor:d.id,className:"text-xs text-gray-500",children:d.name.replace("*","")}),oe?e.jsx(Je,{id:d.id,name:d.id,type:d.type,value:l[d.id]||"",onChange:v=>Y(d.id,v.target.value),className:"h-8 text-sm",placeholder:d.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:l[d.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},d.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Fe,{className:"text-xs text-gray-500",children:"Suivi par"}),oe?e.jsx(ma,{options:ye,value:l.ownerId||"unassigned",onSelect:te,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((je=I.find(d=>d.user_id===l.ownerId))==null?void 0:je.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(wa,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Fe,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ct,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Fe,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(gr,{prospectId:t.id,projectType:V,currentStep:Ae,statusConfig:it,activeAdminUser:T,children:V&&e.jsx(Nr,{prospectId:t.id,projectType:V,currentStepIndex:_e!==-1?_e:0,activeAdminUser:T,initialChannel:ve})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[V&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>Se(!le),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:le?"Annuler":"Modifier le montant",children:le?e.jsx(Ye,{className:"h-4 w-4 text-gray-600"}):e.jsx(ft,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),le?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(Je,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:re,onChange:d=>Ee(d.target.value),onKeyDown:Ve,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(pe,{size:"sm",onClick:De,className:"h-8",children:e.jsx(gt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof w=="number"?Z.format(w):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs($t,{value:z,onValueChange:Ge,children:[e.jsx(Ft,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${z==="actif"?"bg-green-100 text-green-700":z==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Ot,{})}),e.jsxs(Lt,{className:"w-44",children:[e.jsx($e,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx($e,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx($e,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(vr,{steps:we,onUpdateStatus:fe,prompts:_,projectType:V,currentStepIndex:_e,prospectId:t.id,completeStepAndProceed:m})]})]})]})]}),e.jsx(bt,{open:B,onOpenChange:ue,children:e.jsxs(jt,{className:"sm:max-w-md",children:[e.jsxs(yt,{children:[e.jsx(Nt,{children:"Ajouter un projet"}),e.jsx(js,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:W().length>0?W().map(d=>e.jsxs(pe,{variant:"outline",onClick:()=>c(d.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:d.icon}),e.jsx("span",{className:"font-medium",children:d.title})]},d.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},Cr=({prospectId:t,projectType:s})=>{var G;const{activeAdminUser:r,prospects:a,projectsData:g,appointments:m,agendaLoading:h,updateAppointment:f,deleteAppointment:C,addAppointment:P,addCall:N,addTask:b,updateCall:q,updateTask:p}=We(),{users:O,loading:T}=mt(),{supabaseUserId:_}=rt(),[L,D]=i.useState(null),[I,o]=i.useState(null),[u,R]=i.useState(null),[H,k]=i.useState(!1),[M,ne]=i.useState(null),ce=i.useMemo(()=>!m||m.length===0?[]:m.filter(Q=>{var de;if(Q.contactId!==t||s&&Q.projectId!==s)return!1;const oe=(de=Q.status)==null?void 0:de.toLowerCase();return!(oe!=="pending"&&oe!=="prevu")}).sort((Q,oe)=>{const de=new Date(Q.start),l=new Date(oe.start);return de-l}),[m,t,s]),he=(E,Q)=>{R(E)},ve=()=>{D(null),o(null),R(null)},V=E=>{R(null),ne({...E,type:E.type}),k(!0)};return h?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(G=g[s])==null?void 0:G.title})`]})}),ce.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:ce.map(E=>{const Q=new Date(E.start),oe={physical:{icon:ot,color:"blue",label:"üìç RDV"},virtual:{icon:ot,color:"purple",label:"üé• Visio"},call:{icon:at,color:"green",label:"üìû Appel"},task:{icon:gt,color:"yellow",label:"‚úÖ T√¢che"}},de=oe[E.type]||oe.physical,l=de.icon,$={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},B={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>he(E,E.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${de.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(l,{className:`h-5 w-5 text-${de.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:E.title||de.label}),E.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:E.notes}),E.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",E.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${de.color}-700 bg-${de.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Qe(Q,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Qe(Q,"HH:mm")})]})]}),B[E.status]&&E.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${$[E.status]}`,children:B[E.status]})]},E.id)})})]}),e.jsx(kr,{event:u,onClose:ve,onReport:()=>{},onEdit:V,prospects:a,supabaseUsers:O,updateAppointment:f,deleteAppointment:C,projectsData:g}),H&&e.jsx(Ns,{open:H,onOpenChange:E=>{E||ne(null),k(E)},initialData:M||{contactId:t,projectId:s},defaultAssignedUserId:_,addAppointment:P,addCall:N,addTask:b,updateAppointment:f,updateCall:q,updateTask:p,prospects:a||[],users:O||[],projectsData:g||{}})]})},kr=({event:t,onClose:s,onReport:r,onEdit:a,prospects:g,supabaseUsers:m,updateAppointment:h,deleteAppointment:f,projectsData:C})=>{var I;const[P,N]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&N(t.status||"pending")},[t]),!t||!g||!m||!h||!f||!C)return null;const b=g.find(o=>o.id===t.contactId),q=m.find(o=>o.id===t.assignedUserId||o.user_id===t.assignedUserId)||(b?m.find(o=>o.user_id===b.ownerId):null),p=o=>o?o.charAt(0).toUpperCase()+o.slice(1):"",O=(o,u,R={})=>{try{const H=new Date(o);return isNaN(H.getTime())?"Date invalide":Qe(H,u,R)}catch{return"Date invalide"}},T=o=>{N(o),h(t.id,{status:o}),setTimeout(()=>{s(),o==="reporte"&&r(t)},300)},_=()=>{f(t.id),X({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},L=o=>{if(!b){X({title:"Contact non trouv√©",variant:"destructive"});return}switch(o){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:X({title:`Action: ${o}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},D={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(bt,{open:!!t,onOpenChange:o=>!o&&s(),children:e.jsxs(jt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ye,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p(O(t.start,"eeee d MMMM",{locale:He}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[O(t.start,"HH:mm",{locale:He})," - ",O(t.end,"HH:mm",{locale:He})]})]}),e.jsx(yt,{className:"p-0 text-left space-y-1",children:e.jsx(Nt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(tt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),q&&e.jsxs("p",{className:"text-sm",children:[q.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:at,label:"Appel"},{icon:vt,label:"Mail"},{icon:Mt,label:"WhatsApp"},{icon:wt,label:"GPS"}].map(({icon:o,label:u})=>e.jsxs("button",{onClick:()=>L(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(o,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${D[P].color}`,children:e.jsxs($t,{onValueChange:T,value:P,children:[e.jsx(Ft,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Ot,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Lt,{children:[e.jsx($e,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx($e,{value:"effectue",children:"Effectu√©"}),e.jsx($e,{value:"annule",children:"Annul√©"}),e.jsx($e,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((I=C[t.projectId])==null?void 0:I.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(zt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(is,{children:[e.jsx(ls,{asChild:!0,children:e.jsxs(pe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(qt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(os,{children:[e.jsxs(cs,{children:[e.jsx(ds,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(us,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(ms,{children:[e.jsx(gs,{children:"Annuler"}),e.jsx(xs,{onClick:_,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(pe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>a(t),children:"Modifier l'activit√©"})]})]})})};function Er(t,s){const r=t.prospect,a=s.prospect;return!r||!a?!1:r.id===a.id&&(r.updatedAt||r.updated_at)===(a.updatedAt||a.updated_at)}const Ar=pt.memo(Ir,Er),as=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Pr=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",Xe=t=>(t||"").toString().trim().toUpperCase(),Dr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},Tr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],rs=50,ns=50,Gr=()=>{var c,W;const t=We(),[s,r]=fs(),{organizationId:a}=ut(),[g,m]=i.useState(null),[h,f]=i.useState(!1),[C,P]=i.useState("all"),[N,b]=i.useState(null),[q,p]=i.useState(!1),[O,T]=i.useState([]),[_,L]=i.useState(!1),D=i.useRef(null),[I,o]=i.useState(""),u=i.useRef(null),[R,H]=i.useState(!1),[k,M]=i.useState(!1),[ne,ce]=i.useState({}),{users:he,loading:ve}=mt(),{authUserId:V}=rt(),G=t==null?void 0:t.addProspect,{prospects:E=[],prospectsLoading:Q=!0,allProjectSteps:oe={},allStepsLoading:de=!0,updateProspect:l=async()=>{},projectsData:$={},activeAdminUser:B=null,users:ue={},globalPipelineSteps:A=[],pipelineLoading:z=!0,getProjectSteps:j=()=>[],adminReady:ie=!1}=t||{},ee=i.useMemo(()=>he.reduce((n,y)=>(n[y.user_id]={id:y.id,user_id:y.user_id,name:y.name,email:y.email,role:y.role,phone:y.phone,avatarUrl:y.avatar_url,managerId:y.manager_id,accessRights:y.access_rights},n),{}),[he]);i.useEffect(()=>{ie&&!Q&&!de&&!k&&M(!0)},[ie,Q,de,k]);const w=E,Z=l,re=(E==null?void 0:E.find(n=>n.id===g))||null,me=i.useMemo(()=>!A||A.length===0?Tr:A.map((n,y)=>{const F=Xe(n.label),Y=n.color||Dr[F]||as[y%as.length];return{id:n.id,label:n.label,name:Pr(n.label),color:Y}}),[A]),le=i.useMemo(()=>{if(!B)return[];if(B.role==="Global Admin"||B.role==="Admin")return Object.values(ee);const n=B.access_rights||B.accessRights,y=[B.user_id,...(n==null?void 0:n.users)||[]];return Object.values(ee).filter(F=>y.includes(F.user_id))},[B,ee]),Se=i.useMemo(()=>{const n=le.map(y=>({value:y.user_id,label:y.name}));return le.length>1?[{value:"all",label:"Tous les utilisateurs"},...n]:n},[le]);i.useEffect(()=>{B&&N===null&&(le.length>1?b("all"):le.length===1&&b(le[0].user_id))},[B,N,le]),i.useEffect(()=>{if(!_)return;const n=y=>{D.current&&!D.current.contains(y.target)&&L(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[_]);const ye=i.useMemo(()=>{const n=new Set;return w.forEach(y=>{(y.tags||[]).forEach(F=>n.add(F))}),Array.from(n)},[w]),we=O.length===0?"Tags":O.length===1?((c=$[O[0]])==null?void 0:c.title)||O[0]:`${O.length} tags`,_e=i.useMemo(()=>{const n=w.filter(F=>{if(!B)return!1;if(B.role==="Global Admin"||B.role==="Admin")return!0;const Y=B.access_rights||B.accessRights;return[B.user_id,...(Y==null?void 0:Y.users)||[]].includes(F.ownerId)});S.debug("[FinalPipeline] Prospects count",{total:w.length,visible:n.length});let y=n;if(O.length>0&&(y=y.filter(F=>{const Y=F.tags||[];return O.some(te=>Y.includes(te))})),N&&N!=="all"&&(y=y.filter(F=>F.ownerId===N)),I.trim()){const F=I.toLowerCase();y=y.filter(Y=>(Y.name||"").toLowerCase().includes(F)||(Y.email||"").toLowerCase().includes(F)||(Y.city||"").toLowerCase().includes(F)||(Y.phone||"").toLowerCase().includes(F))}return C==="mine"&&V?y.filter(F=>F.ownerId===V):y},[w,C,V,N,O,I]),{stagesWithCounts:Ae,prospectsByStage:ke}=i.useMemo(()=>{var v;const n=me.reduce((x,K)=>(x[K.id]=[],x),{}),y=((v=me[0])==null?void 0:v.id)||"fallback-stage",F=new Set(me.map(x=>x.id)),Y=new Map(me.map(x=>[Xe(x.label),x.id])),te=x=>{const K=[];return x.projectType&&$[x.projectType]&&K.push(x.projectType),Array.isArray(x.tags)&&x.tags.forEach(se=>{$[se]&&!K.includes(se)&&K.push(se)}),K},je=x=>{const K=[];if(!A.length){const U=x.stage||y,ae=F.has(U)?U:y;return K.push({stageId:ae,prospect:x}),K}if(typeof j!="function")return K.push({stageId:y,prospect:x}),K;const se=te(x);return se.length?(se.forEach(U=>{var Ze;const ae=`${x.id}-${U}`,J=oe[ae]||(typeof j=="function"?j(x.id,U):[])||[],xe=((Ze=$[U])==null?void 0:Ze.steps)||[];if(!J.length){K.push({stageId:y,prospect:x,projectType:U});return}const be=J.find(Be=>Be.status==="in_progress"||Be.status==="current")||J.find(Be=>Be.status==="pending")||J[J.length-1];if(!be){K.push({stageId:y,prospect:x,projectType:U});return}const Te=(()=>{if(be.globalStepId&&F.has(be.globalStepId))return be.globalStepId;if(be.globalStepId){const Re=Xe(be.globalStepId),Ie=Y.get(Re);if(Ie&&F.has(Ie))return Ie}const Be=J.indexOf(be);let Ne=null;if(Be>=0&&xe[Be]&&(Ne=xe[Be]),!Ne){const Re=Xe(be.name||be.label);Ne=xe.find(Ie=>Xe(Ie.name||Ie.label)===Re)}if(Ne!=null&&Ne.globalStepId&&F.has(Ne.globalStepId))return Ne.globalStepId;if(Ne!=null&&Ne.globalStepId){const Re=Xe(Ne.globalStepId),Ie=Y.get(Re);if(Ie&&F.has(Ie))return Ie}if(Ne&&(Ne.label||Ne.name)){const Re=Xe(Ne.label||Ne.name),Ie=Y.get(Re);if(Ie&&F.has(Ie))return Ie}const St=Xe(be.label||be.name),nt=Y.get(St);return nt&&F.has(nt)?nt:y})();K.push({stageId:Te,prospect:x,projectType:U,activeStep:be})}),K):(K.push({stageId:y,prospect:x}),K)};return _e.forEach(x=>{je(x).forEach(({stageId:se,projectType:U,activeStep:ae})=>{n[se]||(n[se]=[]),n[se].push({prospect:x,projectType:U,activeStep:ae})})}),{stagesWithCounts:me.map(x=>{var K;return{...x,count:((K=n[x.id])==null?void 0:K.length)||0}}),prospectsByStage:n}},[me,_e,A,j,$]);i.useEffect(()=>{const n=s.get("prospect"),y=s.get("project"),F=`${n}-${y}`;if(u.current===F)return;if(!n){g!==null&&(m(null),u.current=null);return}(w.find(te=>te.id===n)||null)&&(m(n),u.current=F)},[s,w]);const Ge=n=>{T(y=>y.includes(n)?y.filter(F=>F!==n):[...y,n])},Ee=i.useCallback((n,y)=>{m(n.id),r(F=>{const Y=new URLSearchParams(F);return Y.set("prospect",n.id),y?Y.set("project",y):Y.delete("project"),Y})},[r]),qe=i.useCallback(n=>{ce(y=>({...y,[n]:(y[n]||rs)+ns}))},[]),De=()=>{m(null);const n=new URLSearchParams(s);n.delete("prospect"),n.delete("project"),r(n)},Ve=async n=>{var y,F;try{if(!G)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const Y=((y=A[0])==null?void 0:y.step_id)||((F=A[0])==null?void 0:F.id);console.log("[handleAddProspect] calling addProspect",{name:n.name,email:n.email,status:Y,ownerId:B==null?void 0:B.user_id,sendInvitation:n.sendInvitation,allData:n});const te=await G({...n,status:Y,ownerId:B==null?void 0:B.user_id});if(console.log("[handleAddProspect] result",te),!(te!=null&&te.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:n.sendInvitation,email:te.email,willSend:n.sendInvitation&&te.email}),n.sendInvitation&&te.email)try{const je=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",te.email.trim(),"redirect:",je,"org:",a);const{error:d}=await ge.auth.signInWithOtp({email:te.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:je,data:{organization_id:a}}});d?(console.error("[handleAddProspect] ‚ùå invitation error",d),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${d.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",te.email),X({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${te.email}`,className:"bg-green-500 text-white"}))}catch(je){console.error("[handleAddProspect] üí• invitation exception",je),X({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${je.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:n.sendInvitation?"no email":"sendInvitation=false"});f(!1)}catch(Y){console.error("‚ùå handleAddProspect error",Y),X({title:"Erreur",description:Y.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},fe=n=>{try{Z&&(Z(n),X({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{X({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return re&&re.id?e.jsx(Ke.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Us,{name:"Fiche Prospect",children:e.jsx(Ar,{prospect:re,onBack:De,onUpdate:fe,onEditingChange:H})})}):k?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(tt,{className:"w-4 h-4"}),e.jsxs("span",{children:[_e.length," prospect",_e.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:D,className:"relative inline-block text-left",children:[e.jsxs(pe,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>L(n=>!n),children:[e.jsx("span",{children:we}),e.jsx(kt,{className:"h-4 w-4"})]}),_&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[ye.map(n=>{var y;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:O.includes(n),onChange:()=>Ge(n),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((y=$[n])==null?void 0:y.title)||n})]},n)}),O.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>T([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(ea,{open:q,onOpenChange:p,children:[e.jsx(ta,{asChild:!0,children:e.jsxs(pe,{variant:"outline",role:"combobox","aria-expanded":q,className:"w-[230px] justify-between",children:[e.jsx(tt,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:N==="all"?"Tous les utilisateurs":((W=ee[N])==null?void 0:W.name)||"Utilisateur"}),e.jsx(kt,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(sa,{className:"w-[200px] p-0",children:e.jsxs(aa,{children:[e.jsx(ra,{placeholder:"Rechercher..."}),e.jsxs(na,{children:[e.jsx(ia,{children:"Aucun utilisateur"}),e.jsx(la,{children:Se.map(n=>e.jsxs(oa,{value:n.label,onSelect:()=>{b(n.value),p(!1)},children:[e.jsx(gt,{className:Ue("mr-2 h-4 w-4",N===n.value?"opacity-100":"opacity-0")}),n.label]},n.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ca,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Je,{type:"text",placeholder:"Rechercher un prospect...",value:I,onChange:n=>o(n.target.value),className:"pl-9 pr-4"}),I&&e.jsx("button",{onClick:()=>o(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(pe,{onClick:()=>f(!0),children:[e.jsx(Rt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Ae.map(n=>e.jsxs(Ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${n.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:n.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(ke[n.id]||[]).filter(y=>{if(O.length===0)return!0;const{projectType:F}=y;return O.some(Y=>Y.toUpperCase()===(F||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const y=(ke[n.id]||[]).filter(d=>{if(O.length===0)return!0;const{projectType:v}=d;return O.some(x=>x.toUpperCase()===(v||"").toUpperCase())}),F=ne[n.id]||rs,Y=y.slice(0,F),te=y.length>F,je=y.length-F;return e.jsxs(e.Fragment,{children:[Y.map((d,v)=>{var Te;const{prospect:x,projectType:K,activeStep:se}=d,U=`${x.id}-${K||"default"}-${n.id}-${v}`,ae=x.projectType||x.tags&&x.tags[0]||"Projet",J=K&&((Te=$[K])!=null&&Te.title)?$[K].title:ae,xe=(se==null?void 0:se.label)||(se==null?void 0:se.name)||n.name,be=n.color||"bg-blue-100 text-blue-700",Pe=`${x.id}-${K||J}-${n.id}-${v}`;return e.jsx(Ke.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(rr,{prospect:{...x,_projectContext:{projectType:K||ae,projectTitle:J,stepLabel:xe,projectColor:be}},onClick:()=>Ee(x,K||x.projectType||(Array.isArray(x.tags)?x.tags[0]:ae)),compact:!0,sortableId:Pe,projectsData:$})},U)}),te&&e.jsxs("button",{onClick:()=>qe(n.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(je,ns)," de plus (",je," restants)"]}),y.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(tt,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},n.id))})})}),e.jsx(da,{open:h,onOpenChange:f,onAddProspect:Ve}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(n=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},n))})})})]})};export{Gr as default};
