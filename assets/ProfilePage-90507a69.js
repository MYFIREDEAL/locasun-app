import{r as c,s as V,L as w,l as z,R as Ta,j as e,ai as ms,S as F,t as L,v as U,w as q,x as b,B as x,T as ee,b as je,a as Fa,ad as La,aB as Ua,ae as qa,m as G,a9 as h,aa as O,o as Va,a0 as Ke,D as W,aC as Rs,i as Q,k as Y,n as Z,y as X,A as We,z as Qe,aD as Ga,E as Ye,F as Ze,G as Xe,H as es,I as ss,J as as,K as ts,O as Ha,V as Ba,P as ae,aE as ns,aF as ls,aG as is,ac as le,aH as Ts,ay as Ae,aI as hs,az as Ja,g as Fs,_ as Ka,aJ as os,ak as Wa,al as Qa,am as Ya,aK as Za}from"./index-3bb3845c.js";import{S as $s}from"./SearchableSelect-6f0cb30f.js";import{P as cs}from"./pen-square-40b76721.js";const Xa=(l,I=!0)=>{const[P,C]=c.useState([]),[n,j]=c.useState(!0),[g,S]=c.useState(null),a=async()=>{try{j(!0);const{data:p,error:i}=await V.rpc("get_users_safe");if(i)throw i;C(p||[]),S(null)}catch(p){z.error("âŒ Erreur chargement utilisateurs CRUD:",p),S(p.message),w({title:"Erreur",description:"Impossible de charger les utilisateurs.",variant:"destructive"})}finally{j(!1)}};return c.useEffect(()=>{a()},[]),c.useEffect(()=>{if(!I||!l)return;const p=V.channel(`users-crud-${l}`).on("postgres_changes",{event:"*",schema:"public",table:"users",filter:`organization_id=eq.${l}`},i=>{i.eventType==="INSERT"?(C(_=>[..._,i.new]),w({title:"ðŸ‘¤ Nouvel utilisateur",description:`${i.new.name} a Ã©tÃ© ajoutÃ© !`,className:"bg-green-500 text-white"})):i.eventType==="UPDATE"?C(_=>_.map($=>$.id===i.new.id?{...$,...i.new}:$)):i.eventType==="DELETE"&&(C(_=>_.filter($=>$.id!==i.old.id)),w({title:"ðŸ—‘ï¸ Utilisateur supprimÃ©",description:"Un utilisateur a Ã©tÃ© supprimÃ©."}))}).subscribe();return()=>{V.removeChannel(p)}},[I,l]),{users:P,loading:n,error:g,addUser:async p=>{try{if(!(p!=null&&p.organizationId))throw new Error("OrganizationId manquant â€” insert users bloquÃ©");let i=null;if(p.manager&&p.manager!=="none"&&p.manager!==""){const{data:m}=await V.from("users").select("user_id").eq("name",p.manager).single();m&&(i=m.user_id)}const{data:{session:_}}=await V.auth.getSession(),$=await fetch(`${V.supabaseUrl}/functions/v1/invite-user`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(_==null?void 0:_.access_token)||""}`},body:JSON.stringify({email:p.email,name:p.name,role:p.role,managerId:i,organizationId:p.organizationId,accessRights:p.accessRights||{modules:["Pipeline","Agenda","Contacts"],users:[]},phone:p.phone||null})});if(!$.ok){const m=await $.json();throw new Error(m.error||"Erreur lors de l'invitation")}return w({title:"Invitation envoyÃ©e !",description:`${p.name} recevra un email pour crÃ©er son mot de passe.`,className:"bg-green-500 text-white"}),{success:!0}}catch(i){throw z.error("âŒ Erreur invitation utilisateur:",i),w({title:"Erreur",description:i.message||"Impossible d'inviter l'utilisateur.",variant:"destructive"}),i}},updateUser:async(p,i)=>{try{const $=typeof p=="string"&&p.includes("-")?"user_id":"id",m=p;z.debug("updateUser called",{idField:$,idValue:m});const v={};if(i.name!==void 0&&(v.name=i.name),i.email!==void 0&&(v.email=i.email),i.role!==void 0&&(v.role=i.role),i.phone!==void 0&&(v.phone=i.phone),i.avatarUrl!==void 0&&(v.avatar_url=i.avatarUrl),i.accessRights!==void 0&&(v.access_rights=i.accessRights,z.debug("access_rights sent",{hasRights:!!i.accessRights})),i.manager!==void 0)if(z.debug("Manager received",{manager:i.manager}),i.manager===""||i.manager==="none")v.manager_id=null,z.debug("Manager set to null");else{const{data:d,error:y}=await V.from("users").select("user_id").eq("name",i.manager).single();z.debug("Searching manager by name",{manager:i.manager,found:!!d}),y&&z.error("Manager search error:",y),d&&(v.manager_id=d.user_id,z.debug("manager_id assigned",{managerId:d.user_id}))}v.updated_at=new Date().toISOString(),z.debug("Final dbUpdates",{fields:Object.keys(v)});let f,o;if(i.accessRights!==void 0){z.debug("Using RPC for access_rights");const d=await V.rpc("update_user_access_rights",{target_user_id:m,new_access_rights:i.accessRights});f=d.data,o=d.error}else{const d=await V.from("users").update(v).eq($,m).select();f=d.data,o=d.error}if(z.debug("Supabase response",{hasData:!!f,hasError:!!o}),o)throw o;const r=Array.isArray(f)?f[0]:f;return w({title:"SuccÃ¨s !",description:"Utilisateur modifiÃ© avec succÃ¨s.",className:"bg-green-500 text-white"}),r}catch(_){throw z.error("âŒ Erreur update utilisateur:",_),w({title:"Erreur",description:_.message||"Impossible de modifier l'utilisateur.",variant:"destructive"}),_}},deleteUser:async p=>{try{const _=typeof p=="string"&&p.includes("-")?"user_id":"id",$=p,{data:m,error:v}=await V.from("users").select("*, manager:manager_id(id, name)").eq(_,$).single();if(v)throw v;if(!m)throw new Error("Utilisateur introuvable");let f=null;if(m.manager_id)f=m.manager_id;else{const{data:r}=await V.from("users").select("id").in("role",["Global Admin","Manager"]).limit(1).single();r&&(f=r.id)}if(f){const{error:r}=await V.from("prospects").update({owner_id:f}).eq("owner_id",userId);r&&z.error("âš ï¸ Erreur rÃ©assignation prospects:",r)}const{error:o}=await V.from("users").delete().eq(_,$);if(o)throw o;return w({title:"SuccÃ¨s !",description:`${m.name} a Ã©tÃ© supprimÃ© et ses prospects rÃ©assignÃ©s.`,className:"bg-green-500 text-white"}),!0}catch(i){throw z.error("âŒ Erreur suppression utilisateur:",i),w({title:"Erreur",description:i.message||"Impossible de supprimer l'utilisateur.",variant:"destructive"}),i}},refetchUsers:a}},Ie=l=>(l||"").toString().trim().toUpperCase(),et=(l="pipeline-step")=>`${l}-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,st=(l,I,P)=>({id:I||et(),label:Ie(l),color:typeof P=="string"&&P.trim()?P:null}),at=["ðŸ”Œ","ðŸ’¡","â˜€ï¸","ðŸ’¸","ðŸ­","ðŸ†•","âœ…","âš¡","ðŸ“","â³","ðŸŒž","âž¡ï¸","ðŸ”Ž","ðŸ› ï¸","âœï¸","ðŸ¦","ðŸ“¦","ðŸ‘·","ðŸ“‹","âš¡ï¸","ðŸ’¶","ðŸ“ˆ","ðŸ”§"],rs=({value:l,onChange:I})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:l,onChange:P=>I(P.target.value),className:"w-16 text-center text-xl"}),e.jsxs(Wa,{children:[e.jsx(Qa,{asChild:!0,children:e.jsx(x,{type:"button",variant:"outline",size:"sm",className:"h-10 w-10 p-0",title:"Choisir un emoji",children:e.jsx(Fs,{className:"h-4 w-4"})})}),e.jsx(Ya,{className:"w-72 p-3",align:"start",children:e.jsx("div",{className:"flex flex-wrap gap-1 max-h-96 overflow-y-auto",children:at.map(P=>e.jsx("button",{type:"button",onClick:()=>I(P),className:"w-10 h-10 flex items-center justify-center text-xl hover:bg-gray-100 rounded-md transition-colors",children:P},P))})})]})]}),ds=[{value:"bg-blue-100",label:"Bleu pastel"},{value:"bg-yellow-100",label:"Jaune doux"},{value:"bg-green-100",label:"Vert tendre"},{value:"bg-purple-100",label:"Violet pastel"},{value:"bg-orange-100",label:"Orange clair"},{value:"bg-indigo-100",label:"Indigo clair"},{value:"bg-teal-100",label:"Turquoise"},{value:"bg-pink-100",label:"Rose"},{value:"bg-rose-100",label:"Framboise"},{value:"bg-gray-100",label:"Gris doux"}],tt=[{value:"bg-blue-100 text-blue-800",label:"Bleu",preview:"bg-blue-100"},{value:"bg-green-100 text-green-800",label:"Vert",preview:"bg-green-100"},{value:"bg-orange-100 text-orange-800",label:"Orange",preview:"bg-orange-100"},{value:"bg-teal-100 text-teal-800",label:"Turquoise",preview:"bg-teal-100"},{value:"bg-purple-100 text-purple-800",label:"Violet",preview:"bg-purple-100"},{value:"bg-yellow-100 text-yellow-800",label:"Jaune",preview:"bg-yellow-100"},{value:"bg-pink-100 text-pink-800",label:"Rose",preview:"bg-pink-100"},{value:"bg-indigo-100 text-indigo-800",label:"Indigo",preview:"bg-indigo-100"},{value:"bg-red-100 text-red-800",label:"Rouge",preview:"bg-red-100"},{value:"bg-gray-100 text-gray-800",label:"Gris",preview:"bg-gray-100"}],rt={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},Ls=(l,I=0)=>{const P=Ie(l);return rt[P]||ds[I%ds.length].value},nt=Ta.memo(({step:l,index:I,provided:P,snapshot:C,onColorChange:n,onEdit:j,onRemove:g})=>e.jsxs("div",{ref:P.innerRef,...P.draggableProps,className:`flex items-center gap-4 p-3 bg-white border border-gray-200 rounded-xl shadow-sm transition-all ${C.isDragging?"ring-2 ring-purple-200 shadow-lg":""}`,children:[e.jsx("div",{...P.dragHandleProps,className:"text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing flex-shrink-0",children:e.jsx(ms,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`w-3 h-3 rounded-full border border-white shadow-sm flex-shrink-0 ${l.color||"bg-gray-200"}`}),e.jsx("p",{className:"text-sm font-semibold tracking-wide text-gray-800 break-words",children:l.label})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ã‰tape #",I+1]})]}),!C.isDragging&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-end",children:[e.jsxs(F,{value:l.color||Ls(l.label,I),onValueChange:n,children:[e.jsx(L,{className:"w-36 justify-between",children:e.jsx(U,{placeholder:"Couleur"})}),e.jsx(q,{children:ds.map(S=>e.jsx(b,{value:S.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`w-3 h-3 rounded-full border border-white shadow-sm ${S.value}`}),S.label]})},S.value))})]}),e.jsx(x,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-gray-500 hover:text-blue-600",onClick:j,"aria-label":`Renommer ${l.label}`,children:e.jsx(cs,{className:"h-4 w-4"})}),e.jsx(x,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-gray-500 hover:text-red-500",onClick:g,"aria-label":`Supprimer ${l.label}`,children:e.jsx(ee,{className:"h-4 w-4"})})]})]})),lt=({field:l,onSave:I,onCancel:P})=>{const{formContactConfig:C}=je(),[n,j]=c.useState(l?{...l}:{name:"",type:"text",placeholder:"",required:!1,options:[],show_if_conditions:[],condition_operator:"AND",is_repeater:!1,repeats_fields:[]}),g=()=>{if(!n.name){w({title:"Le nom du champ est obligatoire",variant:"destructive"});return}I({...n,id:n.id||`field-${Date.now()}`})},S=l?C.findIndex(a=>a.id===l.id):C.length;return e.jsxs("div",{className:"space-y-4 max-h-[70vh] overflow-y-auto px-1",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"field-name",children:"Nom du champ"}),e.jsx(O,{id:"field-name",value:n.name,onChange:a=>j({...n,name:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"field-type",children:"Type"}),e.jsxs(F,{value:n.type,onValueChange:a=>j({...n,type:a}),children:[e.jsx(L,{id:"field-type",children:e.jsx(U,{})}),e.jsxs(q,{children:[e.jsx(b,{value:"text",children:"Texte"}),e.jsx(b,{value:"email",children:"Email"}),e.jsx(b,{value:"phone",children:"TÃ©lÃ©phone"}),e.jsx(b,{value:"number",children:"Nombre"}),e.jsx(b,{value:"textarea",children:"Zone de texte"}),e.jsx(b,{value:"select",children:"Liste dÃ©roulante"}),e.jsx(b,{value:"file",children:"Fichier"})]})]})]}),n.type==="select"&&e.jsxs("div",{className:"pl-2 space-y-2 border-l-2 border-blue-300",children:[e.jsx(h,{className:"text-xs font-semibold text-blue-700",children:"Options du menu dÃ©roulant :"}),e.jsx("div",{className:"space-y-1",children:(n.options||[]).map((a,E)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:a,onChange:N=>{const M=[...n.options||[]];M[E]=N.target.value,j({...n,options:M})},placeholder:`Option ${E+1}`,className:"flex-1"}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>{const N=(n.options||[]).filter((M,p)=>p!==E);j({...n,options:N})},children:e.jsx(ee,{className:"h-3 w-3 text-red-500"})})]},E))}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{const a=[...n.options||[],""];j({...n,options:a})},className:"text-xs",children:[e.jsx(ae,{className:"h-3 w-3 mr-1"})," Ajouter une option"]})]}),e.jsxs("div",{className:"pl-2 space-y-2 border-l-2 border-purple-300",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{className:"text-xs font-semibold text-purple-700",children:"Conditions d'affichage :"}),n.show_if_conditions&&n.show_if_conditions.length>1&&e.jsxs(F,{value:n.condition_operator||"AND",onValueChange:a=>j({...n,condition_operator:a}),children:[e.jsx(L,{className:"w-[100px] h-7 text-xs",children:e.jsx(U,{})}),e.jsxs(q,{children:[e.jsx(b,{value:"AND",children:"ET (toutes)"}),e.jsx(b,{value:"OR",children:"OU (au moins une)"})]})]})]}),(n.show_if_conditions||[]).map((a,E)=>e.jsxs("div",{className:"flex items-center gap-2 bg-purple-50 p-2 rounded",children:[e.jsxs(F,{value:`${a.field}::${a.equals}`,onValueChange:N=>{const[M,p]=N.split("::"),i=[...n.show_if_conditions||[]];i[E]={field:M,equals:p},j({...n,show_if_conditions:i})},children:[e.jsx(L,{className:"flex-1 h-8 text-xs",children:e.jsx(U,{})}),e.jsx(q,{children:C.slice(0,S).filter(N=>N.type==="text"||N.type==="email"||N.type==="phone"||N.type==="select").map(N=>N.type==="select"&&N.options&&N.options.length>0?N.options.map(M=>e.jsxs(b,{value:`${N.id}::${M}`,children:['"',N.name,'" = "',M,'"']},`${N.id}::${M}`)):e.jsxs(b,{value:`${N.id}::has_value`,children:['"',N.name,'" rempli']},N.id)).flat()})]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>{const N=(n.show_if_conditions||[]).filter((M,p)=>p!==E);j({...n,show_if_conditions:N.length>0?N:[]})},children:e.jsx(ee,{className:"h-3 w-3 text-red-500"})})]},E)),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{const a=[...n.show_if_conditions||[],{field:"",equals:""}];j({...n,show_if_conditions:a})},className:"text-xs w-full",children:[e.jsx(ae,{className:"h-3 w-3 mr-1"})," Ajouter une condition"]}),(!n.show_if_conditions||n.show_if_conditions.length===0)&&e.jsx("p",{className:"text-xs text-gray-500 italic",children:"Toujours visible (aucune condition)"})]}),n.type==="select"&&e.jsxs("div",{className:"pl-2 space-y-2 border-l-2 border-green-300",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{className:"text-xs font-semibold text-green-700",children:"RÃ©pÃ©tition de champs :"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"repeater-checkbox",checked:n.is_repeater||!1,onChange:a=>j({...n,is_repeater:a.target.checked}),className:"h-4 w-4 text-green-600 focus:ring-green-500"}),e.jsx(h,{htmlFor:"repeater-checkbox",className:"text-xs font-normal cursor-pointer",children:"Utiliser comme compteur de rÃ©pÃ©tition"})]})]}),n.is_repeater&&e.jsxs("div",{className:"space-y-2 bg-green-50 p-3 rounded",children:[e.jsx(h,{className:"text-xs",children:"Champs Ã  rÃ©pÃ©ter :"}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:"SÃ©lectionnez les champs qui doivent Ãªtre rÃ©pÃ©tÃ©s N fois (oÃ¹ N = valeur choisie dans le menu dÃ©roulant)"}),e.jsx("div",{className:"space-y-1",children:C.slice(S+1).map(a=>{const E=(n.repeats_fields||[]).includes(a.id);return e.jsxs("div",{className:"flex items-center gap-2 bg-white p-2 rounded border",children:[e.jsx("input",{type:"checkbox",id:`repeat-${a.id}`,checked:E,onChange:N=>{const M=n.repeats_fields||[],p=N.target.checked?[...M,a.id]:M.filter(i=>i!==a.id);j({...n,repeats_fields:p})},className:"h-4 w-4 text-green-600 focus:ring-green-500"}),e.jsxs(h,{htmlFor:`repeat-${a.id}`,className:"text-xs font-normal cursor-pointer flex-1",children:[a.name," (",a.type,")"]})]},a.id)})}),C.slice(S+1).length===0&&e.jsx("p",{className:"text-xs text-orange-600 italic",children:"Ajoutez des champs aprÃ¨s celui-ci pour pouvoir les rÃ©pÃ©ter"})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"field-placeholder",children:"Placeholder"}),e.jsx(O,{id:"field-placeholder",value:n.placeholder,onChange:a=>j({...n,placeholder:a.target.value})})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(hs,{id:"field-required",checked:n.required,onCheckedChange:a=>j({...n,required:a})}),e.jsx(h,{htmlFor:"field-required",children:"Obligatoire ?"})]}),e.jsxs(X,{children:[e.jsx(x,{variant:"outline",onClick:P,children:"Annuler"}),e.jsx(x,{onClick:g,className:"bg-green-600 hover:bg-green-700",children:"Enregistrer"})]})]})},it=({form:l,onSave:I,onCancel:P})=>{const{projectsData:C}=je(),[n,j]=c.useState(l?JSON.parse(JSON.stringify(l)):{name:"",fields:[],projectIds:[]}),[g,S]=c.useState(""),[a,E]=c.useState("text"),N=c.useMemo(()=>Object.values(C).map(m=>({value:m.type,label:m.title})),[C]),M=c.useMemo(()=>(n.projectIds||[]).map(m=>N.find(v=>v.value===m)).filter(Boolean),[n.projectIds,N]);c.useEffect(()=>{l&&j(JSON.parse(JSON.stringify(l)))},[l]);const p=(m,v,f)=>{const o=[...n.fields];o[m]={...o[m],[v]:f},j(r=>({...r,fields:o}))},i=()=>{if(!g.trim())return;const m={id:`field-${Date.now()}`,label:g,type:a,placeholder:""};j(v=>({...v,fields:[...v.fields||[],m]})),S(""),E("text")},_=m=>{const v=(n.fields||[]).filter((f,o)=>o!==m);j(f=>({...f,fields:v}))},$=()=>{if(!n.name.trim()){w({title:"Nom manquant",description:"Veuillez nommer votre formulaire.",variant:"destructive"});return}const m={...n,id:n.id||`form-${Date.now()}`};I(m)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"form-name",children:"Nom du formulaire (Interne)"}),e.jsx(O,{id:"form-name",value:n.name,onChange:m=>j(v=>({...v,name:m.target.value}))})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Ã€ qui est destinÃ© ce formulaire ?"}),e.jsxs("div",{className:"flex gap-4 mt-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",id:"audience-client",name:"audience",value:"client",checked:(n.audience||"client")==="client",onChange:m=>j(v=>({...v,audience:m.target.value})),className:"h-4 w-4 text-blue-600 focus:ring-blue-500"}),e.jsx(h,{htmlFor:"audience-client",className:"font-normal cursor-pointer",children:"Client"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",id:"audience-internal",name:"audience",value:"internal",checked:n.audience==="internal",onChange:m=>j(v=>({...v,audience:m.target.value})),className:"h-4 w-4 text-blue-600 focus:ring-blue-500"}),e.jsx(h,{htmlFor:"audience-internal",className:"font-normal cursor-pointer",children:"Interne (Ã©quipe)"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:(n.audience||"client")==="client"?"Ce formulaire sera envoyable au client via le chat":"Ce formulaire sera visible uniquement dans la fiche prospect (Ã©quipe)"})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Projets associÃ©s"}),e.jsx(Ts,{options:N,selected:M,onChange:m=>j(v=>({...v,projectIds:m.map(f=>f.value)})),placeholder:"SÃ©lectionner des projets...",searchPlaceholder:"Rechercher un projet...",emptyText:"Aucun projet trouvÃ©.",className:"mt-1"})]}),e.jsx("h3",{className:"text-md font-semibold text-gray-700 pt-4 border-t",children:"Champs du formulaire"}),e.jsx("div",{className:"space-y-3",children:(n.fields||[]).map((m,v)=>e.jsxs("div",{className:"flex flex-col gap-2 bg-gray-50 p-3 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:m.label,onChange:f=>p(v,"label",f.target.value),placeholder:"Nom du champ"}),e.jsxs(F,{value:m.type,onValueChange:f=>p(v,"type",f),children:[e.jsx(L,{className:"w-[180px]",children:e.jsx(U,{})}),e.jsxs(q,{children:[e.jsx(b,{value:"text",children:"Texte"}),e.jsx(b,{value:"email",children:"Email"}),e.jsx(b,{value:"phone",children:"TÃ©lÃ©phone"}),e.jsx(b,{value:"number",children:"Nombre"}),e.jsx(b,{value:"select",children:"Liste dÃ©roulante"}),e.jsx(b,{value:"file",children:"Fichier"})]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>_(v),children:e.jsx(ee,{className:"h-4 w-4 text-red-500"})})]}),m.type==="select"&&e.jsxs("div",{className:"pl-2 space-y-2 border-l-2 border-blue-300",children:[e.jsx(h,{className:"text-xs font-semibold text-blue-700",children:"Options du menu dÃ©roulant :"}),e.jsx("div",{className:"space-y-1",children:(m.options||[]).map((f,o)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:f,onChange:r=>{const d=[...m.options||[]];d[o]=r.target.value,p(v,"options",d)},placeholder:`Option ${o+1}`,className:"flex-1"}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>{const r=(m.options||[]).filter((d,y)=>y!==o);p(v,"options",r)},children:e.jsx(ee,{className:"h-3 w-3 text-red-500"})})]},o))}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{const f=[...m.options||[],""];p(v,"options",f)},className:"text-xs",children:[e.jsx(ae,{className:"h-3 w-3 mr-1"})," Ajouter une option"]})]}),e.jsxs("div",{className:"pl-2 space-y-2 border-l-2 border-purple-300",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{className:"text-xs font-semibold text-purple-700",children:"Conditions d'affichage :"}),m.show_if_conditions&&m.show_if_conditions.length>1&&e.jsxs(F,{value:m.condition_operator||"AND",onValueChange:f=>p(v,"condition_operator",f),children:[e.jsx(L,{className:"w-[100px] h-7 text-xs",children:e.jsx(U,{})}),e.jsxs(q,{children:[e.jsx(b,{value:"AND",children:"ET (toutes)"}),e.jsx(b,{value:"OR",children:"OU (au moins une)"})]})]})]}),(m.show_if_conditions||[]).map((f,o)=>e.jsxs("div",{className:"flex items-center gap-2 bg-purple-50 p-2 rounded",children:[e.jsxs(F,{value:`${f.field}::${f.equals}`,onValueChange:r=>{const[d,y]=r.split("::"),D=[...m.show_if_conditions||[]];D[o]={field:d,equals:y},p(v,"show_if_conditions",D)},children:[e.jsx(L,{className:"flex-1 h-8 text-xs",children:e.jsx(U,{})}),e.jsx(q,{children:(n.fields||[]).slice(0,v).filter(r=>r.type==="text"||r.type==="email"||r.type==="phone"||r.type==="select").map(r=>r.type==="select"&&r.options&&r.options.length>0?r.options.map(d=>e.jsxs(b,{value:`${r.id}::${d}`,children:['"',r.label,'" = "',d,'"']},`${r.id}::${d}`)):e.jsxs(b,{value:`${r.id}::has_value`,children:['"',r.label,'" rempli']},r.id)).flat()})]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>{const r=(m.show_if_conditions||[]).filter((d,y)=>y!==o);p(v,"show_if_conditions",r.length>0?r:void 0)},children:e.jsx(ee,{className:"h-3 w-3 text-red-500"})})]},o)),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{const f=[...m.show_if_conditions||[],{field:"",equals:""}];p(v,"show_if_conditions",f)},className:"text-xs w-full",children:[e.jsx(ae,{className:"h-3 w-3 mr-1"})," Ajouter une condition"]}),(!m.show_if_conditions||m.show_if_conditions.length===0)&&e.jsx("p",{className:"text-xs text-gray-500 italic",children:"Toujours visible (aucune condition)"})]}),m.type==="select"&&e.jsxs("div",{className:"pl-2 space-y-2 border-l-2 border-green-300 mt-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{className:"text-xs font-semibold text-green-700",children:"RÃ©pÃ©tition de champs :"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:`repeater-${m.id}`,checked:m.is_repeater||!1,onChange:f=>p(v,"is_repeater",f.target.checked),className:"h-4 w-4 text-green-600 focus:ring-green-500"}),e.jsx(h,{htmlFor:`repeater-${m.id}`,className:"text-xs font-normal cursor-pointer",children:"Utiliser comme compteur de rÃ©pÃ©tition"})]})]}),m.is_repeater&&e.jsxs("div",{className:"space-y-2 bg-green-50 p-3 rounded",children:[e.jsx(h,{className:"text-xs",children:"Champs Ã  rÃ©pÃ©ter :"}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:"SÃ©lectionnez les champs qui doivent Ãªtre rÃ©pÃ©tÃ©s N fois (oÃ¹ N = valeur choisie dans le menu dÃ©roulant)"}),e.jsx("div",{className:"space-y-1",children:(n.fields||[]).slice(v+1).map((f,o)=>{const r=(m.repeats_fields||[]).includes(f.id);return e.jsxs("div",{className:"flex items-center gap-2 bg-white p-2 rounded border",children:[e.jsx("input",{type:"checkbox",id:`repeat-${m.id}-${f.id}`,checked:r,onChange:d=>{const y=m.repeats_fields||[],D=d.target.checked?[...y,f.id]:y.filter(H=>H!==f.id);p(v,"repeats_fields",D)},className:"h-4 w-4 text-green-600 focus:ring-green-500"}),e.jsxs(h,{htmlFor:`repeat-${m.id}-${f.id}`,className:"text-xs font-normal cursor-pointer flex-1",children:[f.label," (",f.type,")"]})]},f.id)})}),(n.fields||[]).slice(v+1).length===0&&e.jsx("p",{className:"text-xs text-orange-600 italic",children:"Ajoutez des champs aprÃ¨s celui-ci pour pouvoir les rÃ©pÃ©ter"})]}),!m.is_repeater&&e.jsx("p",{className:"text-xs text-gray-500 italic",children:"Activez cette option pour gÃ©nÃ©rer automatiquement N copies des champs suivants"})]})]},m.id))}),e.jsxs("div",{className:"flex items-end gap-2 pt-4 border-t",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx(h,{children:"Ajouter un champ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{value:g,onChange:m=>S(m.target.value),placeholder:"Nom du nouveau champ"}),e.jsxs(F,{value:a,onValueChange:E,children:[e.jsx(L,{className:"w-[180px]",children:e.jsx(U,{})}),e.jsxs(q,{children:[e.jsx(b,{value:"text",children:"Texte"}),e.jsx(b,{value:"email",children:"Email"}),e.jsx(b,{value:"phone",children:"TÃ©lÃ©phone"}),e.jsx(b,{value:"number",children:"Nombre"}),e.jsx(b,{value:"select",children:"Liste dÃ©roulante"}),e.jsx(b,{value:"file",children:"Fichier"})]})]})]})]}),e.jsx(x,{onClick:i,children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs(X,{children:[e.jsx(x,{variant:"outline",onClick:P,children:"Annuler"}),e.jsx(x,{onClick:$,className:"bg-green-600 hover:bg-green-700",children:"Enregistrer le formulaire"})]})]})},Us=({project:l,onSave:I,onCancel:P,globalPipelineSteps:C=[]})=>{const n=()=>{var d;const o=l?JSON.parse(JSON.stringify(l)):{type:"",title:"",clientTitle:"",icon:"ðŸ†•",color:"gradient-blue",steps:[],isPublic:!0},r=((d=C[0])==null?void 0:d.id)??null;return o.steps=Array.isArray(o.steps)?o.steps.map(y=>({...y,id:y.id||`step-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,globalStepId:y.globalStepId??r})):[],o},[j,g]=c.useState(n),[S,a]=c.useState(""),[E,N]=c.useState("âž¡ï¸"),M=c.useMemo(()=>C.map(o=>e.jsx(b,{value:o.id,children:o.label},o.id)),[C]);c.useEffect(()=>{g(n()),a(""),N("âž¡ï¸")},[l]),c.useEffect(()=>{g(o=>{var H;const r=new Set(C.map(T=>T.id)),d=((H=C[0])==null?void 0:H.id)??null;let y=!1;const D=(o.steps||[]).map(T=>{const Pe=T.globalStepId&&r.has(T.globalStepId)?T.globalStepId:d??null;return Pe!==T.globalStepId?(y=!0,{...T,globalStepId:Pe}):T});return y?{...o,steps:D}:o})},[C]);const p=c.useCallback((o,r,d)=>{g(y=>{const D=[...y.steps];return D[o]={...D[o],[r]:d},{...y,steps:D}})},[]),i=c.useCallback(()=>{var d;if(!S.trim())return;const o=((d=C[0])==null?void 0:d.id)??null,r={id:`step-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,name:S,status:"pending",icon:E,descriptions:{},globalStepId:o};g(y=>({...y,steps:[...y.steps,r]})),a(""),N("âž¡ï¸")},[S,E,C]),_=c.useCallback(o=>{g(r=>({...r,steps:r.steps.filter((d,y)=>y!==o)}))},[]),$=o=>{if(!o.destination)return;const r=Array.from(j.steps),[d]=r.splice(o.source.index,1);r.splice(o.destination.index,0,d),g(y=>({...y,steps:r}))},m=()=>{typeof document<"u"&&(document.body.style.overflow="hidden")},v=o=>{typeof document<"u"&&(document.body.style.overflow=""),$(o)},f=()=>{const o=l&&l.type,r={...j,type:o?j.type:Za(j.title)||`project-${Date.now()}`,id:j.id||Date.now()};if(!r.title){w({title:"Titre manquant",description:"Veuillez donner un titre Ã  votre projet.",variant:"destructive"});return}r.clientTitle||(r.clientTitle=r.title),I(r)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ParamÃ¨tres du Projet"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ja,{id:"isPublic",checked:j.isPublic,onCheckedChange:o=>g(r=>({...r,isPublic:o}))}),e.jsx(h,{htmlFor:"isPublic",children:"En ligne"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"project-title",children:"Titre du Projet (Interne)"}),e.jsx(O,{id:"project-title",value:j.title,onChange:o=>g(r=>({...r,title:o.target.value}))})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"project-client-title",children:"Nom affichÃ© au client"}),e.jsx(O,{id:"project-client-title",value:j.clientTitle,onChange:o=>g(r=>({...r,clientTitle:o.target.value}))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"project-icon",children:"IcÃ´ne (Emoji)"}),e.jsx(rs,{value:j.icon,onChange:o=>g(r=>({...r,icon:o}))})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"project-color",children:"Couleur du Badge"}),e.jsxs(F,{value:j.color||"bg-blue-100 text-blue-800",onValueChange:o=>g(r=>({...r,color:o})),children:[e.jsx(L,{id:"project-color",children:e.jsx(U,{placeholder:"Choisir une couleur"})}),e.jsx(q,{children:tt.map(o=>e.jsx(b,{value:o.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`w-4 h-4 rounded-full ${o.preview} border border-gray-300`}),o.label]})},o.value))})]})]})]}),e.jsx("h3",{className:"text-md font-semibold text-gray-700 pt-4 border-t",children:"Ã‰tapes de la Timeline"}),e.jsx(ns,{onDragStart:m,onDragEnd:v,children:e.jsx(ls,{droppableId:"steps",children:o=>e.jsxs("div",{...o.droppableProps,ref:o.innerRef,className:"space-y-3",children:[j.steps.map((r,d)=>e.jsx(is,{draggableId:r.id,index:d,children:(y,D)=>{const H=D.isDragging?{...y.draggableProps.style,position:"relative",left:"auto",top:"auto"}:y.draggableProps.style;return e.jsx("div",{ref:y.innerRef,...y.draggableProps,style:H,className:`rounded-xl border border-gray-200 bg-white p-3 shadow-sm transition-all ${D.isDragging?"ring-2 ring-purple-200 shadow-lg":""}`,children:e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 md:flex-1",children:[e.jsx("div",{...y.dragHandleProps,className:"text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing",children:e.jsx(ms,{className:"h-5 w-5"})}),e.jsx(rs,{value:r.icon,onChange:T=>p(d,"icon",T)}),e.jsx(O,{value:r.name,onChange:T=>p(d,"name",T.target.value),placeholder:"Nom de l'Ã©tape",className:"flex-1"})]}),e.jsxs("div",{className:"flex items-center gap-2 md:w-72",children:[e.jsxs(F,{value:r.globalStepId??"",onValueChange:T=>p(d,"globalStepId",T||null),children:[e.jsx(L,{className:"bg-white",children:e.jsx(U,{placeholder:"Associer Ã  une Ã©tape globale"})}),e.jsxs(q,{children:[e.jsx(b,{value:"",children:"Non assignÃ©e"}),M]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>_(d),children:e.jsx(ee,{className:"h-4 w-4 text-red-500"})})]})]})})}},r.id)),o.placeholder]})})}),e.jsxs("div",{className:"flex items-end gap-2 pt-4 border-t",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx(h,{children:"Ajouter une Ã©tape"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(rs,{value:E,onChange:N}),e.jsx(O,{value:S,onChange:o=>a(o.target.value),placeholder:"Nom de la nouvelle Ã©tape",className:"flex-1"})]})]}),e.jsx(x,{onClick:i,children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs(X,{children:[e.jsx(x,{variant:"outline",onClick:P,children:"Annuler"}),e.jsx(x,{onClick:f,className:"bg-green-600 hover:bg-green-700",children:"Enregistrer le projet"})]})]})},ot=({open:l,onOpenChange:I,onSave:P,globalPipelineSteps:C=[]})=>{const{projectsData:n}=je(),[j,g]=c.useState(1),[S,a]=c.useState(null),E=i=>{const _=n[i];if(!_){w({title:"ModÃ¨le introuvable",description:"Le modÃ¨le de projet n'existe plus.",variant:"destructive"});return}const $={...JSON.parse(JSON.stringify(_)),title:`${_.title} (Copie)`,clientTitle:`${_.clientTitle} (Copie)`,type:`${_.type}-copie-${Date.now()}`,isPublic:!0};a($),g(2)},N=()=>{var _;const i=((_=C[0])==null?void 0:_.id)??null;a({type:"",title:"",clientTitle:"",icon:"ðŸ†•",color:"gradient-blue",steps:[{name:"Nouvelle Ã‰tape",status:"pending",icon:"âž¡ï¸",descriptions:{},globalStepId:i}],isPublic:!0}),g(2)},M=i=>{P(i),g(1),a(null),I(!1)},p=()=>{g(1),a(null),I(!1)};return e.jsx(W,{open:l,onOpenChange:i=>{i?I(!0):p()},children:e.jsxs(Q,{className:"sm:max-w-2xl",children:[e.jsxs(Y,{children:[e.jsx(Z,{children:j===1?"CrÃ©er un nouveau projet":"Modifier le projet"}),e.jsx(le,{children:j===1?"Choisissez un modÃ¨le de base ou partez de zÃ©ro.":"Personnalisez le titre, l'icÃ´ne et les Ã©tapes de votre nouveau projet."})]}),j===1&&e.jsxs("div",{className:"p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[Object.values(n).map(i=>e.jsxs(G.button,{onClick:()=>E(i.type),className:"p-4 border rounded-lg hover:shadow-lg hover:border-blue-500 transition-all text-center space-y-2",whileHover:{y:-5},children:[e.jsx("span",{className:"text-4xl",children:i.icon}),e.jsx("p",{className:"font-semibold",children:i.title})]},i.type)),e.jsxs(G.button,{onClick:N,className:"p-4 border border-dashed rounded-lg hover:shadow-lg hover:border-green-500 transition-all text-center space-y-2 flex flex-col items-center justify-center",whileHover:{y:-5},children:[e.jsx(ae,{className:"h-10 w-10 text-gray-400 mb-2"}),e.jsx("p",{className:"font-semibold",children:"Partir de zÃ©ro"})]})]}),j===2&&S&&e.jsx("div",{className:"p-6 max-h-[70vh] overflow-y-auto",children:e.jsx(Us,{project:S,onSave:M,onCancel:p,globalPipelineSteps:C})})]})})},ct=({action:l,onChange:I,onDelete:P,forms:C})=>{const n=(a,E)=>{I({...l,[a]:E})},j=()=>{const a=[...l.checklist||[],{id:`task-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:""}];n("checklist",a)},g=(a,E)=>{const N=[...l.checklist||[]];N[a].text=E,n("checklist",N)},S=a=>{const E=[...l.checklist||[]];E.splice(a,1),n("checklist",E)};return e.jsxs("div",{className:"p-4 bg-white rounded-lg border space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx(h,{className:"text-sm font-semibold text-gray-700 mb-2 block",children:"Type d'action"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>n("hasClientAction",!0),className:`flex-1 p-3 rounded-lg border-2 transition-all ${l.hasClientAction!==!1?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘¤"}),e.jsx("span",{className:"font-medium text-sm",children:"AssociÃ©e au client"})]})}),e.jsx("button",{type:"button",onClick:()=>n("hasClientAction",!1),className:`flex-1 p-3 rounded-lg border-2 transition-all ${l.hasClientAction===!1?"border-purple-500 bg-purple-50 text-purple-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ’¼"}),e.jsx("span",{className:"font-medium text-sm",children:"AssociÃ©e au commercial"})]})})]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:P,className:"ml-2",children:e.jsx(ee,{className:"h-4 w-4 text-red-500"})})]}),l.hasClientAction!==!1?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Message Ã  dire"}),e.jsx(Ae,{placeholder:"Ex: Bonjour, merci de complÃ©ter les informations...",value:l.message,onChange:a=>n("message",a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Action Ã  associer"}),e.jsxs(F,{value:l.type,onValueChange:a=>n("type",a),children:[e.jsx(L,{children:e.jsx(U,{placeholder:"Choisir une action"})}),e.jsxs(q,{children:[e.jsx(b,{value:"none",children:"Aucune"}),e.jsx(b,{value:"show_form",children:"Afficher un formulaire"}),e.jsx(b,{value:"start_signature",children:"Lancer une signature"}),e.jsx(b,{value:"request_document",children:"Demander un document"}),e.jsx(b,{value:"open_payment",children:"Ouvrir un paiement"})]})]})]}),e.jsxs(os,{children:[l.type==="show_form"&&e.jsxs(G.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2 overflow-hidden",children:[e.jsx(h,{children:"Formulaire Ã  afficher"}),e.jsxs(F,{value:l.formId,onValueChange:a=>n("formId",a),children:[e.jsx(L,{children:e.jsx(U,{placeholder:"Choisir un formulaire"})}),e.jsx(q,{children:Object.values(C).map(a=>e.jsx(b,{value:a.id,children:a.name},a.id))})]})]}),l.type==="request_document"&&e.jsxs(G.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2 overflow-hidden",children:[e.jsx(h,{children:"Type de document attendu"}),e.jsx("input",{type:"text",value:l.documentType||"",onChange:a=>n("documentType",a.target.value),placeholder:"Ex: Facture EDF, RIB, Titre de propriÃ©tÃ©...",className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),l.type==="start_signature"&&e.jsxs(G.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2 overflow-hidden",children:[e.jsx(h,{children:"Template de contrat Ã  utiliser"}),e.jsxs(F,{value:l.templateId,onValueChange:a=>n("templateId",a),children:[e.jsx(L,{children:e.jsx(U,{placeholder:"SÃ©lectionner un template"})}),e.jsx(q,{children:contractTemplates.filter(a=>a.isActive).map(a=>e.jsx(b,{value:a.id,children:a.name},a.id))})]}),!l.templateId&&e.jsx("p",{className:"text-xs text-red-500",children:"âš ï¸ Template obligatoire pour sauvegarder"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Mode de gestion"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>n("managementMode","automatic"),className:`flex-1 p-3 rounded-lg border-2 transition-all ${(l.managementMode||"automatic")==="automatic"?"border-green-500 bg-green-50 text-green-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"âœ¨"}),e.jsx("span",{className:"font-medium text-sm",children:"GÃ©rÃ© par l'IA"})]})}),e.jsx("button",{type:"button",onClick:()=>n("managementMode","manual"),className:`flex-1 p-3 rounded-lg border-2 transition-all ${l.managementMode==="manual"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘¤"}),e.jsx("span",{className:"font-medium text-sm",children:"GÃ©rÃ© par commercial"})]})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:(l.managementMode||"automatic")==="automatic"?"âš¡ EnvoyÃ© automatiquement par Charly AI":"ðŸ‘¨â€ðŸ’¼ Le commercial devra envoyer manuellement"}),e.jsx(os,{children:l.managementMode==="manual"&&e.jsxs(G.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"pt-3 border-t overflow-hidden space-y-3",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(hs,{id:`create-task-${l.id}`,checked:l.createTask!==!1,onCheckedChange:a=>n("createTask",a)}),e.jsxs("div",{className:"space-y-1 flex-1",children:[e.jsx(h,{htmlFor:`create-task-${l.id}`,className:"text-sm font-medium text-gray-700 cursor-pointer",children:"CrÃ©er automatiquement une tÃ¢che pour le commercial"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Une tÃ¢che sera envoyÃ©e au commercial dÃ¨s que cette Ã©tape devient l'Ã©tape en cours."})]})]}),l.createTask!==!1&&e.jsxs("div",{className:"space-y-2 ml-6",children:[e.jsx(h,{className:"text-sm",children:"Titre de la tÃ¢che"}),e.jsx("input",{type:"text",value:l.taskTitle||"Action requise pour ce client",onChange:a=>n("taskTitle",a.target.value),placeholder:"Action requise pour ce client",className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]})})]}),l.type==="show_form"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Mode de vÃ©rification"}),e.jsxs(F,{value:l.verificationMode||"human",onValueChange:a=>n("verificationMode",a),children:[e.jsx(L,{children:e.jsx(U,{placeholder:"Choisir le mode de vÃ©rification"})}),e.jsxs(q,{children:[e.jsx(b,{value:"none",children:"Pas de vÃ©rification (auto-validation)"}),e.jsx(b,{value:"ai",children:"IA automatique"}),e.jsx(b,{value:"human",children:"Humain (commercial vÃ©rifie)"})]})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[l.verificationMode==="none"&&"âœ… ValidÃ© automatiquement dÃ¨s que le client termine",l.verificationMode==="ai"&&"âœ¨ L'IA analysera et validera automatiquement",(!l.verificationMode||l.verificationMode==="human")&&"ðŸ‘¤ Une tÃ¢che sera crÃ©Ã©e pour que le commercial vÃ©rifie"]}),(!l.verificationMode||l.verificationMode==="human")&&e.jsxs("div",{className:"space-y-4 mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm font-medium text-gray-700",children:"âœ… Message si validÃ©"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Ce message sera envoyÃ© automatiquement dans le chat quand le commercial valide le formulaire"}),e.jsx(Ae,{value:l.approvalMessage||"Merci ! Votre formulaire a Ã©tÃ© validÃ©.",onChange:a=>n("approvalMessage",a.target.value),placeholder:"Merci ! Votre formulaire a Ã©tÃ© validÃ©.",className:"min-h-[60px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm font-medium text-gray-700",children:"âŒ Message si rejetÃ©"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Message prÃ©dÃ©fini affichÃ© au commercial. Il pourra ajouter sa raison de refus avant d'envoyer dans le chat."}),e.jsx(Ae,{value:l.rejectionMessage||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :",onChange:a=>n("rejectionMessage",a.target.value),placeholder:"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :",className:"min-h-[60px]"})]})]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx(h,{className:"text-sm font-medium text-gray-700",children:"Checklist de tÃ¢ches pour le commercial"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Liste des tÃ¢ches Ã  effectuer manuellement pour cette action"}),e.jsx("div",{className:"space-y-2",children:(l.checklist||[]).map((a,E)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:a.text,onChange:N=>g(E,N.target.value),placeholder:"Ex: VÃ©rifier le document",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>S(E),className:"h-8 w-8",children:e.jsx(ee,{className:"h-4 w-4 text-red-500"})})]},a.id))}),e.jsxs(x,{variant:"outline",size:"sm",onClick:j,className:"w-full border-dashed",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"})," Ajouter une tÃ¢che"]})]})]})},dt=({open:l,onOpenChange:I,onSave:P,existingPrompt:C})=>{var o;const{projectsData:n,forms:j}=je(),[g,S]=c.useState({name:"",tone:"",projectId:null,stepsConfig:{}}),[a,E]=c.useState(null);c.useEffect(()=>{S(C?JSON.parse(JSON.stringify(C)):{name:"",tone:"",projectId:null,stepsConfig:{}})},[C,l]);const N=c.useMemo(()=>Object.values(n).map(r=>({value:r.type,label:r.title})),[n]),M=c.useMemo(()=>{var r;return g.projectId?((r=n[g.projectId])==null?void 0:r.steps)||[]:[]},[g.projectId,n]),p=r=>{S(d=>({...d,projectId:r,stepsConfig:{}})),E(null)},i=r=>{E(a===r?null:r)},_=(r,d,y)=>{const D={...g.stepsConfig};D[r]||(D[r]={actions:[],autoCompleteStep:!1}),D[r].actions[d]=y,S(H=>({...H,stepsConfig:D}))},$=r=>{const d={...g.stepsConfig};d[r]||(d[r]={actions:[],autoCompleteStep:!1}),d[r].actions.push({id:`action-${Date.now()}`,message:"",type:"none",hasClientAction:!0}),S(y=>({...y,stepsConfig:d}))},m=(r,d)=>{const y={...g.stepsConfig};y[r]&&y[r].actions.splice(d,1),S(D=>({...D,stepsConfig:y}))},v=(r,d,y)=>{const D={...g.stepsConfig};D[r]||(D[r]={actions:[],autoCompleteStep:!1}),D[r][d]=y,S(H=>({...H,stepsConfig:D}))},f=()=>{if(!g.name||!g.tone||!g.projectId){w({title:"Champs manquants",description:"Veuillez remplir le nom, le ton et le projet.",variant:"destructive"});return}P({...g,id:(C==null?void 0:C.id)||`prompt-${Date.now()}`}),I(!1)};return e.jsx(W,{open:l,onOpenChange:I,children:e.jsxs(Q,{className:"sm:max-w-3xl",children:[e.jsxs(Y,{children:[e.jsx(Z,{children:C?"Modifier le prompt":"CrÃ©er un nouveau prompt"}),e.jsx(le,{children:"ParamÃ©trez votre prompt pour gÃ©nÃ©rer des communications personnalisÃ©es."})]}),e.jsxs("div",{className:"p-6 space-y-6 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"prompt-name",children:"Nom du prompt"}),e.jsx(O,{id:"prompt-name",placeholder:"Ex: Relance aprÃ¨s RDV",value:g.name,onChange:r=>S(d=>({...d,name:r.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"prompt-tone",children:"Ton"}),e.jsxs(F,{value:g.tone,onValueChange:r=>S(d=>({...d,tone:r})),children:[e.jsx(L,{id:"prompt-tone",children:e.jsx(U,{placeholder:"Choisir un ton"})}),e.jsxs(q,{children:[e.jsx(b,{value:"professionnel",children:"Professionnel"}),e.jsx(b,{value:"detendu",children:"DÃ©tendu"}),e.jsx(b,{value:"humain",children:"Humain"})]})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"prompt-project",children:"Projet"}),e.jsxs(F,{value:g.projectId,onValueChange:p,children:[e.jsx(L,{id:"prompt-project",children:e.jsx(U,{placeholder:"Choisir un projet"})}),e.jsx(q,{children:N.map(r=>e.jsx(b,{value:r.value,children:r.label},r.value))})]})]})]}),g.projectId&&e.jsxs(G.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"pt-4 border-t",children:[e.jsxs("h4",{className:"font-semibold text-gray-700 mb-3",children:['Ã‰tapes du projet "',(o=n[g.projectId])==null?void 0:o.title,'"']}),e.jsx("div",{className:"space-y-2",children:M.map((r,d)=>{var y,D;return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>i(d),className:"w-full flex items-center justify-between gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-lg",children:r.icon}),e.jsx("span",{className:"text-sm font-medium text-gray-800",children:r.name})]}),a===d?e.jsx(Fs,{className:"h-5 w-5"}):e.jsx(Ka,{className:"h-5 w-5"})]}),e.jsx(os,{children:a===d&&e.jsx(G.div,{initial:{opacity:0,height:0,marginTop:0},animate:{opacity:1,height:"auto",marginTop:"0.5rem"},exit:{opacity:0,height:0,marginTop:0},className:"pl-8 bg-gray-50/50 rounded-b-md",children:e.jsxs("div",{className:"p-4 space-y-4",children:[(((y=g.stepsConfig[d])==null?void 0:y.actions)||[]).map((H,T)=>e.jsx(ct,{action:H,onChange:ve=>_(d,T,ve),onDelete:()=>m(d,T),forms:j},H.id)),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>$(d),className:"w-full border-dashed",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"})," Ajouter un message + action"]}),e.jsxs("div",{className:"flex items-center space-x-2 pt-4 border-t mt-4",children:[e.jsx(hs,{id:`form-complete-step-${d}`,checked:((D=g.stepsConfig[d])==null?void 0:D.autoCompleteStep)||!1,onCheckedChange:H=>v(d,"autoCompleteStep",H)}),e.jsx(h,{htmlFor:`form-complete-step-${d}`,className:"text-sm text-gray-600",children:"Si action validÃ©e, passer automatiquement Ã  l'Ã©tape suivante"})]})]})})})]},d)})})]})]}),e.jsxs(X,{children:[e.jsx(x,{variant:"outline",onClick:()=>I(!1),children:"Annuler"}),e.jsx(x,{onClick:f,className:"bg-green-600 hover:bg-green-700",children:"Enregistrer le prompt"})]})]})})},gt=()=>{const{projectsData:l,setProjectsData:I,deleteProjectTemplate:P,prompts:C,formContactConfig:n,setFormContactConfig:j,globalPipelineSteps:g=[],setGlobalPipelineSteps:S,activeAdminUser:a,setActiveAdminUser:E,companyLogo:N,setCompanyLogo:M,removeLogo:p}=je(),{organizationId:i}=Fa(),{forms:_,loading:$,saveForm:m,deleteForm:v}=La(i),f=c.useMemo(()=>_,[_]),{prompts:o,loading:r,savePrompt:d,deletePrompt:y}=Ua({organizationId:i});c.useMemo(()=>o,[o]);const{templates:D,loading:H,createTemplate:T,updateTemplate:ve,deactivateTemplate:Pe}=qa(i),{users:oe,loading:mt,addUser:qs,updateUser:fe,deleteUser:Vs}=Xa(i),be=c.useMemo(()=>oe.reduce((s,t)=>{if(!t.user_id)return s;let u=null;if(t.manager_id){const k=oe.find(B=>B.user_id===t.manager_id);u=k?k.name:t.manager_id}return s[t.user_id]={id:t.id,user_id:t.user_id,name:t.name,email:t.email,role:t.role,phone:t.phone,avatarUrl:t.avatar_url,manager:u,accessRights:t.access_rights},s},{}),[oe]),[Gs,us]=c.useState(!1),[Hs,ps]=c.useState(!1),[Bs,Ne]=c.useState(!1),[Js,Oe]=c.useState(!1),[Ks,pe]=c.useState(!1),[A,ce]=c.useState(null),[se,De]=c.useState({name:"",email:"",password:""}),[ye,Ws]=c.useState(""),[ze,xs]=c.useState(""),[Me,gs]=c.useState(""),[Re,$e]=c.useState({modules:[],users:[]}),[Qs,Ys]=c.useState(!1),[de,Te]=c.useState(null),[we,js]=c.useState(""),[vs,fs]=c.useState(!1),[J,Ce]=c.useState(null),[Zs,Xs]=c.useState(null),[ea,bs]=c.useState(!1),[R,me]=c.useState(null),[sa,Fe]=c.useState(!1),[he,aa]=c.useState(""),[ht,ta]=c.useState({coverImage:"",clientDescription:"",ctaText:""});c.useRef(null);const[te,Ns]=c.useState({name:"",email:"",phone:"",role:""}),[K,ys]=c.useState({name:"",email:"",role:"commercial",manager:""}),[ra,Se]=c.useState(!1),[Le,Ue]=c.useState(null),[qe,ws]=c.useState(""),[na,Cs]=c.useState(!1),[Ve,Ss]=c.useState(null),[ks,Ge]=c.useState(""),xe=c.useRef(null),re=s=>{typeof S=="function"&&S(s)},la=(a==null?void 0:a.role)==="Global Admin",ia=(a==null?void 0:a.role)==="platform_admin",ge=la||ia,oa=(a==null?void 0:a.role)==="Admin",_s=!!(a!=null&&a.organization_id);c.useEffect(()=>{a&&Ns({name:a.name||"",email:a.email||"",phone:a.phone||"",role:a.role||""})},[a]),c.useEffect(()=>{(async()=>{if(i)try{const{data:t,error:u}=await V.from("organizations").select("name").eq("id",i).single();if(u)throw u;t!=null&&t.name&&js(t.name)}catch(t){z.error("Erreur chargement nom organisation",{error:t.message})}})()},[i]),c.useEffect(()=>{if(J!=null&&J.id&&f[J.id]){const s=f[J.id];s.updatedAt!==J.updatedAt&&Ce(s)}},[f]);const ca=s=>{if(!s.destination)return;const t=Array.from(n),[u]=t.splice(s.source.index,1);t.splice(s.destination.index,0,u),j(t)},Es=s=>{Ue(s),Se(!0)},da=s=>{let t;Le?t=n.map(u=>u.id===s.id?s:u):t=[...n,s],j(t),Se(!1),Ue(null)},ma=s=>{const t=n.filter(u=>u.id!==s);j(t)},As=()=>{const s=Ie(qe);if(!s){w({title:"Nom d'Ã©tape requis",description:"Ajoutez un libellÃ© avant d'enregistrer une Ã©tape.",variant:"destructive"});return}if(g.some(u=>u.label===s)){w({title:"Ã‰tape dÃ©jÃ  prÃ©sente",description:"Ce type d'Ã©tape figure dÃ©jÃ  dans votre liste globale.",variant:"destructive"});return}const t=Ls(s,g.length);re(u=>[...u,st(s,null,t)]),ws(""),w({title:"Ã‰tape ajoutÃ©e",description:`${s} est dÃ©sormais disponible pour vos pipelines globales.`})},ha=c.useCallback(s=>{re(t=>{const u=t.find(B=>B.id===s),k=t.filter(B=>B.id!==s);return u&&w({title:"Ã‰tape retirÃ©e",description:`${u.label} a Ã©tÃ© supprimÃ©e de la liste globale.`}),k})},[re]),ua=c.useCallback((s,t)=>{t&&re(u=>u.map(k=>k.id===s?{...k,color:t}:k))},[re]),pa=c.useCallback(s=>{Ss(s.id),Ge(s.label),Cs(!0)},[]),He=s=>{Cs(s),s||(Ss(null),Ge(""))},Is=()=>{if(!Ve)return;const s=Ie(ks);if(!s){w({title:"Nom d'Ã©tape requis",description:"Le libellÃ© ne peut pas Ãªtre vide.",variant:"destructive"});return}if(g.some(t=>t.id!==Ve&&t.label===s)){w({title:"Ã‰tape dÃ©jÃ  prÃ©sente",description:"Un autre type d'Ã©tape porte dÃ©jÃ  ce nom.",variant:"destructive"});return}re(t=>t.map(u=>u.id===Ve?{...u,label:s}:u)),He(!1),w({title:"Ã‰tape mise Ã  jour",description:`${s} remplacera dÃ©sormais l'ancien libellÃ©.`})},xa=c.useCallback(s=>{s.destination&&re(t=>{const u=Array.from(t),[k]=u.splice(s.source.index,1);return u.splice(s.destination.index,0,k),u})},[re]),ke=c.useMemo(()=>Object.values(l).map(s=>({value:s.type,label:s.title})),[l]);c.useEffect(()=>{ke.length>0&&!he&&aa(ke[0].value)},[ke,he]),c.useEffect(()=>{if(he&&l[he]){const s=l[he];ta({coverImage:s.coverImage||"",clientDescription:s.clientDescription||"",ctaText:s.ctaText||""})}},[he,l]);const Ps=s=>{const{name:t,value:u}=s.target;Ns(k=>({...k,[t]:u}))},ga=async()=>{if(a)try{const s=oe.find(t=>t.id===a.id||t.user_id===a.user_id);if(!s)throw new Error("Utilisateur non trouvÃ©");await fe(s.id,te)}catch(s){z.error("Erreur sauvegarde modifications",{error:s.message}),w({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"})}},ja=s=>{w({title:`ðŸš§ ${s}`,description:"Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e. Demandez-la dans votre prochain prompt ! ðŸš€"})},va=async()=>{localStorage.removeItem("activeAdminUser"),V.auth.signOut(),window.location.href="/"},ie=s=>{const t=document.getElementById(s);t&&t.scrollIntoView({behavior:"smooth",block:"start"})},fa=s=>{ce(s),gs(s.role.toLowerCase()),xs(s.manager||"none"),Oe(!0)},ba=s=>{ce(s);const t=s.role==="Admin"||s.role==="Global Admin",u=Object.values(be).filter(B=>B.user_id!==s.user_id).map(B=>({value:B.user_id,label:B.name}));let k=s.accessRights;if(k||(k={modules:["Pipeline","Agenda","Contacts"],users:[]}),t)$e({modules:["Pipeline","Agenda","Contacts"],users:u});else{const Be=((k==null?void 0:k.users)||[]).map($a=>{const Je=be[$a];return Je?{value:Je.user_id,label:Je.name}:null}).filter(Boolean);$e({modules:k.modules||["Pipeline","Agenda","Contacts"],users:Be})}pe(!0)},Na=async()=>{if(!A||A.role==="Admin"||A.role==="Global Admin"){pe(!1);return}try{await fe(A.id,{accessRights:{modules:Re.modules,users:Re.users.map(s=>s.value)}}),pe(!1),ce(null)}catch(s){z.error("Erreur sauvegarde droits accÃ¨s",{error:s.message})}},ya=async()=>{if(A)try{const t={admin:"Global Admin",manager:"Manager",commercial:"Commercial"}[Me]||Me;await fe(A.id,{role:t,manager:ze==="none"?"":ze}),Oe(!1),ce(null)}catch(s){z.error("Erreur changement rÃ´le",{error:s.message})}},wa=async s=>{try{await Vs(s.id)}catch(t){z.error("Erreur suppression utilisateur",{error:t.message})}},Ca=s=>{if(!(s!=null&&s.id))return;const t=oe.find(k=>k.id===s.id||k.user_id===s.user_id);if(!(t!=null&&t.affiliate_slug)){w({title:"Erreur",description:"Ce commercial n'a pas de lien d'affiliation (affiliate_slug manquant).",variant:"destructive"});return}const u=`${window.location.origin}/inscription/${t.affiliate_slug}`;navigator.clipboard.writeText(u).then(()=>{w({title:"Lien d'affiliation copiÃ© !",description:"Envoyez-le Ã  votre client pour qu'il s'inscrive avec votre affiliation.",className:"bg-green-500 text-white"})}).catch(()=>{w({title:"Impossible de copier le lien",description:"Copiez-le manuellement : "+u,variant:"destructive"})})},Os=async s=>{const t={...l,[s.type]:s};try{await I(t),w({title:"Projet enregistrÃ© !",description:`Le projet "${s.title}" a Ã©tÃ© sauvegardÃ©.`,className:"bg-green-500 text-white"}),Te(null)}catch{w({title:"Erreur !",description:"Impossible de sauvegarder le projet.",variant:"destructive"})}},Sa=async()=>{if(!we.trim()){w({title:"Nom manquant",description:"Veuillez entrer un nom pour votre entreprise.",variant:"destructive"});return}try{fs(!0);const{error:s}=await V.from("organizations").update({name:we.trim()}).eq("id",i);if(s)throw s;const{error:t}=await V.from("organization_settings").upsert({organization_id:i,display_name:we.trim(),updated_at:new Date().toISOString()},{onConflict:"organization_id"});t?z.warn("Sync display_name vers organization_settings Ã©chouÃ©:",{error:t.message}):z.info("Nom synchronisÃ© vers organization_settings.display_name"),w({title:"âœ… Nom mis Ã  jour !",description:"Le nom de votre entreprise a Ã©tÃ© modifiÃ©.",className:"bg-green-500 text-white"})}catch(s){z.error("Erreur mise Ã  jour nom organisation",{error:s.message}),w({title:"Erreur",description:s.message||"Impossible de mettre Ã  jour le nom.",variant:"destructive"})}finally{fs(!1)}},ka=async s=>{var u;const t=(u=s.target.files)==null?void 0:u[0];if(t){const k=new FileReader;k.onloadend=async()=>{try{await M(k.result)}catch(B){z.error("Erreur upload logo",{error:B.message})}},k.readAsDataURL(t)}},_a=async()=>{try{await p(),xe.current&&(xe.current.value=""),setIsLogoMenuOpen(!1)}catch(s){z.error("Erreur suppression logo",{error:s.message})}},Ea=async s=>{const t=s.id||`form-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,u=await m(t,{name:s.name,fields:s.fields||[],projectIds:s.projectIds||[],audience:s.audience||"client"});u.success?(w({title:"âœ… Formulaire enregistrÃ© !",description:`Le formulaire "${s.name}" a Ã©tÃ© sauvegardÃ© dans Supabase.`,className:"bg-green-500 text-white"}),Ce(null)):w({title:"âŒ Erreur",description:`Impossible d'enregistrer le formulaire : ${u.error}`,variant:"destructive"})},Aa=async s=>{const t=s.id||`prompt-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,u=await d(t,{name:s.name,tone:s.tone,projectId:s.projectId,stepsConfig:s.stepsConfig||{}});u.success?(w({title:"âœ… Prompt enregistrÃ© !",description:`Le prompt "${s.name}" a Ã©tÃ© sauvegardÃ© dans Supabase.`,className:"bg-green-500 text-white"}),Xs(null),bs(!1)):w({title:"âŒ Erreur",description:`Impossible d'enregistrer le prompt : ${u.error}`,variant:"destructive"})},Ia=async s=>{const u=!s.id?await T({name:s.name,projectType:s.projectType||"ACC",contentHtml:s.contentHtml||""}):await ve(s.id,{name:s.name,projectType:s.projectType,contentHtml:s.contentHtml});u.success?(w({title:"âœ… Template enregistrÃ© !",description:`Le template "${s.name}" a Ã©tÃ© sauvegardÃ©.`,className:"bg-green-500 text-white"}),me(null)):w({title:"âŒ Erreur",description:`Impossible d'enregistrer le template : ${u.error}`,variant:"destructive"})},ue=c.useMemo(()=>Object.values(be),[be]),Ds=c.useMemo(()=>ue.filter(s=>s.role==="Manager"||s.role==="Admin"),[ue]),zs=c.useMemo(()=>[{value:"none",label:"Personne"},...Ds.map(s=>({value:s.name,label:s.name}))],[Ds]),Pa=c.useMemo(()=>ue.filter(s=>s.user_id!==(A==null?void 0:A.user_id)).map(s=>({value:s.user_id,label:s.name})),[ue,A]),Oa=c.useMemo(()=>ue.filter(s=>s.name.toLowerCase().includes(ye.toLowerCase())||s.email.toLowerCase().includes(ye.toLowerCase())).slice(0,5),[ue,ye]),_e=(s,t)=>{ys(u=>({...u,[s]:t}))},Da=async()=>{try{if(!K.name||!K.email){w({title:"Champs manquants",description:"Veuillez remplir le nom et l'email.",variant:"destructive"});return}const s=a==null?void 0:a.organization_id;if(!s)throw new Error("Organization non chargÃ©e â€” invitation bloquÃ©e");await qs({name:K.name,email:K.email,role:K.role.charAt(0).toUpperCase()+K.role.slice(1),manager:K.manager==="none"?"":K.manager,phone:K.phone||"",organizationId:s,accessRights:{modules:["Pipeline","Agenda","Contacts"],users:[]}}),ps(!1),ys({name:"",email:"",role:"commercial",manager:""})}catch(s){z.error("[InviteUser] error:",s),w({title:"Invitation impossible",description:(s==null?void 0:s.message)||"Erreur inconnue",variant:"destructive"})}},za=s=>{ce(s),De({name:s.name||"",email:s.email||"",password:""}),Ne(!0)},Ms=(s,t)=>{De(u=>({...u,[s]:t}))},Ma=async()=>{if(A){if(!se.name||!se.email){w({title:"Champs manquants",description:"Le nom et l'email sont obligatoires.",variant:"destructive"});return}try{const s={name:se.name};if(se.email!==A.email){const{data:t,error:u}=await V.rpc("admin_update_user_email",{target_user_id:A.user_id,new_email:se.email});if(u)throw new Error(`Erreur changement email: ${u.message}`);w({title:"Email modifiÃ© !",description:`L'email de connexion a Ã©tÃ© changÃ© en ${se.email}. L'utilisateur peut maintenant se connecter avec cette adresse.`,className:"bg-green-500 text-white",duration:6e3}),s.email=se.email}se.email===A.email&&(s.email=se.email),await fe(A.id,s),Ne(!1),ce(null),De({name:"",email:"",password:""})}catch(s){z.error("Erreur modification utilisateur",{error:s.message}),w({title:"Erreur",description:s.message||"Impossible de modifier l'utilisateur.",variant:"destructive"})}}},Ra={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},ne={hidden:{y:20,opacity:0},visible:{y:0,opacity:1,transition:{type:"spring",stiffness:100}}},Ee=(A==null?void 0:A.role)==="Admin"||(A==null?void 0:A.role)==="Global Admin";return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
          html {
            scroll-behavior: smooth;
            scroll-padding-top: 100px;
          }
        `}),e.jsxs("div",{className:"flex min-h-screen",children:[e.jsxs("div",{className:"hidden md:block w-60 bg-white shadow-lg rounded-2xl mr-6 p-6 h-fit sticky top-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-6",children:"Navigation"}),e.jsxs("nav",{className:"space-y-2",children:[e.jsx("button",{type:"button",onClick:()=>ie("info-perso"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Info perso"}),ge&&e.jsx("button",{type:"button",onClick:()=>ie("logo-entreprise"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Logo Entreprise"}),ge&&e.jsx("button",{type:"button",onClick:()=>ie("info-entreprise"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Informations de l'entreprise"}),e.jsx("button",{type:"button",onClick:()=>ie("gestion-formulaire-contact"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Gestion du Formulaire Contact"}),e.jsx("button",{type:"button",onClick:()=>ie("gestion-pipelines-globales"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Gestion des Pipelines Globales"}),e.jsx("button",{type:"button",onClick:()=>ie("gestion-utilisateurs"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Gestion des utilisateurs"}),e.jsx("button",{type:"button",onClick:()=>ie("gestion-clients"),className:"block w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:"Gestion des clients"})]})]}),e.jsx("div",{className:"flex-1",children:e.jsxs(G.div,{className:"max-w-5xl mx-auto space-y-8",variants:Ra,initial:"hidden",animate:"visible",children:[e.jsx(G.h1,{variants:ne,className:"text-3xl font-bold text-gray-900",children:"Mon Profil"}),e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"info-perso",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-6",children:"Informations personnelles"}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"nom",children:"Nom"}),e.jsx(O,{id:"nom",name:"name",value:te.name,onChange:Ps})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"email",children:"Email de connexion"}),e.jsx(O,{id:"email",name:"email",type:"email",value:te.email,disabled:!0,className:"bg-gray-100 cursor-not-allowed"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1 flex items-center gap-1",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),"Pour changer votre email de connexion, contactez un Global Admin"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"phone",children:"TÃ©lÃ©phone"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(Va,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx(O,{id:"phone",name:"phone",type:"tel",value:te.phone,onChange:Ps,className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"role",children:"RÃ´le"}),e.jsx(O,{id:"role",name:"role",value:te.role==="Admin"?"Admin":te.role==="Global Admin"?"Admin Global (tous les droits)":te.role,disabled:!0,className:"bg-gray-100"})]})]})]}),(()=>{const s=oe.find(k=>k.user_id===(a==null?void 0:a.id)||k.email===te.email),t=s==null?void 0:s.affiliate_slug,u=t?`${window.location.origin}/inscription/${t}`:null;return u?e.jsx("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl",children:e.jsx("div",{className:"flex items-start justify-between gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs(h,{className:"text-blue-900 font-semibold mb-2 flex items-center gap-2",children:[e.jsx(Ke,{className:"h-4 w-4"}),"Votre lien d'affiliation personnel"]}),e.jsx("p",{className:"text-xs text-blue-700 mb-3",children:"Partagez ce lien avec vos clients. Quand ils s'inscrivent via ce lien, ils vous seront automatiquement attribuÃ©s."}),e.jsxs("div",{className:"flex items-center gap-2 bg-white p-3 rounded-lg border border-blue-300",children:[e.jsx(O,{value:u,readOnly:!0,className:"flex-1 font-mono text-sm bg-transparent border-none focus:ring-0 cursor-pointer select-all",onClick:k=>k.target.select()}),e.jsxs(x,{type:"button",size:"sm",variant:"outline",onClick:()=>{navigator.clipboard.writeText(u).then(()=>{w({title:"âœ… Lien copiÃ© !",description:"Le lien d'affiliation a Ã©tÃ© copiÃ© dans votre presse-papiers.",className:"bg-green-500 text-white"})}).catch(()=>{w({title:"Erreur",description:"Impossible de copier le lien automatiquement. Copiez-le manuellement.",variant:"destructive"})})},className:"shrink-0 bg-blue-600 hover:bg-blue-700 text-white border-none",children:[e.jsx(Ke,{className:"h-4 w-4 mr-1"}),"Copier"]})]})]})})}):null})(),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6",children:[e.jsxs(W,{open:Gs,onOpenChange:us,children:[e.jsx(Rs,{asChild:!0,children:e.jsxs(x,{variant:"outline",children:[e.jsx(cs,{className:"mr-2 h-4 w-4"}),"Changer le mot de passe"]})}),e.jsxs(Q,{children:[e.jsx(Y,{children:e.jsx(Z,{children:"Changer le mot de passe"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"old-password",children:"Ancien mot de passe"}),e.jsx(O,{id:"old-password",type:"password"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"new-password",children:"Nouveau mot de passe"}),e.jsx(O,{id:"new-password",type:"password"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"confirm-password",children:"Confirmation du nouveau mot de passe"}),e.jsx(O,{id:"confirm-password",type:"password"})]})]}),e.jsx(X,{children:e.jsx(x,{onClick:()=>{ja("Validation mot de passe"),us(!1)},className:"bg-green-600 hover:bg-green-700",children:"Valider"})})]})]}),e.jsxs(We,{children:[e.jsx(Qe,{asChild:!0,children:e.jsxs(x,{variant:"destructive",children:[e.jsx(Ga,{className:"mr-2 h-4 w-4"}),"Se dÃ©connecter"]})}),e.jsxs(Ye,{children:[e.jsxs(Ze,{children:[e.jsx(Xe,{children:"Confirmer la dÃ©connexion"}),e.jsx(es,{children:"ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter de l'espace admin ?"})]}),e.jsxs(ss,{children:[e.jsx(as,{children:"Annuler"}),e.jsx(ts,{onClick:va,className:"bg-red-600 hover:bg-red-700",children:"Se dÃ©connecter"})]})]})]}),e.jsx(x,{onClick:ga,className:"bg-green-600 hover:bg-green-700",children:"Enregistrer les modifications"})]})]}),(oa||ge)&&e.jsxs(e.Fragment,{children:[ge&&e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"logo-entreprise",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"ðŸ¢ Logo Entreprise"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Ce logo sera affichÃ© dans l'espace client"})]})}),e.jsxs("div",{className:"space-y-4",children:[N&&(N.startsWith("data:")||N.startsWith("http"))?e.jsxs("div",{className:"flex flex-col items-center gap-4 p-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300",children:[e.jsx("img",{src:N,alt:"Logo de l'entreprise",className:"max-w-xs max-h-48 object-contain rounded-lg shadow-md",onError:s=>{z.error("Erreur chargement image",{url:N}),s.target.style.display="none"}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{variant:"outline",onClick:()=>{var s;return(s=xe.current)==null?void 0:s.click()},className:"flex items-center gap-2",children:[e.jsx(Ha,{className:"h-4 w-4"}),"Remplacer"]}),e.jsxs(x,{variant:"destructive",onClick:_a,className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Supprimer"]})]})]}):e.jsxs("div",{onClick:()=>{var s;return(s=xe.current)==null?void 0:s.click()},className:"flex flex-col items-center justify-center gap-3 p-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all",children:[e.jsx(Ba,{className:"h-12 w-12 text-gray-400"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Cliquez pour tÃ©lÃ©charger un logo"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PNG, JPG ou SVG (max. 2MB)"})]})]}),e.jsx("input",{ref:xe,type:"file",accept:"image/*",onChange:ka,className:"hidden"})]})]}),ge&&e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"info-entreprise",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"ðŸ¢ Informations de l'entreprise"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Modifiez le nom de votre entreprise"})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(h,{htmlFor:"org-name",children:"Nom de l'entreprise"}),e.jsxs("div",{className:"flex gap-3 mt-1",children:[e.jsx(O,{id:"org-name",value:we,onChange:s=>js(s.target.value),placeholder:"Nom de votre entreprise",className:"flex-1"}),e.jsx(x,{onClick:Sa,disabled:vs,className:"bg-green-600 hover:bg-green-700",children:vs?"Enregistrement...":"Enregistrer"})]})]})})]}),e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"gestion-formulaire-contact",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:"ðŸ§© Gestion du Formulaire Contact"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Ajoutez, modifiez et rÃ©organisez les champs du formulaire de crÃ©ation de contact."})]}),e.jsxs(x,{onClick:()=>Es(null),children:[e.jsx(ae,{className:"mr-2 h-4 w-4"})," Ajouter un champ"]})]}),e.jsx(ns,{onDragEnd:ca,children:e.jsx(ls,{droppableId:"form-fields",children:s=>e.jsxs("div",{...s.droppableProps,ref:s.innerRef,className:"space-y-3",children:[n.map((t,u)=>e.jsx(is,{draggableId:t.id,index:u,children:k=>e.jsxs("div",{ref:k.innerRef,...k.draggableProps,className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border",children:[e.jsx("div",{...k.dragHandleProps,className:"cursor-grab text-gray-400",children:e.jsx(ms,{})}),e.jsxs("div",{className:"flex-grow",children:[e.jsxs("p",{className:"font-medium",children:[t.name,t.required&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Type: ",t.type," | Placeholder: ",t.placeholder||"Aucun",t.type==="select"&&t.options&&t.options.length>0&&e.jsxs("span",{className:"ml-2 text-blue-600",children:["(",t.options.length," option",t.options.length>1?"s":"",": ",t.options.join(", "),")"]})]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>Es(t),children:e.jsx(cs,{className:"h-4 w-4"})}),e.jsxs(We,{children:[e.jsx(Qe,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",children:e.jsx(ee,{className:"h-4 w-4 text-red-500"})})}),e.jsxs(Ye,{children:[e.jsxs(Ze,{children:[e.jsxs(Xe,{children:['Supprimer le champ "',t.name,'" ?']}),e.jsx(es,{children:"Cette action est irrÃ©versible."})]}),e.jsxs(ss,{children:[e.jsx(as,{children:"Annuler"}),e.jsx(ts,{onClick:()=>ma(t.id),className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]})]})},t.id)),s.placeholder]})})})]}),e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"gestion-pipelines-globales",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:"ðŸ› ï¸ Gestion des Pipelines Globales"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Visualisez et organisez les variantes de pipeline auxquelles lâ€™Ã©quipe pourra accÃ©der prochainement."})]})}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-sm",children:[e.jsx(h,{htmlFor:"new-pipeline-step",className:"text-gray-700 font-medium",children:"Ajouter un type d'Ã©tape"}),e.jsxs("div",{className:"mt-3 flex flex-col sm:flex-row gap-3",children:[e.jsx(O,{id:"new-pipeline-step",value:qe,onChange:s=>ws(s.target.value.toUpperCase()),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),As())},placeholder:"Ex. MARKET, ETUDE, OFFRE...",className:"uppercase tracking-wide"}),e.jsxs(x,{type:"button",onClick:As,disabled:!qe.trim(),className:"w-full sm:w-auto",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"})," Ajouter"]})]}),e.jsx("div",{className:"mt-4",children:g.length>0?e.jsx(ns,{onDragEnd:xa,children:e.jsx(ls,{droppableId:"global-pipeline-steps",children:s=>e.jsxs("div",{ref:s.innerRef,...s.droppableProps,className:"space-y-2",children:[g.map((t,u)=>e.jsx(is,{draggableId:t.id,index:u,children:(k,B)=>e.jsx(nt,{step:t,index:u,provided:k,snapshot:B,onColorChange:Be=>ua(t.id,Be),onEdit:()=>pa(t),onRemove:()=>ha(t.id)})},t.id)),s.placeholder]})})}):e.jsx("p",{className:"text-sm text-gray-500",children:"Aucune Ã©tape dÃ©finie pour le moment. Ajoutez-en pour structurer vos pipelines globaux."})})]})})]}),e.jsx(W,{open:na,onOpenChange:He,children:e.jsxs(Q,{children:[e.jsxs(Y,{children:[e.jsx(Z,{children:"Renommer le type d'Ã©tape"}),e.jsx(le,{children:"Personnalisez le libellÃ© affichÃ© pour cette Ã©tape globale. Utilisez un intitulÃ© court et explicite (ex. OFFRE, CLOTURE, RELANCE)."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(h,{htmlFor:"pipeline-step-draft",children:"LibellÃ© de l'Ã©tape"}),e.jsx(O,{id:"pipeline-step-draft",value:ks,onChange:s=>Ge(s.target.value.toUpperCase()),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),Is())},placeholder:"Ex. CLOTURE",className:"uppercase tracking-wide"})]}),e.jsxs(X,{children:[e.jsx(x,{variant:"outline",onClick:()=>He(!1),children:"Annuler"}),e.jsx(x,{onClick:Is,className:"bg-blue-600 hover:bg-blue-700",children:"Enregistrer"})]})]})}),e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"gestion-utilisateurs",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Gestion des utilisateurs"}),e.jsxs(W,{open:Hs,onOpenChange:ps,children:[e.jsx(Rs,{asChild:!0,children:e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700 w-full sm:w-auto",children:"Inviter un utilisateur"})}),e.jsxs(Q,{className:"sm:max-w-[425px]",children:[e.jsxs(Y,{children:[e.jsx(Z,{children:"Inviter un nouvel utilisateur"}),e.jsx(le,{children:"L'utilisateur recevra un email pour crÃ©er son mot de passe et activer son compte."})]}),e.jsxs("div",{className:"grid gap-4 py-4 px-6",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"invite-nom",className:"text-right col-span-1",children:"Nom"}),e.jsx(O,{id:"invite-nom",className:"col-span-3",value:K.name,onChange:s=>_e("name",s.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"invite-email",className:"text-right col-span-1",children:"Email"}),e.jsx(O,{id:"invite-email",type:"email",className:"col-span-3",value:K.email,onChange:s=>_e("email",s.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"invite-role",className:"text-right col-span-1",children:"RÃ´le"}),e.jsxs(F,{value:K.role,onValueChange:s=>_e("role",s),children:[e.jsx(L,{id:"invite-role",className:"col-span-3",children:e.jsx(U,{placeholder:"Commercial"})}),e.jsxs(q,{children:[e.jsx(b,{value:"admin",children:"Admin"}),e.jsx(b,{value:"manager",children:"Manager"}),e.jsx(b,{value:"commercial",children:"Commercial"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"invite-manager",className:"text-right col-span-1",children:"Manager"}),e.jsx("div",{className:"col-span-3",children:e.jsx($s,{options:zs,value:K.manager,onSelect:s=>_e("manager",s),placeholder:"SÃ©lectionner...",searchPlaceholder:"Rechercher un manager...",emptyText:"Aucun manager trouvÃ©."})})]})]}),e.jsxs(X,{className:"px-6 pb-4",children:[!_s&&e.jsx("p",{className:"text-sm text-muted-foreground mr-auto",children:"Chargement de l'organisationâ€¦"}),e.jsx(x,{onClick:Da,disabled:!_s,className:"bg-blue-600 hover:bg-blue-700",children:"Envoyer une invitation"})]})]})]})]}),e.jsx(W,{open:Bs,onOpenChange:Ne,children:e.jsxs(Q,{className:"sm:max-w-[500px]",children:[e.jsxs(Y,{children:[e.jsx(Z,{children:"Modifier l'utilisateur"}),e.jsxs(le,{children:["Modifiez le nom de ",A==null?void 0:A.name]})]}),e.jsxs("div",{className:"grid gap-4 py-4 px-6",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"edit-nom",className:"text-right col-span-1",children:"Nom"}),e.jsx(O,{id:"edit-nom",className:"col-span-3",value:se.name,onChange:s=>Ms("name",s.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"edit-email",className:"text-right col-span-1",children:"Email"}),e.jsxs("div",{className:"col-span-3 space-y-1",children:[e.jsx(O,{id:"edit-email",type:"email",value:se.email,onChange:s=>Ms("email",s.target.value)}),e.jsxs("p",{className:"text-xs text-amber-600 flex items-center gap-1",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),"Attention : Changer l'email modifie l'identifiant de connexion de l'utilisateur"]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{className:"text-right col-span-1",children:"Mot de passe"}),e.jsx("div",{className:"col-span-3 space-y-1",children:e.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg",children:e.jsxs("p",{className:"text-xs text-amber-800 flex items-start gap-2",children:[e.jsx("svg",{className:"w-4 h-4 mt-0.5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:'Pour rÃ©initialiser le mot de passe de cet utilisateur, envoyez-lui un lien "Mot de passe oubliÃ©" ou demandez-lui de le faire depuis la page de connexion.'})]})})})]})]}),e.jsxs(X,{className:"px-6 pb-4",children:[e.jsx(x,{variant:"outline",onClick:()=>Ne(!1),children:"Annuler"}),e.jsx(x,{onClick:Ma,className:"bg-blue-600 hover:bg-blue-700",children:"Enregistrer"})]})]})}),e.jsx("div",{className:"mb-4",children:e.jsx(O,{type:"text",placeholder:"Rechercher par nom ou email...",value:ye,onChange:s=>Ws(s.target.value),className:"max-w-sm"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-gray-500",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Nom"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Email"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"RÃ´le"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Manager"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Actions"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Droits d'accÃ¨s"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Lien d'affiliation"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Supprimer"})]})}),e.jsx("tbody",{children:Oa.map(s=>e.jsxs("tr",{className:"bg-white border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 font-medium text-gray-900 whitespace-nowrap",children:s.name}),e.jsx("td",{className:"px-6 py-4",children:s.email}),e.jsx("td",{className:"px-6 py-4",children:s.role}),e.jsx("td",{className:"px-6 py-4",children:s.manager||"N/A"}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>za(s),children:"Modifier"}),e.jsx(x,{variant:"outline",size:"sm",onClick:()=>fa(s),disabled:s.role==="Admin"||s.role==="Global Admin",children:"Changer le rÃ´le"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>ba(s),children:"Modifier droits"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>Ca(s),children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"Copier le lien"]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs(We,{children:[e.jsx(Qe,{asChild:!0,children:e.jsx(x,{variant:"destructive",size:"icon",disabled:s.role==="Admin"||s.role==="Global Admin",children:e.jsx(ee,{className:"h-4 w-4"})})}),e.jsxs(Ye,{children:[e.jsxs(Ze,{children:[e.jsxs(Xe,{children:["Voulez-vous vraiment supprimer ",s.name," ?"]}),e.jsxs(es,{children:["Cette action est irrÃ©versible. Tous les contacts de cet utilisateur seront rÃ©assignÃ©s Ã  son manager (",s.manager||"Admin",")."]})]}),e.jsxs(ss,{children:[e.jsx(as,{children:"Annuler"}),e.jsx(ts,{onClick:()=>wa(s),className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]})})]},s.id))})]})})]}),e.jsx(W,{open:Js,onOpenChange:Oe,children:e.jsxs(Q,{className:"sm:max-w-[425px]",children:[e.jsxs(Y,{children:[e.jsxs(Z,{children:["Changer le rÃ´le de ",A==null?void 0:A.name]}),e.jsx(le,{children:"SÃ©lectionnez un nouveau rÃ´le et assignez un manager pour cet utilisateur."})]}),e.jsxs("div",{className:"grid gap-4 py-4 px-6",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"change-role-select",className:"text-right col-span-1",children:"RÃ´le"}),e.jsxs(F,{value:Me,onValueChange:gs,children:[e.jsx(L,{id:"change-role-select",className:"col-span-3",children:e.jsx(U,{placeholder:"SÃ©lectionner un rÃ´le"})}),e.jsxs(q,{children:[e.jsx(b,{value:"admin",children:"Admin"}),e.jsx(b,{value:"manager",children:"Manager"}),e.jsx(b,{value:"commercial",children:"Commercial"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(h,{htmlFor:"change-manager-select",className:"text-right col-span-1",children:"Manager"}),e.jsx("div",{className:"col-span-3",children:e.jsx($s,{options:zs.filter(s=>s.value!==(A==null?void 0:A.name)),value:ze,onSelect:xs,placeholder:"SÃ©lectionner...",searchPlaceholder:"Rechercher un manager...",emptyText:"Aucun manager trouvÃ©."})})]})]}),e.jsx(X,{className:"px-6 pb-4",children:e.jsx(x,{onClick:ya,className:"bg-green-600 hover:bg-green-700",children:"Valider"})})]})}),e.jsx(W,{open:Ks,onOpenChange:pe,children:e.jsxs(Q,{className:"sm:max-w-md",children:[e.jsxs(Y,{children:[e.jsxs(Z,{children:["Droits dâ€™accÃ¨s de ",A==null?void 0:A.name]}),Ee&&e.jsx(le,{children:"Les administrateurs ont accÃ¨s Ã  tout par dÃ©faut."})]}),e.jsx("div",{className:"space-y-6 p-6",children:e.jsxs("div",{children:[e.jsx(h,{className:"font-semibold",children:"AccÃ¨s aux donnÃ©es dâ€™autres utilisateurs"}),e.jsx(Ts,{options:Pa,selected:Re.users,onChange:s=>$e(t=>({...t,users:s})),placeholder:"SÃ©lectionner des utilisateurs...",searchPlaceholder:"Rechercher un utilisateur...",emptyText:"Aucun utilisateur trouvÃ©.",className:"mt-2",disabled:Ee,showSelectAll:!Ee,selectAllText:"Tout le monde"})]})}),e.jsxs(X,{children:[e.jsx(x,{variant:"outline",onClick:()=>pe(!1),children:"Annuler"}),e.jsx(x,{onClick:Na,disabled:Ee,children:"Enregistrer"})]})]})}),e.jsxs(G.div,{variants:ne,className:"bg-white p-6 sm:p-8 rounded-2xl shadow-card",id:"gestion-clients",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-6",children:"Gestion des clients"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-gray-500",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Nom"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Email"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Projet"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Statut"}),e.jsx("th",{scope:"col",className:"px-6 py-3",children:"Actions"})]})}),e.jsx("tbody",{children:e.jsx("tr",{className:"bg-white",children:e.jsx("td",{colSpan:"5",className:"px-6 py-10 text-center text-gray-400",children:"La gestion des clients sera bientÃ´t disponible ici."})})})]})})]})]}),e.jsx(ot,{open:Qs,onOpenChange:Ys,onSave:Os,globalPipelineSteps:g}),e.jsx(W,{open:!!de,onOpenChange:s=>!s&&Te(null),children:e.jsxs(Q,{className:"sm:max-w-2xl",children:[e.jsx(Y,{children:e.jsxs(Z,{children:['Modifier le projet "',de==null?void 0:de.title,'"']})}),e.jsx("div",{className:"p-6 max-h-[70vh] overflow-y-auto",children:de&&e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}),children:e.jsx(Us,{project:de,onSave:Os,onCancel:()=>Te(null),globalPipelineSteps:g})})})]})}),e.jsx(W,{open:!!J,onOpenChange:s=>!s&&Ce(null),children:e.jsxs(Q,{className:"sm:max-w-2xl",children:[e.jsx(Y,{children:e.jsx(Z,{children:J!=null&&J.id?`Modifier le formulaire "${J.name}"`:"CrÃ©er un nouveau formulaire"})}),e.jsx("div",{className:"p-6 max-h-[70vh] overflow-y-auto",children:J&&e.jsx(it,{form:J,onSave:Ea,onCancel:()=>Ce(null)})})]})}),e.jsx(W,{open:!!R,onOpenChange:s=>!s&&me(null),children:e.jsxs(Q,{className:"sm:max-w-3xl",children:[e.jsx(Y,{children:e.jsx(Z,{children:R!=null&&R.id?`Modifier le template "${R.name}"`:"CrÃ©er un nouveau template de contrat"})}),e.jsxs("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"template-name",children:"Nom du template"}),e.jsx(O,{id:"template-name",value:(R==null?void 0:R.name)||"",onChange:s=>me(t=>({...t,name:s.target.value})),placeholder:"Ex: Contrat ACC Standard"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"template-project-type",children:"Type de projet"}),e.jsxs(F,{value:(R==null?void 0:R.projectType)||"ACC",onValueChange:s=>me(t=>({...t,projectType:s})),children:[e.jsx(L,{id:"template-project-type",children:e.jsx(U,{placeholder:"SÃ©lectionner un type"})}),e.jsx(q,{children:ke.map(s=>e.jsx(b,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"template-content",children:"Contenu HTML"}),e.jsx(Ae,{id:"template-content",value:(R==null?void 0:R.contentHtml)||"",onChange:s=>me(t=>({...t,contentHtml:s.target.value})),placeholder:"Entrez le contenu HTML du contrat...",rows:12,className:"font-mono text-sm"})]})]}),e.jsxs(X,{className:"px-6 pb-4",children:[e.jsx(x,{variant:"outline",onClick:()=>me(null),children:"Annuler"}),e.jsx(x,{variant:"secondary",onClick:()=>Fe(!0),disabled:!(R!=null&&R.contentHtml),children:"ðŸ‘ï¸ Visualiser"}),e.jsx(x,{onClick:()=>Ia(R),className:"bg-purple-600 hover:bg-purple-700",children:"Enregistrer"})]})]})}),e.jsx(W,{open:sa,onOpenChange:Fe,children:e.jsxs(Q,{className:"sm:max-w-5xl max-h-[90vh]",children:[e.jsxs(Y,{children:[e.jsxs(Z,{children:["PrÃ©visualisation : ",(R==null?void 0:R.name)||"Template"]}),e.jsx(le,{children:"AperÃ§u du rendu HTML du template de contrat"})]}),e.jsx("div",{className:"p-6 max-h-[70vh] overflow-y-auto bg-white border rounded-lg",children:e.jsx("div",{className:"prose max-w-none",dangerouslySetInnerHTML:{__html:(R==null?void 0:R.contentHtml)||""}})}),e.jsx(X,{className:"px-6 pb-4",children:e.jsx(x,{onClick:()=>Fe(!1),children:"Fermer"})})]})}),e.jsx(dt,{open:ea,onOpenChange:bs,onSave:Aa,existingPrompt:Zs}),e.jsx(W,{open:ra,onOpenChange:Se,children:e.jsxs(Q,{children:[e.jsx(Y,{children:e.jsx(Z,{children:Le?"Modifier le champ":"Ajouter un champ"})}),e.jsx(lt,{field:Le,onSave:da,onCancel:()=>{Se(!1),Ue(null)}})]})})]})})]})]})};export{gt as default};
