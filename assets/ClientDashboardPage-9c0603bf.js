import{b as ie,r as _,j as e,m as Y,B as se,a6 as _e,a4 as Ee,b1 as Ce,P as $e,e as ke,O as Ie,Q as ue,ac as ye,X as he,V as ve,ad as ce,N as D,s as G,l as y,ag as Pe,b9 as De,aa as ze,i as ge,Y as Ae,aj as Te,ak as Me,aV as Fe,t as qe,p as Re,M as Oe,u as Le,ba as Ve}from"./index-f3f9473d.js";import{u as Be}from"./useSupabaseProjectStepsStatus-6e153194.js";import{f as pe,V as Ge}from"./index-db550b9f.js";import{P as Ne}from"./paperclip-9e2ad9fc.js";const He="completed",Ke=({project:t,projectStepsStatus:l,onSelectProject:c,index:x})=>{const{currentUser:m,getProjectSteps:i}=ie(),v=_.useMemo(()=>l&&l[t.type]?l[t.type]:m?i(m.id,t.type):t.steps,[l,t.type,m,i]),q=v.filter(b=>b.status===He).length,g=v.length,C=g>0?Math.round(q/g*100):0,H=v.find(b=>b.status==="current")||v.find(b=>b.status==="pending")||{name:"TerminÃ©"},Q=C>0?"Continuer le projet ðŸš€":"DÃ©marrer le projet ðŸš€";return e.jsxs(Y.div,{className:"bg-white rounded-2xl shadow-card p-6 flex flex-col justify-between",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:x*.1},children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-4 mb-4",children:[e.jsx("div",{className:`w-12 h-12 ${t.color} rounded-xl flex items-center justify-center shadow-soft`,children:e.jsx("span",{className:"text-2xl",children:t.icon})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-lg",children:t.title}),e.jsx("p",{className:"text-sm text-gray-500",children:H.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"Progression"}),e.jsxs("span",{className:"font-bold text-green-600",children:[C,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx(Y.div,{className:"progress-bar h-2.5 rounded-full",initial:{width:"0%"},animate:{width:`${C}%`},transition:{duration:1,ease:"easeInOut"}})})]}),e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex justify-between items-center text-xs text-gray-400",children:e.jsxs("span",{children:[q," / ",g," Ã©tapes"]})})})]}),e.jsx("div",{className:"flex justify-end items-center mt-6",children:e.jsx(se,{onClick:()=>c(t),className:"bg-green-600 hover:bg-green-700 text-white rounded-lg shadow-soft hover:shadow-lg transition-all duration-300 transform hover:scale-105",children:Q})})]})},Je=({projects:t=[],onProjectClick:l,onAddProject:c})=>{var g;const{currentUser:x}=ie(),m=t.length,{projectStepsStatus:i}=Be(x==null?void 0:x.id),v=0,q=m;return e.jsxs(Y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900",children:["Bonjour ",((g=x==null?void 0:x.name)==null?void 0:g.split(" ")[0])||"Jack"," ðŸ‘‹"]}),(x==null?void 0:x.affiliateName)&&e.jsxs("p",{className:"text-sm text-gray-500 mt-2 flex items-center justify-center",children:[e.jsx(_e,{className:"w-4 h-4 mr-1.5"}),"Suivi par : ",e.jsx("span",{className:"font-medium ml-1",children:x.affiliateName})]})]}),e.jsx(Y.div,{className:"bg-white rounded-2xl shadow-card p-4 sm:p-6",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Vue d'ensemble"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"hidden sm:flex items-center space-x-4 text-sm font-medium",children:[e.jsxs("span",{className:"flex items-center text-green-600",children:[e.jsx(Ee,{className:"h-4 w-4 mr-1.5"}),e.jsxs("span",{children:[v," actif",""]})]}),e.jsxs("span",{className:"flex items-center text-blue-600",children:[e.jsx(Ce,{className:"h-4 w-4 mr-1.5"}),e.jsxs("span",{children:[q," en cours"]})]})]}),e.jsxs(se,{onClick:c,className:"bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-soft hover:shadow-lg transition-all duration-300 transform hover:scale-105",children:[e.jsx($e,{className:"h-5 w-5 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Ajouter un projet"})]})]})]})}),t.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:t.map((C,H)=>e.jsx(Ke,{project:C,projectStepsStatus:i,onSelectProject:()=>l(C),index:H},C.id))}):e.jsxs(Y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"text-center py-12 bg-gray-50 rounded-2xl",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-700",children:"Aucun projet pour le moment."}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Commencez par ajouter votre premier projet !"})]})]})},we=({isDesktop:t,projectType:l})=>{const{clientFormPanels:c,updateClientFormPanel:x,forms:m,currentUser:i,updateProspect:v,addChatMessage:q,prompts:g,completeStepAndProceed:C,projectsData:H}=ie(),{addProjectEvent:Q}=ke({projectType:l,prospectId:i==null?void 0:i.id,enabled:!!l&&!!(i!=null&&i.id),activeAdminUser:i?{organization_id:i.organization_id}:null}),{uploadFile:b,uploading:A,deleteFile:R}=Ie({projectType:l,prospectId:i==null?void 0:i.id,organizationId:i==null?void 0:i.organization_id,enabled:!0}),S=_.useMemo(()=>i?c.filter(a=>!(a.prospectId!==i.id||l&&a.projectType!==l||a.filledByRole==="partner")).sort((a,u)=>(u.createdAt||0)-(a.createdAt||0)):[],[c,i,l]),K=i,[le,Z]=_.useState({}),[r,z]=_.useState({});if(_.useEffect(()=>{if(!K){Z({});return}if(!S.length){Z({});return}Z(a=>{const u={...a};return S.forEach(p=>{var E;if(!u[p.panelId]){const h=m[p.formId],d={},O=((K.form_data||K.formData||{})[p.projectType]||{})[p.formId]||{};(E=h==null?void 0:h.fields)==null||E.forEach(L=>{O[L.id]&&(d[L.id]=O[L.id])}),u[p.panelId]=d}}),u})},[S,m,K]),!S.length)return null;const I=(a,u,p)=>{Z(E=>({...E,[a]:{...E[a]||{},[u]:p}}))},J=async a=>{var O,L,te;const{panelId:u,prospectId:p,projectType:E,currentStepIndex:h,promptId:d,formId:o,messageTimestamp:w}=a;if(!r[u]){z(s=>({...s,[u]:!0}));try{if(!i||i.id!==p){D({title:"Erreur de session",description:"Impossible de soumettre le formulaire. Veuillez vous reconnecter.",variant:"destructive"});return}const s=m[o];let j={...le[u]||{}};const{data:X,error:P}=await G.from("prospects").select("form_data").eq("id",p).single(),F=((O=((X==null?void 0:X.form_data)||i.formData||{})[E])==null?void 0:O[o])||{};try{const n=((L=s==null?void 0:s.fields)==null?void 0:L.filter(f=>f.type==="file"))||[];for(const f of n){const M=j[f.id];if(M&&M instanceof File){if(M.size>10485760){D({title:"âŒ Fichier trop volumineux",description:`${f.label}: La taille maximale est de 10 MB.`,variant:"destructive"});return}const B=F[f.id];if(B&&typeof B=="object"&&B.id&&B.storagePath){y.debug("ï¿½ Replacing existing file for field",{fieldId:f.id,fieldLabel:f.label,oldFileName:B.name,oldFileId:B.id,newFileName:M.name});try{const{data:oe,error:Se}=await G.from("project_files").select("field_label").eq("id",B.id).single();if(!Se&&(oe!=null&&oe.field_label)){const{error:be}=await G.storage.from("project-files").remove([B.storagePath]);be?y.error("âŒ Error deleting old file from storage",be):y.info("âœ… Old file deleted from storage",{storagePath:B.storagePath});const{error:je}=await G.from("project_files").delete().eq("id",B.id);je?y.error("âŒ Error deleting old file from database",je):y.info("âœ… Old file deleted from database",{fileId:B.id})}else y.warn("âš ï¸ Old file is not a form file (no field_label), skipping deletion",{fileId:B.id})}catch(oe){y.error("âŒ Error during old file deletion",oe)}}y.debug("ï¿½ðŸ“¤ Uploading new file from form",{fieldId:f.id,fieldLabel:f.label,name:M.name,size:M.size});const ne=await b({file:M,uploadedBy:i==null?void 0:i.id,fieldLabel:f.label});ne&&(j[f.id]={id:ne.id,name:ne.file_name,size:ne.file_size,type:ne.file_type,storagePath:ne.storage_path,fieldLabel:f.label},y.debug("âœ… New file uploaded for form field",{fieldId:f.id,fileData:j[f.id]}))}}}catch(n){y.error("âŒ Error uploading form files",n),D({title:"âŒ Erreur d'upload",description:`Impossible d'uploader les fichiers : ${n.message}`,variant:"destructive"});return}const{data:N,error:V}=await G.from("prospects").select("form_data").eq("id",p).single();V&&y.error("âŒ Erreur rechargement form_data:",V);const $=(N==null?void 0:N.form_data)||i.formData||{},T={...$,[E]:{...$[E]||{},[o]:j}},{error:k}=await G.from("prospects").update({form_data:T}).eq("id",p);if(k){y.error("âŒ Erreur update form_data:",k),D({title:"Erreur",description:"Impossible de sauvegarder vos donnÃ©es.",variant:"destructive"});return}try{const{data:n,error:f}=await G.from("prospects").select("*").eq("id",p).single();if(!f&&n){const M={id:n.id,name:n.name,email:n.email,phone:n.phone,company:n.company_name,address:n.address,ownerId:n.owner_id,status:n.status,tags:n.tags||[],hasAppointment:n.has_appointment||!1,affiliateName:n.affiliate_name,formData:n.form_data||{},form_data:n.form_data||{},createdAt:n.created_at,updatedAt:n.updated_at};await G.channel("prospects-broadcast-global").send({type:"broadcast",event:"prospect-updated",payload:M}),y.info("âœ… Broadcast envoyÃ© aux admins",{prospectId:p,name:n.name})}}catch(n){y.warn("âš ï¸ Erreur broadcast (non bloquant):",n)}try{await v({id:p,formData:T,form_data:T,tags:(i==null?void 0:i.tags)||[]})}catch(n){y.warn("âš ï¸ Erreur mise Ã  jour currentUser (non bloquant):",n)}q(p,E,{sender:"client",text:`A complÃ©tÃ© le formulaire : ${(s==null?void 0:s.name)||"Formulaire"}.`,completedFormId:o,relatedMessageTimestamp:w}),(!g||Object.keys(g).length===0)&&y.warn("âš ï¸ [ClientFormPanel] Aucun prompt configurÃ© pour cette organisation (normal pour nouvelles orgs)");const ee=d?g[d]:Object.values(g).find(n=>{var M,re;if(n.projectId!==E)return!1;const f=(M=n.stepsConfig)==null?void 0:M[h];return(re=f==null?void 0:f.actions)==null?void 0:re.some(B=>B.type==="show_form"&&B.formId===o)});if(ee){const n=(te=ee.stepsConfig)==null?void 0:te[h];n!=null&&n.autoCompleteStep?(C(p,E,h),D({title:"Ã‰tape terminÃ©e !",description:"L'Ã©tape a Ã©tÃ© automatiquement marquÃ©e comme terminÃ©e.",className:"bg-green-500 text-white"})):D({title:"Formulaire envoyÃ©",description:"Vos informations ont Ã©tÃ© transmises Ã  votre conseiller.",className:"bg-green-500 text-white"})}else D({title:"Formulaire envoyÃ©",description:"Vos informations ont Ã©tÃ© transmises Ã  votre conseiller.",className:"bg-green-500 text-white"});x(u,{status:"submitted",lastSubmittedAt:new Date().toISOString(),userOverride:null});try{const n=(s==null?void 0:s.name)||o;await Q({prospectId:i.id,projectType:E,title:"Formulaire complÃ©tÃ©",description:`${i.name} a complÃ©tÃ© le formulaire ${n}.`,createdBy:i.name})}catch(n){y.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",n)}}catch(s){y.error("âŒ Erreur lors de la soumission du formulaire:",s),D({title:"âŒ Erreur",description:"Une erreur est survenue lors de l'envoi du formulaire.",variant:"destructive"})}finally{z(s=>({...s,[u]:!1}))}}},W=async a=>{if(!a||!a.storagePath){D({title:"âŒ Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{const{data:u,error:p}=await G.storage.from("project-files").createSignedUrl(a.storagePath,3600);if(p)throw p;window.open(u.signedUrl,"_blank"),D({title:"âœ… TÃ©lÃ©chargement",description:`${a.name} s'ouvre dans un nouvel onglet.`})}catch(u){y.error("âŒ Error downloading file",u),D({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},xe=async a=>{var te,s;const{panelId:u,formId:p,projectType:E}=a,{data:h,error:d}=await G.from("prospects").select("form_data").eq("id",i.id).single();if(d){y.error("âŒ Erreur rechargement form_data:",d),D({title:"Erreur",description:"Impossible de charger les derniÃ¨res donnÃ©es.",variant:"destructive"});return}const o=m[p],w={},L=(((te=h.form_data)==null?void 0:te[E])||{})[p]||{};(s=o==null?void 0:o.fields)==null||s.forEach(j=>{L[j.id]&&(w[j.id]=L[j.id])}),Z(j=>({...j,[u]:w})),x(u,{status:"pending",userOverride:"pending"})};return e.jsxs("aside",{className:`bg-white rounded-2xl shadow-card p-6 space-y-6 ${t?"":"mt-6"}`,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires Ã  complÃ©ter"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Retrouvez ici les actions Ã  rÃ©aliser ou dÃ©jÃ  envoyÃ©es pour votre projet."})]}),e.jsx("div",{className:"space-y-6",children:S.map(a=>{var O,L,te;const u=m[a.formId],p=a.status==="submitted",E=a.status==="approved",h=a.status==="rejected",d=le[a.panelId]||{};let o="human";if(a.promptId&&g){const s=Object.values(g).find(j=>j.id===a.promptId);if(s){const j=(O=s.stepsConfig)==null?void 0:O[a.currentStepIndex],X=(L=j==null?void 0:j.actions)==null?void 0:L.find(P=>P.type==="show_form"&&P.formId===a.formId);o=(X==null?void 0:X.verificationMode)||"human"}}if(!u)return console.error("âŒ [ClientFormPanel] Formulaire non trouvÃ©:",{formId:a.formId,availableForms:Object.keys(m),panel:a}),null;let w={text:"Ã€ complÃ©ter",className:"bg-blue-100 text-blue-700"};return E?w={text:"âœ… ApprouvÃ©",className:"bg-green-100 text-green-700"}:h?w={text:"âŒ RejetÃ©",className:"bg-red-100 text-red-700"}:p&&(o==="none"?w={text:"âœ… ValidÃ© automatiquement",className:"bg-green-100 text-green-700"}:w={text:"ðŸ• En attente de validation",className:"bg-yellow-100 text-yellow-700"}),e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900 truncate",children:u.name}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ã‰tape : ",a.stepName||"Suivi du projet"]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full whitespace-nowrap flex-shrink-0 ${w.className}`,children:w.text})]}),E?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"âœ…"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:"Formulaire approuvÃ©"}),e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Votre conseiller a validÃ© les informations"})]})]})}),e.jsx("div",{className:"space-y-2 text-sm",children:(te=u.fields)==null?void 0:te.map(s=>{if(s.show_if_conditions&&s.show_if_conditions.length>0){const P=s.condition_operator||"AND",U=s.show_if_conditions.map(N=>{const V=d[N.field];return N.equals==="has_value"?!!V&&V!=="":V===N.equals});if(!(P==="AND"?U.every(N=>N===!0):U.some(N=>N===!0)))return null}if(s.show_if){const P=s.show_if.field,U=s.show_if.equals,F=d[P];if(!F||F!==U)return null}const j=d[s.id];if(!j)return null;const X=s.type==="file"&&typeof j=="object"&&j.storagePath;return e.jsxs("div",{className:"flex justify-between items-start gap-2 py-2 border-b border-gray-100 last:border-0",children:[e.jsxs("span",{className:"text-gray-600 font-medium",children:[s.label,":"]}),X?e.jsxs("button",{onClick:()=>W(j),className:"flex items-center gap-1 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:j.name})]}):e.jsx("span",{className:"text-gray-900 text-right",children:typeof j=="object"?JSON.stringify(j):j})]},s.id)})})]}):h?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"âŒ"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-red-700",children:"Formulaire rejetÃ©"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Veuillez modifier les informations et renvoyer"})]})]})}),e.jsx(se,{variant:"outline",size:"sm",onClick:()=>xe(a),className:"w-full",children:"Modifier et renvoyer"})]}):p?e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg px-3 py-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700",children:o==="none"?"Formulaire validÃ© automatiquement":"Formulaire envoyÃ© Ã  votre conseiller"}),o!=="none"&&e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"Vous pouvez encore le modifier si nÃ©cessaire"})]}),e.jsx(se,{variant:"outline",size:"sm",onClick:()=>xe(a),children:"Modifier"})]})}):e.jsxs("div",{className:"space-y-4",children:[(u.fields||[]).map(s=>{if(s.show_if_conditions&&s.show_if_conditions.length>0){const F=s.condition_operator||"AND",N=s.show_if_conditions.map($=>{const T=$.field,k=$.equals,ee=d[T];return k==="has_value"?!!ee&&ee!=="":ee===k});if(!(F==="AND"?N.every($=>$===!0):N.some($=>$===!0)))return null}if(s.show_if){const F=s.show_if.field,N=s.show_if.equals,V=d[F];if(!V||V!==N)return null}if((u.fields||[]).some(F=>F.is_repeater&&(F.repeats_fields||[]).includes(s.id)))return null;const X=s.type==="file",P=d[s.id],U=X&&(P instanceof File||(P==null?void 0:P.storagePath));return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ye,{htmlFor:`${a.panelId}-${s.id}`,children:[s.label,s.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),X?e.jsxs("div",{className:"space-y-2",children:[U&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx(ue,{className:"h-5 w-5 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-blue-900 truncate",children:(P instanceof File,P.name)}),e.jsx("p",{className:"text-xs text-blue-600",children:P instanceof File?`${(P.size/1024).toFixed(1)} KB`:`${(P.size/1024).toFixed(1)} KB`})]}),e.jsx("button",{type:"button",onClick:()=>I(a.panelId,s.id,null),className:"p-1 hover:bg-red-100 rounded-full transition-colors",children:e.jsx(he,{className:"h-4 w-4 text-red-600"})})]}),e.jsxs("label",{htmlFor:`${a.panelId}-${s.id}`,className:`flex items-center justify-center gap-2 p-3 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${U?"border-gray-300 bg-gray-50 hover:border-gray-400":"border-blue-300 bg-blue-50 hover:border-blue-400 hover:bg-blue-100"}`,children:[e.jsx(ve,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-900",children:U?"Changer le fichier":"Choisir un fichier"})]}),e.jsx(ce,{id:`${a.panelId}-${s.id}`,type:"file",onChange:F=>{var V;const N=(V=F.target.files)==null?void 0:V[0];N&&I(a.panelId,s.id,N)},className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Formats acceptÃ©s: PDF, PNG, JPG, DOCX (max 10 MB)"})]}):s.type==="select"?e.jsxs("select",{id:`${a.panelId}-${s.id}`,value:P||"",onChange:F=>I(a.panelId,s.id,F.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(s.options||[]).map((F,N)=>e.jsx("option",{value:F,children:F},N))]}):e.jsx(ce,{id:`${a.panelId}-${s.id}`,type:s.type||"text",value:typeof P=="object"?"":P||"",onChange:F=>I(a.panelId,s.id,F.target.value),placeholder:s.placeholder||""}),s.is_repeater&&s.repeats_fields&&s.repeats_fields.length>0&&P&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(P)||0},(F,N)=>{const V=(u.fields||[]).filter($=>s.repeats_fields.includes($.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[s.label," #",N+1]}),V.map($=>{const T=`${s.id}_repeat_${N}_${$.id}`,k=d[T],ee=$.type==="file",n=ee&&(k instanceof File||(k==null?void 0:k.storagePath));return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ye,{htmlFor:`${a.panelId}-${T}`,children:[$.label,$.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),ee?e.jsxs("div",{className:"space-y-2",children:[n&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx(ue,{className:"h-5 w-5 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-blue-900 truncate",children:(k instanceof File,k.name)}),e.jsx("p",{className:"text-xs text-blue-600",children:k instanceof File?`${(k.size/1024).toFixed(1)} KB`:`${(k.size/1024).toFixed(1)} KB`})]}),e.jsx("button",{type:"button",onClick:()=>I(a.panelId,T,null),className:"p-1 hover:bg-red-100 rounded-full transition-colors",children:e.jsx(he,{className:"h-4 w-4 text-red-600"})})]}),e.jsxs("label",{htmlFor:`${a.panelId}-${T}`,className:`flex items-center justify-center gap-2 p-3 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${n?"border-gray-300 bg-gray-50 hover:border-gray-400":"border-blue-300 bg-blue-50 hover:border-blue-400 hover:bg-blue-100"}`,children:[e.jsx(ve,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-900",children:n?"Changer le fichier":"Choisir un fichier"})]}),e.jsx(ce,{id:`${a.panelId}-${T}`,type:"file",onChange:f=>{var re;const M=(re=f.target.files)==null?void 0:re[0];M&&I(a.panelId,T,M)},className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Formats acceptÃ©s: PDF, PNG, JPG, DOCX (max 10 MB)"})]}):$.type==="select"?e.jsxs("select",{id:`${a.panelId}-${T}`,value:k||"",onChange:f=>I(a.panelId,T,f.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),($.options||[]).map((f,M)=>e.jsx("option",{value:f,children:f},M))]}):e.jsx(ce,{id:`${a.panelId}-${T}`,type:$.type||"text",value:typeof k=="object"?"":k||"",onChange:f=>I(a.panelId,T,f.target.value),placeholder:$.placeholder||""})]},T)})]},N)})})]},s.id)}),e.jsx(se,{onClick:()=>J(a),className:"w-full bg-blue-600 hover:bg-blue-700 text-white",disabled:A||r[a.panelId],children:r[a.panelId]?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Envoi en cours..."]}):A?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Upload en cours..."]}):"Envoyer"})]})]},a.panelId)})})]})},fe="completed",de="in_progress",me="pending",ae={[fe]:{label:"TerminÃ©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[de]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[me]:{label:"Ã€ venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Xe=({appointment:t,onClick:l})=>{const c=new Date(t.start),x=t.type==="physical";return e.jsx(Y.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-blue-100 to-blue-200 border border-blue-400 rounded-lg p-2.5 shadow-md cursor-pointer hover:from-blue-200 hover:to-blue-300 transition-all duration-200",onClick:()=>l(t),children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"font-medium text-blue-900 text-xs leading-tight",children:["Rdv le ",pe(c,"EEEE dd/MM",{locale:ge})," Ã  ",pe(c,"HH:mm")]}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-xs font-medium ${x?"bg-blue-600 text-white":"bg-purple-600 text-white"}`,children:x?"Physique":"Visio"})]}),t.description&&e.jsx("p",{className:"text-blue-700 text-xs truncate",children:t.description})]})})},Qe=({prospectId:t,projectType:l,currentStepIndex:c})=>{const{addChatMessage:x,currentUser:m,forms:i}=ie(),{messages:v,loading:q}=Pe(t,l,"client"),{uploadFile:g,uploading:C}=Ie({projectType:l,prospectId:t,organizationId:m==null?void 0:m.organization_id,enabled:!0}),[H,Q]=_.useState(""),[b,A]=_.useState(null),R=_.useRef(null),S=_.useRef(null);_.useEffect(()=>{requestAnimationFrame(()=>{var r;(r=R.current)==null||r.scrollIntoView({behavior:"smooth",block:"end"})})},[v]);const K=async()=>{if(!(!H.trim()&&!b))try{let r=null;if(b){if(b.size>10485760){D({title:"âŒ Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}y.debug("ðŸ“¤ Uploading file from client chat",{name:b.name,size:b.size,type:b.type});const J=await g({file:b,uploadedBy:m==null?void 0:m.id});J&&(r={id:J.id,name:J.file_name,size:J.file_size,type:J.file_type,storagePath:J.storage_path},y.debug("âœ… File uploaded successfully",r))}x(t,l,{sender:"client",text:H,file:r}),Q(""),A(null),requestAnimationFrame(()=>{var I;(I=R.current)==null||I.scrollIntoView({behavior:"smooth",block:"end"})}),r&&D({title:"âœ… Fichier envoyÃ©",description:`${r.name} a Ã©tÃ© envoyÃ© avec succÃ¨s.`})}catch(r){y.error("âŒ Error sending message with file",r),D({title:"âŒ Erreur",description:`Impossible d'envoyer le fichier : ${r.message}`,variant:"destructive"})}},le=r=>{r.target.files&&r.target.files[0]&&A(r.target.files[0])},Z=async r=>{if(!r||!r.storagePath){D({title:"âŒ Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{y.debug("ðŸ“¥ Downloading file",{storagePath:r.storagePath});const{data:z,error:I}=await G.storage.from("project-files").createSignedUrl(r.storagePath,3600);if(I)throw I;window.open(z.signedUrl,"_blank"),D({title:"âœ… TÃ©lÃ©chargement",description:`${r.name} s'ouvre dans un nouvel onglet.`})}catch(z){y.error("âŒ Error downloading file",z),D({title:"âŒ Erreur",description:`Impossible de tÃ©lÃ©charger le fichier : ${z.message}`,variant:"destructive"})}};return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[v.map((r,z)=>r.formId&&!r.text?null:e.jsxs("div",{className:`flex items-end gap-2 ${r.sender==="client"?"justify-end":"justify-start"}`,children:[r.sender==="pro"&&e.jsx("img",{alt:"Charly",className:"w-8 h-8 rounded-full",src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${r.sender==="client"?"bg-blue-500 text-white rounded-br-none p-2.5":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[r.text&&(r.sender==="pro"&&r.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:r.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:r.text})),r.file&&e.jsxs("button",{onClick:()=>Z(r.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(ue,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:r.file.name}),e.jsx(Ae,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),r.formId&&i[r.formId]&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600 bg-white rounded-xl p-3",children:[e.jsx("p",{className:"font-semibold text-gray-700 text-sm",children:i[r.formId].name}),e.jsx("p",{className:"mt-1",children:"Ce formulaire est disponible dans le panneau de droite pour Ãªtre complÃ©tÃ©."})]}),e.jsx("p",{className:`text-xs mt-1 ${r.sender==="client"?"text-blue-200":"text-gray-500"}`,children:Te(new Date(r.timestamp),{addSuffix:!0,locale:ge})})]}),r.sender==="client"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white",children:(m==null?void 0:m.name.charAt(0))||"?"})]},z)),e.jsx("div",{ref:R})]}),b&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),e.jsx("span",{children:b.name}),e.jsx("button",{onClick:()=>A(null),className:"text-red-500",children:"Ã—"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ce,{placeholder:"Ã‰crire Ã  votre conseiller...",className:"pr-24 h-12",value:H,onChange:r=>Q(r.target.value),onKeyPress:r=>r.key==="Enter"&&K()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(se,{variant:"ghost",size:"icon",onClick:()=>S.current.click(),disabled:C,children:e.jsx(Ne,{className:`h-5 w-5 ${C?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:S,onChange:le,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:C}),e.jsx(se,{onClick:K,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:C,children:C?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Me,{className:"h-4 w-4"})})]})]})]})},We=({appointment:t,onClose:l})=>{var q,g;if(!t)return null;const{getAdminById:c}=ie(),x=new Date(t.start),m=t.type==="physical",i=t.assignedUserId?c(t.assignedUserId):null,v=i?{firstName:((q=i.name)==null?void 0:q.split(" ")[0])||"Conseiller",lastName:((g=i.name)==null?void 0:g.split(" ")[1])||"Locasun",phone:i.phone||"+33 1 23 45 67 89",email:i.email||"contact@locasun.com"}:{firstName:"Conseiller",lastName:"Locasun",phone:"+33 1 23 45 67 89",email:"contact@locasun.com"};return e.jsx(Fe,{children:e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs(Y.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},className:"bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"DÃ©tails du rendez-vous"}),e.jsx("button",{onClick:l,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(he,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-3 mb-2",children:[m?e.jsx(qe,{className:"h-5 w-5 text-blue-600"}):e.jsx(Ge,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-blue-900",children:m?"Rendez-vous physique":"Rendez-vous en visioconfÃ©rence"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-medium text-gray-900 text-lg",children:pe(x,"EEEE dd MMMM yyyy",{locale:ge})}),e.jsx("p",{className:"text-blue-700 font-medium",children:pe(x,"HH:mm")})]})]}),t.description&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-amber-900",children:"Commentaire"})]}),e.jsx("p",{className:"text-gray-700 leading-relaxed bg-white p-3 rounded border",children:t.description})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsxs("h4",{className:"font-medium text-gray-900 mb-4 flex items-center space-x-2",children:[e.jsx(_e,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{children:"Votre conseiller"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:[e.jsxs("p",{className:"font-bold text-gray-900 text-xl",children:[v.firstName," ",v.lastName]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Conseiller Locasun"})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(Re,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"TÃ©lÃ©phone"}),e.jsx("p",{className:"font-medium text-gray-900",children:v.phone})]}),e.jsx("a",{href:`tel:${v.phone}`,className:"px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors",children:"Appeler"})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(Oe,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("p",{className:"font-medium text-gray-900",children:v.email})]}),e.jsx("a",{href:`mailto:${v.email}`,className:"px-3 py-1.5 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors",children:"Ã‰crire"})]})]})]})]}),e.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50 rounded-b-xl",children:e.jsx(se,{onClick:l,className:"w-full",children:"Fermer"})})]})})})},Ye=({project:t,onBack:l})=>{var u,p,E;const{currentUser:c,getProjectSteps:x,updateProjectSteps:m,getSharedAppointments:i,clientFormPanels:v,clientNotifications:q,markClientNotificationAsRead:g}=ie();Pe(c==null?void 0:c.id,t.type,"client");const{width:C}=De(),H=C>=1024,[Q,b]=_.useState(0),[A,R]=_.useState(null),[S,K]=_.useState(null),[le,Z]=_.useState(!0),r=c?v.some(h=>h.prospectId===c.id&&h.projectType===t.type):!1,z=S||t.steps,I=_.useMemo(()=>{if(!z||z.length===0)return[];if(!z.some(d=>d.status===de)){const d=z.findIndex(o=>o.status!==fe);if(d!==-1)return z.map((o,w)=>w===d?{...o,status:de}:o)}return z},[z]),J=I.findIndex(h=>h.status===de),W=I[J]||I[0],xe=J!==-1?J:0,a=c&&W?i(c.id,t.type,W.name):[];return _.useEffect(()=>{if(!(c!=null&&c.id)||!t.type)return;(async()=>{try{Z(!0);const{data:o,error:w}=await G.from("project_steps_status").select("steps").eq("prospect_id",c.id).eq("project_type",t.type).single();if(w){console.warn("âš ï¸ No steps found in Supabase for this project, using template default"),K(null);return}o!=null&&o.steps&&K(o.steps)}catch(o){y.error("âŒ Error fetching initial steps:",o)}finally{Z(!1)}})();const d=G.channel(`client-project-steps-${c.id}-${t.type}`).on("postgres_changes",{event:"*",schema:"public",table:"project_steps_status",filter:`prospect_id=eq.${c.id}`},o=>{var w,O;((w=o.new)==null?void 0:w.project_type)===t.type&&((O=o.new)!=null&&O.steps)&&(K(o.new.steps),D({title:"ðŸ“Š Timeline mise Ã  jour",description:"Votre conseiller a mis Ã  jour l'avancement du projet",className:"bg-blue-500 text-white"}))}).subscribe();return()=>{G.removeChannel(d)}},[c==null?void 0:c.id,t.type]),_.useEffect(()=>{if(!(c!=null&&c.id)||!t.type||!q||!g)return;const h=q.filter(d=>!d.read&&d.projectType===t.type);h.length>0&&h.forEach(d=>{g(d.id)})},[c==null?void 0:c.id,t.type,q,g]),_.useEffect(()=>{const h=I.filter(w=>w.status===fe).length,d=I.length,o=d>0?Math.round(h/d*100):0;b(o)},[I]),e.jsxs(Y.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 md:space-x-4",children:[e.jsx(se,{variant:"ghost",size:"icon",onClick:l,className:"rounded-full hover:bg-gray-100 flex-shrink-0",children:e.jsx(ze,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center space-x-3 overflow-hidden",children:[e.jsx("div",{className:`w-10 h-10 md:w-12 md:h-12 ${t.color} rounded-xl flex items-center justify-center shadow-card flex-shrink-0`,children:e.jsx("span",{className:"text-2xl",children:t.icon})}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold text-gray-900 truncate",children:t.clientTitle||t.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Projet #",t.id]})]})]})]}),e.jsxs("div",{className:`flex flex-col ${H&&r?"lg:flex-row":""} gap-8`,children:[e.jsx("div",{className:"flex-1 space-y-8",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Progression globale"}),e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Avancement"}),e.jsxs("span",{className:"text-lg font-bold text-green-600",children:[Q,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx(Y.div,{className:"progress-bar h-3 rounded-full",initial:{width:"0%"},animate:{width:`${Q}%`},transition:{duration:1}})})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-6",children:"Suivi dÃ©taillÃ©"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-4",children:I.map((h,d)=>{const o=ae[h.status]||ae[me],w=h.status===de,O=w?a:[];return e.jsxs(Y.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:d*.1},className:"relative",children:[e.jsxs("div",{className:"flex items-center space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${o.iconOnly}`,children:h.icon})}),e.jsxs("div",{className:"flex-1 flex items-center justify-between",children:[e.jsx("h3",{className:`font-medium ${o.text}`,children:h.name}),e.jsx("span",{className:`text-xs px-2.5 py-1 rounded-full ${o.badge}`,children:o.label})]})]}),w&&O.length>0&&e.jsx("div",{className:"ml-14 mt-3 space-y-2",children:O.map(L=>e.jsx("div",{className:"ml-0",children:e.jsx(Xe,{appointment:L,onClick:R})},L.id))})]},d)})})]})]})]}),e.jsx("div",{className:"lg:col-span-2 bg-white rounded-2xl shadow-card p-6",children:W&&e.jsxs(Y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((u=ae[W.status])==null?void 0:u.iconOnly)||ae[me].iconOnly}`,children:W.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:W.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((p=ae[W.status])==null?void 0:p.badge)||ae[me].badge}`,children:((E=ae[W.status])==null?void 0:E.label)||ae[me].label})]}),e.jsx(Qe,{prospectId:c.id,projectType:t.type,currentStepIndex:xe})]},W.name)})]})}),H&&r&&e.jsx("div",{className:"w-[320px] flex-shrink-0",children:e.jsx(we,{isDesktop:!0,projectType:t.type})}),!H&&r&&e.jsx("div",{className:"w-full",children:e.jsx(we,{isDesktop:!1,projectType:t.type})})]}),A&&e.jsx(We,{appointment:A,onClose:()=>R(null)})]})};function ts(){const{projectsData:t,currentUser:l,authLoading:c}=ie(),x=Le(),m=Ve(),[i,v]=_.useState(null),[q,g]=_.useState([]),[C,H]=_.useState({});_.useEffect(()=>{(async()=>{if(!(l!=null&&l.id)||!(l!=null&&l.tags)||l.tags.length===0)return;const{data:A}=await G.from("project_infos").select("project_type, status").eq("prospect_id",l.id).in("project_type",l.tags);if(A){const R={};A.forEach(S=>{R[S.project_type]=S.status||"actif"}),H(R)}})()},[l]),_.useEffect(()=>{if(!l){g([]);return}if(Object.keys(t).length===0){g([]);return}const b=l.tags||[];if(b.length===0){g([]);return}const R=b.filter(S=>{const K=C[S];return!K||K==="actif"}).map(S=>t[S]).filter(Boolean);g(R)},[l,t,C,x]);const Q=b=>{v(b)};return _.useEffect(()=>{var R;if((R=m.state)!=null&&R.openProjectType&&t[m.state.openProjectType]){const S=t[m.state.openProjectType];v(S),x("/dashboard",{replace:!0,state:{}});return}const A=new URLSearchParams(m.search).get("project");if(A&&t[A]){const S=t[A];v(S),x("/dashboard",{replace:!0})}},[m.search,m.state,t,x]),c?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center text-center p-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Chargement de votre espace..."})]}):l?e.jsx(Fe,{mode:"wait",children:i?e.jsx(Ye,{project:i,onBack:()=>v(null)},"details"):e.jsx(Je,{projects:q,onProjectClick:Q,onAddProject:()=>x("/dashboard/offres")},"dashboard")}):e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center text-center p-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Bienvenue !"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Connectez-vous pour voir vos projets."}),e.jsx("button",{onClick:()=>x("/"),className:"gradient-blue text-white font-bold py-2 px-4 rounded-lg",children:"Retour Ã  l'accueil"})]})}export{ts as default};
