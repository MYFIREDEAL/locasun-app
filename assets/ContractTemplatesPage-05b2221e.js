import{c as ie,u as $e,b as Ve,a as ke,ag as qe,r as c,N as u,j as e,b3 as Oe,m as F,B as d,P as W,O as T,A as Pe,E as Be,F as Ue,G as Xe,H as Ge,I as Je,J as Ye,K as We,L as Ke,aa as A,ab as Qe,S as Ze,v as et,w as tt,x as at,y as ge,aI as lt,Q as K,a3 as st,D as R,k as $,n as V,o as k,ad as q,z as Q,X as it,T as nt,an as Z,ao as ee,g as te,ap as ae,R as rt}from"./index-1b5ac617.js";import{P as xe}from"./pen-square-2558fab7.js";const ot=ie("FormInput",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["path",{d:"M12 12h.01",key:"1mp3jc"}],["path",{d:"M17 12h.01",key:"1m0b6t"}],["path",{d:"M7 12h.01",key:"eqddd0"}]]),ct=ie("Move",[["polyline",{points:"5 9 2 12 5 15",key:"1r5uj5"}],["polyline",{points:"9 5 12 2 15 5",key:"5v383o"}],["polyline",{points:"15 19 12 22 9 19",key:"g7qi8m"}],["polyline",{points:"19 9 22 12 19 15",key:"tpp73q"}],["line",{x1:"2",x2:"22",y1:"12",y2:"12",key:"1dnqot"}],["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}]]),he=ie("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),O={client_firstname:{label:"Pr√©nom du client",type:"text",required:!0},client_lastname:{label:"Nom du client",type:"text",required:!0},client_email:{label:"Email du client",type:"email"},client_phone:{label:"T√©l√©phone du client",type:"phone"},client_address:{label:"Adresse du client",type:"text"},client_zip:{label:"Code postal client",type:"text",placeholder:"75001"},client_city:{label:"Ville du client",type:"text"},client_birthdate:{label:"Date de naissance",type:"text",placeholder:"JJ/MM/AAAA"},client_birthplace:{label:"Lieu de naissance",type:"text"},client_nationality:{label:"Nationalit√©",type:"text",placeholder:"Fran√ßaise"},company_name:{label:"Nom de la soci√©t√©",type:"text",required:!0},company_legal_form:{label:"Forme juridique",type:"select",options:["SARL","SAS","SASU","SA","EURL","SCI","Auto-entrepreneur","Autre"]},company_siret:{label:"Num√©ro SIRET",type:"text",placeholder:"123 456 789 00012"},company_capital:{label:"Capital social (‚Ç¨)",type:"number",placeholder:"10000"},company_address:{label:"Adresse du si√®ge social",type:"text"},company_zip:{label:"Code postal soci√©t√©",type:"text",placeholder:"75001"},company_city:{label:"Ville soci√©t√©",type:"text"},company_rcs_number:{label:"Num√©ro RCS",type:"text"},company_rcs_city:{label:"Ville RCS",type:"text"},company_representative_name:{label:"Nom du repr√©sentant l√©gal",type:"text"},company_representative_role:{label:"Fonction du repr√©sentant",type:"text",placeholder:"G√©rant, Pr√©sident..."},cosigner_name_1:{label:"Nom du co-signataire 1",type:"text"},cosigner_email_1:{label:"Email co-signataire 1",type:"email"},cosigner_phone_1:{label:"T√©l√©phone co-signataire 1",type:"phone"},cosigner_address_1:{label:"Adresse co-signataire 1",type:"text"},cosigner_zip_1:{label:"Code postal co-signataire 1",type:"text"},cosigner_city_1:{label:"Ville co-signataire 1",type:"text"},cosigner_birthdate_1:{label:"Date de naissance co-signataire 1",type:"text"},cosigner_nationality_1:{label:"Nationalit√© co-signataire 1",type:"text"},cosigner_name_2:{label:"Nom du co-signataire 2",type:"text"},cosigner_email_2:{label:"Email co-signataire 2",type:"email"},cosigner_phone_2:{label:"T√©l√©phone co-signataire 2",type:"phone"},cosigner_address_2:{label:"Adresse co-signataire 2",type:"text"},cosigner_zip_2:{label:"Code postal co-signataire 2",type:"text"},cosigner_city_2:{label:"Ville co-signataire 2",type:"text"},cosigner_birthdate_2:{label:"Date de naissance co-signataire 2",type:"text"},cosigner_nationality_2:{label:"Nationalit√© co-signataire 2",type:"text"},cosigner_name_3:{label:"Nom du co-signataire 3",type:"text"},cosigner_email_3:{label:"Email co-signataire 3",type:"email"},cosigner_phone_3:{label:"T√©l√©phone co-signataire 3",type:"phone"},cosigner_address_3:{label:"Adresse co-signataire 3",type:"text"},cosigner_zip_3:{label:"Code postal co-signataire 3",type:"text"},cosigner_city_3:{label:"Ville co-signataire 3",type:"text"},cosigner_birthdate_3:{label:"Date de naissance co-signataire 3",type:"text"},cosigner_nationality_3:{label:"Nationalit√© co-signataire 3",type:"text"},project_type:{label:"Type de projet",type:"text"},project_description:{label:"Description du projet",type:"text"},project_power:{label:"Puissance (kWc)",type:"number"},project_address:{label:"Adresse du projet",type:"text"},project_zip:{label:"Code postal du projet",type:"text"},project_city:{label:"Ville du projet",type:"text"},contract_date:{label:"Date du contrat",type:"date"},signature_date:{label:"Date de signature",type:"date"},contract_place:{label:"Lieu du contrat",type:"text"},current_date:{label:"Date actuelle (auto)",type:"date"},contract_reference:{label:"R√©f√©rence contrat",type:"text"},contract_amount:{label:"Montant contrat (‚Ç¨)",type:"number"},contract_amount_words:{label:"Montant en lettres",type:"text"}},P=[{value:"text_variable",label:"üìù Variable texte"},{value:"signature",label:"‚úçÔ∏è Signature"},{value:"paraphe",label:"üîñ Paraphe"},{value:"reserve_block",label:"üì¶ Bloc r√©serv√©"}],le={CLIENT:[{value:"{{client_firstname}}",label:"Pr√©nom client"},{value:"{{client_lastname}}",label:"Nom client"},{value:"{{client_email}}",label:"Email client"},{value:"{{client_phone}}",label:"T√©l√©phone client"},{value:"{{client_address}}",label:"Adresse client"},{value:"{{client_zip}}",label:"Code postal client"},{value:"{{client_city}}",label:"Ville client"},{value:"{{client_birthdate}}",label:"N√©(e) le"},{value:"{{client_nationality}}",label:"Nationalit√©"}],SOCI√âT√â:[{value:"{{company_name}}",label:"Nom soci√©t√©"},{value:"{{company_siret}}",label:"SIRET"},{value:"{{company_address}}",label:"Adresse soci√©t√©"},{value:"{{company_zip}}",label:"Code postal soci√©t√©"},{value:"{{company_city}}",label:"Ville soci√©t√©"},{value:"{{company_representative_name}}",label:"Nom repr√©sentant"},{value:"{{company_representative_role}}",label:"R√¥le repr√©sentant"}],"DATES / LIEU":[{value:"{{contract_date}}",label:"Date du contrat"},{value:"{{signature_date}}",label:"Date de signature"},{value:"{{contract_place}}",label:"Lieu du contrat"}],"R√âF√âRENCE / MONTANT":[{value:"{{contract_reference}}",label:"R√©f√©rence contrat"},{value:"{{contract_amount}}",label:"Montant contrat"}],"CO-SIGNATAIRES":[{value:"{{cosigner_label_X}}",label:"Label co-signataire X (g√©n√©rique)"},{value:"{{cosigner_name_X}}",label:"Nom co-signataire X (g√©n√©rique)"},{value:"{{cosigner_email_X}}",label:"Email co-signataire X (g√©n√©rique)"},{value:"{{cosigner_phone_X}}",label:"T√©l√©phone co-signataire X (g√©n√©rique)"},{value:"{{cosigner_section_X}}",label:"Section co-signataire X (g√©n√©rique)"},{value:"{{cosigner_signature_line_X}}",label:"Ligne signature co-signataire X (g√©n√©rique)"},{value:"{{cosigner_name_1}}",label:"Nom co-signataire 1"},{value:"{{cosigner_email_1}}",label:"Email co-signataire 1"},{value:"{{cosigner_phone_1}}",label:"T√©l√©phone co-signataire 1"},{value:"{{cosigner_address_1}}",label:"Adresse co-signataire 1"},{value:"{{cosigner_zip_1}}",label:"Code postal co-signataire 1"},{value:"{{cosigner_city_1}}",label:"Ville co-signataire 1"},{value:"{{cosigner_birthdate_1}}",label:"N√©(e) le co-signataire 1"},{value:"{{cosigner_signature_line_1}}",label:"Ligne signature co-signataire 1"},{value:"{{cosigner_name_2}}",label:"Nom co-signataire 2"},{value:"{{cosigner_email_2}}",label:"Email co-signataire 2"},{value:"{{cosigner_phone_2}}",label:"T√©l√©phone co-signataire 2"},{value:"{{cosigner_address_2}}",label:"Adresse co-signataire 2"},{value:"{{cosigner_zip_2}}",label:"Code postal co-signataire 2"},{value:"{{cosigner_city_2}}",label:"Ville co-signataire 2"},{value:"{{cosigner_birthdate_2}}",label:"N√©(e) le co-signataire 2"},{value:"{{cosigner_signature_line_2}}",label:"Ligne signature co-signataire 2"},{value:"{{cosigner_name_3}}",label:"Nom co-signataire 3"},{value:"{{cosigner_email_3}}",label:"Email co-signataire 3"},{value:"{{cosigner_phone_3}}",label:"T√©l√©phone co-signataire 3"},{value:"{{cosigner_address_3}}",label:"Adresse co-signataire 3"},{value:"{{cosigner_zip_3}}",label:"Code postal co-signataire 3"},{value:"{{cosigner_city_3}}",label:"Ville co-signataire 3"},{value:"{{cosigner_birthdate_3}}",label:"N√©(e) le co-signataire 3"},{value:"{{cosigner_signature_line_3}}",label:"Ligne signature co-signataire 3"}],"CO-SIGNATAIRES SOCI√âT√â":[{value:"{{company_cosigner_label_1}}",label:"Label co-signataire soci√©t√© 1"},{value:"{{company_cosigner_name_1}}",label:"Nom co-signataire soci√©t√© 1"},{value:"{{company_cosigner_email_1}}",label:"Email co-signataire soci√©t√© 1"},{value:"{{company_cosigner_phone_1}}",label:"T√©l√©phone co-signataire soci√©t√© 1"},{value:"{{company_cosigner_signature_line_1}}",label:"Ligne signature co-signataire soci√©t√© 1"},{value:"{{company_cosigner_label_2}}",label:"Label co-signataire soci√©t√© 2"},{value:"{{company_cosigner_name_2}}",label:"Nom co-signataire soci√©t√© 2"},{value:"{{company_cosigner_email_2}}",label:"Email co-signataire soci√©t√© 2"},{value:"{{company_cosigner_phone_2}}",label:"T√©l√©phone co-signataire soci√©t√© 2"},{value:"{{company_cosigner_signature_line_2}}",label:"Ligne signature co-signataire soci√©t√© 2"},{value:"{{company_cosigner_label_3}}",label:"Label co-signataire soci√©t√© 3"},{value:"{{company_cosigner_name_3}}",label:"Nom co-signataire soci√©t√© 3"},{value:"{{company_cosigner_email_3}}",label:"Email co-signataire soci√©t√© 3"},{value:"{{company_cosigner_phone_3}}",label:"T√©l√©phone co-signataire soci√©t√© 3"},{value:"{{company_cosigner_signature_line_3}}",label:"Ligne signature co-signataire soci√©t√© 3"}]},be=[{value:"client",label:"üë§ Client (signataire principal)"},{value:"company",label:"üè¢ Soci√©t√© (signataire principal)"},{value:"cosigner_client_1",label:"‚úçÔ∏è Co-signataire client 1"},{value:"cosigner_client_2",label:"‚úçÔ∏è Co-signataire client 2"},{value:"cosigner_client_3",label:"‚úçÔ∏è Co-signataire client 3"},{value:"cosigner_company_1",label:"üè¢ Co-signataire soci√©t√© 1"},{value:"cosigner_company_2",label:"üè¢ Co-signataire soci√©t√© 2"},{value:"cosigner_company_3",label:"üè¢ Co-signataire soci√©t√© 3"}],dt={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},se={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}},pt=({onSave:v,onCancel:N})=>{var i,g,n;const[o,p]=c.useState("text_variable"),[b,j]=c.useState(""),[_,I]=c.useState(""),D=()=>{if(o==="text_variable"&&!b){u({title:"‚ùå Erreur",description:"Veuillez s√©lectionner une variable",variant:"destructive"});return}if((o==="signature"||o==="paraphe")&&!_){u({title:"‚ùå Erreur",description:"Veuillez s√©lectionner un r√¥le",variant:"destructive"});return}v({type:o,variable:b||null,role:_||null})};return e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"block-type",children:"Type de bloc"}),e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(d,{variant:"outline",className:"w-full justify-between mt-1",children:[((i=P.find(l=>l.value===o))==null?void 0:i.label)||"S√©lectionner...",e.jsx(te,{className:"ml-2 h-4 w-4 opacity-50"})]})}),e.jsx(ae,{className:"w-[300px] p-0",align:"start",children:e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:P.map(l=>e.jsx("button",{onClick:()=>p(l.value),className:"w-full px-3 py-2 text-left hover:bg-muted transition-colors",children:l.label},l.value))})})]})]}),o==="text_variable"&&e.jsxs("div",{children:[e.jsx(A,{htmlFor:"variable",children:"Variable (liste ferm√©e)"}),e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(d,{variant:"outline",className:"w-full justify-between mt-1",children:[le&&((g=Object.values(le).flat().find(l=>l.value===b))==null?void 0:g.label)||"S√©lectionnez une variable...",e.jsx(te,{className:"ml-2 h-4 w-4 opacity-50"})]})}),e.jsx(ae,{className:"w-[300px] p-0",align:"start",children:e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:Object.entries(le).map(([l,x])=>e.jsxs(rt.Fragment,{children:[e.jsx("div",{className:"px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 sticky top-0",children:l}),x.map(h=>e.jsx("button",{onClick:()=>j(h.value),className:"w-full px-3 py-2 text-left hover:bg-muted transition-colors text-sm",children:h.label},h.value))]},l))})})]})]}),(o==="signature"||o==="paraphe")&&e.jsxs("div",{children:[e.jsx(A,{htmlFor:"role",children:"R√¥le (liste ferm√©e)"}),e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(d,{variant:"outline",className:"w-full justify-between mt-1",children:[((n=be.find(l=>l.value===_))==null?void 0:n.label)||"S√©lectionnez un r√¥le...",e.jsx(te,{className:"ml-2 h-4 w-4 opacity-50"})]})}),e.jsx(ae,{className:"w-[300px] p-0",align:"start",children:e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:be.map(l=>e.jsx("button",{onClick:()=>I(l.value),className:"w-full px-3 py-2 text-left hover:bg-muted transition-colors",children:l.label},l.value))})})]})]}),o==="reserve_block"&&e.jsx("div",{className:"p-3 bg-gray-100 rounded-lg",children:e.jsx("p",{className:"text-sm text-gray-600",children:"‚ÑπÔ∏è Un bloc r√©serv√© n'a pas de configuration suppl√©mentaire"})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(d,{variant:"outline",onClick:N,children:"Annuler"}),e.jsx(d,{onClick:D,className:"bg-purple-600 hover:bg-purple-700",children:"Cr√©er le bloc"})]})]})},mt=v=>{if(!v)return[];const N=/\{\{([^}#/]+)\}\}/g,o=new Set;let p;for(;(p=N.exec(v))!==null;){const b=p[1].trim();o.add(b)}return Array.from(o)},ut=(v,N)=>{const o=[],p=v.filter(n=>!n.includes("signature")&&n!=="current_date"),b=p.some(n=>n.startsWith("client_")),j=p.some(n=>n.startsWith("company_")),_=new Set;p.forEach(n=>{const l=n.match(/^cosigner_.*_(\d+)$/);l&&_.add(Number(l[1]))});const I=p.filter(n=>n.startsWith("client_")),D=p.filter(n=>n.startsWith("company_")),i=p.filter(n=>n.match(/^cosigner_.*_\d+$/)),g=p.filter(n=>!n.startsWith("client_")&&!n.startsWith("company_")&&!n.match(/^cosigner_.*_\d+$/));return b&&j&&o.push({id:"__signer_type",label:"Type de signataire",type:"select",options:["Particulier","Soci√©t√©"],required:!0}),I.forEach(n=>{const l=O[n]||{label:n.replace(/_/g," ").replace(/\b\w/g,h=>h.toUpperCase()),type:"text"},x={id:n,label:l.label,type:l.type,required:l.required||!1,options:l.options||void 0,placeholder:l.placeholder||""};b&&j&&(x.show_if_conditions=[{field:"__signer_type",equals:"Particulier"}]),o.push(x)}),D.forEach(n=>{const l=O[n]||{label:n.replace(/_/g," ").replace(/\b\w/g,h=>h.toUpperCase()),type:"text"},x={id:n,label:l.label,type:l.type,required:l.required||!1,options:l.options||void 0,placeholder:l.placeholder||""};b&&j&&(x.show_if_conditions=[{field:"__signer_type",equals:"Soci√©t√©"}]),o.push(x)}),g.forEach(n=>{const l=O[n]||{label:n.replace(/_/g," ").replace(/\b\w/g,x=>x.toUpperCase()),type:"text"};o.push({id:n,label:l.label,type:l.type,required:l.required||!1,options:l.options||void 0,placeholder:l.placeholder||""})}),_.size>0&&(o.push({id:"__cosigner_count",label:"Nombre de co-signataires",type:"select",options:["0","1","2","3"],required:!0}),i.forEach(n=>{const l=O[n]||{label:n.replace(/_/g," ").replace(/\b\w/g,B=>B.toUpperCase()),type:"text"},x=n.match(/^cosigner_.*_(\d+)$/),h=x?Number(x[1]):1;o.push({id:n,label:l.label,type:l.type,required:l.required||!1,options:l.options||void 0,placeholder:l.placeholder||"",show_if_conditions:[{field:"__cosigner_count",gte:String(h)}]})})),o},bt=()=>{const v=$e(),{projectsData:N={}}=Ve(),{organizationId:o}=ke(),{templates:p,loading:b,createTemplate:j,updateTemplate:_,deactivateTemplate:I}=qe(o),D=[...Object.entries(N||{}).map(([t,a])=>({value:t,label:a.title||t}))],[i,g]=c.useState(null),[n,l]=c.useState(!1),[x,h]=c.useState(!1),[B,L]=c.useState(!1),[gt,ne]=c.useState(null),[w,U]=c.useState(null),[f,X]=c.useState(null),[ve,ye]=c.useState(!1),[y,C]=c.useState([]),[E,S]=c.useState(null),[_e,re]=c.useState(!1),[je,oe]=c.useState(!1),[z,M]=c.useState({x:0,y:0}),[fe,H]=c.useState(!1),[Ne,G]=c.useState(null),[J,we]=c.useState(null),[Y,Ce]=c.useState(!1);c.useEffect(()=>{const t=localStorage.getItem("shouldInjectHtml"),a=localStorage.getItem("generatedContractHtml"),r=localStorage.getItem("editingTemplateId"),s=localStorage.getItem("editingTemplateName");if(console.log("üîç useEffect injection check:",{shouldInject:t,hasGeneratedHtml:!!a,editingTemplateId:r,editingTemplateName:s,contractTemplatesCount:p==null?void 0:p.length}),t==="true"&&a){if(r){const m=p.find(Re=>Re.id===r);console.log("üîç Recherche template existant:",{editingTemplateId:r,found:!!m,templateName:m==null?void 0:m.name}),m?(g({...m,contentHtml:a}),u({title:"‚úÖ Template charg√©",description:`"${m.name}" - Cliquez sur Enregistrer pour sauvegarder les modifications`,duration:5e3,className:"bg-blue-500 text-white"})):console.warn("‚ö†Ô∏è Template non trouv√© dans contractTemplates")}else g(m=>({...m,name:s||(m==null?void 0:m.name)||"",projectType:(m==null?void 0:m.projectType)||"ACC",contentHtml:a})),u({title:"‚úÖ HTML inject√©",description:"Le contenu HTML a √©t√© ins√©r√©. Donnez un nom et enregistrez.",duration:4e3});localStorage.removeItem("shouldInjectHtml"),localStorage.removeItem("generatedContractHtml"),localStorage.removeItem("editingTemplateId"),localStorage.removeItem("editingTemplateName"),localStorage.removeItem("editingTemplateHtml")}},[p]),c.useEffect(()=>(document.body.style.overflow="auto",()=>{document.body.style.overflow=""}),[]);const ce=()=>{L(!0)},de=t=>{ne(t),L(!1),t==="manual"?g({name:"",projectType:"ACC",contentHtml:""}):t==="pdf"&&(localStorage.removeItem("editingTemplateId"),localStorage.removeItem("editingTemplateName"),localStorage.removeItem("editingTemplateHtml"),localStorage.removeItem("generatedContractHtml"),localStorage.removeItem("shouldInjectHtml"),v("/admin/contract-templates/editor"))},Se=t=>{var r;const a=(r=t.target.files)==null?void 0:r[0];if(a&&a.type==="application/pdf"){U(a);const s=URL.createObjectURL(a);X(s),u({title:"‚úÖ PDF charg√©",description:`${a.name} est pr√™t √† √™tre visualis√©`,className:"bg-green-500 text-white"})}else u({title:"‚ùå Erreur",description:"Veuillez s√©lectionner un fichier PDF valide",variant:"destructive"})},pe=()=>{f&&URL.revokeObjectURL(f),ye(!1),X(null),U(null),ne(null),C([]),S(null)},Te=()=>{const t={id:`block-${Date.now()}`,x:50,y:50,width:200,height:100,page:1};G(t),H(!0)},Ae=t=>{var r;const a={...Ne,type:t.type,variable:t.variable||null,role:t.role||null};C([...y,a]),S(a.id),H(!1),G(null),u({title:"‚úÖ Bloc ajout√©",description:`Bloc ${(r=P.find(s=>s.value===t.type))==null?void 0:r.label} cr√©√©`,className:"bg-green-500 text-white"})},Ie=t=>{C(y.filter(a=>a.id!==t)),E===t&&S(null),u({title:"üóëÔ∏è Bloc supprim√©",className:"bg-gray-500 text-white"})},De=(t,a)=>{a.stopPropagation(),S(t),re(!0),M({x:a.clientX,y:a.clientY})},Ee=(t,a)=>{a.stopPropagation(),S(t),oe(!0),M({x:a.clientX,y:a.clientY})},Le=t=>{if(E){if(_e){const a=t.clientX-z.x,r=t.clientY-z.y;C(y.map(s=>s.id===E?{...s,x:Math.max(0,s.x+a),y:Math.max(0,s.y+r)}:s)),M({x:t.clientX,y:t.clientY})}else if(je){const a=t.clientX-z.x,r=t.clientY-z.y;C(y.map(s=>s.id===E?{...s,width:Math.max(50,s.width+a),height:Math.max(30,s.height+r)}:s)),M({x:t.clientX,y:t.clientY})}}},me=()=>{re(!1),oe(!1)},ze=()=>{const t=y.map(a=>{const r={type:a.type,page:a.page,x:a.x,y:a.y,width:a.width,height:a.height};return a.type==="text_variable"&&a.variable&&(r.variable=a.variable),(a.type==="signature"||a.type==="paraphe")&&a.role&&(r.role=a.role),r});we(t),u({title:"‚úÖ JSON g√©n√©r√©",description:`${t.length} bloc(s) structur√©(s)`,className:"bg-green-500 text-white"})},ue=t=>{if(!t)return t;let a=t;return["if_individual","if_company","if_cosigner_1","if_cosigner_2","if_cosigner_3"].forEach(s=>{a=a.replace(new RegExp(`<p>\\s*\\{\\{#${s}\\}\\}\\s*<\\/p>`,"gi"),`{{#${s}}}`),a=a.replace(new RegExp(`<p>\\s*\\{\\{\\/${s}\\}\\}\\s*<\\/p>`,"gi"),`{{/${s}}}`),a=a.replace(new RegExp(`<p>(<br>)*\\s*\\{\\{#${s}\\}\\}\\s*<\\/p>`,"gi"),`{{#${s}}}`),a=a.replace(new RegExp(`<p>(<br>)*\\s*\\{\\{\\/${s}\\}\\}\\s*<\\/p>`,"gi"),`{{/${s}}}`),a=a.replace(new RegExp(`(<p>[^{]*?)\\{\\{#${s}\\}\\}\\s*<\\/p>`,"gi"),`$1</p>{{#${s}}}`),a=a.replace(new RegExp(`(<p>[^{]*?)\\{\\{\\/${s}\\}\\}\\s*<\\/p>`,"gi"),`$1</p>{{/${s}}}`),a=a.replace(new RegExp(`<p>\\{\\{#${s}\\}\\}([^<])`,"gi"),`{{#${s}}}<p>$1`),a=a.replace(new RegExp(`<p>\\{\\{\\/${s}\\}\\}([^<])`,"gi"),`{{/${s}}}<p>$1`)}),a},Me=async t=>{var s;l(!0);const a=!t.id,r=ue(t.contentHtml);console.log("üßπ Nettoyage HTML template:",{avant:(s=t.contentHtml)==null?void 0:s.substring(0,200),apr√®s:r==null?void 0:r.substring(0,200),diff√©rence:t.contentHtml!==r});try{const m=a?await j({name:t.name,projectType:t.projectType||"ACC",contentHtml:r||""}):await _(t.id,{name:t.name,projectType:t.projectType,contentHtml:r});m.success?(u({title:"‚úÖ Template enregistr√© !",description:`Le template "${t.name}" a √©t√© sauvegard√©.`,className:"bg-green-500 text-white"}),g(null)):u({title:"‚ùå Erreur",description:`Impossible d'enregistrer le template : ${m.error}`,variant:"destructive"})}finally{l(!1)}},He=async t=>{const a=await I(t);a.success?u({title:"‚úÖ Template d√©sactiv√© !",description:"Le template a √©t√© d√©sactiv√©.",className:"bg-green-500 text-white"}):u({title:"‚ùå Erreur",description:`Impossible de d√©sactiver le template : ${a.error}`,variant:"destructive"})},Fe=()=>{if(!(i!=null&&i.contentHtml)){u({title:"‚ùå Erreur",description:"Aucun contenu HTML √† analyser",variant:"destructive"});return}const t=mt(i.contentHtml);if(t.length===0){u({title:"‚ö†Ô∏è Aucune variable d√©tect√©e",description:"Le template ne contient pas de variables {{xxx}}",variant:"destructive"});return}const a=ut(t,i.contentHtml),r={name:`Formulaire - ${i.name}`,fields:a,projectIds:i.projectType?[i.projectType]:[],audience:"internal"};v("/admin/forms-management",{state:{prefilledForm:r}}),u({title:"üéØ Redirection vers le cr√©ateur de formulaire",description:`${a.length} champs pr√©-remplis √† partir des variables d√©tect√©es`,className:"bg-blue-500 text-white"})};return e.jsxs("div",{className:"flex flex-col min-h-screen",children:[e.jsx(Oe,{activeModule:"contrats"}),e.jsxs("div",{className:"flex-1 bg-gradient-to-br from-purple-50 via-white to-blue-50 p-4 sm:p-6 lg:p-8",children:[e.jsxs(F.div,{variants:dt,initial:"hidden",animate:"visible",className:"max-w-7xl mx-auto",children:[e.jsxs(F.div,{variants:se,className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:"üìÑ Templates de contrats"}),e.jsx("p",{className:"text-gray-600",children:"G√©rez vos mod√®les de contrats HTML pour chaque type de projet"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx(F.div,{variants:se,className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Mes templates"}),e.jsxs(d,{onClick:ce,className:"bg-purple-600 hover:bg-purple-700 w-full",children:[e.jsx(W,{className:"mr-2 h-4 w-4"})," Nouveau template"]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("label",{htmlFor:"show-inactive",className:"text-sm text-gray-700 cursor-pointer",children:"Afficher d√©sactiv√©s"}),e.jsx("input",{id:"show-inactive",type:"checkbox",checked:Y,onChange:t=>Ce(t.target.checked),className:"w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 cursor-pointer"})]})]}),e.jsx("div",{className:"space-y-2",children:b?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Chargement..."}):p.filter(t=>Y||t.isActive).length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(T,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"Aucun template"})]}):p.filter(t=>Y||t.isActive).map(t=>e.jsxs("button",{onClick:()=>g(t),className:`w-full text-left p-3 rounded-lg border-2 transition-all hover:shadow-md ${(i==null?void 0:i.id)===t.id?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-purple-300"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(T,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"font-medium text-sm truncate",children:t.name})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-6",children:[e.jsx("span",{className:"text-xs text-gray-500",children:t.projectType}),e.jsx("span",{className:"text-xs text-gray-400",children:"‚Ä¢"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["v",t.version]}),e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ml-auto ${t.isActive?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:t.isActive?"‚úÖ":"‚õî"})]})]},t.id))})]})}),e.jsx(F.div,{variants:se,className:"lg:col-span-3",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-card p-6",children:i?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:i.id?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"inline h-5 w-5 mr-2 text-purple-600"}),"Modifier le template"]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"inline h-5 w-5 mr-2 text-purple-600"}),"Cr√©er un nouveau template"]})}),i.id&&e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Version actuelle: v",i.version||1]})]}),e.jsx("div",{className:"flex items-center gap-2",children:i.id&&i.isActive&&e.jsxs(Pe,{children:[e.jsx(Be,{asChild:!0,children:e.jsx(d,{variant:"destructive",size:"sm",children:"D√©sactiver"})}),e.jsxs(Ue,{children:[e.jsxs(Xe,{children:[e.jsxs(Ge,{children:['D√©sactiver "',i.name,'" ?']}),e.jsx(Je,{children:"Le template sera marqu√© comme inactif mais restera dans la base."})]}),e.jsxs(Ye,{children:[e.jsx(We,{children:"Annuler"}),e.jsx(Ke,{onClick:()=>{He(i.id),g(null)},className:"bg-red-600 hover:bg-red-700",children:"D√©sactiver"})]})]})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"template-name",children:"Nom du template"}),e.jsx(Qe,{id:"template-name",value:i.name||"",onChange:t=>g(a=>({...a,name:t.target.value})),placeholder:"Ex: Contrat ACC Standard",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"template-project-type",children:"Type de projet (optionnel)"}),e.jsxs(Ze,{value:i.projectType||"",onValueChange:t=>g(a=>({...a,projectType:t==="TOUS"?null:t})),modal:!1,children:[e.jsx(et,{id:"template-project-type",className:"mt-1",children:e.jsx(tt,{placeholder:"Tous les projets"})}),e.jsxs(at,{children:[e.jsx(ge,{value:"TOUS",children:"üåç Tous les projets (universel)"}),D.map(t=>e.jsx(ge,{value:t.value,children:t.label},t.value))]})]})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"template-content",children:"Contenu HTML"}),e.jsx(lt,{id:"template-content",value:i.contentHtml||"",onChange:t=>g(a=>({...a,contentHtml:t.target.value})),placeholder:"Entrez le contenu HTML du contrat...",rows:20,className:"font-mono text-sm mt-1"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(d,{type:"button",variant:"outline",size:"sm",onClick:()=>{const t=ue(i.contentHtml);g(a=>({...a,contentHtml:t})),u({title:"üßπ HTML nettoy√© !",description:"Les balises conditionnelles ont √©t√© d√©plac√©es hors des <p>",className:"bg-green-500 text-white"})},className:"text-xs",children:"üßπ Nettoyer HTML maintenant"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Cliquez pour corriger automatiquement les balises conditionnelles"})]}),e.jsxs("div",{className:"mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("p",{className:"text-xs text-blue-800 font-semibold mb-1",children:"üí° Guide des balises conditionnelles:"}),e.jsxs("ul",{className:"text-xs text-blue-700 space-y-1 ml-4",children:[e.jsxs("li",{children:["‚Ä¢ ",e.jsxs("code",{className:"bg-blue-100 px-1 rounded",children:["{{#if_individual}}","...","{{/if_individual}}"]})," - Affiche si c'est un particulier"]}),e.jsxs("li",{children:["‚Ä¢ ",e.jsxs("code",{className:"bg-blue-100 px-1 rounded",children:["{{#if_company}}","...","{{/if_company}}"]})," - Affiche si c'est une soci√©t√©"]}),e.jsxs("li",{children:["‚Ä¢ ",e.jsxs("code",{className:"bg-blue-100 px-1 rounded",children:["{{#if_cosigner_1}}","...","{{/if_cosigner_1}}"]})," - Affiche si co-signataire 1 existe"]}),e.jsx("li",{className:"mt-2 text-blue-900 font-semibold",children:"‚ö†Ô∏è Important: Ces balises seront automatiquement nettoy√©es √† la sauvegarde"})]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsx(d,{variant:"outline",onClick:()=>g(null),children:"Annuler"}),e.jsxs("div",{className:"flex items-center gap-2",children:[i.id&&e.jsxs(d,{variant:"outline",onClick:()=>{localStorage.setItem("editingTemplateId",i.id),localStorage.setItem("editingTemplateName",i.name),localStorage.setItem("editingTemplateHtml",i.contentHtml||""),v("/admin/contract-templates/editor")},children:[e.jsx(K,{className:"mr-2 h-4 w-4"})," Ouvrir dans l'√©diteur PDF"]}),e.jsx(d,{variant:"secondary",onClick:()=>h(!0),disabled:!i.contentHtml||n,children:"üëÅÔ∏è Visualiser"}),e.jsx(d,{onClick:()=>Me(i),className:"bg-purple-600 hover:bg-purple-700",disabled:!i.name||!i.contentHtml||n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(st,{className:"mr-2 h-4 w-4 animate-spin"}),"Enregistrement..."]}):"Enregistrer"}),i.id&&e.jsxs(d,{onClick:Fe,className:"bg-teal-600 hover:bg-teal-700",disabled:!i.contentHtml,children:[e.jsx(ot,{className:"mr-2 h-4 w-4"})," G√©n√©rer formulaire"]})]})]})]}):e.jsxs("div",{className:"text-center py-20",children:[e.jsx(T,{className:"h-16 w-16 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-lg font-medium text-gray-700 mb-2",children:"S√©lectionnez un template"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"Choisissez un template dans la liste ou cr√©ez-en un nouveau"}),e.jsxs(d,{onClick:ce,className:"bg-purple-600 hover:bg-purple-700",children:[e.jsx(W,{className:"mr-2 h-4 w-4"})," Cr√©er un template"]})]})})})]})]}),e.jsx(R,{open:B,onOpenChange:L,children:e.jsxs($,{className:"sm:max-w-md",children:[e.jsxs(V,{children:[e.jsx(k,{children:"Choisissez votre m√©thode de cr√©ation"}),e.jsx(q,{children:"Comment souhaitez-vous cr√©er votre template de contrat ?"})]}),e.jsxs("div",{className:"space-y-3 py-6",children:[e.jsx("button",{onClick:()=>de("pdf"),className:"w-full p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all group",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center group-hover:bg-purple-200 transition-colors",children:e.jsx(T,{className:"h-6 w-6 text-purple-600"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-1",children:"üìÑ Importer un PDF et g√©n√©rer le HTML"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Uploadez un PDF, placez les champs dynamiques avec l'√©diteur visuel, puis g√©n√©rez automatiquement le HTML"})]})]})}),e.jsx("button",{onClick:()=>de("manual"),className:"w-full p-6 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all group",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(xe,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-1",children:"‚úçÔ∏è J'ai d√©j√† mon HTML"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Collez ou √©crivez directement votre HTML dans l'√©diteur. Parfait si vous avez d√©j√† pr√©par√© votre template"})]})]})})]}),e.jsx(Q,{children:e.jsx(d,{variant:"outline",onClick:()=>L(!1),children:"Annuler"})})]})}),e.jsx(R,{open:ve,onOpenChange:pe,children:e.jsxs($,{className:"sm:max-w-6xl max-h-[95vh]",children:[e.jsxs(V,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5 text-purple-600"}),"Visualisation du PDF"]}),e.jsx(q,{children:w?`${w.name} (${(w.size/1024).toFixed(2)} KB)`:"Importez un fichier PDF pour le visualiser"})]}),e.jsxs("div",{className:"space-y-4",children:[!f&&e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-purple-400 transition-colors",children:[e.jsx(K,{className:"h-16 w-16 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-medium text-gray-700 mb-2",children:"Importez votre fichier PDF"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Cliquez pour s√©lectionner ou glissez-d√©posez votre PDF"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"cursor-pointer",children:[e.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Se,className:"hidden"}),e.jsx(d,{asChild:!0,className:"bg-purple-600 hover:bg-purple-700",children:e.jsxs("span",{children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"S√©lectionner un PDF"]})})]})]}),f&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-100 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4 text-gray-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:w==null?void 0:w.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{variant:"default",size:"sm",onClick:Te,className:"bg-purple-600 hover:bg-purple-700",children:[e.jsx(he,{className:"h-4 w-4 mr-1"}),"Ajouter un bloc"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{f&&URL.revokeObjectURL(f),X(null),U(null),C([]),S(null)},children:[e.jsx(it,{className:"h-4 w-4 mr-1"}),"Changer de PDF"]})]})]}),e.jsx("div",{className:"border border-gray-300 rounded-lg overflow-hidden bg-gray-100",children:e.jsxs("div",{className:"h-[60vh] overflow-auto relative",onMouseMove:Le,onMouseUp:me,onMouseLeave:me,children:[e.jsx("iframe",{src:f,className:"w-full h-full",title:"PDF Viewer",style:{minHeight:"600px"}}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:e.jsx("div",{className:"relative w-full h-full pointer-events-auto",children:y.map(t=>{var r;const a=((r=P.find(s=>s.value===t.type))==null?void 0:r.label)||"üî∑";return e.jsxs("div",{className:`absolute border-2 bg-blue-500 bg-opacity-20 cursor-move transition-all ${E===t.id?"border-blue-600 shadow-lg":"border-blue-400"}`,style:{left:`${t.x}px`,top:`${t.y}px`,width:`${t.width}px`,height:`${t.height}px`},onMouseDown:s=>De(t.id,s),children:[e.jsx("div",{className:"absolute top-1 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-xs px-2 py-0.5 rounded",children:a}),e.jsx("div",{className:"absolute top-1 left-1 bg-blue-600 rounded p-1",children:e.jsx(ct,{className:"h-3 w-3 text-white"})}),e.jsx("button",{onClick:s=>{s.stopPropagation(),Ie(t.id)},className:"absolute top-1 right-1 bg-red-600 hover:bg-red-700 rounded p-1 transition-colors",children:e.jsx(nt,{className:"h-3 w-3 text-white"})}),e.jsx("div",{className:"absolute bottom-0 right-0 w-4 h-4 bg-blue-600 cursor-se-resize",onMouseDown:s=>Ee(t.id,s),style:{borderBottomRightRadius:"2px"}})]},t.id)})})})]})}),y.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-blue-700",children:[e.jsx(he,{className:"inline h-4 w-4 mr-1"}),y.length," bloc",y.length>1?"s":""," positionn√©",y.length>1?"s":""]}),e.jsx(d,{size:"sm",onClick:ze,className:"bg-green-600 hover:bg-green-700",children:"üìã G√©n√©rer JSON"})]}),J&&e.jsxs("div",{className:"p-3 bg-gray-900 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-xs text-gray-400 font-mono",children:"JSON g√©n√©r√©"}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(JSON.stringify(J,null,2)),u({title:"‚úÖ Copi√© !",description:"JSON copi√© dans le presse-papier",className:"bg-green-500 text-white"})},className:"text-xs text-blue-400 hover:text-blue-300",children:"üìã Copier"})]}),e.jsx("pre",{className:"text-xs text-green-400 font-mono overflow-auto max-h-60",children:JSON.stringify(J,null,2)})]})]})]})]}),e.jsx(Q,{className:"px-6 pb-4",children:e.jsx(d,{variant:"outline",onClick:pe,children:"Fermer"})})]})}),e.jsx(R,{open:fe,onOpenChange:H,children:e.jsxs($,{className:"sm:max-w-md overflow-visible",onOpenAutoFocus:t=>t.preventDefault(),onCloseAutoFocus:t=>t.preventDefault(),children:[e.jsxs(V,{children:[e.jsx(k,{children:"Configuration du bloc"}),e.jsx(q,{children:"Choisissez le type de bloc et ses param√®tres"})]}),e.jsx(pt,{onSave:Ae,onCancel:()=>{H(!1),G(null)}})]})}),e.jsx(R,{open:x,onOpenChange:h,children:e.jsxs($,{className:"sm:max-w-5xl max-h-[90vh]",children:[e.jsxs(V,{children:[e.jsxs(k,{children:["Pr√©visualisation : ",(i==null?void 0:i.name)||"Template"]}),e.jsx(q,{children:"Aper√ßu du rendu HTML du template de contrat"})]}),e.jsx("div",{className:"p-6 max-h-[70vh] overflow-y-auto bg-white border rounded-lg",children:e.jsx("div",{className:"prose max-w-none",dangerouslySetInnerHTML:{__html:(i==null?void 0:i.contentHtml)||""}})}),e.jsx(Q,{className:"px-6 pb-4",children:e.jsx(d,{onClick:()=>h(!1),children:"Fermer"})})]})})]})]})};export{bt as default};
