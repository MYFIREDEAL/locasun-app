import{c as Ot,r as i,R as jt,u as qs,j as e,m as et,C as ut,l as v,s as pe,a as xt,b as Je,d as Vs,e as it,f as Bs,g as Tt,h as pt,B as he,P as Lt,i as Ge,D as vt,k as wt,X as Ze,n as _t,o as St,U as nt,p as lt,M as It,q as zt,t as Ct,S as qt,v as Vt,w as Bt,x as Ht,y as ze,z as Wt,A as us,E as ms,T as Gt,F as gs,G as xs,H as ps,I as hs,J as fs,K as bs,L as js,N as X,O as ys,Q as Ve,V as Hs,W as Ns,Y as yt,Z as Ws,_ as vs,$ as Kt,a0 as Gs,a1 as Js,a2 as at,a3 as Xs,a4 as Ys,a5 as Ks,a6 as mt,a7 as Qs,a8 as ws,a9 as _s,aa as Zs,ab as Us,ac as qe,ad as Xe,ae as ht,af as Ss,ag as Is,ah as ea,ai as ta,aj as sa,ak as aa,al as ra,am as na,an as ia,ao as la,ap as oa,aq as ca,ar as da,as as ua,at as ma,au as ga,av as xa,aw as pa,ax as ha,ay as fa,az as ba,aA as ja}from"./index-ff6ab25d.js";import{u as ot,A as Cs,C as ya}from"./Agenda-09ef4059.js";import{S as Na}from"./SearchableSelect-5193f070.js";import{u as va}from"./useSupabaseProjectStepsStatus-36f589d2.js";import{F as wa,a as _a,P as Sa,b as Ia,e as Ca,u as ks,S as Jt,c as ka}from"./useSupabaseWorkflowModuleTemplates-81ce407b.js";import{f as tt,V as Ea}from"./index-13dbaf00.js";import{i as Aa}from"./workflowV2Config-f801420c.js";import{P as Nt}from"./pen-square-62cb0a95.js";import{P as Qt}from"./paperclip-28ecfe4b.js";import"./external-link-ec8ceceb.js";const Pa=Ot("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),Da=Ot("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),Ta=Ot("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function Ra(){for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];return i.useMemo(()=>r=>{a.forEach(x=>x(r))},a)}const Ma=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function $a(t){const a=Object.prototype.toString.call(t);return a==="[object Window]"||a==="[object global]"}function Fa(t){return"nodeType"in t}function Es(t){var a,n;return t?$a(t)?t:Fa(t)&&(a=(n=t.ownerDocument)==null?void 0:n.defaultView)!=null?a:window:window}const kt=Ma?i.useLayoutEffect:i.useEffect;function As(t){const a=i.useRef(t);return kt(()=>{a.current=t}),i.useCallback(function(){for(var n=arguments.length,r=new Array(n),x=0;x<n;x++)r[x]=arguments[x];return a.current==null?void 0:a.current(...r)},[])}function Rt(t,a){a===void 0&&(a=[t]);const n=i.useRef(t);return kt(()=>{n.current!==t&&(n.current=t)},a),n}function Mt(t){const a=As(t),n=i.useRef(null),r=i.useCallback(x=>{x!==n.current&&(a==null||a(x,n.current)),n.current=x},[]);return[n,r]}let Dt={};function Ps(t,a){return i.useMemo(()=>{if(a)return a;const n=Dt[t]==null?0:Dt[t]+1;return Dt[t]=n,t+"-"+n},[t,a])}function Oa(t){if(!t)return!1;const{KeyboardEvent:a}=Es(t.target);return a&&t instanceof a}const gt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:a,y:n}=t;return"translate3d("+(a?Math.round(a):0)+"px, "+(n?Math.round(n):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:a,scaleY:n}=t;return"scaleX("+a+") scaleY("+n+")"}},Transform:{toString(t){if(t)return[gt.Translate.toString(t),gt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:a,duration:n,easing:r}=t;return a+" "+n+"ms "+r}}});var dt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(dt||(dt={}));function Zt(){}const La=Object.freeze({x:0,y:0});function za(t){if(t.startsWith("matrix3d(")){const a=t.slice(9,-1).split(/, /);return{x:+a[12],y:+a[13],scaleX:+a[0],scaleY:+a[5]}}else if(t.startsWith("matrix(")){const a=t.slice(7,-1).split(/, /);return{x:+a[4],y:+a[5],scaleX:+a[0],scaleY:+a[3]}}return null}function qa(t,a,n){const r=za(a);if(!r)return t;const{scaleX:x,scaleY:g,x:h,y:f}=r,_=t.left-h-(1-x)*parseFloat(n),k=t.top-f-(1-g)*parseFloat(n.slice(n.indexOf(" ")+1)),y=x?t.width/x:t.width,b=g?t.height/g:t.height;return{width:y,height:b,top:k,right:_+y,bottom:k+b,left:_}}const Va={ignoreTransform:!1};function Xt(t,a){a===void 0&&(a=Va);let n=t.getBoundingClientRect();if(a.ignoreTransform){const{transform:k,transformOrigin:y}=Es(t).getComputedStyle(t);k&&(n=qa(n,k,y))}const{top:r,left:x,width:g,height:h,bottom:f,right:_}=n;return{top:r,left:x,width:g,height:h,bottom:f,right:_}}function Ut(t){return Xt(t,{ignoreTransform:!0})}var rt;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(rt||(rt={}));var es;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(es||(es={}));var Fe;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})(Fe||(Fe={}));Fe.Space,Fe.Enter,Fe.Esc,Fe.Space,Fe.Enter,Fe.Tab;var ts;(function(t){t[t.RightClick=2]="RightClick"})(ts||(ts={}));var ss;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(ss||(ss={}));var as;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(as||(as={}));rt.Backward+"",rt.Forward+"",rt.Backward+"",rt.Forward+"";var $t;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})($t||($t={}));var Ft;(function(t){t.Optimized="optimized"})(Ft||(Ft={}));function Ba(t){let{callback:a,disabled:n}=t;const r=As(a),x=i.useMemo(()=>{if(n||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:g}=window;return new g(r)},[n]);return i.useEffect(()=>()=>x==null?void 0:x.disconnect(),[x]),x}function Ha(t,a){return i.useMemo(()=>t.reduce((n,r)=>{let{eventName:x,handler:g}=r;return n[x]=h=>{g(h,a)},n},{}),[t,a])}$t.WhileDragging,Ft.Optimized;const Wa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Zt,draggableNodes:new Map,over:null,measureDroppableContainers:Zt},Ds=i.createContext(Wa),Ga=i.createContext({...La,scaleX:1,scaleY:1});var rs;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(rs||(rs={}));const Ja=i.createContext(null),ns="button",Xa="Draggable";function Ya(t){let{id:a,data:n,disabled:r=!1,attributes:x}=t;const g=Ps(Xa),{activators:h,activatorEvent:f,active:_,activeNodeRect:k,ariaDescribedById:y,draggableNodes:b,over:O}=i.useContext(Ds),{role:p=ns,roleDescription:$="draggable",tabIndex:D=0}=x??{},N=(_==null?void 0:_.id)===a,F=i.useContext(N?Ga:Ja),[E,w]=Mt(),[c,u]=Mt(),R=Ha(h,a),q=Rt(n);kt(()=>(b.set(a,{id:a,key:g,node:E,activatorNode:c,data:q}),()=>{const M=b.get(a);M&&M.key===g&&b.delete(a)}),[b,a]);const S=i.useMemo(()=>({role:p,tabIndex:D,"aria-disabled":r,"aria-pressed":N&&p===ns?!0:void 0,"aria-roledescription":$,"aria-describedby":y.draggable}),[r,p,D,N,$,y.draggable]);return{active:_,activatorEvent:f,activeNodeRect:k,attributes:S,isDragging:N,listeners:r?void 0:R,node:E,over:O,setNodeRef:w,setActivatorNodeRef:u,transform:F}}const Ka="Droppable",Qa={timeout:25};function Za(t){let{data:a,disabled:n=!1,id:r,resizeObserverConfig:x}=t;const g=Ps(Ka),{active:h,dispatch:f,over:_,measureDroppableContainers:k}=i.useContext(Ds),y=i.useRef({disabled:n}),b=i.useRef(!1),O=i.useRef(null),p=i.useRef(null),{disabled:$,updateMeasurementsFor:D,timeout:N}={...Qa,...x},F=Rt(D??r),E=i.useCallback(()=>{if(!b.current){b.current=!0;return}p.current!=null&&clearTimeout(p.current),p.current=setTimeout(()=>{k(Array.isArray(F.current)?F.current:[F.current]),p.current=null},N)},[N]),w=Ba({callback:E,disabled:$||!h}),c=i.useCallback((S,M)=>{w&&(M&&(w.unobserve(M),b.current=!1),S&&w.observe(S))},[w]),[u,R]=Mt(c),q=Rt(a);return i.useEffect(()=>{!w||!u.current||(w.disconnect(),b.current=!1,w.observe(u.current))},[u,w]),i.useEffect(()=>(f({type:dt.RegisterDroppable,element:{id:r,key:g,disabled:n,node:u,rect:O,data:q}}),()=>f({type:dt.UnregisterDroppable,key:g,id:r})),[r]),i.useEffect(()=>{n!==y.current.disabled&&(f({type:dt.SetDroppableDisabled,id:r,key:g,disabled:n}),y.current.disabled=n)},[r,g,n,f]),{active:h,rect:O,isOver:(_==null?void 0:_.id)===r,node:u,over:_,setNodeRef:R}}function Ts(t,a,n){const r=t.slice();return r.splice(n<0?r.length+n:n,0,r.splice(a,1)[0]),r}function bt(t){return t!==null&&t>=0}const Ua=t=>{let{rects:a,activeIndex:n,overIndex:r,index:x}=t;const g=Ts(a,r,n),h=a[x],f=g[x];return!f||!h?null:{x:f.left-h.left,y:f.top-h.top,scaleX:f.width/h.width,scaleY:f.height/h.height}},er="Sortable",tr=jt.createContext({activeIndex:-1,containerId:er,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Ua,disabled:{draggable:!1,droppable:!1}}),sr=t=>{let{id:a,items:n,activeIndex:r,overIndex:x}=t;return Ts(n,r,x).indexOf(a)},ar=t=>{let{containerId:a,isSorting:n,wasDragging:r,index:x,items:g,newIndex:h,previousItems:f,previousContainerId:_,transition:k}=t;return!k||!r||f!==g&&x===h?!1:n?!0:h!==x&&a===_},rr={duration:200,easing:"ease"},Rs="transform",nr=gt.Transition.toString({property:Rs,duration:0,easing:"linear"}),ir={roleDescription:"sortable"};function lr(t){let{disabled:a,index:n,node:r,rect:x}=t;const[g,h]=i.useState(null),f=i.useRef(n);return kt(()=>{if(!a&&n!==f.current&&r.current){const _=x.current;if(_){const k=Xt(r.current,{ignoreTransform:!0}),y={x:_.left-k.left,y:_.top-k.top,scaleX:_.width/k.width,scaleY:_.height/k.height};(y.x||y.y)&&h(y)}}n!==f.current&&(f.current=n)},[a,n,r,x]),i.useEffect(()=>{g&&h(null)},[g]),g}function or(t){let{animateLayoutChanges:a=ar,attributes:n,disabled:r,data:x,getNewIndex:g=sr,id:h,strategy:f,resizeObserverConfig:_,transition:k=rr}=t;const{items:y,containerId:b,activeIndex:O,disabled:p,disableTransforms:$,sortedRects:D,overIndex:N,useDragOverlay:F,strategy:E}=i.useContext(tr),w=cr(r,p),c=y.indexOf(h),u=i.useMemo(()=>({sortable:{containerId:b,index:c,items:y},...x}),[b,x,c,y]),R=i.useMemo(()=>y.slice(y.indexOf(h)),[y,h]),{rect:q,node:S,isOver:M,setNodeRef:re}=Za({id:h,data:u,disabled:w.droppable,resizeObserverConfig:{updateMeasurementsFor:R,..._}}),{active:de,activatorEvent:fe,activeNodeRect:_e,attributes:z,setNodeRef:H,listeners:I,isDragging:K,over:ue,setActivatorNodeRef:oe,transform:o}=Ya({id:h,data:u,attributes:{...ir,...n},disabled:w.draggable}),P=Ra(re,H),V=!!de,xe=V&&!$&&bt(O)&&bt(N),C=!F&&K,L=C&&xe?o:null,ie=xe?L??(f??E)({rects:D,activeNodeRect:_e,activeIndex:O,overIndex:N,index:c}):null,se=bt(O)&&bt(N)?g({id:h,items:y,activeIndex:O,overIndex:N}):c,W=de==null?void 0:de.id,ee=i.useRef({activeId:W,items:y,newIndex:se,containerId:b}),te=y!==ee.current.items,me=a({active:de,containerId:b,isDragging:K,isSorting:V,id:h,index:c,items:y,newIndex:ee.current.newIndex,previousItems:ee.current.items,previousContainerId:ee.current.containerId,transition:k,wasDragging:ee.current.activeId!=null}),ne=lr({disabled:!me,index:c,node:S,rect:q});return i.useEffect(()=>{V&&ee.current.newIndex!==se&&(ee.current.newIndex=se),b!==ee.current.containerId&&(ee.current.containerId=b),y!==ee.current.items&&(ee.current.items=y)},[V,se,b,y]),i.useEffect(()=>{if(W===ee.current.activeId)return;if(W&&!ee.current.activeId){ee.current.activeId=W;return}const Ne=setTimeout(()=>{ee.current.activeId=W},50);return()=>clearTimeout(Ne)},[W]),{active:de,activeIndex:O,attributes:z,data:u,rect:q,index:c,newIndex:se,items:y,isOver:M,isSorting:V,isDragging:K,listeners:I,node:S,overIndex:N,over:ue,setNodeRef:P,setActivatorNodeRef:oe,setDroppableNodeRef:re,setDraggableNodeRef:H,transform:ne??ie,transition:Ie()};function Ie(){if(ne||te&&ee.current.newIndex===c)return nr;if(!(C&&!Oa(fe)||!k)&&(V||me))return gt.Transition.toString({...k,property:Rs})}}function cr(t,a){var n,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(n=t==null?void 0:t.draggable)!=null?n:a.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:a.droppable}}Fe.Down,Fe.Right,Fe.Up,Fe.Left;const dr=t=>(t||"").toString().trim().toUpperCase(),ur=(t,a)=>{if(t.sortableId!==a.sortableId)return!1;const n=t.prospect,r=a.prospect;if(n.id!==r.id||n.name!==r.name||n.hasAppointment!==r.hasAppointment||n.updatedAt!==r.updatedAt)return!1;const x=n._projectContext||{},g=r._projectContext||{};if(x.projectType!==g.projectType||x.projectTitle!==g.projectTitle||x.stepLabel!==g.stepLabel)return!1;const h=n.tags||[],f=r.tags||[];return!(h.length!==f.length||h.some((_,k)=>_!==f[k])||t.projectsData!==a.projectsData||t.onClick!==a.onClick)},mr=({prospect:t,onClick:a,sortableId:n,projectsData:r={}})=>{var N,F,E,w,c,u,R;qs();const x=Array.isArray(t.tags)?t.tags:[],g=((N=t._projectContext)==null?void 0:N.projectTitle)||((F=t._projectContext)==null?void 0:F.projectType)||null,h=((E=t._projectContext)==null?void 0:E.projectType)||null;(w=t._projectContext)!=null&&w.stepLabel;const f=g?dr(g):null,_=n||(f?`${t.id}-${f}`:`${t.id}-${((c=t._projectContext)==null?void 0:c.projectType)||"default"}`),{attributes:k,listeners:y,setNodeRef:b,transform:O,transition:p,isDragging:$}=or({id:_,data:{prospect:t}}),D={transform:gt.Transform.toString(O),transition:p,zIndex:$?10:"auto",opacity:$?.8:1};return e.jsx("div",{ref:b,style:D,...k,...y,children:e.jsxs(et.div,{layoutId:`prospect-card-${_}`,whileHover:{y:-4,scale:1.02},onClick:a,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(ut,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[g&&x.includes(((u=t._projectContext)==null?void 0:u.projectType)||g)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((R=r[h])==null?void 0:R.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:g})}),x.filter(q=>q!==h).map(q=>{var re,de;const S=((re=r[q])==null?void 0:re.title)||q,M=((de=r[q])==null?void 0:de.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:S},q)})]})]})})},gr=i.memo(mr,ur);function xr({prospectId:t,projectType:a,currentStepIndex:n,prompt:r,sendNextAction:x}){const g=i.useRef(new Set);i.useRef(!1),i.useEffect(()=>{if(!t||!a||n===void 0||!r)return;v.info("ðŸ”„ Workflow action trigger activÃ©",{prospectId:t,projectType:a,currentStepIndex:n,promptName:r==null?void 0:r.name});const h=pe.channel(`workflow-forms-${t}-${a}-${n}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async f=>{const _=f.new;v.info("ðŸ” Form panel UPDATE reÃ§u",{panelId:_.id,prospectId:_.prospect_id,projectType:_.project_type,status:_.status,actionId:_.action_id,expectedProjectType:a});const k=_.project_type===a,y=_.status==="approved",b=!!_.action_id;if(k&&y&&b){const O=`${t}-${a}-${n}-${_.action_id}`;if(g.current.has(O)){v.warn("âš ï¸ Action dÃ©jÃ  exÃ©cutÃ©e, skip",{actionKey:O});return}g.current.add(O),v.info("âœ… Formulaire approuvÃ© â†’ Action suivante dans 2s",{formId:_.form_id,actionId:_.action_id}),setTimeout(()=>{v.info("ðŸš€ Envoi action suivante",{completedActionId:_.action_id}),x(_.action_id)},2e3)}}).subscribe();return()=>{pe.removeChannel(h)}},[t,a,n,r,x])}function pr({projectType:t,prospectId:a,enabled:n=!0}){const[r,x]=i.useState([]),[g,h]=i.useState(!1),[f,_]=i.useState(!1),[k,y]=i.useState(null),{organizationId:b}=xt(),O=i.useCallback(async()=>{if(!(!t||!n))try{h(!0),y(null);let N=pe.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});a&&(N=N.eq("prospect_id",a));const{data:F,error:E}=await N;if(E)throw E;x(F||[])}catch(N){v.error("Erreur rÃ©cupÃ©ration project notes:",{error:N.message}),y(N.message)}finally{h(!1)}},[t,a,n]);i.useEffect(()=>{if(!t||!n)return;O();const N=pe.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},F=>{x(E=>{const{eventType:w,new:c,old:u}=F;return w==="INSERT"?[c,...E]:w==="UPDATE"?E.map(R=>R.id===c.id?c:R):w==="DELETE"?E.filter(R=>R.id!==u.id):E})}).subscribe();return()=>{pe.removeChannel(N)}},[t,n,O]);const p=i.useCallback(async({content:N,createdBy:F,createdByName:E})=>{if(!(!t||!(N!=null&&N.trim())))try{if(_(!0),y(null),!b)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:w,error:c}=await pe.from("project_notes").insert([{project_type:t,prospect_id:a||null,content:N.trim(),created_by:F||null,created_by_name:E||null,organization_id:b}]).select().single();if(c)throw c;return x(u=>[w,...u]),w}catch(w){throw v.error("Erreur ajout project note:",{error:w.message}),y(w.message),w}finally{_(!1)}},[t,a,b]),$=i.useCallback(async(N,{content:F})=>{if(!(!N||!(F!=null&&F.trim())))try{_(!0),y(null);const{data:E,error:w}=await pe.from("project_notes").update({content:F.trim(),updated_at:new Date().toISOString()}).eq("id",N).select().single();if(w)throw w;return x(c=>c.map(u=>u.id===N?E:u)),E}catch(E){throw v.error("Erreur update project note:",{error:E.message}),y(E.message),E}finally{_(!1)}},[]),D=i.useCallback(async N=>{if(N)try{_(!0),y(null);const{error:F}=await pe.from("project_notes").delete().eq("id",N);if(F)throw F;x(E=>E.filter(w=>w.id!==N))}catch(F){throw v.error("Erreur suppression project note:",{error:F.message}),y(F.message),F}finally{_(!1)}},[]);return{notes:r,loading:g,saving:f,error:k,addNote:p,updateNote:$,deleteNote:D,refetch:O}}function hr({projectType:t,prospectId:a,currentUser:n,activeAdminUser:r}){var c;const{activeAdminUser:x}=Je(),g=r||x,[h,f]=i.useState(""),[_,k]=i.useState(!1),{getTemplateByType:y}=Vs(),b=y(t),O=(b==null?void 0:b.title)||t,{notes:p,loading:$,saving:D,error:N,addNote:F}=pr({projectType:t,prospectId:a,enabled:!!t}),{addHistoryEvent:E}=it({projectType:t,prospectId:a,enabled:!!t,activeAdminUser:g}),w=async()=>{if(h.trim())try{const u=await F({content:h,createdBy:(g==null?void 0:g.id)||(n==null?void 0:n.id),createdByName:(g==null?void 0:g.name)||(g==null?void 0:g.email)||(n==null?void 0:n.full_name)||(n==null?void 0:n.email)});u&&E&&await E({event_type:"note",title:"Note ajoutÃ©e",description:u.content||h.trim(),metadata:{source:"notes_tab"},createdBy:(g==null?void 0:g.id)||(n==null?void 0:n.id),createdByName:(g==null?void 0:g.name)||(g==null?void 0:g.email)||(n==null?void 0:n.full_name)||(n==null?void 0:n.email)}),f("")}catch(u){v.error(u)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${O}`:"Aucun projet sÃ©lectionnÃ©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne liÃ©e Ã  ce projetâ€¦",value:h,onChange:u=>f(u.target.value),disabled:!t||D}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"ðŸ–¼ï¸"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:w,disabled:!h.trim()||!t||D,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:D?"Enregistrementâ€¦":"Enregistrer la note"})]}),N&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",N]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes prÃ©cÃ©dentes"}),p&&p.length>3&&e.jsx("button",{onClick:()=>k(!_),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:_?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"RÃ©duire"}),e.jsx(Bs,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",p.length,")"]}),e.jsx(Tt,{className:"w-4 h-4"})]})})]}),$&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notesâ€¦"}),!$&&(p==null?void 0:p.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(c=_?p:p==null?void 0:p.slice(0,3))==null?void 0:c.map(u=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:u.created_by_name||u.created_by?`Par ${u.created_by_name||u.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:u.created_at&&new Date(u.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:u.content})]},u.id))})]})]})}const fr=({prospectId:t,projectType:a,activeAdminUser:n})=>{const{projectsData:r,appointments:x,updateAppointment:g,deleteAppointment:h,addAppointment:f,addCall:_,addTask:k,updateCall:y,updateTask:b,prospects:O}=Je(),[p,$]=i.useState(!1),[D,N]=i.useState(null),[F,E]=i.useState(null),{users:w}=pt(),{supabaseUserId:c}=ot(),{history:u,loading:R}=it({projectType:a,prospectId:t,enabled:!!a&&!!t,activeAdminUser:n}),q=i.useMemo(()=>!u||u.length===0?[]:u.filter(I=>I.event_type==="activity").sort((I,K)=>new Date(K.created_at)-new Date(I.created_at)),[u]),S=i.useMemo(()=>{const I={};return q.forEach(ue=>{var o;const oe=(o=ue.metadata)==null?void 0:o.appointment_id;oe&&(I[oe]||(I[oe]=[]),I[oe].push(ue))}),Object.entries(I).map(([ue,oe])=>{var V;const P=oe.sort((xe,C)=>new Date(C.created_at)-new Date(xe.created_at))[0];return{...P,currentStatus:((V=P.metadata)==null?void 0:V.status)||(P.title==="ActivitÃ© supprimÃ©e"?"deleted":"pending")}})},[q]),M=i.useMemo(()=>S?S.filter(I=>I.currentStatus==="pending"):[],[S]),re=i.useMemo(()=>S?S.filter(I=>I.currentStatus!=="pending"):[],[S]),de=I=>{switch((I==null?void 0:I.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(ut,{className:"h-4 w-4"});case"virtual":return e.jsx(Ea,{className:"h-4 w-4"});case"call":return e.jsx(lt,{className:"h-4 w-4"});case"task":return e.jsx(ya,{className:"h-4 w-4"});default:return e.jsx(ut,{className:"h-4 w-4"})}},fe=I=>{const K=(I==null?void 0:I.activity_type)||"appointment",ue=I==null?void 0:I.status;if(ue==="effectue"||ue==="completed")return"text-green-600 bg-green-50";if(ue==="annule")return"text-red-600 bg-red-50";if(ue==="reporte")return"text-yellow-600 bg-yellow-50";switch(K){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},_e=I=>{var K;return!x||!((K=I.metadata)!=null&&K.appointment_id)?null:x.find(ue=>ue.id===I.metadata.appointment_id)},z=I=>{const K=_e(I);K&&N(K)},H=I=>{N(null),E({...I,type:I.type}),$(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"ActivitÃ©s du projet"}),e.jsxs(he,{onClick:()=>{$(!p)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Lt,{className:"h-4 w-4 mr-2"}),"Ajouter une activitÃ©"]})]}),p&&e.jsx(Cs,{open:p,onOpenChange:I=>{I||E(null),$(I)},initialData:F||{contactId:t,projectId:a},defaultAssignedUserId:c,addAppointment:f,addCall:_,addTask:k,updateAppointment:g,updateCall:y,updateTask:b,prospects:O||[],users:w||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activitÃ©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activitÃ© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(I=>{const K=_e(I),ue=(K==null?void 0:K.title)||I.title||"ActivitÃ©",oe=K!=null&&K.start?new Date(K.start):new Date(I.created_at);return e.jsxs("div",{onClick:()=>z(I),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${fe(I.metadata)}`,children:de(I.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:ue}),(K==null?void 0:K.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:K.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:tt(oe,"d MMM 'Ã ' HH:mm",{locale:Ge})})]})]},I.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["PassÃ©es (",re.length,")"]}),R?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):re.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activitÃ© passÃ©e"}):e.jsx("div",{className:"space-y-2",children:re.map(I=>{const K=_e(I),ue=(K==null?void 0:K.title)||I.title||"ActivitÃ©",oe=K!=null&&K.start?new Date(K.start):new Date(I.created_at),o={effectue:"âœ… EffectuÃ©",annule:"âŒ AnnulÃ©",reporte:"ðŸ“… ReportÃ©",deleted:"ðŸ—‘ï¸ SupprimÃ©",completed:"âœ… TerminÃ©"}[I.currentStatus]||I.currentStatus;return e.jsxs("div",{onClick:()=>z(I),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${fe(I.metadata)}`,children:de(I.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:ue}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[o," â€¢ ",tt(oe,"d MMM yyyy 'Ã ' HH:mm",{locale:Ge})]})]})]},I.id)})})]}),D&&e.jsx(br,{event:D,onClose:()=>N(null),onReport:()=>{},onEdit:H,prospects:O,supabaseUsers:w,updateAppointment:g,deleteAppointment:h,projectsData:r})]})},br=({event:t,onClose:a,onReport:n,onEdit:r,prospects:x,supabaseUsers:g,updateAppointment:h,deleteAppointment:f,projectsData:_})=>{var w;const[k,y]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!x||!g||!h||!f||!_)return null;const b=x.find(c=>c.id===t.contactId),O=g.find(c=>c.id===t.assignedUserId||c.user_id===t.assignedUserId)||(b?g.find(c=>c.user_id===b.ownerId):null),p=c=>c?c.charAt(0).toUpperCase()+c.slice(1):"",$=(c,u,R={})=>{try{const q=new Date(c);return isNaN(q.getTime())?"Date invalide":tt(q,u,R)}catch{return"Date invalide"}},D=c=>{y(c),h(t.id,{status:c}),setTimeout(()=>{a(),c==="reporte"&&n(t)},300)},N=()=>{f(t.id),X({title:"âœ… RDV supprimÃ©",description:"Le rendez-vous a Ã©tÃ© retirÃ© de votre agenda."}),a()},F=c=>{if(!b){X({title:"Contact non trouvÃ©",variant:"destructive"});return}switch(c){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:X({title:`Action: ${c}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activitÃ©"},effectue:{color:"bg-green-500",label:"EffectuÃ©"},annule:{color:"bg-red-500",label:"AnnulÃ©"},reporte:{color:"bg-yellow-500",label:"ReportÃ©"}};return e.jsx(vt,{open:!!t,onOpenChange:c=>!c&&a(),children:e.jsxs(wt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:a,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ze,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p($(t.start,"eeee d MMMM",{locale:Ge}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Ge})," - ",$(t.end,"HH:mm",{locale:Ge})]})]}),e.jsx(_t,{className:"p-0 text-left space-y-1",children:e.jsx(St,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(nt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (AssignÃ©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:lt,label:"Appel"},{icon:It,label:"Mail"},{icon:zt,label:"WhatsApp"},{icon:Ct,label:"GPS"}].map(({icon:c,label:u})=>e.jsxs("button",{onClick:()=>F(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(c,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[k].color}`,children:e.jsxs(qt,{onValueChange:D,value:k,children:[e.jsx(Vt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Bt,{placeholder:"Qualifier votre activitÃ©"})}),e.jsxs(Ht,{children:[e.jsx(ze,{value:"pending",disabled:!0,children:"Qualifier votre activitÃ©"}),e.jsx(ze,{value:"effectue",children:"EffectuÃ©"}),e.jsx(ze,{value:"annule",children:"AnnulÃ©"}),e.jsx(ze,{value:"reporte",children:"ReportÃ©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activitÃ©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((w=_[t.projectId])==null?void 0:w.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ã‰tape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(Wt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(us,{children:[e.jsx(ms,{asChild:!0,children:e.jsxs(he,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Gt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(gs,{children:[e.jsxs(xs,{children:[e.jsx(ps,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(hs,{children:"Cette action est irrÃ©versible. Le rendez-vous sera dÃ©finitivement supprimÃ©."})]}),e.jsxs(fs,{children:[e.jsx(bs,{children:"Annuler"}),e.jsx(js,{onClick:N,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(he,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activitÃ©"})]})]})})},jr=({projectType:t,prospectId:a,currentUser:n,activeAdminUser:r})=>{const{activeAdminUser:x}=Je(),{organizationId:g}=xt(),h=r||x,[f,_]=i.useState(null),{files:k,loading:y,uploading:b,deleting:O,error:p,uploadFile:$,deleteFile:D}=ys({projectType:t,prospectId:a,organizationId:g,enabled:!!t}),{addHistoryEvent:N}=it({projectType:t,prospectId:a,enabled:!!t,activeAdminUser:h}),F=async S=>{const M=Array.from(S.target.files||[]);if(M.length!==0)try{const re=M.map(async de=>{_(de);const fe=await $({file:de,uploadedBy:n==null?void 0:n.id});return fe&&N&&await N({event_type:"file",title:"Fichier ajoutÃ©",description:fe.file_name,metadata:{size:fe.file_size,type:fe.file_type,storage_path:fe.storage_path},createdBy:(h==null?void 0:h.id)||(n==null?void 0:n.id),createdByName:(h==null?void 0:h.name)||(h==null?void 0:h.email)||(n==null?void 0:n.full_name)||(n==null?void 0:n.email)}),fe});await Promise.all(re),_(null),S.target.value=""}catch(re){v.error("Error uploading files:",re),_(null)}},E=async S=>{try{const{data:M,error:re}=await pe.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(re){v.error("Error creating signed URL:",re);return}const fe=await(await fetch(M.signedUrl)).blob(),_e=window.URL.createObjectURL(fe),z=document.createElement("a");z.href=_e,z.download=S.file_name,document.body.appendChild(z),z.click(),document.body.removeChild(z),window.URL.revokeObjectURL(_e)}catch(M){v.error("Error downloading file:",M)}},w=async S=>{try{v.debug("ðŸ‘ï¸ Generating signed URL for view",{storagePath:S.storage_path});const{data:M,error:re}=await pe.storage.from("project-files").createSignedUrl(S.storage_path,3600);if(re){v.error("Error creating signed URL:",re);return}v.debug("âœ… Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){v.error("Error viewing file:",M)}},c=async S=>{if(confirm(`Supprimer le fichier "${S.file_name}" ?`))try{await D(S.id,S.storage_path)}catch(M){v.error("Error deleting file:",M)}},u=S=>S!=null&&S.startsWith("image/")?e.jsx(Ws,{className:"h-5 w-5 text-blue-500"}):S==="application/pdf"?e.jsx(Ve,{className:"h-5 w-5 text-red-500"}):e.jsx(wa,{className:"h-5 w-5 text-gray-500"}),R=S=>S?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(S)):"",q=S=>S?S<1024?`${S} o`:S<1024*1024?`${(S/1024).toFixed(1)} Ko`:`${(S/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Hs,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:b?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents â€¢ SÃ©lection multiple possible â€¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:F,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:b,multiple:!0})]})}),p&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:p}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",k.length,")"]}),y?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):k.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Ve,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:k.map(S=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:u(S.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[S.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:S.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:S.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:S.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[q(S.file_size)," â€¢ ",R(S.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[S.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>w(S),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:O,children:e.jsx(Ns,{className:"h-4 w-4"})}),S.field_label==="Document signÃ©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"âœ“ SignÃ©"}),e.jsx("button",{onClick:()=>E(S),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"TÃ©lÃ©charger",disabled:O,children:e.jsx(yt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"â³ En attente"}),e.jsx("button",{onClick:()=>c(S),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:O,children:e.jsx(Gt,{className:"h-4 w-4"})})]})]},S.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stockÃ©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(Ve,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"SÃ©lectionnez un projet pour voir les fichiers"})]})},yr=({prospectId:t,projectType:a,activeAdminUser:n})=>{const[r,x]=i.useState("notes"),{supabaseUserId:g}=ot(),h=[{id:"notes",label:"Notes",icon:Ve},{id:"activity",label:"ActivitÃ©",icon:Pa},{id:"files",label:"Fichiers",icon:_a}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:h.map(({id:f,label:_,icon:k})=>e.jsxs("button",{onClick:()=>x(f),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===f?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{children:_})]},f))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(hr,{prospectId:t,projectType:a,currentUser:{id:g},activeAdminUser:n}),r==="activity"&&e.jsx(fr,{prospectId:t,projectType:a,activeAdminUser:n}),r==="files"&&e.jsx(jr,{prospectId:t,projectType:a,currentUser:{id:g},activeAdminUser:n})]})]})},Nr=({projectType:t,prospectId:a,activeAdminUser:n})=>{const{history:r,loading:x,error:g}=it({projectType:t,prospectId:a,enabled:!!t,activeAdminUser:n});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),x&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historiqueâ€¦"}),g&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",g]}),!x&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun Ã©vÃ©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(h=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.title||h.event_type}),h.description&&e.jsx("p",{className:"text-xs text-gray-600",children:h.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(h.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(h.created_by_name||h.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Par ",h.created_by_name||h.created_by]})]})]})]})]},h.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"SÃ©lectionnez un projet"})})},vr=({children:t,prospectId:a,projectType:n,currentStep:r,statusConfig:x,activeAdminUser:g})=>{var h,f,_;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(et.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((h=x[r.status])==null?void 0:h.iconOnly)||x.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((f=x[r.status])==null?void 0:f.badge)||x.pending.badge}`,children:((_=x[r.status])==null?void 0:_.label)||x.pending.label})]}),t]},r.name),!r&&!n&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Ve,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet sÃ©lectionnÃ©"}),e.jsx("p",{className:"text-gray-500",children:"SÃ©lectionnez un projet dans la liste ci-dessus pour voir le suivi dÃ©taillÃ©."})]})]}),n&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(yr,{prospectId:a,projectType:n,activeAdminUser:g}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(Nr,{prospectId:a,projectType:n,activeAdminUser:g})]})]})},wr={CLIENT:mt,COMMERCIAL:Qs,PARTENAIRE:nt},_r={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},Sr={FORM:Ve,SIGNATURE:Sa},Ir={FORM:"Formulaire",SIGNATURE:"Signature"},Cr=({isOpen:t,onClose:a,prospectId:n,projectType:r,moduleId:x,moduleName:g,moduleConfig:h,context:f={},availableForms:_=[],availableTemplates:k=[]})=>{var V,xe;const[y,b]=i.useState(null),[O,p]=i.useState(!1),[$,D]=i.useState(null),[N,F]=i.useState(!1),E=Aa(),w=i.useMemo(()=>h?h.actions&&h.actions.length>0?h.actions:h.actionConfig?[{order:1,status:"pending",actionConfig:h.actionConfig}]:[]:[],[h]),[c,u]=i.useState({}),[R,q]=i.useState(!1);i.useEffect(()=>{if(!t||!n||!x||w.length<=1){u({});return}(async()=>{q(!0);try{const L=w.map((W,ee)=>`v2-${x}-action-${ee}`),{data:j,error:ie}=await pe.from("client_form_panels").select("id, action_id, status").eq("prospect_id",n).eq("project_type",r).in("action_id",L),se={};if(!ie&&j&&j.length>0){for(const W of j)W.action_id&&(W.status==="approved"||W.status==="submitted")&&(se[W.action_id]=W.status);console.log("[V2 Robot] Action statuses by action_id:",se)}else{const{data:W}=await pe.from("client_form_panels").select("id, step_name, status").eq("prospect_id",n).eq("project_type",r).in("status",["approved","submitted"]);if(W){const ee=W.filter(te=>!te.step_name||te.step_name===g||te.step_name===x);ee.forEach((te,me)=>{me<w.length&&(se[`v2-${x}-action-${me}`]=te.status)}),console.log("[V2 Robot] Fallback legacy statuses:",se,"from",ee.length,"panels")}}u(se)}catch(L){console.error("[V2 Robot] Error fetching action statuses:",L)}finally{q(!1)}})()},[t,n,r,g,x,w.length]);const S=i.useMemo(()=>w.map((C,L)=>{const j=`v2-${x}-action-${L}`,ie=c[j];return{...C,actionId:j,realStatus:ie==="approved"?"validated":ie==="submitted"?"submitted":"pending"}}),[w,c,x]),[M,re]=i.useState(0);i.useEffect(()=>{if(t&&S.length>0&&!R){const C=S.findIndex(L=>L.realStatus!=="validated");re(C>=0?C:S.length-1)}},[t,S,R]);const de=S[M]||null,fe=S.length,_e=fe>1,z=i.useMemo(()=>{if(!de)return!1;const C=de.actionConfig;return!(!C||!C.actionType||!(Array.isArray(C.targetAudience)?C.targetAudience.length>0:!!C.targetAudience))},[de]),H=(de==null?void 0:de.actionConfig)||null,I=()=>{if(!z||!H){X({title:"Configuration incomplÃ¨te",description:"Aucune action configurÃ©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:H.allowedFormIds,currentActionFull:de,allActions:S.map((C,L)=>{var j;return{index:L,formIds:(j=C.actionConfig)==null?void 0:j.allowedFormIds}})});try{const C=Array.isArray(H.targetAudience)?H.targetAudience[0]:H.targetAudience,L=Ia({moduleId:x,moduleName:g,projectType:r,prospectId:n,actionIndex:M,actionConfig:{...H,targetAudience:C||"CLIENT"},message:""});b(L),D(null),console.log("[V2 Robot] ActionOrder gÃ©nÃ©rÃ©:",L)}catch(C){console.error("[V2 Robot] Erreur gÃ©nÃ©ration:",C),X({title:"Erreur",description:C.message,variant:"destructive"})}},K=async()=>{if(!y){X({title:"Aucun ordre",description:"Simulez d'abord pour gÃ©nÃ©rer un ActionOrder.",variant:"destructive"});return}if(!E){X({title:"ExÃ©cution dÃ©sactivÃ©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}p(!0),D(null);try{const C={...y,_meta:{...y._meta,isSimulation:!1}},L=await Ca(C,f);D(L),L.success?(X({title:"âœ… Action exÃ©cutÃ©e",description:L.message,className:"bg-green-500 text-white"}),setTimeout(()=>{a()},1e3)):X({title:"âš ï¸ ExÃ©cution bloquÃ©e",description:L.message,variant:"destructive"})}catch(C){console.error("[V2 Robot] Erreur exÃ©cution:",C),D({success:!1,status:"error",message:C.message}),X({title:"Erreur",description:C.message,variant:"destructive"})}finally{p(!1)}},ue=()=>{y&&(navigator.clipboard.writeText(JSON.stringify(y,null,2)),X({title:"CopiÃ© !",description:"ActionOrder JSON copiÃ© dans le presse-papiers."}))},oe=jt.useRef(M);i.useEffect(()=>{const C=oe.current!==M;if(oe.current=M,C&&(b(null),D(null)),t&&z&&!R&&(!y||C)){const L=setTimeout(()=>{I()},C?50:0);return()=>clearTimeout(L)}},[t,z,R,M]),i.useEffect(()=>{t||(b(null),D(null),F(!1),re(0))},[t]);const o=C=>{const L=_.find(j=>j.id===C);return(L==null?void 0:L.name)||C},P=C=>{const L=k.find(j=>j.id===C);return(L==null?void 0:L.name)||C};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(vs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[g||x,_e&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["â€” Action ",M+1,"/",fe]})]})]})]}),e.jsx("button",{onClick:a,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ze,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[_e&&z&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["ðŸ“‹ Ã‰tape ",M+1," sur ",fe]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," terminÃ©e",M>1?"s":"",")"]})]}),!z&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Kt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est dÃ©finie pour cette Ã©tape."}),e.jsxs(he,{variant:"outline",size:"sm",onClick:()=>{X({title:"Configurer cette Ã©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Gs,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),z&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:_e?`Action ${M+1}/${fe}`:"Action configurÃ©e"}),E&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(H==null?void 0:H.actionType)&&e.jsxs(e.Fragment,{children:[jt.createElement(Sr[H.actionType]||Ve,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:Ir[H.actionType]||H.actionType})]})}),(H==null?void 0:H.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(H.targetAudience)?H.targetAudience:[H.targetAudience]).map(C=>{const L=wr[C]||mt;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(L,{className:"h-3.5 w-3.5"}),_r[C]||C]},C)})]}),((V=H==null?void 0:H.allowedFormIds)==null?void 0:V.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",H.allowedFormIds.map(C=>o(C)).join(", ")]}),((xe=H==null?void 0:H.allowedTemplateIds)==null?void 0:xe.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",H.allowedTemplateIds.map(C=>P(C)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(H==null?void 0:H.managementMode)==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"]}),e.jsxs("span",{children:["VÃ©rif: ",(H==null?void 0:H.verificationMode)==="AI"?"âœ¨ IA":"ðŸ‘¤ Humain"]})]})]}),y&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>F(!N),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Js,{className:at("h-4 w-4 transition-transform",N&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:C=>{C.stopPropagation(),ue()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx(Xs,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),N&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(y,null,2)})]}),$&&e.jsxs("div",{className:at("rounded-lg p-4 flex items-start gap-3",$.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[$.success?e.jsx(Ys,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Kt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:at("font-medium text-sm",$.success?"text-green-800":"text-red-800"),children:[$.status==="executed"&&"ExÃ©cutÃ© avec succÃ¨s",$.status==="simulated"&&"Simulation uniquement",$.status==="blocked"&&"ExÃ©cution bloquÃ©e",$.status==="error"&&"Erreur"]}),e.jsx("p",{className:at("text-sm mt-1",$.success?"text-green-700":"text-red-700"),children:$.message})]})]})]})]}),z&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(he,{variant:"outline",onClick:I,disabled:O,children:[e.jsx(Ns,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(he,{onClick:K,disabled:!y||O||!E,className:at(!E&&"opacity-50 cursor-not-allowed"),children:[O?e.jsx(Ks,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Ta,{className:"h-4 w-4 mr-2"}),"ExÃ©cuter"]})]})]})}):null},Be="completed",Ee="in_progress",He="pending",ct={[Be]:{label:"TerminÃ©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[Ee]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[He]:{label:"Ã€ venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},is=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const a={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||He}))};if(t.status!==Ee)return a;if(!a.subSteps.some(r=>r.status===Ee)){const r=a.subSteps.findIndex(x=>x.status===He);r!==-1&&(a.subSteps=a.subSteps.map((x,g)=>({...x,status:g===r?Ee:x.status})))}return a},ls=(t,a,n)=>{var k;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,x=r?`${a}:${r}`:null,g=x&&n?n[x]:null,h=(k=g==null?void 0:g.configJson)==null?void 0:k.actions;if(!h||h.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const y=t.subSteps.map((b,O)=>{var N,F;const p=h[O],D=((F=(N=p==null?void 0:p.config)==null?void 0:N.objective)==null?void 0:F.trim())||(p==null?void 0:p.title)||(p==null?void 0:p.label);return{...b,name:D||b.name||`Action ${O+1}`}});return{...t,subSteps:y}}const f=t.status||He,_=h.map((y,b)=>{var O;return{id:y.id||`v2-${r}-action-${b}`,name:((O=y.config)==null?void 0:O.objective)&&y.config.objective.trim()||y.title||y.label||`Action ${b+1}`,status:f===Be?Be:f===Ee&&b===0?Ee:He}});return{...t,subSteps:_,status:f}},kr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(a=>a.status===Be),Er=({form:t,prospectId:a,onFormSubmit:n})=>{const[r,x]=i.useState({}),g=(f,_)=>{x(k=>({...k,[f]:_}))},h=()=>{n(a,t.id,r),X({title:"RÃ©ponses enregistrÃ©es",description:`Les rÃ©ponses au formulaire "${t.name}" ont Ã©tÃ© sauvegardÃ©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(f=>{if(f.show_if_conditions&&f.show_if_conditions.length>0){const k=f.condition_operator||"AND",y=f.show_if_conditions.map(O=>{const p=r[O.field];return O.equals==="has_value"?!!p&&p!=="":p===O.equals});if(!(k==="AND"?y.every(O=>O===!0):y.some(O=>O===!0)))return null}if(f.show_if){const k=f.show_if.field,y=f.show_if.equals,b=r[k];if(!b||b!==y)return null}return(t.fields||[]).some(k=>k.is_repeater&&(k.repeats_fields||[]).includes(f.id))?null:e.jsxs("div",{children:[e.jsx(qe,{htmlFor:`${t.id}-${f.id}`,children:f.label}),e.jsx(Xe,{id:`${t.id}-${f.id}`,type:f.type,value:typeof r[f.id]=="object"?"":r[f.id]||"",onChange:k=>g(f.id,k.target.value),placeholder:f.placeholder||""}),f.is_repeater&&f.repeats_fields&&f.repeats_fields.length>0&&r[f.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[f.id])||0},(k,y)=>{const b=(t.fields||[]).filter(O=>f.repeats_fields.includes(O.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[f.label," #",y+1]}),b.map(O=>{const p=`${f.id}_repeat_${y}_${O.id}`,$=r[p];return e.jsxs("div",{children:[e.jsx(qe,{htmlFor:`${t.id}-${p}`,children:O.label}),e.jsx(Xe,{id:`${t.id}-${p}`,type:O.type,value:typeof $=="object"?"":$||"",onChange:D=>g(p,D.target.value),placeholder:O.placeholder||""})]},p)})]},y)})})]},f.id)}),e.jsx(he,{onClick:h,className:"w-full",children:"Soumettre"})]})},Ar=({prospectId:t,projectType:a,currentStepIndex:n,activeAdminUser:r,initialChannel:x})=>{var ye,De;const{addChatMessage:g,prompts:h,projectsData:f,forms:_,updateProspect:k,prospects:y,completeStepAndProceed:b,registerClientForm:O}=Je(),{users:p,loading:$}=pt(),{messages:D,loading:N}=Is(t,a),{uploadFile:F,uploading:E}=ys({projectType:a,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:w}=it({projectType:a||"",prospectId:t,enabled:!!a&&!!t,activeAdminUser:r}),{user:c}=ot(),[u,R]=i.useState(""),[q,S]=i.useState(null),M=i.useRef(null),re=i.useRef(null),[de,fe]=i.useState(!1),[_e,z]=i.useState(!1),[H,I]=i.useState(x==="partner"?"partner":x==="internal"?"internal":"client"),[K,ue]=i.useState(null),[oe,o]=i.useState([]),{organizationId:P}=xt(),{partners:V,loading:xe}=ea(P||(r==null?void 0:r.organization_id));i.useEffect(()=>{if(!t||!a)return;(async()=>{try{const{data:m,error:l}=await pe.from("missions").select("id, partner_id, title, step_name, status, created_at").eq("prospect_id",t).eq("project_type",a).order("created_at",{ascending:!1});!l&&m&&o(m)}catch(m){v.error("âŒ Error loading partner missions for chat",m)}})()},[t,a]);const C=i.useMemo(()=>!oe.length||!V.length?[]:[...new Set(oe.map(m=>m.partner_id).filter(Boolean))].map(m=>{var G,Z,ge;const l=V.find(U=>U.id===m),T=oe.filter(U=>U.partner_id===m),Y=(ge=(Z=(G=f[a])==null?void 0:G.steps)==null?void 0:Z[n])==null?void 0:ge.name,B=T.some(U=>U.step_name===Y&&(U.status==="pending"||U.status==="in_progress"));return{id:m,name:(l==null?void 0:l.companyName)||(l==null?void 0:l.name)||(l==null?void 0:l.email)||"Partenaire inconnu",specialty:(l==null?void 0:l.specialty)||null,missionsCount:T.length,hasActiveStep:B,lastMission:T[0]}}).sort((m,l)=>m.hasActiveStep&&!l.hasActiveStep?-1:!m.hasActiveStep&&l.hasActiveStep?1:0),[oe,V,f,a,n]);i.useEffect(()=>{if(!K&&C.length>0){const s=C.find(m=>m.hasActiveStep);ue(s?s.id:C[0].id)}},[C,K]);const{templates:L,loading:j}=ks(P||(r==null?void 0:r.organization_id),a),{forms:ie,loading:se}=ta(P||(r==null?void 0:r.organization_id)),{templates:W,loading:ee}=sa(P||(r==null?void 0:r.organization_id)),te=(De=(ye=f[a])==null?void 0:ye.steps)==null?void 0:De[n],me=i.useMemo(()=>te!=null&&te.name?te.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${n}`,[te,n]),ne=i.useMemo(()=>{if(!L||!me)return null;const s=L[`${a}:${me}`];return(s==null?void 0:s.configJson)||null},[L,me,a]),Ie=i.useMemo(()=>ie?Object.values(ie).map(s=>({id:s.id,name:s.name||s.title||"Formulaire sans nom"})):[],[ie]),Ne=i.useMemo(()=>W?Array.isArray(W)?W.map(s=>({id:s.id,name:s.name||"Template sans nom"})):Object.values(W).map(s=>({id:s.id,name:s.name||"Template sans nom"})):[],[W]),Q=y.find(s=>s.id===t),Se=i.useMemo(()=>Object.values(h).filter(s=>{var l;if(s.projectId!==a)return!1;const m=(l=s.stepsConfig)==null?void 0:l[n];return m&&m.actions&&m.actions.length>0}),[h,a,n]),Me=i.useCallback(async(s=null)=>{var Y;const m=Se[0];if(!m){v.warn("Aucun prompt disponible");return}const l=(Y=m.stepsConfig)==null?void 0:Y[n];if(!l||!l.actions){v.warn("Aucune action dans la config de l'Ã©tape");return}const T=[...l.actions].sort((B,G)=>(B.order||0)-(G.order||0));if(s){const B=T.findIndex(G=>G.id===s);if(B!==-1&&B+1<T.length){const G=T[B+1];v.info("ðŸŽ¯ Action suivante trouvÃ©e",{completedActionId:s,nextActionId:G.id,nextActionType:G.type}),await We(m,G.id);return}else{v.warn("Pas d'action suivante",{completedActionId:s,totalActions:T.length});return}}await We(m)},[Se,n]);xr({prospectId:t,projectType:a,currentStepIndex:n,prompt:Se[0],sendNextAction:Me}),i.useEffect(()=>{requestAnimationFrame(()=>{var s;(s=M.current)==null||s.scrollIntoView({behavior:"smooth",block:"end"})})},[D,H]);const Pe=async()=>{if(!(!u.trim()&&!q))try{let s=null;if(q){if(q.size>10485760){X({title:"âŒ Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}v.debug("ðŸ“¤ Uploading file from admin chat",{name:q.name,size:q.size,type:q.type});const{data:{user:T}}=await pe.auth.getUser(),Y=await F({file:q,uploadedBy:T==null?void 0:T.id});Y&&(s={id:Y.id,name:Y.file_name,size:Y.file_size,type:Y.file_type,storagePath:Y.storage_path},v.debug("âœ… File uploaded successfully",s))}const m={sender:"pro",text:u,file:s,channel:H,...H==="internal"&&{metadata:{sender_id:(r==null?void 0:r.user_id)||null,sender_name:(r==null?void 0:r.name)||"Admin",target_user_id:A||null}},...H==="partner"&&K&&{partnerId:K}};g(t,a,m),R(""),S(null),requestAnimationFrame(()=>{var l;(l=M.current)==null||l.scrollIntoView({behavior:"smooth",block:"end"})}),s&&X({title:"âœ… Fichier envoyÃ©",description:`${s.name} a Ã©tÃ© envoyÃ© avec succÃ¨s.`})}catch(s){v.error("âŒ Error sending message with file",s),X({title:"âŒ Erreur",description:`Impossible d'envoyer le fichier : ${s.message}`,variant:"destructive"})}},Ye=s=>{s.target.files&&s.target.files[0]&&S(s.target.files[0])},Re=async s=>{if(!s||!s.storagePath){X({title:"âŒ Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{v.debug("ðŸ“¥ Downloading file",{storagePath:s.storagePath});const{data:m,error:l}=await pe.storage.from("project-files").createSignedUrl(s.storagePath,3600);if(l)throw l;window.open(m.signedUrl,"_blank"),X({title:"âœ… TÃ©lÃ©chargement",description:`${s.name} s'ouvre dans un nouvel onglet.`})}catch(m){v.error("âŒ Error downloading file",m),X({title:"âŒ Erreur",description:`Impossible de tÃ©lÃ©charger le fichier : ${m.message}`,variant:"destructive"})}},Ke=(s,m,l)=>{var Z;const T=y.find(ge=>ge.id===s);if(!T)return;const Y={...T.formData||{},...l};k({...T,formData:Y});const B={sender:"client",text:`A complÃ©tÃ© le formulaire : ${((Z=_[m])==null?void 0:Z.name)||"Formulaire"}.`};if(g(s,a,B),Object.values(h).find(ge=>{var Ae,$e;if(ge.projectId!==a)return!1;const U=(Ae=ge.stepsConfig)==null?void 0:Ae[n];return U!=null&&U.autoCompleteStep?($e=U.actions)==null?void 0:$e.some(Le=>Le.type==="show_form"&&Le.formId===m):!1})){const ge=ne==null?void 0:ne.actions;if(ge&&ge.length>1){X({title:"âœ… Formulaire reÃ§u",description:"Il reste d'autres actions Ã  complÃ©ter pour cette Ã©tape.",className:"bg-blue-500 text-white"});return}b(t,a,n),X({title:"Ã‰tape terminÃ©e !",description:"L'Ã©tape a Ã©tÃ© automatiquement marquÃ©e comme terminÃ©e.",className:"bg-green-500 text-white"})}},We=async(s,m=null)=>{var T,Y,B,G,Z,ge,U,Ae;const l=(T=s.stepsConfig)==null?void 0:T[n];if(l&&l.actions&&l.actions.length>0){const $e=D,Le=[...l.actions].sort((be,ke)=>(be.order||0)-(ke.order||0));let Ce=Le,ve=!1;if(m){const be=Le.find(ke=>ke.id===m);if(!be){v.warn("Action spÃ©cifique introuvable",{specificActionId:m});return}v.info("ðŸŽ¯ ExÃ©cution action spÃ©cifique (forcÃ©e)",{actionId:m,actionType:be.type}),Ce=[be],ve=!0}for(const be of Ce)if(!(!ve&&$e.some(Te=>Te.promptId===s.id&&Te.stepIndex===n&&(Te.text===be.message||Te.formId===be.formId&&be.type==="show_form")))){if(be.message){const ke={sender:"pro",text:be.message,promptId:s.id,stepIndex:n,actionId:be.id};g(t,a,ke)}if(be.type==="show_form"&&be.formId){const ke={sender:"pro",formId:be.formId,promptId:s.id,stepIndex:n,actionId:be.id};g(t,a,ke);const Te=((G=(B=(Y=f[a])==null?void 0:Y.steps)==null?void 0:B[n])==null?void 0:G.name)||"Ã‰tape inconnue";try{const we=await O({prospectId:t,projectType:a,formId:be.formId,currentStepIndex:n,promptId:s.id,messageTimestamp:Date.now(),status:"pending",stepName:Te,actionId:be.id});if(!we.success)v.error("âŒ Ã‰chec enregistrement formulaire:",we.error),X({title:"Erreur",description:"Le formulaire n'a pas pu Ãªtre enregistrÃ©.",variant:"destructive"});else try{const Ue=((Z=_[be.formId])==null?void 0:Z.name)||be.formId;await w({prospectId:t,projectType:a,title:"Formulaire envoyÃ©",description:`Le formulaire ${Ue} a Ã©tÃ© envoyÃ© Ã  ${(Q==null?void 0:Q.name)||"le client"}.`,createdBy:(c==null?void 0:c.user_id)||null,createdByName:(c==null?void 0:c.name)||"Admin"})}catch(Ue){v.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",Ue)}}catch(we){v.error("âŒ Exception enregistrement formulaire:",we),X({title:"Erreur",description:"Le formulaire n'a pas pu Ãªtre enregistrÃ©.",variant:"destructive"})}}if(be.type==="start_signature"&&be.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de gÃ©nÃ©rer le contrat");v.info("ðŸ”¥ GÃ©nÃ©ration contrat via workflow sÃ©quentiel",{templateId:be.templateId,prospectId:t,projectType:a,organizationId:r.organization_id,formId:be.formId});const{data:ke,error:Te}=await pe.from("prospects").select("form_data").eq("id",t).single(),we=((U=(ge=ke==null?void 0:ke.form_data)==null?void 0:ge[a])==null?void 0:U[be.formId])||{};v.info("ðŸ“‹ DonnÃ©es formulaire extraites",{formId:be.formId,dataKeys:Object.keys(we)}),X({title:"ðŸ“„ GÃ©nÃ©ration du contrat...",description:"CrÃ©ation du PDF en cours",className:"bg-blue-500 text-white"});const Ue=await ka({templateId:be.templateId,projectType:a,prospectId:t,formData:we,organizationId:r==null?void 0:r.organization_id});if(Ue.success){const Et=Ue.fileData.id;v.debug("CrÃ©ation procÃ©dure de signature...",{fileId:Et,prospectId:t,projectType:a});const{data:Ms}=await pe.from("signature_procedures").select("*").eq("file_id",Et).eq("prospect_id",t).eq("status","pending").maybeSingle();let st=Ms;if(!st){const ft=crypto.randomUUID(),At=new Date;At.setDate(At.getDate()+7);const Yt=[{role:"principal",name:(Q==null?void 0:Q.name)||"Client",email:Q==null?void 0:Q.email,phone:(Q==null?void 0:Q.phone)||null,access_token:ft,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de crÃ©er la procÃ©dure de signature");const Os=typeof(Q==null?void 0:Q.name)=="string"&&Q.name.trim()!==""?Q.name:((Ae=Q==null?void 0:Q.email)==null?void 0:Ae.split("@")[0])||"Client",Ls=Q==null?void 0:Q.email,{data:zs,error:Pt}=await pe.from("signature_procedures").insert({prospect_id:t,project_type:a,file_id:Et,access_token:ft,access_token_expires_at:At.toISOString(),status:"pending",signers:Yt,organization_id:r.organization_id,signer_name:Os,signer_email:Ls}).select().single();if(Pt)throw v.error("Erreur crÃ©ation signature_procedures",Pt),Pt;st=zs,v.debug("ProcÃ©dure de signature crÃ©Ã©e",{procedureId:st.id,signersCount:Yt.length})}const $s=`https://evatime.fr/signature/${st.id}?token=${st.access_token}`,{data:Fs}=await pe.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",a).eq("sender","pro").ilike("text",`%/signature/${st.id}%`).maybeSingle();Fs||(await pe.from("chat_messages").insert({prospect_id:t,project_type:a,sender:"pro",text:`<a href="${$s}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">ðŸ‘‰ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id,channel:"client"}),v.debug("Lien de signature envoyÃ© dans le chat")),X({title:"âœ… Contrat gÃ©nÃ©rÃ© !",description:"Le contrat a Ã©tÃ© crÃ©Ã© et le lien de signature envoyÃ©.",className:"bg-green-500 text-white"});try{await w({prospectId:t,projectType:a,title:"Contrat gÃ©nÃ©rÃ©",description:`Le contrat a Ã©tÃ© gÃ©nÃ©rÃ© et envoyÃ© Ã  ${(Q==null?void 0:Q.name)||"le client"}.`,createdBy:(c==null?void 0:c.user_id)||null,createdByName:(c==null?void 0:c.name)||"Admin"})}catch(ft){v.error("âš ï¸ Erreur ajout Ã©vÃ©nement historique:",ft)}}else throw new Error(Ue.error||"Erreur inconnue")}catch(ke){v.error("âŒ Exception gÃ©nÃ©ration contrat:",ke),X({title:"Erreur",description:`Impossible de gÃ©nÃ©rer le contrat: ${ke.message}`,variant:"destructive"})}break}}fe(!1)},Oe=D.filter(s=>!s.channel||s.channel==="client"),je=D.filter(s=>s.channel==="partner"),ce=K?je.filter(s=>s.partnerId===K):je,le=D.filter(s=>s.channel==="internal"),d=H==="partner"?ce:H==="internal"?le:Oe,[A,J]=i.useState(null),ae=i.useMemo(()=>{const s=(p||[]).filter(U=>U.user_id!==(r==null?void 0:r.user_id)).filter(U=>U.role!=="Partner"),m=Q==null?void 0:Q.ownerId,l=s.find(U=>U.user_id===m),T=l!=null&&l.manager_id?s.find(U=>U.id===l.manager_id):null,Y=new Set;l&&Y.add(l.user_id),T&&Y.add(T.user_id);const B={"Global Admin":0,Admin:1,Manager:2,Commercial:3},G=s.filter(U=>!Y.has(U.user_id)).sort((U,Ae)=>(B[U.role]??9)-(B[Ae.role]??9)),Z=[];l&&Z.push({...l,tag:"ðŸ‘‘ Owner"}),T&&Z.push({...T,tag:"ðŸ‘¤ Manager"});let ge=null;return G.forEach(U=>{U.role!==ge&&(ge=U.role,Z.push({isSeparator:!0,role:ge})),Z.push(U)}),Z},[p,r,Q==null?void 0:Q.ownerId]);return i.useEffect(()=>{if(!A&&(Q!=null&&Q.ownerId)){const s=Q.ownerId===(r==null?void 0:r.user_id),m=ae.find(l=>!l.isSeparator);s&&m?J(m.user_id):s||J(Q.ownerId)}},[Q==null?void 0:Q.ownerId,r==null?void 0:r.user_id,ae]),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex mb-3 rounded-xl overflow-hidden border-2 border-gray-200",children:[e.jsxs("button",{onClick:()=>I("client"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${H==="client"?"bg-blue-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["ðŸ’¬ Client",Oe.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${H==="client"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:Oe.length})]}),e.jsxs("button",{onClick:()=>I("partner"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${H==="partner"?"bg-orange-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["ðŸŸ  Partenaire",ce.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${H==="partner"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:ce.length})]}),e.jsxs("button",{onClick:()=>I("internal"),className:`flex-1 flex items-center justify-center gap-2 py-3 text-sm font-bold transition-all ${H==="internal"?"bg-purple-500 text-white shadow-inner":"bg-gray-50 text-gray-500 hover:bg-gray-100"}`,children:["ðŸ‘¥ Interne",le.length>0&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-semibold ${H==="internal"?"bg-white/25 text-white":"bg-gray-200 text-gray-600"}`,children:le.length})]})]}),H==="internal"&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("span",{className:"text-sm text-purple-600 font-bold whitespace-nowrap",children:"â†’ Ã€ :"}),e.jsxs("select",{value:A||"",onChange:s=>J(s.target.value),className:"flex-1 text-sm border-2 border-purple-300 rounded-xl px-3 py-2.5 bg-purple-50 text-purple-900 font-semibold focus:ring-2 focus:ring-purple-400 focus:border-purple-400 focus:outline-none appearance-none cursor-pointer shadow-sm",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237c3aed' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"},children:[ae.filter(s=>!s.isSeparator).length===0&&e.jsx("option",{value:"",children:"Aucun collÃ¨gue disponible"}),ae.map((s,m)=>s.isSeparator?e.jsx("optgroup",{label:`â”€â”€ ${s.role} â”€â”€`},`sep-${m}`):e.jsx("option",{value:s.user_id,children:s.tag?`${s.tag}  Â·  ${s.name||s.email}`:s.name||s.email},s.user_id))]})]}),H==="partner"&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("span",{className:"text-sm text-orange-600 font-bold whitespace-nowrap",children:"ðŸŸ  Ã€ :"}),e.jsxs("select",{value:K||"",onChange:s=>ue(s.target.value),className:"flex-1 text-sm border-2 border-orange-300 rounded-xl px-3 py-2.5 bg-orange-50 text-orange-900 font-semibold focus:ring-2 focus:ring-orange-400 focus:border-orange-400 focus:outline-none appearance-none cursor-pointer shadow-sm",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23ea580c' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"},children:[C.length===0&&e.jsx("option",{value:"",children:"Aucun partenaire sur ce projet"}),C.map(s=>e.jsxs("option",{value:s.id,children:[s.hasActiveStep?"âš¡ ":"",s.name,s.specialty?` Â· ${s.specialty}`:""," (",s.missionsCount," mission",s.missionsCount>1?"s":"",")"]},s.id))]})]}),e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[d.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400 text-sm",children:H==="partner"?"ðŸŸ  Aucun message partenaire":H==="internal"?"ðŸ‘¥ Aucun message interne":"ðŸ’¬ Aucun message client"}),d.map((s,m)=>{var U,Ae,$e,Le;const l=s.sender==="pro"||s.sender==="admin",T=s.sender==="partner",Y=s.sender==="client",B=s.channel==="internal",G=B&&((U=s.metadata)==null?void 0:U.sender_id)===(r==null?void 0:r.user_id),Z=B&&!G,ge=B?G:l;return e.jsxs("div",{className:`flex items-end gap-2 ${ge?"justify-end":"justify-start"}`,children:[Y&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(Q==null?void 0:Q.name.charAt(0))||"?"}),T&&(()=>{const Ce=C.find(be=>be.id===s.partnerId),ve=Ce?Ce.name.charAt(0).toUpperCase():"P";return e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center font-bold text-white text-xs",title:(Ce==null?void 0:Ce.name)||"Partenaire",children:ve})})(),Z&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-400 flex items-center justify-center font-bold text-white text-xs",children:(((Ae=s.metadata)==null?void 0:Ae.sender_name)||"?").charAt(0).toUpperCase()}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${B?G?"bg-purple-500 text-white rounded-br-none p-2.5":"bg-purple-100 text-purple-900 rounded-bl-none p-3 border border-purple-200":l?"bg-blue-500 text-white rounded-br-none p-2.5":T?"bg-orange-100 text-orange-900 rounded-bl-none p-3 border border-orange-200":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[B&&(($e=s.metadata)==null?void 0:$e.sender_name)&&e.jsxs("span",{className:`inline-block text-xs font-bold mb-1 ${G?"text-purple-200":"text-purple-600"}`,children:["ðŸ‘¥ ",s.metadata.sender_name]}),T&&e.jsxs("span",{className:"inline-block text-xs font-bold text-orange-600 mb-1",children:["ðŸŸ  ",((Le=C.find(Ce=>Ce.id===s.partnerId))==null?void 0:Le.name)||"Partenaire"]}),s.channel==="partner"&&l&&e.jsx("span",{className:"inline-block text-xs font-bold text-orange-300 mb-1",children:"â†’ Partenaire"}),s.text&&(l&&s.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:s.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:s.text})),s.file&&e.jsxs("button",{onClick:()=>Re(s.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(Ve,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.file.name}),e.jsx(yt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),s.formId&&_[s.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(Er,{form:_[s.formId],prospectId:t,onFormSubmit:Ke})}),e.jsx("p",{className:`text-xs mt-1 ${B?G?"text-purple-200":"text-purple-400":l?"text-blue-200":T?"text-orange-400":"text-gray-500"}`,children:aa(new Date(s.timestamp),{addSuffix:!0,locale:Ge})})]}),G&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center font-bold text-white text-xs",children:((r==null?void 0:r.name)||"?").charAt(0).toUpperCase()}),l&&!B&&!s.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},m)}),e.jsx("div",{ref:M})]}),q&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Qt,{className:"w-4 h-4"}),e.jsx("span",{children:q.name}),e.jsx("button",{onClick:()=>S(null),className:"text-red-500",children:"Ã—"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{placeholder:H==="internal"?"ðŸ‘¥ Ã‰crire en interne...":H==="partner"?"ðŸŸ  Ã‰crire au partenaire...":"ðŸ’¬ Ã‰crire au client...",className:`pr-28 h-12 ${H==="internal"?"border-purple-300 focus:ring-purple-400":H==="partner"?"border-orange-300 focus:ring-orange-400":""}`,value:u,onChange:s=>R(s.target.value),onKeyPress:s=>s.key==="Enter"&&Pe()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(he,{variant:"ghost",size:"icon",onClick:()=>z(!0),title:"Workflow V2 - Actions automatisÃ©es",children:e.jsx(vs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(he,{variant:"ghost",size:"icon",onClick:()=>re.current.click(),disabled:E,children:e.jsx(Qt,{className:`h-5 w-5 ${E?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:re,onChange:Ye,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:E}),e.jsx(he,{onClick:Pe,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:E,children:E?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(ra,{className:"h-4 w-4"})})]})]}),e.jsx(Cr,{isOpen:_e,onClose:()=>z(!1),prospectId:t,projectType:a,moduleId:me,moduleName:(te==null?void 0:te.name)||`Ã‰tape ${n+1}`,moduleConfig:ne,context:{organizationId:P||(r==null?void 0:r.organization_id),adminUser:r},availableForms:Ie,availableTemplates:Ne})]})},Pr=({steps:t,onUpdateStatus:a,prompts:n,projectType:r,currentStepIndex:x,prospectId:g,completeStepAndProceed:h})=>{var N;if(!t)return null;const[f,_]=i.useState({}),{activeAdminUser:k,appointments:y,updateAppointment:b}=Je(),O=n?Object.values(n).find(F=>F.projectId===r):null,p=(N=O==null?void 0:O.stepsConfig)==null?void 0:N[x],$=i.useMemo(()=>{if(!t[x])return[];const F=t[x].name,E=y.filter(w=>w.type==="task"&&w.contactId===g&&w.projectId===r&&w.step===F);return E.length>0&&v.debug("ðŸ” TÃ¢ches filtrÃ©es pour cette Ã©tape:",{prospectId:g,projectType:r,stepName:F,totalAppointments:y.length,filteredTasks:E.length,tasks:E.map(w=>({id:w.id,title:w.title,contactId:w.contactId,projectId:w.projectId,step:w.step}))}),E},[y,g,r,x,t]),D=(F,E)=>{_(w=>{var S;const c=w[F]||{},u={...c,[E]:!c[E]},R={...w,[F]:u},q=(S=p==null?void 0:p.actions)==null?void 0:S.find(M=>M.id===F);return q&&q.checklist&&q.checklist.every(re=>u[re.id])&&p!=null&&p.autoCompleteStep&&(X({title:"âœ… Checklist complÃ©tÃ©e !",description:"Passage automatique Ã  l'Ã©tape suivante...",className:"bg-green-500 text-white"}),h(g,r,x,t)),R})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((F,E)=>{const w=ct[F.status]||ct[He];return e.jsxs(et.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:E*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${w.iconOnly}`,children:F.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${w.text}`,children:F.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[F.subSteps&&F.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[F.subSteps.filter(c=>c.status===Be).length,"/",F.subSteps.length," sous-Ã©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(he,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${w.badge} hover:opacity-90`,onClick:c=>{var S;c.stopPropagation();const u=c.currentTarget,R=u.nextElementSibling,q=u.closest("[data-step-status-container]");!R||!q||((S=q.parentElement)==null||S.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==R&&M.classList.add("hidden")}),R.classList.toggle("hidden"))},children:w.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:c=>{var u;c.stopPropagation(),c.preventDefault(),a(E,Ee),(u=c.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:c=>{var u;c.stopPropagation(),c.preventDefault(),a(E,Be),(u=c.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:c=>{var u;c.stopPropagation(),c.preventDefault(),a(E,He),(u=c.currentTarget.parentElement)==null||u.classList.add("hidden")},children:"Marquer Ã  venir"})]})]})]})]}),F.subSteps&&F.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:F.subSteps.map((c,u)=>{const R=ct[c.status]||ct[He];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${c.status===Be?"bg-green-500":c.status===Ee?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:c.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${R.badge}`,children:R.label})]},c.id||u)})}),F.status===Ee&&E===x&&(p==null?void 0:p.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:p.actions.filter(c=>c.hasClientAction===!1&&c.checklist&&c.checklist.length>0).map(c=>{const u=f[c.id]||{},R=c.checklist.length,q=c.checklist.filter(M=>u[M.id]).length,S=q===R;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"ðŸ“‹ Checklist Ã  complÃ©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${S?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[q,"/",R]})]}),e.jsx("div",{className:"space-y-2",children:c.checklist.map(M=>{const re=u[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:re,onChange:()=>D(c.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${re?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(p==null?void 0:p.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"âš¡ Passage automatique Ã  l'Ã©tape suivante quand tout est cochÃ©"})]},c.id)})}),F.status===Ee&&E===x&&$.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:$.map(c=>{const u=c.status==="effectue",R=c.startTime?new Date(c.startTime):null,q=R&&!isNaN(R.getTime()),S=async()=>{const M=u?"pending":"effectue";await b(c.id,{status:M}),X({title:u?"ðŸ”„ TÃ¢che rÃ©ouverte":"âœ… TÃ¢che terminÃ©e",description:u?"La tÃ¢che a Ã©tÃ© remise en cours":"La tÃ¢che a Ã©tÃ© marquÃ©e comme terminÃ©e",className:u?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:S,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${u?"line-through text-gray-500":""} truncate flex-1`,children:c.title||"TÃ¢che"}),u&&e.jsx(ht,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),q&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["ðŸ“… ",tt(R,"dd/MM/yyyy Ã  HH:mm",{locale:Ge})]})]})]},c.id)})})]})]},E)})})]})},Dr=({prospect:t,projectType:a,supabaseSteps:n,v2Templates:r,onUpdate:x})=>{var oe;const{forms:g,prompts:h,completeStepAndProceed:f,activeAdminUser:_,appointments:k,updateAppointment:y}=Je(),{formPanels:b=[],loading:O,updateFormPanel:p}=na(t.id),{sendMessage:$}=Is(t.id,a),[D,N]=i.useState(null),[F,E]=i.useState({}),[w,c]=i.useState(!1),[u,R]=i.useState(null),[q,S]=i.useState(""),[M,re]=i.useState(new Set),de=i.useMemo(()=>{if(!b)return[];const o=b.filter(P=>P.prospectId===t.id&&P.projectType===a).sort((P,V)=>(V.createdAt||0)-(P.createdAt||0));return v.debug("[ProspectForms] Filtering panels",{totalPanels:b.length,prospectId:t.id,projectType:a,filteredCount:o.length,samplePanel:b[0]}),o},[b,t.id,a]);if(i.useEffect(()=>{!de||de.length===0||de.forEach(o=>{var V,xe,C,L;if(M.has(o.panelId)||o.status!=="submitted")return;if(o.lastSubmittedAt){const j=new Date(o.lastSubmittedAt).getTime(),se=Date.now()-j;if(se>1e4){v.debug("Form too old, skipping auto-complete",{panelId:o.panelId,ageSeconds:Math.floor(se/1e3)}),re(W=>new Set([...W,o.panelId]));return}}v.debug("New submitted form detected",{panelId:o.panelId,formId:o.formId,projectType:o.projectType}),v.debug("Available prompts",{count:Object.keys(h).length});let P=null;if(o.promptId&&(v.debug("Searching by promptId",{promptId:o.promptId}),P=h[o.promptId]),P||(P=Object.values(h).find(j=>{var W,ee;if(v.debug("Testing prompt",{name:j.name,projectId:j.projectId,target:o.projectType}),j.projectId!==o.projectType)return!1;const ie=(W=j.stepsConfig)==null?void 0:W[o.currentStepIndex];return(ee=ie==null?void 0:ie.actions)==null?void 0:ee.some(te=>te.type==="show_form"&&te.formId===o.formId)})),v.debug("Prompt found",{name:P==null?void 0:P.name,autoComplete:(xe=(V=P==null?void 0:P.stepsConfig)==null?void 0:V[o.currentStepIndex])==null?void 0:xe.autoCompleteStep}),P){const j=(C=P.stepsConfig)==null?void 0:C[o.currentStepIndex],ie=(L=j==null?void 0:j.actions)==null?void 0:L.find(W=>W.type==="show_form"&&W.formId===o.formId),se=(ie==null?void 0:ie.verificationMode)||"human";v.debug("Checking auto-complete conditions",{autoCompleteStep:j==null?void 0:j.autoCompleteStep,verificationMode:se}),j!=null&&j.autoCompleteStep&&se==="none"&&(v.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),f(t.id,o.projectType,o.currentStepIndex),X({title:"âœ… Ã‰tape terminÃ©e !",description:`${t.name} a complÃ©tÃ© le formulaire. Passage automatique Ã  l'Ã©tape suivante.`,className:"bg-green-500 text-white"}))}re(j=>new Set([...j,o.panelId]))})},[de,h,f,t.id,t.name,M]),de.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const fe=o=>{N(o.panelId);const xe=((t.form_data||t.formData||{})[o.projectType]||{})[o.formId]||{};E({...xe,_meta:{projectType:o.projectType,formId:o.formId}})},_e=()=>{N(null),E({})},z=async()=>{const{_meta:o,...P}=F,{projectType:V,formId:xe}=o||{};if(!V||!xe){v.error("âŒ MÃ©tadonnÃ©es manquantes pour la sauvegarde");return}const C=t.form_data||t.formData||{},L={...C,[V]:{...C[V]||{},[xe]:P}},{error:j}=await pe.from("prospects").update({form_data:L}).eq("id",t.id);if(j){v.error("âŒ Erreur sauvegarde formulaire:",j),X({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}X({title:"âœ… SauvegardÃ©",description:"Les modifications ont Ã©tÃ© enregistrÃ©es.",className:"bg-green-500 text-white"}),x&&x({...t,form_data:L,formData:L}),N(null),E({})},H=(o,P)=>{E(V=>({...V,[o]:P}))},I=o=>{var xe,C;const P=Object.values(h).find(L=>L.id===o.promptId||L.projectId===o.projectType),V=(xe=P==null?void 0:P.stepsConfig)==null?void 0:xe[o.currentStepIndex];return(C=V==null?void 0:V.actions)==null?void 0:C.find(L=>L.formId===o.formId)},K=async o=>{var P,V,xe,C,L,j;try{await p(o.panelId,{status:"approved"});const ie=I(o),se=(ie==null?void 0:ie.verificationMode)||"human";if(v.debug("ðŸ” Checking verification mode",{verificationMode:se,shouldSearchTask:se==="human"}),se==="human"){v.debug("ðŸ” Searching for related task",{totalAppointments:(k==null?void 0:k.length)||0,prospectId:t.id,projectType:o.projectType,stepName:o.stepName,panel:o});const je=(k==null?void 0:k.filter(d=>d.type==="task"))||[],ce=je.filter(d=>d.contactId===t.id);v.debug("ðŸ” Task filtering debug",{allTasks:je.length,prospectTasks:ce.length,prospectTasksData:ce.map(d=>({id:d.id,title:d.title,contactId:d.contactId,projectId:d.projectId,step:d.step,status:d.status}))}),v.debug("ðŸ” Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:o.projectType,step:o.stepName,status:"pending",titleIncludes:"VÃ©rifier le formulaire"}});let le=k==null?void 0:k.find(d=>{var ae;const A={isTask:d.type==="task",contactMatch:d.contactId===t.id,projectMatch:d.projectId===o.projectType,stepMatch:d.step===o.stepName,isPending:d.status==="pending",titleMatch:(ae=d.title)==null?void 0:ae.includes("VÃ©rifier le formulaire")},J=Object.values(A).every(ye=>ye);return!J&&d.type==="task"&&d.contactId===t.id&&v.warn("ðŸ” Task failed matching:",{taskId:d.id,title:d.title,checks:A,COMPARISON:{taskStep:`"${d.step}"`,panelStep:`"${o.stepName}"`,areEqual:d.step===o.stepName,taskStepType:typeof d.step,panelStepType:typeof o.stepName},taskData:{contactId:d.contactId,projectId:d.projectId,step:d.step,status:d.status},panelData:{projectType:o.projectType,stepName:o.stepName}}),J});le||(v.warn("âš ï¸ Task not found with exact step, trying fallback without step",{panelStep:o.stepName}),le=k==null?void 0:k.find(d=>{var A;return d.type==="task"&&d.contactId===t.id&&d.projectId===o.projectType&&d.status==="pending"&&((A=d.title)==null?void 0:A.includes("VÃ©rifier le formulaire"))}),le&&v.info("âœ… Found task via fallback (without step match)",{taskId:le.id,taskStep:le.step})),le?(v.info("âœ… Found verification task, marking as completed",{taskId:le.id,prospectId:t.id,title:le.title}),await y(le.id,{status:"effectue"}),X({title:"âœ… TÃ¢che mise Ã  jour",description:"La tÃ¢che de vÃ©rification a Ã©tÃ© marquÃ©e comme effectuÃ©e.",className:"bg-blue-500 text-white"})):v.warn("âš ï¸ No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:o.projectType,step:o.stepName,status:"pending",titleContains:"VÃ©rifier le formulaire"}})}else v.debug("â­ï¸ Skipping task search (verificationMode !== human)",{verificationMode:se});const W=n==null?void 0:n[o.projectType],ee=W==null?void 0:W.findIndex(je=>je.status==="in_progress"),te=ee!=null&&ee>=0?ee:o.currentStepIndex||0,me=(P=W==null?void 0:W[te])==null?void 0:P.name,ne=me?me.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,Ie=`${o.projectType}:${ne}`,Ne=ne&&r?r[Ie]:null,Q=(V=Ne==null?void 0:Ne.configJson)==null?void 0:V.actionConfig;v.debug("[V2] Template lookup",{panelProjectType:o.projectType,propProjectType:a,currentStepName:me,moduleId:ne,templateKey:Ie,v2TemplatesKeys:r?Object.keys(r):[],templateFound:!!Ne});const Se=me?_s(me):null,Me=(Q==null?void 0:Q.completionTrigger)||(Se==null?void 0:Se.completionTrigger),Pe=(xe=Ne==null?void 0:Ne.configJson)==null?void 0:xe.actions,Ye=Pe&&Pe.length>1;let Re=!0;if(Ye){const je=Pe.map((J,ae)=>`v2-${ne}-action-${ae}`),{data:ce}=await pe.from("client_form_panels").select("id, action_id, step_name, form_id, filled_by_role").eq("prospect_id",t.id).eq("project_type",o.projectType).eq("status","approved");let le=new Set;(ce||[]).forEach(J=>{J.action_id&&je.includes(J.action_id)&&le.add(J.action_id)});const d=(ce||[]).filter(J=>!J.action_id&&(!J.step_name||J.step_name===me||J.step_name===ne));if(d.length>0){const J=je.filter(ae=>!le.has(ae));d.forEach((ae,ye)=>{ye<J.length&&le.add(J[ye])}),v.debug("[V2] Fallback: assigned panels without action_id",{panelsWithoutActionId:d.length,uncoveredIds:J,afterAssignment:[...le]})}const A=le.size;Re=A>=Pe.length,v.debug("[V2] Multi-actions check",{totalActions:Pe.length,expectedActionIds:je,approvedActionIds:[...le],panelsTotal:(ce||[]).length,panelsWithActionId:(ce||[]).filter(J=>J.action_id).length,panelsWithoutActionId:d.length,allCompleted:Re}),Re||(v.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:Pe.length-A}),X({title:"âœ… Action validÃ©e",description:`Action ${A}/${Pe.length} â€” il reste ${Pe.length-A} action(s) avant de terminer l'Ã©tape.`,className:"bg-blue-500 text-white"}))}v.debug("[V2] Checking completionTrigger for form approval",{stepName:me,moduleId:ne,v2TemplateFound:!!Ne,completionTrigger:Me,currentStepIdx:te,hasMultiActions:Ye,allActionsCompleted:Re});const Ke=(Me==="form_approved"||!Me)&&Re;let We=W;if(W&&((L=(C=W[te])==null?void 0:C.subSteps)==null?void 0:L.length)>0){const je=W[te];let ce=-1;if(o.action_id&&(ce=je.subSteps.findIndex(le=>le.id===o.action_id)),ce===-1&&(ce=je.subSteps.findIndex(le=>le.status===Ee),v.debug("[V2] Substep fallback: using first in_progress",{panelActionId:o.action_id,fallbackIndex:ce})),ce!==-1){v.debug("[V2] Updating substep for approved action",{actionId:o.action_id,subStepIndex:ce,subStepName:je.subSteps[ce].name,allActionsCompleted:Re});const le=JSON.parse(JSON.stringify(W));if(le[te].subSteps.forEach((d,A)=>{d.status===Ee&&A!==ce&&(d.status=Be)}),le[te].subSteps[ce].status=Be,!Re){let d=-1;for(let A=ce+1;A<le[te].subSteps.length;A++)if(le[te].subSteps[A].status===He){d=A;break}d!==-1&&(le[te].subSteps[d].status=Ee,v.debug("[V2] Activated next substep",{completedIndex:ce,nextIndex:d,nextName:le[te].subSteps[d].name}))}await updateSupabaseSteps(o.projectType,le),We=le,v.info("[V2] Substep updated successfully",{completedSubStep:ce,nextActivated:!Re})}}if(Ke&&We)v.info("[V2] Form approved â†’ completing step",{prospectId:t.id,projectType:o.projectType,currentStepIdx:te,stepName:me,trigger:Me||"default_behavior"}),await f(t.id,o.projectType,te,We),X({title:"âœ… Ã‰tape validÃ©e automatiquement",description:"La validation du formulaire a dÃ©clenchÃ© le passage Ã  l'Ã©tape suivante",className:"bg-green-500 text-white"});else{const je=Object.values(h).find(ce=>ce.id===o.promptId||ce.projectId===o.projectType);if(je){const ce=(j=je.stepsConfig)==null?void 0:j[o.currentStepIndex];ce!=null&&ce.autoCompleteStep&&(v.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:o.projectType,stepIndex:o.currentStepIndex}),W?await f(t.id,o.projectType,o.currentStepIndex,W):v.error("No steps found in supabaseSteps for projectType",{projectType:o.projectType}))}}const Oe=o.filledByRole==="partner";if(Oe)v.debug("Formulaire partenaire validÃ© â€” pas de message chat au client");else{const je=(ie==null?void 0:ie.approvalMessage)||"Merci ! Votre formulaire a Ã©tÃ© validÃ©.",{data:ce}=await pe.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",o.projectType).eq("sender","admin").eq("text",je).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!ce||ce.length===0?await $({sender:"admin",text:je,relatedMessageTimestamp:new Date().toISOString()}):v.debug("Message de validation dÃ©jÃ  envoyÃ© rÃ©cemment, skip")}if(Oe&&o.formId){const{data:je,error:ce}=await pe.from("missions").select("id, form_ids, status").eq("prospect_id",t.id).eq("status","submitted");if(!ce&&(je==null?void 0:je.length)>0){const le=je.find(d=>{var A;return(A=d.form_ids)==null?void 0:A.includes(o.formId)});if(le){const{error:d}=await pe.from("missions").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",le.id);d?v.error("âŒ Erreur mise Ã  jour mission â†’ completed",d):v.info("âœ… Mission passÃ©e en completed",{missionId:le.id})}}}X({title:"âœ… Formulaire validÃ©",description:Oe?"Le formulaire partenaire a Ã©tÃ© validÃ©. Mission marquÃ©e comme complÃ©tÃ©e.":"Un message a Ã©tÃ© envoyÃ© au client.",className:"bg-green-500 text-white"})}catch(ie){v.error("âŒ Erreur validation formulaire:",ie),X({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},ue=async(o="")=>{if(u)try{const P=u,V=P.filledByRole==="partner";await p(P.panelId,{status:"rejected",rejectionReason:V?o:null});const xe=I(P),C=(xe==null?void 0:xe.verificationMode)||"human";if(v.debug("ðŸ” Checking verification mode (reject)",{verificationMode:C,shouldSearchTask:C==="human",isPartnerForm:V}),C==="human"){v.debug("ðŸ” Searching for related task (reject)",{totalAppointments:(k==null?void 0:k.length)||0,prospectId:t.id,projectType:P.projectType,stepName:P.stepName}),v.debug("ðŸ” Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:P.projectType,step:P.stepName,status:"pending",titleIncludes:"VÃ©rifier le formulaire"}});let L=k==null?void 0:k.find(j=>{var W;const ie={isTask:j.type==="task",contactMatch:j.contactId===t.id,projectMatch:j.projectId===P.projectType,stepMatch:j.step===P.stepName,isPending:j.status==="pending",titleMatch:(W=j.title)==null?void 0:W.includes("VÃ©rifier le formulaire")},se=Object.values(ie).every(ee=>ee);return!se&&j.type==="task"&&j.contactId===t.id&&v.warn("ðŸ” Task failed matching (REJECT):",{taskId:j.id,title:j.title,checks:ie,COMPARISON:{taskStep:`"${j.step}"`,panelStep:`"${P.stepName}"`,areEqual:j.step===P.stepName,taskStepType:typeof j.step,panelStepType:typeof P.stepName},taskData:{contactId:j.contactId,projectId:j.projectId,step:j.step,status:j.status},panelData:{projectType:P.projectType,stepName:P.stepName}}),se});L||(v.warn("âš ï¸ Task not found with exact step (reject), trying fallback",{panelStep:P.stepName}),L=k==null?void 0:k.find(j=>{var ie;return j.type==="task"&&j.contactId===t.id&&j.projectId===P.projectType&&j.status==="pending"&&((ie=j.title)==null?void 0:ie.includes("VÃ©rifier le formulaire"))}),L&&v.info("âœ… Found task via fallback (reject, without step match)",{taskId:L.id,taskStep:L.step})),L&&(v.info("âœ… Found verification task, marking as completed (rejected)",{taskId:L.id,prospectId:t.id,title:L.title}),await y(L.id,{status:"effectue"}))}else v.debug("â­ï¸ Skipping task search (reject, verificationMode !== human)",{verificationMode:C});if(V){if(P.formId){const{data:L}=await pe.from("missions").select("id, form_ids").eq("prospect_id",t.id).eq("status","submitted"),j=L==null?void 0:L.find(ie=>{var se;return(se=ie.form_ids)==null?void 0:se.includes(P.formId)});j&&(await pe.from("missions").update({status:"pending"}).eq("id",j.id),v.info("âœ… Mission remise en pending (admin a refusÃ©)",{missionId:j.id}))}X({title:"âŒ Formulaire rejetÃ©",description:"La mission est revenue dans l'onglet Missions du partenaire.",className:"bg-red-500 text-white"})}else{const j=`${(xe==null?void 0:xe.rejectionMessage)||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :"}

${o}`;await $({sender:"admin",text:j,relatedMessageTimestamp:new Date().toISOString()}),X({title:"âŒ Formulaire rejetÃ©",description:"Un message a Ã©tÃ© envoyÃ© au client.",className:"bg-red-500 text-white"})}c(!1),R(null),S("")}catch(P){v.error("âŒ Erreur rejet formulaire:",P),X({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[de.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:de.map(o=>{var C,L;const P=g[o.formId];let V={};if(o.filledByRole==="partner"&&o.formData?V=o.formData:V=((t.form_data||t.formData||{})[o.projectType]||{})[o.formId]||{},!P)return null;const xe=o.stepName||((L=(C=n==null?void 0:n[o.projectType])==null?void 0:C[o.currentStepIndex])==null?void 0:L.name)||null;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:P.name}),xe&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ã‰tape : ",xe]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${o.status==="submitted"?"bg-green-100 text-green-700":o.status==="approved"?"bg-blue-100 text-blue-700":o.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:o.status==="submitted"?"EnvoyÃ©":o.status==="approved"?"ApprouvÃ©":o.status==="rejected"?"RejetÃ©":"En attente"})]}),o.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-green-700",children:["âœ… ",o.filledByRole==="partner"?"Partenaire":"Client"," a soumis ce formulaire"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(he,{size:"sm",onClick:()=>K(o),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(ht,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(he,{size:"sm",variant:"outline",onClick:()=>{R(o),c(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),o.status==="rejected"&&o.rejectionReason&&e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-red-800",children:o.rejectionReason.startsWith("Mission impossible")?"â›” Mission dÃ©clarÃ©e impossible par le partenaire":"âŒ Formulaire rejetÃ©"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:o.rejectionReason.startsWith("Mission impossible â€” ")?o.rejectionReason.replace("Mission impossible â€” ",""):o.rejectionReason})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(P.fields||[]).map(j=>{if(j.show_if_conditions&&j.show_if_conditions.length>0){const ee=j.condition_operator||"AND",te=j.show_if_conditions.map(ne=>{const Ie=V[ne.field];return ne.equals==="has_value"?!!Ie&&Ie!=="":Ie===ne.equals});if(!(ee==="AND"?te.every(ne=>ne===!0):te.some(ne=>ne===!0)))return null}if(j.show_if){const ee=j.show_if.field,te=j.show_if.equals,me=V[ee];if(!me||me!==te)return null}if((P.fields||[]).some(ee=>ee.is_repeater&&(ee.repeats_fields||[]).includes(j.id)))return null;const se=V[j.id],W=j.type==="file"&&typeof se=="object"&&(se==null?void 0:se.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(qe,{className:"text-sm font-medium text-gray-600",children:j.label}),D===o.panelId?W?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(Ve,{className:"inline h-4 w-4 mr-2"}),se.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):j.type==="select"?e.jsxs("select",{value:F[j.id]||"",onChange:ee=>H(j.id,ee.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(j.options||[]).map((ee,te)=>e.jsx("option",{value:ee,children:ee},te))]}):e.jsx(Xe,{type:j.type||"text",value:F[j.id]||"",onChange:ee=>H(j.id,ee.target.value),placeholder:j.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:W?e.jsxs("button",{onClick:async()=>{try{const{data:ee,error:te}=await pe.storage.from("project-files").createSignedUrl(se.storagePath,3600);if(te)throw te;window.open(ee.signedUrl,"_blank")}catch{X({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{children:se.name}),e.jsx(yt,{className:"h-3 w-3"})]}):se||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseignÃ©"})}),j.is_repeater&&j.repeats_fields&&j.repeats_fields.length>0&&se&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(se)||0},(ee,te)=>{const me=(P.fields||[]).filter(ne=>j.repeats_fields.includes(ne.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[j.label," #",te+1]}),me.map(ne=>{const Ie=`${j.id}_repeat_${te}_${ne.id}`,Ne=V[Ie],Q=ne.type==="file"&&typeof Ne=="object"&&(Ne==null?void 0:Ne.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(qe,{className:"text-xs font-medium text-gray-600",children:ne.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:Q?e.jsxs("button",{onClick:async()=>{try{const{data:Se,error:Me}=await pe.storage.from("project-files").createSignedUrl(Ne.storagePath,3600);if(Me)throw Me;window.open(Se.signedUrl,"_blank")}catch{X({title:"âŒ Erreur",description:"Impossible de tÃ©lÃ©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(Ve,{className:"h-3 w-3"}),e.jsx("span",{children:Ne.name}),e.jsx(yt,{className:"h-3 w-3"})]}):Ne||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseignÃ©"})})]},Ie)})]},te)})})]},j.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D===o.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(he,{variant:"outline",size:"sm",onClick:_e,children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(he,{size:"sm",onClick:z,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Jt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(he,{variant:"outline",size:"sm",onClick:()=>fe(o),children:[e.jsx(Nt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},o.panelId)})}),e.jsx(vt,{open:w,onOpenChange:c,children:e.jsxs(wt,{className:"max-w-lg",children:[e.jsxs(_t,{children:[e.jsx(St,{children:"Rejeter le formulaire"}),e.jsx(Ss,{children:"Expliquez au client pourquoi le formulaire est rejetÃ©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((oe=I(u))==null?void 0:oe.rejectionMessage)||"Oups !! Votre formulaire a Ã©tÃ© rejetÃ© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(qe,{children:"Raison du refus"}),e.jsx("textarea",{value:q,onChange:o=>S(o.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Wt,{children:[e.jsx(he,{variant:"outline",onClick:()=>{c(!1),R(null),S("")},children:"Annuler"}),e.jsx(he,{onClick:()=>ue(q),disabled:!q.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},Tr=({prospect:t,projectType:a,onUpdate:n})=>{const{forms:r}=Je(),[x,g]=i.useState(null),[h,f]=i.useState({}),_=i.useMemo(()=>Object.values(r).filter(p=>p.audience==="internal"&&(p.projectIds||[]).includes(a)),[r,a]);i.useEffect(()=>{if(t&&t.form_data){const p=t.form_data[a]||{};f(p)}},[t,a]);const k=p=>{g(p)},y=()=>{if(g(null),t&&t.form_data){const p=t.form_data[a]||{};f(p)}},b=(p,$,D)=>{f(N=>({...N,[p]:{...N[p]||{},[$]:D}}))},O=async()=>{try{const p={...t.form_data||{},[a]:h},$={...t,form_data:p,formData:p};await n($),X({title:"âœ… Formulaire enregistrÃ©",description:"Les donnÃ©es du formulaire interne ont Ã©tÃ© sauvegardÃ©es.",className:"bg-green-500 text-white"}),g(null)}catch(p){v.error("Erreur sauvegarde formulaire interne:",p),X({title:"âŒ Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[_.length," formulaire(s)"]})]}),_.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'CrÃ©ez un formulaire avec "Interne (Ã©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:_.map(p=>{const $=h[p.id]||{},D=x===p.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:p.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (Ã©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(p.fields||[]).map(N=>{if(N.show_if_conditions&&N.show_if_conditions.length>0){const w=N.condition_operator||"AND",c=N.show_if_conditions.map(R=>{const q=$[R.field];return R.equals==="has_value"?!!q&&q!=="":q===R.equals});if(!(w==="AND"?c.every(R=>R===!0):c.some(R=>R===!0)))return null}if(N.show_if){const w=N.show_if.field,c=N.show_if.equals,u=$[w];if(!u||u!==c)return null}if((p.fields||[]).some(w=>w.is_repeater&&(w.repeats_fields||[]).includes(N.id)))return null;const E=$[N.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(qe,{className:"text-sm font-medium text-gray-600",children:[N.label,N.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),D?N.type==="textarea"?e.jsx("textarea",{value:E,onChange:w=>b(p.id,N.id,w.target.value),placeholder:N.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):N.type==="select"?e.jsxs("select",{value:E,onChange:w=>b(p.id,N.id,w.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(N.options||[]).map((w,c)=>e.jsx("option",{value:w,children:w},c))]}):e.jsx(Xe,{type:N.type||"text",value:E,onChange:w=>b(p.id,N.id,w.target.value),placeholder:N.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:E||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseignÃ©"})}),N.is_repeater&&N.repeats_fields&&N.repeats_fields.length>0&&E&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(E)||0},(w,c)=>{const u=(p.fields||[]).filter(R=>N.repeats_fields.includes(R.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[N.label," #",c+1]}),u.map(R=>{const q=`${N.id}_repeat_${c}_${R.id}`,S=$[q]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(qe,{className:"text-xs font-medium text-gray-600",children:R.label}),D?R.type==="textarea"?e.jsx("textarea",{value:S,onChange:M=>b(p.id,q,M.target.value),placeholder:R.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):R.type==="select"?e.jsxs("select",{value:S,onChange:M=>b(p.id,q,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- SÃ©lectionner --"}),(R.options||[]).map((M,re)=>e.jsx("option",{value:M,children:M},re))]}):e.jsx(Xe,{type:R.type||"text",value:S,onChange:M=>b(p.id,q,M.target.value),placeholder:R.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:S||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseignÃ©"})})]},q)})]},c)})})]},N.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D?e.jsxs(e.Fragment,{children:[e.jsxs(he,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(he,{size:"sm",onClick:O,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Jt,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(he,{variant:"outline",size:"sm",onClick:()=>k(p.id),children:[e.jsx(Nt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},p.id)})})]})},Rr=t=>{switch(t.type){case"email":return e.jsx(It,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(lt,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(ia,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(Ct,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(mt,{className:"h-4 w-4 text-gray-400"}):e.jsx(la,{className:"h-4 w-4 text-gray-400"})}},Mr=({prospect:t,onBack:a,onUpdate:n,onEditingChange:r})=>{var De;const{getProjectSteps:x,completeStepAndProceed:g,updateProjectSteps:h,markNotificationAsRead:f,projectsData:_,formContactConfig:k,currentUser:y,userProjects:b,setUserProjects:O,getProjectInfo:p,updateProjectInfo:$,activeAdminUser:D,prompts:N,notifications:F}=Je(),{supabaseUserId:E}=ot(),{users:w,loading:c}=pt(),{projectStepsStatus:u,updateProjectSteps:R}=va(t.id),{organizationId:q}=xt(),{templates:S}=ks(q||(D==null?void 0:D.organization_id),null),[M,re]=ws(),de=M.get("project")||t._selectedProjectType,fe=M.get("notificationId"),_e=M.get("channel"),[z,H]=i.useState(de||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:I,addProjectEvent:K}=it({projectType:z||"",prospectId:t.id,enabled:!!z&&!!t.id,activeAdminUser:D}),[ue,oe]=i.useState(!1),[o,P]=i.useState(t);i.useEffect(()=>{P(t)},[t]);const[V,xe]=i.useState(!1),C=i.useMemo(()=>z?p(t.id,z)||{}:{},[z,p,t.id]),[L,j]=i.useState((C==null?void 0:C.status)||"actif"),[ie,se]=i.useState({}),W=C==null?void 0:C.amount,ee=i.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[te,me]=i.useState(""),[ne,Ie]=i.useState(!1),Ne=i.useMemo(()=>[{value:"unassigned",label:"Non assignÃ©"},...w.map(s=>({value:s.user_id,label:s.name}))],[w]),Q=i.useMemo(()=>{var m;if(!z)return[];if(u[z])return u[z].map(l=>ls(l,z,S)).map(is);const s=(m=_[z])==null?void 0:m.steps;if(s&&s.length>0){const l=JSON.parse(JSON.stringify(s));return l[0].status="in_progress",l.map(T=>ls(T,z,S)).map(is)}return[]},[z,u,_,S]),Se=Q.findIndex(s=>s.status===Ee),Me=Q[Se]||Q.find(s=>s.status===He)||Q[0];i.useEffect(()=>{if(fe){f(parseInt(fe));const s=new URLSearchParams(M);s.delete("notificationId"),re(s,{replace:!0})}},[fe,f,re,M]),i.useEffect(()=>{var m;const s=M.get("project");s&&s!==z&&((m=t.tags)!=null&&m.includes(s))&&H(s)},[M,t.tags]),i.useEffect(()=>{if(!(t!=null&&t.id)||!z||!F||!f)return;const s=F.filter(m=>!m.read&&m.prospectId===t.id&&m.projectType===z);s.length>0&&s.forEach(m=>{f(m.id)})},[t==null?void 0:t.id,z,F,f]),i.useEffect(()=>{v.debug("Prospect prop changed",{name:t.name}),P(t)},[t]),i.useEffect(()=>{ne||(W==null||W===""?me(""):me(W.toString()))},[W,ne]),i.useEffect(()=>{(async()=>{var T;if(!z||!t.id)return;const{data:m,error:l}=await pe.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",z).maybeSingle();l?(v.error("Erreur chargement project status:",l),j("actif")):(T=m==null?void 0:m.data)!=null&&T.status?j(m.data.status):j("actif")})()},[z,t.id]),i.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:m,error:l}=await pe.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(m){const T={};m.forEach(Y=>{T[Y.project_type]=Y.status||"actif"}),se(T)}})()},[t.id,t.tags]),i.useEffect(()=>{r&&r(ue)},[ue,r]),i.useEffect(()=>{if(!t.id)return;const s=pe.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async m=>{var U;const{new:l,old:T}=m;if(l.status!=="signed"||(T==null?void 0:T.status)==="signed")return;const Y=l.project_type;v.info("[V2 Signature Listener] Signature completed",{procedureId:l.id,projectType:Y,prospectId:l.prospect_id});const B=u==null?void 0:u[Y];if(!B||B.length===0){v.warn("[V2 Signature Listener] No steps found for project type",{projectType:Y});return}const G=B.findIndex(Ae=>Ae.status==="in_progress");if(G===-1){v.warn("[V2 Signature Listener] No current step in_progress",{projectType:Y});return}const Z=(U=B[G])==null?void 0:U.name;if(!Z){v.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:G});return}const ge=_s(Z);if((ge==null?void 0:ge.completionTrigger)!=="signature"){v.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:Z,completionTrigger:(ge==null?void 0:ge.completionTrigger)||"null"});return}v.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:Y,currentStepIdx:G,stepName:Z});try{await g(t.id,Y,G,B),X({title:"âœ… Ã‰tape validÃ©e automatiquement",description:`La signature a dÃ©clenchÃ© la validation de "${Z}"`,className:"bg-green-500 text-white"})}catch(Ae){v.error("[V2 Signature Listener] Error completing step",Ae)}}).subscribe();return()=>{pe.removeChannel(s)}},[t.id,u,g]);const Pe=s=>{H(s),re(m=>(m.set("project",s),m),{replace:!0})},Ye=async s=>{if(!z||!t.id)return;const m=L;j(s);try{const{error:l}=await pe.from("project_infos").upsert({prospect_id:t.id,project_type:z,status:s,data:(C==null?void 0:C.data)||{}},{onConflict:"prospect_id,project_type"});if(l)throw l;const T={actif:"rÃ©activÃ©",abandon:"abandonnÃ©",archive:"archivÃ©"},{error:Y}=await pe.from("project_history").insert({prospect_id:t.id,project_type:z,event_type:"status",description:`Projet ${T[s]||s}`,organization_id:D==null?void 0:D.organization_id,metadata:{old_status:m,new_status:s}});Y&&v.error("Erreur historique:",Y),$(t.id,z,(B={})=>({...B,status:s})),se(B=>({...B,[z]:s})),X({title:"âœ… Statut mis Ã  jour",description:`Le projet est maintenant "${T[s]}".`,className:"bg-green-500 text-white"})}catch(l){v.error("Erreur lors du changement de statut:",l),j(m),X({title:"âŒ Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},Re=s=>{me(s)},Ke=s=>{if(!z)return;const m=s.replace(",",".").trim();if(m===""){$(t.id,z,(Y={})=>{if(!Y.amount)return Y;const B={...Y};return delete B.amount,B}),me("");return}const l=parseFloat(m);if(Number.isNaN(l)||l<0){me(W==null?"":W.toString());return}const T=Math.round(l*100)/100;$(t.id,z,(Y={})=>({...Y,amount:T})),me(T.toFixed(2))},We=()=>{Ke(te),Ie(!1)},Oe=s=>{s.key==="Enter"&&(s.preventDefault(),Ke(s.currentTarget.value),s.currentTarget.blur(),Ie(!1))},je=async(s,m)=>{var T,Y;const l=Q[s];if(m===Be&&((T=l==null?void 0:l.subSteps)==null?void 0:T.length)>0&&!kr(l)){X({title:"Sous-Ã©tapes en cours",description:"Vous devez valider chaque sous-Ã©tape avant de terminer cette Ã©tape.",variant:"destructive"});return}if(m===Ee&&((Y=l==null?void 0:l.subSteps)==null?void 0:Y.length)>0){const B=JSON.parse(JSON.stringify(Q)),G=B[s];G.status=Ee,G.subSteps=G.subSteps.map((Z,ge)=>({...Z,status:ge===0?Ee:He})),await R(z,B),I&&await I({event_type:"pipeline",title:"Ã‰tape relancÃ©e",description:`Sous-Ã©tapes rÃ©initialisÃ©es pour Â« ${G.name} Â»`,metadata:{step_id:(G==null?void 0:G.id)||null,step_name:(G==null?void 0:G.name)||null,previous_status:(l==null?void 0:l.status)||null,new_status:Ee,project_type:z},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)});return}if(m===Be){const B=JSON.parse(JSON.stringify(Q));B[s].status="completed";let G=s+1;if(G<B.length&&(B[G].status="in_progress"),await R(z,B),I){const Z=G<B.length?B[G]:null;await I({event_type:"pipeline",title:"Ã‰tape du pipeline mise Ã  jour",description:l&&Z?`Ã‰tape Â« ${l.name} Â» complÃ©tÃ©e â†’ passage Ã  Â« ${Z.name} Â»`:`Ã‰tape Â« ${l.name} Â» complÃ©tÃ©e`,metadata:{previous_step_id:(l==null?void 0:l.id)||null,previous_step_name:(l==null?void 0:l.name)||null,previous_step_status:(l==null?void 0:l.status)||null,new_step_id:(Z==null?void 0:Z.id)||null,new_step_name:(Z==null?void 0:Z.name)||null,new_step_status:"in_progress",project_type:z},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}if(G<B.length&&B[G].globalStepId){const Z=B[G].globalStepId,ge={...t,status:Z};n(ge),X({title:"ðŸ“Š Pipeline mis Ã  jour",description:"Le prospect a Ã©tÃ© dÃ©placÃ© dans le pipeline"})}}else{const B=Q.map((Z,ge)=>{let U=Z.status;return ge===s&&(U=m),{...Z,status:U}});if(await R(z,B),I){const Z=B[s];await I({event_type:"pipeline",title:"Ã‰tape du pipeline mise Ã  jour",description:`Ã‰tape Â« ${Z.name} Â» passÃ©e de Â« ${l.status==="pending"?"Ã€ venir":l.status==="in_progress"?"En cours":"TerminÃ©"} Â» Ã  Â« ${m==="pending"?"Ã€ venir":m==="in_progress"?"En cours":"TerminÃ©"} Â»`,metadata:{step_id:(Z==null?void 0:Z.id)||null,step_name:(Z==null?void 0:Z.name)||null,previous_status:(l==null?void 0:l.status)||null,new_status:m,project_type:z},createdBy:E,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}const G=B[s];if(G.globalStepId&&m==="in_progress"){const Z={...t,status:G.globalStepId};n(Z)}}},ce=async s=>{var l,T;const m=o.tags||[];if(!m.includes(s)){const Y={...o,tags:[...m,s]};if(P(Y),n(Y),H(s),y&&t.id===y.id&&!b.includes(s)){const G=[...b,s];O(G)}const B=(l=_[s])==null?void 0:l.steps;if(B&&B.length>0)try{const G=JSON.parse(JSON.stringify(B));G[0].status="in_progress",await R(s,G),v.debug("Steps initialized in Supabase",{projectType:s})}catch(G){v.error("Steps initialization error:",G)}X({title:"âœ… Projet ajoutÃ© !",description:`Le projet ${(T=_[s])==null?void 0:T.title} a Ã©tÃ© associÃ© au prospect.`})}xe(!1)},le=()=>{const s=o.tags||[];return Object.values(_).filter(m=>m.isPublic&&!s.includes(m.type))},d=async s=>{switch(s){case"Appel":o.phone&&(window.location.href=`tel:${o.phone}`);break;case"Mail":o.email&&(window.location.href=`mailto:${o.email}`);break;case"WhatsApp":if(o.phone){const m=o.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${m}`,"_blank")}else X({title:"NumÃ©ro de tÃ©lÃ©phone manquant",description:"Ce contact n'a pas de numÃ©ro de tÃ©lÃ©phone.",variant:"destructive"});break;case"GPS":if(t.address){const m=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${m}`:window.open(`https://www.google.com/maps/search/?api=1&query=${m}`,"_blank")}break;case"Invitation":if(!o.email){X({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const m=`${window.location.origin}/dashboard`,l=q||(D==null?void 0:D.organization_id);console.log("[handleActionClick] ðŸ“§ Sending magic link to:",o.email,"org:",l);const{error:T}=await pe.auth.signInWithOtp({email:o.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:m,data:{organization_id:l}}});T?(console.error("[handleActionClick] âŒ Magic link error:",T),X({title:"âŒ Erreur envoi invitation",description:T.message,variant:"destructive"})):(console.log("[handleActionClick] âœ… Magic link sent to:",o.email),X({title:"âœ… Invitation envoyÃ©e",description:`Magic link envoyÃ© Ã  ${o.email}`,className:"bg-green-500 text-white"}))}catch(m){console.error("[handleActionClick] ðŸ’¥ Exception:",m),X({title:"âŒ Erreur",description:m.message,variant:"destructive"})}break;default:X({title:`Action: ${s}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},A=()=>{const s=window.scrollY;oe(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:s,behavior:"instant"})})})},J=()=>{try{n(o),oe(!1),X({title:"âœ… Prospect mis Ã  jour",description:"Les informations du prospect ont Ã©tÃ© enregistrÃ©es."})}catch(s){v.error("âŒ Erreur sauvegarde:",s),X({title:"âŒ Erreur",description:s.message,variant:"destructive"})}},ae=(s,m)=>{P(l=>({...l,[s]:m}))},ye=s=>{let m=s;s==="unassigned"?m=null:s==="user-1"&&E&&(m=E),P(l=>({...l,ownerId:m}))};return _[z],i.useEffect(()=>{const s=document.createElement("style");return s.id="disable-auto-scroll",s.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(s),()=>{const m=document.getElementById("disable-auto-scroll");m&&m.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(et.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(he,{variant:"ghost",size:"icon",onClick:a,className:"rounded-full hover:bg-gray-100",children:e.jsx(Zs,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:o.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associÃ©s"}),e.jsx(he,{size:"icon",className:"rounded-full",onClick:()=>xe(!0),children:e.jsx(Lt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(o.tags||[]).map(s=>{var l;const m=ie[s]||"actif";return e.jsxs("button",{onClick:()=>Pe(s),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${z===s?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((l=_[s])==null?void 0:l.title)||s}),m==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${z===s?"text-red-200":"text-red-600"}`,children:"(AbandonnÃ©)"}),m==="archive"&&e.jsx("span",{className:`text-xs font-medium ${z===s?"text-gray-300":"text-gray-500"}`,children:"(ArchivÃ©)"})]},s)}),(!o.tags||o.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associÃ©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:lt,label:"Appel"},{icon:It,label:"Mail"},{icon:zt,label:"WhatsApp"},{icon:Ct,label:"GPS"},{icon:Us,label:"Invitation",highlight:!o.userId}].map(({icon:s,label:m,highlight:l})=>e.jsxs("button",{onClick:()=>d(m),className:`flex flex-col items-center space-x-1 transition-colors group ${l?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${l?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(s,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:m})]},m))})]}),e.jsx($r,{prospectId:t.id,projectType:z}),e.jsx(Dr,{prospect:o,projectType:z,supabaseSteps:u,v2Templates:S,onUpdate:s=>{P(s),n&&n(s)}}),e.jsx(Tr,{prospect:o,projectType:z,onUpdate:s=>{P(s),n&&n(s)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),ue?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(he,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:J,children:e.jsx(Jt,{className:"h-4 w-4"})}),e.jsx(he,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>oe(!1),children:e.jsx(Ze,{className:"h-4 w-4"})})]}):e.jsx(he,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:A,children:e.jsx(Nt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[k.map(s=>e.jsxs("div",{className:"flex items-start space-x-3",children:[Rr(s),e.jsxs("div",{className:"flex-1",children:[e.jsx(qe,{htmlFor:s.id,className:"text-xs text-gray-500",children:s.name.replace("*","")}),ue?e.jsx(Xe,{id:s.id,name:s.id,type:s.type,value:o[s.id]||"",onChange:m=>ae(s.id,m.target.value),className:"h-8 text-sm",placeholder:s.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:o[s.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseignÃ©"})})]})]},s.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(mt,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(qe,{className:"text-xs text-gray-500",children:"Suivi par"}),ue?e.jsx(Na,{options:Ne,value:o.ownerId||"unassigned",onSelect:ye,placeholder:"SÃ©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouvÃ©."}):e.jsx("p",{className:"text-gray-700",children:((De=w.find(s=>s.user_id===o.ownerId))==null?void 0:De.name)||"Non assignÃ©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(Da,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(qe,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(mt,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(qe,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assignÃ©"})]})]})]})]})]}),e.jsx(vr,{prospectId:t.id,projectType:z,currentStep:Me,statusConfig:ct,activeAdminUser:D,children:z&&e.jsx(Ar,{prospectId:t.id,projectType:z,currentStepIndex:Se!==-1?Se:0,activeAdminUser:D,initialChannel:_e})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[z&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>Ie(!ne),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:ne?"Annuler":"Modifier le montant",children:ne?e.jsx(Ze,{className:"h-4 w-4 text-gray-600"}):e.jsx(Nt,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),ne?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"â‚¬"}),e.jsx(Xe,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:te,onChange:s=>Re(s.target.value),onKeyDown:Oe,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(he,{size:"sm",onClick:We,className:"h-8",children:e.jsx(ht,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof W=="number"?ee.format(W):"0,00 â‚¬"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Ã‰tapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(qt,{value:L,onValueChange:Ye,children:[e.jsx(Vt,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${L==="actif"?"bg-green-100 text-green-700":L==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx(Bt,{})}),e.jsxs(Ht,{className:"w-44",children:[e.jsx(ze,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx(ze,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"AbandonnÃ©"}),e.jsx(ze,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"ArchivÃ©"})]})]})]})}),e.jsx(Pr,{steps:Q,onUpdateStatus:je,prompts:N,projectType:z,currentStepIndex:Se,prospectId:t.id,completeStepAndProceed:g})]})]})]})]}),e.jsx(vt,{open:V,onOpenChange:xe,children:e.jsxs(wt,{className:"sm:max-w-md",children:[e.jsxs(_t,{children:[e.jsx(St,{children:"Ajouter un projet"}),e.jsx(Ss,{children:"SÃ©lectionnez un projet Ã  associer Ã  ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:le().length>0?le().map(s=>e.jsxs(he,{variant:"outline",onClick:()=>ce(s.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:s.icon}),e.jsx("span",{className:"font-medium",children:s.title})]},s.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont dÃ©jÃ  associÃ©s Ã  ce prospect."})})]})})]})},$r=({prospectId:t,projectType:a})=>{var H;const{activeAdminUser:n,prospects:r,projectsData:x,appointments:g,agendaLoading:h,updateAppointment:f,deleteAppointment:_,addAppointment:k,addCall:y,addTask:b,updateCall:O,updateTask:p}=Je(),{users:$,loading:D}=pt(),{supabaseUserId:N}=ot(),[F,E]=i.useState(null),[w,c]=i.useState(null),[u,R]=i.useState(null),[q,S]=i.useState(!1),[M,re]=i.useState(null),de=i.useMemo(()=>!g||g.length===0?[]:g.filter(K=>{var oe;if(K.contactId!==t||a&&K.projectId!==a)return!1;const ue=(oe=K.status)==null?void 0:oe.toLowerCase();return!(ue!=="pending"&&ue!=="prevu")}).sort((K,ue)=>{const oe=new Date(K.start),o=new Date(ue.start);return oe-o}),[g,t,a]),fe=(I,K)=>{R(I)},_e=()=>{E(null),c(null),R(null)},z=I=>{R(null),re({...I,type:I.type}),S(!0)};return h?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"ActivitÃ© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activitÃ©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["ActivitÃ©s Ã  venir ",a&&`(${(H=x[a])==null?void 0:H.title})`]})}),de.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activitÃ© future planifiÃ©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:de.map(I=>{const K=new Date(I.start),ue={physical:{icon:ut,color:"blue",label:"ðŸ“ RDV"},virtual:{icon:ut,color:"purple",label:"ðŸŽ¥ Visio"},call:{icon:lt,color:"green",label:"ðŸ“ž Appel"},task:{icon:ht,color:"yellow",label:"âœ… TÃ¢che"}},oe=ue[I.type]||ue.physical,o=oe.icon,P={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},V={effectue:"EffectuÃ©",annule:"AnnulÃ©",reporte:"ReportÃ©",pending:"PrÃ©vu"};return e.jsxs("div",{onClick:()=>fe(I,I.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${oe.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(o,{className:`h-5 w-5 text-${oe.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:I.title||oe.label}),I.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:I.notes}),I.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["ðŸ“ ",I.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${oe.color}-700 bg-${oe.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:tt(K,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:tt(K,"HH:mm")})]})]}),V[I.status]&&I.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${P[I.status]}`,children:V[I.status]})]},I.id)})})]}),e.jsx(Fr,{event:u,onClose:_e,onReport:()=>{},onEdit:z,prospects:r,supabaseUsers:$,updateAppointment:f,deleteAppointment:_,projectsData:x}),q&&e.jsx(Cs,{open:q,onOpenChange:I=>{I||re(null),S(I)},initialData:M||{contactId:t,projectId:a},defaultAssignedUserId:N,addAppointment:k,addCall:y,addTask:b,updateAppointment:f,updateCall:O,updateTask:p,prospects:r||[],users:$||[],projectsData:x||{}})]})},Fr=({event:t,onClose:a,onReport:n,onEdit:r,prospects:x,supabaseUsers:g,updateAppointment:h,deleteAppointment:f,projectsData:_})=>{var w;const[k,y]=i.useState((t==null?void 0:t.status)||"pending");if(i.useEffect(()=>{t&&y(t.status||"pending")},[t]),!t||!x||!g||!h||!f||!_)return null;const b=x.find(c=>c.id===t.contactId),O=g.find(c=>c.id===t.assignedUserId||c.user_id===t.assignedUserId)||(b?g.find(c=>c.user_id===b.ownerId):null),p=c=>c?c.charAt(0).toUpperCase()+c.slice(1):"",$=(c,u,R={})=>{try{const q=new Date(c);return isNaN(q.getTime())?"Date invalide":tt(q,u,R)}catch{return"Date invalide"}},D=c=>{y(c),h(t.id,{status:c}),setTimeout(()=>{a(),c==="reporte"&&n(t)},300)},N=()=>{f(t.id),X({title:"âœ… RDV supprimÃ©",description:"Le rendez-vous a Ã©tÃ© retirÃ© de votre agenda."}),a()},F=c=>{if(!b){X({title:"Contact non trouvÃ©",variant:"destructive"});return}switch(c){case"Appel":b.phone&&(window.location.href=`tel:${b.phone}`);break;case"Mail":b.email&&(window.location.href=`mailto:${b.email}`);break;case"WhatsApp":if(b.phone){let u=b.phone.replace(/\D/g,"");u.startsWith("0")&&(u=`33${u.substring(1)}`);const R=encodeURIComponent("Bonjour");window.open(`https://wa.me/${u}?text=${R}`,"_blank")}break;case"GPS":if(b.address){const u=encodeURIComponent(b.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${u}`:window.open(`https://www.google.com/maps/search/?api=1&query=${u}`,"_blank")}break;default:X({title:`Action: ${c}`,description:"ðŸš§ Cette fonctionnalitÃ© n'est pas encore implÃ©mentÃ©e."})}},E={pending:{color:"bg-blue-500",label:"Qualifier votre activitÃ©"},effectue:{color:"bg-green-500",label:"EffectuÃ©"},annule:{color:"bg-red-500",label:"AnnulÃ©"},reporte:{color:"bg-yellow-500",label:"ReportÃ©"}};return e.jsx(vt,{open:!!t,onOpenChange:c=>!c&&a(),children:e.jsxs(wt,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:a,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Ze,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:p($(t.start,"eeee d MMMM",{locale:Ge}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[$(t.start,"HH:mm",{locale:Ge})," - ",$(t.end,"HH:mm",{locale:Ge})]})]}),e.jsx(_t,{className:"p-0 text-left space-y-1",children:e.jsx(St,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(nt,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),b&&e.jsxs("p",{className:"text-sm",children:[b.name," (Client)"]}),O&&e.jsxs("p",{className:"text-sm",children:[O.name," (AssignÃ©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:lt,label:"Appel"},{icon:It,label:"Mail"},{icon:zt,label:"WhatsApp"},{icon:Ct,label:"GPS"}].map(({icon:c,label:u})=>e.jsxs("button",{onClick:()=>F(u),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(c,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:u})]},u))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${E[k].color}`,children:e.jsxs(qt,{onValueChange:D,value:k,children:[e.jsx(Vt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx(Bt,{placeholder:"Qualifier votre activitÃ©"})}),e.jsxs(Ht,{children:[e.jsx(ze,{value:"pending",disabled:!0,children:"Qualifier votre activitÃ©"}),e.jsx(ze,{value:"effectue",children:"EffectuÃ©"}),e.jsx(ze,{value:"annule",children:"AnnulÃ©"}),e.jsx(ze,{value:"reporte",children:"ReportÃ©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activitÃ©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((w=_[t.projectId])==null?void 0:w.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ã‰tape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(b==null?void 0:b.name)||"N/A"})]})]})]}),e.jsxs(Wt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(us,{children:[e.jsx(ms,{asChild:!0,children:e.jsxs(he,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(Gt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(gs,{children:[e.jsxs(xs,{children:[e.jsx(ps,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(hs,{children:"Cette action est irrÃ©versible. Le rendez-vous sera dÃ©finitivement supprimÃ©."})]}),e.jsxs(fs,{children:[e.jsx(bs,{children:"Annuler"}),e.jsx(js,{onClick:N,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(he,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activitÃ©"})]})]})})};function Or(t,a){const n=t.prospect,r=a.prospect;return!n||!r?!1:n.id===r.id&&(n.updatedAt||n.updated_at)===(r.updatedAt||r.updated_at)}const Lr=jt.memo(Mr,Or),os=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],zr=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" "):"",Qe=t=>(t||"").toString().trim().toUpperCase(),qr={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},Vr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFIÃ‰",name:"QualifiÃ©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"NÃ‰GOCIATION",name:"NÃ©gociation"},{id:"closed",label:"FERMÃ‰",name:"FermÃ©"}],cs=50,ds=50,Ur=()=>{var ce,le;const t=Je(),[a,n]=ws(),{organizationId:r}=xt(),[x,g]=i.useState(null),[h,f]=i.useState(!1),[_,k]=i.useState("all"),[y,b]=i.useState(null),[O,p]=i.useState(!1),[$,D]=i.useState([]),[N,F]=i.useState(!1),E=i.useRef(null),[w,c]=i.useState(""),u=i.useRef(null),[R,q]=i.useState(!1),[S,M]=i.useState(!1),[re,de]=i.useState({}),{users:fe,loading:_e}=pt(),{authUserId:z}=ot(),H=t==null?void 0:t.addProspect,{prospects:I=[],prospectsLoading:K=!0,allProjectSteps:ue={},allStepsLoading:oe=!0,updateProspect:o=async()=>{},projectsData:P={},activeAdminUser:V=null,users:xe={},globalPipelineSteps:C=[],pipelineLoading:L=!0,getProjectSteps:j=()=>[],adminReady:ie=!1}=t||{},se=i.useMemo(()=>fe.reduce((d,A)=>(d[A.user_id]={id:A.id,user_id:A.user_id,name:A.name,email:A.email,role:A.role,phone:A.phone,avatarUrl:A.avatar_url,managerId:A.manager_id,accessRights:A.access_rights},d),{}),[fe]);i.useEffect(()=>{ie&&!K&&!oe&&!S&&M(!0)},[ie,K,oe,S]);const W=I,ee=o,te=(I==null?void 0:I.find(d=>d.id===x))||null,me=i.useMemo(()=>!C||C.length===0?Vr:C.map((d,A)=>{const J=Qe(d.label),ae=d.color||qr[J]||os[A%os.length];return{id:d.id,label:d.label,name:zr(d.label),color:ae}}),[C]),ne=i.useMemo(()=>{if(!V)return[];if(V.role==="Global Admin"||V.role==="Admin")return Object.values(se);const d=V.access_rights||V.accessRights,A=[V.user_id,...(d==null?void 0:d.users)||[]];return Object.values(se).filter(J=>A.includes(J.user_id))},[V,se]),Ie=i.useMemo(()=>{const d=ne.map(A=>({value:A.user_id,label:A.name}));return ne.length>1?[{value:"all",label:"Tous les utilisateurs"},...d]:d},[ne]);i.useEffect(()=>{V&&y===null&&(ne.length>1?b("all"):ne.length===1&&b(ne[0].user_id))},[V,y,ne]),i.useEffect(()=>{if(!N)return;const d=A=>{E.current&&!E.current.contains(A.target)&&F(!1)};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[N]);const Ne=i.useMemo(()=>{const d=new Set;return W.forEach(A=>{(A.tags||[]).forEach(J=>d.add(J))}),Array.from(d)},[W]),Q=$.length===0?"Tags":$.length===1?((ce=P[$[0]])==null?void 0:ce.title)||$[0]:`${$.length} tags`,Se=i.useMemo(()=>{const d=W.filter(J=>{if(!V)return!1;if(V.role==="Global Admin"||V.role==="Admin")return!0;const ae=V.access_rights||V.accessRights;return[V.user_id,...(ae==null?void 0:ae.users)||[]].includes(J.ownerId)});v.debug("[FinalPipeline] Prospects count",{total:W.length,visible:d.length});let A=d;if($.length>0&&(A=A.filter(J=>{const ae=J.tags||[];return $.some(ye=>ae.includes(ye))})),y&&y!=="all"&&(A=A.filter(J=>J.ownerId===y)),w.trim()){const J=w.toLowerCase();A=A.filter(ae=>(ae.name||"").toLowerCase().includes(J)||(ae.email||"").toLowerCase().includes(J)||(ae.city||"").toLowerCase().includes(J)||(ae.phone||"").toLowerCase().includes(J))}return _==="mine"&&z?A.filter(J=>J.ownerId===z):A},[W,_,z,y,$,w]),{stagesWithCounts:Me,prospectsByStage:Pe}=i.useMemo(()=>{var m;const d=me.reduce((l,T)=>(l[T.id]=[],l),{}),A=((m=me[0])==null?void 0:m.id)||"fallback-stage",J=new Set(me.map(l=>l.id)),ae=new Map(me.map(l=>[Qe(l.label),l.id])),ye=l=>{const T=[];return l.projectType&&P[l.projectType]&&T.push(l.projectType),Array.isArray(l.tags)&&l.tags.forEach(Y=>{P[Y]&&!T.includes(Y)&&T.push(Y)}),T},De=l=>{const T=[];if(!C.length){const B=l.stage||A,G=J.has(B)?B:A;return T.push({stageId:G,prospect:l}),T}if(typeof j!="function")return T.push({stageId:A,prospect:l}),T;const Y=ye(l);return Y.length?(Y.forEach(B=>{var Le;const G=`${l.id}-${B}`,Z=ue[G]||(typeof j=="function"?j(l.id,B):[])||[],ge=((Le=P[B])==null?void 0:Le.steps)||[];if(!Z.length){T.push({stageId:A,prospect:l,projectType:B});return}const U=Z.find(Ce=>Ce.status==="in_progress"||Ce.status==="current")||Z.find(Ce=>Ce.status==="pending")||Z[Z.length-1];if(!U){T.push({stageId:A,prospect:l,projectType:B});return}const $e=(()=>{if(U.globalStepId&&J.has(U.globalStepId))return U.globalStepId;if(U.globalStepId){const Te=Qe(U.globalStepId),we=ae.get(Te);if(we&&J.has(we))return we}const Ce=Z.indexOf(U);let ve=null;if(Ce>=0&&ge[Ce]&&(ve=ge[Ce]),!ve){const Te=Qe(U.name||U.label);ve=ge.find(we=>Qe(we.name||we.label)===Te)}if(ve!=null&&ve.globalStepId&&J.has(ve.globalStepId))return ve.globalStepId;if(ve!=null&&ve.globalStepId){const Te=Qe(ve.globalStepId),we=ae.get(Te);if(we&&J.has(we))return we}if(ve&&(ve.label||ve.name)){const Te=Qe(ve.label||ve.name),we=ae.get(Te);if(we&&J.has(we))return we}const be=Qe(U.label||U.name),ke=ae.get(be);return ke&&J.has(ke)?ke:A})();T.push({stageId:$e,prospect:l,projectType:B,activeStep:U})}),T):(T.push({stageId:A,prospect:l}),T)};return Se.forEach(l=>{De(l).forEach(({stageId:Y,projectType:B,activeStep:G})=>{d[Y]||(d[Y]=[]),d[Y].push({prospect:l,projectType:B,activeStep:G})})}),{stagesWithCounts:me.map(l=>{var T;return{...l,count:((T=d[l.id])==null?void 0:T.length)||0}}),prospectsByStage:d}},[me,Se,C,j,P]);i.useEffect(()=>{const d=a.get("prospect"),A=a.get("project"),J=`${d}-${A}`;if(u.current===J)return;if(!d){x!==null&&(g(null),u.current=null);return}(W.find(ye=>ye.id===d)||null)&&(g(d),u.current=J)},[a,W]);const Ye=d=>{D(A=>A.includes(d)?A.filter(J=>J!==d):[...A,d])},Re=i.useCallback((d,A)=>{g(d.id),n(J=>{const ae=new URLSearchParams(J);return ae.set("prospect",d.id),A?ae.set("project",A):ae.delete("project"),ae})},[n]),Ke=i.useCallback(d=>{de(A=>({...A,[d]:(A[d]||cs)+ds}))},[]),We=()=>{g(null);const d=new URLSearchParams(a);d.delete("prospect"),d.delete("project"),n(d)},Oe=async d=>{var A,J;try{if(!H)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const ae=((A=C[0])==null?void 0:A.step_id)||((J=C[0])==null?void 0:J.id);console.log("[handleAddProspect] calling addProspect",{name:d.name,email:d.email,status:ae,ownerId:V==null?void 0:V.user_id,sendInvitation:d.sendInvitation,allData:d});const ye=await H({...d,status:ae,ownerId:V==null?void 0:V.user_id});if(console.log("[handleAddProspect] result",ye),!(ye!=null&&ye.id))throw new Error("Prospect non crÃ©Ã© - rÃ©sultat vide");if(console.log("[handleAddProspect] ðŸ” sendInvitation check:",{sendInvitation:d.sendInvitation,email:ye.email,willSend:d.sendInvitation&&ye.email}),d.sendInvitation&&ye.email)try{const De=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] ðŸ“§ Sending magic link to:",ye.email.trim(),"redirect:",De,"org:",r);const{error:s}=await pe.auth.signInWithOtp({email:ye.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:De,data:{organization_id:r}}});s?(console.error("[handleAddProspect] âŒ invitation error",s),X({title:"Prospect crÃ©Ã©",description:`âš ï¸ Invitation non envoyÃ©e: ${s.message}`,variant:"warning"})):(console.log("[handleAddProspect] âœ… invitation sent to",ye.email),X({title:"âœ… Prospect crÃ©Ã©",description:`Invitation envoyÃ©e Ã  ${ye.email}`,className:"bg-green-500 text-white"}))}catch(De){console.error("[handleAddProspect] ðŸ’¥ invitation exception",De),X({title:"Prospect crÃ©Ã©",description:`âš ï¸ Erreur envoi invitation: ${De.message}`,variant:"warning"})}else console.log("[handleAddProspect] â­ï¸ Skipping invitation:",{reason:d.sendInvitation?"no email":"sendInvitation=false"});f(!1)}catch(ae){console.error("âŒ handleAddProspect error",ae),X({title:"Erreur",description:ae.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},je=d=>{try{ee&&(ee(d),X({title:"Prospect mis Ã  jour",description:"Les informations ont Ã©tÃ© sauvegardÃ©es."}))}catch{X({title:"Erreur",description:"Impossible de mettre Ã  jour le prospect.",variant:"destructive"})}};return te&&te.id?e.jsx(et.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(oa,{name:"Fiche Prospect",children:e.jsx(Lr,{prospect:te,onBack:We,onUpdate:je,onEditingChange:q})})}):S?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(nt,{className:"w-4 h-4"}),e.jsxs("span",{children:[Se.length," prospect",Se.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:E,className:"relative inline-block text-left",children:[e.jsxs(he,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>F(d=>!d),children:[e.jsx("span",{children:Q}),e.jsx(Tt,{className:"h-4 w-4"})]}),N&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[Ne.map(d=>{var A;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:$.includes(d),onChange:()=>Ye(d),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((A=P[d])==null?void 0:A.title)||d})]},d)}),$.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>D([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la sÃ©lection"})]})]})})]}),e.jsxs(ca,{open:O,onOpenChange:p,children:[e.jsx(da,{asChild:!0,children:e.jsxs(he,{variant:"outline",role:"combobox","aria-expanded":O,className:"w-[230px] justify-between",children:[e.jsx(nt,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:y==="all"?"Tous les utilisateurs":((le=se[y])==null?void 0:le.name)||"Utilisateur"}),e.jsx(Tt,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(ua,{className:"w-[200px] p-0",children:e.jsxs(ma,{children:[e.jsx(ga,{placeholder:"Rechercher..."}),e.jsxs(xa,{children:[e.jsx(pa,{children:"Aucun utilisateur"}),e.jsx(ha,{children:Ie.map(d=>e.jsxs(fa,{value:d.label,onSelect:()=>{b(d.value),p(!1)},children:[e.jsx(ht,{className:at("mr-2 h-4 w-4",y===d.value?"opacity-100":"opacity-0")}),d.label]},d.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(ba,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Xe,{type:"text",placeholder:"Rechercher un prospect...",value:w,onChange:d=>c(d.target.value),className:"pl-9 pr-4"}),w&&e.jsx("button",{onClick:()=>c(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"Ã—"})]}),e.jsxs(he,{onClick:()=>f(!0),children:[e.jsx(Lt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Me.map(d=>e.jsxs(et.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${d.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:d.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(Pe[d.id]||[]).filter(A=>{if($.length===0)return!0;const{projectType:J}=A;return $.some(ae=>ae.toUpperCase()===(J||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const A=(Pe[d.id]||[]).filter(s=>{if($.length===0)return!0;const{projectType:m}=s;return $.some(l=>l.toUpperCase()===(m||"").toUpperCase())}),J=re[d.id]||cs,ae=A.slice(0,J),ye=A.length>J,De=A.length-J;return e.jsxs(e.Fragment,{children:[ae.map((s,m)=>{var $e;const{prospect:l,projectType:T,activeStep:Y}=s,B=`${l.id}-${T||"default"}-${d.id}-${m}`,G=l.projectType||l.tags&&l.tags[0]||"Projet",Z=T&&(($e=P[T])!=null&&$e.title)?P[T].title:G,ge=(Y==null?void 0:Y.label)||(Y==null?void 0:Y.name)||d.name,U=d.color||"bg-blue-100 text-blue-700",Ae=`${l.id}-${T||Z}-${d.id}-${m}`;return e.jsx(et.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(gr,{prospect:{...l,_projectContext:{projectType:T||G,projectTitle:Z,stepLabel:ge,projectColor:U}},onClick:()=>Re(l,T||l.projectType||(Array.isArray(l.tags)?l.tags[0]:G)),compact:!0,sortableId:Ae,projectsData:P})},B)}),ye&&e.jsxs("button",{onClick:()=>Ke(d.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(De,ds)," de plus (",De," restants)"]}),A.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(nt,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},d.id))})})}),e.jsx(ja,{open:h,onOpenChange:f,onAddProspect:Oe}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(d=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},d))})})})]})};export{Ur as default};
