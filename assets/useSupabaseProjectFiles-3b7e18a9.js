import{r as u,s as d,l as _}from"./index-e8fae7c0.js";const n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));function V(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}let U;const j=new Uint8Array(16);function k(){if(!U){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");U=crypto.getRandomValues.bind(crypto)}return U(j)}const z=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),S={randomUUID:z};function I(e,t,a){var y;e=e||{};const o=e.random??((y=e.rng)==null?void 0:y.call(e))??k();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){if(a=a||0,a<0||a+16>t.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);for(let c=0;c<16;++c)t[a+c]=o[c];return t}return V(o)}function L(e,t,a){return S.randomUUID&&!t&&!e?S.randomUUID():I(e,t,a)}function N({projectType:e,prospectId:t,organizationId:a=null,enabled:o=!0}){const[y,c]=u.useState([]),[x,b]=u.useState(!1),[R,v]=u.useState(!1),[$,D]=u.useState(!1),[q,g]=u.useState(null),E=u.useCallback(async()=>{if(!(!e||!o))try{b(!0),g(null);let r=d.from("project_files").select("*").eq("project_type",e).order("created_at",{ascending:!1});t&&(r=r.eq("prospect_id",t));const{data:s,error:l}=await r;if(l)throw l;c(s||[])}catch(r){_.error("Error fetching project files:",r),g(r.message)}finally{b(!1)}},[e,t,o]);u.useEffect(()=>{if(!e||!o)return;E();const r=d.channel(`project-files-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"project_files",filter:`project_type=eq.${e}`},s=>{_.debug("Realtime event",{eventType:s.eventType}),c(l=>{var w;const{eventType:i,new:f,old:m}=s;if(i==="INSERT")return[f,...l];if(i==="DELETE"){const h=(m==null?void 0:m.id)||((w=s.old)==null?void 0:w.id);return l.filter(p=>p.id!==h)}return i==="UPDATE"?l.map(h=>h.id===f.id?f:h):l})}).subscribe();return()=>{d.removeChannel(r)}},[e,o,E]);const C=u.useCallback(async({file:r,uploadedBy:s,fieldLabel:l=null})=>{if(!(!r||!e))try{v(!0),g(null);const i=r.name.split(".").pop(),f=`${L()}.${i}`,m=`${e}/${f}`,{error:w}=await d.storage.from("project-files").upload(m,r);if(w)throw w;const{data:h,error:p}=await d.from("project_files").insert([{project_type:e,prospect_id:t||null,organization_id:a||null,file_name:r.name,file_type:r.type,file_size:r.size,storage_path:m,uploaded_by:s||null,field_label:l}]).select().single();if(p)throw p;return h}catch(i){throw _.error("Error uploading file:",i),g(i.message),i}finally{v(!1)}},[e,t]),F=u.useCallback(async(r,s)=>{if(!(!r||!s))try{D(!0),g(null);const{error:l}=await d.storage.from("project-files").remove([s]);if(l)throw l;const{error:i}=await d.from("project_files").delete().eq("id",r);if(i)throw i}catch(l){throw _.error("Error deleting file:",l),g(l.message),l}finally{D(!1)}},[]);return{files:y,loading:x,uploading:R,deleting:$,error:q,uploadFile:C,deleteFile:F,refetch:E}}export{N as u};
