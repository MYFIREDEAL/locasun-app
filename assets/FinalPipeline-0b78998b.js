import{c as Et,r as n,R as gt,u as ks,j as e,m as Ye,C as nt,l as w,s as ge,a as ot,b as Ve,d as As,e as et,f as Es,g as St,h as ct,B as pe,P as Pt,D as ht,i as ft,X as Je,k as bt,n as jt,U as Ue,o as tt,M as yt,p as Dt,q as vt,S as Tt,t as Rt,v as $t,w as Ft,x as Fe,y as Mt,A as as,z as rs,T as zt,E as ns,F as is,G as ls,H as os,I as cs,J as ds,K as us,L as J,N as ze,O as Ps,Q as ms,V as Ds,W as gs,Y as Vt,Z as Ts,_ as Rs,$ as Qe,a0 as $s,a1 as Fs,a2 as Ms,a3 as it,a4 as zs,a5 as xs,a6 as ps,a7 as Os,a8 as Ls,a9 as Me,aa as Be,ab as dt,ac as hs,ad as qs,ae as Vs,af as Bs,ag as Hs,ah as Gs,ai as Ws,aj as Js,ak as Xs,al as Ys,am as Ks,an as Qs,ao as Zs,ap as Us,aq as ea,ar as ta,as as sa,at as aa,au as ra}from"./index-6abd78e1.js";import{u as st,A as fs,C as na}from"./Agenda-80ef617d.js";import{S as ia}from"./SearchableSelect-090cbc88.js";import{u as la}from"./useSupabaseProjectStepsStatus-eab35557.js";import{u as bs,a as js}from"./useSupabaseProjectFiles-2fbbea26.js";import{F as oa,a as ca,P as da,b as ua,e as ma,u as ys,S as Ot,c as ga}from"./useSupabaseWorkflowModuleTemplates-086f2511.js";import{f as Ke,a as Oe,V as xa}from"./index-4e48c339.js";import{D as xt}from"./download-a916a253.js";import{i as pa}from"./workflowV2Config-f801420c.js";import{P as pt}from"./pen-square-078e9ba9.js";import{f as ha,P as Bt}from"./index-e9ef58e1.js";import"./external-link-6901882e.js";const fa=Et("Activity",[["path",{d:"M22 12h-4l-3 9L9 3l-3 9H2",key:"d5dnw9"}]]),ba=Et("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),ja=Et("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function ya(){for(var t=arguments.length,s=new Array(t),a=0;a<t;a++)s[a]=arguments[a];return n.useMemo(()=>r=>{s.forEach(c=>c(r))},s)}const va=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function Na(t){const s=Object.prototype.toString.call(t);return s==="[object Window]"||s==="[object global]"}function wa(t){return"nodeType"in t}function vs(t){var s,a;return t?Na(t)?t:wa(t)&&(s=(a=t.ownerDocument)==null?void 0:a.defaultView)!=null?s:window:window}const Nt=va?n.useLayoutEffect:n.useEffect;function Ns(t){const s=n.useRef(t);return Nt(()=>{s.current=t}),n.useCallback(function(){for(var a=arguments.length,r=new Array(a),c=0;c<a;c++)r[c]=arguments[c];return s.current==null?void 0:s.current(...r)},[])}function Ct(t,s){s===void 0&&(s=[t]);const a=n.useRef(t);return Nt(()=>{a.current!==t&&(a.current=t)},s),a}function It(t){const s=Ns(t),a=n.useRef(null),r=n.useCallback(c=>{c!==a.current&&(s==null||s(c,a.current)),a.current=c},[]);return[a,r]}let _t={};function ws(t,s){return n.useMemo(()=>{if(s)return s;const a=_t[t]==null?0:_t[t]+1;return _t[t]=a,t+"-"+a},[t,s])}function _a(t){if(!t)return!1;const{KeyboardEvent:s}=vs(t.target);return s&&t instanceof s}const lt=Object.freeze({Translate:{toString(t){if(!t)return;const{x:s,y:a}=t;return"translate3d("+(s?Math.round(s):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(t){if(!t)return;const{scaleX:s,scaleY:a}=t;return"scaleX("+s+") scaleY("+a+")"}},Transform:{toString(t){if(t)return[lt.Translate.toString(t),lt.Scale.toString(t)].join(" ")}},Transition:{toString(t){let{property:s,duration:a,easing:r}=t;return s+" "+a+"ms "+r}}});var rt;(function(t){t.DragStart="dragStart",t.DragMove="dragMove",t.DragEnd="dragEnd",t.DragCancel="dragCancel",t.DragOver="dragOver",t.RegisterDroppable="registerDroppable",t.SetDroppableDisabled="setDroppableDisabled",t.UnregisterDroppable="unregisterDroppable"})(rt||(rt={}));function Ht(){}const Sa=Object.freeze({x:0,y:0});function Ca(t){if(t.startsWith("matrix3d(")){const s=t.slice(9,-1).split(/, /);return{x:+s[12],y:+s[13],scaleX:+s[0],scaleY:+s[5]}}else if(t.startsWith("matrix(")){const s=t.slice(7,-1).split(/, /);return{x:+s[4],y:+s[5],scaleX:+s[0],scaleY:+s[3]}}return null}function Ia(t,s,a){const r=Ca(s);if(!r)return t;const{scaleX:c,scaleY:d,x:m,y:g}=r,v=t.left-m-(1-c)*parseFloat(a),S=t.top-g-(1-d)*parseFloat(a.slice(a.indexOf(" ")+1)),b=c?t.width/c:t.width,p=d?t.height/d:t.height;return{width:b,height:p,top:S,right:v+b,bottom:S+p,left:v}}const ka={ignoreTransform:!1};function Lt(t,s){s===void 0&&(s=ka);let a=t.getBoundingClientRect();if(s.ignoreTransform){const{transform:S,transformOrigin:b}=vs(t).getComputedStyle(t);S&&(a=Ia(a,S,b))}const{top:r,left:c,width:d,height:m,bottom:g,right:v}=a;return{top:r,left:c,width:d,height:m,bottom:g,right:v}}function Gt(t){return Lt(t,{ignoreTransform:!0})}var Ze;(function(t){t[t.Forward=1]="Forward",t[t.Backward=-1]="Backward"})(Ze||(Ze={}));var Wt;(function(t){t.Click="click",t.DragStart="dragstart",t.Keydown="keydown",t.ContextMenu="contextmenu",t.Resize="resize",t.SelectionChange="selectionchange",t.VisibilityChange="visibilitychange"})(Wt||(Wt={}));var $e;(function(t){t.Space="Space",t.Down="ArrowDown",t.Right="ArrowRight",t.Left="ArrowLeft",t.Up="ArrowUp",t.Esc="Escape",t.Enter="Enter",t.Tab="Tab"})($e||($e={}));$e.Space,$e.Enter,$e.Esc,$e.Space,$e.Enter,$e.Tab;var Jt;(function(t){t[t.RightClick=2]="RightClick"})(Jt||(Jt={}));var Xt;(function(t){t[t.Pointer=0]="Pointer",t[t.DraggableRect=1]="DraggableRect"})(Xt||(Xt={}));var Yt;(function(t){t[t.TreeOrder=0]="TreeOrder",t[t.ReversedTreeOrder=1]="ReversedTreeOrder"})(Yt||(Yt={}));Ze.Backward+"",Ze.Forward+"",Ze.Backward+"",Ze.Forward+"";var kt;(function(t){t[t.Always=0]="Always",t[t.BeforeDragging=1]="BeforeDragging",t[t.WhileDragging=2]="WhileDragging"})(kt||(kt={}));var At;(function(t){t.Optimized="optimized"})(At||(At={}));function Aa(t){let{callback:s,disabled:a}=t;const r=Ns(s),c=n.useMemo(()=>{if(a||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:d}=window;return new d(r)},[a]);return n.useEffect(()=>()=>c==null?void 0:c.disconnect(),[c]),c}function Ea(t,s){return n.useMemo(()=>t.reduce((a,r)=>{let{eventName:c,handler:d}=r;return a[c]=m=>{d(m,s)},a},{}),[t,s])}kt.WhileDragging,At.Optimized;const Pa={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Ht,draggableNodes:new Map,over:null,measureDroppableContainers:Ht},_s=n.createContext(Pa),Da=n.createContext({...Sa,scaleX:1,scaleY:1});var Kt;(function(t){t[t.Uninitialized=0]="Uninitialized",t[t.Initializing=1]="Initializing",t[t.Initialized=2]="Initialized"})(Kt||(Kt={}));const Ta=n.createContext(null),Qt="button",Ra="Draggable";function $a(t){let{id:s,data:a,disabled:r=!1,attributes:c}=t;const d=ws(Ra),{activators:m,activatorEvent:g,active:v,activeNodeRect:S,ariaDescribedById:b,draggableNodes:p,over:z}=n.useContext(_s),{role:x=Qt,roleDescription:F="draggable",tabIndex:D=0}=c??{},f=(v==null?void 0:v.id)===s,A=n.useContext(f?Da:Ta),[P,y]=It(),[i,o]=It(),T=Ea(m,s),H=Ct(a);Nt(()=>(p.set(s,{id:s,key:d,node:P,activatorNode:i,data:H}),()=>{const M=p.get(s);M&&M.key===d&&p.delete(s)}),[p,s]);const N=n.useMemo(()=>({role:x,tabIndex:D,"aria-disabled":r,"aria-pressed":f&&x===Qt?!0:void 0,"aria-roledescription":F,"aria-describedby":b.draggable}),[r,x,D,f,F,b.draggable]);return{active:v,activatorEvent:g,activeNodeRect:S,attributes:N,isDragging:f,listeners:r?void 0:T,node:P,over:z,setNodeRef:y,setActivatorNodeRef:o,transform:A}}const Fa="Droppable",Ma={timeout:25};function za(t){let{data:s,disabled:a=!1,id:r,resizeObserverConfig:c}=t;const d=ws(Fa),{active:m,dispatch:g,over:v,measureDroppableContainers:S}=n.useContext(_s),b=n.useRef({disabled:a}),p=n.useRef(!1),z=n.useRef(null),x=n.useRef(null),{disabled:F,updateMeasurementsFor:D,timeout:f}={...Ma,...c},A=Ct(D??r),P=n.useCallback(()=>{if(!p.current){p.current=!0;return}x.current!=null&&clearTimeout(x.current),x.current=setTimeout(()=>{S(Array.isArray(A.current)?A.current:[A.current]),x.current=null},f)},[f]),y=Aa({callback:P,disabled:F||!m}),i=n.useCallback((N,M)=>{y&&(M&&(y.unobserve(M),p.current=!1),N&&y.observe(N))},[y]),[o,T]=It(i),H=Ct(s);return n.useEffect(()=>{!y||!o.current||(y.disconnect(),p.current=!1,y.observe(o.current))},[o,y]),n.useEffect(()=>(g({type:rt.RegisterDroppable,element:{id:r,key:d,disabled:a,node:o,rect:z,data:H}}),()=>g({type:rt.UnregisterDroppable,key:d,id:r})),[r]),n.useEffect(()=>{a!==b.current.disabled&&(g({type:rt.SetDroppableDisabled,id:r,key:d,disabled:a}),b.current.disabled=a)},[r,d,a,g]),{active:m,rect:z,isOver:(v==null?void 0:v.id)===r,node:o,over:v,setNodeRef:T}}function Ss(t,s,a){const r=t.slice();return r.splice(a<0?r.length+a:a,0,r.splice(s,1)[0]),r}function mt(t){return t!==null&&t>=0}const Oa=t=>{let{rects:s,activeIndex:a,overIndex:r,index:c}=t;const d=Ss(s,r,a),m=s[c],g=d[c];return!g||!m?null:{x:g.left-m.left,y:g.top-m.top,scaleX:g.width/m.width,scaleY:g.height/m.height}},La="Sortable",qa=gt.createContext({activeIndex:-1,containerId:La,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Oa,disabled:{draggable:!1,droppable:!1}}),Va=t=>{let{id:s,items:a,activeIndex:r,overIndex:c}=t;return Ss(a,r,c).indexOf(s)},Ba=t=>{let{containerId:s,isSorting:a,wasDragging:r,index:c,items:d,newIndex:m,previousItems:g,previousContainerId:v,transition:S}=t;return!S||!r||g!==d&&c===m?!1:a?!0:m!==c&&s===v},Ha={duration:200,easing:"ease"},Cs="transform",Ga=lt.Transition.toString({property:Cs,duration:0,easing:"linear"}),Wa={roleDescription:"sortable"};function Ja(t){let{disabled:s,index:a,node:r,rect:c}=t;const[d,m]=n.useState(null),g=n.useRef(a);return Nt(()=>{if(!s&&a!==g.current&&r.current){const v=c.current;if(v){const S=Lt(r.current,{ignoreTransform:!0}),b={x:v.left-S.left,y:v.top-S.top,scaleX:v.width/S.width,scaleY:v.height/S.height};(b.x||b.y)&&m(b)}}a!==g.current&&(g.current=a)},[s,a,r,c]),n.useEffect(()=>{d&&m(null)},[d]),d}function Xa(t){let{animateLayoutChanges:s=Ba,attributes:a,disabled:r,data:c,getNewIndex:d=Va,id:m,strategy:g,resizeObserverConfig:v,transition:S=Ha}=t;const{items:b,containerId:p,activeIndex:z,disabled:x,disableTransforms:F,sortedRects:D,overIndex:f,useDragOverlay:A,strategy:P}=n.useContext(qa),y=Ya(r,x),i=b.indexOf(m),o=n.useMemo(()=>({sortable:{containerId:p,index:i,items:b},...c}),[p,c,i,b]),T=n.useMemo(()=>b.slice(b.indexOf(m)),[b,m]),{rect:H,node:N,isOver:M,setNodeRef:ne}=za({id:m,data:o,disabled:y.droppable,resizeObserverConfig:{updateMeasurementsFor:T,...v}}),{active:ie,activatorEvent:me,activeNodeRect:B,attributes:he,setNodeRef:Q,listeners:E,isDragging:G,over:ue,setActivatorNodeRef:q,transform:u}=$a({id:m,data:o,attributes:{...Wa,...a},disabled:y.draggable}),O=ya(ne,Q),V=!!ie,le=V&&!F&&mt(z)&&mt(f),h=!A&&G,C=h&&le?u:null,L=le?C??(g??P)({rects:D,activeNodeRect:B,activeIndex:z,overIndex:f,index:i}):null,te=mt(z)&&mt(f)?d({id:m,items:b,activeIndex:z,overIndex:f}):i,W=ie==null?void 0:ie.id,Z=n.useRef({activeId:W,items:b,newIndex:te,containerId:p}),oe=b!==Z.current.items,ce=s({active:ie,containerId:p,isDragging:G,isSorting:V,id:m,index:i,items:b,newIndex:Z.current.newIndex,previousItems:Z.current.items,previousContainerId:Z.current.containerId,transition:S,wasDragging:Z.current.activeId!=null}),be=Ja({disabled:!ce,index:i,node:N,rect:H});return n.useEffect(()=>{V&&Z.current.newIndex!==te&&(Z.current.newIndex=te),p!==Z.current.containerId&&(Z.current.containerId=p),b!==Z.current.items&&(Z.current.items=b)},[V,te,p,b]),n.useEffect(()=>{if(W===Z.current.activeId)return;if(W&&!Z.current.activeId){Z.current.activeId=W;return}const se=setTimeout(()=>{Z.current.activeId=W},50);return()=>clearTimeout(se)},[W]),{active:ie,activeIndex:z,attributes:he,data:o,rect:H,index:i,newIndex:te,items:b,isOver:M,isSorting:V,isDragging:G,listeners:E,node:N,overIndex:f,over:ue,setNodeRef:O,setActivatorNodeRef:q,setDroppableNodeRef:ne,setDraggableNodeRef:Q,transform:be??L,transition:_()};function _(){if(be||oe&&Z.current.newIndex===i)return Ga;if(!(h&&!_a(me)||!S)&&(V||ce))return lt.Transition.toString({...S,property:Cs})}}function Ya(t,s){var a,r;return typeof t=="boolean"?{draggable:t,droppable:!1}:{draggable:(a=t==null?void 0:t.draggable)!=null?a:s.draggable,droppable:(r=t==null?void 0:t.droppable)!=null?r:s.droppable}}$e.Down,$e.Right,$e.Up,$e.Left;const Ka=t=>(t||"").toString().trim().toUpperCase(),Qa=(t,s)=>{if(t.sortableId!==s.sortableId)return!1;const a=t.prospect,r=s.prospect;if(a.id!==r.id||a.name!==r.name||a.hasAppointment!==r.hasAppointment||a.updatedAt!==r.updatedAt)return!1;const c=a._projectContext||{},d=r._projectContext||{};if(c.projectType!==d.projectType||c.projectTitle!==d.projectTitle||c.stepLabel!==d.stepLabel)return!1;const m=a.tags||[],g=r.tags||[];return!(m.length!==g.length||m.some((v,S)=>v!==g[S])||t.projectsData!==s.projectsData||t.onClick!==s.onClick)},Za=({prospect:t,onClick:s,sortableId:a,projectsData:r={}})=>{var f,A,P,y,i,o,T;ks();const c=Array.isArray(t.tags)?t.tags:[],d=((f=t._projectContext)==null?void 0:f.projectTitle)||((A=t._projectContext)==null?void 0:A.projectType)||null,m=((P=t._projectContext)==null?void 0:P.projectType)||null;(y=t._projectContext)!=null&&y.stepLabel;const g=d?Ka(d):null,v=a||(g?`${t.id}-${g}`:`${t.id}-${((i=t._projectContext)==null?void 0:i.projectType)||"default"}`),{attributes:S,listeners:b,setNodeRef:p,transform:z,transition:x,isDragging:F}=Xa({id:v,data:{prospect:t}}),D={transform:lt.Transform.toString(z),transition:x,zIndex:F?10:"auto",opacity:F?.8:1};return e.jsx("div",{ref:p,style:D,...S,...b,children:e.jsxs(Ye.div,{layoutId:`prospect-card-${v}`,whileHover:{y:-4,scale:1.02},onClick:s,className:"bg-white rounded-xl shadow-card hover:shadow-soft p-4 cursor-grab active:cursor-grabbing transition-all",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:t.name}),t.hasAppointment&&e.jsxs("div",{className:"flex items-center text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full",children:[e.jsx(nt,{className:"h-3 w-3 mr-1"}),e.jsx("span",{children:"RDV"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3 items-center",children:[d&&c.includes(((o=t._projectContext)==null?void 0:o.projectType)||d)&&e.jsx("span",{className:`inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border-2 border-blue-400 font-semibold shadow-sm tracking-wide ${((T=r[m])==null?void 0:T.color)||"bg-blue-100 text-blue-800"}`,children:e.jsx("span",{children:d})}),c.filter(H=>H!==m).map(H=>{var ne,ie;const N=((ne=r[H])==null?void 0:ne.title)||H,M=((ie=r[H])==null?void 0:ie.color)||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${M}`,children:N},H)})]})]})})},Ua=n.memo(Za,Qa);function er({prospectId:t,projectType:s,currentStepIndex:a,prompt:r,sendNextAction:c}){const d=n.useRef(new Set);n.useRef(!1),n.useEffect(()=>{if(!t||!s||a===void 0||!r)return;w.info("üîÑ Workflow action trigger activ√©",{prospectId:t,projectType:s,currentStepIndex:a,promptName:r==null?void 0:r.name});const m=ge.channel(`workflow-forms-${t}-${s}-${a}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"client_form_panels",filter:`prospect_id=eq.${t}`},async g=>{const v=g.new;w.info("üîç Form panel UPDATE re√ßu",{panelId:v.id,prospectId:v.prospect_id,projectType:v.project_type,status:v.status,actionId:v.action_id,expectedProjectType:s});const S=v.project_type===s,b=v.status==="approved",p=!!v.action_id;if(S&&b&&p){const z=`${t}-${s}-${a}-${v.action_id}`;if(d.current.has(z)){w.warn("‚ö†Ô∏è Action d√©j√† ex√©cut√©e, skip",{actionKey:z});return}d.current.add(z),w.info("‚úÖ Formulaire approuv√© ‚Üí Action suivante dans 2s",{formId:v.form_id,actionId:v.action_id}),setTimeout(()=>{w.info("üöÄ Envoi action suivante",{completedActionId:v.action_id}),c(v.action_id)},2e3)}}).subscribe();return()=>{ge.removeChannel(m)}},[t,s,a,r,c])}function tr({projectType:t,prospectId:s,enabled:a=!0}){const[r,c]=n.useState([]),[d,m]=n.useState(!1),[g,v]=n.useState(!1),[S,b]=n.useState(null),{organizationId:p}=ot(),z=n.useCallback(async()=>{if(!(!t||!a))try{m(!0),b(null);let f=ge.from("project_notes").select("*").eq("project_type",t).order("created_at",{ascending:!1});s&&(f=f.eq("prospect_id",s));const{data:A,error:P}=await f;if(P)throw P;c(A||[])}catch(f){w.error("Erreur r√©cup√©ration project notes:",{error:f.message}),b(f.message)}finally{m(!1)}},[t,s,a]);n.useEffect(()=>{if(!t||!a)return;z();const f=ge.channel(`project-notes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"project_notes",filter:`project_type=eq.${t}`},A=>{c(P=>{const{eventType:y,new:i,old:o}=A;return y==="INSERT"?[i,...P]:y==="UPDATE"?P.map(T=>T.id===i.id?i:T):y==="DELETE"?P.filter(T=>T.id!==o.id):P})}).subscribe();return()=>{ge.removeChannel(f)}},[t,a,z]);const x=n.useCallback(async({content:f,createdBy:A,createdByName:P})=>{if(!(!t||!(f!=null&&f.trim())))try{if(v(!0),b(null),!p)throw new Error("Organization ID manquant - Impossible d'ajouter une note");const{data:y,error:i}=await ge.from("project_notes").insert([{project_type:t,prospect_id:s||null,content:f.trim(),created_by:A||null,created_by_name:P||null,organization_id:p}]).select().single();if(i)throw i;return c(o=>[y,...o]),y}catch(y){throw w.error("Erreur ajout project note:",{error:y.message}),b(y.message),y}finally{v(!1)}},[t,s,p]),F=n.useCallback(async(f,{content:A})=>{if(!(!f||!(A!=null&&A.trim())))try{v(!0),b(null);const{data:P,error:y}=await ge.from("project_notes").update({content:A.trim(),updated_at:new Date().toISOString()}).eq("id",f).select().single();if(y)throw y;return c(i=>i.map(o=>o.id===f?P:o)),P}catch(P){throw w.error("Erreur update project note:",{error:P.message}),b(P.message),P}finally{v(!1)}},[]),D=n.useCallback(async f=>{if(f)try{v(!0),b(null);const{error:A}=await ge.from("project_notes").delete().eq("id",f);if(A)throw A;c(P=>P.filter(y=>y.id!==f))}catch(A){throw w.error("Erreur suppression project note:",{error:A.message}),b(A.message),A}finally{v(!1)}},[]);return{notes:r,loading:d,saving:g,error:S,addNote:x,updateNote:F,deleteNote:D,refetch:z}}function sr({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r}){var i;const{activeAdminUser:c}=Ve(),d=r||c,[m,g]=n.useState(""),[v,S]=n.useState(!1),{getTemplateByType:b}=As(),p=b(t),z=(p==null?void 0:p.title)||t,{notes:x,loading:F,saving:D,error:f,addNote:A}=tr({projectType:t,prospectId:s,enabled:!!t}),{addHistoryEvent:P}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:d}),y=async()=>{if(m.trim())try{const o=await A({content:m,createdBy:(d==null?void 0:d.id)||(a==null?void 0:a.id),createdByName:(d==null?void 0:d.name)||(d==null?void 0:d.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)});o&&P&&await P({event_type:"note",title:"Note ajout√©e",description:o.content||m.trim(),metadata:{source:"notes_tab"},createdBy:(d==null?void 0:d.id)||(a==null?void 0:a.id),createdByName:(d==null?void 0:d.name)||(d==null?void 0:d.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),g("")}catch(o){w.error(o)}};return e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Notes internes du projet"}),e.jsx("span",{className:"text-xs text-gray-400",children:t?`Projet ${z}`:"Aucun projet s√©lectionn√©"})]}),e.jsx("textarea",{className:"w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50",rows:4,placeholder:"Ajoute une note interne li√©e √† ce projet‚Ä¶",value:m,onChange:o=>g(o.target.value),disabled:!t||D}),"        ",e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"üñºÔ∏è"}),e.jsx("span",{children:"Image"})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-1 hover:text-gray-700",children:[e.jsx("span",{children:"@"}),e.jsx("span",{children:"Mention"})]})]}),e.jsx("button",{type:"button",onClick:y,disabled:!m.trim()||!t||D,className:"px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:D?"Enregistrement‚Ä¶":"Enregistrer la note"})]}),f&&e.jsxs("p",{className:"text-xs text-red-500 mt-1",children:["Erreur : ",f]})]}),e.jsxs("div",{className:"bg-white rounded-xl border p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Notes pr√©c√©dentes"}),x&&x.length>3&&e.jsx("button",{onClick:()=>S(!v),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700",children:v?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"R√©duire"}),e.jsx(Es,{className:"w-4 h-4"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Voir tout (",x.length,")"]}),e.jsx(St,{className:"w-4 h-4"})]})})]}),F&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement des notes‚Ä¶"}),!F&&(x==null?void 0:x.length)===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucune note pour ce projet pour l'instant."}),e.jsx("div",{className:"flex flex-col gap-3",children:(i=v?x:x==null?void 0:x.slice(0,3))==null?void 0:i.map(o=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-600",children:o.created_by_name||o.created_by?`Par ${o.created_by_name||o.created_by}`:"Note interne"}),e.jsx("span",{className:"text-[10px] text-gray-400",children:o.created_at&&new Date(o.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:o.content})]},o.id))})]})]})}const ar=({prospectId:t,projectType:s,activeAdminUser:a})=>{const{projectsData:r,appointments:c,updateAppointment:d,deleteAppointment:m,addAppointment:g,addCall:v,addTask:S,updateCall:b,updateTask:p,prospects:z}=Ve(),[x,F]=n.useState(!1),[D,f]=n.useState(null),[A,P]=n.useState(null),{users:y}=ct(),{supabaseUserId:i}=st(),{history:o,loading:T}=et({projectType:s,prospectId:t,enabled:!!s&&!!t,activeAdminUser:a}),H=n.useMemo(()=>!o||o.length===0?[]:o.filter(E=>E.event_type==="activity").sort((E,G)=>new Date(G.created_at)-new Date(E.created_at)),[o]),N=n.useMemo(()=>{const E={};return H.forEach(ue=>{var u;const q=(u=ue.metadata)==null?void 0:u.appointment_id;q&&(E[q]||(E[q]=[]),E[q].push(ue))}),Object.entries(E).map(([ue,q])=>{var V;const O=q.sort((le,h)=>new Date(h.created_at)-new Date(le.created_at))[0];return{...O,currentStatus:((V=O.metadata)==null?void 0:V.status)||(O.title==="Activit√© supprim√©e"?"deleted":"pending")}})},[H]),M=n.useMemo(()=>N?N.filter(E=>E.currentStatus==="pending"):[],[N]),ne=n.useMemo(()=>N?N.filter(E=>E.currentStatus!=="pending"):[],[N]),ie=E=>{switch((E==null?void 0:E.activity_type)||"appointment"){case"physical":case"appointment":return e.jsx(nt,{className:"h-4 w-4"});case"virtual":return e.jsx(xa,{className:"h-4 w-4"});case"call":return e.jsx(tt,{className:"h-4 w-4"});case"task":return e.jsx(na,{className:"h-4 w-4"});default:return e.jsx(nt,{className:"h-4 w-4"})}},me=E=>{const G=(E==null?void 0:E.activity_type)||"appointment",ue=E==null?void 0:E.status;if(ue==="effectue"||ue==="completed")return"text-green-600 bg-green-50";if(ue==="annule")return"text-red-600 bg-red-50";if(ue==="reporte")return"text-yellow-600 bg-yellow-50";switch(G){case"physical":case"appointment":return"text-blue-600 bg-blue-50";case"virtual":return"text-purple-600 bg-purple-50";case"call":return"text-green-600 bg-green-50";case"task":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},B=E=>{var G;return!c||!((G=E.metadata)!=null&&G.appointment_id)?null:c.find(ue=>ue.id===E.metadata.appointment_id)},he=E=>{const G=B(E);G&&f(G)},Q=E=>{f(null),P({...E,type:E.type}),F(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Activit√©s du projet"}),e.jsxs(pe,{onClick:()=>{F(!x)},size:"sm",variant:"outline",className:"text-blue-600 border-blue-600 hover:bg-blue-50",children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"}),"Ajouter une activit√©"]})]}),x&&e.jsx(fs,{open:x,onOpenChange:E=>{E||P(null),F(E)},initialData:A||{contactId:t,projectId:s},defaultAssignedUserId:i,addAppointment:g,addCall:v,addTask:S,updateAppointment:d,updateCall:b,updateTask:p,prospects:z||[],users:y||[],projectsData:r||{}}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["En cours (",M.length,")"]}),T?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement des activit√©s..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© en cours"}):e.jsx("div",{className:"space-y-2",children:M.map(E=>{const G=B(E),ue=(G==null?void 0:G.title)||E.title||"Activit√©",q=G!=null&&G.start?new Date(G.start):new Date(E.created_at);return e.jsxs("div",{onClick:()=>he(E),className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${me(E.metadata)}`,children:ie(E.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:ue}),(G==null?void 0:G.notes)&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:G.notes}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:Ke(q,"d MMM '√†' HH:mm",{locale:Oe})})]})]},E.id)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:["Pass√©es (",ne.length,")"]}),T?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Chargement..."}):ne.length===0?e.jsx("p",{className:"text-sm text-gray-400 italic",children:"Aucune activit√© pass√©e"}):e.jsx("div",{className:"space-y-2",children:ne.map(E=>{const G=B(E),ue=(G==null?void 0:G.title)||E.title||"Activit√©",q=G!=null&&G.start?new Date(G.start):new Date(E.created_at),u={effectue:"‚úÖ Effectu√©",annule:"‚ùå Annul√©",reporte:"üìÖ Report√©",deleted:"üóëÔ∏è Supprim√©",completed:"‚úÖ Termin√©"}[E.currentStatus]||E.currentStatus;return e.jsxs("div",{onClick:()=>he(E),className:"flex items-center space-x-3 p-3 bg-gray-50 border border-gray-100 rounded-lg opacity-75 hover:opacity-100 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${me(E.metadata)}`,children:ie(E.metadata)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:ue}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[u," ‚Ä¢ ",Ke(q,"d MMM yyyy '√†' HH:mm",{locale:Oe})]})]})]},E.id)})})]}),D&&e.jsx(rr,{event:D,onClose:()=>f(null),onReport:()=>{},onEdit:Q,prospects:z,supabaseUsers:y,updateAppointment:d,deleteAppointment:m,projectsData:r})]})},rr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:c,supabaseUsers:d,updateAppointment:m,deleteAppointment:g,projectsData:v})=>{var y;const[S,b]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&b(t.status||"pending")},[t]),!t||!c||!d||!m||!g||!v)return null;const p=c.find(i=>i.id===t.contactId),z=d.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(p?d.find(i=>i.user_id===p.ownerId):null),x=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",F=(i,o,T={})=>{try{const H=new Date(i);return isNaN(H.getTime())?"Date invalide":Ke(H,o,T)}catch{return"Date invalide"}},D=i=>{b(i),m(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},f=()=>{g(t.id),J({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},A=i=>{if(!p){J({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":p.phone&&(window.location.href=`tel:${p.phone}`);break;case"Mail":p.email&&(window.location.href=`mailto:${p.email}`);break;case"WhatsApp":if(p.phone){let o=p.phone.replace(/\D/g,"");o.startsWith("0")&&(o=`33${o.substring(1)}`);const T=encodeURIComponent("Bonjour");window.open(`https://wa.me/${o}?text=${T}`,"_blank")}break;case"GPS":if(p.address){const o=encodeURIComponent(p.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${o}`:window.open(`https://www.google.com/maps/search/?api=1&query=${o}`,"_blank")}break;default:J({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},P={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(ht,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(ft,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-4 top-4 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:x(F(t.start,"eeee d MMMM",{locale:Oe}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[F(t.start,"HH:mm",{locale:Oe})," - ",F(t.end,"HH:mm",{locale:Oe})]})]}),e.jsx(bt,{className:"p-0 text-left space-y-1",children:e.jsx(jt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(Ue,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),p&&e.jsxs("p",{className:"text-sm",children:[p.name," (Client)"]}),z&&e.jsxs("p",{className:"text-sm",children:[z.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"}].map(({icon:i,label:o})=>e.jsxs("button",{onClick:()=>A(o),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:o})]},o))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${P[S].color}`,children:e.jsxs(Tt,{onValueChange:D,value:S,children:[e.jsx(Rt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx($t,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Ft,{children:[e.jsx(Fe,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Fe,{value:"effectue",children:"Effectu√©"}),e.jsx(Fe,{value:"annule",children:"Annul√©"}),e.jsx(Fe,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((y=v[t.projectId])==null?void 0:y.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(p==null?void 0:p.name)||"N/A"})]})]})]}),e.jsxs(Mt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(as,{children:[e.jsx(rs,{asChild:!0,children:e.jsxs(pe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(os,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(cs,{children:[e.jsx(ds,{children:"Annuler"}),e.jsx(us,{onClick:f,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(pe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})},nr=({projectType:t,prospectId:s,currentUser:a,activeAdminUser:r})=>{const{activeAdminUser:c}=Ve(),{organizationId:d}=ot(),m=r||c,[g,v]=n.useState(null),{files:S,loading:b,uploading:p,deleting:z,error:x,uploadFile:F,deleteFile:D}=bs({projectType:t,prospectId:s,organizationId:d,enabled:!!t}),{addHistoryEvent:f}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:m}),A=async N=>{const M=Array.from(N.target.files||[]);if(M.length!==0)try{const ne=M.map(async ie=>{v(ie);const me=await F({file:ie,uploadedBy:a==null?void 0:a.id});return me&&f&&await f({event_type:"file",title:"Fichier ajout√©",description:me.file_name,metadata:{size:me.file_size,type:me.file_type,storage_path:me.storage_path},createdBy:(m==null?void 0:m.id)||(a==null?void 0:a.id),createdByName:(m==null?void 0:m.name)||(m==null?void 0:m.email)||(a==null?void 0:a.full_name)||(a==null?void 0:a.email)}),me});await Promise.all(ne),v(null),N.target.value=""}catch(ne){w.error("Error uploading files:",ne),v(null)}},P=async N=>{try{const{data:M,error:ne}=await ge.storage.from("project-files").createSignedUrl(N.storage_path,3600);if(ne){w.error("Error creating signed URL:",ne);return}const me=await(await fetch(M.signedUrl)).blob(),B=window.URL.createObjectURL(me),he=document.createElement("a");he.href=B,he.download=N.file_name,document.body.appendChild(he),he.click(),document.body.removeChild(he),window.URL.revokeObjectURL(B)}catch(M){w.error("Error downloading file:",M)}},y=async N=>{try{w.debug("üëÅÔ∏è Generating signed URL for view",{storagePath:N.storage_path});const{data:M,error:ne}=await ge.storage.from("project-files").createSignedUrl(N.storage_path,3600);if(ne){w.error("Error creating signed URL:",ne);return}w.debug("‚úÖ Signed URL generated",{url:M.signedUrl}),window.open(M.signedUrl,"_blank")}catch(M){w.error("Error viewing file:",M)}},i=async N=>{if(confirm(`Supprimer le fichier "${N.file_name}" ?`))try{await D(N.id,N.storage_path)}catch(M){w.error("Error deleting file:",M)}},o=N=>N!=null&&N.startsWith("image/")?e.jsx(Ds,{className:"h-5 w-5 text-blue-500"}):N==="application/pdf"?e.jsx(ze,{className:"h-5 w-5 text-red-500"}):e.jsx(oa,{className:"h-5 w-5 text-gray-500"}),T=N=>N?new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric"}).format(new Date(N)):"",H=N=>N?N<1024?`${N} o`:N<1024*1024?`${(N/1024).toFixed(1)} Ko`:`${(N/(1024*1024)).toFixed(1)} Mo`:"";return t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer",children:e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Ps,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:p?"Upload en cours...":"Cliquez pour ajouter des fichiers"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, documents ‚Ä¢ S√©lection multiple possible ‚Ä¢ Max 10 MB par fichier"}),e.jsx("input",{id:"file-upload",type:"file",onChange:A,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:p,multiple:!0})]})}),x&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:x}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700",children:["Fichiers (",S.length,")"]}),b?e.jsx("div",{className:"text-center py-8 text-gray-400",children:e.jsx("p",{className:"text-sm",children:"Chargement des fichiers..."})}):S.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Aucun fichier pour ce projet"})]}):e.jsx("div",{className:"space-y-2",children:S.map(N=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"flex-shrink-0",children:o(N.file_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[N.field_label?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:N.field_label}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:N.file_name})]}):e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:N.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[H(N.file_size)," ‚Ä¢ ",T(N.created_at)]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[N.file_size>0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>y(N),className:"p-2 hover:bg-green-50 rounded text-green-600 transition-colors",title:"Voir",disabled:z,children:e.jsx(ms,{className:"h-4 w-4"})}),N.field_label==="Document sign√©"&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded",children:"‚úì Sign√©"}),e.jsx("button",{onClick:()=>P(N),className:"p-2 hover:bg-blue-50 rounded text-blue-600 transition-colors",title:"T√©l√©charger",disabled:z,children:e.jsx(xt,{className:"h-4 w-4"})})]}):e.jsx("span",{className:"px-2 py-1 text-xs text-amber-600 bg-amber-50 rounded-full",children:"‚è≥ En attente"}),e.jsx("button",{onClick:()=>i(N),className:"p-2 hover:bg-red-50 rounded text-red-600 transition-colors disabled:opacity-50",title:"Supprimer",disabled:z,children:e.jsx(zt,{className:"h-4 w-4"})})]})]},N.id))})]}),e.jsxs("div",{className:"text-center py-4 text-sm text-gray-400 border-t border-gray-100",children:[e.jsx("p",{children:"Fichiers stock√©s dans Supabase Storage"}),e.jsx("p",{className:"text-xs mt-1",children:"(bucket: project-files)"})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ze,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"S√©lectionnez un projet pour voir les fichiers"})]})},ir=({prospectId:t,projectType:s,activeAdminUser:a})=>{const[r,c]=n.useState("notes"),{supabaseUserId:d}=st(),m=[{id:"notes",label:"Notes",icon:ze},{id:"activity",label:"Activit√©",icon:fa},{id:"files",label:"Fichiers",icon:ca}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("div",{className:"flex space-x-1",children:m.map(({id:g,label:v,icon:S})=>e.jsxs("button",{onClick:()=>c(g),className:`
                flex items-center space-x-2 px-4 py-3 text-sm font-medium transition-all
                border-b-2 -mb-px
                ${r===g?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}
              `,children:[e.jsx(S,{className:"h-4 w-4"}),e.jsx("span",{children:v})]},g))})}),e.jsxs("div",{className:"min-h-[200px]",children:[r==="notes"&&e.jsx(sr,{prospectId:t,projectType:s,currentUser:{id:d},activeAdminUser:a}),r==="activity"&&e.jsx(ar,{prospectId:t,projectType:s,activeAdminUser:a}),r==="files"&&e.jsx(nr,{prospectId:t,projectType:s,currentUser:{id:d},activeAdminUser:a})]})]})},lr=({projectType:t,prospectId:s,activeAdminUser:a})=>{const{history:r,loading:c,error:d}=et({projectType:t,prospectId:s,enabled:!!t,activeAdminUser:a});return t?e.jsxs("div",{className:"bg-white border rounded-xl p-4",children:[e.jsx("h3",{className:"font-semibold text-sm mb-4",children:"Historique du projet"}),c&&e.jsx("p",{className:"text-xs text-gray-400",children:"Chargement de l'historique‚Ä¶"}),d&&e.jsxs("p",{className:"text-xs text-red-500",children:["Erreur : ",d]}),!c&&r.length===0&&e.jsx("p",{className:"text-xs text-gray-400",children:"Aucun √©v√©nement pour ce projet."}),e.jsx("div",{className:"flex flex-col gap-6",children:r.map(m=>e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-0 top-1.5 w-3 h-3 rounded-full bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:m.title||m.event_type}),m.description&&e.jsx("p",{className:"text-xs text-gray-600",children:m.description}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:new Date(m.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"})}),(m.created_by_name||m.created_by)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["Par ",m.created_by_name||m.created_by]})]})]})]})]},m.id))})]}):e.jsx("div",{className:"bg-white border rounded-xl p-4",children:e.jsx("p",{className:"text-sm text-gray-400",children:"S√©lectionnez un projet"})})},or=({children:t,prospectId:s,projectType:a,currentStep:r,statusConfig:c,activeAdminUser:d})=>{var m,g,v;return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[r&&e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${((m=c[r.status])==null?void 0:m.iconOnly)||c.pending.iconOnly}`,children:r.icon}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r.name})]}),e.jsx("span",{className:`text-xs px-3 py-1 rounded-full ${((g=c[r.status])==null?void 0:g.badge)||c.pending.badge}`,children:((v=c[r.status])==null?void 0:v.label)||c.pending.label})]}),t]},r.name),!r&&!a&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ze,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun projet s√©lectionn√©"}),e.jsx("p",{className:"text-gray-500",children:"S√©lectionnez un projet dans la liste ci-dessus pour voir le suivi d√©taill√©."})]})]}),a&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 space-y-6",children:[e.jsx(ir,{prospectId:s,projectType:a,activeAdminUser:d}),e.jsx("div",{className:"border-t border-gray-200"}),e.jsx(lr,{prospectId:s,projectType:a,activeAdminUser:d})]})]})},cr={CLIENT:it,COMMERCIAL:zs,PARTENAIRE:Ue},dr={CLIENT:"Client",COMMERCIAL:"Commercial",PARTENAIRE:"Partenaire"},ur={FORM:ze,SIGNATURE:da},mr={FORM:"Formulaire",SIGNATURE:"Signature"},gr=({isOpen:t,onClose:s,prospectId:a,projectType:r,moduleId:c,moduleName:d,moduleConfig:m,context:g={},availableForms:v=[],availableTemplates:S=[]})=>{var V,le;const[b,p]=n.useState(null),[z,x]=n.useState(!1),[F,D]=n.useState(null),[f,A]=n.useState(!1),P=pa(),y=n.useMemo(()=>m?m.actions&&m.actions.length>0?m.actions:m.actionConfig?[{order:1,status:"pending",actionConfig:m.actionConfig}]:[]:[],[m]),[i,o]=n.useState({}),[T,H]=n.useState(!1);n.useEffect(()=>{if(!t||!a||!c||y.length<=1){o({});return}(async()=>{H(!0);try{const C=y.map((W,Z)=>`v2-${c}-action-${Z}`),{data:X,error:L}=await ge.from("client_form_panels").select("id, action_id, status").eq("prospect_id",a).eq("project_type",r).in("action_id",C),te={};if(!L&&X&&X.length>0){for(const W of X)W.action_id&&(W.status==="approved"||W.status==="submitted")&&(te[W.action_id]=W.status);console.log("[V2 Robot] Action statuses by action_id:",te)}else{const{data:W}=await ge.from("client_form_panels").select("id, step_name, status").eq("prospect_id",a).eq("project_type",r).in("status",["approved","submitted"]);if(W){const Z=W.filter(oe=>!oe.step_name||oe.step_name===d||oe.step_name===c);Z.forEach((oe,ce)=>{ce<y.length&&(te[`v2-${c}-action-${ce}`]=oe.status)}),console.log("[V2 Robot] Fallback legacy statuses:",te,"from",Z.length,"panels")}}o(te)}catch(C){console.error("[V2 Robot] Error fetching action statuses:",C)}finally{H(!1)}})()},[t,a,r,d,c,y.length]);const N=n.useMemo(()=>y.map((h,C)=>{const X=`v2-${c}-action-${C}`,L=i[X];return{...h,actionId:X,realStatus:L==="approved"?"validated":L==="submitted"?"submitted":"pending"}}),[y,i,c]),[M,ne]=n.useState(0);n.useEffect(()=>{if(t&&N.length>0&&!T){const h=N.findIndex(C=>C.realStatus!=="validated");ne(h>=0?h:N.length-1)}},[t,N,T]);const ie=N[M]||null,me=N.length,B=me>1,he=n.useMemo(()=>{if(!ie)return!1;const h=ie.actionConfig;return!(!h||!h.actionType||!(Array.isArray(h.targetAudience)?h.targetAudience.length>0:!!h.targetAudience))},[ie]),Q=(ie==null?void 0:ie.actionConfig)||null,E=()=>{if(!he||!Q){J({title:"Configuration incompl√®te",description:"Aucune action configur√©e pour ce module.",variant:"destructive"});return}console.log("[V2 Robot] handleSimulate DEBUG:",{currentActionIndex:M,actionConfigFormIds:Q.allowedFormIds,currentActionFull:ie,allActions:N.map((h,C)=>{var X;return{index:C,formIds:(X=h.actionConfig)==null?void 0:X.allowedFormIds}})});try{const h=Array.isArray(Q.targetAudience)?Q.targetAudience[0]:Q.targetAudience,C=ua({moduleId:c,moduleName:d,projectType:r,prospectId:a,actionIndex:M,actionConfig:{...Q,targetAudience:h||"CLIENT"},message:""});p(C),D(null),console.log("[V2 Robot] ActionOrder g√©n√©r√©:",C)}catch(h){console.error("[V2 Robot] Erreur g√©n√©ration:",h),J({title:"Erreur",description:h.message,variant:"destructive"})}},G=async()=>{if(!b){J({title:"Aucun ordre",description:"Simulez d'abord pour g√©n√©rer un ActionOrder.",variant:"destructive"});return}if(!P){J({title:"Ex√©cution d√©sactiv√©e",description:"Le flag EXECUTION_FROM_V2 est OFF.",variant:"destructive"});return}x(!0),D(null);try{const h={...b,_meta:{...b._meta,isSimulation:!1}},C=await ma(h,g);D(C),C.success?(J({title:"‚úÖ Action ex√©cut√©e",description:C.message,className:"bg-green-500 text-white"}),setTimeout(()=>{s()},1e3)):J({title:"‚ö†Ô∏è Ex√©cution bloqu√©e",description:C.message,variant:"destructive"})}catch(h){console.error("[V2 Robot] Erreur ex√©cution:",h),D({success:!1,status:"error",message:h.message}),J({title:"Erreur",description:h.message,variant:"destructive"})}finally{x(!1)}},ue=()=>{b&&(navigator.clipboard.writeText(JSON.stringify(b,null,2)),J({title:"Copi√© !",description:"ActionOrder JSON copi√© dans le presse-papiers."}))},q=gt.useRef(M);n.useEffect(()=>{const h=q.current!==M;if(q.current=M,h&&(p(null),D(null)),t&&he&&!T&&(!b||h)){const C=setTimeout(()=>{E()},h?50:0);return()=>clearTimeout(C)}},[t,he,T,M]),n.useEffect(()=>{t||(p(null),D(null),A(!1),ne(0))},[t]);const u=h=>{const C=v.find(X=>X.id===h);return(C==null?void 0:C.name)||h},O=h=>{const C=S.find(X=>X.id===h);return(C==null?void 0:C.name)||h};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-purple-50 to-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(gs,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Workflow V2"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[d||c,B&&e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["‚Äî Action ",M+1,"/",me]})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Je,{className:"h-5 w-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-4",children:[B&&he&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:["üìã √âtape ",M+1," sur ",me]}),M>0&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",M," termin√©e",M>1?"s":"",")"]})]}),!he&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Vt,{className:"h-12 w-12 text-amber-400 mx-auto mb-3"}),e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:"Aucune action disponible"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Aucune configuration V2 n'est d√©finie pour cette √©tape."}),e.jsxs(pe,{variant:"outline",size:"sm",onClick:()=>{J({title:"Configurer cette √©tape",description:"Allez dans Workflow V2 > Configuration pour configurer ce module."})},children:[e.jsx(Ts,{className:"h-4 w-4 mr-2"}),"Configurer"]})]}),he&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase",children:B?`Action ${M+1}/${me}`:"Action configur√©e"}),P&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full",children:"EXEC ON"})]}),e.jsx("div",{className:"flex items-center gap-3",children:(Q==null?void 0:Q.actionType)&&e.jsxs(e.Fragment,{children:[gt.createElement(ur[Q.actionType]||ze,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:mr[Q.actionType]||Q.actionType})]})}),(Q==null?void 0:Q.targetAudience)&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Cibles:"}),(Array.isArray(Q.targetAudience)?Q.targetAudience:[Q.targetAudience]).map(h=>{const C=cr[h]||it;return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white rounded-md border text-sm",children:[e.jsx(C,{className:"h-3.5 w-3.5"}),dr[h]||h]},h)})]}),((V=Q==null?void 0:Q.allowedFormIds)==null?void 0:V.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Formulaires:"})," ",Q.allowedFormIds.map(h=>u(h)).join(", ")]}),((le=Q==null?void 0:Q.allowedTemplateIds)==null?void 0:le.length)>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"text-gray-500",children:"Templates:"})," ",Q.allowedTemplateIds.map(h=>O(h)).join(", ")]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 pt-2 border-t",children:[e.jsxs("span",{children:["Gestion: ",(Q==null?void 0:Q.managementMode)==="AI"?"‚ú® IA":"üë§ Humain"]}),e.jsxs("span",{children:["V√©rif: ",(Q==null?void 0:Q.verificationMode)==="AI"?"‚ú® IA":"üë§ Humain"]})]})]}),b&&e.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-50 cursor-pointer",onClick:()=>A(!f),children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Rs,{className:Qe("h-4 w-4 transition-transform",f&&"rotate-90")}),"ActionOrder"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full",children:"V2"}),e.jsx("button",{onClick:h=>{h.stopPropagation(),ue()},className:"p-1 hover:bg-gray-200 rounded",title:"Copier JSON",children:e.jsx($s,{className:"h-3.5 w-3.5 text-gray-500"})})]})]}),f&&e.jsx("pre",{className:"p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto max-h-48",children:JSON.stringify(b,null,2)})]}),F&&e.jsxs("div",{className:Qe("rounded-lg p-4 flex items-start gap-3",F.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[F.success?e.jsx(Fs,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Vt,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:Qe("font-medium text-sm",F.success?"text-green-800":"text-red-800"),children:[F.status==="executed"&&"Ex√©cut√© avec succ√®s",F.status==="simulated"&&"Simulation uniquement",F.status==="blocked"&&"Ex√©cution bloqu√©e",F.status==="error"&&"Erreur"]}),e.jsx("p",{className:Qe("text-sm mt-1",F.success?"text-green-700":"text-red-700"),children:F.message})]})]})]})]}),he&&e.jsxs("div",{className:"px-5 py-4 border-t bg-gray-50 flex items-center justify-end gap-3",children:[e.jsxs(pe,{variant:"outline",onClick:E,disabled:z,children:[e.jsx(ms,{className:"h-4 w-4 mr-2"}),"Simuler"]}),e.jsxs(pe,{onClick:G,disabled:!b||z||!P,className:Qe(!P&&"opacity-50 cursor-not-allowed"),children:[z?e.jsx(Ms,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ja,{className:"h-4 w-4 mr-2"}),"Ex√©cuter"]})]})]})}):null},Le="completed",De="in_progress",qe="pending",at={[Le]:{label:"Termin√©",badge:"bg-green-100 text-green-700",icon:"bg-green-500 text-white shadow-soft",text:"text-gray-900",iconOnly:"bg-green-100 text-green-600"},[De]:{label:"En cours",badge:"bg-blue-100 text-blue-700",icon:"bg-blue-500 text-white shadow-soft ring-4 ring-blue-200",text:"text-blue-900",iconOnly:"bg-blue-100 text-blue-600"},[qe]:{label:"√Ä venir",badge:"bg-gray-100 text-gray-500",icon:"bg-gray-100 text-gray-400",text:"text-gray-500",iconOnly:"bg-gray-200 text-gray-500"}},Zt=t=>{if(!t||!Array.isArray(t.subSteps)||t.subSteps.length===0)return t;const s={...t,subSteps:t.subSteps.map(r=>({...r,status:r.status||qe}))};if(!s.subSteps.some(r=>r.status===De)){const r=s.subSteps.findIndex(c=>c.status===qe);r!==-1&&(s.subSteps=s.subSteps.map((c,d)=>({...c,status:d===r?De:c.status})),s.status=s.status===Le?De:s.status)}return s},Ut=(t,s,a)=>{var S;if(!t)return t;const r=t.name?t.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,c=r?`${s}:${r}`:null,d=c&&a?a[c]:null,m=(S=d==null?void 0:d.configJson)==null?void 0:S.actions;if(!m||m.length===0)return t;if(Array.isArray(t.subSteps)&&t.subSteps.length>0){const b=t.subSteps.map((p,z)=>{var f,A;const x=m[z],D=((A=(f=x==null?void 0:x.config)==null?void 0:f.objective)==null?void 0:A.trim())||(x==null?void 0:x.title)||(x==null?void 0:x.label);return{...p,name:D||p.name||`Action ${z+1}`}});return{...t,subSteps:b}}const g=t.status||qe,v=m.map((b,p)=>{var z;return{id:b.id||`v2-${r}-action-${p}`,name:((z=b.config)==null?void 0:z.objective)&&b.config.objective.trim()||b.title||b.label||`Action ${p+1}`,status:g===Le?Le:p===0&&g===De?De:qe}});return{...t,subSteps:v,status:g}},xr=t=>!(t!=null&&t.subSteps)||t.subSteps.length===0?!0:t.subSteps.every(s=>s.status===Le),pr=({form:t,prospectId:s,onFormSubmit:a})=>{const[r,c]=n.useState({}),d=(g,v)=>{c(S=>({...S,[g]:v}))},m=()=>{a(s,t.id,r),J({title:"R√©ponses enregistr√©es",description:`Les r√©ponses au formulaire "${t.name}" ont √©t√© sauvegard√©es.`,className:"bg-green-500 text-white"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:t.name}),(t.fields||[]).map(g=>{if(g.show_if_conditions&&g.show_if_conditions.length>0){const S=g.condition_operator||"AND",b=g.show_if_conditions.map(z=>{const x=r[z.field];return z.equals==="has_value"?!!x&&x!=="":x===z.equals});if(!(S==="AND"?b.every(z=>z===!0):b.some(z=>z===!0)))return null}if(g.show_if){const S=g.show_if.field,b=g.show_if.equals,p=r[S];if(!p||p!==b)return null}return(t.fields||[]).some(S=>S.is_repeater&&(S.repeats_fields||[]).includes(g.id))?null:e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${g.id}`,children:g.label}),e.jsx(Be,{id:`${t.id}-${g.id}`,type:g.type,value:typeof r[g.id]=="object"?"":r[g.id]||"",onChange:S=>d(g.id,S.target.value),placeholder:g.placeholder||""}),g.is_repeater&&g.repeats_fields&&g.repeats_fields.length>0&&r[g.id]&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from({length:parseInt(r[g.id])||0},(S,b)=>{const p=(t.fields||[]).filter(z=>g.repeats_fields.includes(z.id));return e.jsxs("div",{className:"p-4 bg-green-50 border-2 border-green-200 rounded-lg space-y-3",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-sm",children:[g.label," #",b+1]}),p.map(z=>{const x=`${g.id}_repeat_${b}_${z.id}`,F=r[x];return e.jsxs("div",{children:[e.jsx(Me,{htmlFor:`${t.id}-${x}`,children:z.label}),e.jsx(Be,{id:`${t.id}-${x}`,type:z.type,value:typeof F=="object"?"":F||"",onChange:D=>d(x,D.target.value),placeholder:z.placeholder||""})]},x)})]},b)})})]},g.id)}),e.jsx(pe,{onClick:m,className:"w-full",children:"Soumettre"})]})},hr=({prospectId:t,projectType:s,currentStepIndex:a,activeAdminUser:r})=>{var ce,be;const{addChatMessage:c,prompts:d,projectsData:m,forms:g,updateProspect:v,prospects:S,completeStepAndProceed:b,registerClientForm:p}=Ve();ct();const{messages:z,loading:x}=js(t,s),{uploadFile:F,uploading:D}=bs({projectType:s,prospectId:t,organizationId:r==null?void 0:r.organization_id,enabled:!0}),{addProjectEvent:f}=et({projectType:s||"",prospectId:t,enabled:!!s&&!!t,activeAdminUser:r}),{user:A}=st(),[P,y]=n.useState(""),[i,o]=n.useState(null),T=n.useRef(null),H=n.useRef(null),[N,M]=n.useState(!1),[ne,ie]=n.useState(!1),{organizationId:me}=ot(),{templates:B,loading:he}=ys(me||(r==null?void 0:r.organization_id),s),{forms:Q,loading:E}=qs(me||(r==null?void 0:r.organization_id)),{templates:G,loading:ue}=Vs(me||(r==null?void 0:r.organization_id)),q=(be=(ce=m[s])==null?void 0:ce.steps)==null?void 0:be[a],u=n.useMemo(()=>q!=null&&q.name?q.name.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):`step-${a}`,[q,a]),O=n.useMemo(()=>{if(!B||!u)return null;const _=B[`${s}:${u}`];return(_==null?void 0:_.configJson)||null},[B,u,s]),V=n.useMemo(()=>Q?Object.values(Q).map(_=>({id:_.id,name:_.name||_.title||"Formulaire sans nom"})):[],[Q]),le=n.useMemo(()=>G?Array.isArray(G)?G.map(_=>({id:_.id,name:_.name||"Template sans nom"})):Object.values(G).map(_=>({id:_.id,name:_.name||"Template sans nom"})):[],[G]),h=S.find(_=>_.id===t),C=n.useMemo(()=>Object.values(d).filter(_=>{var xe;if(_.projectId!==s)return!1;const se=(xe=_.stepsConfig)==null?void 0:xe[a];return se&&se.actions&&se.actions.length>0}),[d,s,a]),X=n.useCallback(async(_=null)=>{var Se;const se=C[0];if(!se){w.warn("Aucun prompt disponible");return}const xe=(Se=se.stepsConfig)==null?void 0:Se[a];if(!xe||!xe.actions){w.warn("Aucune action dans la config de l'√©tape");return}const fe=[...xe.actions].sort((Ie,ke)=>(Ie.order||0)-(ke.order||0));if(_){const Ie=fe.findIndex(ke=>ke.id===_);if(Ie!==-1&&Ie+1<fe.length){const ke=fe[Ie+1];w.info("üéØ Action suivante trouv√©e",{completedActionId:_,nextActionId:ke.id,nextActionType:ke.type}),await oe(se,ke.id);return}else{w.warn("Pas d'action suivante",{completedActionId:_,totalActions:fe.length});return}}await oe(se)},[C,a]);er({prospectId:t,projectType:s,currentStepIndex:a,prompt:C[0],sendNextAction:X}),n.useEffect(()=>{requestAnimationFrame(()=>{var _;(_=T.current)==null||_.scrollIntoView({behavior:"smooth",block:"end"})})},[z]);const L=async()=>{if(!(!P.trim()&&!i))try{let _=null;if(i){if(i.size>10485760){J({title:"‚ùå Fichier trop volumineux",description:"La taille maximale est de 10 MB.",variant:"destructive"});return}w.debug("üì§ Uploading file from admin chat",{name:i.name,size:i.size,type:i.type});const{data:{user:fe}}=await ge.auth.getUser(),Se=await F({file:i,uploadedBy:fe==null?void 0:fe.id});Se&&(_={id:Se.id,name:Se.file_name,size:Se.file_size,type:Se.file_type,storagePath:Se.storage_path},w.debug("‚úÖ File uploaded successfully",_))}c(t,s,{sender:"pro",text:P,file:_}),y(""),o(null),requestAnimationFrame(()=>{var xe;(xe=T.current)==null||xe.scrollIntoView({behavior:"smooth",block:"end"})}),_&&J({title:"‚úÖ Fichier envoy√©",description:`${_.name} a √©t√© envoy√© avec succ√®s.`})}catch(_){w.error("‚ùå Error sending message with file",_),J({title:"‚ùå Erreur",description:`Impossible d'envoyer le fichier : ${_.message}`,variant:"destructive"})}},te=_=>{_.target.files&&_.target.files[0]&&o(_.target.files[0])},W=async _=>{if(!_||!_.storagePath){J({title:"‚ùå Erreur",description:"Le fichier n'est pas disponible.",variant:"destructive"});return}try{w.debug("üì• Downloading file",{storagePath:_.storagePath});const{data:se,error:xe}=await ge.storage.from("project-files").createSignedUrl(_.storagePath,3600);if(xe)throw xe;window.open(se.signedUrl,"_blank"),J({title:"‚úÖ T√©l√©chargement",description:`${_.name} s'ouvre dans un nouvel onglet.`})}catch(se){w.error("‚ùå Error downloading file",se),J({title:"‚ùå Erreur",description:`Impossible de t√©l√©charger le fichier : ${se.message}`,variant:"destructive"})}},Z=(_,se,xe)=>{var we;const fe=S.find(je=>je.id===_);if(!fe)return;const Se={...fe.formData||{},...xe};v({...fe,formData:Se});const Ie={sender:"client",text:`A compl√©t√© le formulaire : ${((we=g[se])==null?void 0:we.name)||"Formulaire"}.`};if(c(_,s,Ie),Object.values(d).find(je=>{var ae,Ce;if(je.projectId!==s)return!1;const ye=(ae=je.stepsConfig)==null?void 0:ae[a];return ye!=null&&ye.autoCompleteStep?(Ce=ye.actions)==null?void 0:Ce.some(Ae=>Ae.type==="show_form"&&Ae.formId===se):!1})){const je=O==null?void 0:O.actions;if(je&&je.length>1){J({title:"‚úÖ Formulaire re√ßu",description:"Il reste d'autres actions √† compl√©ter pour cette √©tape.",className:"bg-blue-500 text-white"});return}b(t,s,a),J({title:"√âtape termin√©e !",description:"L'√©tape a √©t√© automatiquement marqu√©e comme termin√©e.",className:"bg-green-500 text-white"})}},oe=async(_,se=null)=>{var fe,Se,Ie,ke,we,je,ye,ae;const xe=(fe=_.stepsConfig)==null?void 0:fe[a];if(xe&&xe.actions&&xe.actions.length>0){const Ce=z,Ae=[...xe.actions].sort((I,Y)=>(I.order||0)-(Y.order||0));let Pe=Ae,j=!1;if(se){const I=Ae.find(Y=>Y.id===se);if(!I){w.warn("Action sp√©cifique introuvable",{specificActionId:se});return}w.info("üéØ Ex√©cution action sp√©cifique (forc√©e)",{actionId:se,actionType:I.type}),Pe=[I],j=!0}for(const I of Pe)if(!(!j&&Ce.some(de=>de.promptId===_.id&&de.stepIndex===a&&(de.text===I.message||de.formId===I.formId&&I.type==="show_form")))){if(I.message){const Y={sender:"pro",text:I.message,promptId:_.id,stepIndex:a,actionId:I.id};c(t,s,Y)}if(I.type==="show_form"&&I.formId){const Y={sender:"pro",formId:I.formId,promptId:_.id,stepIndex:a,actionId:I.id};c(t,s,Y);const de=((ke=(Ie=(Se=m[s])==null?void 0:Se.steps)==null?void 0:Ie[a])==null?void 0:ke.name)||"√âtape inconnue";try{const ve=await p({prospectId:t,projectType:s,formId:I.formId,currentStepIndex:a,promptId:_.id,messageTimestamp:Date.now(),status:"pending",stepName:de,actionId:I.id});if(!ve.success)w.error("‚ùå √âchec enregistrement formulaire:",ve.error),J({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"});else try{const l=((we=g[I.formId])==null?void 0:we.name)||I.formId;await f({prospectId:t,projectType:s,title:"Formulaire envoy√©",description:`Le formulaire ${l} a √©t√© envoy√© √† ${(h==null?void 0:h.name)||"le client"}.`,createdBy:(A==null?void 0:A.user_id)||null,createdByName:(A==null?void 0:A.name)||"Admin"})}catch(l){w.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",l)}}catch(ve){w.error("‚ùå Exception enregistrement formulaire:",ve),J({title:"Erreur",description:"Le formulaire n'a pas pu √™tre enregistr√©.",variant:"destructive"})}}if(I.type==="start_signature"&&I.templateId)try{if(!(r!=null&&r.organization_id))throw new Error("activeAdminUser.organization_id manquant - Impossible de g√©n√©rer le contrat");w.info("üî• G√©n√©ration contrat via workflow s√©quentiel",{templateId:I.templateId,prospectId:t,projectType:s,organizationId:r.organization_id,formId:I.formId});const{data:Y,error:de}=await ge.from("prospects").select("form_data").eq("id",t).single(),ve=((ye=(je=Y==null?void 0:Y.form_data)==null?void 0:je[s])==null?void 0:ye[I.formId])||{};w.info("üìã Donn√©es formulaire extraites",{formId:I.formId,dataKeys:Object.keys(ve)}),J({title:"üìÑ G√©n√©ration du contrat...",description:"Cr√©ation du PDF en cours",className:"bg-blue-500 text-white"});const l=await ga({templateId:I.templateId,projectType:s,prospectId:t,formData:ve,organizationId:r==null?void 0:r.organization_id});if(l.success){const k=l.fileData.id;w.debug("Cr√©ation proc√©dure de signature...",{fileId:k,prospectId:t,projectType:s});const{data:R}=await ge.from("signature_procedures").select("*").eq("file_id",k).eq("prospect_id",t).eq("status","pending").maybeSingle();let $=R;if(!$){const ee=crypto.randomUUID(),re=new Date;re.setDate(re.getDate()+7);const Ne=[{role:"principal",name:(h==null?void 0:h.name)||"Client",email:h==null?void 0:h.email,phone:(h==null?void 0:h.phone)||null,access_token:ee,requires_auth:!0,status:"pending",signed_at:null}];if(!(r!=null&&r.organization_id))throw new Error("Organization ID manquant - Impossible de cr√©er la proc√©dure de signature");const Re=typeof(h==null?void 0:h.name)=="string"&&h.name.trim()!==""?h.name:((ae=h==null?void 0:h.email)==null?void 0:ae.split("@")[0])||"Client",_e=h==null?void 0:h.email,{data:ut,error:He}=await ge.from("signature_procedures").insert({prospect_id:t,project_type:s,file_id:k,access_token:ee,access_token_expires_at:re.toISOString(),status:"pending",signers:Ne,organization_id:r.organization_id,signer_name:Re,signer_email:_e}).select().single();if(He)throw w.error("Erreur cr√©ation signature_procedures",He),He;$=ut,w.debug("Proc√©dure de signature cr√©√©e",{procedureId:$.id,signersCount:Ne.length})}const K=`https://evatime.fr/signature/${$.id}?token=${$.access_token}`,{data:U}=await ge.from("chat_messages").select("id").eq("prospect_id",t).eq("project_type",s).eq("sender","pro").ilike("text",`%/signature/${$.id}%`).maybeSingle();U||(await ge.from("chat_messages").insert({prospect_id:t,project_type:s,sender:"pro",text:`<a href="${K}" target="_blank" style="color: #10b981; font-weight: 600; text-decoration: underline;">üëâ Signer mon contrat</a>`,organization_id:r==null?void 0:r.organization_id}),w.debug("Lien de signature envoy√© dans le chat")),J({title:"‚úÖ Contrat g√©n√©r√© !",description:"Le contrat a √©t√© cr√©√© et le lien de signature envoy√©.",className:"bg-green-500 text-white"});try{await f({prospectId:t,projectType:s,title:"Contrat g√©n√©r√©",description:`Le contrat a √©t√© g√©n√©r√© et envoy√© √† ${(h==null?void 0:h.name)||"le client"}.`,createdBy:(A==null?void 0:A.user_id)||null,createdByName:(A==null?void 0:A.name)||"Admin"})}catch(ee){w.error("‚ö†Ô∏è Erreur ajout √©v√©nement historique:",ee)}}else throw new Error(l.error||"Erreur inconnue")}catch(Y){w.error("‚ùå Exception g√©n√©ration contrat:",Y),J({title:"Erreur",description:`Impossible de g√©n√©rer le contrat: ${Y.message}`,variant:"destructive"})}break}}M(!1)};return e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"space-y-4 h-96 overflow-y-auto pr-2 mb-4 rounded-lg bg-gray-50 p-4 border",children:[z.map((_,se)=>e.jsxs("div",{className:`flex items-end gap-2 ${_.sender==="pro"?"justify-end":"justify-start"}`,children:[_.sender==="client"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-white",children:(h==null?void 0:h.name.charAt(0))||"?"}),e.jsxs("div",{className:`max-w-xs lg:max-w-md rounded-2xl ${_.sender==="pro"?"bg-blue-500 text-white rounded-br-none p-2.5":"bg-gray-200 text-gray-800 rounded-bl-none p-3"}`,children:[_.text&&(_.sender==="pro"&&_.text.includes("<a ")?e.jsx("p",{className:"text-xs leading-relaxed",dangerouslySetInnerHTML:{__html:_.text}}):e.jsx("p",{className:"text-xs leading-relaxed",children:_.text})),_.file&&e.jsxs("button",{onClick:()=>W(_.file),className:"mt-2 flex items-center gap-2 text-xs bg-white/20 hover:bg-white/30 p-2 rounded-lg w-full text-left transition-colors",children:[e.jsx(ze,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:_.file.name}),e.jsx(xt,{className:"w-3 h-3 ml-auto flex-shrink-0"})]}),_.formId&&g[_.formId]&&e.jsx("div",{className:"mt-2 bg-white text-gray-800 p-3 rounded-lg",children:e.jsx(pr,{form:g[_.formId],prospectId:t,onFormSubmit:Z})}),e.jsx("p",{className:`text-xs mt-1 ${_.sender==="pro"?"text-blue-200":"text-gray-500"}`,children:ha(new Date(_.timestamp),{addSuffix:!0,locale:Oe})})]}),_.sender==="pro"&&!_.formId&&e.jsx("img",{src:"https://horizons-cdn.hostinger.com/43725989-d002-4543-b65c-278701925e7e/4e3f809791e357819f31c585852d3a99.png",alt:"Charly",className:"w-8 h-8 rounded-full"})]},se)),e.jsx("div",{ref:T})]}),i&&e.jsxs("div",{className:"mb-2 text-sm text-gray-600 flex items-center gap-2",children:[e.jsx(Bt,{className:"w-4 h-4"}),e.jsx("span",{children:i.name}),e.jsx("button",{onClick:()=>o(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Be,{placeholder:"√âcrire au client...",className:"pr-28 h-12",value:P,onChange:_=>y(_.target.value),onKeyPress:_=>_.key==="Enter"&&L()}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx(pe,{variant:"ghost",size:"icon",onClick:()=>ie(!0),title:"Workflow V2 - Actions automatis√©es",children:e.jsx(gs,{className:"h-5 w-5 text-purple-600"})}),e.jsx(pe,{variant:"ghost",size:"icon",onClick:()=>H.current.click(),disabled:D,children:e.jsx(Bt,{className:`h-5 w-5 ${D?"text-gray-300":"text-gray-500"}`})}),e.jsx("input",{type:"file",ref:H,onChange:te,className:"hidden",accept:".pdf,.png,.jpg,.jpeg,.doc,.docx",disabled:D}),e.jsx(pe,{onClick:L,size:"icon",className:"bg-green-500 hover:bg-green-600 w-8 h-8",disabled:D,children:D?e.jsx("div",{className:"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Bs,{className:"h-4 w-4"})})]})]}),e.jsx(gr,{isOpen:ne,onClose:()=>ie(!1),prospectId:t,projectType:s,moduleId:u,moduleName:(q==null?void 0:q.name)||`√âtape ${a+1}`,moduleConfig:O,context:{organizationId:me||(r==null?void 0:r.organization_id),adminUser:r},availableForms:V,availableTemplates:le})]})},fr=({steps:t,onUpdateStatus:s,prompts:a,projectType:r,currentStepIndex:c,prospectId:d,completeStepAndProceed:m})=>{var f;if(!t)return null;const[g,v]=n.useState({}),{activeAdminUser:S,appointments:b,updateAppointment:p}=Ve(),z=a?Object.values(a).find(A=>A.projectId===r):null,x=(f=z==null?void 0:z.stepsConfig)==null?void 0:f[c],F=n.useMemo(()=>{if(!t[c])return[];const A=t[c].name,P=b.filter(y=>y.type==="task"&&y.contactId===d&&y.projectId===r&&y.step===A);return P.length>0&&w.debug("üîç T√¢ches filtr√©es pour cette √©tape:",{prospectId:d,projectType:r,stepName:A,totalAppointments:b.length,filteredTasks:P.length,tasks:P.map(y=>({id:y.id,title:y.title,contactId:y.contactId,projectId:y.projectId,step:y.step}))}),P},[b,d,r,c,t]),D=(A,P)=>{v(y=>{var N;const i=y[A]||{},o={...i,[P]:!i[P]},T={...y,[A]:o},H=(N=x==null?void 0:x.actions)==null?void 0:N.find(M=>M.id===A);return H&&H.checklist&&H.checklist.every(ne=>o[ne.id])&&x!=null&&x.autoCompleteStep&&(J({title:"‚úÖ Checklist compl√©t√©e !",description:"Passage automatique √† l'√©tape suivante...",className:"bg-green-500 text-white"}),m(d,r,c,t)),T})};return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-5 top-5 bottom-5 w-0.5 bg-gray-200","aria-hidden":"true"}),e.jsx("div",{className:"space-y-6",children:t.map((A,P)=>{const y=at[A.status]||at[qe];return e.jsxs(Ye.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:P*.1},className:"flex items-start space-x-4 relative",children:[e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-lg ${y.iconOnly}`,children:A.icon})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h3",{className:`font-medium ${y.text}`,children:A.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[A.subSteps&&A.subSteps.length>0&&e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[A.subSteps.filter(i=>i.status===Le).length,"/",A.subSteps.length," sous-√©tapes"]}),e.jsxs("div",{className:"relative","data-step-status-container":!0,children:[e.jsx(pe,{variant:"ghost",size:"sm",className:`text-xs px-2.5 py-1 rounded-full mt-1 sm:mt-0 ${y.badge} hover:opacity-90`,onClick:i=>{var N;i.stopPropagation();const o=i.currentTarget,T=o.nextElementSibling,H=o.closest("[data-step-status-container]");!T||!H||((N=H.parentElement)==null||N.querySelectorAll('[data-dropdown="step-status"]').forEach(M=>{M!==T&&M.classList.add("hidden")}),T.classList.toggle("hidden"))},children:y.label}),e.jsxs("div",{className:"hidden absolute right-0 mt-2 w-40 rounded-lg bg-white shadow-lg border border-gray-100 z-20 overflow-hidden","data-dropdown":"step-status",children:[e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-blue-50 text-blue-600",onClick:i=>{var o;i.stopPropagation(),i.preventDefault(),s(P,De),(o=i.currentTarget.parentElement)==null||o.classList.add("hidden")},children:"Mettre en cours"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-green-50 text-green-600",onClick:i=>{var o;i.stopPropagation(),i.preventDefault(),s(P,Le),(o=i.currentTarget.parentElement)==null||o.classList.add("hidden")},children:"Terminer"}),e.jsx("button",{className:"w-full text-left text-xs px-3 py-2 hover:bg-gray-100 text-gray-600",onClick:i=>{var o;i.stopPropagation(),i.preventDefault(),s(P,qe),(o=i.currentTarget.parentElement)==null||o.classList.add("hidden")},children:"Marquer √† venir"})]})]})]})]}),A.subSteps&&A.subSteps.length>0&&e.jsx("div",{className:"mt-3 space-y-2 border border-gray-100 rounded-lg p-3 bg-gray-50",children:A.subSteps.map((i,o)=>{const T=at[i.status]||at[qe];return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${i.status===Le?"bg-green-500":i.status===De?"bg-blue-500":"bg-gray-300"}`}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate max-w-[220px]",children:i.name})]}),e.jsx("span",{className:`text-[11px] px-2 py-1 rounded-full ${T.badge}`,children:T.label})]},i.id||o)})}),A.status===De&&P===c&&(x==null?void 0:x.actions)&&e.jsx("div",{className:"mt-4 space-y-2",children:x.actions.filter(i=>i.hasClientAction===!1&&i.checklist&&i.checklist.length>0).map(i=>{const o=g[i.id]||{},T=i.checklist.length,H=i.checklist.filter(M=>o[M.id]).length,N=H===T;return e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-purple-900",children:"üìã Checklist √† compl√©ter"}),e.jsxs("span",{className:`text-xs px-2 py-1 rounded-full ${N?"bg-green-100 text-green-700":"bg-purple-100 text-purple-700"}`,children:[H,"/",T]})]}),e.jsx("div",{className:"space-y-2",children:i.checklist.map(M=>{const ne=o[M.id]||!1;return e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer hover:bg-purple-100 rounded p-2 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:()=>D(i.id,M.id),className:"mt-0.5 h-4 w-4 text-purple-600 rounded focus:ring-purple-500 focus:ring-2"}),e.jsx("p",{className:`text-sm flex-1 ${ne?"text-purple-500 line-through":"text-purple-800"}`,children:M.text})]},M.id)})}),(x==null?void 0:x.autoCompleteStep)&&e.jsx("p",{className:"text-xs text-purple-600 mt-3 italic flex items-center gap-1",children:"‚ö° Passage automatique √† l'√©tape suivante quand tout est coch√©"})]},i.id)})}),A.status===De&&P===c&&F.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:F.map(i=>{const o=i.status==="effectue",T=i.startTime?new Date(i.startTime):null,H=T&&!isNaN(T.getTime()),N=async()=>{const M=o?"pending":"effectue";await p(i.id,{status:M}),J({title:o?"üîÑ T√¢che r√©ouverte":"‚úÖ T√¢che termin√©e",description:o?"La t√¢che a √©t√© remise en cours":"La t√¢che a √©t√© marqu√©e comme termin√©e",className:o?"bg-blue-500 text-white":"bg-green-500 text-white"})};return e.jsxs("label",{className:"bg-green-100 border-l-4 border-green-500 text-green-800 rounded-lg p-3 flex items-start gap-3 shadow-sm cursor-pointer hover:bg-green-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:N,className:"mt-0.5 h-4 w-4 text-green-600 rounded focus:ring-green-500 focus:ring-2 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`text-sm font-medium ${o?"line-through text-gray-500":""} truncate flex-1`,children:i.title||"T√¢che"}),o&&e.jsx(dt,{className:"h-4 w-4 text-green-600 flex-shrink-0"})]}),H&&e.jsxs("p",{className:"text-xs text-green-600 mt-1 truncate",children:["üìÖ ",Ke(T,"dd/MM/yyyy √† HH:mm",{locale:Oe})]})]})]},i.id)})})]})]},P)})})]})},br=({prospect:t,projectType:s,supabaseSteps:a,v2Templates:r,onUpdate:c})=>{var q;const{forms:d,prompts:m,completeStepAndProceed:g,activeAdminUser:v,appointments:S,updateAppointment:b}=Ve(),{formPanels:p=[],loading:z,updateFormPanel:x}=Hs(null),{sendMessage:F}=js(t.id,s),[D,f]=n.useState(null),[A,P]=n.useState({}),[y,i]=n.useState(!1),[o,T]=n.useState(null),[H,N]=n.useState(""),[M,ne]=n.useState(new Set),ie=n.useMemo(()=>p?p.filter(u=>u.prospectId===t.id&&u.projectType===s).sort((u,O)=>(O.createdAt||0)-(u.createdAt||0)):[],[p,t.id,s]);if(n.useEffect(()=>{!ie||ie.length===0||ie.forEach(u=>{var V,le,h,C;if(M.has(u.panelId)||u.status!=="submitted")return;if(u.lastSubmittedAt){const X=new Date(u.lastSubmittedAt).getTime(),te=Date.now()-X;if(te>1e4){w.debug("Form too old, skipping auto-complete",{panelId:u.panelId,ageSeconds:Math.floor(te/1e3)}),ne(W=>new Set([...W,u.panelId]));return}}w.debug("New submitted form detected",{panelId:u.panelId,formId:u.formId,projectType:u.projectType}),w.debug("Available prompts",{count:Object.keys(m).length});let O=null;if(u.promptId&&(w.debug("Searching by promptId",{promptId:u.promptId}),O=m[u.promptId]),O||(O=Object.values(m).find(X=>{var W,Z;if(w.debug("Testing prompt",{name:X.name,projectId:X.projectId,target:u.projectType}),X.projectId!==u.projectType)return!1;const L=(W=X.stepsConfig)==null?void 0:W[u.currentStepIndex];return(Z=L==null?void 0:L.actions)==null?void 0:Z.some(oe=>oe.type==="show_form"&&oe.formId===u.formId)})),w.debug("Prompt found",{name:O==null?void 0:O.name,autoComplete:(le=(V=O==null?void 0:O.stepsConfig)==null?void 0:V[u.currentStepIndex])==null?void 0:le.autoCompleteStep}),O){const X=(h=O.stepsConfig)==null?void 0:h[u.currentStepIndex],L=(C=X==null?void 0:X.actions)==null?void 0:C.find(W=>W.type==="show_form"&&W.formId===u.formId),te=(L==null?void 0:L.verificationMode)||"human";w.debug("Checking auto-complete conditions",{autoCompleteStep:X==null?void 0:X.autoCompleteStep,verificationMode:te}),X!=null&&X.autoCompleteStep&&te==="none"&&(w.debug("Triggering completeStepAndProceed (no verification needed)",{prospect:t.name}),g(t.id,u.projectType,u.currentStepIndex),J({title:"‚úÖ √âtape termin√©e !",description:`${t.name} a compl√©t√© le formulaire. Passage automatique √† l'√©tape suivante.`,className:"bg-green-500 text-white"}))}ne(X=>new Set([...X,u.panelId]))})},[ie,m,g,t.id,t.name,M]),ie.length===0)return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsx("span",{className:"text-xs text-gray-500",children:"0 formulaire"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun formulaire soumis pour ce projet."})]});const me=u=>{f(u.panelId);const le=((t.form_data||t.formData||{})[u.projectType]||{})[u.formId]||{};P({...le,_meta:{projectType:u.projectType,formId:u.formId}})},B=()=>{f(null),P({})},he=async()=>{const{_meta:u,...O}=A,{projectType:V,formId:le}=u||{};if(!V||!le){w.error("‚ùå M√©tadonn√©es manquantes pour la sauvegarde");return}const h=t.form_data||t.formData||{},C={...h,[V]:{...h[V]||{},[le]:O}},{error:X}=await ge.from("prospects").update({form_data:C}).eq("id",t.id);if(X){w.error("‚ùå Erreur sauvegarde formulaire:",X),J({title:"Erreur",description:"Impossible de sauvegarder les modifications.",variant:"destructive"});return}J({title:"‚úÖ Sauvegard√©",description:"Les modifications ont √©t√© enregistr√©es.",className:"bg-green-500 text-white"}),c&&c({...t,form_data:C,formData:C}),f(null),P({})},Q=(u,O)=>{P(V=>({...V,[u]:O}))},E=u=>{var le,h;const O=Object.values(m).find(C=>C.id===u.promptId||C.projectId===u.projectType),V=(le=O==null?void 0:O.stepsConfig)==null?void 0:le[u.currentStepIndex];return(h=V==null?void 0:V.actions)==null?void 0:h.find(C=>C.formId===u.formId)},G=async u=>{var O,V,le,h;try{await x(u.panelId,{status:"approved"});const C=E(u),X=(C==null?void 0:C.verificationMode)||"human";if(w.debug("üîç Checking verification mode",{verificationMode:X,shouldSearchTask:X==="human"}),X==="human"){w.debug("üîç Searching for related task",{totalAppointments:(S==null?void 0:S.length)||0,prospectId:t.id,projectType:u.projectType,stepName:u.stepName,panel:u});const we=(S==null?void 0:S.filter(ae=>ae.type==="task"))||[],je=we.filter(ae=>ae.contactId===t.id);w.debug("üîç Task filtering debug",{allTasks:we.length,prospectTasks:je.length,prospectTasksData:je.map(ae=>({id:ae.id,title:ae.title,contactId:ae.contactId,projectId:ae.projectId,step:ae.step,status:ae.status}))}),w.debug("üîç Searching for task with criteria:",{searchCriteria:{type:"task",contactId:t.id,projectId:u.projectType,step:u.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let ye=S==null?void 0:S.find(ae=>{var Pe;const Ce={isTask:ae.type==="task",contactMatch:ae.contactId===t.id,projectMatch:ae.projectId===u.projectType,stepMatch:ae.step===u.stepName,isPending:ae.status==="pending",titleMatch:(Pe=ae.title)==null?void 0:Pe.includes("V√©rifier le formulaire")},Ae=Object.values(Ce).every(j=>j);return!Ae&&ae.type==="task"&&ae.contactId===t.id&&w.warn("üîç Task failed matching:",{taskId:ae.id,title:ae.title,checks:Ce,COMPARISON:{taskStep:`"${ae.step}"`,panelStep:`"${u.stepName}"`,areEqual:ae.step===u.stepName,taskStepType:typeof ae.step,panelStepType:typeof u.stepName},taskData:{contactId:ae.contactId,projectId:ae.projectId,step:ae.step,status:ae.status},panelData:{projectType:u.projectType,stepName:u.stepName}}),Ae});ye||(w.warn("‚ö†Ô∏è Task not found with exact step, trying fallback without step",{panelStep:u.stepName}),ye=S==null?void 0:S.find(ae=>{var Ce;return ae.type==="task"&&ae.contactId===t.id&&ae.projectId===u.projectType&&ae.status==="pending"&&((Ce=ae.title)==null?void 0:Ce.includes("V√©rifier le formulaire"))}),ye&&w.info("‚úÖ Found task via fallback (without step match)",{taskId:ye.id,taskStep:ye.step})),ye?(w.info("‚úÖ Found verification task, marking as completed",{taskId:ye.id,prospectId:t.id,title:ye.title}),await b(ye.id,{status:"effectue"}),J({title:"‚úÖ T√¢che mise √† jour",description:"La t√¢che de v√©rification a √©t√© marqu√©e comme effectu√©e.",className:"bg-blue-500 text-white"})):w.warn("‚ö†Ô∏è No related task found (even with fallback)",{searchCriteria:{type:"task",contactId:t.id,projectId:u.projectType,step:u.stepName,status:"pending",titleContains:"V√©rifier le formulaire"}})}else w.debug("‚è≠Ô∏è Skipping task search (verificationMode !== human)",{verificationMode:X});const L=a==null?void 0:a[u.projectType],te=(L==null?void 0:L.findIndex(we=>we.status==="in_progress"))??u.currentStepIndex,W=(O=L==null?void 0:L[te])==null?void 0:O.name,Z=W?W.toLowerCase().replace(/[_\s]/g,"-").replace(/[^a-z0-9-]/g,""):null,oe=Z&&r?r[`${s}:${Z}`]:null,ce=(V=oe==null?void 0:oe.configJson)==null?void 0:V.actionConfig,be=W?ps(W):null,_=(ce==null?void 0:ce.completionTrigger)||(be==null?void 0:be.completionTrigger),se=(le=oe==null?void 0:oe.configJson)==null?void 0:le.actions,xe=se&&se.length>1;let fe=!0;if(xe){const we=se.map((Ce,Ae)=>`v2-${Z}-action-${Ae}`),{data:je}=await ge.from("client_form_panels").select("id, action_id").eq("prospect_id",t.id).eq("project_type",u.projectType).eq("status","approved").in("action_id",we);let ye=new Set((je||[]).map(Ce=>Ce.action_id));if(ye.size===0){const{data:Ce}=await ge.from("client_form_panels").select("id, step_name").eq("prospect_id",t.id).eq("project_type",u.projectType).eq("status","approved");(Ce||[]).filter(Pe=>!Pe.step_name||Pe.step_name===W||Pe.step_name===Z).forEach((Pe,j)=>{j<se.length&&ye.add(`v2-${Z}-action-${j}`)})}const ae=ye.size;fe=ae>=se.length,w.debug("[V2] Multi-actions check (by action_id)",{totalActions:se.length,approvedActionIds:[...ye],allCompleted:fe}),fe||(w.info("[V2] Multi-actions: still pending actions, NOT completing step",{remaining:se.length-ae}),J({title:"‚úÖ Action valid√©e",description:`Action ${ae}/${se.length} ‚Äî il reste ${se.length-ae} action(s) avant de terminer l'√©tape.`,className:"bg-blue-500 text-white"}))}if(w.debug("[V2] Checking completionTrigger for form approval",{stepName:W,moduleId:Z,v2TemplateFound:!!oe,completionTrigger:_,currentStepIdx:te,hasMultiActions:xe,allActionsCompleted:fe}),(_==="form_approved"||!_)&&fe&&L)w.info("[V2] Form approved ‚Üí completing step",{prospectId:t.id,projectType:u.projectType,currentStepIdx:te,stepName:W,trigger:_||"default_behavior"}),await g(t.id,u.projectType,te,L),J({title:"‚úÖ √âtape valid√©e automatiquement",description:"La validation du formulaire a d√©clench√© le passage √† l'√©tape suivante",className:"bg-green-500 text-white"});else{const we=Object.values(m).find(je=>je.id===u.promptId||je.projectId===u.projectType);if(we){const je=(h=we.stepsConfig)==null?void 0:h[u.currentStepIndex];je!=null&&je.autoCompleteStep&&(w.debug("[V1] Auto-completing step after validation (legacy)",{prospect:t.id,projectType:u.projectType,stepIndex:u.currentStepIndex}),L?await g(t.id,u.projectType,u.currentStepIndex,L):w.error("No steps found in supabaseSteps for projectType",{projectType:u.projectType}))}}const Ie=(C==null?void 0:C.approvalMessage)||"Merci ! Votre formulaire a √©t√© valid√©.",{data:ke}=await ge.from("chat_messages").select("*").eq("prospect_id",t.id).eq("project_type",u.projectType).eq("sender","admin").eq("text",Ie).gte("created_at",new Date(Date.now()-2e3).toISOString()).limit(1);!ke||ke.length===0?await F({sender:"admin",text:Ie,relatedMessageTimestamp:new Date().toISOString()}):w.debug("Message de validation d√©j√† envoy√© r√©cemment, skip"),J({title:"‚úÖ Formulaire valid√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-green-500 text-white"})}catch(C){w.error("‚ùå Erreur validation formulaire:",C),J({title:"Erreur",description:"Impossible de valider le formulaire.",variant:"destructive"})}},ue=async(u="")=>{if(o)try{const O=o;await x(O.panelId,{status:"rejected"});const V=E(O),le=(V==null?void 0:V.verificationMode)||"human";if(w.debug("üîç Checking verification mode (reject)",{verificationMode:le,shouldSearchTask:le==="human"}),le==="human"){w.debug("üîç Searching for related task (reject)",{totalAppointments:(S==null?void 0:S.length)||0,prospectId:t.id,projectType:O.projectType,stepName:O.stepName}),w.debug("üîç Searching for task with criteria (REJECT):",{searchCriteria:{type:"task",contactId:t.id,projectId:O.projectType,step:O.stepName,status:"pending",titleIncludes:"V√©rifier le formulaire"}});let X=S==null?void 0:S.find(L=>{var Z;const te={isTask:L.type==="task",contactMatch:L.contactId===t.id,projectMatch:L.projectId===O.projectType,stepMatch:L.step===O.stepName,isPending:L.status==="pending",titleMatch:(Z=L.title)==null?void 0:Z.includes("V√©rifier le formulaire")},W=Object.values(te).every(oe=>oe);return!W&&L.type==="task"&&L.contactId===t.id&&w.warn("üîç Task failed matching (REJECT):",{taskId:L.id,title:L.title,checks:te,COMPARISON:{taskStep:`"${L.step}"`,panelStep:`"${O.stepName}"`,areEqual:L.step===O.stepName,taskStepType:typeof L.step,panelStepType:typeof O.stepName},taskData:{contactId:L.contactId,projectId:L.projectId,step:L.step,status:L.status},panelData:{projectType:O.projectType,stepName:O.stepName}}),W});X||(w.warn("‚ö†Ô∏è Task not found with exact step (reject), trying fallback",{panelStep:O.stepName}),X=S==null?void 0:S.find(L=>{var te;return L.type==="task"&&L.contactId===t.id&&L.projectId===O.projectType&&L.status==="pending"&&((te=L.title)==null?void 0:te.includes("V√©rifier le formulaire"))}),X&&w.info("‚úÖ Found task via fallback (reject, without step match)",{taskId:X.id,taskStep:X.step})),X&&(w.info("‚úÖ Found verification task, marking as completed (rejected)",{taskId:X.id,prospectId:t.id,title:X.title}),await b(X.id,{status:"effectue"}))}else w.debug("‚è≠Ô∏è Skipping task search (reject, verificationMode !== human)",{verificationMode:le});const C=`${(V==null?void 0:V.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"}

${u}`;await F({sender:"admin",text:C,relatedMessageTimestamp:new Date().toISOString()}),J({title:"‚ùå Formulaire rejet√©",description:"Un message a √©t√© envoy√© au client.",className:"bg-red-500 text-white"}),i(!1),T(null),N("")}catch(O){w.error("‚ùå Erreur rejet formulaire:",O),J({title:"Erreur",description:"Impossible de rejeter le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires soumis"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ie.length," formulaire(s)"]})]}),e.jsx("div",{className:"space-y-4",children:ie.map(u=>{const O=d[u.formId],h=((t.form_data||t.formData||{})[u.projectType]||{})[u.formId]||{};return O?e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:O.name}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["√âtape : ",u.stepName||"Non sp√©cifi√©e"]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${u.status==="submitted"?"bg-green-100 text-green-700":u.status==="approved"?"bg-blue-100 text-blue-700":u.status==="rejected"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:u.status==="submitted"?"Envoy√©":u.status==="approved"?"Approuv√©":u.status==="rejected"?"Rejet√©":"En attente"})]}),u.status==="submitted"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg px-3 py-2",children:e.jsx("p",{className:"text-sm text-green-700",children:"‚úÖ Client a soumis ce formulaire"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(pe,{size:"sm",onClick:()=>G(u),className:"flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(dt,{className:"h-4 w-4 mr-1"}),"Valider"]}),e.jsxs(pe,{size:"sm",variant:"outline",onClick:()=>{T(u),i(!0)},className:"flex-1 border-red-300 text-red-600 hover:bg-red-50",children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Rejeter"]})]})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(O.fields||[]).map(C=>{if(C.show_if_conditions&&C.show_if_conditions.length>0){const W=C.condition_operator||"AND",Z=C.show_if_conditions.map(ce=>{const be=h[ce.field];return ce.equals==="has_value"?!!be&&be!=="":be===ce.equals});if(!(W==="AND"?Z.every(ce=>ce===!0):Z.some(ce=>ce===!0)))return null}if(C.show_if){const W=C.show_if.field,Z=C.show_if.equals,oe=h[W];if(!oe||oe!==Z)return null}if((O.fields||[]).some(W=>W.is_repeater&&(W.repeats_fields||[]).includes(C.id)))return null;const L=h[C.id],te=C.type==="file"&&typeof L=="object"&&(L==null?void 0:L.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-sm font-medium text-gray-600",children:C.label}),D===u.panelId?te?e.jsxs("div",{className:"text-sm text-gray-700 p-2 bg-gray-50 rounded-md",children:[e.jsx(ze,{className:"inline h-4 w-4 mr-2"}),L.name,e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Fichier non modifiable)"})]}):C.type==="select"?e.jsxs("select",{value:A[C.id]||"",onChange:W=>Q(C.id,W.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(C.options||[]).map((W,Z)=>e.jsx("option",{value:W,children:W},Z))]}):e.jsx(Be,{type:C.type||"text",value:A[C.id]||"",onChange:W=>Q(C.id,W.target.value),placeholder:C.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:te?e.jsxs("button",{onClick:async()=>{try{const{data:W,error:Z}=await ge.storage.from("project-files").createSignedUrl(L.storagePath,3600);if(Z)throw Z;window.open(W.signedUrl,"_blank")}catch{J({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx("span",{children:L.name}),e.jsx(xt,{className:"h-3 w-3"})]}):L||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),C.is_repeater&&C.repeats_fields&&C.repeats_fields.length>0&&L&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(L)||0},(W,Z)=>{const oe=(O.fields||[]).filter(ce=>C.repeats_fields.includes(ce.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[C.label," #",Z+1]}),oe.map(ce=>{const be=`${C.id}_repeat_${Z}_${ce.id}`,_=h[be],se=ce.type==="file"&&typeof _=="object"&&(_==null?void 0:_.storagePath);return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:ce.label}),e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:se?e.jsxs("button",{onClick:async()=>{try{const{data:xe,error:fe}=await ge.storage.from("project-files").createSignedUrl(_.storagePath,3600);if(fe)throw fe;window.open(xe.signedUrl,"_blank")}catch{J({title:"‚ùå Erreur",description:"Impossible de t√©l√©charger le fichier.",variant:"destructive"})}},className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline text-xs",children:[e.jsx(ze,{className:"h-3 w-3"}),e.jsx("span",{children:_.name}),e.jsx(xt,{className:"h-3 w-3"})]}):_||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},be)})]},Z)})})]},C.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D===u.panelId?e.jsxs(e.Fragment,{children:[e.jsxs(pe,{variant:"outline",size:"sm",onClick:B,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(pe,{size:"sm",onClick:he,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Ot,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(pe,{variant:"outline",size:"sm",onClick:()=>me(u),children:[e.jsx(pt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},u.panelId):null})}),e.jsx(ht,{open:y,onOpenChange:i,children:e.jsxs(ft,{className:"max-w-lg",children:[e.jsxs(bt,{children:[e.jsx(jt,{children:"Rejeter le formulaire"}),e.jsx(hs,{children:"Expliquez au client pourquoi le formulaire est rejet√©"})]}),e.jsx("div",{className:"space-y-4 py-4",children:o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700 font-medium",children:((q=E(o))==null?void 0:q.rejectionMessage)||"Oups !! Votre formulaire a √©t√© rejet√© pour la raison suivante :"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Me,{children:"Raison du refus"}),e.jsx("textarea",{value:H,onChange:u=>N(u.target.value),placeholder:"Ex: Le RIB n'est pas lisible, veuillez en fournir un nouveau",className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]})}),e.jsxs(Mt,{children:[e.jsx(pe,{variant:"outline",onClick:()=>{i(!1),T(null),N("")},children:"Annuler"}),e.jsx(pe,{onClick:()=>ue(H),disabled:!H.trim(),className:"bg-red-600 hover:bg-red-700",children:"Envoyer dans le chat"})]})]})})]})},jr=({prospect:t,projectType:s,onUpdate:a})=>{const{forms:r}=Ve(),[c,d]=n.useState(null),[m,g]=n.useState({}),v=n.useMemo(()=>Object.values(r).filter(x=>x.audience==="internal"&&(x.projectIds||[]).includes(s)),[r,s]);n.useEffect(()=>{if(t&&t.form_data){const x=t.form_data[s]||{};g(x)}},[t,s]);const S=x=>{d(x)},b=()=>{if(d(null),t&&t.form_data){const x=t.form_data[s]||{};g(x)}},p=(x,F,D)=>{g(f=>({...f,[x]:{...f[x]||{},[F]:D}}))},z=async()=>{try{const x={...t.form_data||{},[s]:m},F={...t,form_data:x,formData:x};await a(F),J({title:"‚úÖ Formulaire enregistr√©",description:"Les donn√©es du formulaire interne ont √©t√© sauvegard√©es.",className:"bg-green-500 text-white"}),d(null)}catch(x){w.error("Erreur sauvegarde formulaire interne:",x),J({title:"‚ùå Erreur",description:"Impossible de sauvegarder le formulaire.",variant:"destructive"})}};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Formulaires internes"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[v.length," formulaire(s)"]})]}),v.length===0?e.jsxs("p",{className:"text-sm text-gray-500 text-center py-8",children:["Aucun formulaire interne pour ce projet.",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Cr√©ez un formulaire avec "Interne (√©quipe)" dans Gestion des Formulaires.'})]}):e.jsx("div",{className:"space-y-4",children:v.map(x=>{const F=m[x.id]||{},D=c===x.id;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:x.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formulaire interne (√©quipe uniquement)"})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Interne"})]}),e.jsx("div",{className:"space-y-3 pt-2",children:(x.fields||[]).map(f=>{if(f.show_if_conditions&&f.show_if_conditions.length>0){const y=f.condition_operator||"AND",i=f.show_if_conditions.map(T=>{const H=F[T.field];return T.equals==="has_value"?!!H&&H!=="":H===T.equals});if(!(y==="AND"?i.every(T=>T===!0):i.some(T=>T===!0)))return null}if(f.show_if){const y=f.show_if.field,i=f.show_if.equals,o=F[y];if(!o||o!==i)return null}if((x.fields||[]).some(y=>y.is_repeater&&(y.repeats_fields||[]).includes(f.id)))return null;const P=F[f.id]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsxs(Me,{className:"text-sm font-medium text-gray-600",children:[f.label,f.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),D?f.type==="textarea"?e.jsx("textarea",{value:P,onChange:y=>p(x.id,f.id,y.target.value),placeholder:f.placeholder||"",className:"w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"}):f.type==="select"?e.jsxs("select",{value:P,onChange:y=>p(x.id,f.id,y.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(f.options||[]).map((y,i)=>e.jsx("option",{value:y,children:y},i))]}):e.jsx(Be,{type:f.type||"text",value:P,onChange:y=>p(x.id,f.id,y.target.value),placeholder:f.placeholder||""}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:P||e.jsx("span",{className:"text-gray-400 italic",children:"Non renseign√©"})}),f.is_repeater&&f.repeats_fields&&f.repeats_fields.length>0&&P&&e.jsx("div",{className:"mt-4 space-y-3",children:Array.from({length:parseInt(P)||0},(y,i)=>{const o=(x.fields||[]).filter(T=>f.repeats_fields.includes(T.id));return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-green-800 text-xs",children:[f.label," #",i+1]}),o.map(T=>{const H=`${f.id}_repeat_${i}_${T.id}`,N=F[H]||"";return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Me,{className:"text-xs font-medium text-gray-600",children:T.label}),D?T.type==="textarea"?e.jsx("textarea",{value:N,onChange:M=>p(x.id,H,M.target.value),placeholder:T.placeholder||"",className:"w-full min-h-[60px] px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"}):T.type==="select"?e.jsxs("select",{value:N,onChange:M=>p(x.id,H,M.target.value),className:"flex h-8 w-full rounded-md border border-input bg-background px-2 py-1 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx("option",{value:"",children:"-- S√©lectionner --"}),(T.options||[]).map((M,ne)=>e.jsx("option",{value:M,children:M},ne))]}):e.jsx(Be,{type:T.type||"text",value:N,onChange:M=>p(x.id,H,M.target.value),placeholder:T.placeholder||"",className:"text-sm h-8"}):e.jsx("p",{className:"text-sm text-gray-900 p-2 bg-white rounded-md min-h-[32px] flex items-center",children:N||e.jsx("span",{className:"text-gray-400 italic text-xs",children:"Non renseign√©"})})]},H)})]},i)})})]},f.id)})}),e.jsx("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t",children:D?e.jsxs(e.Fragment,{children:[e.jsxs(pe,{variant:"outline",size:"sm",onClick:b,children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"Annuler"]}),e.jsxs(pe,{size:"sm",onClick:z,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Ot,{className:"h-4 w-4 mr-1"}),"Sauvegarder"]})]}):e.jsxs(pe,{variant:"outline",size:"sm",onClick:()=>S(x.id),children:[e.jsx(pt,{className:"h-4 w-4 mr-1"}),"Modifier"]})})]},x.id)})})]})},yr=t=>{switch(t.type){case"email":return e.jsx(yt,{className:"h-4 w-4 text-gray-400"});case"phone":case"tel":return e.jsx(tt,{className:"h-4 w-4 text-gray-400"});default:return t.id.includes("company")?e.jsx(Gs,{className:"h-4 w-4 text-gray-400"}):t.id.includes("address")?e.jsx(vt,{className:"h-4 w-4 text-gray-400"}):t.id.includes("name")?e.jsx(it,{className:"h-4 w-4 text-gray-400"}):e.jsx(Ws,{className:"h-4 w-4 text-gray-400"})}},vr=({prospect:t,onBack:s,onUpdate:a,onEditingChange:r})=>{var ve;const{getProjectSteps:c,completeStepAndProceed:d,updateProjectSteps:m,markNotificationAsRead:g,projectsData:v,formContactConfig:S,currentUser:b,userProjects:p,setUserProjects:z,getProjectInfo:x,updateProjectInfo:F,activeAdminUser:D,prompts:f,notifications:A}=Ve(),{supabaseUserId:P}=st(),{users:y,loading:i}=ct(),{projectStepsStatus:o,updateProjectSteps:T}=la(t.id),{organizationId:H}=ot(),{templates:N}=ys(H||(D==null?void 0:D.organization_id),null),[M,ne]=xs(),ie=M.get("project")||t._selectedProjectType,me=M.get("notificationId"),[B,he]=n.useState(ie||(t.tags&&t.tags.length>0?t.tags[0]:null)),{addHistoryEvent:Q,addProjectEvent:E}=et({projectType:B||"",prospectId:t.id,enabled:!!B&&!!t.id,activeAdminUser:D}),[G,ue]=n.useState(!1),[q,u]=n.useState(t);n.useEffect(()=>{u(t)},[t]);const[O,V]=n.useState(!1),le=n.useMemo(()=>B?x(t.id,B)||{}:{},[B,x,t.id]),[h,C]=n.useState((le==null?void 0:le.status)||"actif"),[X,L]=n.useState({}),te=le==null?void 0:le.amount,W=n.useMemo(()=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}),[]),[Z,oe]=n.useState(""),[ce,be]=n.useState(!1),_=n.useMemo(()=>[{value:"unassigned",label:"Non assign√©"},...y.map(l=>({value:l.user_id,label:l.name}))],[y]),se=n.useMemo(()=>{var k;if(!B)return[];if(o[B])return o[B].map(R=>Ut(R,B,N)).map(Zt);const l=(k=v[B])==null?void 0:k.steps;if(l&&l.length>0){const R=JSON.parse(JSON.stringify(l));return R[0].status="in_progress",R.map($=>Ut($,B,N)).map(Zt)}return[]},[B,o,v,N]),xe=se.findIndex(l=>l.status===De),fe=se[xe]||se.find(l=>l.status===qe)||se[0];n.useEffect(()=>{if(me){g(parseInt(me));const l=new URLSearchParams(M);l.delete("notificationId"),ne(l,{replace:!0})}},[me,g,ne,M]),n.useEffect(()=>{var k;const l=M.get("project");l&&l!==B&&((k=t.tags)!=null&&k.includes(l))&&he(l)},[M,t.tags]),n.useEffect(()=>{if(!(t!=null&&t.id)||!B||!A||!g)return;const l=A.filter(k=>!k.read&&k.prospectId===t.id&&k.projectType===B);l.length>0&&l.forEach(k=>{g(k.id)})},[t==null?void 0:t.id,B,A,g]),n.useEffect(()=>{w.debug("Prospect prop changed",{name:t.name}),u(t)},[t]),n.useEffect(()=>{ce||(te==null||te===""?oe(""):oe(te.toString()))},[te,ce]),n.useEffect(()=>{(async()=>{var $;if(!B||!t.id)return;const{data:k,error:R}=await ge.from("project_infos").select("data").eq("prospect_id",t.id).eq("project_type",B).maybeSingle();R?(w.error("Erreur chargement project status:",R),C("actif")):($=k==null?void 0:k.data)!=null&&$.status?C(k.data.status):C("actif")})()},[B,t.id]),n.useEffect(()=>{(async()=>{if(!t.id||!t.tags||t.tags.length===0)return;const{data:k,error:R}=await ge.from("project_infos").select("project_type, status").eq("prospect_id",t.id).in("project_type",t.tags);if(k){const $={};k.forEach(K=>{$[K.project_type]=K.status||"actif"}),L($)}})()},[t.id,t.tags]),n.useEffect(()=>{r&&r(G)},[G,r]),n.useEffect(()=>{if(!t.id)return;const l=ge.channel(`signature-completion-${t.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"signature_procedures",filter:`prospect_id=eq.${t.id}`},async k=>{var Re;const{new:R,old:$}=k;if(R.status!=="signed"||($==null?void 0:$.status)==="signed")return;const K=R.project_type;w.info("[V2 Signature Listener] Signature completed",{procedureId:R.id,projectType:K,prospectId:R.prospect_id});const U=o==null?void 0:o[K];if(!U||U.length===0){w.warn("[V2 Signature Listener] No steps found for project type",{projectType:K});return}const ee=U.findIndex(_e=>_e.status==="in_progress");if(ee===-1){w.warn("[V2 Signature Listener] No current step in_progress",{projectType:K});return}const re=(Re=U[ee])==null?void 0:Re.name;if(!re){w.warn("[V2 Signature Listener] Current step has no name",{currentStepIdx:ee});return}const Ne=ps(re);if((Ne==null?void 0:Ne.completionTrigger)!=="signature"){w.debug('[V2 Signature Listener] completionTrigger is not "signature", skipping',{stepName:re,completionTrigger:(Ne==null?void 0:Ne.completionTrigger)||"null"});return}w.info("[V2 Signature Listener] Triggering completeStepAndProceed",{prospectId:t.id,projectType:K,currentStepIdx:ee,stepName:re});try{await d(t.id,K,ee,U),J({title:"‚úÖ √âtape valid√©e automatiquement",description:`La signature a d√©clench√© la validation de "${re}"`,className:"bg-green-500 text-white"})}catch(_e){w.error("[V2 Signature Listener] Error completing step",_e)}}).subscribe();return()=>{ge.removeChannel(l)}},[t.id,o,d]);const Se=l=>{he(l),ne(k=>(k.set("project",l),k),{replace:!0})},Ie=async l=>{if(!B||!t.id)return;const k=h;C(l);try{const{error:R}=await ge.from("project_infos").upsert({prospect_id:t.id,project_type:B,status:l,data:(le==null?void 0:le.data)||{}},{onConflict:"prospect_id,project_type"});if(R)throw R;const $={actif:"r√©activ√©",abandon:"abandonn√©",archive:"archiv√©"},{error:K}=await ge.from("project_history").insert({prospect_id:t.id,project_type:B,event_type:"status",description:`Projet ${$[l]||l}`,organization_id:D==null?void 0:D.organization_id,metadata:{old_status:k,new_status:l}});K&&w.error("Erreur historique:",K),F(t.id,B,(U={})=>({...U,status:l})),L(U=>({...U,[B]:l})),J({title:"‚úÖ Statut mis √† jour",description:`Le projet est maintenant "${$[l]}".`,className:"bg-green-500 text-white"})}catch(R){w.error("Erreur lors du changement de statut:",R),C(k),J({title:"‚ùå Erreur",description:"Impossible de changer le statut du projet.",variant:"destructive"})}},ke=l=>{oe(l)},we=l=>{if(!B)return;const k=l.replace(",",".").trim();if(k===""){F(t.id,B,(K={})=>{if(!K.amount)return K;const U={...K};return delete U.amount,U}),oe("");return}const R=parseFloat(k);if(Number.isNaN(R)||R<0){oe(te==null?"":te.toString());return}const $=Math.round(R*100)/100;F(t.id,B,(K={})=>({...K,amount:$})),oe($.toFixed(2))},je=()=>{we(Z),be(!1)},ye=l=>{l.key==="Enter"&&(l.preventDefault(),we(l.currentTarget.value),l.currentTarget.blur(),be(!1))},ae=async(l,k)=>{var $,K;const R=se[l];if(k===Le&&(($=R==null?void 0:R.subSteps)==null?void 0:$.length)>0&&!xr(R)){J({title:"Sous-√©tapes en cours",description:"Vous devez valider chaque sous-√©tape avant de terminer cette √©tape.",variant:"destructive"});return}if(k===De&&((K=R==null?void 0:R.subSteps)==null?void 0:K.length)>0){const U=JSON.parse(JSON.stringify(se)),ee=U[l];ee.status=De,ee.subSteps=ee.subSteps.map((re,Ne)=>({...re,status:Ne===0?De:qe})),await T(B,U),Q&&await Q({event_type:"pipeline",title:"√âtape relanc√©e",description:`Sous-√©tapes r√©initialis√©es pour ¬´ ${ee.name} ¬ª`,metadata:{step_id:(ee==null?void 0:ee.id)||null,step_name:(ee==null?void 0:ee.name)||null,previous_status:(R==null?void 0:R.status)||null,new_status:De,project_type:B},createdBy:P,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)});return}if(k===Le){const U=JSON.parse(JSON.stringify(se));U[l].status="completed";let ee=l+1;if(ee<U.length&&(U[ee].status="in_progress"),await T(B,U),Q){const re=ee<U.length?U[ee]:null;await Q({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:R&&re?`√âtape ¬´ ${R.name} ¬ª compl√©t√©e ‚Üí passage √† ¬´ ${re.name} ¬ª`:`√âtape ¬´ ${R.name} ¬ª compl√©t√©e`,metadata:{previous_step_id:(R==null?void 0:R.id)||null,previous_step_name:(R==null?void 0:R.name)||null,previous_step_status:(R==null?void 0:R.status)||null,new_step_id:(re==null?void 0:re.id)||null,new_step_name:(re==null?void 0:re.name)||null,new_step_status:"in_progress",project_type:B},createdBy:P,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}if(ee<U.length&&U[ee].globalStepId){const re=U[ee].globalStepId,Ne={...t,status:re};a(Ne),J({title:"üìä Pipeline mis √† jour",description:"Le prospect a √©t√© d√©plac√© dans le pipeline"})}}else{const U=se.map((re,Ne)=>{let Re=re.status;return Ne===l&&(Re=k),{...re,status:Re}});if(await T(B,U),Q){const re=U[l];await Q({event_type:"pipeline",title:"√âtape du pipeline mise √† jour",description:`√âtape ¬´ ${re.name} ¬ª pass√©e de ¬´ ${R.status==="pending"?"√Ä venir":R.status==="in_progress"?"En cours":"Termin√©"} ¬ª √† ¬´ ${k==="pending"?"√Ä venir":k==="in_progress"?"En cours":"Termin√©"} ¬ª`,metadata:{step_id:(re==null?void 0:re.id)||null,step_name:(re==null?void 0:re.name)||null,previous_status:(R==null?void 0:R.status)||null,new_status:k,project_type:B},createdBy:P,createdByName:(D==null?void 0:D.name)||(D==null?void 0:D.email)})}const ee=U[l];if(ee.globalStepId&&k==="in_progress"){const re={...t,status:ee.globalStepId};a(re)}}},Ce=async l=>{var R,$;const k=q.tags||[];if(!k.includes(l)){const K={...q,tags:[...k,l]};if(u(K),a(K),he(l),b&&t.id===b.id&&!p.includes(l)){const ee=[...p,l];z(ee)}const U=(R=v[l])==null?void 0:R.steps;if(U&&U.length>0)try{const ee=JSON.parse(JSON.stringify(U));ee[0].status="in_progress",await T(l,ee),w.debug("Steps initialized in Supabase",{projectType:l})}catch(ee){w.error("Steps initialization error:",ee)}J({title:"‚úÖ Projet ajout√© !",description:`Le projet ${($=v[l])==null?void 0:$.title} a √©t√© associ√© au prospect.`})}V(!1)},Ae=()=>{const l=q.tags||[];return Object.values(v).filter(k=>k.isPublic&&!l.includes(k.type))},Pe=async l=>{switch(l){case"Appel":q.phone&&(window.location.href=`tel:${q.phone}`);break;case"Mail":q.email&&(window.location.href=`mailto:${q.email}`);break;case"WhatsApp":if(q.phone){const k=q.phone.replace(/[^0-9]/g,"");window.open(`https://wa.me/${k}`,"_blank")}else J({title:"Num√©ro de t√©l√©phone manquant",description:"Ce contact n'a pas de num√©ro de t√©l√©phone.",variant:"destructive"});break;case"GPS":if(t.address){const k=encodeURIComponent(t.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${k}`:window.open(`https://www.google.com/maps/search/?api=1&query=${k}`,"_blank")}break;case"Invitation":if(!q.email){J({title:"Email manquant",description:"Ce prospect n'a pas d'email.",variant:"destructive"});return}try{const k=`${window.location.origin}/dashboard`,R=H||(D==null?void 0:D.organization_id);console.log("[handleActionClick] üìß Sending magic link to:",q.email,"org:",R);const{error:$}=await ge.auth.signInWithOtp({email:q.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:k,data:{organization_id:R}}});$?(console.error("[handleActionClick] ‚ùå Magic link error:",$),J({title:"‚ùå Erreur envoi invitation",description:$.message,variant:"destructive"})):(console.log("[handleActionClick] ‚úÖ Magic link sent to:",q.email),J({title:"‚úÖ Invitation envoy√©e",description:`Magic link envoy√© √† ${q.email}`,className:"bg-green-500 text-white"}))}catch(k){console.error("[handleActionClick] üí• Exception:",k),J({title:"‚ùå Erreur",description:k.message,variant:"destructive"})}break;default:J({title:`Action: ${l}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},j=()=>{const l=window.scrollY;ue(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:l,behavior:"instant"})})})},I=()=>{try{a(q),ue(!1),J({title:"‚úÖ Prospect mis √† jour",description:"Les informations du prospect ont √©t√© enregistr√©es."})}catch(l){w.error("‚ùå Erreur sauvegarde:",l),J({title:"‚ùå Erreur",description:l.message,variant:"destructive"})}},Y=(l,k)=>{u(R=>({...R,[l]:k}))},de=l=>{let k=l;l==="unassigned"?k=null:l==="user-1"&&P&&(k=P),u(R=>({...R,ownerId:k}))};return v[B],n.useEffect(()=>{const l=document.createElement("style");return l.id="disable-auto-scroll",l.textContent=`
      * {
        scroll-margin: 0 !important;
        scroll-padding: 0 !important;
      }
      input:focus, textarea:focus, select:focus {
        scroll-margin-block: 0 !important;
      }
    `,document.head.appendChild(l),()=>{const k=document.getElementById("disable-auto-scroll");k&&k.remove()}},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(pe,{variant:"ghost",size:"icon",onClick:s,className:"rounded-full hover:bg-gray-100",children:e.jsx(Os,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:q.name})})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[340px_minmax(0,1fr)_420px] gap-6 xl:gap-6 items-stretch",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Projets associ√©s"}),e.jsx(pe,{size:"icon",className:"rounded-full",onClick:()=>V(!0),children:e.jsx(Pt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(q.tags||[]).map(l=>{var R;const k=X[l]||"actif";return e.jsxs("button",{onClick:()=>Se(l),className:`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 flex items-center gap-2 ${B===l?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{children:((R=v[l])==null?void 0:R.title)||l}),k==="abandon"&&e.jsx("span",{className:`text-xs font-medium ${B===l?"text-red-200":"text-red-600"}`,children:"(Abandonn√©)"}),k==="archive"&&e.jsx("span",{className:`text-xs font-medium ${B===l?"text-gray-300":"text-gray-500"}`,children:"(Archiv√©)"})]},l)}),(!q.tags||q.tags.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm italic",children:"Aucun projet associ√©"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actions rapides"}),e.jsx("div",{className:"flex flex-wrap justify-between gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"},{icon:Ls,label:"Invitation",highlight:!q.userId}].map(({icon:l,label:k,highlight:R})=>e.jsxs("button",{onClick:()=>Pe(k),className:`flex flex-col items-center space-x-1 transition-colors group ${R?"text-orange-600 hover:text-orange-700":"text-gray-600 hover:text-blue-600"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${R?"bg-orange-100 group-hover:bg-orange-200":"bg-gray-100 group-hover:bg-blue-100"}`,children:e.jsx(l,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:k})]},k))})]}),e.jsx(Nr,{prospectId:t.id,projectType:B}),e.jsx(br,{prospect:q,projectType:B,supabaseSteps:o,v2Templates:N,onUpdate:l=>{u(l),a&&a(l)}}),e.jsx(jr,{prospect:q,projectType:B,onUpdate:l=>{u(l),a&&a(l)}}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations Prospect"}),G?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-green-600 hover:bg-green-100",onClick:I,children:e.jsx(Ot,{className:"h-4 w-4"})}),e.jsx(pe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:bg-red-100",onClick:()=>ue(!1),children:e.jsx(Je,{className:"h-4 w-4"})})]}):e.jsx(pe,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:j,children:e.jsx(pt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[S.map(l=>e.jsxs("div",{className:"flex items-start space-x-3",children:[yr(l),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{htmlFor:l.id,className:"text-xs text-gray-500",children:l.name.replace("*","")}),G?e.jsx(Be,{id:l.id,name:l.id,type:l.type,value:q[l.id]||"",onChange:k=>Y(l.id,k.target.value),className:"h-8 text-sm",placeholder:l.placeholder,autoFocus:!1}):e.jsx("p",{className:"text-gray-700",children:q[l.id]||e.jsx("span",{className:"text-gray-400",children:"Non renseign√©"})})]})]},l.id)),e.jsxs("div",{className:"flex items-center space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(it,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"Suivi par"}),G?e.jsx(ia,{options:_,value:q.ownerId||"unassigned",onSelect:de,placeholder:"S√©lectionner un utilisateur",searchPlaceholder:"Rechercher...",emptyText:"Aucun utilisateur trouv√©."}):e.jsx("p",{className:"text-gray-700",children:((ve=y.find(l=>l.user_id===q.ownerId))==null?void 0:ve.name)||"Non assign√©"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Prospect"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.id})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 pt-3 border-t border-gray-100",children:[e.jsx(it,{className:"h-4 w-4 text-gray-400 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Me,{className:"text-xs text-gray-500",children:"ID Utilisateur (owner)"}),e.jsx("p",{className:"text-gray-700 text-xs font-mono",children:t.ownerId||"Non assign√©"})]})]})]})]})]}),e.jsx(or,{prospectId:t.id,projectType:B,currentStep:fe,statusConfig:at,activeAdminUser:D,children:B&&e.jsx(hr,{prospectId:t.id,projectType:B,currentStepIndex:xe!==-1?xe:0,activeAdminUser:D})}),e.jsxs("div",{className:"space-y-6 xl:max-w-[520px] w-full flex flex-col",children:[B&&e.jsxs("div",{className:"bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg p-6 border border-gray-200 relative",children:[e.jsx("button",{onClick:()=>be(!ce),className:"absolute top-3 right-3 p-1.5 hover:bg-white/50 rounded-lg transition-colors",title:ce?"Annuler":"Modifier le montant",children:ce?e.jsx(Je,{className:"h-4 w-4 text-gray-600"}):e.jsx(pt,{className:"h-4 w-4 text-gray-600"})}),e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-2 text-center",children:"Montant du deal"}),ce?e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-500",children:"‚Ç¨"}),e.jsx(Be,{type:"number",min:"0",step:"0.01",inputMode:"decimal",value:Z,onChange:l=>ke(l.target.value),onKeyDown:ye,placeholder:"0,00",className:"pl-7 text-xl font-bold text-center w-40 h-11",autoFocus:!0})]}),e.jsx(pe,{size:"sm",onClick:je,className:"h-8",children:e.jsx(dt,{className:"h-3.5 w-3.5"})})]}):e.jsx("p",{className:"text-4xl font-bold text-gray-900 text-center",children:typeof te=="number"?W.format(te):"0,00 ‚Ç¨"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-card p-6 flex-1",children:[e.jsx("div",{className:"flex items-center justify-center mb-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"√âtapes du projet"}),e.jsx("span",{className:"text-gray-400",children:":"}),e.jsxs(Tt,{value:h,onValueChange:Ie,children:[e.jsx(Rt,{className:`w-auto h-auto text-sm px-3 py-1.5 rounded-full border-none shadow-none font-medium ${h==="actif"?"bg-green-100 text-green-700":h==="abandon"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-500"}`,children:e.jsx($t,{})}),e.jsxs(Ft,{className:"w-44",children:[e.jsx(Fe,{value:"actif",className:"text-sm hover:bg-green-50 text-green-600",children:"Actif"}),e.jsx(Fe,{value:"abandon",className:"text-sm hover:bg-red-50 text-red-600",children:"Abandonn√©"}),e.jsx(Fe,{value:"archive",className:"text-sm hover:bg-gray-100 text-gray-600",children:"Archiv√©"})]})]})]})}),e.jsx(fr,{steps:se,onUpdateStatus:ae,prompts:f,projectType:B,currentStepIndex:xe,prospectId:t.id,completeStepAndProceed:d})]})]})]})]}),e.jsx(ht,{open:O,onOpenChange:V,children:e.jsxs(ft,{className:"sm:max-w-md",children:[e.jsxs(bt,{children:[e.jsx(jt,{children:"Ajouter un projet"}),e.jsx(hs,{children:"S√©lectionnez un projet √† associer √† ce prospect."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:Ae().length>0?Ae().map(l=>e.jsxs(pe,{variant:"outline",onClick:()=>Ce(l.type),className:"flex items-center justify-start space-x-3 h-auto p-4",children:[e.jsx("span",{className:"text-2xl",children:l.icon}),e.jsx("span",{className:"font-medium",children:l.title})]},l.type)):e.jsx("p",{className:"text-center text-gray-500 italic",children:"Tous les projets disponibles sont d√©j√† associ√©s √† ce prospect."})})]})})]})},Nr=({prospectId:t,projectType:s})=>{var Q;const{activeAdminUser:a,prospects:r,projectsData:c,appointments:d,agendaLoading:m,updateAppointment:g,deleteAppointment:v,addAppointment:S,addCall:b,addTask:p,updateCall:z,updateTask:x}=Ve(),{users:F,loading:D}=ct(),{supabaseUserId:f}=st(),[A,P]=n.useState(null),[y,i]=n.useState(null),[o,T]=n.useState(null),[H,N]=n.useState(!1),[M,ne]=n.useState(null),ie=n.useMemo(()=>!d||d.length===0?[]:d.filter(G=>{var q;if(G.contactId!==t||s&&G.projectId!==s)return!1;const ue=(q=G.status)==null?void 0:q.toLowerCase();return!(ue!=="pending"&&ue!=="prevu")}).sort((G,ue)=>{const q=new Date(G.start),u=new Date(ue.start);return q-u}),[d,t,s]),me=(E,G)=>{T(E)},B=()=>{P(null),i(null),T(null)},he=E=>{T(null),ne({...E,type:E.type}),N(!0)};return m?e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Activit√© en cours"}),e.jsx("p",{className:"text-gray-400 italic",children:"Chargement des activit√©s..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow mt-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Activit√©s √† venir ",s&&`(${(Q=c[s])==null?void 0:Q.title})`]})}),ie.length===0?e.jsx("p",{className:"text-gray-400 italic",children:"Aucune activit√© future planifi√©e pour ce projet."}):e.jsx("div",{className:"space-y-3",children:ie.map(E=>{const G=new Date(E.start),ue={physical:{icon:nt,color:"blue",label:"üìç RDV"},virtual:{icon:nt,color:"purple",label:"üé• Visio"},call:{icon:tt,color:"green",label:"üìû Appel"},task:{icon:dt,color:"yellow",label:"‚úÖ T√¢che"}},q=ue[E.type]||ue.physical,u=q.icon,O={effectue:"bg-green-500 text-white",annule:"bg-red-500 text-white",reporte:"bg-yellow-400 text-black",pending:"bg-gray-200 text-gray-700"},V={effectue:"Effectu√©",annule:"Annul√©",reporte:"Report√©",pending:"Pr√©vu"};return e.jsxs("div",{onClick:()=>me(E,E.type),className:`bg-white rounded-lg p-3 shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-${q.color}-500 relative transition-all`,children:[e.jsxs("div",{className:"flex items-center justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(u,{className:`h-5 w-5 text-${q.color}-600`})}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:E.title||q.label}),E.notes&&e.jsx("p",{className:"text-xs text-gray-600 truncate mt-1",children:E.notes}),E.step&&e.jsxs("span",{className:"text-xs text-gray-500 mt-1 block truncate",children:["üìç ",E.step]})]})]}),e.jsxs("div",{className:"flex flex-col items-end ml-2",children:[e.jsx("span",{className:`text-xs font-semibold text-${q.color}-700 bg-${q.color}-100 px-2 py-1 rounded-full whitespace-nowrap`,children:Ke(G,"dd/MM")}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Ke(G,"HH:mm")})]})]}),V[E.status]&&E.status!=="pending"&&e.jsx("span",{className:`absolute bottom-1 right-1 text-xs font-bold px-2 py-0.5 rounded-full ${O[E.status]}`,children:V[E.status]})]},E.id)})})]}),e.jsx(wr,{event:o,onClose:B,onReport:()=>{},onEdit:he,prospects:r,supabaseUsers:F,updateAppointment:g,deleteAppointment:v,projectsData:c}),H&&e.jsx(fs,{open:H,onOpenChange:E=>{E||ne(null),N(E)},initialData:M||{contactId:t,projectId:s},defaultAssignedUserId:f,addAppointment:S,addCall:b,addTask:p,updateAppointment:g,updateCall:z,updateTask:x,prospects:r||[],users:F||[],projectsData:c||{}})]})},wr=({event:t,onClose:s,onReport:a,onEdit:r,prospects:c,supabaseUsers:d,updateAppointment:m,deleteAppointment:g,projectsData:v})=>{var y;const[S,b]=n.useState((t==null?void 0:t.status)||"pending");if(n.useEffect(()=>{t&&b(t.status||"pending")},[t]),!t||!c||!d||!m||!g||!v)return null;const p=c.find(i=>i.id===t.contactId),z=d.find(i=>i.id===t.assignedUserId||i.user_id===t.assignedUserId)||(p?d.find(i=>i.user_id===p.ownerId):null),x=i=>i?i.charAt(0).toUpperCase()+i.slice(1):"",F=(i,o,T={})=>{try{const H=new Date(i);return isNaN(H.getTime())?"Date invalide":Ke(H,o,T)}catch{return"Date invalide"}},D=i=>{b(i),m(t.id,{status:i}),setTimeout(()=>{s(),i==="reporte"&&a(t)},300)},f=()=>{g(t.id),J({title:"‚úÖ RDV supprim√©",description:"Le rendez-vous a √©t√© retir√© de votre agenda."}),s()},A=i=>{if(!p){J({title:"Contact non trouv√©",variant:"destructive"});return}switch(i){case"Appel":p.phone&&(window.location.href=`tel:${p.phone}`);break;case"Mail":p.email&&(window.location.href=`mailto:${p.email}`);break;case"WhatsApp":if(p.phone){let o=p.phone.replace(/\D/g,"");o.startsWith("0")&&(o=`33${o.substring(1)}`);const T=encodeURIComponent("Bonjour");window.open(`https://wa.me/${o}?text=${T}`,"_blank")}break;case"GPS":if(p.address){const o=encodeURIComponent(p.address);/Mac|iPod|iPhone|iPad/.test(navigator.platform)?window.location.href=`maps://?q=${o}`:window.open(`https://www.google.com/maps/search/?api=1&query=${o}`,"_blank")}break;default:J({title:`Action: ${i}`,description:"üöß Cette fonctionnalit√© n'est pas encore impl√©ment√©e."})}},P={pending:{color:"bg-blue-500",label:"Qualifier votre activit√©"},effectue:{color:"bg-green-500",label:"Effectu√©"},annule:{color:"bg-red-500",label:"Annul√©"},reporte:{color:"bg-yellow-500",label:"Report√©"}};return e.jsx(ht,{open:!!t,onOpenChange:i=>!i&&s(),children:e.jsxs(ft,{className:"sm:max-w-md p-0",children:[e.jsx("button",{onClick:s,className:"absolute right-2 top-2 rounded-full p-2 bg-gray-100 hover:bg-gray-200 transition-colors z-10 group",children:e.jsx(Je,{className:"h-6 w-6 text-gray-600 group-hover:text-gray-900"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"text-center py-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:x(F(t.start,"eeee d MMMM",{locale:Oe}))}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:[F(t.start,"HH:mm",{locale:Oe})," - ",F(t.end,"HH:mm",{locale:Oe})]})]}),e.jsx(bt,{className:"p-0 text-left space-y-1",children:e.jsx(jt,{className:"text-xl font-bold text-gray-900",children:t.summary})}),e.jsxs("div",{className:"flex items-start space-x-3 text-gray-600",children:[e.jsx(Ue,{className:"h-5 w-5 text-gray-400 mt-1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Participants"}),p&&e.jsxs("p",{className:"text-sm",children:[p.name," (Client)"]}),z&&e.jsxs("p",{className:"text-sm",children:[z.name," (Assign√©)"]})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Actions rapides"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-center",children:[{icon:tt,label:"Appel"},{icon:yt,label:"Mail"},{icon:Dt,label:"WhatsApp"},{icon:vt,label:"GPS"}].map(({icon:i,label:o})=>e.jsxs("button",{onClick:()=>A(o),className:"flex flex-col items-center space-y-1 text-gray-600 hover:text-blue-600 transition-colors group",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-blue-100",children:e.jsx(i,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs font-medium",children:o})]},o))})]}),e.jsx("div",{className:`p-4 text-white transition-colors ${P[S].color}`,children:e.jsxs(Tt,{onValueChange:D,value:S,children:[e.jsx(Rt,{className:"w-full bg-transparent border-none text-white text-lg font-semibold focus:ring-0 focus:ring-offset-0 h-auto p-0 text-center justify-center",iconClassName:"h-8 w-8 opacity-100",children:e.jsx($t,{placeholder:"Qualifier votre activit√©"})}),e.jsxs(Ft,{children:[e.jsx(Fe,{value:"pending",disabled:!0,children:"Qualifier votre activit√©"}),e.jsx(Fe,{value:"effectue",children:"Effectu√©"}),e.jsx(Fe,{value:"annule",children:"Annul√©"}),e.jsx(Fe,{value:"reporte",children:"Report√©"})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-6 space-y-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wider",children:"Infos activit√©"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Projet"}),e.jsx("span",{className:"font-medium text-gray-800",children:((y=v[t.projectId])==null?void 0:y.title)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"√âtape"}),e.jsx("span",{className:"font-medium text-gray-800",children:t.step||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Note"}),e.jsx("span",{className:"font-medium text-gray-800 text-right",children:t.notes||"Aucune"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Interlocuteur"}),e.jsx("span",{className:"font-medium text-gray-800",children:(p==null?void 0:p.name)||"N/A"})]})]})]}),e.jsxs(Mt,{className:"p-6 bg-gray-50 sm:justify-between",children:[e.jsxs(as,{children:[e.jsx(rs,{asChild:!0,children:e.jsxs(pe,{variant:"ghost",className:"text-red-600 hover:bg-red-50 hover:text-red-700",children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),"Supprimer"]})}),e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Voulez-vous vraiment supprimer ce RDV ?"}),e.jsx(os,{children:"Cette action est irr√©versible. Le rendez-vous sera d√©finitivement supprim√©."})]}),e.jsxs(cs,{children:[e.jsx(ds,{children:"Annuler"}),e.jsx(us,{onClick:f,className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]}),e.jsx(pe,{className:t!=null&&t.status&&t.status!=="pending"?"bg-gray-400 hover:bg-gray-500 text-gray-700":"bg-blue-600 hover:bg-blue-700",onClick:()=>r(t),children:"Modifier l'activit√©"})]})]})})};function _r(t,s){const a=t.prospect,r=s.prospect;return!a||!r?!1:a.id===r.id&&(a.updatedAt||a.updated_at)===(r.updatedAt||r.updated_at)}const Sr=gt.memo(vr,_r),es=["bg-gray-100","bg-blue-100","bg-yellow-100","bg-orange-100","bg-purple-100","bg-green-100","bg-pink-100","bg-indigo-100","bg-teal-100","bg-rose-100"],Cr=t=>t?t.toLowerCase().split(/[_\\s-]+/).filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",We=t=>(t||"").toString().trim().toUpperCase(),Ir={MARKET:"bg-blue-100",ETUDE:"bg-yellow-100",OFFRE:"bg-green-100",CONTRAT:"bg-blue-100","CONTRAT OK":"bg-blue-100","CLIENT ACTIF":"bg-purple-100"},kr=[{id:"lead",label:"PROSPECTS",name:"Prospects"},{id:"contact",label:"PREMIER CONTACT",name:"Premier Contact"},{id:"qualified",label:"QUALIFI√â",name:"Qualifi√©"},{id:"proposal",label:"PROPOSITION",name:"Proposition"},{id:"negotiation",label:"N√âGOCIATION",name:"N√©gociation"},{id:"closed",label:"FERM√â",name:"Ferm√©"}],ts=50,ss=50,qr=()=>{var Ae,Pe;const t=Ve(),[s,a]=xs(),{organizationId:r}=ot(),[c,d]=n.useState(null),[m,g]=n.useState(!1),[v,S]=n.useState("all"),[b,p]=n.useState(null),[z,x]=n.useState(!1),[F,D]=n.useState([]),[f,A]=n.useState(!1),P=n.useRef(null),[y,i]=n.useState(""),o=n.useRef(null),[T,H]=n.useState(!1),[N,M]=n.useState(!1),[ne,ie]=n.useState({}),{users:me,loading:B}=ct(),{authUserId:he}=st(),Q=t==null?void 0:t.addProspect,{prospects:E=[],prospectsLoading:G=!0,allProjectSteps:ue={},allStepsLoading:q=!0,updateProspect:u=async()=>{},projectsData:O={},activeAdminUser:V=null,users:le={},globalPipelineSteps:h=[],pipelineLoading:C=!0,getProjectSteps:X=()=>[],adminReady:L=!1}=t||{},te=n.useMemo(()=>me.reduce((j,I)=>(j[I.user_id]={id:I.id,user_id:I.user_id,name:I.name,email:I.email,role:I.role,phone:I.phone,avatarUrl:I.avatar_url,managerId:I.manager_id,accessRights:I.access_rights},j),{}),[me]);n.useEffect(()=>{L&&!G&&!q&&!N&&M(!0)},[L,G,q,N]);const W=E,Z=u,oe=(E==null?void 0:E.find(j=>j.id===c))||null,ce=n.useMemo(()=>!h||h.length===0?kr:h.map((j,I)=>{const Y=We(j.label),de=j.color||Ir[Y]||es[I%es.length];return{id:j.id,label:j.label,name:Cr(j.label),color:de}}),[h]),be=n.useMemo(()=>{if(!V)return[];if(V.role==="Global Admin"||V.role==="Admin")return Object.values(te);const j=V.access_rights||V.accessRights,I=[V.user_id,...(j==null?void 0:j.users)||[]];return Object.values(te).filter(Y=>I.includes(Y.user_id))},[V,te]),_=n.useMemo(()=>{const j=be.map(I=>({value:I.user_id,label:I.name}));return be.length>1?[{value:"all",label:"Tous les utilisateurs"},...j]:j},[be]);n.useEffect(()=>{V&&b===null&&(be.length>1?p("all"):be.length===1&&p(be[0].user_id))},[V,b,be]),n.useEffect(()=>{if(!f)return;const j=I=>{P.current&&!P.current.contains(I.target)&&A(!1)};return document.addEventListener("mousedown",j),()=>document.removeEventListener("mousedown",j)},[f]);const se=n.useMemo(()=>{const j=new Set;return W.forEach(I=>{(I.tags||[]).forEach(Y=>j.add(Y))}),Array.from(j)},[W]),xe=F.length===0?"Tags":F.length===1?((Ae=O[F[0]])==null?void 0:Ae.title)||F[0]:`${F.length} tags`,fe=n.useMemo(()=>{const j=W.filter(Y=>{if(!V)return!1;if(V.role==="Global Admin"||V.role==="Admin")return!0;const de=V.access_rights||V.accessRights;return[V.user_id,...(de==null?void 0:de.users)||[]].includes(Y.ownerId)});w.debug("[FinalPipeline] Prospects count",{total:W.length,visible:j.length});let I=j;if(F.length>0&&(I=I.filter(Y=>{const de=Y.tags||[];return F.some(ve=>de.includes(ve))})),b&&b!=="all"&&(I=I.filter(Y=>Y.ownerId===b)),y.trim()){const Y=y.toLowerCase();I=I.filter(de=>(de.name||"").toLowerCase().includes(Y)||(de.email||"").toLowerCase().includes(Y)||(de.city||"").toLowerCase().includes(Y)||(de.phone||"").toLowerCase().includes(Y))}return v==="mine"&&he?I.filter(Y=>Y.ownerId===he):I},[W,v,he,b,F,y]),{stagesWithCounts:Se,prospectsByStage:Ie}=n.useMemo(()=>{var R;const j=ce.reduce(($,K)=>($[K.id]=[],$),{}),I=((R=ce[0])==null?void 0:R.id)||"fallback-stage",Y=new Set(ce.map($=>$.id)),de=new Map(ce.map($=>[We($.label),$.id])),ve=$=>{const K=[];return $.projectType&&O[$.projectType]&&K.push($.projectType),Array.isArray($.tags)&&$.tags.forEach(U=>{O[U]&&!K.includes(U)&&K.push(U)}),K},l=$=>{const K=[];if(!h.length){const ee=$.stage||I,re=Y.has(ee)?ee:I;return K.push({stageId:re,prospect:$}),K}if(typeof X!="function")return K.push({stageId:I,prospect:$}),K;const U=ve($);return U.length?(U.forEach(ee=>{var qt;const re=`${$.id}-${ee}`,Ne=ue[re]||(typeof X=="function"?X($.id,ee):[])||[],Re=((qt=O[ee])==null?void 0:qt.steps)||[];if(!Ne.length){K.push({stageId:I,prospect:$,projectType:ee});return}const _e=Ne.find(Ge=>Ge.status==="in_progress"||Ge.status==="current")||Ne.find(Ge=>Ge.status==="pending")||Ne[Ne.length-1];if(!_e){K.push({stageId:I,prospect:$,projectType:ee});return}const He=(()=>{if(_e.globalStepId&&Y.has(_e.globalStepId))return _e.globalStepId;if(_e.globalStepId){const Xe=We(_e.globalStepId),Te=de.get(Xe);if(Te&&Y.has(Te))return Te}const Ge=Ne.indexOf(_e);let Ee=null;if(Ge>=0&&Re[Ge]&&(Ee=Re[Ge]),!Ee){const Xe=We(_e.name||_e.label);Ee=Re.find(Te=>We(Te.name||Te.label)===Xe)}if(Ee!=null&&Ee.globalStepId&&Y.has(Ee.globalStepId))return Ee.globalStepId;if(Ee!=null&&Ee.globalStepId){const Xe=We(Ee.globalStepId),Te=de.get(Xe);if(Te&&Y.has(Te))return Te}if(Ee&&(Ee.label||Ee.name)){const Xe=We(Ee.label||Ee.name),Te=de.get(Xe);if(Te&&Y.has(Te))return Te}const Is=We(_e.label||_e.name),wt=de.get(Is);return wt&&Y.has(wt)?wt:I})();K.push({stageId:He,prospect:$,projectType:ee,activeStep:_e})}),K):(K.push({stageId:I,prospect:$}),K)};return fe.forEach($=>{l($).forEach(({stageId:U,projectType:ee,activeStep:re})=>{j[U]||(j[U]=[]),j[U].push({prospect:$,projectType:ee,activeStep:re})})}),{stagesWithCounts:ce.map($=>{var K;return{...$,count:((K=j[$.id])==null?void 0:K.length)||0}}),prospectsByStage:j}},[ce,fe,h,X,O]);n.useEffect(()=>{const j=s.get("prospect"),I=s.get("project"),Y=`${j}-${I}`;if(o.current===Y)return;if(!j){c!==null&&(d(null),o.current=null);return}(W.find(ve=>ve.id===j)||null)&&(d(j),o.current=Y)},[s,W]);const ke=j=>{D(I=>I.includes(j)?I.filter(Y=>Y!==j):[...I,j])},we=n.useCallback((j,I)=>{d(j.id),a(Y=>{const de=new URLSearchParams(Y);return de.set("prospect",j.id),I?de.set("project",I):de.delete("project"),de})},[a]),je=n.useCallback(j=>{ie(I=>({...I,[j]:(I[j]||ts)+ss}))},[]),ye=()=>{d(null);const j=new URLSearchParams(s);j.delete("prospect"),j.delete("project"),a(j)},ae=async j=>{var I,Y,de;try{if(!Q)throw console.error("[handleAddProspect] addProspect is undefined"),new Error("Fonction addProspect non disponible");const ve=((I=h[0])==null?void 0:I.step_id)||((Y=h[0])==null?void 0:Y.id);console.log("[handleAddProspect] calling addProspect",{name:j.name,email:j.email,status:ve,ownerId:V==null?void 0:V.user_id,sendInvitation:j.sendInvitation,allData:j});const l=await Q({...j,status:ve,ownerId:V==null?void 0:V.user_id});if(console.log("[handleAddProspect] result",l),!(l!=null&&l.id))throw new Error("Prospect non cr√©√© - r√©sultat vide");if(l&&j.tags&&j.tags.length>0)for(const k of j.tags){const R=(de=O[k])==null?void 0:de.steps;if(R&&R.length>0)try{const $=JSON.parse(JSON.stringify(R));if($[0].status="in_progress",!r)throw new Error("Organization ID manquant - Impossible de cr√©er les steps projet");const{error:K}=await ge.from("project_steps_status").upsert({prospect_id:l.id,project_type:k,steps:$,organization_id:r,updated_at:new Date().toISOString()},{onConflict:"prospect_id,project_type"});K?w.error("Erreur initialisation steps",{projectType:k,error:K}):w.debug("Steps initialized for project",{projectType:k,prospectId:l.id})}catch($){w.error("Erreur initialisation steps",{projectType:k,error:$})}}if(console.log("[handleAddProspect] üîç sendInvitation check:",{sendInvitation:j.sendInvitation,email:l.email,willSend:j.sendInvitation&&l.email}),j.sendInvitation&&l.email)try{const k=`${window.location.origin}/dashboard`;console.log("[handleAddProspect] üìß Sending magic link to:",l.email.trim(),"redirect:",k,"org:",r);const{error:R}=await ge.auth.signInWithOtp({email:l.email.trim(),options:{shouldCreateUser:!0,emailRedirectTo:k,data:{organization_id:r}}});R?(console.error("[handleAddProspect] ‚ùå invitation error",R),J({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Invitation non envoy√©e: ${R.message}`,variant:"warning"})):(console.log("[handleAddProspect] ‚úÖ invitation sent to",l.email),J({title:"‚úÖ Prospect cr√©√©",description:`Invitation envoy√©e √† ${l.email}`,className:"bg-green-500 text-white"}))}catch(k){console.error("[handleAddProspect] üí• invitation exception",k),J({title:"Prospect cr√©√©",description:`‚ö†Ô∏è Erreur envoi invitation: ${k.message}`,variant:"warning"})}else console.log("[handleAddProspect] ‚è≠Ô∏è Skipping invitation:",{reason:j.sendInvitation?"no email":"sendInvitation=false"});g(!1)}catch(ve){console.error("‚ùå handleAddProspect error",ve),J({title:"Erreur",description:ve.message||"Impossible d'ajouter le prospect.",variant:"destructive"})}},Ce=j=>{try{Z&&(Z(j),J({title:"Prospect mis √† jour",description:"Les informations ont √©t√© sauvegard√©es."}))}catch{J({title:"Erreur",description:"Impossible de mettre √† jour le prospect.",variant:"destructive"})}};return oe&&oe.id?e.jsx(Ye.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"h-full",children:e.jsx(Js,{name:"Fiche Prospect",children:e.jsx(Sr,{prospect:oe,onBack:ye,onUpdate:Ce,onEditingChange:H})})}):N?e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Pipeline des Prospects"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ue,{className:"w-4 h-4"}),e.jsxs("span",{children:[fe.length," prospect",fe.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{ref:P,className:"relative inline-block text-left",children:[e.jsxs(pe,{variant:"outline",className:"flex items-center space-x-2",onClick:()=>A(j=>!j),children:[e.jsx("span",{children:xe}),e.jsx(St,{className:"h-4 w-4"})]}),f&&e.jsx("div",{className:"absolute z-50 mt-1 w-44 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg",children:e.jsxs("div",{className:"py-1",children:[se.map(j=>{var I;return e.jsxs("label",{className:"flex items-center px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:F.includes(j),onChange:()=>ke(j),className:"mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:((I=O[j])==null?void 0:I.title)||j})]},j)}),F.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-gray-200 my-1"}),e.jsx("button",{onClick:()=>D([]),className:"w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100",children:"Effacer la s√©lection"})]})]})})]}),e.jsxs(Xs,{open:z,onOpenChange:x,children:[e.jsx(Ys,{asChild:!0,children:e.jsxs(pe,{variant:"outline",role:"combobox","aria-expanded":z,className:"w-[230px] justify-between",children:[e.jsx(Ue,{className:"mr-2 h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:b==="all"?"Tous les utilisateurs":((Pe=te[b])==null?void 0:Pe.name)||"Utilisateur"}),e.jsx(St,{className:"ml-2 h-4 w-4 flex-shrink-0 opacity-50"})]})}),e.jsx(Ks,{className:"w-[200px] p-0",children:e.jsxs(Qs,{children:[e.jsx(Zs,{placeholder:"Rechercher..."}),e.jsxs(Us,{children:[e.jsx(ea,{children:"Aucun utilisateur"}),e.jsx(ta,{children:_.map(j=>e.jsxs(sa,{value:j.label,onSelect:()=>{p(j.value),x(!1)},children:[e.jsx(dt,{className:Qe("mr-2 h-4 w-4",b===j.value?"opacity-100":"opacity-0")}),j.label]},j.value))})]})]})})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(aa,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Be,{type:"text",placeholder:"Rechercher un prospect...",value:y,onChange:j=>i(j.target.value),className:"pl-9 pr-4"}),y&&e.jsx("button",{onClick:()=>i(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:"√ó"})]}),e.jsxs(pe,{onClick:()=>g(!0),children:[e.jsx(Pt,{className:"w-4 h-4 mr-2"}),"Nouveau Prospect"]})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:Se.map(j=>e.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`${j.color} rounded-lg p-4 flex flex-col h-full min-h-[500px]`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:j.name}),e.jsx("span",{className:"bg-white bg-opacity-70 text-gray-700 px-2 py-1 rounded-full text-xs font-medium",children:(Ie[j.id]||[]).filter(I=>{if(F.length===0)return!0;const{projectType:Y}=I;return F.some(de=>de.toUpperCase()===(Y||"").toUpperCase())}).length})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto",children:(()=>{const I=(Ie[j.id]||[]).filter(k=>{if(F.length===0)return!0;const{projectType:R}=k;return F.some($=>$.toUpperCase()===(R||"").toUpperCase())}),Y=ne[j.id]||ts,de=I.slice(0,Y),ve=I.length>Y,l=I.length-Y;return e.jsxs(e.Fragment,{children:[de.map((k,R)=>{var He;const{prospect:$,projectType:K,activeStep:U}=k,ee=`${$.id}-${K||"default"}-${j.id}-${R}`,re=$.projectType||$.tags&&$.tags[0]||"Projet",Ne=K&&((He=O[K])!=null&&He.title)?O[K].title:re,Re=(U==null?void 0:U.label)||(U==null?void 0:U.name)||j.name,_e=j.color||"bg-blue-100 text-blue-700",ut=`${$.id}-${K||Ne}-${j.id}-${R}`;return e.jsx(Ye.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},children:e.jsx(Ua,{prospect:{...$,_projectContext:{projectType:K||re,projectTitle:Ne,stepLabel:Re,projectColor:_e}},onClick:()=>we($,K||$.projectType||(Array.isArray($.tags)?$.tags[0]:re)),compact:!0,sortableId:ut,projectsData:O})},ee)}),ve&&e.jsxs("button",{onClick:()=>je(j.id),className:"w-full py-3 text-sm text-blue-600 hover:text-blue-800 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-lg transition-all font-medium",children:["Voir ",Math.min(l,ss)," de plus (",l," restants)"]}),I.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"w-16 h-16 bg-white bg-opacity-50 rounded-full flex items-center justify-center mx-auto mb-2",children:e.jsx(Ue,{className:"w-8 h-8 text-gray-400"})}),e.jsx("p",{className:"text-sm",children:"Aucun prospect"})]})]})})()})]},j.id))})})}),e.jsx(ra,{open:m,onOpenChange:g,onAddProspect:ae}),!1]}):e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-24 bg-gray-100 rounded animate-pulse"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-40 bg-green-200 rounded animate-pulse"})]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-x-auto pb-4",children:e.jsx("div",{className:"grid grid-flow-col auto-cols-[minmax(220px,1fr)] gap-4 h-full",children:[1,2,3,4,5].map(j=>e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 flex flex-col h-full min-h-[500px] animate-pulse",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-5 w-24 bg-gray-300 rounded"}),e.jsx("div",{className:"h-6 w-8 bg-white bg-opacity-70 rounded-full"})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-6 w-16 bg-blue-100 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-green-100 rounded-full"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[e.jsx("div",{className:"h-4 w-2/3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-200 rounded"})]})]})]},j))})})})]})};export{qr as default};
